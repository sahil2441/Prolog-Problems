
RCS file: /cvsroot/xsb/XSB/emu/Attic/.DS_Store,v
Working file: .DS_Store
head: 1.1
branch:
locks: strict
access list:
symbolic names:
	latest_plus_supp_branch: 1.1.0.2
keyword substitution: b
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.1
date: 2010/06/19 19:39:50;  author: spyrosh;  state: dead;
branches:  1.1.2;
file .DS_Store was initially added on branch latest_plus_supp_branch.
----------------------------
revision 1.1.2.2
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.2.1
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +47 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/.cvsignore,v
Working file: .cvsignore
head: 1.19
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.18
	ROLLBACK: 1.14
	latest_plus_supp_branch: 1.14.0.4
	latest_plus_supp: 1.14
	Version_3dot2_plus_supp: 1.14.0.2
	release_2_6_plus_supp: 1.10.0.14
	Version_3dot2: 1.14
	mt_thesis: 1.13
	release_3_0: 1.13
	release_2_7_0: 1.12
	multi-threaded-26-engine: 1.10
	pre-mt: 1.12
	multi-threaded-25-engine-done: 1.10
	multi-threaded-25-engine: 1.10.0.12
	release_2_6_1: 1.10
	release_2_6_final: 1.10
	release_2_6: 1.10.0.10
	last-merged-to-demand: 1.10
	demand_branch: 1.10.0.8
	before_removing_chat: 1.10
	release_2_5: 1.10
	pre-merge-slgwam-gc: 1.10
	multi-threaded-c-engine: 1.10.0.6
	release_2_4: 1.10
	release_2_3: 1.10
	multi-threaded-engine: 1.10.0.4
	pre-threading: 1.10
	release-2-2: 1.10
	chat-and-local: 1.10.0.2
	xsb-pre-cleanup: 1.10
	release-2-1: 1.9
	release-2-0-1: 1.9
	subsumption: 1.8
	without-attv: 1.8
	release-2-0: 1.7
	pre-release-2-0: 1.7
	v1-9-8: 1.3
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.3
	r1-9-b6: 1.3
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.1
	devel-1-9-b4-4: 1.1
	devel-1-9-b4-3: 1.1
keyword substitution: kv
total revisions: 20;	selected revisions: 20
description:
initial version
----------------------------
revision 1.19
date: 2011/05/16 01:03:07;  author: kifer;  state: Exp;  lines: +0 -1
added extentsions_xsb.h to the repository.
Otherwise, windows building problems
----------------------------
revision 1.18
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.17
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.15
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.14
date: 2007/08/18 22:07:55;  author: kifer;  state: Exp;  lines: +1 -0
branches:  1.14.4;
removed emu/extensions_xsb.h from CVS. This file is generated by configure and
there are frequent clashes due to that.
----------------------------
revision 1.13
date: 2006/02/11 02:46:08;  author: kifer;  state: Exp;  lines: +1 -0
added files to ignore in cvs
----------------------------
revision 1.12
date: 2004/10/15 05:34:38;  author: kifer;  state: Exp;  lines: +0 -1
readded
----------------------------
revision 1.11
date: 2004/10/15 02:14:41;  author: kifer;  state: Exp;  lines: +1 -0
*** empty log message ***
----------------------------
revision 1.10
date: 1999/11/29 00:30:10;  author: kifer;  state: Exp;  lines: +1 -0
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.9
date: 1999/10/24 05:00:40;  author: kifer;  state: Exp;  lines: +1 -0
added file
----------------------------
revision 1.8
date: 1999/08/09 00:29:25;  author: kifer;  state: Exp;  lines: +2 -1
Changes for windows installation
----------------------------
revision 1.7
date: 1999/04/02 04:23:24;  author: kifer;  state: Exp;  lines: +1 -1
Changes neede to have private_builtin.c really private.
----------------------------
revision 1.6
date: 1999/04/02 03:54:04;  author: kifer;  state: Exp;  lines: +1 -1
Ignore private_builtin.* during commits
----------------------------
revision 1.5
date: 1999/04/02 03:51:22;  author: kifer;  state: Exp;  lines: +1 -0
Ignore private_builtin.* during commits
----------------------------
revision 1.4
date: 1999/03/26 07:06:35;  author: cbaoqiu;  state: Exp;  lines: +1 -0
Made ChangeLog to be ignored.
----------------------------
revision 1.3
date: 1998/11/23 23:17:00;  author: kifer;  state: Exp;  lines: +1 -0
*** empty log message ***
----------------------------
revision 1.2
date: 1998/11/17 01:56:39;  author: kifer;  state: Exp;  lines: +1 -0
Changed so that basictypes.h could be included multiple times.
Moved prolog_int and such from cinterf to basictypes.h
----------------------------
revision 1.1
date: 1998/11/13 20:10:34;  author: kifer;  state: Exp;
deleted orastuff.c, since it is generated from orastuff.pc
----------------------------
revision 1.14.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/CODING_GUIDELINES,v
Working file: CODING_GUIDELINES
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.16
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.14
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.2
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.6
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2000/04/29 19:23:17;  author: kifer;  state: Exp;  lines: +5 -4
branches:  1.2.16;
documentation fixes
----------------------------
revision 1.1
date: 2000/04/28 02:18:46;  author: kifer;  state: Exp;
new file
----------------------------
revision 1.2.16.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.2.16.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.16.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/README,v
Working file: README
head: 1.16
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.16
	ROLLBACK: 1.12
	latest_plus_supp_branch: 1.12.0.4
	latest_plus_supp: 1.12
	Version_3dot2_plus_supp: 1.12.0.2
	release_2_6_plus_supp: 1.2.0.14
	Version_3dot2: 1.12
	dec07-perf-results: 1.12
	mt_thesis: 1.11
	release_3_0: 1.11
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.12
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.10
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.8
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.6
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.2
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 20;	selected revisions: 20
description:
----------------------------
revision 1.16
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.15
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.14
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.13
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.12
date: 2007/08/02 23:23:49;  author: pmoura;  state: Exp;  lines: +3 -3
branches:  1.12.4;
Fixed some spelling typos.
----------------------------
revision 1.11
date: 2006/04/27 21:08:46;  author: tswift;  state: Exp;  lines: +6 -8

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.10
date: 2006/01/27 20:29:42;  author: tswift;  state: Exp;  lines: +0 -1

Some changes I recently made broke batched evaluation.  I backed out these changes to fix the batched test suite again.
----------------------------
revision 1.9
date: 2006/01/24 14:10:00;  author: tswift;  state: Exp;  lines: +90 -115

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.8
date: 2006/01/23 21:21:31;  author: tswift;  state: Exp;  lines: +1 -0

Fixed bug in is_incomplete: no overflow check was made before
allocating a completion suspension frame.

The bug was uncovered during testing thread-safety of the MT
engine.  This 1-line change took me most of the day to find ...
c'est la vie.
----------------------------
revision 1.7
date: 2005/12/22 23:33:55;  author: tswift;  state: Exp;  lines: +177 -16

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.6
date: 2005/12/13 01:13:45;  author: tswift;  state: Exp;  lines: +2 -1

Added mutex MUTEX_SYS_SYSTEM to protect global process table used
by spawn_process() and related functions.
----------------------------
revision 1.5
date: 2005/12/12 00:19:11;  author: tswift;  state: Exp;  lines: +62 -9

Mutexed socket calls which dont seem to be mutexed.  Also added a
mutex around some rarely used string/symbol table statistics.

Other than that, documentation.
----------------------------
revision 1.4
date: 2005/11/17 18:22:41;  author: tswift;  state: Exp;  lines: +2 -4

Removed resume_compl_susp_inst2 -- unneeded, and a remnant of old single-stack scheduling (!)
----------------------------
revision 1.3
date: 2005/11/14 18:58:48;  author: tswift;  state: Exp;  lines: +32 -0


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.2
date: 1999/09/20 08:59:34;  author: kostis;  state: Exp;  lines: +1 -1
*** empty log message ***
----------------------------
revision 1.1
date: 1998/11/05 16:55:11;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:11;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.12.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.12.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.12.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/_ansi.h,v
Working file: _ansi.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
----------------------------
revision 1.2
date: 2001/01/30 21:08:37;  author: dwarren;  state: dead;  lines: +0 -0
Fixing problems with ODBC for cygwin
----------------------------
revision 1.1
date: 2001/01/29 22:59:31;  author: dwarren;  state: Exp;
Updates to allow ODBC interface to be compiled under cygwin on Windows.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/auxlry.c,v
Working file: auxlry.c
head: 1.24
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.24
	ROLLBACK: 1.20
	latest_plus_supp_branch: 1.20.0.4
	latest_plus_supp: 1.20
	Version_3dot2_plus_supp: 1.20.0.2
	release_2_6_plus_supp: 1.17.0.4
	Version_3dot2: 1.20
	dec07-perf-results: 1.20
	mt_thesis: 1.20
	release_3_0: 1.20
	release_2_7_0: 1.18
	multi-threaded-26-engine: 1.8.6.2
	pre-mt: 1.18
	multi-threaded-25-engine-done: 1.8.6.1
	multi-threaded-25-engine: 1.8.0.6
	release_2_6_1: 1.17
	release_2_6_final: 1.17
	release_2_6: 1.17.0.2
	last-merged-to-demand: 1.8
	demand_branch: 1.8.0.4
	before_removing_chat: 1.8
	release_2_5: 1.8
	pre-merge-slgwam-gc: 1.8
	multi-threaded-c-engine: 1.8.0.2
	release_2_4: 1.8
	release_2_3: 1.7
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.6
	release-2-2: 1.5
	chat-and-local: 1.5.0.2
	xsb-pre-cleanup: 1.5
	release-2-1: 1.4
	release-2-0-1: 1.4
	subsumption: 1.4
	without-attv: 1.4
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 33;	selected revisions: 33
description:
----------------------------
revision 1.24
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.23
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.22
date: 2010/08/18 03:08:12;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.21
date: 2010/08/17 20:01:44;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.20
date: 2005/12/17 02:46:28;  author: dwarren;  state: Exp;  lines: +4 -4
branches:  1.20.4;
Fixed accumulated missing casts.  MSVC compiles it now without complaint.
----------------------------
revision 1.19
date: 2005/10/21 17:47:52;  author: tswift;  state: Exp;  lines: +8 -1


These are documentation changes only, made while stumbling through unfamiliar code.  I wanted to get them in before I started to make code changes.
----------------------------
revision 1.18
date: 2003/09/11 14:23:34;  author: dwarren;  state: Exp;  lines: +2 -6
Fixed bug in get_date for Windows.  Directly use system function to get Universal Time
rather than getting local time and time-zone and trying to fix.  (Fixing requires handling
complex roll-over of days, months, (leap)-years....)
----------------------------
revision 1.17
date: 2003/03/20 18:40:08;  author: lfcastro;  state: Exp;  lines: +3 -3
* cpu_time in Windows should return kernel+user time, not
  kernel+kernel! Ooops. ;)
----------------------------
revision 1.16
date: 2003/03/19 18:16:32;  author: lfcastro;  state: Exp;  lines: +1 -4
* Cleanup: remove old, now-invalid comment
----------------------------
revision 1.15
date: 2003/03/12 19:02:31;  author: lfcastro;  state: Exp;  lines: +10 -4
* Use MSVC's own 64-bit integer type; unfortunately, conversion from unsigned __int64 to double is not supported, so use the signed version
----------------------------
revision 1.14
date: 2003/03/10 16:18:11;  author: lfcastro;  state: Exp;  lines: +34 -21
* make cputime get actual user+system time in Windows NT and above, instead of using wall clock; dynamically check for Windows version; should be checked in Win 95/98.
----------------------------
revision 1.13
date: 2003/03/05 19:59:59;  author: lfcastro;  state: Exp;  lines: +4 -2
* Date related predicates:

  - now(-When) returns a string with current date & time --- format
  should be fixed

  - datime(-Datime) returns a term with current date & time in the
    form datime(Year,Month,Day,Hour,Min,Sec)

* All dates & times are UTC
----------------------------
revision 1.12
date: 2003/03/05 15:29:55;  author: lfcastro;  state: Exp;  lines: +2 -3
* void getdate(), not int getdate()
----------------------------
revision 1.11
date: 2003/03/05 14:35:18;  author: lfcastro;  state: Exp;  lines: +26 -4
* Include <windows.h> when under windows in auxlry.c
* Tentative implementation of a more precise cputime builtin for Windows NT & up --- commented out, for now
----------------------------
revision 1.10
date: 2003/03/03 21:50:07;  author: lfcastro;  state: Exp;  lines: +6 -3
* get_date(Year,Month,Day,Hour,Minute) now works on Windows and is
  more sensible on Linux
----------------------------
revision 1.9
date: 2003/03/03 20:55:00;  author: lfcastro;  state: Exp;  lines: +28 -13
* (EXPERIMENTAL) Preliminary introduction of a get_date/5 builtin.
----------------------------
revision 1.8
date: 2001/06/29 21:03:29;  author: kifer;  state: Exp;  lines: +4 -6
branches:  1.8.4;  1.8.6;
took care of the time.h/ sys/time.h problem.
----------------------------
revision 1.7
date: 2001/02/15 16:15:44;  author: lfcastro;  state: Exp;  lines: +3 -1
* ifdef'd out unused function which uses localtime(). Some versions of
glibc define localtime() in sys/time.h, others in time.h, and this is
currently not detected.
----------------------------
revision 1.6
date: 2000/05/20 06:55:55;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.6.2;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.5
date: 2000/01/07 08:51:13;  author: kifer;  state: Exp;  lines: +2 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.4
date: 1999/07/20 18:54:33;  author: kifer;  state: Exp;  lines: +2 -1
added open_process_pipe/close_process_pipe,
open_process_stream/close_process_stream
----------------------------
revision 1.3
date: 1999/04/17 16:44:00;  author: kostis;  state: Exp;  lines: +9 -4
Changes necessary for HP machines.
----------------------------
revision 1.2
date: 1999/02/01 21:43:24;  author: kostis;  state: Exp;  lines: +4 -4
Fixed minor problem with unused function on Linux (warning removed).
----------------------------
revision 1.1
date: 1998/11/05 16:55:11;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:11;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.8.6.2
date: 2004/10/18 20:45:54;  author: ruim;  state: Exp;  lines: +71 -14
update for version 2.6.1
----------------------------
revision 1.8.6.1
date: 2004/09/29 19:43:53;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.8.4.1
date: 2003/04/17 17:11:55;  author: lfcastro;  state: Exp;  lines: +71 -14
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.20.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.20.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.20.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/auxlry.h,v
Working file: auxlry.h
head: 1.39
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.33
	ROLLBACK: 1.28
	latest_plus_supp_branch: 1.28.0.4
	latest_plus_supp: 1.28
	Version_3dot2_plus_supp: 1.28.0.2
	release_2_6_plus_supp: 1.18.0.4
	Version_3dot2: 1.28
	dec07-perf-results: 1.27
	mt_thesis: 1.26
	release_3_0: 1.26
	release_2_7_0: 1.19
	multi-threaded-26-engine: 1.11.4.2
	pre-mt: 1.19
	multi-threaded-25-engine-done: 1.11.4.1
	multi-threaded-25-engine: 1.11.0.4
	release_2_6_1: 1.18
	release_2_6_final: 1.18
	release_2_6: 1.18.0.2
	last-merged-to-demand: 1.13
	demand_branch: 1.13.0.2
	before_removing_chat: 1.11
	release_2_5: 1.11
	pre-merge-slgwam-gc: 1.11
	multi-threaded-c-engine: 1.11.0.2
	release_2_4: 1.9
	release_2_3: 1.9
	multi-threaded-engine: 1.9.0.4
	pre-threading: 1.9
	release-2-2: 1.9
	chat-and-local: 1.9.0.2
	xsb-pre-cleanup: 1.9
	release-2-1: 1.8
	release-2-0-1: 1.7
	subsumption: 1.7
	without-attv: 1.6
	release-2-0: 1.5
	pre-release-2-0: 1.3
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 50;	selected revisions: 50
description:
----------------------------
revision 1.39
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +3 -1

Integrating in Call Abstraction
----------------------------
revision 1.38
date: 2011/07/08 04:39:56;  author: kifer;  state: Exp;  lines: +3 -3
better messages
----------------------------
revision 1.37
date: 2011/05/22 15:12:25;  author: tswift;  state: Exp;  lines: +4 -1

Changes to fix compiler warnings on various Mac configurations.
----------------------------
revision 1.36
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +4 -1

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.35
date: 2011/05/20 20:20:26;  author: tswift;  state: Exp;  lines: +5 -2

Fixed a couple of 32/64 compiler warnings.
----------------------------
revision 1.34
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +9 -1
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.33
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.32
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.31
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.30
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.29
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.28
date: 2007/12/13 18:22:26;  author: ruim;  state: Exp;  lines: +5 -1
branches:  1.28.4;
changes to align structs to 16 byte addresses in the multi-threaded system
preliminar results indicate that we may want to do that for the sequential
system
----------------------------
revision 1.27
date: 2007/10/23 15:53:19;  author: ruim;  state: Exp;  lines: +2 -2
Introduced command line option max_mqueues to specify maximum limit for
message queues

Rationalized use of max_threads_glc wrt sequential engine
----------------------------
revision 1.26
date: 2006/02/27 22:03:46;  author: tswift;  state: Exp;  lines: +2 -1
Some miscellaneous changes

1) abolish_table_pred now emits a warning when the table has a
   leaf node with a delay list -- this could cause dangling
   pointers for dependency checking.  Also, modified an error.

2) trie_interned now throws an exception, rather than exiting on
   an error case.

3) max_threads is now a command-line option

4) Added a new define NON_OPT_COMPILE, and memory mutexes are now
   used only with NON_OPT_COMPILE
----------------------------
revision 1.25
date: 2006/01/24 14:10:00;  author: tswift;  state: Exp;  lines: +4 -4

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.24
date: 2005/12/31 01:43:33;  author: tswift;  state: Exp;  lines: +3 -2
Changes to mutex handling for IO that should affect only the MT
engine. Rather than having a global IO mutex, I've added a mutex
for each stream, and used MUTEX_IO to lock the open_files array
itself.  This change was prompted by the fact that I can't have
one thread waiting on an input-stream via, say, a read and have
that thread create other threads that write to the output stream
and exit when done.

The result is that we no longer have contention when different
threads write to different streams.  At the same time, we end up
doing no more locking than before -- a little less, in fact due
to some manipulations in xsb_writ.P Unfortunately, the stream
mutexes are recursive (as with MUTEX_IO).  We can't get rid of
this until we rewrite write_term.

Now, back to handling memory_errors.
----------------------------
revision 1.23
date: 2005/10/21 17:47:52;  author: tswift;  state: Exp;  lines: +3 -1


These are documentation changes only, made while stumbling through unfamiliar code.  I wanted to get them in before I started to make code changes.
----------------------------
revision 1.22
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +2 -17


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.21
date: 2005/08/08 17:11:01;  author: dwarren;  state: Exp;  lines: +3 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.20
date: 2005/01/14 18:30:49;  author: ruim;  state: Exp;  lines: +3 -2
Integration of multithreaded system
----------------------------
revision 1.19
date: 2004/08/19 22:15:24;  author: tswift;  state: Exp;  lines: +2 -2

Changes for streams.  Here's hoping...
----------------------------
revision 1.18
date: 2003/03/05 19:59:58;  author: lfcastro;  state: Exp;  lines: +3 -3
* Date related predicates:

  - now(-When) returns a string with current date & time --- format
  should be fixed

  - datime(-Datime) returns a term with current date & time in the
    form datime(Year,Month,Day,Hour,Min,Sec)

* All dates & times are UTC
----------------------------
revision 1.17
date: 2003/03/05 15:29:57;  author: lfcastro;  state: Exp;  lines: +2 -2
* void getdate(), not int getdate()
----------------------------
revision 1.16
date: 2003/03/03 20:54:59;  author: lfcastro;  state: Exp;  lines: +3 -1
* (EXPERIMENTAL) Preliminary introduction of a get_date/5 builtin.
----------------------------
revision 1.15
date: 2002/11/04 18:09:00;  author: dwarren;  state: Exp;  lines: +4 -14
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.14
date: 2002/10/04 20:42:00;  author: lfcastro;  state: Exp;  lines: +5 -1
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.13
date: 2002/03/17 10:36:02;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.13.2;
parens around ihash macro def -- too dangerous without
----------------------------
revision 1.12
date: 2002/03/13 10:17:48;  author: kifer;  state: Exp;  lines: +2 -2
replaced file extensions with defined preprocessor constants in preparation to
the objfile extension switch
----------------------------
revision 1.11
date: 2001/11/08 21:35:25;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.11.4;
Eliminated the indirection of *asynint_ptr and to directly use
asynint_val.  (Also a minor bug-fix in ptoc_longstring.)
----------------------------
revision 1.10
date: 2001/11/07 21:08:00;  author: dwarren;  state: Exp;  lines: +2 -2
I modified slightly the way interrupts are handled.  There had been a
couple of mechanisms, and I tried to consolidate them. I elimitaed
call_intercept and merged it in with *asynint_ptr. Now the keyboard
interrupt can be used for C-user-defined interrupts.  There is a new
variable asynint_code that can be set when an interrupt is signaled.
It is set to 0 by the system signal catcher.  To generate a
user-defined interrupt, you need to set the KEYINT_MARK bit of
*asynint_ptr and set asynint_code to your integer code.  Then when
this interrupt is fielded, it will call the keyboard interrupt handler
(set by set_inthandler imported from loader) which is a two argument
predicate.  When it is called, the first argument will be the goal to
call when continuing out of the interrupt; the second argument will be
the value of asynint_code.
----------------------------
revision 1.9
date: 1999/12/10 07:47:22;  author: kifer;  state: Exp;  lines: +3 -14
branches:  1.9.4;
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.8
date: 1999/11/23 04:06:42;  author: kifer;  state: Exp;  lines: +2 -2
Added tmpfile_open.
Cleaned up the file opening modes stuff.
----------------------------
revision 1.7
date: 1999/10/12 19:47:43;  author: ejohnson;  state: Exp;  lines: +5 -1
Moved two defs into auxlry.h I initially put into basictypes.h.
Added def of YES/NO, and an unsigned int type "counter".
----------------------------
revision 1.6
date: 1999/08/05 07:57:25;  author: kifer;  state: Exp;  lines: +7 -7
Added process plumbing to spawn_process
----------------------------
revision 1.5
date: 1999/06/24 14:13:49;  author: kostis;  state: Exp;  lines: +1 -4
Some more changes to report meaningful things in arithmetic exceptions
(dealt with bit operations this time).
----------------------------
revision 1.4
date: 1999/06/23 21:26:01;  author: kostis;  state: Exp;  lines: +2 -5
Changes to have more meaningful error messages in case of arithmetic
expressions or comparisons.
----------------------------
revision 1.3
date: 1999/04/04 04:22:18;  author: kifer;  state: Exp;  lines: +6 -6
(SET_FILEPTR): improved macro
----------------------------
revision 1.2
date: 1999/04/04 03:54:42;  author: kifer;  state: Exp;  lines: +13 -2
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.1
date: 1998/11/05 16:55:11;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:11;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.9.4.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.4.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.11.4.2
date: 2004/10/18 20:45:55;  author: ruim;  state: Exp;  lines: +12 -16
update for version 2.6.1
----------------------------
revision 1.11.4.1
date: 2004/09/29 19:43:53;  author: ruim;  state: Exp;  lines: +8 -7
Sources from rfm repository
----------------------------
revision 1.13.2.3
date: 2003/04/17 17:11:54;  author: lfcastro;  state: Exp;  lines: +3 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.13.2.2
date: 2003/02/11 18:36:31;  author: lfcastro;  state: Exp;  lines: +3 -13
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.13.2.1
date: 2002/10/28 16:49:29;  author: lfcastro;  state: Exp;  lines: +5 -1
* Merge with HEAD
----------------------------
revision 1.28.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.28.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.28.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/basicdefs.h,v
Working file: basicdefs.h
head: 1.12
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.1.12.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.1.12.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
keyword substitution: kv
total revisions: 18;	selected revisions: 18
description:
----------------------------
revision 1.12
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +3 -2
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.11
date: 2011/06/27 15:47:30;  author: dwarren;  state: Exp;  lines: +2 -2
Doubled size of large string buffer.  (Overflowed on me on very long shell
command.)
----------------------------
revision 1.10
date: 2011/06/26 21:01:13;  author: tswift;  state: Exp;  lines: +2 -1

Support for C-level trace.
----------------------------
revision 1.9
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2007/10/09 17:15:04;  author: dwarren;  state: Exp;  lines: +2 -1
branches:  1.4.4;
These changes implement a facility that allows a routine called from
XSB as foreign code to call a predicate back in XSB.  This allows
mutual recursion between XSB and foreign code (and has been tested by
programming a recursive fibonacci in which the Prolog code calls C for
the samller values and C calls Prolog for its smaller values.)

It is similar to the "C calling XSB" interface, with the following
differences:

1. Do not call xsb_init or xsb_init_string.  These functions
initialize XSB, which clearly cannot be done if XSB is already
running.

2. A foreign routine called from XSB that wants to call an XSB
predicate must first call:
	xsb_query_save(NumRegs)

It must do this after retrieving its input parameters from XSB and
before calling any XSB predicate.  NumRegs must be the number of XSB
registers that the current foreign code uses (i.e., the number of
arguments of the XSB predicate used to call this foreign code
routine.)  This call saves the caller registers and sets up the XSB
state to accept queries from the foreign code.  (This is similar to
the XSB state after xsb_init is called.)  So after this call, the
foreign routine can use any of the interface routines for calling XSB,
such as xsb_command, xsb_command_string, xsb_query, xsb_query_string,
etc.

3. Before setting its output parameters and returning to its caller,
the foreign routine must call
	xsb_query_restore()

This restores the XSB parameter registers back to their state when
xsb_query_save() was called, and so prepares the registers to accept
the return values.  (It must be called even if there are no values to
be returned.)

This code works (according to my tests) for the single-threaded
engine.  It does NOT currently work for the multi-threaded engine.
I've put in the necessary CTXT- stuff, but still get crashes.  I'm
sure it can be made to work, but may need help in figuring out how.
----------------------------
revision 1.3
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +8 -1

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.2
date: 2004/02/02 20:29:47;  author: dwarren;  state: Exp;  lines: +5 -5
Change min and max macros to xsb_min and xsb_max to avoid name clash
as requested by a user.
----------------------------
revision 1.1
date: 1999/12/10 07:47:23;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.12;
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.1.12.1
date: 2004/09/29 19:43:53;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/basictypes.h,v
Working file: basictypes.h
head: 1.33
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.27
	ROLLBACK: 1.22
	latest_plus_supp_branch: 1.22.0.4
	latest_plus_supp: 1.22
	Version_3dot2_plus_supp: 1.22.0.2
	release_2_6_plus_supp: 1.16.0.12
	Version_3dot2: 1.22
	dec07-perf-results: 1.22
	mt_thesis: 1.22
	release_3_0: 1.21
	release_2_7_0: 1.18
	multi-threaded-26-engine: 1.16.10.1
	pre-mt: 1.18
	multi-threaded-25-engine-done: 1.16.10.1
	multi-threaded-25-engine: 1.16.0.10
	release_2_6_1: 1.16
	release_2_6_final: 1.16
	release_2_6: 1.16.0.8
	last-merged-to-demand: 1.16
	demand_branch: 1.16.0.6
	before_removing_chat: 1.16
	release_2_5: 1.16
	pre-merge-slgwam-gc: 1.16
	multi-threaded-c-engine: 1.16.0.4
	release_2_4: 1.16
	release_2_3: 1.16
	multi-threaded-engine: 1.16.0.2
	pre-threading: 1.16
	release-2-2: 1.15
	chat-and-local: 1.15.0.2
	xsb-pre-cleanup: 1.15
	release-2-1: 1.13
	release-2-0-1: 1.12
	subsumption: 1.12
	without-attv: 1.11
	release-2-0: 1.10
	pre-release-2-0: 1.9
	v1-9-8: 1.7
	code-fixer-new: 1.6
	code-fixer: 1.6
	delayvar_ok: 1.6
	r1-9-b6: 1.6
	r1-9-b5: 1.5
	devel-1-9-b4-5: 1.3
	devel-1-9-b4-4: 1.3
	devel-1-9-b4-3: 1.3
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 40;	selected revisions: 40
description:
----------------------------
revision 1.33
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +38 -1

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.32
date: 2011/11/06 20:30:42;  author: tswift;  state: Exp;  lines: +11 -1

Optimized is_cyclic by taking out a malloc()
----------------------------
revision 1.31
date: 2011/06/27 15:49:04;  author: dwarren;  state: Exp;  lines: +3 -3
Made maxint larger to actual maxint (for 64 bit)
----------------------------
revision 1.30
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +9 -1

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.29
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +14 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.28
date: 2011/05/11 01:27:14;  author: kifer;  state: Exp;  lines: +6 -4
introduced XSB_MAXINT/XSB_MININT and defined MY_MAXINT/MY_MININT
in terms of these. Eventually MY_* should be eliminated. Bad names.
----------------------------
revision 1.27
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.26
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.25
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2006/11/06 10:31:39;  author: ruim;  state: Exp;  lines: +2 -2
branches:  1.22.4;
Changed counter to unsigned long
Changed several counting variables to unsigned
Fixed a wrong thing in previous memory_xsb.c fix
----------------------------
revision 1.21
date: 2006/01/14 16:25:32;  author: dwarren;  state: Exp;  lines: +4 -2
Fix read_canonical to read floats into doubles,
Change write_canonical to write full precision floats (compatibility?)
Move MAXINT-type declarations, perhaps for giving to Prolog.
----------------------------
revision 1.20
date: 2005/07/22 15:42:12;  author: crojo;  state: Exp;  lines: +3 -3

Made double floating point numbers the default. Single precision floats can be reverted to with the configure option --enable-fast-floats
----------------------------
revision 1.19
date: 2005/07/18 21:54:00;  author: crojo;  state: Exp;  lines: +54 -2
*** empty log message ***
----------------------------
revision 1.18
date: 2004/12/20 19:26:14;  author: dwarren;  state: Exp;  lines: +2 -2
hanged several int's to Integer's for safety.  There is more interest in
the 64-bit port, so I'd like to find the current bugs in it.  This might
be a start.
----------------------------
revision 1.17
date: 2004/01/14 15:21:17;  author: dwarren;  state: Exp;  lines: +3 -1
To eliminate compiler warnings due to redefinition of byte type.
----------------------------
revision 1.16
date: 2000/04/29 21:53:49;  author: kifer;  state: Exp;  lines: +2 -5
branches:  1.16.2;  1.16.10;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.15
date: 1999/12/21 22:56:24;  author: warren;  state: Exp;  lines: +2 -2
cleanup to reduce number of warnings given by MSVC compiler.
----------------------------
revision 1.14
date: 1999/12/10 07:47:24;  author: kifer;  state: Exp;  lines: +21 -56
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.13
date: 1999/11/16 19:05:47;  author: kifer;  state: Exp;  lines: +9 -1
Revamped sockets interface.
----------------------------
revision 1.12
date: 1999/10/12 19:47:44;  author: ejohnson;  state: Exp;  lines: +7 -4
Moved two defs into auxlry.h I initially put into basictypes.h.
Added def of YES/NO, and an unsigned int type "counter".
----------------------------
revision 1.11
date: 1999/07/15 21:41:09;  author: ejohnson;  state: Exp;  lines: +5 -1
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.10
date: 1999/05/27 16:02:32;  author: kifer;  state: Exp;  lines: +4 -1
Added set_dcg_style/1 and related stuff to enable switching between
XSB-style DCG and Quintus, etc.
----------------------------
revision 1.9
date: 1999/04/04 15:53:32;  author: kifer;  state: Exp;  lines: +3 -1
Increased I/O max buf type.
----------------------------
revision 1.8
date: 1999/03/17 16:00:27;  author: kifer;  state: Exp;  lines: +2 -2
Changed comment.
----------------------------
revision 1.7
date: 1999/02/02 19:51:29;  author: kostis;  state: Exp;  lines: +2 -2
Added an important comment.
----------------------------
revision 1.6
date: 1998/11/18 07:59:10;  author: kifer;  state: Exp;  lines: +4 -1
Moved initialization of executable, user_home, xsb_config_file to the
new file self_orientation. Added initialization like in xmain.c to
xsb_init in cinterf.c. This should fix the C-calling xsb interface.
----------------------------
revision 1.5
date: 1998/11/17 01:56:41;  author: kifer;  state: Exp;  lines: +19 -1
Changed so that basictypes.h could be included multiple times.
Moved prolog_int and such from cinterf to basictypes.h
----------------------------
revision 1.4
date: 1998/11/17 00:29:35;  author: kifer;  state: Exp;  lines: +1 -3
Adjustments for the NT port.
----------------------------
revision 1.3
date: 1998/11/14 05:00:44;  author: kifer;  state: Exp;  lines: +2 -2
replaced #define bool int with typedef short bool, to make NT happy
----------------------------
revision 1.2
date: 1998/11/13 23:08:16;  author: kifer;  state: Exp;  lines: +3 -3
Adjusted various macros for NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:27;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:27;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.16.10.1
date: 2004/09/29 19:43:53;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.16.2.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.16.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +4 -4
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.22.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.22.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.22.4.1
date: 2010/06/19 19:35:00;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/biassert.c,v
Working file: biassert.c
head: 1.197
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.185
	ROLLBACK: 1.178
	latest_plus_supp_branch: 1.173.0.2
	latest_plus_supp: 1.173
	Version_3dot2_plus_supp: 1.169.0.2
	release_2_6_plus_supp: 1.63.0.4
	Version_3dot2: 1.169
	dec07-perf-results: 1.160
	mt_thesis: 1.131
	release_3_0: 1.124
	release_2_7_0: 1.74
	multi-threaded-26-engine: 1.50.4.4
	pre-mt: 1.74
	multi-threaded-25-engine-done: 1.50.4.1
	multi-threaded-25-engine: 1.50.0.4
	release_2_6_1: 1.63
	release_2_6_final: 1.63
	release_2_6: 1.63.0.2
	last-merged-to-demand: 1.53
	demand_branch: 1.52.0.2
	before_removing_chat: 1.50
	release_2_5: 1.50
	pre-merge-slgwam-gc: 1.50
	multi-threaded-c-engine: 1.50.0.2
	release_2_4: 1.50
	release_2_3: 1.47
	multi-threaded-engine: 1.43.0.2
	pre-threading: 1.41
	release-2-2: 1.36
	chat-and-local: 1.36.0.2
	xsb-pre-cleanup: 1.36
	release-2-1: 1.33
	release-2-0-1: 1.24
	subsumption: 1.22
	without-attv: 1.21
	release-2-0: 1.14
	pre-release-2-0: 1.13
	v1-9-8: 1.9
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 213;	selected revisions: 213
description:
----------------------------
revision 1.197
date: 2012/07/17 16:12:43;  author: dwarren;  state: Exp;  lines: +6 -5
Fixed bug when very large files are indexed, and overflow hash_size table.
Also changed somewhat rate at which hash tables are expanded.
----------------------------
revision 1.196
date: 2012/06/04 15:59:24;  author: dwarren;  state: Exp;  lines: +6 -3
Added unindexed profiling.
----------------------------
revision 1.195
date: 2012/05/18 20:35:41;  author: tswift;  state: Exp;  lines: +3 -3

Added check_variant/[1,2]
----------------------------
revision 1.194
date: 2011/12/05 15:00:44;  author: dwarren;  state: Exp;  lines: +6 -2
Modified handling of hashtabsize in index declaration to take next larger
tabsize from the table of (prime) hash table sizes.
----------------------------
revision 1.193
date: 2011/08/22 16:15:24;  author: dwarren;  state: Exp;  lines: +8 -4
Cleaned up recent checkins to work with MSVC, and avoid warnings.
(Changed bzero to memset, since MS seems not to have bzero.)
Also changed a couple of builtins to be more consistent in their
treatment of string p vs. 0-ary structure symbol p.
----------------------------
revision 1.192
date: 2011/06/10 17:17:38;  author: dwarren;  state: Exp;  lines: +3 -3
Fix bug introduced when "simplifying" treatment of ints and boxed_ints.
Uninumcon and bldnumcon instruction must handle boxed ints in the structure
case.
----------------------------
revision 1.191
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +8 -8
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.190
date: 2011/06/05 19:24:03;  author: tswift;  state: Exp;  lines: +4 -2



Changes to

1) Add flag-controlled answer depth checks to variant answer
tables.  (See current_prolog_flag in the manual for details).

2) In support of 1, added sprint_term, which prints a term to a C
string.  This is useful for errors and warnings invoked by C.

3) Added MAXTOINDEX_FLAG, which allows experimentation with the
depth of * indexing.

4) Increased the initial size strbuff from 1000 -> 10000.  This
reduces spurious long atom warnings.
----------------------------
revision 1.189
date: 2011/05/19 16:39:05;  author: tswift;  state: Exp;  lines: +12 -12
Getting Linux to Work
----------------------------
revision 1.188
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +45 -45
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.187
date: 2011/01/17 02:31:32;  author: dwarren;  state: Exp;  lines: +9 -8
Moved some debug messages into conditional, so ptr is defined.
Fixed a couple of formats.
----------------------------
revision 1.186
date: 2011/01/02 22:16:42;  author: tswift;  state: Exp;  lines: +2 -2

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.185
date: 2010/09/05 18:47:17;  author: tswift;  state: Exp;  lines: +4 -4

Fixes to make incremental tabling work properly when opaque is
switched to incremental.  I had made a fix to predicate_property to
distinguish incremenel from opaque that apparently broke things.
----------------------------
revision 1.184
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -85
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.183
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.182
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.181
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.180
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.179
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +85 -1
no message
----------------------------
revision 1.178
date: 2010/08/01 22:06:02;  author: tswift;  state: Exp;  lines: +3 -1

biassert.c -- minor doc change

Others: changes to allow directives to change tables among
incremental, nonincremental, and opaque.
----------------------------
revision 1.177
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.176
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.175
date: 2010/06/22 23:30:54;  author: spyrosh;  state: Exp;  lines: +0 -76
Backed out code
----------------------------
revision 1.174
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +77 -1
Dipti's code for support graph added
----------------------------
revision 1.173
date: 2010/02/20 22:24:45;  author: evansbj;  state: Exp;  lines: +2 -2
branches:  1.173.2;
Removed a weird little extraneous assignment to parameter HashTabSize ...
----------------------------
revision 1.172
date: 2010/02/02 14:54:13;  author: dwarren;  state: Exp;  lines: +8 -3
Fixed bug in db_remove_prref_1, must reset the spc load instruction to
be a load instruction and the following word to point to the psc.
----------------------------
revision 1.171
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +3 -3

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.170
date: 2009/05/08 17:32:25;  author: dwarren;  state: Exp;  lines: +3 -3
Change the order of traversal of clauses during general retractall.
This way greatly reduces the maximum stack depth needed, which we
had overflowed the previous way.
----------------------------
revision 1.169
date: 2009/01/02 17:50:03;  author: tswift;  state: Exp;  lines: +2 -2


Updating a number of files so that delete_branch() will work with call
subsumption (it needs to know that it deallocates BTNs rather than
TSTNs).  This fixed a latent bug in simplification and allows another
test to be run for call subsumption. It also provides a step towards
supporting answer subsumption on call subsumptive tables.  There are
also some other documentationstyle changes.

Adding a new test for copying attributed variables into delay elements
/ lists.  I hadn't thought this worked, but apparently it does !

Also, I'm adding a very simple test for incremental evaluation -- more
cases need to be added here, but at least this is a start.
----------------------------
revision 1.168
date: 2008/11/05 22:47:15;  author: dwarren;  state: Exp;  lines: +6 -1
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.167
date: 2008/09/08 13:52:44;  author: dwarren;  state: Exp;  lines: +2 -2
Deleted unnecessary CTXTc which was causing a compiler warning, but surprisingly
(to me) not an error.
----------------------------
revision 1.166
date: 2008/08/01 20:08:14;  author: tswift;  state: Exp;  lines: +27 -6
temporarily commenting out thread_free_dyn_blks.
----------------------------
revision 1.165
date: 2008/06/02 21:29:18;  author: dwarren;  state: Exp;  lines: +2 -2
Fix misspelling in error message.
----------------------------
revision 1.164
date: 2008/03/27 19:55:15;  author: tswift;  state: Exp;  lines: +5 -4

A few minor changes for error handling:

Improved error reporting for predicates that call the new C
convert_to_dyna()

Introduced iso_ptoc_callable_arg(), (for now, used only in convert_to_dyna())
----------------------------
revision 1.163
date: 2008/03/16 22:11:55;  author: tswift;  state: Exp;  lines: +30 -1

convert_to_dyna in C.  This speeds up assert/trie assert.  It also
refactors uses mutex_dynamic so that it is only locked when creating a
new prref, rather than whenever convert_to_dyna is called (something
stupid I did when I didnt really understand XSB's dynamic code.
----------------------------
revision 1.162
date: 2008/01/03 18:45:20;  author: dwarren;  state: Exp;  lines: +3 -2
Added new mega-instruction: getkpvars, which codes for multiple getpvar's.
Since the compiler generates a sequence of getpvar's of consecutively
increasing register numbers and increasing local variable locations for
heads that have distinct variables that are all permanent variables, this
instruction can be used quite often (as can be seen by the number of
.xwam files that have changed.)  The form is getkpvars(K,V,R) which
codes for K getpvar's with the V and R increasing by one each time.
----------------------------
revision 1.161
date: 2007/12/24 19:16:59;  author: tswift;  state: Exp;  lines: +69 -2

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.160
date: 2007/12/08 20:58:22;  author: ruim;  state: Exp;  lines: +3 -3
Fixes to last changes - some wrong files were commited by mistake
----------------------------
revision 1.159
date: 2007/12/06 23:24:54;  author: ruim;  state: Exp;  lines: +14 -14
replaced shared struct manangers with malloc
which improves scalabilty on a multi-processor

that required a number of small fixes to have coherency
between shared and private struct managers
----------------------------
revision 1.158
date: 2007/11/15 23:02:14;  author: tswift;  state: Exp;  lines: +2 -2
Update for handling thread_private/1 declarations when
--shared_predicates is defined.  The loader wasn't properly setting
the SHARED_DET bit so that the shared bits were ignored for
thread_private.  In addition, the loader sometimes overwrote
thread_private to thread_shared during import of a predicate by a
module.

These problems affected exception balls when XSB was called with
shared_predicates.  Anyway this seems to fix the bug discovered by the
logtalk benchmark examples.

Added a test to mttest to make sure this continues to work.
----------------------------
revision 1.157
date: 2007/11/09 14:48:50;  author: dwarren;  state: Exp;  lines: +4 -3
Added extra margin into the size that's generated in a test_heap instruction.
GC needs at least 256+ for registers and other.  I added a 512 word buffer.
----------------------------
revision 1.156
date: 2007/11/01 23:46:59;  author: tswift;  state: Exp;  lines: +3 -1


Added a command-line argument, --shared-predicates which, in the MT
engine makes dynamic code and tables shared by default.  If this
command-line argument is not used.  The default behavior is kept in a
flag so it can be queried, but not changed during run time.

Also, fixed a bug in dynamic as an executable directive.  ?-
dyanamic(p/n) succeeded even when p/n was static -- worse, it actually
CHANGED p/n to dynamic, working like an abolish for static predicates.
Don't know how that got in there.
----------------------------
revision 1.155
date: 2007/10/19 21:15:16;  author: tswift;  state: Exp;  lines: +34 -4

Changes to add call_cleanup/2, whose semantics is ISO compliant as far
as the ISO definition goes.  I also put call_cleanup/2 in std_xsb.P.
Cleanup handlers are scheduled through the attv interrupt chain, so I
needed to hack this code a little to make sure that an interrupt
handler for cleanups is always present.

Also, I made a change to peephole to not optimize away a putpbreg_ci
-- we'll usually need it for call_cleanups.

Right now I'm using a static inline for CHECK_CALL_CLEANUP -- on gcc
this should be as fast as a macro and allows me to trace if there are
any problems.


Adding these changes made me need to adjust a few include statements
in tr_utils.c and tst_retrv.c
----------------------------
revision 1.154
date: 2007/08/09 23:35:28;  author: tswift;  state: Exp;  lines: +3 -3

Fixed bug in dynamic clause gc under 64 bits --- for dbclause, and ';' we need to put in a zoom factor to know when we are in a choice point that might arise from a dynamic clause.
----------------------------
revision 1.153
date: 2007/08/08 17:50:49;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.152
date: 2007/08/02 19:07:41;  author: tswift;  state: Exp;  lines: +6 -13

Minor optimization for thread dispatch blocks.
----------------------------
revision 1.151
date: 2007/06/22 15:06:25;  author: dwarren;  state: Exp;  lines: +2 -2
This change to compile.P removes a redundant test_heap instruction
that is generated at the beginning of an internal predicate.  The
test_heap for the main predicate that caused the internal predicate
to be generated works for it as well.  Because it changed the code
displacements in dbclause hacking, a constant in biassert needed to
be changed as well.
And thus every .xwam file is now different.  (Every predicate with
a hard cut now has one fewer test_heap instruction.)
----------------------------
revision 1.150
date: 2007/06/10 18:43:57;  author: tswift;  state: Exp;  lines: +2 -6

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.149
date: 2007/06/01 22:47:05;  author: tswift;  state: Exp;  lines: +7 -3

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.148
date: 2007/05/16 18:51:56;  author: dwarren;  state: Exp;  lines: +6 -0
Fixed bug in first_clref to skip deleted SOB's
----------------------------
revision 1.147
date: 2007/04/09 18:52:09;  author: dwarren;  state: Exp;  lines: +17 -16
Try to fix a bud in deleting SOB blocks when a choice point still
points to them.  I went ahead and made Terry's change to zap a
fail instruction over the sob instruction.  The problem I fixed was
in db_get_clause after an sob block had been so modified.  Traversing
through the clauses (for retract and for clause/2) was confused
by that castrated sob block.  I've tested this in as many ways as I can
think of, but I'm not convinced it is totally right.  In particular,
I don't think it would work with (explicit) reclaim_space.  But since
that has been made obsolete, I'm hoping htis is OK.  If anyone encounters
problems, let me know.  -David
----------------------------
revision 1.146
date: 2007/04/05 17:26:56;  author: tswift;  state: Exp;  lines: +10 -2
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.145
date: 2007/03/30 10:34:06;  author: tswift;  state: Exp;  lines: +114 -6

Changes for debugging: printing out structures (e.g. deleted clref chains) and more informative error reporting.
----------------------------
revision 1.144
date: 2007/03/21 15:15:55;  author: dwarren;  state: Exp;  lines: +2 -1
Update estimate of heapsize possibly necessary by a clause, due to new
mega-instructions for small int lists.  This is gross over-estimate and
could be improved.
----------------------------
revision 1.143
date: 2007/03/18 14:48:49;  author: dwarren;  state: Exp;  lines: +6 -0
Added debugging print code for the new mega-instructions added for int lists.
----------------------------
revision 1.142
date: 2007/03/17 14:16:46;  author: dwarren;  state: Exp;  lines: +13 -12
Fix assert to use new mega-instructions to compile "-strings.
----------------------------
revision 1.141
date: 2007/03/17 00:03:31;  author: dwarren;  state: Exp;  lines: +2 -2
Oops again.  Strings in head also not asserted right.  So back that out, too.
(Gotta fix the testsuite....)
----------------------------
revision 1.140
date: 2007/03/16 22:15:59;  author: dwarren;  state: Exp;  lines: +2 -2
Oops, I introduced a bug in assert.  So back out the change to assert
that tried to optimize strings in clause bodies.
----------------------------
revision 1.139
date: 2007/03/16 20:40:29;  author: dwarren;  state: Exp;  lines: +31 -7
Add new mega-xwam-instructions to compile "abc"-type strings more
efficiently.  This changes almost(?) all xwam files.
The implementation at this point is just thru the peephole
optimizer.  The next step is to change the way the compiler
processes these strings to speed up compilation.
----------------------------
revision 1.138
date: 2007/02/23 20:17:04;  author: tswift;  state: Exp;  lines: +26 -26
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.137
date: 2007/02/18 16:24:10;  author: dwarren;  state: Exp;  lines: +46 -45
Improvements to debugging output for asserted code.
Elimimated redundant assignment of addr of realloc-ed buffer.
(assigned in subroutine and also returned and assigned by caller.)
(These changes are side-effects of searching for what turned out
to be file_read_line_list buffer overflow.)
----------------------------
revision 1.136
date: 2007/02/15 22:00:06;  author: dwarren;  state: Exp;  lines: +21 -9
Fix bug in handling single-occurrence variables in assert after they've
been numbered.  Slightly improves the code generated.
----------------------------
revision 1.135
date: 2007/01/25 20:33:53;  author: tswift;  state: Exp;  lines: +2 -2


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.134
date: 2007/01/16 22:23:02;  author: dwarren;  state: Exp;  lines: +94 -69
Modify assert to handle variables that have been preset to
$assertVAR(_,Occs) where Occs is the number of occurrences of
the variable.  This allows it to free registers used for (non-put)
variables after seeing the last occurrence.  assert/3 now has an
option that does this numbering.  It requires a Prolog pass of the
clause, but allows some clauses with many variables to be asserted.
----------------------------
revision 1.133
date: 2007/01/01 16:34:40;  author: dwarren;  state: Exp;  lines: +74 -201
Modified assert to better use registers in compiling rule bodies.
This now uses the same algorithm (and most of the code) for the body
as it does for the head.  So this should now handle most large terms.
The only ones not handled are those with large left-branching structures
with more structures to the right at each level.  Such terms are not
hard to construct artifically, but seem unlikely in applications.
We still have problems with terms with large numbers of variables.
----------------------------
revision 1.132
date: 2006/12/22 18:39:01;  author: dwarren;  state: Exp;  lines: +2 -0
Released registers in assert when generating code for bodies of rules.
Avoids register overflow for longer.
----------------------------
revision 1.131
date: 2006/11/26 23:43:42;  author: tswift;  state: Exp;  lines: +55 -45

 changes involve memory allocation
 for the dynamic clause garbage collection frames: rather than
 using malloc() and free() for these frames, I changed the
 various retract(all)s to use structure managers.  This has two
 advantages: first the structure managers are more efficient
 overall than using malloc and free, and second, in the
 multi-threaded engine we now use private structure mangers to
 manage the dynamic gc frames for private dynamic predicates,
 increaing potential concurrency.

Also, changes to experimental retract.
----------------------------
revision 1.130
date: 2006/11/22 16:18:06;  author: ruim;  state: Exp;  lines: +40 -40
Fixed heap expansion and GC to allow concurrency, by
moving global variables into the thread context.

GC_PROFILE was not fixed
----------------------------
revision 1.129
date: 2006/11/21 01:22:12;  author: ruim;  state: Exp;  lines: +3 -3
activated parameter --max_threads by replacing MAX_THREADS with max_threads_glc
----------------------------
revision 1.128
date: 2006/11/20 16:53:41;  author: ruim;  state: Exp;  lines: +13 -13
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.127
date: 2006/11/16 00:10:45;  author: tswift;  state: Exp;  lines: +39 -2

New heuristics for space reclamation in assert -- to activate define RETRACT_EXPERIMENT.
----------------------------
revision 1.126
date: 2006/11/09 16:58:34;  author: ruim;  state: Exp;  lines: +7 -1
SET_TRIE_ALLOCATION_TYPE_TIP: I think this would not have worked
for thread private tabled dynamic predicates, so changed to a safer code

TRIE_ASSERT: there's only one structure manager for trie assert,
so had to use SHARED struct manager mode
I also added a lock on trie asserted tries, but as reading is not
protected this is not entirely safe
----------------------------
revision 1.125
date: 2006/09/06 05:15:26;  author: diptikalyan;  state: Exp;  lines: +15 -8
Incremental Code Added.
----------------------------
revision 1.124
date: 2006/07/25 14:18:41;  author: tswift;  state: Exp;  lines: +3 -3

Commented out some fprintfs introduced for debugging.  This should be ready for release now.
----------------------------
revision 1.123
date: 2006/07/24 14:46:20;  author: dwarren;  state: Exp;  lines: +8 -7
Link record was being freed and THEN a pointer to the next record was retrieved
from it.  Fixed by getting the pointer to the next before feeing this one.
----------------------------
revision 1.122
date: 2006/07/20 20:41:34;  author: tswift;  state: Exp;  lines: +45 -43

Fix to quadratic factor in check_insert_delcf()
----------------------------
revision 1.121
date: 2006/07/16 17:46:25;  author: tswift;  state: Exp;  lines: +8 -3

Added call to clause gc from db_abolish.  It is necessary to make sure
that all clauses for a predicate have been gc'd before doing an
abolish for the prref and the generation of clrefs that belong to it.
This change ensures that, and fixes a bug recently introduced in
testretract.

By the way, there was also a buglet in the test suite that didn't
report memory violations as an error.  An associated commit fixes this
as well.

Terry
----------------------------
revision 1.120
date: 2006/07/14 16:49:36;  author: tswift;  state: Exp;  lines: +139 -47

Fixed relatively obscure bugs in clause gc.  With these fixes, the gc testsuite is working again, as does the flora testsuite.

Changes are (1 traverse CPS from bfreg if needed; 2 dont reclaim if there are ;/2 or db_get_clause CPs in the stack.

Also changed dis to allow it to print to a file if needed.
----------------------------
revision 1.119
date: 2006/07/08 18:49:11;  author: tswift;  state: Exp;  lines: +11 -6

Checks for private flag CLAUSE_GARBAGE_COLLECT that turns off space reclamation.  Useful for debugging.

In debug_xsb.c, wrote a Choice point stack printout routine with stuff needed for debugging clause/table gc.
----------------------------
revision 1.118
date: 2006/06/14 15:27:23;  author: dwarren;  state: Exp;  lines: +14 -5
Fixed a minor bug in computing hash values for big ints and floats in
*-indexing.
----------------------------
revision 1.117
date: 2006/04/30 18:27:12;  author: tswift;  state: Exp;  lines: +7 -7

-- Put parentheses around retract-gc definitions to ensure
   correctness.  The engine had been delaying space reclamation and
   garbage collecting far too often, and this seems to fix that problem.

-- A little more thread-safety for token_xsb.c

-- Fixed bug with file_clone/3 that I introduced many moons ago.  The
problem was that I hadn't been giving names to console type files,
and file_clone used the file name in a string_find.  Now console
files have file names and things seem to work fine.
----------------------------
revision 1.116
date: 2006/04/29 14:32:40;  author: dwarren;  state: Exp;  lines: +20 -13
Fixed bug in retract gc involving indexes.  If the choicepoint is pointing
to an index chain, then we need to get the address of the (beginning of the)
clref from the address of the try-type instruction.  Also need to do a similar
thing in determine_if_safe_to_delete when using indexes.
----------------------------
revision 1.115
date: 2006/04/27 21:08:47;  author: tswift;  state: Exp;  lines: +163 -151

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.114
date: 2006/04/27 01:05:26;  author: tswift;  state: Exp;  lines: +96 -2

Changed structure of retractall as called with non-open terms --
i.e. when a gen_retractall is NOT called.  The basic change was
to factor out the potentially expensive marking and unmarking
operations outside of the retract and to call them as builtins
before and after the retract itself.

Changes for code cleanup (db_remove_prref changed to db_abolish0).

Associated changes were also made to the test suite.
----------------------------
revision 1.113
date: 2006/04/24 15:41:16;  author: tswift;  state: Exp;  lines: +187 -119

Changes to make lists of delcfs both shared and private, so that space reclamation of dynamic clauses can occur when more than 1 thread is active.

Also, added reclamation of delcf and deltf frames for thread-private predicates upon exit of a thread.
----------------------------
revision 1.112
date: 2006/04/17 20:54:56;  author: tswift;  state: Exp;  lines: +750 -120

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.111
date: 2006/03/24 16:40:27;  author: tswift;  state: Exp;  lines: +24 -50

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.110
date: 2006/03/18 17:37:48;  author: tswift;  state: Exp;  lines: +49 -10
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.109
date: 2006/02/27 22:03:46;  author: tswift;  state: Exp;  lines: +3 -5
Some miscellaneous changes

1) abolish_table_pred now emits a warning when the table has a
   leaf node with a delay list -- this could cause dangling
   pointers for dependency checking.  Also, modified an error.

2) trie_interned now throws an exception, rather than exiting on
   an error case.

3) max_threads is now a command-line option

4) Added a new define NON_OPT_COMPILE, and memory mutexes are now
   used only with NON_OPT_COMPILE
----------------------------
revision 1.108
date: 2006/01/24 14:10:01;  author: tswift;  state: Exp;  lines: +9 -3

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.107
date: 2006/01/17 21:50:18;  author: dwarren;  state: Exp;  lines: +6 -6
Fixed to leave untagged integers in instructions, so compiler can
pass full 32-bit integers to runtime.  This (along with change to
flatten, in the compiler) should make the compiler handle full 32-bit
integers.  (Also fixed a bug in which boxed ints were being created
for small integers.)
----------------------------
revision 1.106
date: 2005/12/31 23:16:02;  author: tswift;  state: Exp;  lines: +10 -3

Fixed problems with throwing memory errors from mem_xxxoc(), at
least in sequential engine.  When memory cannot be malloced, a
resource error is thrown.  Since throwing errors mallocs memory
in itself, mem_xxxocs used by a throw are changed into
mem_xxxoc_nochecks and an xsb_exit is called if these functions
return NULL pointers.  Care is taken so that when a resource
error is thrown, space for its PSCs has been pre-allocated, and
varstrings are used for the actual message strings (varstring
exits too, if there is not enough memory).

In MT engine, a memory error just exits -- this is because I need
a CTXT to throw an error.  Right now, I'm not sure whether its a
good idea or not to put CTXTs into mem_xxxoc or not.

Not that some of the biggest memory allocations, such as tcp
stack, local-heap stack use straight reallocs and use their own
error handling.

In general, we should be handling most memory errors in a
reasonable, or at least consistent, manner.
----------------------------
revision 1.105
date: 2005/12/17 02:46:31;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed accumulated missing casts.  MSVC compiles it now without complaint.
----------------------------
revision 1.104
date: 2005/12/16 17:05:48;  author: dwarren;  state: Exp;  lines: +2 -2
Can't have inline predicate used outside of compilation unit in MSVC,
so took out inline.
----------------------------
revision 1.103
date: 2005/12/15 16:39:51;  author: dwarren;  state: Exp;  lines: +62 -34
1. Changed the XSB tokenizer to be more compatible with the Prolog
standard.  This involved adding escape characters when processing
strings -- single quoted, double quoted and 0-radix, as in 0'\n.  The
escape characters are those in the standard (taken from C).  I did not
add \' as a single quote within a quoted string, since it breaks the
form: '/\', which appears several times in the XSB system code.  (This
could, of course, be changed.)  Backslashes that are not followed by a
legal escape indicator are accepted simply as backslashes.  (I suspect
this is not what the standard expects, but it will break fewer
programs.)  I added the new forms for binary (e.g., 0b101), octal
(e.g., 0o731), and hex (e.g., 0xffef) that the standard requires.  I
left in the non-0 radix notation (after fixing a few bugs in it) which
is not in the standard, so we still process e.g., 8'713 as an octal
integer.  I extended the allowable radix up to 36 (which was partially
there already in a buggy form; I used A-Z for the digits 10-35.)  This
is probably not of much use, but what the hey....

The addition of the escape changed one of the tests in the testsuite.
Update tests from cvs to get the new correct answers.

2. Improved assert_code_to_buff so that it will run out of registers
less often when asserting GROUND structures.  The old version had a
limit of approximately 255 for right-branching when the left-elements
were non-constant.  E.g. arbitrary lists of constants were handled, but
lists of structures were limited to c. 255.  I've changed it so the
limit is now on left-branching instead of right-branching.  Since
right-branching is much more common in Prolog programs, this should
handle more structures that show up in Prolog programs.  (No claim is
made for Flora programs :-).
----------------------------
revision 1.102
date: 2005/12/12 18:44:51;  author: dwarren;  state: Exp;  lines: +79 -30
Added string table garbage collection.
----------------------------
revision 1.101
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +18 -17
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.100
date: 2005/11/14 18:58:48;  author: tswift;  state: Exp;  lines: +7 -7


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.99
date: 2005/11/12 15:48:49;  author: dwarren;  state: Exp;  lines: +5 -5
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.98
date: 2005/10/20 13:49:07;  author: dwarren;  state: Exp;  lines: +2 -1
Fix bug in retractall: check if freeing retract buffers empties the predicate,
and don't free the block if so.
----------------------------
revision 1.97
date: 2005/10/18 20:37:16;  author: dwarren;  state: Exp;  lines: +1 -3
Minor code cleanup of previous updates.
----------------------------
revision 1.96
date: 2005/10/18 20:12:53;  author: dwarren;  state: Exp;  lines: +5 -4
Fixed memory leak caused by not freeing empty SOB blocks.
(And had to move getting buff addr from prref till after forcing retract buffers!)
----------------------------
revision 1.95
date: 2005/10/12 23:06:26;  author: tswift;  state: Exp;  lines: +2 -2


Mostly added documentation.  Other changes

biassert.c -- commented out a debug that prevented -vrb option from
compiling.

Added a !defined(SOLARIS) to the inclusion of POSIX_C_SOURCE in
setjmp_xsb.h, and put the setjmp_xsb.h back into context.  I figured
its best to make the minimal change, rather than taking out the
inclusion of POSIX_C_SOURCE, which somehow would have broken something
down the line.

Terry
----------------------------
revision 1.94
date: 2005/09/29 15:31:47;  author: dwarren;  state: Exp;  lines: +10 -2
Added define-constant for clref flag for tries.
Added function to return trienode addr given a (trie) clref
----------------------------
revision 1.93
date: 2005/09/13 13:02:04;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed abolish_table_pred to work with private tables in multithreaded
(but there seems to be a memory leak that still needs to be tracked down.)
Also improved documentation of psc fields for tabling and sharedness.
Changed TDispBlk_t type for table dispatch blocks to allow direct coercion
to a TIF (so they agree on the psc and method fields.)
(Also, the load_backsuite test fails on cygwin, for a reason yet to be determined.)
----------------------------
revision 1.92
date: 2005/09/02 20:43:13;  author: tswift;  state: Exp;  lines: +48 -26

Fix to abolish_table_xxx and gc_tables to work when stacks are frozen;
and made creation of DelTF frames thread-safe.  Also, got a little
further towards reclaiming retracted clauses.

----------------------------------------------------------------------
builtin.c emuloop.c extensions_xsb.h inst_xsb.h CVS: std_cases_xsb_i.h
tr_utils.c xsb_inst_list.h CVS:
----------------------------------------------------------------------
----------------------------
revision 1.91
date: 2005/09/01 18:29:38;  author: tswift;  state: Exp;  lines: +28 -28

(mostly minor) documentation changes, and a little code movement.
----------------------------
revision 1.90
date: 2005/08/25 00:19:04;  author: dwarren;  state: Exp;  lines: +11 -3
Fix bug in abolish_table_pred for thread_private dynamic predicates.
----------------------------
revision 1.89
date: 2005/08/24 20:51:50;  author: dwarren;  state: Exp;  lines: +28 -18
Moddified psc_set_ep builtin to allow setting of ep to a fail instruction.
Made db_get_prref create a new prref if one doesn't exist.
----------------------------
revision 1.88
date: 2005/08/22 19:38:22;  author: dwarren;  state: Exp;  lines: +6 -10
Add a little more lock protection when handling private dispatch blocks
----------------------------
revision 1.87
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +4 -4
Made pflags thread private
----------------------------
revision 1.86
date: 2005/08/16 19:19:08;  author: dwarren;  state: Exp;  lines: +1 -3
Changes for multi-threading:
1. Added open/4 to allow forcing of a new open.  open/3 returns previously opened
file (with same name and mode) if there is one.  This is needed in multithreading
to allow each thread to open the same file to read it.
2. Reworked how table directives are passed from the compiler to the execution
state.  It is now passed through the xwam files, and use_subsumptive_tabling
and use_variant_tabling is also passed this way.  shared/private, and tabling (variant
or subsumptive) tags are kept in the psc record (in bits in the env byte.)
This is not completely compatible with old .xwam files, so they shoudl be
recompiled.  If they aren't, then all tabled predicates are assumed to be tabled
with variant tabling, and a warning is given.
3. Updated the compiler so that most (all?) of its output files are now
written to explicit streams (instead of using tell.)
----------------------------
revision 1.85
date: 2005/08/08 21:25:00;  author: dwarren;  state: Exp;  lines: +3 -3
SImple cleanup, mostly using define-cons instead of numbers in various places.
----------------------------
revision 1.84
date: 2005/08/08 17:11:08;  author: dwarren;  state: Exp;  lines: +258 -118
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.83
date: 2005/08/06 16:29:54;  author: tswift;  state: Exp;  lines: +79 -7

Added check of Choice point stack to abolish_all_tables to ensure that it contains no choice points for completed tables.  Also, added some stubs for gc_clauses.
----------------------------
revision 1.82
date: 2005/07/21 21:04:18;  author: dwarren;  state: Exp;  lines: +3 -1
When tabled dynamic code was abolished, the TIF and any tables computed for
that dynamic predicate were left around and their space not reclaimed.  This
update reclaims the table space and the TIF.
Also, abolish did not retract the fact that the dynamic predicate was tabled,
so this update fixes that as well.
----------------------------
revision 1.81
date: 2005/07/20 18:21:54;  author: dwarren;  state: Exp;  lines: +2 -2
Reduce initial inst_queue_size so won't overflow java default runstack size.
This may be stop-gap...
----------------------------
revision 1.80
date: 2005/07/18 21:54:00;  author: crojo;  state: Exp;  lines: +15 -13
*** empty log message ***
----------------------------
revision 1.79
date: 2005/07/15 15:02:19;  author: dwarren;  state: Exp;  lines: +96 -48
Made assert thread-safe (I hope.)  Problem was asserta, and I added
mutex_lock in jumptbreg when just entering asserted code, and I release
it after the code for the first clause to be executed is found and about
to be entered.  It introduces new instructions: dyntrymeelse, dynnoop, and
dynfail to release the lock.
assertz was made safe (I hope) without locks, by adding the new clause at the
end and then as the last thing, changing the opcode of the old-last clause
from dyntrust to retry.  Since dyntrust doesn't look at any argument, this
should work.
----------------------------
revision 1.78
date: 2005/07/13 19:51:43;  author: dwarren;  state: Exp;  lines: +167 -146
More thread-safety in assert (in generating code)
and in ptoc_longstring where I'd overlooked a static variable.
----------------------------
revision 1.77
date: 2005/07/12 21:20:48;  author: dwarren;  state: Exp;  lines: +98 -99
Made the assert buffer local to a thread to reduce length of time required
to hold the lock when asserting.  Also, reordered some code to try to reduce
the time for race-conditions when asserting.
----------------------------
revision 1.76
date: 2005/03/05 07:49:51;  author: kifer;  state: Exp;  lines: +31 -30
got rid of obvious compiler warnings
----------------------------
revision 1.75
date: 2005/01/14 18:30:49;  author: ruim;  state: Exp;  lines: +182 -148
Integration of multithreaded system
----------------------------
revision 1.74
date: 2004/09/30 13:22:21;  author: dwarren;  state: Exp;  lines: +2 -2
Refine 64-bit mods (and fix some inconsistencies I introduced yesterday...)
----------------------------
revision 1.73
date: 2004/09/29 21:41:54;  author: dwarren;  state: Exp;  lines: +2 -2
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.72
date: 2004/08/31 00:19:13;  author: dwarren;  state: Exp;  lines: +21 -7
Added option to generate anonymous var bld and uni in assert.
(and very monor cleanup to avoid warnings.)
----------------------------
revision 1.71
date: 2004/08/04 13:21:26;  author: dwarren;  state: Exp;  lines: +3 -2
Fixed a comment giving args to assert_buff_to_clref
----------------------------
revision 1.70
date: 2004/07/13 17:29:52;  author: dwarren;  state: Exp;  lines: +4 -5
Fixed memory leak in retractall on trie-asserted code.  Freed the ClRef.
----------------------------
revision 1.69
date: 2004/07/07 22:29:12;  author: dwarren;  state: Exp;  lines: +2 -2
Add initialization; necessary for getting clauses from empty predicates.
----------------------------
revision 1.68
date: 2004/02/02 20:29:48;  author: dwarren;  state: Exp;  lines: +3 -3
Change min and max macros to xsb_min and xsb_max to avoid name clash
as requested by a user.
----------------------------
revision 1.67
date: 2004/01/14 20:27:12;  author: dwarren;  state: Exp;  lines: +58 -18
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.66
date: 2004/01/06 22:19:19;  author: dwarren;  state: Exp;  lines: +23 -24
Fixed retract.  In the conversion of the code to C (several years ago)
the algorithm got changed to include a run of the hash chains when
deleting a record, in order to maintain a count of records that is
used to determine when to expand the hash table.  I've changed it to
keep a count of nonempty buckets (which is a better measure anyway),
and now it avoids the running of hash chains.  It can lead to very big
speedups in retract.
----------------------------
revision 1.65
date: 2003/10/20 12:45:45;  author: dwarren;  state: Exp;  lines: +51 -32
Fixed bugs in db_get_last_clause in handling the tree of SOB's correctly.
----------------------------
revision 1.64
date: 2003/10/17 21:23:20;  author: dwarren;  state: Exp;  lines: +54 -1
Added ability to get the last ClRef of a dynamic predicate.  Allows
access to end of a log, for retracting for undo.
----------------------------
revision 1.63
date: 2003/06/18 16:37:35;  author: lfcastro;  state: Exp;  lines: +5 -1
* Ensure invariant that psc->data for predicates always points to the
  corresponding module's psc.
----------------------------
revision 1.62
date: 2003/05/01 18:51:34;  author: dwarren;  state: Exp;  lines: +177 -107
Fix db_get_clause to allow clause and retract to work with
predicates in which the indexing is changed  after some clauses
have been asserted.  This capability seems to have been lost
with the 64-bit port.  This re-establishes it.  (Also required
changes to db_clause and machine in syslib.)
----------------------------
revision 1.61
date: 2003/04/25 18:59:33;  author: lfcastro;  state: Exp;  lines: +26 -1
* Check against asserting into open relations. Only when compiled with
  --enable-debug-assertions
* debug-assertions implies CP_DEBUG
----------------------------
revision 1.60
date: 2003/03/14 18:54:27;  author: dwarren;  state: Exp;  lines: +11 -7
Minor changes to create and use some "builtin" psc-addresses, rather than
re-insert every time one is needed.
----------------------------
revision 1.59
date: 2002/11/04 18:09:00;  author: dwarren;  state: Exp;  lines: +3 -16
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.58
date: 2002/10/28 19:05:34;  author: dwarren;  state: Exp;  lines: +4 -3
Fixed a bug in new fixed-depth indexing.
----------------------------
revision 1.57
date: 2002/10/28 14:45:02;  author: dwarren;  state: Exp;  lines: +54 -33
Multiple-argument indexing modified and extended.  Now can only do multiple-argument
indexing on arguments 1-127 (down from all 255).  The first bit of the byte
that indicates the argument to index on is now used to indicate whether to use
main functor indexing (0 as before) or "fixed-depth" indexing (1, new).  In
"fixed-depth" indexing, the first N nodes in a depth-first traversal of the term
are used for indexing.  N is a fixed global value (fixed when the XSB system is compiled,
and it is currently set to 5.)  So indexing is used if the first N nodes are nonvariable
(or if the term has fewer than N nodes, the term is ground.)  All nodes contribute to
the index.
----------------------------
revision 1.56
date: 2002/10/15 16:33:23;  author: dwarren;  state: Exp;  lines: +37 -13
Separated out routines to be callable from C to do asserting.
----------------------------
revision 1.55
date: 2002/10/08 16:56:47;  author: dwarren;  state: Exp;  lines: +5 -5
Fixed typo in comment describing layout, and fixed length error in
allocating PrRefs.  Both pointed out by Kostis. (Thanks)
----------------------------
revision 1.54
date: 2002/10/04 20:42:00;  author: lfcastro;  state: Exp;  lines: +6 -6
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.53
date: 2002/08/07 15:42:13;  author: lfcastro;  state: Exp;  lines: +39 -39
* do not use is_* functions (from the C interface) inside the
  emulator.
----------------------------
revision 1.52
date: 2002/05/31 15:09:01;  author: lfcastro;  state: Exp;  lines: +104 -104
branches:  1.52.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.51
date: 2002/05/22 15:41:12;  author: lfcastro;  state: Exp;  lines: +117 -133
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.50
date: 2001/04/28 20:15:36;  author: ejohnson;  state: Exp;  lines: +2 -2
branches:  1.50.4;
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.49
date: 2001/03/17 05:44:02;  author: kifer;  state: Exp;  lines: +4 -4
improved error messages
----------------------------
revision 1.48
date: 2001/02/26 22:13:48;  author: dwarren;  state: Exp;  lines: +11 -2
Fixed a bug that abolishing (and retractall-ing) a trie-indexed
predicate didn't release the space, causing a serious memory leak.
----------------------------
revision 1.47
date: 2001/02/19 17:36:50;  author: dwarren;  state: Exp;  lines: +6 -4
Changed db_retract_abol to pass prref instead of a buffer pointer
obtained from the prref.  Eliminates a use of buff_word, always a good
idea.
----------------------------
revision 1.46
date: 2001/02/09 21:49:54;  author: dwarren;  state: Exp;  lines: +2 -27
Removed code haveing to do with having compiled code in with asserted
code.  We disallowed that awhile ago when we separated out static and
dynamic code.
----------------------------
revision 1.45
date: 2001/02/06 16:56:36;  author: lfcastro;  state: Exp;  lines: +1 -74
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.44
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +76 -2
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.43
date: 2000/07/31 20:27:52;  author: ejohnson;  state: Exp;  lines: +2 -2
branches:  1.43.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.42
date: 2000/06/22 19:40:30;  author: ruim;  state: Exp;  lines: +3 -3
added casts to malloc calls to avoid warnings in C++
----------------------------
revision 1.41
date: 2000/06/19 07:13:06;  author: ruim;  state: Exp;  lines: +2 -2
Change for C++ compatibility
----------------------------
revision 1.40
date: 2000/06/17 23:26:13;  author: kifer;  state: Exp;  lines: +23 -20
fixed bugs having to do with trie_retract_nr
----------------------------
revision 1.39
date: 2000/05/20 06:55:55;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.38
date: 2000/05/12 20:18:14;  author: ejohnson;  state: Exp;  lines: +1 -6
Fix for builtins abolish_all_tables and abolish_table_pred.
Checks that the subgoals are (marked as) complete before destroying
the tables.

Other supporting changes:

Added a field in TableInfoFrames (TIF) for maintaining references to
the subgoals according to predicate, rather than one global list.
Routines which walked this list had to be appropriately modified.

Discovered that TIFs weren't being counted in memory usage, so changed
their allocation to use mem_alloc() instead of malloc().

Moved the code which places a TIF on the alloc chain, maintained
through `first_tip' and `last_tip', into macro New_TIF().
Removed this code from biassert.c and loader_xsb.c.

Made a structure out of `first_tip' and `last_tip'.  Added an extern
for this structure to macro_xsb.h, and hence removed the externs from
biassert.c and builtin.c.  Modified references appropriately.

Producer subgoal frame allocation now puts the SF into the predicate's
TIF.
----------------------------
revision 1.37
date: 2000/04/29 21:53:49;  author: kifer;  state: Exp;  lines: +10 -10
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.36
date: 2000/01/07 08:51:15;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.35
date: 1999/12/22 05:10:09;  author: cbaoqiu;  state: Exp;  lines: +79 -8
Added changes to support attributed variables in assert.
----------------------------
revision 1.34
date: 1999/12/21 22:56:26;  author: warren;  state: Exp;  lines: +10 -10
cleanup to reduce number of warnings given by MSVC compiler.
----------------------------
revision 1.33
date: 1999/11/17 15:05:50;  author: warren;  state: Exp;  lines: +1 -3
Took out some trace code left in by mistake.
----------------------------
revision 1.32
date: 1999/11/17 03:54:21;  author: kifer;  state: Exp;  lines: +2 -2
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.31
date: 1999/11/16 23:12:30;  author: warren;  state: Exp;  lines: +8 -3
added freeing of blocks in abolish, and fixed a call to it.
----------------------------
revision 1.30
date: 1999/11/16 19:05:49;  author: kifer;  state: Exp;  lines: +1 -7
Revamped sockets interface.
----------------------------
revision 1.29
date: 1999/11/15 21:56:46;  author: warren;  state: Exp;  lines: +4 -2
Modified retractall to directly free the buffers and not to call
delete_clause, which does a lot of work unchaining buffers.  This work
is unnecessary, since everything is being freed.
----------------------------
revision 1.28
date: 1999/11/15 21:14:53;  author: warren;  state: Exp;  lines: +16 -3
Added code so abort and retractall work OK with delyed deleting of
code buffers.  They do empty the buffer before processing, so it could
cause some new interactions with regular retract.
----------------------------
revision 1.27
date: 1999/11/12 21:42:07;  author: warren;  state: Exp;  lines: +18 -20
Minor fix in way I determine whether clause was already scheduled for
deletion.  Use a 66 flag in 1st op field of the fail instruction.
THis avoids a scan of the buffer pool.
----------------------------
revision 1.26
date: 1999/11/12 20:45:17;  author: warren;  state: Exp;  lines: +59 -32
Modified Rui's use of his circular queue of retract buffers.  They had
been used to store retracted code after it had been removed from the
clause indexing data structures.  I changed it to store pointers to
clauses before their removal.  Then when the queue fills up and real
deletion is to take place, at that time they are removed from the
indexing data structure and freed.  This fixes one common bug in
retract caused by changing a retry instruction to a try instruction
when code is deleted.
----------------------------
revision 1.25
date: 1999/11/11 03:35:12;  author: cbaoqiu;  state: Exp;  lines: +134 -202
Introduced two macros, dbgen_printinst3_macro() and
dbgen_printinst_macro(), to avoid many lines of duplicate code.  Also
fixed a minor problem in dbgen_instB_pppw: Arg1 is printed instead of
always 0.
----------------------------
revision 1.24
date: 1999/10/26 06:46:42;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.23
date: 1999/10/25 05:57:22;  author: kifer;  state: Exp;  lines: +7 -7
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.22
date: 1999/10/10 11:38:13;  author: kostis;  state: Exp;  lines: +1 -2
Changes to fold code of file "load_seg.c" into "loader.c" and thus avoid
communication between these two pieces of code through horrible global
variables.  Files "load_seg.*" are removed.  Some code cleanup took place.
----------------------------
revision 1.21
date: 1999/10/05 04:01:13;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.20
date: 1999/08/30 16:40:49;  author: kostis;  state: Exp;  lines: +8 -42
Clean up and simplification changes in various builtins and in their use.
----------------------------
revision 1.19
date: 1999/08/16 07:24:00;  author: kifer;  state: Exp;  lines: +33 -30
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.18
date: 1999/08/13 03:16:21;  author: kifer;  state: Exp;  lines: +6 -1
cleaned up a number of int -> float assignments without the cast; ifdef'ed
the definitions of min/max
----------------------------
revision 1.17
date: 1999/08/04 14:41:47;  author: ejohnson;  state: Exp;  lines: +12 -15
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.16
date: 1999/07/22 19:09:13;  author: kifer;  state: Exp;  lines: +4 -2
Got rid of compiler warnings.
----------------------------
revision 1.15
date: 1999/07/06 16:35:02;  author: ejohnson;  state: Exp;  lines: +37 -42
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.14
date: 1999/05/06 16:01:15;  author: unova;  state: Exp;  lines: +33 -14
Implemented reclaim_space and fixed a bad bug on retract_nr.
----------------------------
revision 1.13
date: 1999/04/19 18:15:01;  author: kostis;  state: Exp;  lines: +102 -139
Added some missing comments and fixed a statistics inconsistency.
----------------------------
revision 1.12
date: 1999/04/09 12:18:10;  author: kostis;  state: Exp;  lines: +13 -8
Performed clean-up of code that is either obsolete or unnecessarily inefficient
and depends on interaction between Prolog and C.
----------------------------
revision 1.11
date: 1999/03/11 17:15:08;  author: kostis;  state: Exp;  lines: +1 -5
Obsolete test for [] in the body taken out.
----------------------------
revision 1.10
date: 1999/03/09 23:08:15;  author: warren;  state: Exp;  lines: +6 -4
updated assertdebug mode to print out test_heap, and
added a repeat in the main read-loop to avoid multiple asserts to
handle abort cutpoints.
----------------------------
revision 1.9
date: 1999/02/10 17:07:30;  author: warren;  state: Exp;  lines: +2 -2
Deleted commenting out of a declaration from previous update.
----------------------------
revision 1.8
date: 1999/02/10 16:20:05;  author: warren;  state: Exp;  lines: +27 -16
Added test_heap instructions to asserted code.
Changed the allocate instruction in teh header for tabled asserted
code to an allocate_gc.
Did general cleanup of builtin db_build_prref, and simplified its
calling conventions.
----------------------------
revision 1.7
date: 1999/01/31 14:54:02;  author: kostis;  state: Exp;  lines: +3 -4
Changed bopy to memmove to avoid warning on Linux.
----------------------------
revision 1.6
date: 1999/01/26 17:20:16;  author: unova;  state: Exp;  lines: +2 -2
db_build_prref: microscopic fix for a bug that caused dynamic tabled
preds to make abolish_all_tables loop.
----------------------------
revision 1.5
date: 1999/01/24 17:07:45;  author: kostis;  state: Exp;  lines: +2 -2
Rectified type definitions in delete_branch().
----------------------------
revision 1.4
date: 1999/01/19 16:45:11;  author: kostis;  state: Exp;  lines: +7 -7
Eliminated some dependency on 255's arbitrarily placed in the code.
----------------------------
revision 1.3
date: 1999/01/18 15:37:28;  author: kostis;  state: Exp;  lines: +57 -81
Cleanup changes to make less functions visible to other modules.
----------------------------
revision 1.2
date: 1998/12/21 01:07:49;  author: cbaoqiu;  state: Exp;  lines: +13 -12
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:11;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:11;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.43.2.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.43.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +78 -3
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.50.4.4
date: 2004/11/24 21:53:24;  author: ruim;  state: Exp;  lines: +6 -8
made smBTHT and smBTN thread specific
----------------------------
revision 1.50.4.3
date: 2004/11/04 22:31:09;  author: tswift;  state: Exp;  lines: +3 -3

Changes for compilation in cygwin.  This will not affect the linux distribution (I hope).
Changes are:

	1) execute -> xsb_execute, to avoid conflict with pthread.h in cygwin
	2) Renamed mutex constants to accord with pthread.h in cygwin.
----------------------------
revision 1.50.4.2
date: 2004/10/18 20:45:55;  author: ruim;  state: Exp;  lines: +456 -336
update for version 2.6.1
----------------------------
revision 1.50.4.1
date: 2004/09/29 19:43:53;  author: ruim;  state: Exp;  lines: +167 -131
Sources from rfm repository
----------------------------
revision 1.52.2.5
date: 2003/04/17 17:11:54;  author: lfcastro;  state: Exp;  lines: +11 -7
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.52.2.4
date: 2003/02/11 18:36:29;  author: lfcastro;  state: Exp;  lines: +2 -15
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.52.2.3
date: 2002/10/29 15:28:46;  author: lfcastro;  state: Exp;  lines: +3 -2
* applied bugfix from mainline
----------------------------
revision 1.52.2.2
date: 2002/10/28 16:49:29;  author: lfcastro;  state: Exp;  lines: +98 -53
* Merge with HEAD
----------------------------
revision 1.52.2.1
date: 2002/08/07 17:53:34;  author: lfcastro;  state: Exp;  lines: +39 -39
* update to HEAD
----------------------------
revision 1.173.2.4
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.173.2.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +9 -1
no message
----------------------------
revision 1.173.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +76 -0
no message
----------------------------
revision 1.173.2.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/biassert_defs.h,v
Working file: biassert_defs.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.11
	ROLLBACK: 1.7
	latest_plus_supp_branch: 1.7.0.4
	latest_plus_supp: 1.7
	Version_3dot2_plus_supp: 1.7.0.2
	Version_3dot2: 1.7
	dec07-perf-results: 1.4
	mt_thesis: 1.2
	release_3_0: 1.2
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.11
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.10
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.9
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7
date: 2008/08/01 20:11:24;  author: tswift;  state: Exp;  lines: +1 -0
branches:  1.7.4;
Forgot to commit.
----------------------------
revision 1.6
date: 2008/03/16 22:11:55;  author: tswift;  state: Exp;  lines: +1 -0

convert_to_dyna in C.  This speeds up assert/trie assert.  It also
refactors uses mutex_dynamic so that it is only locked when creating a
new prref, rather than whenever convert_to_dyna is called (something
stupid I did when I didnt really understand XSB's dynamic code.
----------------------------
revision 1.5
date: 2007/12/24 19:16:59;  author: tswift;  state: Exp;  lines: +9 -0

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.4
date: 2007/10/19 21:15:16;  author: tswift;  state: Exp;  lines: +1 -0

Changes to add call_cleanup/2, whose semantics is ISO compliant as far
as the ISO definition goes.  I also put call_cleanup/2 in std_xsb.P.
Cleanup handlers are scheduled through the attv interrupt chain, so I
needed to hack this code a little to make sure that an interrupt
handler for cleanups is always present.

Also, I made a change to peephole to not optimize away a putpbreg_ci
-- we'll usually need it for call_cleanups.

Right now I'm using a static inline for CHECK_CALL_CLEANUP -- on gcc
this should be as fast as a macro and allows me to trace if there are
any problems.


Adding these changes made me need to adjust a few include statements
in tr_utils.c and tst_retrv.c
----------------------------
revision 1.3
date: 2007/04/05 17:26:56;  author: tswift;  state: Exp;  lines: +9 -0
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.2
date: 2006/07/14 16:49:36;  author: tswift;  state: Exp;  lines: +5 -3

Fixed relatively obscure bugs in clause gc.  With these fixes, the gc testsuite is working again, as does the flora testsuite.

Changes are (1 traverse CPS from bfreg if needed; 2 dont reclaim if there are ;/2 or db_get_clause CPs in the stack.

Also changed dis to allow it to print to a file if needed.
----------------------------
revision 1.1
date: 2006/04/27 01:05:26;  author: tswift;  state: Exp;

Changed structure of retractall as called with non-open terms --
i.e. when a gen_retractall is NOT called.  The basic change was
to factor out the potentially expensive marking and unmarking
operations outside of the retract and to call them as builtins
before and after the retract itself.

Changes for code cleanup (db_remove_prref changed to db_abolish0).

Associated changes were also made to the test suite.
----------------------------
revision 1.7.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.7.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/binding.h,v
Working file: binding.h
head: 1.26
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.24
	ROLLBACK: 1.19
	latest_plus_supp_branch: 1.19.0.4
	latest_plus_supp: 1.19
	Version_3dot2_plus_supp: 1.19.0.2
	release_2_6_plus_supp: 1.16.0.6
	Version_3dot2: 1.19
	dec07-perf-results: 1.19
	mt_thesis: 1.19
	release_3_0: 1.19
	release_2_7_0: 1.16
	multi-threaded-26-engine: 1.15.2.2
	pre-mt: 1.16
	multi-threaded-25-engine-done: 1.15.2.1
	multi-threaded-25-engine: 1.15.0.2
	release_2_6_1: 1.16
	release_2_6_final: 1.16
	release_2_6: 1.16.0.4
	last-merged-to-demand: 1.16
	demand_branch: 1.16.0.2
	before_removing_chat: 1.15
	release_2_5: 1.15
	pre-merge-slgwam-gc: 1.14
	multi-threaded-c-engine: 1.14.0.2
	release_2_4: 1.14
	release_2_3: 1.14
	multi-threaded-engine: 1.12.0.2
	pre-threading: 1.12
	release-2-2: 1.11
	chat-and-local: 1.11.0.2
	xsb-pre-cleanup: 1.11
	release-2-1: 1.9
	release-2-0-1: 1.9
	subsumption: 1.6
	without-attv: 1.4
	release-2-0: 1.4
	pre-release-2-0: 1.3
	v1-9-8: 1.3
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 36;	selected revisions: 36
description:
----------------------------
revision 1.26
date: 2011/11/11 18:21:39;  author: dwarren;  state: Exp;  lines: +19 -3
Added flag[UNIFY_WITH_OCCURS_CHECK_FLAG] that when true causes XSB
to do all unifications with occur_check.  (Not completely tested, and
better efficiency is possible by having compiler generate different
bldval instructions when it can determine that occur-check isn't needed.)
----------------------------
revision 1.25
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.24
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.23
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.22
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.21
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.20
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.19
date: 2005/07/22 15:42:12;  author: crojo;  state: Exp;  lines: +2 -2
branches:  1.19.4;

Made double floating point numbers the default. Single precision floats can be reverted to with the configure option --enable-fast-floats
----------------------------
revision 1.18
date: 2005/07/18 21:54:01;  author: crojo;  state: Exp;  lines: +51 -12
*** empty log message ***
----------------------------
revision 1.17
date: 2005/01/14 18:30:50;  author: ruim;  state: Exp;  lines: +5 -5
Integration of multithreaded system
----------------------------
revision 1.16
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -59
* Removal of Chat engine
----------------------------
revision 1.15
date: 2002/01/23 17:08:07;  author: dwarren;  state: Exp;  lines: +16 -1
branches:  1.15.2;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.14
date: 2001/02/06 16:56:36;  author: lfcastro;  state: Exp;  lines: +1 -11
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.13
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +17 -1
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.12
date: 2000/04/29 21:53:49;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.12.2;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.11
date: 1999/12/14 21:03:52;  author: ejohnson;  state: Exp;  lines: +13 -11
branches:  1.11.2;
Put {} around nbldval.
----------------------------
revision 1.10
date: 1999/12/10 07:47:25;  author: kifer;  state: Exp;  lines: +1 -3
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.9
date: 1999/11/04 23:53:06;  author: cbaoqiu;  state: Exp;  lines: +8 -8
Simplified the definition of macro push_pre_image_trail().
----------------------------
revision 1.8
date: 1999/10/28 03:22:24;  author: cbaoqiu;  state: Exp;  lines: +76 -26
Put pre-image trail stuff into `#ifdef PRE_IMAGE_TRAIL' (for Kostis),
and added some comments about trail frame data structures in binding.h
(for Ernie).
----------------------------
revision 1.7
date: 1999/10/24 20:09:33;  author: cbaoqiu;  state: Exp;  lines: +17 -15
Added two macros for pre-image trail in CHAT, and changed the macro of
table_undo_bindings().  More work needs to be done in function
chat_trail_copy(), etc.
----------------------------
revision 1.6
date: 1999/10/10 04:11:52;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Added the two missing `{'s in push_pre_image_trail0.
----------------------------
revision 1.5
date: 1999/10/09 02:00:19;  author: cbaoqiu;  state: Exp;  lines: +66 -4
Changes for attributed variables (first step).
----------------------------
revision 1.4
date: 1999/04/29 12:04:18;  author: kostis;  state: Exp;  lines: +5 -3
Changed trail stack overflow check for SLG-WAM.
----------------------------
revision 1.3
date: 1999/02/18 13:02:19;  author: kostis;  state: Exp;  lines: +12 -2
Changes to check for trail stack overflow in pushtrail0().
----------------------------
revision 1.2
date: 1998/12/21 01:07:52;  author: cbaoqiu;  state: Exp;  lines: +13 -2
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.11.2.2
date: 2000/09/13 18:41:09;  author: lfcastro;  state: Exp;  lines: +1 -37
Changes:

*Makefile
	- create target for 'make etags'

*emu/binding.h
	- got rid of #ifdef's on WAM_TRAIL

*emu/chat.c
	- commented out a switch_envs(breg) in
	  chat_restore_compl_susp_trail
	- introduced function chat_free_cp_compl_susp_chat_areas
	  needed for bugfix in cut_xsb.h
	- change in restore_answer_template

*emu/cut_xsb.h
	- bugfix in check_table_cut

*lib/Makefile
	- put '-g none' in calls to XSB to be able to compile when GC
	  isn't working

*general
	- changes/introduction in/of debug messages

Status:
Passes the testsuite for all tests, except for the gctests with the
copying collector, which fails for tests wfs_tests/p53 (and up).
----------------------------
revision 1.11.2.1
date: 2000/03/28 18:10:30;  author: lfcastro;  state: Exp;  lines: +1 -6
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.12.2.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.12.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.15.2.2
date: 2004/10/18 20:45:55;  author: ruim;  state: Exp;  lines: +1 -59
update for version 2.6.1
----------------------------
revision 1.15.2.1
date: 2004/09/29 19:43:53;  author: ruim;  state: Exp;  lines: +7 -7
Sources from rfm repository
----------------------------
revision 1.19.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.19.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.19.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/bineg.i,v
Working file: bineg.i
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.13
	without-attv: 1.13
	release-2-0: 1.10
	pre-release-2-0: 1.9
	v1-9-8: 1.7
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.14
date: 1999/10/25 05:57:24;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.13
date: 1999/08/16 07:24:02;  author: kifer;  state: Exp;  lines: +12 -12
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.12
date: 1999/08/10 12:17:52;  author: kostis;  state: Exp;  lines: +9 -6
lean up and slight improvement of string manipulation builtins.
Eliminated building of strings in the heap (like eg. in str_cat)
without checking for overflows.  Now str_cat occurs in a buffer
of its own.  Also, made str_* routines test their arguments for
the correct types and unify their output arguments.
----------------------------
revision 1.11
date: 1999/07/06 16:35:03;  author: ejohnson;  state: Exp;  lines: +2 -3
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.10
date: 1999/06/14 00:32:07;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Fixed a bug in GET_DELAY_LISTS: changed the place to call
free(copy_of_var_addr).
----------------------------
revision 1.9
date: 1999/04/22 06:49:09;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.8
date: 1999/04/04 03:54:44;  author: kifer;  state: Exp;  lines: +5 -9
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.7
date: 1999/02/02 17:16:59;  author: kostis;  state: Exp;  lines: +1 -2
Silly include for debugging taken out.
----------------------------
revision 1.6
date: 1999/01/29 20:06:42;  author: kostis;  state: Exp;  lines: +3 -6
Important changes: Saving of argument registers for completion suspension
choice points is not needed either in the SLG-WAM or in CHAT.
----------------------------
revision 1.5
date: 1999/01/18 17:59:30;  author: kostis;  state: Exp;  lines: +1 -22
Changes to make ptcp pointing to subgoal frame independently of engine used.
----------------------------
revision 1.4
date: 1999/01/10 01:02:50;  author: cbaoqiu;  state: Exp;  lines: +13 -13
Change all occurrences of num_vars_in_var_regs in builtin
GET_DELAY_LISTS to global_num_vars.
----------------------------
revision 1.3
date: 1998/12/21 01:07:53;  author: cbaoqiu;  state: Exp;  lines: +40 -22
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 02:58:30;  author: cbaoqiu;  state: Exp;  lines: +82 -23
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  Builtin GET_DELAY_LISTS is rewritten to support variables.
----------------------------
revision 1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/bineg_xsb_i.h,v
Working file: bineg_xsb_i.h
head: 1.51
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.47
	ROLLBACK: 1.42
	latest_plus_supp_branch: 1.42.0.4
	latest_plus_supp: 1.42
	Version_3dot2_plus_supp: 1.42.0.2
	release_2_6_plus_supp: 1.18.0.6
	Version_3dot2: 1.42
	dec07-perf-results: 1.36
	mt_thesis: 1.33
	release_3_0: 1.29
	release_2_7_0: 1.18
	multi-threaded-26-engine: 1.15.2.2
	pre-mt: 1.18
	multi-threaded-25-engine-done: 1.15.2.1
	multi-threaded-25-engine: 1.15.0.2
	release_2_6_1: 1.18
	release_2_6_final: 1.18
	release_2_6: 1.18.0.4
	last-merged-to-demand: 1.18
	demand_branch: 1.18.0.2
	before_removing_chat: 1.15
	release_2_5: 1.15
	pre-merge-slgwam-gc: 1.14
	multi-threaded-c-engine: 1.14.0.2
	release_2_4: 1.14
	release_2_3: 1.11
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.5
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 60;	selected revisions: 60
description:
----------------------------
revision 1.51
date: 2012/06/07 19:37:41;  author: tswift;  state: Exp;  lines: +8 -1

A number of changes to extend forest logging to handle negation.
----------------------------
revision 1.50
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +7 -7

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.49
date: 2011/01/09 22:30:15;  author: tswift;  state: Exp;  lines: +3 -3

Minor code cleanup: some changes in documentation, changes to make a
function name accord with a builtin name, and moved some table
abolishing routines from tries.c to tr_utils.c with all the others.
----------------------------
revision 1.48
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +15 -15

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.47
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.46
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.45
date: 2010/08/17 21:10:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.44
date: 2010/08/17 20:48:35;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.43
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.42
date: 2009/01/02 17:50:03;  author: tswift;  state: Exp;  lines: +7 -5
branches:  1.42.4;


Updating a number of files so that delete_branch() will work with call
subsumption (it needs to know that it deallocates BTNs rather than
TSTNs).  This fixed a latent bug in simplification and allows another
test to be run for call subsumption. It also provides a step towards
supporting answer subsumption on call subsumptive tables.  There are
also some other documentationstyle changes.

Adding a new test for copying attributed variables into delay elements
/ lists.  I hadn't thought this worked, but apparently it does !

Also, I'm adding a very simple test for incremental evaluation -- more
cases need to be added here, but at least this is a start.
----------------------------
revision 1.41
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +5 -1


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.40
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +1 -4
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.39
date: 2008/06/05 18:15:11;  author: ruim;  state: Exp;  lines: +5 -11
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.38
date: 2008/06/04 13:23:24;  author: ruim;  state: Exp;  lines: +21 -26
tidy up of shared completed tables code
completing mut is now locked much less time
----------------------------
revision 1.37
date: 2008/03/10 16:21:49;  author: dwarren;  state: Exp;  lines: +2 -2
Fix bug in addintfastasgn instruction (to trail if binding to a variable.)
Also a cuple of comments to indicate where memory problems are wrt delay lists
(which may reduce search time the next time this bug shows up....)
----------------------------
revision 1.36
date: 2007/11/24 07:38:40;  author: ruim;  state: Exp;  lines: +1 -4
rolled back last commit
it was unsafe
----------------------------
revision 1.35
date: 2007/11/24 06:53:58;  author: ruim;  state: Exp;  lines: +5 -2
released the completing mut during the more heavy duty tasks
when the leader is reseting the other threads in the SCC
in shared completed tables
----------------------------
revision 1.34
date: 2007/02/23 20:17:04;  author: tswift;  state: Exp;  lines: +2 -2
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.33
date: 2006/12/13 02:24:41;  author: ruim;  state: Exp;  lines: +11 -6
changed lock on completing mut to be done only if the
table is shared
----------------------------
revision 1.32
date: 2006/12/02 19:31:57;  author: ruim;  state: Exp;  lines: +2 -2
moved in lock of compl mutex to avoid locking if non leader
some standartization and ifx of potential bugs for conc compl
----------------------------
revision 1.31
date: 2006/11/30 21:10:24;  author: ruim;  state: Exp;  lines: +3 -1
Moved DELAY_MUTEX in, in do_delay_stuff_shared to avoid unneeded locks

New Feature:
 Pseudo Mutexes

  These are system mutexes which are just used for counting in place of
  either sets of mutexes (call trie, struct manager) or mutexes
  that really don't fit in the SYS_MUTEX convention (completing_mut,
  th_mutex)

  It allows to re-use the statistics stuff for these mutexes.
----------------------------
revision 1.30
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +6 -4
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.29
date: 2006/02/16 18:32:49;  author: dwarren;  state: Exp;  lines: +3 -2
Fixed a memory bug that showed up when newly needed memory was more than twice
previous memory.  Showed up in trie_interned.  Added explicit argument to
memory allocator to provide needed amount.
----------------------------
revision 1.28
date: 2006/01/23 21:21:31;  author: tswift;  state: Exp;  lines: +4 -2

Fixed bug in is_incomplete: no overflow check was made before
allocating a completion suspension frame.

The bug was uncovered during testing thread-safety of the MT
engine.  This 1-line change took me most of the day to find ...
c'est la vie.
----------------------------
revision 1.27
date: 2006/01/12 21:33:49;  author: tswift;  state: Exp;  lines: +12 -8
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.26
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +6 -3
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.25
date: 2005/11/12 15:48:49;  author: dwarren;  state: Exp;  lines: +3 -3
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.24
date: 2005/09/30 20:04:26;  author: ruim;  state: Exp;  lines: +1 -2
bugfixes for concurrent completion
----------------------------
revision 1.23
date: 2005/08/13 15:04:02;  author: ruim;  state: Exp;  lines: +3 -3
changed defines to allow concurrent completion
made batch compile under mt
----------------------------
revision 1.22
date: 2005/08/04 19:35:19;  author: ruim;  state: Exp;  lines: +6 -6
fix for deadlock breaking with negation
----------------------------
revision 1.21
date: 2005/08/01 19:10:47;  author: ruim;  state: Exp;  lines: +8 -1
changes to break deadlocks in negation and handle early completion
----------------------------
revision 1.20
date: 2005/07/26 13:10:57;  author: ruim;  state: Exp;  lines: +34 -1
extended shared completed tables to handle negation
----------------------------
revision 1.19
date: 2005/01/14 18:30:50;  author: ruim;  state: Exp;  lines: +6 -6
Integration of multithreaded system
----------------------------
revision 1.18
date: 2002/05/31 15:09:01;  author: lfcastro;  state: Exp;  lines: +9 -9
branches:  1.18.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.17
date: 2002/05/22 15:41:12;  author: lfcastro;  state: Exp;  lines: +23 -25
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.16
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -6
* Removal of Chat engine
----------------------------
revision 1.15
date: 2001/12/13 21:13:36;  author: lfcastro;  state: Exp;  lines: +10 -1
branches:  1.15.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.14
date: 2001/07/07 00:18:24;  author: ejohnson;  state: Exp;  lines: +8 -2
Plugged a VarString memory leak.
----------------------------
revision 1.13
date: 2001/06/22 21:07:23;  author: tswift;  state: Exp;  lines: +5 -1

Improved (to my taste) DEBUG_DELAY
----------------------------
revision 1.12
date: 2001/04/28 20:15:36;  author: ejohnson;  state: Exp;  lines: +3 -3
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.11
date: 2000/12/08 17:26:46;  author: ejohnson;  state: Exp;  lines: +39 -97
Altered the manner in which the truth of negated subsumptive
predicates are evaluated.  Originally I relied upon the interpretive
timestamp-based relevant-answer collection function, but this requires
the Time Stamp Indices to be present in the TST.  If the producer has
completed before the collection, then these structures would have
already been be reclaimed.

The new approach checks for a relevant answer using the
trie_get_return/2 builtin.  If one is found, then the literal can be
failed.  Otherwise, the producer must be checked for completion and
whether the negative-delay flag has been set.  This is performed
through a new builtin, lrd_success/2.  Therefore, slg_not/1 is restored
for handling variant tabled predicates only.
----------------------------
revision 1.10
date: 2000/12/04 17:10:42;  author: ejohnson;  state: Exp;  lines: +112 -16
Added support for subsumption-based LRD stratified negation,
including:

o Modification of 't not'/1 to accept all predicates.

o Replacement of predicate get_producer_subgoal_frame/2 with a new
  predicate get_producer_call/3 (ala get_call/3 and friends) to take
  the subgoal and perform a tabling-strategy-dependent lookup,
  returning a producer's subgoal frame and an answer template with
  respect to that producer.

  get_producer_call/3 aborts if given a non-tabled predicate and fails
  if the tabled predicate hasn't been called before.

o Modification of slg_not/1 s.t. it takes two extra arguments: the
  first is the answer template from get_producer_call/3, used by
  negated, properly subsumed predicates for relevant-answer
  collection; the second contains the subgoal which is negated, used
  only for error reporting.

o Extension of certain C functions, e.g. get_variant_sf() and
  get_subsumer_sf() to build and return, in an extra argument, the
  answer template.
----------------------------
revision 1.9
date: 2000/10/05 17:23:14;  author: ejohnson;  state: Exp;  lines: +4 -4
branches:  1.9.2;
Added two more structure tests to Structure Manager code:
- smIsAllocatedStruct(SM,struct) checks whether a known valid struct is
    currently allocated wrt its SM.
- smIsAllocatedStructRef(SM,struct) combines the functionality of
    smIsValidStructRef() and smIsAllocatedStruct().
Also changed argument passing style of SM from pass-by-ref to pass-by value.

Added extra checks to TRIE_DELETE_RETURN builtin to ensure that (1)
leaf node is currently allocated, (2) that it is in fact a leaf, and
(3) that it appears in the answer set associated with the given
subgoal frame.
----------------------------
revision 1.8
date: 2000/09/28 21:31:01;  author: ejohnson;  state: Exp;  lines: +46 -48
Two subsumption-related changes:

(1) Support for incomplete subsumptive subgoals in tfindall/3.
    Two builtins needed modification:
    -- get_subgoal_ptr/2 ==> get_producer_subgoal_frame/2
         Now handles both variant and subsumptive subgoals, returning
	 the producing table entry.
    -- is_incomplete/4 ==> is_incomplete/2
         Now handles both variant and subsumptive subgoals.  Used to
	 encompass some of the functionality of get_subgoal_ptr/2, but
	 since the processing performed by that builtin is more complex,
	 this (partial) functionality is removed.

(2) Standard predicate delete_return/2 produces an error when invoked
    on a subsumptive table entry.
----------------------------
revision 1.7
date: 2000/07/31 20:27:52;  author: ejohnson;  state: Exp;  lines: +3 -3
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.6
date: 2000/06/24 13:55:04;  author: ruim;  state: Exp;  lines: +2 -2
Casts to avoid void * implicit conversion
----------------------------
revision 1.5
date: 2000/05/29 04:23:33;  author: ejohnson;  state: Exp;  lines: +4 -4
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.4
date: 2000/04/29 21:53:50;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.3
date: 1999/12/14 21:04:53;  author: ejohnson;  state: Exp;  lines: +6 -6
branches:  1.3.2;
Effect of change of return type of get_subgoal_ptr().  Modified casts.
----------------------------
revision 1.2
date: 1999/10/29 14:29:02;  author: kostis;  state: Exp;  lines: +63 -58
Many changes to define variables in smallest possible block that they are
used.  There is a *significant* speedup potential by doing so.  I will,
hopefully soon, write a mail about this.
----------------------------
revision 1.1
date: 1999/10/25 05:57:25;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.2.1
date: 2000/03/28 18:10:30;  author: lfcastro;  state: Exp;  lines: +1 -11
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.15.2.2
date: 2004/10/18 20:45:55;  author: ruim;  state: Exp;  lines: +23 -30
update for version 2.6.1
----------------------------
revision 1.15.2.1
date: 2004/09/29 19:43:54;  author: ruim;  state: Exp;  lines: +6 -6
Sources from rfm repository
----------------------------
revision 1.18.2.1
date: 2003/05/13 18:12:54;  author: lfcastro;  state: Exp;  lines: +6 -7
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.42.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.42.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.42.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/box_defines.h,v
Working file: box_defines.h
head: 1.10
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.10
	ROLLBACK: 1.6
	latest_plus_supp_branch: 1.6.0.4
	latest_plus_supp: 1.6
	Version_3dot2_plus_supp: 1.6.0.2
	Version_3dot2: 1.6
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.10
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.9
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6
date: 2008/03/29 21:04:05;  author: tswift;  state: Exp;  lines: +1 -1
branches:  1.6.4;

Fixed 64-bit bugs in read_canonical_term.  It passes back an "old" psc
record, but was using the int type for the psc rether than Integer in
a couple of places.  This mostly affected load_dync.
----------------------------
revision 1.5
date: 2008/03/29 19:14:55;  author: tswift;  state: Exp;  lines: +23 -6

Fixed conversion routines for boxed floats.  However in order to get
boxed floats to work right now, you need to compile with a 32 bit engine.  I'll try to fix that soon.

The test suite runs better now, but not perfectly, so there are still a few things to fix, perhaps in the intersection of tabling and assert.
----------------------------
revision 1.4
date: 2006/06/23 14:53:10;  author: tswift;  state: Exp;  lines: +2 -2

Added extern_ macros for C interface functions not yet covered.

Change to box_defines.h to get rid of whitespace before #endif (non-portable)
----------------------------
revision 1.3
date: 2005/12/12 00:19:11;  author: tswift;  state: Exp;  lines: +23 -0

Mutexed socket calls which dont seem to be mutexed.  Also added a
mutex around some rarely used string/symbol table statistics.

Other than that, documentation.
----------------------------
revision 1.2
date: 2005/07/22 15:42:13;  author: crojo;  state: Exp;  lines: +5 -2

Made double floating point numbers the default. Single precision floats can be reverted to with the configure option --enable-fast-floats
----------------------------
revision 1.1
date: 2005/07/18 21:54:01;  author: crojo;  state: Exp;
*** empty log message ***
----------------------------
revision 1.6.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.6.4.2
date: 2010/06/19 19:38:18;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/builtin.c,v
Working file: builtin.c
head: 1.393
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.352
	ROLLBACK: 1.346
	latest_plus_supp_branch: 1.341.0.2
	latest_plus_supp: 1.341
	release_2_6_plus_supp: 1.161.0.4
	Version_3dot2: 1.325
	dec07-perf-results: 1.301
	mt_thesis: 1.272
	release_3_0: 1.269
	release_2_7_0: 1.191
	multi-threaded-26-engine: 1.139.2.6
	pre-mt: 1.191
	multi-threaded-25-engine-done: 1.139.2.1
	multi-threaded-25-engine: 1.139.0.2
	release_2_6_1: 1.161.2.2
	release_2_6_final: 1.161
	release_2_6: 1.161.0.2
	last-merged-to-demand: 1.144
	demand_branch: 1.143.0.2
	before_removing_chat: 1.139
	release_2_5: 1.139
	pre-merge-slgwam-gc: 1.132
	multi-threaded-c-engine: 1.132.0.2
	release_2_4: 1.127
	release_2_3: 1.115
	multi-threaded-engine: 1.108.0.2
	pre-threading: 1.98
	release-2-2: 1.90
	chat-and-local: 1.88.0.2
	xsb-pre-cleanup: 1.88
	release-2-1: 1.79
	release-2-0-1: 1.76
	subsumption: 1.69
	without-attv: 1.65
	release-2-0: 1.41
	pre-release-2-0: 1.37
	v1-9-8: 1.21
	code-fixer-new: 1.6
	code-fixer: 1.6
	delayvar_ok: 1.6
	r1-9-b6: 1.4
	r1-9-b5: 1.3
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 416;	selected revisions: 416
description:
----------------------------
revision 1.393
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +2 -2

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.392
date: 2012/03/19 15:19:58;  author: dwarren;  state: Exp;  lines: +1 -2
Fixed a couple of declarations, not at the beginning of blocks.
Added some casts to quiet MSVC.
Conditioned the inline declarations of prolog_call0 and prolog_code_call,
which can't be external in MSVC.
----------------------------
revision 1.391
date: 2012/03/16 19:25:59;  author: tswift;  state: Exp;  lines: +2 -2

Allow failure of incremental builtins.
----------------------------
revision 1.390
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +4 -2

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.389
date: 2012/02/12 22:49:12;  author: tswift;  state: Exp;  lines: +3 -3

Fixed bug in throwing exceptions with incomplete tables.  Now tables
are reclaimed by unwind stack so that they stop *between* SCCs: this
allows us to continue reclaiming incomplete tables while at the same
time ensuring that we wont backtrack into a choice point for one of
those tables that we reclaimed.
----------------------------
revision 1.388
date: 2012/02/05 16:44:58;  author: tswift;  state: Exp;  lines: +2 -2

Added ground_and_acyclic/1.
----------------------------
revision 1.387
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +8 -3
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.386
date: 2012/01/12 14:27:36;  author: dwarren;  state: Exp;  lines: +2 -2
Changed sprintTerm to sprintCyclicTerm where we know it's a cyclic term we're printing.
----------------------------
revision 1.385
date: 2011/12/19 21:39:25;  author: waltergwilson;  state: Exp;  lines: +3 -1
ground_cyc/1
----------------------------
revision 1.384
date: 2011/12/17 12:44:43;  author: dwarren;  state: Exp;  lines: +6 -20
Simplified the code to handle attributed variables in excess_vars.
----------------------------
revision 1.383
date: 2011/12/16 21:57:11;  author: dwarren;  state: Exp;  lines: +22 -4
Fixed excess_vars to handle attributed variables.
----------------------------
revision 1.382
date: 2011/12/11 23:07:25;  author: dwarren;  state: Exp;  lines: +5 -2
A number of changes to fix bugs and make XSB more ISO compliant (from U.Neumerkel)
1. Made length/2 slightly more resiliant.
2. Added a cyclic term check in atom_codes.
3. fixed bug in call/n to non-existent predicate
4. Added new operators (for ISO): ^, div, xor (and changed ** to always return float.)
5. Added new ISO predicate names: acyclic_term, and subsumes_term.
6. Made number_codes/chars more ISO compliant (mostly on unusual inputs)
7. Increased precision of floating point numbers in write_canonical.
8. Added cputime to load message (if > 0.0 secs), desired by MK
9. Support reading and writing of 0-ary predicates in form p().  (This is not
	fully implemented and should not in general be used.)
----------------------------
revision 1.381
date: 2011/11/12 00:33:31;  author: tswift;  state: Exp;  lines: +2 -2

Added depth check for interned tries -- use tabled answer depth /
action flags.
----------------------------
revision 1.380
date: 2011/11/11 18:21:39;  author: dwarren;  state: Exp;  lines: +4 -2
Added flag[UNIFY_WITH_OCCURS_CHECK_FLAG] that when true causes XSB
to do all unifications with occur_check.  (Not completely tested, and
better efficiency is possible by having compiler generate different
bldval instructions when it can determine that occur-check isn't needed.)
----------------------------
revision 1.379
date: 2011/11/09 02:28:19;  author: dwarren;  state: Exp;  lines: +2 -2
Changed unify to unify cyclic terms without going into an infinite loop.

Also fixed some calls to print term that gave too large a level parameter
which caused overflow of C runstack.
----------------------------
revision 1.378
date: 2011/10/29 23:27:58;  author: tswift;  state: Exp;  lines: +22 -150

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.377
date: 2011/10/19 22:51:28;  author: tswift;  state: Exp;  lines: +9 -1

Changes to C trace to indicate the state of a tabled subgoal (new/complete/incomplete)
also emitting where an error was called from.

Also, some small change to get call abstracting compiling under MSVC.
----------------------------
revision 1.376
date: 2011/10/12 17:18:54;  author: dwarren;  state: Exp;  lines: +9 -1
Added new case to xwam_state to return estimate of current memory from the system.  (Used in new memory_bounded_call/3.)
----------------------------
revision 1.375
date: 2011/10/09 19:38:37;  author: waltergwilson;  state: Exp;  lines: +2 -1
term_size_limit/2
----------------------------
revision 1.374
date: 2011/10/05 21:29:09;  author: tswift;  state: Exp;  lines: +2 -1

Added TERM_SIZE macro.
----------------------------
revision 1.373
date: 2011/10/05 19:16:10;  author: waltergwilson;  state: Exp;  lines: +2 -1
term_size/2
----------------------------
revision 1.372
date: 2011/09/23 18:36:07;  author: tswift;  state: Exp;  lines: +11 -1

Changes for timed_call/3
----------------------------
revision 1.371
date: 2011/08/22 16:15:24;  author: dwarren;  state: Exp;  lines: +6 -3
Cleaned up recent checkins to work with MSVC, and avoid warnings.
(Changed bzero to memset, since MS seems not to have bzero.)
Also changed a couple of builtins to be more consistent in their
treatment of string p vs. 0-ary structure symbol p.
----------------------------
revision 1.370
date: 2011/08/15 15:10:25;  author: dwarren;  state: Exp;  lines: +2 -2
Minor changes to quiet 64-bit compilation (or use 64-bit compatible decls).
Minor change to tokenizer to make it more standardish(?) for \NUM form.
One decl moved to work with ANSI C (MSVC).
----------------------------
revision 1.369
date: 2011/08/13 19:56:20;  author: tswift;  state: Exp;  lines: +2 -1

is_cyclic + fix to weird bug with not initializaing memory errors...
----------------------------
revision 1.368
date: 2011/08/12 15:17:13;  author: tswift;  state: Exp;  lines: +27 -29

Fixes for approximate tabling and correcting memory errors.
----------------------------
revision 1.367
date: 2011/08/06 19:14:19;  author: tswift;  state: Exp;  lines: +4 -4
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.366
date: 2011/08/04 19:52:57;  author: tswift;  state: Exp;  lines: +2 -1


term_depth/1
----------------------------
revision 1.365
date: 2011/08/03 18:05:34;  author: tswift;  state: Exp;  lines: +3 -1
Got rid of a compiler warning while compiling with mt
----------------------------
revision 1.364
date: 2011/06/22 21:27:53;  author: tswift;  state: Exp;  lines: +14 -2

Now maintaining gc time for abolishing tables -- this way I can tell
if my heuristics are out of whack for some program.
----------------------------
revision 1.363
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +5 -5
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.362
date: 2011/05/22 15:12:25;  author: tswift;  state: Exp;  lines: +5 -5

Changes to fix compiler warnings on various Mac configurations.
----------------------------
revision 1.361
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +3 -3
Getting Linux to Work
----------------------------
revision 1.360
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +76 -74
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.359
date: 2011/04/15 03:11:03;  author: kifer;  state: Exp;  lines: +19 -1
Added url_encode/url_decode.
----------------------------
revision 1.358
date: 2011/04/01 16:36:22;  author: tswift;  state: Exp;  lines: +7 -4

Added incremental_needs_reeval to table_state.
----------------------------
revision 1.357
date: 2011/03/24 17:55:30;  author: dwarren;  state: Exp;  lines: +7 -5
Fixed initialization of new psc record.
Changed float output spec (removed l, which was making every float print as 0.0)
----------------------------
revision 1.356
date: 2011/03/13 15:48:34;  author: tswift;  state: Exp;  lines: +7 -6

Now failing when get_attr encounters a non-var, rather than throwing an exception.
Ideally, I'm not sure this is the best thing to do, but it is what other Prologs do.
----------------------------
revision 1.355
date: 2011/01/22 19:36:51;  author: dwarren;  state: Exp;  lines: +4 -1
Added option to xwam_state to get current size of global stack.
----------------------------
revision 1.354
date: 2011/01/11 14:05:20;  author: dwarren;  state: Exp;  lines: +15 -1
Added new case to FLOAT_OP (a strange builtin dealing with doubles)
to be able to get access to low-level float representation.  For debugging
and bit-hacking, maybe necessary for interface to interprolog.
----------------------------
revision 1.353
date: 2011/01/09 22:30:15;  author: tswift;  state: Exp;  lines: +2 -2

Minor code cleanup: some changes in documentation, changes to make a
function name accord with a builtin name, and moved some table
abolishing routines from tries.c to tr_utils.c with all the others.
----------------------------
revision 1.352
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +2 -11
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.351
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.350
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.349
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.348
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.347
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +11 -2
no message
----------------------------
revision 1.346
date: 2010/07/31 17:29:08;  author: tswift;  state: Exp;  lines: +2 -2

Forgot to commit these when expanding predicate property for various
types of tabling.
----------------------------
revision 1.345
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.344
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.343
date: 2010/06/22 23:30:54;  author: spyrosh;  state: Exp;  lines: +0 -9
Backed out code
----------------------------
revision 1.342
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +10 -1
Dipti's code for support graph added
----------------------------
revision 1.341
date: 2010/06/14 12:48:38;  author: dwarren;  state: Exp;  lines: +45 -41
branches:  1.341.2;
Improved error messages for low-level ptoc_ type functions (and a few others)
Now print the actual term that is found that is incorrect.  May help localize
errors better.
----------------------------
revision 1.340
date: 2010/05/26 20:51:38;  author: tswift;  state: Exp;  lines: +7 -2

New builtin get_trie_leaf for faster trie_interned.
----------------------------
revision 1.339
date: 2010/05/22 23:30:51;  author: evansbj;  state: Exp;  lines: +118 -118
Removed an extra parameter in the call to storage_builtin when building multithreaded version
----------------------------
revision 1.338
date: 2010/05/21 23:58:10;  author: kifer;  state: Exp;  lines: +5 -5
made the storage builtin/module to understand trie types
----------------------------
revision 1.337
date: 2010/05/02 05:11:26;  author: evansbj;  state: Exp;  lines: +1 -2
Update to make thread_exit/1, and xsb_kill_thread work from the C interface. It passes the regression tests as well as before, better actually.
----------------------------
revision 1.336
date: 2010/04/25 03:00:20;  author: dwarren;  state: Exp;  lines: +2 -2
Added offending word in error message, to help track problems.
----------------------------
revision 1.335
date: 2010/04/21 16:20:35;  author: tswift;  state: Exp;  lines: +28 -22



This change affects excecution of table p/n as variant/subsuptive.

Previously, a test such as that below would have dumped core when
changing from variant to subsuption, so a couple of days ago I fixed
it so that it threw a permission error.  However, in thinking about
it, it may be safe to change the evaluation method even if a predicate
already has tables.  The idea is that new tables will get the method
from the psc or tip, while incomplete tables will get the method from
the subgoal frame.  Im not sure if this will work in general, but it
does work for the following test.  So for now, Im allowing it, but
printing out a warning,	    so I can fix things when they go wrong.

This will hopefully give us a measure of adaptivity for	  call
subsuption/variance, if a profiler indicates that the evaluation
method should change during a session.


test:- p(X),fail.
test:- p(1),fail.
test:- (table p/1 as subsumptive),fail.
test:- p(2),fail.
test:- (table p/1 as variant),fail.
test:- p(3).

:- table p/1.
p(X):- writeln(executing_clause_body(p(X))).
----------------------------
revision 1.334
date: 2010/04/18 21:22:08;  author: tswift;  state: Exp;  lines: +21 -14

Fixed the handling of set_tabled_eval builtin to not dump core when the commands

?- table p/2 as variant.
?- table p/2 as subsumptive.

are issued.  Now it throws a permission error, which I think is better (though I'll hear about it soon if I'm wrong!)
----------------------------
revision 1.333
date: 2010/02/17 16:09:33;  author: dwarren;  state: Exp;  lines: +70 -34
Fixed excess_vars, a) to correctly handle 0-ary structure symbols (thanks, Barry)
and to check for size to handle stack overflow.
----------------------------
revision 1.332
date: 2010/02/10 19:11:12;  author: dwarren;  state: Exp;  lines: +135 -0
Made excess_vars a builtin, for efficiency.
----------------------------
revision 1.331
date: 2010/01/30 20:17:37;  author: evansbj;  state: Exp;  lines: +2 -2
*** empty log message ***
----------------------------
revision 1.330
date: 2010/01/18 13:54:51;  author: dwarren;  state: Exp;  lines: +5 -5
Add ground_term as a case in jumpcof, to allow it to appear in a test without laying
down a choicepoint.
----------------------------
revision 1.329
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.328
date: 2009/10/19 16:51:14;  author: dwarren;  state: Exp;  lines: +9 -2
Added erf (normal error function) call in function.  (Useful for PRISM-like reasoning.)
Added psc_import_as function, which assigns the entry-point of a psc to point to the
load-address of another PSC.  Will be used for "import a from b as c" functionality,
but it's not complete yet.
----------------------------
revision 1.327
date: 2009/08/12 13:05:50;  author: dwarren;  state: Exp;  lines: +14 -1
Added new case to the xwam_state builtin to get amount of space allocated to trie-intern.
Used to see when about to overflow so you can modify an algorithm to avoid it.
----------------------------
revision 1.326
date: 2009/04/27 18:32:03;  author: dwarren;  state: Exp;  lines: +15 -1
Added new builtin: psc_mod, to get the address of the module psc from a pcs
record.  This used to be done by psc_prop, but got (more) overloaded when we changed
the psc_data field to have the module psc address if it is not usermod, and to
have the filename of the file that defined it if it *is* usermod.  Now psc_mod
returns a psc address always (as needed for curr_cym and loader.)
----------------------------
revision 1.325
date: 2009/01/10 23:37:06;  author: tswift;  state: Exp;  lines: +4 -5

Extended (almost) all the marking routines for tabled predicates
so that subgoals in the heap delay list are checked.  This rather
obscure bug caused a crash in a Flora program for defeasible
logic.  I'll try to finish that part tomorrow.

The problem was that space was reclaimed for a table T that had a
delay element in the heap pointing to it.  When the answer with
the delay element was added, the engine tried to adjust the
backpointers for T and crashed.

Also made some minor ajustments for efficency to some of the
marking functions.  And I changed abolish_table_info to the
clearer abolish_all_tables.
----------------------------
revision 1.324
date: 2009/01/02 17:50:03;  author: tswift;  state: Exp;  lines: +13 -11


Updating a number of files so that delete_branch() will work with call
subsumption (it needs to know that it deallocates BTNs rather than
TSTNs).  This fixed a latent bug in simplification and allows another
test to be run for call subsumption. It also provides a step towards
supporting answer subsumption on call subsumptive tables.  There are
also some other documentationstyle changes.

Adding a new test for copying attributed variables into delay elements
/ lists.  I hadn't thought this worked, but apparently it does !

Also, I'm adding a very simple test for incremental evaluation -- more
cases need to be added here, but at least this is a start.
----------------------------
revision 1.323
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +5 -4


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.322
date: 2008/11/25 18:40:07;  author: dwarren;  state: Exp;  lines: +24 -1
Added new jumpcof builtin: if_number_atom that succeeds if the atom can be
converted to a number by (atom_codes and then) number_codes.  This is necessitated
by the change that to number_codes to throw an error that made it more standard
conforming.
----------------------------
revision 1.321
date: 2008/10/24 18:55:20;  author: dwarren;  state: Exp;  lines: +7 -9
A couple of minor changes:
1. Use case-insensitive compare of filenames for redefining test on Windows machines.
2. Minor change to Profiling to accumulate interrupt counts and apply all to the
point of the next interrupt.  This now seems to me to be slightly better.  It doesn't
much change the few profiles I tested, but it seems better to me, so...
----------------------------
revision 1.320
date: 2008/10/24 15:50:32;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed bug in profiling, created when I changed the psc data field for
usermod predicates to point to the filename that defined it.
----------------------------
revision 1.319
date: 2008/10/16 17:57:58;  author: dwarren;  state: Exp;  lines: +5 -3
Use data field in psc-records for predicates loaded into usermod to point
to the full filename of the file from which it was loaded.  Used this to
print a warning when XSB loads code for a usermod predicate that was previously
defined from a different file.
Will look at extending current_predicate to return this information, but that
has not yet been done.
----------------------------
revision 1.318
date: 2008/10/15 16:41:53;  author: dwarren;  state: Exp;  lines: +9 -2
Extended xsb_profiling to include counts for time in garbage collection.
(This info could be gotten, approximately, from statistics, but it is
nice to see it directly in the profile_call dump.)
----------------------------
revision 1.317
date: 2008/04/06 23:04:20;  author: tswift;  state: Exp;  lines: +2 -2
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.316
date: 2008/03/31 13:38:49;  author: dwarren;  state: Exp;  lines: +2 -2
Add const type decls in iso_ptoc_callable_arg to conform to MSVC's requirements.
----------------------------
revision 1.315
date: 2008/03/27 19:55:16;  author: tswift;  state: Exp;  lines: +24 -1

A few minor changes for error handling:

Improved error reporting for predicates that call the new C
convert_to_dyna()

Introduced iso_ptoc_callable_arg(), (for now, used only in convert_to_dyna())
----------------------------
revision 1.314
date: 2008/03/19 22:58:09;  author: tswift;  state: Exp;  lines: +3 -3

Changed flagval from int to prolgo int in stat(set)flag.  This allows
xsb to run on the mac when compiled with 64 bits.

The problem was that the addresses of int handlers such as load_undef were truncated leading to an immediate core dump.

There may be more problems on the mac, but at least we have a start.
----------------------------
revision 1.313
date: 2008/03/05 15:23:33;  author: tswift;  state: Exp;  lines: +3 -4

Fiddling around with the order of statements for MSVC.
----------------------------
revision 1.312
date: 2008/02/28 14:53:37;  author: tswift;  state: Exp;  lines: +11 -5

Added error checking to setarg/3
----------------------------
revision 1.311
date: 2008/02/27 22:14:08;  author: dwarren;  state: Exp;  lines: +8 -3
Fix bug in CALLN when generated predicate not in usermod is new.
----------------------------
revision 1.310
date: 2008/02/22 19:43:26;  author: dwarren;  state: Exp;  lines: +10 -4
Fixed call/n handling of explicit module names.
If a module name is given (as in call(basics:append(X),Y,[1,2]))
then it overrides the module of the term, e.g. append(X).
If no module is given, it takes the module of the "call term".
E.g. call(append(X),Y,[1,2]) would call append/3 in the module
of the term append/1.
This results in the perhaps unintuitive consequence, that if you want
to call append/3 in basics as above, you need to
  :- import append/1 from basics.
even though append/1 isn't defined in basics.  As long as you don't
call append/1, all works fine and the above call works.
----------------------------
revision 1.309
date: 2008/02/22 03:39:10;  author: dwarren;  state: Exp;  lines: +71 -1
Main change is to add a builtin to implement call/n for n=2..10.
That affected builtin.c,builtin.h,machine.P,standard.H and associated
xwam files.
The other xwam files seem not to have been updated with recent .P file
changes.
----------------------------
revision 1.308
date: 2008/02/16 18:00:41;  author: dwarren;  state: Exp;  lines: +7 -2
Add new instructions putdfloat and getdfloat to handle double floats.
Update the loader to load these instructions from the xwam files.
(There is a possible problem.  The doubles are written into the xwam
file as bitstrings, and read by the loader as the same bitstring.  If
representations on different machines are different, then xwam files
compiled on one system won't run on another.)
----------------------------
revision 1.307
date: 2008/01/28 18:16:49;  author: dwarren;  state: Exp;  lines: +4 -2
import can be called before flags[CURRENT_MODULE] is initialized, so
use global_mod in this case.  (Noticed when debugging something else;
This seemed to end up working before, but only by a fluke.)
----------------------------
revision 1.306
date: 2008/01/21 18:07:28;  author: dwarren;  state: Exp;  lines: +1 -5
Modify glstack_realloc to support shrinking of the heap-local stack space.
This allows trimcore to reduce the amount of space used for these stacks.
----------------------------
revision 1.305
date: 2008/01/16 17:19:37;  author: dwarren;  state: Exp;  lines: +14 -2
Added new builtin for conpsc/2.  It moves down this functionality fully
into C.  I was tired of looking at performance profiles with 3-5% of the
time spent in this predicate.  It is heavily used in assert.
----------------------------
revision 1.304
date: 2008/01/02 19:47:42;  author: dwarren;  state: Exp;  lines: +6 -1
Fix (or at least greatly improve) the C-calling-XSB (recursively) interface for
the multi-threaded engine.  There is still an issue with multiple calls of
different C threads, but sharing the same th-context.  But I think the problem
is in more than just this interface.
----------------------------
revision 1.303
date: 2007/12/24 20:21:01;  author: tswift;  state: Exp;  lines: +2 -7

One small change for trie_truncate.
----------------------------
revision 1.302
date: 2007/12/24 19:16:59;  author: tswift;  state: Exp;  lines: +13 -13

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.301
date: 2007/11/01 18:48:51;  author: tswift;  state: Exp;  lines: +1 -19
Fixed some problems in **/2 -- Sundays update didn't handle floats
properly, due to a copy and paste error.  Also, I added a domain check
(as in standard) that the number exponientiated isnt negative with a
float exponent.  Finally, I was able to take out the pow builtin as
eval now calls **/2.

In addition, made some of the C error functions DLL-exported so that
they can be used by external C functions.
----------------------------
revision 1.300
date: 2007/10/19 21:15:16;  author: tswift;  state: Exp;  lines: +4 -3

Changes to add call_cleanup/2, whose semantics is ISO compliant as far
as the ISO definition goes.  I also put call_cleanup/2 in std_xsb.P.
Cleanup handlers are scheduled through the attv interrupt chain, so I
needed to hack this code a little to make sure that an interrupt
handler for cleanups is always present.

Also, I made a change to peephole to not optimize away a putpbreg_ci
-- we'll usually need it for call_cleanups.

Right now I'm using a static inline for CHECK_CALL_CLEANUP -- on gcc
this should be as fast as a macro and allows me to trace if there are
any problems.


Adding these changes made me need to adjust a few include statements
in tr_utils.c and tst_retrv.c
----------------------------
revision 1.299
date: 2007/10/07 17:37:55;  author: tswift;  state: Exp;  lines: +18 -9

Two sets of changes.

First, was to add const declaration modifiers to external ctop and
ptoc routines.  Apparently some C++ compilers can benefit from this
modifier, and it should help the Parma polyhedra group and others who
call XSB from C++.

The second change supports call_cleanup, and fixes a minor bug in the
implementation of catch (see the emails on the XSB group).  This
update does not handle cutting over call cleanup -- I'll try to get
that in soon.
----------------------------
revision 1.298
date: 2007/09/04 00:49:08;  author: dwarren;  state: Exp;  lines: +2 -2
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.297
date: 2007/08/28 16:43:49;  author: dwarren;  state: Exp;  lines: +2 -2
Added more info in printout when stack is clobbered.
----------------------------
revision 1.296
date: 2007/08/23 14:48:19;  author: dwarren;  state: Exp;  lines: +4 -7
Change setenv to putenv (with mostly same functionality, but works on Windows, too)
(xsb_read.xwam seems to have gotten out of sync, and this should put it back in.)
----------------------------
revision 1.295
date: 2007/08/22 22:04:33;  author: tswift;  state: Exp;  lines: +37 -2

Added setenv/3.
----------------------------
revision 1.294
date: 2007/08/22 19:03:45;  author: tswift;  state: Exp;  lines: +2 -2
A couple of changes to get a cleaner compiler.
----------------------------
revision 1.293
date: 2007/08/08 17:50:49;  author: dwarren;  state: Exp;  lines: +5 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.292
date: 2007/08/03 20:34:56;  author: tswift;  state: Exp;  lines: +3 -3

Changes to allow an override to restriction that only one thread may be active during a load.

In doing this, I refined the mutexes for syscalls so that system calls only use a mutex when using the proc table.
----------------------------
revision 1.291
date: 2007/07/07 21:02:07;  author: tswift;  state: Exp;  lines: +32 -1
-- Added usleep

-- Fixed concurrency bug with thread aliases in thread create.

-- made thread_join/thread_detach allow thread aliases
on input, and isoified their errors

-- Makde thread_self allow thread aliases on input.  The errors for
   this predicate different from ISO -- I dont really with their error
   designation in this case (at least not yet).

-- made thread_join, thread_detach, and thread_exit all properly
   remove aliases if applicable

-- Brought thread exit statuses in line with ISO working standard
   (mostly -- for now, we still have a cancelled status)

-- Added numerous tests for thread manipulation predicates to mttests.
----------------------------
revision 1.290
date: 2007/07/06 13:44:58;  author: dwarren;  state: Exp;  lines: +7 -3
Fixed bug in print_xsb_backtrace, and added one more test (for clobbered
stack) to try to make it more resilient.
----------------------------
revision 1.289
date: 2007/06/24 19:03:21;  author: tswift;  state: Exp;  lines: +30 -3
Changes to support thread aliases and other ISO functionality.
----------------------------
revision 1.288
date: 2007/06/10 18:43:57;  author: tswift;  state: Exp;  lines: +49 -36

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.287
date: 2007/06/08 15:25:37;  author: dwarren;  state: Exp;  lines: +4 -4
Changed use of powl to pow (with necessary coercions.)  It seems that some
math.h's don't define powl, and this seems to work for gcc on cygwin and msvc.
If you find problems, let me know.
----------------------------
revision 1.286
date: 2007/06/01 22:47:05;  author: tswift;  state: Exp;  lines: +9 -14

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.285
date: 2007/05/25 18:11:29;  author: dwarren;  state: Exp;  lines: +1 -1
Added coercion to quiet the MSVC compiler.
----------------------------
revision 1.284
date: 2007/05/10 16:15:03;  author: dwarren;  state: Exp;  lines: +1 -0
Initialize variable "instruction" in all cases to quiet a fussy compiler.
----------------------------
revision 1.283
date: 2007/05/04 18:04:46;  author: dwarren;  state: Exp;  lines: +3 -3
Minor modifications (including casts) for builtin pow (for power).
----------------------------
revision 1.282
date: 2007/05/01 14:52:28;  author: tswift;  state: Exp;  lines: +7 -2

Adding scratch code for table inspection functions that may, if they're good, grow up into answer_completion and the like.
----------------------------
revision 1.281
date: 2007/04/28 13:29:49;  author: tswift;  state: Exp;  lines: +17 -5
Changes to XSB_POW, which supports exp/2, so that it handles floats properly.
This is useful, for instance, to find geometric means.
----------------------------
revision 1.280
date: 2007/04/20 14:40:52;  author: tswift;  state: Exp;  lines: +12 -7

Made changes to several occurrences of ctop_string to avoid interning the string twice.  I only took the obvious cases, but there were several af them.  Probably at some point we should take a closer look at a few of them to make sure we aren't interning things unnecessarily, but this depends on understanding the actual uses in detail.
----------------------------
revision 1.279
date: 2007/04/16 16:14:15;  author: tswift;  state: Exp;  lines: +4 -2

Got rid of some unnecessary calls to string_find().  There are
plenty left due to ctop_string() calls.

--- It turned out that read/[1,2] was interning each token 3
    times, and I got rid of 2 of those 3, by tweaking the builtin
    call and by redefining the unnecessary read_getcon.

-- It also turned out that nl, and file_nl were performing
   unnecessary string interns because of windows_os_loader.  I
   got rid of that function and moved file_nl to C (in
   file_function).  Also, I redefined nl/0 to call file_nl.
----------------------------
revision 1.278
date: 2007/04/05 17:26:56;  author: tswift;  state: Exp;  lines: +7 -2
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.277
date: 2007/02/27 18:51:13;  author: dwarren;  state: Exp;  lines: +6 -2
Made backtrace a little more resilient in case of weird program state.
----------------------------
revision 1.276
date: 2007/02/23 20:17:04;  author: tswift;  state: Exp;  lines: +4 -3
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.275
date: 2007/02/09 18:12:16;  author: dwarren;  state: Exp;  lines: +21 -3
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.274
date: 2007/01/25 20:33:53;  author: tswift;  state: Exp;  lines: +7 -2


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.273
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +5 -1

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.272
date: 2006/11/26 23:43:42;  author: tswift;  state: Exp;  lines: +4 -1

 changes involve memory allocation
 for the dynamic clause garbage collection frames: rather than
 using malloc() and free() for these frames, I changed the
 various retract(all)s to use structure managers.  This has two
 advantages: first the structure managers are more efficient
 overall than using malloc and free, and second, in the
 multi-threaded engine we now use private structure mangers to
 manage the dynamic gc frames for private dynamic predicates,
 increaing potential concurrency.

Also, changes to experimental retract.
----------------------------
revision 1.271
date: 2006/10/23 15:26:25;  author: ruim;  state: Exp;  lines: +1 -3
got MUTEX_SOCKET deeper in socket code
----------------------------
revision 1.270
date: 2006/09/06 05:15:26;  author: diptikalyan;  state: Exp;  lines: +19 -3
Incremental Code Added.
----------------------------
revision 1.269
date: 2006/07/07 21:08:14;  author: dwarren;  state: Exp;  lines: +6 -2
Added bound on length of backtrace to print.  Sometimes there would be a loop
in the backtrace (on segfaults) and then it would enter an infinite print loop.
----------------------------
revision 1.268
date: 2006/07/02 18:36:28;  author: tswift;  state: Exp;  lines: +6 -1
builtin.c and cinterf.h -- change for MT engine

gc_slide: small changes in documentation.
----------------------------
revision 1.267
date: 2006/06/23 15:03:19;  author: dwarren;  state: Exp;  lines: +50 -1
Change term_hash builtin to use names of functors and atoms to hash rather than
the psc (or string) address.  This slows it down a little, but makes hashing stable.
This makes the compiler deterministic, so we don't get changing xwam files (differing
only in order of symbol entries.)
----------------------------
revision 1.266
date: 2006/06/22 21:01:52;  author: dwarren;  state: Exp;  lines: +12 -12
Change printf's to fprintf's to make output location explicit.
----------------------------
revision 1.265
date: 2006/06/14 15:27:23;  author: dwarren;  state: Exp;  lines: +3 -5
Fixed a minor bug in computing hash values for big ints and floats in
*-indexing.
----------------------------
revision 1.264
date: 2006/06/01 13:19:41;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed minor bug in extern decl of dynamic_code_function.
----------------------------
revision 1.263
date: 2006/05/22 20:47:45;  author: tswift;  state: Exp;  lines: +6 -2

Prolog code for unify_with_occur_check

In addition, fixed bug in batched evaluation that I believe is of long standing.

In the batched fixed point, a subgoal S may be checked for fixed
point even if it has been completed and its answer return lists
have been reclaimed.  This doesn't usually happen but can if S is
the leader of the ASCC.  In such a case, the fixed point check
traverses each consumer choice point for S and determines whether
all answers have been returned to the choice point.  However, if
the answer return list for S has been reclaimed and its space
reused, the fixpoint check may mistakenly think that an answer
has not been returned to the choice point -- a dangerous situation.

The fix is simple -- a check for reclamation of the subgoal.  The
check will also be made for local evaluation, even though it
won't be needed there.
----------------------------
revision 1.262
date: 2006/04/27 21:08:47;  author: tswift;  state: Exp;  lines: +2 -1

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.261
date: 2006/04/27 01:05:26;  author: tswift;  state: Exp;  lines: +11 -6

Changed structure of retractall as called with non-open terms --
i.e. when a gen_retractall is NOT called.  The basic change was
to factor out the potentially expensive marking and unmarking
operations outside of the retract and to call them as builtins
before and after the retract itself.

Changes for code cleanup (db_remove_prref changed to db_abolish0).

Associated changes were also made to the test suite.
----------------------------
revision 1.260
date: 2006/04/17 20:54:56;  author: tswift;  state: Exp;  lines: +1 -2

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.259
date: 2006/03/27 00:13:53;  author: tswift;  state: Exp;  lines: +3 -36

1) Split DelTF chain into private and shared chains.  This fixed
   a bug with table garbage collection, but also enabled me to
   allow garbage collection of a threads private tables when
   there is more than one active thread.

2) Extended the delay of space reclamation to abolished subgoals,
   and added subgoal reclamation to the table garbage collector.

I also added tests for these: lease update the various test
suites as the gc stuff may be a little brittle.
----------------------------
revision 1.258
date: 2006/03/24 16:40:28;  author: tswift;  state: Exp;  lines: +2 -2

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.257
date: 2006/03/23 14:10:15;  author: dwarren;  state: Exp;  lines: +3 -3
Took out CTXTc from a call to trie_undispose that caused it not to compile,
and commented out a decaration of an unused variable (active).  Terry should check.
----------------------------
revision 1.256
date: 2006/03/20 15:54:55;  author: tswift;  state: Exp;  lines: +12 -12

Modifications to take out cps check in abolish_table_call.
----------------------------
revision 1.255
date: 2006/03/17 18:17:59;  author: tswift;  state: Exp;  lines: +5 -108


Some updates to fix bugs in table abolishing and garbage
collecting.  Many of the changes have to do with refactoring code
to make it a little faster as well as to reduce bugs.

In addition, there are associated additional files in the test suite.

I'll be making more changes, and hopefully finishing over the weekend.
----------------------------
revision 1.254
date: 2006/03/15 13:15:53;  author: tswift;  state: Exp;  lines: +7 -5


Introduced two new predicates: abolish_private_tables, and
abolish_shared_tables (CPS check for these predicates is not yet
done).

Fixed bug (I think) for null parent pointer in CPS check.

Adding new test for abolishing tables to testsuite.
----------------------------
revision 1.253
date: 2006/03/14 19:48:49;  author: dwarren;  state: Exp;  lines: +3 -2
data field is not always set.  If it's 0, it is (almost always?) usermod,
so assume so for abolishing usermod tables.
----------------------------
revision 1.252
date: 2006/02/27 22:03:46;  author: tswift;  state: Exp;  lines: +4 -3
Some miscellaneous changes

1) abolish_table_pred now emits a warning when the table has a
   leaf node with a delay list -- this could cause dangling
   pointers for dependency checking.  Also, modified an error.

2) trie_interned now throws an exception, rather than exiting on
   an error case.

3) max_threads is now a command-line option

4) Added a new define NON_OPT_COMPILE, and memory mutexes are now
   used only with NON_OPT_COMPILE
----------------------------
revision 1.251
date: 2006/01/27 17:50:16;  author: dwarren;  state: Exp;  lines: +3 -3
Added a new instruction to implement unary tests that don't change
the XWAM state.  Examples are integer/1, atom/1, etc.  The compiler
is changed to use these instructions to avoid laying down a choicepoint
in a conditional, and they are used for regular inline calls.
----------------------------
revision 1.250
date: 2006/01/16 22:13:30;  author: dwarren;  state: Exp;  lines: +7 -3
Fix bug in profiling that caused profile-interrupt-thread to be started too often.
----------------------------
revision 1.249
date: 2006/01/12 21:33:50;  author: tswift;  state: Exp;  lines: +32 -23
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.248
date: 2006/01/09 00:06:30;  author: tswift;  state: Exp;  lines: +6 -4
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.247
date: 2006/01/03 17:14:20;  author: dwarren;  state: Exp;  lines: +5 -3
Fixed float indexing problem in compiler.  Now indexes on floats should work.
(Still not very recommended, but at least the bit patterns pass through.)
Even though compiler still passes only single precision floats, at least now
all those bits are preserved, and converted to double on execution.
----------------------------
revision 1.246
date: 2005/12/31 23:16:03;  author: tswift;  state: Exp;  lines: +4 -1

Fixed problems with throwing memory errors from mem_xxxoc(), at
least in sequential engine.  When memory cannot be malloced, a
resource error is thrown.  Since throwing errors mallocs memory
in itself, mem_xxxocs used by a throw are changed into
mem_xxxoc_nochecks and an xsb_exit is called if these functions
return NULL pointers.  Care is taken so that when a resource
error is thrown, space for its PSCs has been pre-allocated, and
varstrings are used for the actual message strings (varstring
exits too, if there is not enough memory).

In MT engine, a memory error just exits -- this is because I need
a CTXT to throw an error.  Right now, I'm not sure whether its a
good idea or not to put CTXTs into mem_xxxoc or not.

Not that some of the biggest memory allocations, such as tcp
stack, local-heap stack use straight reallocs and use their own
error handling.

In general, we should be handling most memory errors in a
reasonable, or at least consistent, manner.
----------------------------
revision 1.245
date: 2005/12/31 01:43:33;  author: tswift;  state: Exp;  lines: +13 -6
Changes to mutex handling for IO that should affect only the MT
engine. Rather than having a global IO mutex, I've added a mutex
for each stream, and used MUTEX_IO to lock the open_files array
itself.  This change was prompted by the fact that I can't have
one thread waiting on an input-stream via, say, a read and have
that thread create other threads that write to the output stream
and exit when done.

The result is that we no longer have contention when different
threads write to different streams.  At the same time, we end up
doing no more locking than before -- a little less, in fact due
to some manipulations in xsb_writ.P Unfortunately, the stream
mutexes are recursive (as with MUTEX_IO).  We can't get rid of
this until we rewrite write_term.

Now, back to handling memory_errors.
----------------------------
revision 1.244
date: 2005/12/29 20:06:43;  author: tswift;  state: Exp;  lines: +2 -1


Refactored init_machine() to include a new function
init_thread_structures() that includes all initializations that
need to be done on a per-thread basis.  Then mem_dealloc'ed all
thread-specific memory, including varstrings and such in
cleanup_tread_structures() (nee cleanup_machine()).  This change
should affect the MT engine only.

At this point, there should be no memory leaks simply for
creating a thread that exits -- apart from interaction with the
string table, etc.  Also, I'm not freeing space for dispatch
blocks for private predicates, which doesn't seem necessary
overall.  I suppose if we want to get rid of that space, the
reclamation should be done in one of the abolish predicates,
rather than xsb_thread_exit()?
----------------------------
revision 1.243
date: 2005/12/22 23:33:55;  author: tswift;  state: Exp;  lines: +5 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.242
date: 2005/12/17 02:46:31;  author: dwarren;  state: Exp;  lines: +3 -3
Fixed accumulated missing casts.  MSVC compiles it now without complaint.
----------------------------
revision 1.241
date: 2005/12/15 20:59:28;  author: dwarren;  state: Exp;  lines: +1 -4
More tokenizer fixups.  Supports full numeric precision.  Floats are doubles,
and full 32-bit integers are handled.  And cleaned up some escapes a bit, and
did slightly better treatment of odd cases in binary/octal/hex integers.
----------------------------
revision 1.240
date: 2005/12/15 16:39:52;  author: dwarren;  state: Exp;  lines: +5 -2
1. Changed the XSB tokenizer to be more compatible with the Prolog
standard.  This involved adding escape characters when processing
strings -- single quoted, double quoted and 0-radix, as in 0'\n.  The
escape characters are those in the standard (taken from C).  I did not
add \' as a single quote within a quoted string, since it breaks the
form: '/\', which appears several times in the XSB system code.  (This
could, of course, be changed.)  Backslashes that are not followed by a
legal escape indicator are accepted simply as backslashes.  (I suspect
this is not what the standard expects, but it will break fewer
programs.)  I added the new forms for binary (e.g., 0b101), octal
(e.g., 0o731), and hex (e.g., 0xffef) that the standard requires.  I
left in the non-0 radix notation (after fixing a few bugs in it) which
is not in the standard, so we still process e.g., 8'713 as an octal
integer.  I extended the allowable radix up to 36 (which was partially
there already in a buggy form; I used A-Z for the digits 10-35.)  This
is probably not of much use, but what the hey....

The addition of the escape changed one of the tests in the testsuite.
Update tests from cvs to get the new correct answers.

2. Improved assert_code_to_buff so that it will run out of registers
less often when asserting GROUND structures.  The old version had a
limit of approximately 255 for right-branching when the left-elements
were non-constant.  E.g. arbitrary lists of constants were handled, but
lists of structures were limited to c. 255.  I've changed it so the
limit is now on left-branching instead of right-branching.  Since
right-branching is much more common in Prolog programs, this should
handle more structures that show up in Prolog programs.  (No claim is
made for Flora programs :-).
----------------------------
revision 1.239
date: 2005/12/13 01:13:45;  author: tswift;  state: Exp;  lines: +8 -2

Added mutex MUTEX_SYS_SYSTEM to protect global process table used
by spawn_process() and related functions.
----------------------------
revision 1.238
date: 2005/12/12 18:44:51;  author: dwarren;  state: Exp;  lines: +19 -9
Added string table garbage collection.
----------------------------
revision 1.237
date: 2005/12/12 00:19:11;  author: tswift;  state: Exp;  lines: +8 -3

Mutexed socket calls which dont seem to be mutexed.  Also added a
mutex around some rarely used string/symbol table statistics.

Other than that, documentation.
----------------------------
revision 1.236
date: 2005/11/21 22:36:30;  author: dwarren;  state: Exp;  lines: +4 -1
Fixed bug I introduced in abolish_table_pred a couple of weeks ago.
It now works again.
(Also added case to xwam_stats to get delayreg.)
----------------------------
revision 1.235
date: 2005/11/18 23:29:01;  author: tswift;  state: Exp;  lines: +3 -3

Took attv_interrupts array out of global area, and put it into
the thread context.  Also added, _gl suffix to realtime_count.

Other than that, just general documentation.
----------------------------
revision 1.234
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +8 -8
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.233
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +10 -6


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.232
date: 2005/11/13 21:38:37;  author: dwarren;  state: Exp;  lines: +2 -2
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.231
date: 2005/11/12 15:48:49;  author: dwarren;  state: Exp;  lines: +5 -3
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.230
date: 2005/11/10 23:05:54;  author: tswift;  state: Exp;  lines: +9 -8

Removed some stray printfs.
----------------------------
revision 1.229
date: 2005/11/07 20:55:41;  author: dwarren;  state: Exp;  lines: +40 -7
Fixed (for now) abolish_table_call to check for table (note: NOT table-call)
to be in use, and if not, to delete the table-call and reclaim the space.
This fixes a memory leak.
(And added an xwam_stat builtin, to support better debugging from the
Prolog side.  Extensible.)
----------------------------
revision 1.228
date: 2005/10/21 21:23:15;  author: crojo;  state: Exp;  lines: +15 -3
Changed term_type/2 to check for the boxed representations of floats/ints, and return XSB_INT/XSB_FLOAT when encountered
----------------------------
revision 1.227
date: 2005/10/14 13:24:36;  author: dwarren;  state: Exp;  lines: +9 -3
Added error checking to str_len (and made it throw errors instead of
quietly failing.)
----------------------------
revision 1.226
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +17 -4


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.225
date: 2005/09/29 15:35:24;  author: dwarren;  state: Exp;  lines: +22 -1
Added new builtin trie_assert_hdr_info to return needed pointers.
Gets 2 values.  Used to replace old buff_word calls.
----------------------------
revision 1.224
date: 2005/09/12 01:09:33;  author: tswift;  state: Exp;  lines: +3 -3

Tonight's changes were to clean up global data structures used to
clean up tries.  This time I was able to make data structures used in deleting
asserted and interned tries, local to the relevant function.  In addition,
I put into the MT context data structures used to manage an array of interned
tries.

Of course, there's more work to allow asserted and interned tries to be used in multi-threading -- but these changes will hopefully save us from one danger, at least.
----------------------------
revision 1.223
date: 2005/09/02 20:43:13;  author: tswift;  state: Exp;  lines: +7 -3

Fix to abolish_table_xxx and gc_tables to work when stacks are frozen;
and made creation of DelTF frames thread-safe.  Also, got a little
further towards reclaiming retracted clauses.

----------------------------------------------------------------------
builtin.c emuloop.c extensions_xsb.h inst_xsb.h CVS: std_cases_xsb_i.h
tr_utils.c xsb_inst_list.h CVS:
----------------------------------------------------------------------
----------------------------
revision 1.222
date: 2005/09/01 18:37:06;  author: tswift;  state: Exp;  lines: +2 -84


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.221
date: 2005/08/24 20:51:52;  author: dwarren;  state: Exp;  lines: +4 -3
Moddified psc_set_ep builtin to allow setting of ep to a fail instruction.
Made db_get_prref create a new prref if one doesn't exist.
----------------------------
revision 1.220
date: 2005/08/22 19:38:22;  author: dwarren;  state: Exp;  lines: +12 -7
Add a little more lock protection when handling private dispatch blocks
----------------------------
revision 1.219
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +6 -9
Made pflags thread private
----------------------------
revision 1.218
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +6 -2
made private flags array for sequential engine
----------------------------
revision 1.217
date: 2005/08/19 07:23:54;  author: ruim;  state: Exp;  lines: +2 -2
renumbered flags
----------------------------
revision 1.216
date: 2005/08/16 19:19:09;  author: dwarren;  state: Exp;  lines: +20 -15
Changes for multi-threading:
1. Added open/4 to allow forcing of a new open.  open/3 returns previously opened
file (with same name and mode) if there is one.  This is needed in multithreading
to allow each thread to open the same file to read it.
2. Reworked how table directives are passed from the compiler to the execution
state.  It is now passed through the xwam files, and use_subsumptive_tabling
and use_variant_tabling is also passed this way.  shared/private, and tabling (variant
or subsumptive) tags are kept in the psc record (in bits in the env byte.)
This is not completely compatible with old .xwam files, so they shoudl be
recompiled.  If they aren't, then all tabled predicates are assumed to be tabled
with variant tabling, and a warning is given.
3. Updated the compiler so that most (all?) of its output files are now
written to explicit streams (instead of using tell.)
----------------------------
revision 1.215
date: 2005/08/15 21:41:07;  author: crojo;  state: Exp;  lines: +10 -10

Corrected builtin.c for multithreading.
----------------------------
revision 1.214
date: 2005/08/15 20:55:39;  author: crojo;  state: Exp;  lines: +49 -9

added a new builtin, #188, float_op/10, to be used to circumvent excessive heap usage by floating point operations. Documentation for it is soon to come.
----------------------------
revision 1.213
date: 2005/08/13 15:04:02;  author: ruim;  state: Exp;  lines: +3 -3
changed defines to allow concurrent completion
made batch compile under mt
----------------------------
revision 1.212
date: 2005/08/09 13:59:59;  author: evansbj;  state: Exp;  lines: +5 -1
*** empty log message ***
----------------------------
revision 1.211
date: 2005/08/08 17:11:30;  author: dwarren;  state: Exp;  lines: +60 -14
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.210
date: 2005/08/06 16:29:54;  author: tswift;  state: Exp;  lines: +47 -2

Added check of Choice point stack to abolish_all_tables to ensure that it contains no choice points for completed tables.  Also, added some stubs for gc_clauses.
----------------------------
revision 1.209
date: 2005/08/04 19:35:20;  author: ruim;  state: Exp;  lines: +9 -1
fix for deadlock breaking with negation
----------------------------
revision 1.208
date: 2005/08/01 23:03:29;  author: tswift;  state: Exp;  lines: +2 -2
1) Changes to error handling in assert, retract, abolish, clause, and
   related predicates to make the error terms a bit more ISO-like.

2) Change to psc_prop to check for T_DYNA in addition to T_PRED.
----------------------------
revision 1.207
date: 2005/07/26 13:10:57;  author: ruim;  state: Exp;  lines: +2 -1
extended shared completed tables to handle negation
----------------------------
revision 1.206
date: 2005/07/19 13:57:42;  author: dwarren;  state: Exp;  lines: +3 -3
Try to get the private_builtin stuff fixed....
----------------------------
revision 1.205
date: 2005/07/18 21:54:01;  author: crojo;  state: Exp;  lines: +46 -12
*** empty log message ***
----------------------------
revision 1.204
date: 2005/07/18 19:47:45;  author: tswift;  state: Exp;  lines: +4 -2

picayune (my word for the day) changes in predicate names and a little added documentation
based on reviewing abolish_table_pred and friends.
----------------------------
revision 1.203
date: 2005/07/13 19:51:44;  author: dwarren;  state: Exp;  lines: +2 -4
More thread-safety in assert (in generating code)
and in ptoc_longstring where I'd overlooked a static variable.
----------------------------
revision 1.202
date: 2005/07/12 17:37:35;  author: dwarren;  state: Exp;  lines: +5 -2
Interned expand_filename, fix a bug I introduced when hacking pathnames...
----------------------------
revision 1.201
date: 2005/07/11 16:50:47;  author: dwarren;  state: Exp;  lines: +2 -6
Moved iostrs declaration into file where it is used. (Cleanup)
----------------------------
revision 1.200
date: 2005/07/08 21:25:20;  author: dwarren;  state: Exp;  lines: +6 -9
More thread-safing: ptoc_longstring(!) and is_most_general_term.
----------------------------
revision 1.199
date: 2005/07/08 20:25:08;  author: dwarren;  state: Exp;  lines: +5 -17
More thread-safe making.  gettoken and read_canonical, this time.
----------------------------
revision 1.198
date: 2005/07/08 17:11:14;  author: dwarren;  state: Exp;  lines: +3 -2
Fix a couple of oddities I noticed. (unused var in token, strange way to fail a builtin.)
----------------------------
revision 1.197
date: 2005/07/08 00:54:24;  author: dwarren;  state: Exp;  lines: +32 -10
Fixes to sockets for multi-threading, by Chris Rued.
----------------------------
revision 1.196
date: 2005/07/05 20:20:44;  author: dwarren;  state: Exp;  lines: +8 -8
Fixed pathname to be thread-safe, mostly by putting names that were
static into the atom-table.  They'll get there anyway.  Also used
malloc instead of mem_alloc once since it was used before mutexes were
initialized, and so crashes (at least on cygwin.)
----------------------------
revision 1.195
date: 2005/04/27 04:20:13;  author: evansbj;  state: Exp;  lines: +2 -2
Updated stderr and stdout redirection available via the -q parameter
----------------------------
revision 1.194
date: 2005/02/23 20:52:16;  author: dwarren;  state: Exp;  lines: +4 -2
Fix bug in building of backtrace list when -p and boxed integer.
----------------------------
revision 1.193
date: 2005/01/17 20:31:57;  author: dwarren;  state: Exp;  lines: +12 -11
Put back a ptoc_longstring that got lost.
Also, modified ptoc_longstring to handle integers (as does ptoc_string) to
make it fully compatible.  Also changed more ptoc_strings to ptoc_longstrings.
----------------------------
revision 1.192
date: 2005/01/14 18:30:50;  author: ruim;  state: Exp;  lines: +381 -368
Integration of multithreaded system
----------------------------
revision 1.191
date: 2004/10/15 14:43:33;  author: dwarren;  state: Exp;  lines: +1 -0
Added file_puttoken option to print an atom ALWAYS as single-quoted.
----------------------------
revision 1.190
date: 2004/10/15 14:26:07;  author: dwarren;  state: Exp;  lines: +2 -2
Minor changes to fix file_puttoken to properly quote (or double quote) tokens.
Renamed no_quotes_needed to quotes_are_needed to reflect its semantics.
----------------------------
revision 1.189
date: 2004/09/30 13:22:21;  author: dwarren;  state: Exp;  lines: +7 -6
Refine 64-bit mods (and fix some inconsistencies I introduced yesterday...)
----------------------------
revision 1.188
date: 2004/09/29 21:41:55;  author: dwarren;  state: Exp;  lines: +7 -7
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.187
date: 2004/09/03 20:35:22;  author: dwarren;  state: Exp;  lines: +3 -3
Fix handling of boxed ints for large psc addresses in backtrace.  (I was
building them wrong.)
----------------------------
revision 1.186
date: 2004/09/03 19:10:31;  author: dwarren;  state: Exp;  lines: +12 -7
Modified build_backtrace to build a boxed int if the psc address is
too big to cast to a simple Prolog int.  (And added cast in bld_oint
to allow addresses to easily be handled there.)
----------------------------
revision 1.185
date: 2004/09/02 19:48:50;  author: tswift;  state: Exp;  lines: +1 -13

1) added ISO predicates peek_char/1,2 peek_code/1,2, at_end_of_stream/1,2
set_stream_position/2

2) A bit of code cleanup by fixing print_openfiles.

3) Fixed error in spawning processes intro'd by new stream stuff.

4) Revised I/O documentation (more to come).
----------------------------
revision 1.184
date: 2004/08/24 20:41:06;  author: tswift;  state: Exp;  lines: +20 -5

This is a pre-integration of certain parts of the MT engine so that I can run the mttests
in single-threaded mode under 2.6.  This basically defines some stubs so that I can compile and so
that I dont get undefined errors, and won't affect anything anybody is doing.
----------------------------
revision 1.183
date: 2004/08/20 18:11:34;  author: dwarren;  state: Exp;  lines: +43 -25
Added uniavar and bldavar WAM instructions for processing anonymous variables.
Fixed a bug in backtrace due to cpreg being used in compiling inline disjunctions
   and thus not pointing after a call WAM instruction.
Fixed initialization to put system-defined constants/predicates (in particular ,/2)
   into both the particular module (standard) AND in usermod.
----------------------------
revision 1.182
date: 2004/08/19 22:15:24;  author: tswift;  state: Exp;  lines: +15 -2

Changes for streams.  Here's hoping...
----------------------------
revision 1.181
date: 2004/07/16 16:24:33;  author: dwarren;  state: Exp;  lines: +6 -6
Changed several xsb_exit's to xsb_abort's to give control back to user
as seems appropriate.
----------------------------
revision 1.180
date: 2004/07/10 21:04:28;  author: dwarren;  state: Exp;  lines: +9 -6
Minor cleanup of term_set_arg to avoid multiple recomputations.
----------------------------
revision 1.179
date: 2004/07/07 22:08:12;  author: dwarren;  state: Exp;  lines: +10 -5
Changed decl of i to unsigned to quiet compiler.
Added check for variable in term_new_mod to give instantiation error.
----------------------------
revision 1.178
date: 2004/05/03 21:55:40;  author: dwarren;  state: Exp;  lines: +6 -2
Add early check for abolishing empty (variant) tables for efficiency.
Added printout of hreg (for heap usage) on backtrace backward continuation.
----------------------------
revision 1.177
date: 2004/04/12 13:08:00;  author: dwarren;  state: Exp;  lines: +6 -6
Better integration of backtrace into abort handling.
----------------------------
revision 1.176
date: 2004/04/09 21:03:05;  author: dwarren;  state: Exp;  lines: +78 -5
Added 1) print_xsb_backtrace and 2) build_xsb_backtrace functions to 1) print
out the predicates on the forward continuation and the backward continuation
and 2) to build a list of these psc pointers to return to Prolog.
If xsb was not started with the -p option, then the backward continuation
is always empty.  Without the -p option, the predicate names returned as the
forward continuation are gotten from the psc pointers in the calls on the
forward continuation (so it is a weird collection of containing predicates,
given last-call optimization.)  With the -p option, it contains all the
predicates on the forward continuation (assuming their names are found),
as well as the calls (when they add new information.) This is clearly just
an approximation, but might help find where, in the Prolog context, bad
things happen.
----------------------------
revision 1.175
date: 2004/04/09 00:05:31;  author: dwarren;  state: Exp;  lines: +69 -5
Add code to print out backtrace (forward and backward continuations)
----------------------------
revision 1.174
date: 2004/03/10 13:37:51;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed table_status to work with boxed integers as handles.
----------------------------
revision 1.173
date: 2004/03/05 00:58:22;  author: dwarren;  state: Exp;  lines: +11 -2
Cleaned up initialization of constant psc record pointers.  They should
be created in standard, not in usermod.
Also modified term_new_mod to tread mod1:mod2:term as mod1:term.
----------------------------
revision 1.172
date: 2004/01/29 18:44:09;  author: dwarren;  state: Exp;  lines: +72 -58
Modified implementation of profiling to avoid the extra psc-record
field for the count.  Now the counts are kept in the code-ptr records
and accumulated only at accumulation time.  Someday may want to improve
accumulation algorithm.
----------------------------
revision 1.171
date: 2004/01/26 22:07:43;  author: dwarren;  state: Exp;  lines: +2 -2
Added comment to clarify unusual local use and required global use of
ctop_string in file_gettoken.
----------------------------
revision 1.170
date: 2004/01/26 14:46:56;  author: dwarren;  state: Exp;  lines: +2 -4
Fixed seeming bug in abolish_table_call.  I don't see why we need to update
the completion frame pointer.  If it's still ours, we shouldn't be abolishing
anything anyway, no?
----------------------------
revision 1.169
date: 2004/01/14 20:27:12;  author: dwarren;  state: Exp;  lines: +177 -1
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.168
date: 2003/11/11 19:40:25;  author: dwarren;  state: Exp;  lines: +2 -1
Added new sorting predicate: parsort, which takes a more complicated
sorting specification and supports ascending, descending sort on
subfileds of terms.  It generalizes both sort and keysort (which have
not been changed.)  See manual1 (comparison) for details.
----------------------------
revision 1.167
date: 2003/10/28 13:51:06;  author: dwarren;  state: Exp;  lines: +12 -5
Improved error message (and changed abort to warning and fail.)
----------------------------
revision 1.166
date: 2003/10/17 21:23:20;  author: dwarren;  state: Exp;  lines: +6 -1
Added ability to get the last ClRef of a dynamic predicate.  Allows
access to end of a log, for retracting for undo.
----------------------------
revision 1.165
date: 2003/09/30 14:44:26;  author: tschrijvers;  state: Exp;  lines: +3 -3
made term_set_arg/4 backward compatible
----------------------------
revision 1.164
date: 2003/09/29 13:05:12;  author: tschrijvers;  state: Exp;  lines: +12 -10
Merged CHR related updates to branch release_2_6 into the HEAD.
----------------------------
revision 1.163
date: 2003/07/30 17:44:22;  author: dwarren;  state: Exp;  lines: +19 -2
Added new builtin in machine: term_new_mod(+Mod,+Term,-TermInMod), which
creates a term whose main functor symbol has the same name and arity as
Term, but is in module Mod, and the arguments are the arguments of Term.
The new functor symbol is assumed to be a predicate, and set to be imported
from Mod, if it's not already loaded.  We may want another parameter if we
want to build function symbols, and not predicates, in the new module.
----------------------------
revision 1.162
date: 2003/07/01 14:34:14;  author: lfcastro;  state: Exp;  lines: +6 -1
* New global variable
* New builtin globalvar/1, which returns THE global variable
----------------------------
revision 1.161
date: 2003/06/18 16:51:15;  author: lfcastro;  state: Exp;  lines: +85 -1
branches:  1.161.2;
* New builtin: abolish_module_tables(+ModuleName)

  abolishes all tables for predicates defined in module
  ModuleName. abolish_module_tables(usermod) abolishes tables in
  usermod that are not defined in other modules.

  Requires that all predicate PSCs point to their modules through
  their 'data' field.
----------------------------
revision 1.160
date: 2003/06/18 16:32:09;  author: lfcastro;  state: Exp;  lines: +5 -1
* disable conget/conset and psc_prop on predicate PSC's
----------------------------
revision 1.159
date: 2003/06/18 16:06:34;  author: lfcastro;  state: Exp;  lines: +21 -13
* Small reorganization of abolish_table_pred
----------------------------
revision 1.158
date: 2003/06/18 15:29:59;  author: lfcastro;  state: Exp;  lines: +1 -52
* remove predicate_module/3 since its functionality is provided by
  current_predicate(Module:predicate/arity) from curr_sym.
----------------------------
revision 1.157
date: 2003/06/18 13:41:20;  author: lfcastro;  state: Exp;  lines: +52 -1
* New builtin: predicate_module(+Name,+Arity,-ModuleList) returns the
  list of mofules in which Name/Arity is defined/imported.
----------------------------
revision 1.156
date: 2003/05/14 16:19:00;  author: lfcastro;  state: Exp;  lines: +2 -2
* Use ptoc_longstring in expand_pathname
----------------------------
revision 1.155
date: 2003/04/18 15:07:37;  author: lfcastro;  state: Exp;  lines: +5 -1
* Better error message when ODBC is not compiled in. Closes #635399.
----------------------------
revision 1.154
date: 2003/04/02 19:42:42;  author: lfcastro;  state: Exp;  lines: +10 -1
* New builtin: walltime(-X) returns the (wall clock) time since
  execution started (or since statistics(0) was last called).
----------------------------
revision 1.153
date: 2003/03/05 19:59:56;  author: lfcastro;  state: Exp;  lines: +4 -3
* Date related predicates:

  - now(-When) returns a string with current date & time --- format
  should be fixed

  - datime(-Datime) returns a term with current date & time in the
    form datime(Year,Month,Day,Hour,Min,Sec)

* All dates & times are UTC
----------------------------
revision 1.152
date: 2003/03/05 14:35:19;  author: lfcastro;  state: Exp;  lines: +2 -2
* Include <windows.h> when under windows in auxlry.c
* Tentative implementation of a more precise cputime builtin for Windows NT & up --- commented out, for now
----------------------------
revision 1.151
date: 2003/03/03 20:54:58;  author: lfcastro;  state: Exp;  lines: +18 -2
* (EXPERIMENTAL) Preliminary introduction of a get_date/5 builtin.
----------------------------
revision 1.150
date: 2003/01/28 22:56:58;  author: dwarren;  state: Exp;  lines: +5 -3
Move write_canonical (and write_canonical_lettervars) to C.  Not for speed
but so that they can be accessed from C, and used in the ODBC interface to
write terms canonically to character fields.
----------------------------
revision 1.149
date: 2002/11/05 20:50:36;  author: lfcastro;  state: Exp;  lines: +16 -1
* First cut at an implementation for abolish_table_call/1.
  - at this point, this call deletes all subsuming tables of a given
  term, via backtracking; what is the desired semantics?

*** WARNING ***
This is not a "safe" operator. It does not perform any kind of
checking, so one may, in fact, delete a table which is in use. This
may cause undefined behavior (i.e. segmentation faults and the like).
----------------------------
revision 1.148
date: 2002/10/04 20:42:00;  author: lfcastro;  state: Exp;  lines: +9 -9
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.147
date: 2002/09/10 16:22:50;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed ground to handle (unusual, but possible) 0-ary terms with PSC records.
----------------------------
revision 1.146
date: 2002/09/09 13:53:01;  author: dwarren;  state: Exp;  lines: +17 -14
Fixed ground/1 to use tail-recursion, to avoid c-stack overflow
----------------------------
revision 1.145
date: 2002/08/19 15:40:24;  author: tswift;  state: Exp;  lines: +32 -1
Added a math builtin, pow/3, to support clpqr.
----------------------------
revision 1.144
date: 2002/08/07 15:42:13;  author: lfcastro;  state: Exp;  lines: +3 -3
* do not use is_* functions (from the C interface) inside the
  emulator.
----------------------------
revision 1.143
date: 2002/05/22 15:41:12;  author: lfcastro;  state: Exp;  lines: +3 -7
branches:  1.143.2;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.142
date: 2002/05/20 17:47:09;  author: tswift;  state: Exp;  lines: +1 -83

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.141
date: 2002/03/13 22:40:13;  author: lfcastro;  state: Exp;  lines: +15 -1
* first step in implementing demand
- new (experimental) primitive: demand_once/1
- executes query and, after first answer is returned, deletes all
consumers created during execution; further, any tables created are
also destroyed
----------------------------
revision 1.140
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -6
* Removal of Chat engine
----------------------------
revision 1.139
date: 2002/02/21 16:57:56;  author: lfcastro;  state: Exp;  lines: +6 -2
branches:  1.139.2;
* Support for compiling with SimpleScalar/PISA
* Some fixes wrt boxed integers
----------------------------
revision 1.138
date: 2002/02/15 15:24:53;  author: dwarren;  state: Exp;  lines: +2 -3
Fixed bug in calling of builtin copy_term so it can now fail.
----------------------------
revision 1.137
date: 2002/01/28 16:47:55;  author: lfcastro;  state: Exp;  lines: +2 -2
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.136
date: 2002/01/23 17:08:08;  author: dwarren;  state: Exp;  lines: +5 -6
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.135
date: 2002/01/03 23:57:48;  author: tswift;  state: Exp;  lines: +10 -1
ifdef-able builtins added for interprolog
----------------------------
revision 1.134
date: 2001/12/29 06:28:15;  author: kifer;  state: Exp;  lines: +1 -53
took out the redundant floating point ops ceil/2, floor/2, etc.
----------------------------
revision 1.133
date: 2001/12/24 00:55:54;  author: kifer;  state: Exp;  lines: +57 -2
added floating point ops round/2, ceil/2, floor/2.
----------------------------
revision 1.132
date: 2001/11/08 21:35:25;  author: dwarren;  state: Exp;  lines: +4 -4
Eliminated the indirection of *asynint_ptr and to directly use
asynint_val.  (Also a minor bug-fix in ptoc_longstring.)
----------------------------
revision 1.131
date: 2001/11/07 21:08:00;  author: dwarren;  state: Exp;  lines: +4 -3
I modified slightly the way interrupts are handled.  There had been a
couple of mechanisms, and I tried to consolidate them. I elimitaed
call_intercept and merged it in with *asynint_ptr. Now the keyboard
interrupt can be used for C-user-defined interrupts.  There is a new
variable asynint_code that can be set when an interrupt is signaled.
It is set to 0 by the system signal catcher.  To generate a
user-defined interrupt, you need to set the KEYINT_MARK bit of
*asynint_ptr and set asynint_code to your integer code.  Then when
this interrupt is fielded, it will call the keyboard interrupt handler
(set by set_inthandler imported from loader) which is a two argument
predicate.  When it is called, the first argument will be the goal to
call when continuing out of the interrupt; the second argument will be
the value of asynint_code.
----------------------------
revision 1.130
date: 2001/09/21 15:01:15;  author: tswift;  state: Exp;  lines: +3 -1

Updates to profile amount of trapped Prolog choice points (if any) in SLGWAM
----------------------------
revision 1.129
date: 2001/08/13 04:31:35;  author: kifer;  state: Exp;  lines: +15 -2
added builtin to optimize the storage.P module
----------------------------
revision 1.128
date: 2001/07/24 15:36:49;  author: dwarren;  state: Exp;  lines: +4 -3
Fix lack-of-indirection error in varstring_create, so calling varstr is changed.
----------------------------
revision 1.127
date: 2001/07/07 06:10:30;  author: kifer;  state: Exp;  lines: +8 -1
some work to enhance dll support.
VarString cleanup in builtin.c
----------------------------
revision 1.126
date: 2001/07/02 16:20:47;  author: lfcastro;  state: Exp;  lines: +2 -3
* multi-line strings are deprecated
----------------------------
revision 1.125
date: 2001/06/29 22:50:48;  author: kifer;  state: Exp;  lines: +5 -4
replaced flora with flora2 in the build
added str_match.
----------------------------
revision 1.124
date: 2001/06/21 19:07:59;  author: tswift;  state: Exp;  lines: +9 -2

Added profiling info and traces of SCC shapes.
----------------------------
revision 1.123
date: 2001/05/24 17:54:51;  author: lfcastro;  state: Exp;  lines: +4 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.122
date: 2001/04/28 20:15:36;  author: ejohnson;  state: Exp;  lines: +2 -2
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.121
date: 2001/03/28 08:56:35;  author: kifer;  state: Exp;  lines: +18 -1
sped up conget/conset making them into builtins
----------------------------
revision 1.120
date: 2001/03/27 22:59:31;  author: dwarren;  state: Exp;  lines: +2 -2
modifications to configure (and a couple of other files) to support
the no-cygwin option to compile to a native windows executable usgin
cygwin's gcc compiler.  This allows XSB to use the jump-table
capabilities of gcc (for efficiency) without needing cygwin to
execute.
----------------------------
revision 1.119
date: 2001/03/27 17:52:02;  author: dwarren;  state: Exp;  lines: +2 -2
Took out PSC_INT code that MK proposed but is now not needed.  Also
minor changes to pahtname to make it a little more flexible for
cygwin.  Also changed last (?) boolean to xsbBool.
----------------------------
revision 1.118
date: 2001/03/26 04:59:02;  author: kifer;  state: Exp;  lines: +1 -6
got rid of the FILE_STAT builtin, replaced with the one in system_xsb.c
Added more path_sysop goodies.
----------------------------
revision 1.117
date: 2001/03/17 05:44:02;  author: kifer;  state: Exp;  lines: +27 -27
improved error messages
----------------------------
revision 1.116
date: 2001/02/21 14:50:04;  author: dwarren;  state: Exp;  lines: +3 -2
Changed builtin term_psc to call C function term_psc, generalizing it
to handle strings by converting them to have psc's.
----------------------------
revision 1.115
date: 2001/02/09 21:53:12;  author: dwarren;  state: Exp;  lines: +2 -2
Changed printf to xsb_warning for uniformity.
----------------------------
revision 1.114
date: 2001/02/05 14:44:30;  author: dwarren;  state: Exp;  lines: +3 -1
Added check for overflow in ctop_int to give an error message if
and integer is passed back to Prolog that has lost some bits.
----------------------------
revision 1.113
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +20 -14
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.112
date: 2000/12/06 13:39:47;  author: dwarren;  state: Exp;  lines: +6 -5
optimize tail recursion in ptoc_longstring.
----------------------------
revision 1.111
date: 2000/12/04 17:10:42;  author: ejohnson;  state: Exp;  lines: +27 -21
Added support for subsumption-based LRD stratified negation,
including:

o Modification of 't not'/1 to accept all predicates.

o Replacement of predicate get_producer_subgoal_frame/2 with a new
  predicate get_producer_call/3 (ala get_call/3 and friends) to take
  the subgoal and perform a tabling-strategy-dependent lookup,
  returning a producer's subgoal frame and an answer template with
  respect to that producer.

  get_producer_call/3 aborts if given a non-tabled predicate and fails
  if the tabled predicate hasn't been called before.

o Modification of slg_not/1 s.t. it takes two extra arguments: the
  first is the answer template from get_producer_call/3, used by
  negated, properly subsumed predicates for relevant-answer
  collection; the second contains the subgoal which is negated, used
  only for error reporting.

o Extension of certain C functions, e.g. get_variant_sf() and
  get_subsumer_sf() to build and return, in an extra argument, the
  answer template.
----------------------------
revision 1.110
date: 2000/11/22 20:06:12;  author: ejohnson;  state: Exp;  lines: +6 -3
Modified get_producer_subgoal_frame/2 to carry an extra argument for
reporting the predicate's type.  This will boost efficiency of 't not'/1
by allowing us to remove the call to table_state/4 which also performs a
lookup of the goal.
----------------------------
revision 1.109
date: 2000/11/22 15:24:43;  author: dwarren;  state: Exp;  lines: +70 -1
Added ptoc_longstring which is like ptoc_string, except that it
accepts a complex structure from Prolog and turns it into a C string.
It accepts lists, regular and ,-separated, containing atoms or small
integers, and constructs a string by concatenating the atoms or chars.
Small ints represent their ascii codes.  It is recursive.  This makes
it easier to send a long string across the C interface, without having
to construct a new atom for it.
----------------------------
revision 1.108
date: 2000/10/05 17:23:14;  author: ejohnson;  state: Exp;  lines: +16 -11
branches:  1.108.2;
Added two more structure tests to Structure Manager code:
- smIsAllocatedStruct(SM,struct) checks whether a known valid struct is
    currently allocated wrt its SM.
- smIsAllocatedStructRef(SM,struct) combines the functionality of
    smIsValidStructRef() and smIsAllocatedStruct().
Also changed argument passing style of SM from pass-by-ref to pass-by value.

Added extra checks to TRIE_DELETE_RETURN builtin to ensure that (1)
leaf node is currently allocated, (2) that it is in fact a leaf, and
(3) that it appears in the answer set associated with the given
subgoal frame.
----------------------------
revision 1.107
date: 2000/09/28 21:31:01;  author: ejohnson;  state: Exp;  lines: +53 -24
Two subsumption-related changes:

(1) Support for incomplete subsumptive subgoals in tfindall/3.
    Two builtins needed modification:
    -- get_subgoal_ptr/2 ==> get_producer_subgoal_frame/2
         Now handles both variant and subsumptive subgoals, returning
	 the producing table entry.
    -- is_incomplete/4 ==> is_incomplete/2
         Now handles both variant and subsumptive subgoals.  Used to
	 encompass some of the functionality of get_subgoal_ptr/2, but
	 since the processing performed by that builtin is more complex,
	 this (partial) functionality is removed.

(2) Standard predicate delete_return/2 produces an error when invoked
    on a subsumptive table entry.
----------------------------
revision 1.106
date: 2000/08/05 07:59:23;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Introduced a new inline builtin: is_attv/1.
----------------------------
revision 1.105
date: 2000/07/31 20:27:53;  author: ejohnson;  state: Exp;  lines: +77 -36
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.104
date: 2000/07/25 20:45:59;  author: ejohnson;  state: Exp;  lines: +59 -30
Added function for performing validity checks for structure references
on structures maintained by Structure Manager.  Useful when users
provide pointer values as arguments to builtins.

Used this function in builtin table_status/4 for checking subgoal
frame reference validity.

Reinstated correct semantics for get_calls_for_table/2.

Added builtin get_returns/3 to list of standard predicates.  This was
apparently left off this list accidentally???  According to the
manual, it is a standard predicate.
----------------------------
revision 1.103
date: 2000/06/29 06:25:27;  author: kifer;  state: Exp;  lines: +1 -2
deleted redundant break.
----------------------------
revision 1.102
date: 2000/06/28 06:42:52;  author: kifer;  state: Exp;  lines: +4 -4
incorporated Prasad's reclaim_uninterned_nr builtin.
----------------------------
revision 1.101
date: 2000/06/25 16:59:14;  author: ejohnson;  state: Exp;  lines: +16 -9
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.100
date: 2000/06/23 20:54:07;  author: ruim;  state: Exp;  lines: +5 -4
Removed some C++ automatic pointer casting warnings
----------------------------
revision 1.99
date: 2000/06/22 19:40:30;  author: ruim;  state: Exp;  lines: +15 -15
added casts to malloc calls to avoid warnings in C++
----------------------------
revision 1.98
date: 2000/06/19 07:48:07;  author: ruim;  state: Exp;  lines: +2 -2
Changes to remove warnings
----------------------------
revision 1.97
date: 2000/06/14 21:16:04;  author: kifer;  state: Exp;  lines: +5 -1
Added builtin stub for reclaim_uninterned_nr/trie_reclaim_uninterned_nr.
----------------------------
revision 1.96
date: 2000/05/29 04:23:33;  author: ejohnson;  state: Exp;  lines: +14 -9
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.95
date: 2000/05/25 23:24:53;  author: kifer;  state: Exp;  lines: +14 -68
made call0 and call_code into inlined functions.
----------------------------
revision 1.94
date: 2000/05/25 00:32:00;  author: ejohnson;  state: Exp;  lines: +7 -4
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.93
date: 2000/05/20 06:55:55;  author: kifer;  state: Exp;  lines: +5 -5
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.92
date: 2000/05/12 20:18:15;  author: ejohnson;  state: Exp;  lines: +33 -13
Fix for builtins abolish_all_tables and abolish_table_pred.
Checks that the subgoals are (marked as) complete before destroying
the tables.

Other supporting changes:

Added a field in TableInfoFrames (TIF) for maintaining references to
the subgoals according to predicate, rather than one global list.
Routines which walked this list had to be appropriately modified.

Discovered that TIFs weren't being counted in memory usage, so changed
their allocation to use mem_alloc() instead of malloc().

Moved the code which places a TIF on the alloc chain, maintained
through `first_tip' and `last_tip', into macro New_TIF().
Removed this code from biassert.c and loader_xsb.c.

Made a structure out of `first_tip' and `last_tip'.  Added an extern
for this structure to macro_xsb.h, and hence removed the externs from
biassert.c and builtin.c.  Modified references appropriately.

Producer subgoal frame allocation now puts the SF into the predicate's
TIF.
----------------------------
revision 1.91
date: 2000/04/29 21:53:50;  author: kifer;  state: Exp;  lines: +89 -88
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.90
date: 2000/04/06 11:19:15;  author: cbaoqiu;  state: Exp;  lines: +3 -5
Let ret_random() and getrand() return TRUE or FALSE (instead of 0 and
-1) to be consistent with other builtin implementations.
----------------------------
revision 1.89
date: 2000/04/05 17:42:02;  author: cbaoqiu;  state: Exp;  lines: +19 -1
Added a new builtin WH_RANDOM (53) for random number generator.
----------------------------
revision 1.88
date: 2000/03/01 16:22:33;  author: dwarren;  state: Exp;  lines: +26 -22
branches:  1.88.2;
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.87
date: 2000/02/22 14:54:15;  author: tswift;  state: Exp;  lines: +22 -1

Changes to integrate catch/throw.  Builtins are presently in the module
standard, but are not automatically imported by the interpreter level.  (I'll
do this after we all kick the predicates around a little).
----------------------------
revision 1.86
date: 2000/01/11 17:19:05;  author: ejohnson;  state: Exp;  lines: +152 -53
Added support for subsumptive predicates/tables in two builtins:
table_state and abolish_table_pred.  This included 1) a routine for
performing a subsumptive goal lookup in a table, plus modification of
builtin code to interpret the results (this is practically rewritten),
and 2) a set of routines for deleting portions of subsumptive tables.
----------------------------
revision 1.85
date: 2000/01/07 08:51:17;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.84
date: 1999/12/21 22:56:30;  author: warren;  state: Exp;  lines: +11 -11
cleanup to reduce number of warnings given by MSVC compiler.
----------------------------
revision 1.83
date: 1999/12/14 20:41:46;  author: ejohnson;  state: Exp;  lines: +44 -17
get_call/3 rewritten as a builtin, which made the builtin
construct_ret_for_call/1 expendable.  It was only used in support
of get_call/3.

Arity of get_lastnode_cs_retskel changed from 3 to 4.  The extra
argument contains the original call for computing the answer template
for a properly subsumed subgoal.

Note that the builtin code TRIE_GET_CALL is now used for get_call/3,
while that for get_calls/1, which originally used TRIE_GET_CALL, is
changed to TRIE_UNIFY_CALL.
----------------------------
revision 1.82
date: 1999/12/14 15:41:14;  author: luis;  state: Exp;  lines: +58 -38
- optimizations in ground()
----------------------------
revision 1.81
date: 1999/12/12 03:27:33;  author: kifer;  state: Exp;  lines: +3 -3
removed copy_term0, only copy_term is left.
----------------------------
revision 1.80
date: 1999/12/10 07:47:26;  author: kifer;  state: Exp;  lines: +5 -30
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.79
date: 1999/11/19 20:31:06;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Declared printterm as an extern function when DEBUG is define.  It's
used in bineg_xsb_i.h.
----------------------------
revision 1.78
date: 1999/11/17 17:41:55;  author: ejohnson;  state: Exp;  lines: +2 -2
Warning fixes, noticed under 64-bit mode compilation:
- type mismatches, in assignment and print formats
- unused variables
----------------------------
revision 1.77
date: 1999/11/17 15:06:49;  author: warren;  state: Exp;  lines: +4 -4
Moved a close-brace in get_token, which pretty clearly was in the
wrong place.
----------------------------
revision 1.76
date: 1999/11/05 21:41:10;  author: cbaoqiu;  state: Exp;  lines: +3 -2
Added type check in builtin get_attributes/3.
----------------------------
revision 1.75
date: 1999/11/02 01:20:20;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Very minor changes in comments.
----------------------------
revision 1.74
date: 1999/10/29 14:29:03;  author: kostis;  state: Exp;  lines: +164 -119
Many changes to define variables in smallest possible block that they are
used.  There is a *significant* speedup potential by doing so.  I will,
hopefully soon, write a mail about this.
----------------------------
revision 1.73
date: 1999/10/26 06:46:44;  author: kifer;  state: Exp;  lines: +14 -14
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.72
date: 1999/10/25 05:57:27;  author: kifer;  state: Exp;  lines: +19 -19
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.71
date: 1999/10/22 20:57:29;  author: ejohnson;  state: Exp;  lines: +29 -20
Enabled subsumption with CHAT.

The interesting changes are in chat.c and chatsched.i.

Changes to the other files just remove CHAT restrictions to
subsumption.
----------------------------
revision 1.70
date: 1999/10/19 20:11:45;  author: ejohnson;  state: Exp;  lines: +9 -9
Addition of variant/1 to XSB to complement subsumptive/1.
Each one changes the tabled evaluation method of the given
predicate(s).

Modified the structure of related constants to utilize the
preprocessor on the Prolog end.  The builtin which actually makes the
change in the TableInfoFrame is generalized from only making the
switch to subsumptive mode to taking an extra argument indicating the
method to use during the predicate's evaluation.
----------------------------
revision 1.69
date: 1999/10/12 19:52:35;  author: ejohnson;  state: Exp;  lines: +12 -3
Added header file.

Renamed abolish_trie to release_all_tabling_resources.  This better
describes its intended use: to free resources for tabled tries (vs,
possibly also being used to free interned/asserted tries).

Builtin for making a pred eval subsumptively temporarily ifdef'd out
for CHAT.
----------------------------
revision 1.68
date: 1999/10/11 15:43:02;  author: kostis;  state: Exp;  lines: +206 -218
Clean up changes and changes to make variables used in the smallest possible
enclosing block.  This last step is still incomplete, however, it is a good
first step.
----------------------------
revision 1.67
date: 1999/10/10 11:38:10;  author: kostis;  state: Exp;  lines: +1 -2
Changes to fold code of file "load_seg.c" into "loader.c" and thus avoid
communication between these two pieces of code through horrible global
variables.  Files "load_seg.*" are removed.  Some code cleanup took place.
----------------------------
revision 1.66
date: 1999/10/09 02:00:20;  author: cbaoqiu;  state: Exp;  lines: +74 -5
Changes for attributed variables (first step).
----------------------------
revision 1.65
date: 1999/10/08 07:33:45;  author: kifer;  state: Exp;  lines: +16 -28
added substring, string_substitute
----------------------------
revision 1.64
date: 1999/10/05 04:01:16;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.63
date: 1999/09/25 16:34:22;  author: kifer;  state: Exp;  lines: +2 -1
Implemented atom/number_chars correctly. Added number digits.
----------------------------
revision 1.62
date: 1999/08/30 16:40:47;  author: kostis;  state: Exp;  lines: +6 -9
Clean up and simplification changes in various builtins and in their use.
----------------------------
revision 1.61
date: 1999/08/30 13:57:27;  author: kostis;  state: Exp;  lines: +4 -8
Unused and obsolete PSC stuff taken out.
----------------------------
revision 1.60
date: 1999/08/28 09:49:06;  author: kostis;  state: Exp;  lines: +8 -1
Introduced psc_set_spy/2 buitlin predicate to avoid ugliness in Prolog.
----------------------------
revision 1.59
date: 1999/08/28 07:54:15;  author: kostis;  state: Exp;  lines: +17 -3
Added new builtins in C that manipulate file names and used them in
consult.P to implement search_module/7.  Should be cleaner and faster
now.
----------------------------
revision 1.58
date: 1999/08/27 16:14:54;  author: warren;  state: Exp;  lines: +22 -4
extended is_most_general_term/1 to include checking for list of
distinct variables.
----------------------------
revision 1.57
date: 1999/08/25 17:46:49;  author: warren;  state: Exp;  lines: +18 -14
Modified table_state to take either a subgoal pointer or a term.
----------------------------
revision 1.56
date: 1999/08/19 15:08:29;  author: kifer;  state: Exp;  lines: +32 -1
added segfault_handler/1
----------------------------
revision 1.55
date: 1999/08/18 12:31:30;  author: kostis;  state: Exp;  lines: +42 -90
Predicate ground/1 made a direct builtin.  Also some unused (and most
probably non-working) builtins taken out.  Small change in xpathname.c.
----------------------------
revision 1.54
date: 1999/08/17 19:30:04;  author: warren;  state: Exp;  lines: +49 -5
convert dynamic P/A to dynamic p(_,_,..), added new builtin
is_most_general_term to return true if given a term with all distinct
variables as subfields.
----------------------------
revision 1.53
date: 1999/08/17 06:34:09;  author: kifer;  state: Exp;  lines: +16 -15
Added pipe_open, pipe2file.
Fixed compilation bugs on NT from yesterday's.
----------------------------
revision 1.52
date: 1999/08/16 07:24:03;  author: kifer;  state: Exp;  lines: +3 -1
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.51
date: 1999/08/14 16:41:41;  author: kostis;  state: Exp;  lines: +4 -20
Eliminated obsolete and unused builtins; fixed name and arity
inconsistencies in the definition of builtins.
----------------------------
revision 1.50
date: 1999/08/10 12:17:50;  author: kostis;  state: Exp;  lines: +32 -25
lean up and slight improvement of string manipulation builtins.
Eliminated building of strings in the heap (like eg. in str_cat)
without checking for overflows.  Now str_cat occurs in a buffer
of its own.  Also, made str_* routines test their arguments for
the correct types and unify their output arguments.
----------------------------
revision 1.49
date: 1999/08/04 14:41:49;  author: ejohnson;  state: Exp;  lines: +47 -20
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.48
date: 1999/08/02 09:05:18;  author: kifer;  state: Exp;  lines: +1 -4
Deleted open/close_process_stream/pipe.
Added the more general spawn_process/3.
Added section on interprocess communication to manual2.
Still needs testing on NT.
----------------------------
revision 1.47
date: 1999/08/02 00:28:56;  author: kifer;  state: Exp;  lines: +10 -5
renamed xsbsockets.i to xsbsockets.c
added socket_set-option
----------------------------
revision 1.46
date: 1999/07/27 14:55:23;  author: kifer;  state: Exp;  lines: +1 -5
eliminated str_insert, because it duplicates intern_string.
----------------------------
revision 1.45
date: 1999/07/20 18:54:35;  author: kifer;  state: Exp;  lines: +9 -5
added open_process_pipe/close_process_pipe,
open_process_stream/close_process_stream
----------------------------
revision 1.44
date: 1999/07/15 21:41:10;  author: ejohnson;  state: Exp;  lines: +3 -22
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.43
date: 1999/07/06 16:35:04;  author: ejohnson;  state: Exp;  lines: +11 -44
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.42
date: 1999/07/05 06:13:02;  author: kifer;  state: Exp;  lines: +14 -3
added xsb_sprint_variable to fix the problem with printing vars in
print_pterm: cinterf.c (now fmt_write('%S', f(V)) prints vars the same
way as write(V) does).
----------------------------
revision 1.41
date: 1999/06/17 07:50:56;  author: kifer;  state: Exp;  lines: +15 -1
Added a new builtin: is_charlist/1 and /2
----------------------------
revision 1.40
date: 1999/05/06 16:01:17;  author: unova;  state: Exp;  lines: +7 -2
Implemented reclaim_space and fixed a bad bug on retract_nr.
----------------------------
revision 1.39
date: 1999/04/30 15:53:27;  author: kifer;  state: Exp;  lines: +7 -3
Changed so that when foreign function returns 0 then the corresponding
xsb predicate will fail.
----------------------------
revision 1.38
date: 1999/04/27 14:39:39;  author: kifer;  state: Exp;  lines: +21 -26
Made large builtins in the former std_pred.i into inlined subroutines.
Added atom_codes, number_codes and made atom_chars, number_chars into
synonyms to the *_codes builtins.
----------------------------
revision 1.37
date: 1999/04/22 06:54:36;  author: kifer;  state: Exp;  lines: +11 -409
Took socket stuff out of builtin.c and put it in xsbsocket.[ih]
Unified WIN_NT and Unix parts, eliminating duplicates, etc.
----------------------------
revision 1.36
date: 1999/04/16 04:10:39;  author: kifer;  state: Exp;  lines: +2 -2
Minor changes to pacify non-gcc compilers.
----------------------------
revision 1.35
date: 1999/04/13 17:24:44;  author: kostis;  state: Exp;  lines: +25 -61
Performed major clean-up and rationalization of the tabling builtins.
----------------------------
revision 1.34
date: 1999/04/08 18:05:52;  author: kostis;  state: Exp;  lines: +39 -42
Another try.
----------------------------
revision 1.33
date: 1999/04/04 03:54:45;  author: kifer;  state: Exp;  lines: +60 -65
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.32
date: 1999/04/03 04:46:37;  author: kifer;  state: Exp;  lines: +6 -8
Introduced file_read_line_atom and file_read_line_list.
----------------------------
revision 1.31
date: 1999/04/02 20:16:59;  author: kifer;  state: Exp;  lines: +9 -2
Added comments, to help me through
----------------------------
revision 1.30
date: 1999/04/02 03:48:01;  author: kifer;  state: Exp;  lines: +11 -1
Introduced private_builtin/11
----------------------------
revision 1.29
date: 1999/04/01 05:03:07;  author: kifer;  state: Exp;  lines: +5 -18
Replaced fmt_ builtins with formatted_io().
The fmt_* builtins now hang off of that.
----------------------------
revision 1.28
date: 1999/03/30 16:25:17;  author: kifer;  state: Exp;  lines: +15 -207
Changes associated with moving file_open/close/put/get,
fmt_read/write, etc. to file_io. Unifying the builtins
file_open/close/put/get with file_flush/seek/truncate
under a single builtin file_function.
----------------------------
revision 1.27
date: 1999/03/29 21:06:49;  author: kifer;  state: Exp;  lines: +2 -2
Fixed a portability bug in ftruncate.
----------------------------
revision 1.26
date: 1999/03/27 09:33:01;  author: workflow;  state: Exp;  lines: +33 -2

additional file functions and is_deleted(X) macro defn fixes
----------------------------
revision 1.25
date: 1999/03/17 18:34:40;  author: kostis;  state: Exp;  lines: +190 -33
Changes to separate out all builtin #defines from "inst.h" and have them
appear in a new file called "builtin.h".
----------------------------
revision 1.24
date: 1999/03/07 10:26:05;  author: c541-1;  state: Exp;  lines: +6 -6
Bart Demoen
changed Sun Mar  7 11:27:18 MET 1999
builtin.c
last arg of print_ls print_tr print_heap print_cp print_regs change from
0 to 1
make life easier when debugging
and to try out my first commit
----------------------------
revision 1.23
date: 1999/03/06 03:34:47;  author: cbaoqiu;  state: Exp;  lines: +14 -1
Added builtin force_truth_value/2.
----------------------------
revision 1.22
date: 1999/02/22 16:56:49;  author: workflow;  state: Exp;  lines: +16 -2
nr stuff
----------------------------
revision 1.21
date: 1999/02/03 16:07:06;  author: workflow;  state: Exp;  lines: +2 -16
rollback.
rollback
----------------------------
revision 1.20
date: 1999/02/03 11:14:10;  author: workflow;  state: Exp;  lines: +16 -2
*** empty log message ***
----------------------------
revision 1.19
date: 1999/02/02 17:17:01;  author: kostis;  state: Exp;  lines: +1 -2
Silly include for debugging taken out.
----------------------------
revision 1.18
date: 1999/02/01 23:55:58;  author: kostis;  state: Exp;  lines: +4 -4
Changes for a first cut of a working heap garbage collector.
----------------------------
revision 1.17
date: 1999/01/29 20:06:44;  author: kostis;  state: Exp;  lines: +9 -8
Important changes: Saving of argument registers for completion suspension
choice points is not needed either in the SLG-WAM or in CHAT.
----------------------------
revision 1.16
date: 1999/01/27 17:40:53;  author: kostis;  state: Exp;  lines: +1 -2
Minor cleanup after deletion of cutils.c
----------------------------
revision 1.15
date: 1999/01/24 17:07:42;  author: kostis;  state: Exp;  lines: +3 -3
Rectified type definitions in delete_branch().
----------------------------
revision 1.14
date: 1999/01/19 18:50:55;  author: kostis;  state: Exp;  lines: +58 -101
Fixed foreign language interface bug on Linux and did a major cleanup.
----------------------------
revision 1.13
date: 1999/01/15 18:41:34;  author: kostis;  state: Exp;  lines: +14 -25
Cleanup changes to avoid unnecessary arguments in two heavily used hard
builtin predicates.  This should hopefully slightly speed up some things.
----------------------------
revision 1.12
date: 1999/01/15 12:30:29;  author: kostis;  state: Exp;  lines: +8 -18
Clean-up changes to disallow allocation/deallocation of buffers in the heap.
----------------------------
revision 1.11
date: 1999/01/13 18:19:09;  author: kostis;  state: Exp;  lines: +10 -10
Changes related to printing of WAM stacks.  Corresponding predicates made
builtins and added in machine.P.
----------------------------
revision 1.10
date: 1999/01/12 05:29:12;  author: cbaoqiu;  state: Exp;  lines: +21 -5
Changed builtin DELETE_TRIE so that deleted sets are collected into
the free set list.
----------------------------
revision 1.9
date: 1999/01/10 01:05:00;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Change builtin GET_LASTNODE_AND_RETSKEL to GET_LASTNODE_CS_RETSKEL.
----------------------------
revision 1.8
date: 1998/12/22 15:48:53;  author: kostis;  state: Exp;  lines: +6 -6
Changes related to moving breg_skel() completely down to C and
making it work with CHAT which stores the substitution factor
of generatr choice points in the heap instead of the choice point
stack.
----------------------------
revision 1.7
date: 1998/12/21 01:07:56;  author: cbaoqiu;  state: Exp;  lines: +60 -64
Kostis' changes for GC and CHAT.
----------------------------
revision 1.6
date: 1998/12/09 03:03:54;  author: cbaoqiu;  state: Exp;  lines: +4 -3
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  Variables `dls' and `idl' are changed to `dl' and `de' (along with
  their types), and function printterm() is declared extern if DEBUG
  is defined.
----------------------------
revision 1.5
date: 1998/12/01 17:10:42;  author: sbprolog;  state: Exp;  lines: +7 -1
These are small fixes to a couple of stack expansion bugs, mainly
in the placing of the overflow checks.

TRIM_CORE is also updated to deal with heap/local stack expansion.

-- Rui Marques
----------------------------
revision 1.4
date: 1998/11/18 07:59:12;  author: kifer;  state: Exp;  lines: +3 -3
Moved initialization of executable, user_home, xsb_config_file to the
new file self_orientation. Added initialization like in xmain.c to
xsb_init in cinterf.c. This should fix the C-calling xsb interface.
----------------------------
revision 1.3
date: 1998/11/18 03:20:19;  author: kifer;  state: Exp;  lines: +6 -6
Changed so that xsb will find its path name in case it is called as
xsb and is found by the OS by searching the $PATH environment var.
----------------------------
revision 1.2
date: 1998/11/13 02:48:54;  author: kifer;  state: Exp;  lines: +5 -3
Modifications for porting to NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.88.2.1
date: 2000/03/28 18:10:30;  author: lfcastro;  state: Exp;  lines: +1 -3
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.108.2.4
date: 2001/01/07 00:32:50;  author: ruim;  state: Exp;  lines: +0 -2
fixes
----------------------------
revision 1.108.2.3
date: 2001/01/06 18:43:04;  author: ruim;  state: Exp;  lines: +3 -1
Initialization data made static and other small changes
----------------------------
revision 1.108.2.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.108.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +66 -6
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.139.2.6
date: 2004/12/14 08:47:04;  author: ruim;  state: Exp;  lines: +2 -2
added dynamic stacks to thread context
----------------------------
revision 1.139.2.5
date: 2004/11/24 21:53:25;  author: ruim;  state: Exp;  lines: +18 -18
made smBTHT and smBTN thread specific
----------------------------
revision 1.139.2.4
date: 2004/11/22 23:07:29;  author: ruim;  state: Exp;  lines: +2 -2
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.139.2.3
date: 2004/11/01 16:56:11;  author: ruim;  state: Exp;  lines: +4 -1
added predicate ts_abolish_table_call
----------------------------
revision 1.139.2.2
date: 2004/10/18 20:45:55;  author: ruim;  state: Exp;  lines: +256 -140
update for version 2.6.1
----------------------------
revision 1.139.2.1
date: 2004/09/29 19:43:54;  author: ruim;  state: Exp;  lines: +315 -292
Sources from rfm repository
----------------------------
revision 1.143.2.6
date: 2003/04/17 17:11:53;  author: lfcastro;  state: Exp;  lines: +47 -4
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.143.2.5
date: 2002/11/01 22:38:18;  author: lfcastro;  state: Exp;  lines: +2 -2
* Use approximate pruning when cutting (only when DEMAND is enabled)
----------------------------
revision 1.143.2.4
date: 2002/10/28 16:49:29;  author: lfcastro;  state: Exp;  lines: +28 -21
* Merge with HEAD
----------------------------
revision 1.143.2.3
date: 2002/08/29 14:17:12;  author: lfcastro;  state: Exp;  lines: +31 -0
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.143.2.2
date: 2002/08/07 17:53:34;  author: lfcastro;  state: Exp;  lines: +8 -12
* update to HEAD
----------------------------
revision 1.143.2.1
date: 2002/08/07 17:41:37;  author: lfcastro;  state: Exp;  lines: +10 -6
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.161.2.2
date: 2003/09/30 14:38:35;  author: tschrijvers;  state: Exp;  lines: +3 -3
made term_set_arg backward compatible
----------------------------
revision 1.161.2.1
date: 2003/09/11 13:48:09;  author: tschrijvers;  state: Exp;  lines: +34 -10
Changed the emulator in the following way:
- term_new_mod/3 builtin from to copy a term
  to a term in a different module
- globalvar builtin that provides one global variable
- changed behavior of get_attributes and put_attributes:
  attribute value can be anything, not just a vector
- replace pre-unification interrupt handling of attributed variables
  to post-unification handling
----------------------------
revision 1.341.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.341.2.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +9 -0
no message
----------------------------
revision 1.341.2.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/builtin.h,v
Working file: builtin.h
head: 1.114
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.102
	ROLLBACK: 1.96
	latest_plus_supp_branch: 1.92.0.2
	latest_plus_supp: 1.92
	Version_3dot2_plus_supp: 1.87.0.2
	release_2_6_plus_supp: 1.52.0.4
	Version_3dot2: 1.87
	dec07-perf-results: 1.81
	mt_thesis: 1.74
	release_3_0: 1.73
	release_2_7_0: 1.62
	multi-threaded-26-engine: 1.42.2.2
	pre-mt: 1.62
	multi-threaded-25-engine-done: 1.42.2.1
	multi-threaded-25-engine: 1.42.0.2
	release_2_6_1: 1.52.2.1
	release_2_6_final: 1.52
	release_2_6: 1.52.0.2
	last-merged-to-demand: 1.45
	demand_branch: 1.45.0.2
	before_removing_chat: 1.42
	release_2_5: 1.42
	pre-merge-slgwam-gc: 1.39
	multi-threaded-c-engine: 1.39.0.2
	release_2_4: 1.38
	release_2_3: 1.35
	multi-threaded-engine: 1.33.0.2
	pre-threading: 1.30
	release-2-2: 1.29
	chat-and-local: 1.28.0.2
	xsb-pre-cleanup: 1.28
	release-2-1: 1.24
	release-2-0-1: 1.24
	subsumption: 1.23
	without-attv: 1.22
	release-2-0: 1.10
	pre-release-2-0: 1.7
keyword substitution: kv
total revisions: 128;	selected revisions: 128
description:
----------------------------
revision 1.114
date: 2012/02/05 16:44:58;  author: tswift;  state: Exp;  lines: +4 -1

Added ground_and_acyclic/1.
----------------------------
revision 1.113
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +2 -1
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.112
date: 2011/12/19 21:39:46;  author: waltergwilson;  state: Exp;  lines: +3 -2
ground_cyc/1
----------------------------
revision 1.111
date: 2011/11/04 23:21:11;  author: tswift;  state: Exp;  lines: +2 -1

is_acyclic/1.
----------------------------
revision 1.110
date: 2011/10/29 23:27:58;  author: tswift;  state: Exp;  lines: +2 -1

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.109
date: 2011/10/09 19:39:06;  author: waltergwilson;  state: Exp;  lines: +2 -1
term_size_limit/2
----------------------------
revision 1.108
date: 2011/10/05 21:29:09;  author: tswift;  state: Exp;  lines: +2 -1

Added TERM_SIZE macro.
----------------------------
revision 1.107
date: 2011/09/23 18:36:08;  author: tswift;  state: Exp;  lines: +2 -1

Changes for timed_call/3
----------------------------
revision 1.106
date: 2011/08/13 19:56:20;  author: tswift;  state: Exp;  lines: +2 -1

is_cyclic + fix to weird bug with not initializaing memory errors...
----------------------------
revision 1.105
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +7 -1
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.104
date: 2011/08/04 19:52:57;  author: tswift;  state: Exp;  lines: +2 -1


term_depth/1
----------------------------
revision 1.103
date: 2011/04/15 03:11:03;  author: kifer;  state: Exp;  lines: +7 -1
Added url_encode/url_decode.
----------------------------
revision 1.102
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -2
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.101
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.100
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.99
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.98
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.97
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +2 -1
no message
----------------------------
revision 1.96
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.95
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.94
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -1
Backed out code
----------------------------
revision 1.93
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +2 -1
Dipti's code for support graph added
----------------------------
revision 1.92
date: 2010/05/26 20:51:38;  author: tswift;  state: Exp;  lines: +2 -1
branches:  1.92.2;

New builtin get_trie_leaf for faster trie_interned.
----------------------------
revision 1.91
date: 2010/02/10 19:11:12;  author: dwarren;  state: Exp;  lines: +2 -2
Made excess_vars a builtin, for efficiency.
----------------------------
revision 1.90
date: 2010/01/18 13:54:51;  author: dwarren;  state: Exp;  lines: +2 -1
Add ground_term as a case in jumpcof, to allow it to appear in a test without laying
down a choicepoint.
----------------------------
revision 1.89
date: 2009/10/19 16:51:14;  author: dwarren;  state: Exp;  lines: +2 -1
Added erf (normal error function) call in function.  (Useful for PRISM-like reasoning.)
Added psc_import_as function, which assigns the entry-point of a psc to point to the
load-address of another PSC.  Will be used for "import a from b as c" functionality,
but it's not complete yet.
----------------------------
revision 1.88
date: 2009/04/27 18:32:03;  author: dwarren;  state: Exp;  lines: +3 -1
Added new builtin: psc_mod, to get the address of the module psc from a pcs
record.  This used to be done by psc_prop, but got (more) overloaded when we changed
the psc_data field to have the module psc address if it is not usermod, and to
have the filename of the file that defined it if it *is* usermod.  Now psc_mod
returns a psc address always (as needed for curr_cym and loader.)
----------------------------
revision 1.87
date: 2009/01/10 23:37:07;  author: tswift;  state: Exp;  lines: +2 -2

Extended (almost) all the marking routines for tabled predicates
so that subgoals in the heap delay list are checked.  This rather
obscure bug caused a crash in a Flora program for defeasible
logic.  I'll try to finish that part tomorrow.

The problem was that space was reclaimed for a table T that had a
delay element in the heap pointing to it.  When the answer with
the delay element was added, the engine tried to adjust the
backpointers for T and crashed.

Also made some minor ajustments for efficency to some of the
marking functions.  And I changed abolish_table_info to the
clearer abolish_all_tables.
----------------------------
revision 1.86
date: 2008/11/25 18:40:07;  author: dwarren;  state: Exp;  lines: +3 -1
Added new jumpcof builtin: if_number_atom that succeeds if the atom can be
converted to a number by (atom_codes and then) number_codes.  This is necessitated
by the change that to number_codes to throw an error that made it more standard
conforming.
----------------------------
revision 1.85
date: 2008/02/22 03:39:10;  author: dwarren;  state: Exp;  lines: +2 -1
Main change is to add a builtin to implement call/n for n=2..10.
That affected builtin.c,builtin.h,machine.P,standard.H and associated
xwam files.
The other xwam files seem not to have been updated with recent .P file
changes.
----------------------------
revision 1.84
date: 2008/02/21 21:33:44;  author: tswift;  state: Exp;  lines: +2 -1
Overlooked adding DIRECTLY_CALLABLE_TEST
----------------------------
revision 1.83
date: 2008/01/16 17:19:37;  author: dwarren;  state: Exp;  lines: +2 -1
Added new builtin for conpsc/2.  It moves down this functionality fully
into C.  I was tired of looking at performance profiles with 3-5% of the
time spent in this predicate.  It is heavily used in assert.
----------------------------
revision 1.82
date: 2007/12/24 19:16:59;  author: tswift;  state: Exp;  lines: +3 -6

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.81
date: 2007/11/01 18:48:51;  author: tswift;  state: Exp;  lines: +1 -4
Fixed some problems in **/2 -- Sundays update didn't handle floats
properly, due to a copy and paste error.  Also, I added a domain check
(as in standard) that the number exponientiated isnt negative with a
float exponent.  Finally, I was able to take out the pow builtin as
eval now calls **/2.

In addition, made some of the C error functions DLL-exported so that
they can be used by external C functions.
----------------------------
revision 1.80
date: 2007/10/07 17:37:55;  author: tswift;  state: Exp;  lines: +2 -1

Two sets of changes.

First, was to add const declaration modifiers to external ctop and
ptoc routines.  Apparently some C++ compilers can benefit from this
modifier, and it should help the Parma polyhedra group and others who
call XSB from C++.

The second change supports call_cleanup, and fixes a minor bug in the
implementation of catch (see the emails on the XSB group).  This
update does not handle cutting over call cleanup -- I'll try to get
that in soon.
----------------------------
revision 1.79
date: 2007/08/23 14:48:19;  author: dwarren;  state: Exp;  lines: +2 -2
Change setenv to putenv (with mostly same functionality, but works on Windows, too)
(xsb_read.xwam seems to have gotten out of sync, and this should put it back in.)
----------------------------
revision 1.78
date: 2007/08/22 22:04:33;  author: tswift;  state: Exp;  lines: +2 -1

Added setenv/3.
----------------------------
revision 1.77
date: 2007/05/01 14:52:29;  author: tswift;  state: Exp;  lines: +10 -8

Adding scratch code for table inspection functions that may, if they're good, grow up into answer_completion and the like.
----------------------------
revision 1.76
date: 2007/04/05 17:26:57;  author: tswift;  state: Exp;  lines: +4 -1
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.75
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +2 -1

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.74
date: 2006/09/06 05:15:26;  author: diptikalyan;  state: Exp;  lines: +4 -1
Incremental Code Added.
----------------------------
revision 1.73
date: 2006/05/22 20:47:45;  author: tswift;  state: Exp;  lines: +2 -1

Prolog code for unify_with_occur_check

In addition, fixed bug in batched evaluation that I believe is of long standing.

In the batched fixed point, a subgoal S may be checked for fixed
point even if it has been completed and its answer return lists
have been reclaimed.  This doesn't usually happen but can if S is
the leader of the ASCC.  In such a case, the fixed point check
traverses each consumer choice point for S and determines whether
all answers have been returned to the choice point.  However, if
the answer return list for S has been reclaimed and its space
reused, the fixpoint check may mistakenly think that an answer
has not been returned to the choice point -- a dangerous situation.

The fix is simple -- a check for reclamation of the subgoal.  The
check will also be made for local evaluation, even though it
won't be needed there.
----------------------------
revision 1.72
date: 2006/04/27 01:05:26;  author: tswift;  state: Exp;  lines: +5 -2

Changed structure of retractall as called with non-open terms --
i.e. when a gen_retractall is NOT called.  The basic change was
to factor out the potentially expensive marking and unmarking
operations outside of the retract and to call them as builtins
before and after the retract itself.

Changes for code cleanup (db_remove_prref changed to db_abolish0).

Associated changes were also made to the test suite.
----------------------------
revision 1.71
date: 2006/01/27 17:50:16;  author: dwarren;  state: Exp;  lines: +15 -1
Added a new instruction to implement unary tests that don't change
the XWAM state.  Examples are integer/1, atom/1, etc.  The compiler
is changed to use these instructions to avoid laying down a choicepoint
in a conditional, and they are used for regular inline calls.
----------------------------
revision 1.70
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +2 -8
Added string table garbage collection.
----------------------------
revision 1.69
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +3 -2


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.68
date: 2005/11/07 20:55:41;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed (for now) abolish_table_call to check for table (note: NOT table-call)
to be in use, and if not, to delete the table-call and reclaim the space.
This fixes a memory leak.
(And added an xwam_stat builtin, to support better debugging from the
Prolog side.  Extensible.)
----------------------------
revision 1.67
date: 2005/09/29 15:35:25;  author: dwarren;  state: Exp;  lines: +2 -1
Added new builtin trie_assert_hdr_info to return needed pointers.
Gets 2 values.  Used to replace old buff_word calls.
----------------------------
revision 1.66
date: 2005/09/01 18:37:06;  author: tswift;  state: Exp;  lines: +6 -1


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.65
date: 2005/08/15 20:55:40;  author: crojo;  state: Exp;  lines: +4 -3

added a new builtin, #188, float_op/10, to be used to circumvent excessive heap usage by floating point operations. Documentation for it is soon to come.
----------------------------
revision 1.64
date: 2005/08/08 17:11:30;  author: dwarren;  state: Exp;  lines: +4 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.63
date: 2005/08/06 16:29:54;  author: tswift;  state: Exp;  lines: +3 -4

Added check of Choice point stack to abolish_all_tables to ensure that it contains no choice points for completed tables.  Also, added some stubs for gc_clauses.
----------------------------
revision 1.62
date: 2004/09/02 19:48:51;  author: tswift;  state: Exp;  lines: +1 -2

1) added ISO predicates peek_char/1,2 peek_code/1,2, at_end_of_stream/1,2
set_stream_position/2

2) A bit of code cleanup by fixing print_openfiles.

3) Fixed error in spawning processes intro'd by new stream stuff.

4) Revised I/O documentation (more to come).
----------------------------
revision 1.61
date: 2004/08/24 20:41:09;  author: tswift;  state: Exp;  lines: +8 -4

This is a pre-integration of certain parts of the MT engine so that I can run the mttests
in single-threaded mode under 2.6.  This basically defines some stubs so that I can compile and so
that I dont get undefined errors, and won't affect anything anybody is doing.
----------------------------
revision 1.60
date: 2004/08/19 22:15:24;  author: tswift;  state: Exp;  lines: +2 -1

Changes for streams.  Here's hoping...
----------------------------
revision 1.59
date: 2004/04/09 21:03:05;  author: dwarren;  state: Exp;  lines: +2 -1
Added 1) print_xsb_backtrace and 2) build_xsb_backtrace functions to 1) print
out the predicates on the forward continuation and the backward continuation
and 2) to build a list of these psc pointers to return to Prolog.
If xsb was not started with the -p option, then the backward continuation
is always empty.  Without the -p option, the predicate names returned as the
forward continuation are gotten from the psc pointers in the calls on the
forward continuation (so it is a weird collection of containing predicates,
given last-call optimization.)  With the -p option, it contains all the
predicates on the forward continuation (assuming their names are found),
as well as the calls (when they add new information.) This is clearly just
an approximation, but might help find where, in the Prolog context, bad
things happen.
----------------------------
revision 1.58
date: 2004/04/09 00:05:31;  author: dwarren;  state: Exp;  lines: +3 -2
Add code to print out backtrace (forward and backward continuations)
----------------------------
revision 1.57
date: 2004/01/14 20:27:12;  author: dwarren;  state: Exp;  lines: +4 -1
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.56
date: 2003/11/11 19:40:25;  author: dwarren;  state: Exp;  lines: +2 -1
Added new sorting predicate: parsort, which takes a more complicated
sorting specification and supports ascending, descending sort on
subfileds of terms.  It generalizes both sort and keysort (which have
not been changed.)  See manual1 (comparison) for details.
----------------------------
revision 1.55
date: 2003/10/17 21:23:21;  author: dwarren;  state: Exp;  lines: +2 -1
Added ability to get the last ClRef of a dynamic predicate.  Allows
access to end of a log, for retracting for undo.
----------------------------
revision 1.54
date: 2003/07/30 17:44:22;  author: dwarren;  state: Exp;  lines: +2 -1
Added new builtin in machine: term_new_mod(+Mod,+Term,-TermInMod), which
creates a term whose main functor symbol has the same name and arity as
Term, but is in module Mod, and the arguments are the arguments of Term.
The new functor symbol is assumed to be a predicate, and set to be imported
from Mod, if it's not already loaded.  We may want another parameter if we
want to build function symbols, and not predicates, in the new module.
----------------------------
revision 1.53
date: 2003/07/01 14:34:14;  author: lfcastro;  state: Exp;  lines: +2 -1
* New global variable
* New builtin globalvar/1, which returns THE global variable
----------------------------
revision 1.52
date: 2003/06/18 16:51:15;  author: lfcastro;  state: Exp;  lines: +2 -1
branches:  1.52.2;
* New builtin: abolish_module_tables(+ModuleName)

  abolishes all tables for predicates defined in module
  ModuleName. abolish_module_tables(usermod) abolishes tables in
  usermod that are not defined in other modules.

  Requires that all predicate PSCs point to their modules through
  their 'data' field.
----------------------------
revision 1.51
date: 2003/06/18 15:29:59;  author: lfcastro;  state: Exp;  lines: +1 -2
* remove predicate_module/3 since its functionality is provided by
  current_predicate(Module:predicate/arity) from curr_sym.
----------------------------
revision 1.50
date: 2003/06/18 13:41:19;  author: lfcastro;  state: Exp;  lines: +2 -1
* New builtin: predicate_module(+Name,+Arity,-ModuleList) returns the
  list of mofules in which Name/Arity is defined/imported.
----------------------------
revision 1.49
date: 2003/04/02 19:42:41;  author: lfcastro;  state: Exp;  lines: +2 -1
* New builtin: walltime(-X) returns the (wall clock) time since
  execution started (or since statistics(0) was last called).
----------------------------
revision 1.48
date: 2003/03/03 20:54:57;  author: lfcastro;  state: Exp;  lines: +3 -1
* (EXPERIMENTAL) Preliminary introduction of a get_date/5 builtin.
----------------------------
revision 1.47
date: 2002/11/05 20:50:37;  author: lfcastro;  state: Exp;  lines: +2 -2
* First cut at an implementation for abolish_table_call/1.
  - at this point, this call deletes all subsuming tables of a given
  term, via backtracking; what is the desired semantics?

*** WARNING ***
This is not a "safe" operator. It does not perform any kind of
checking, so one may, in fact, delete a table which is in use. This
may cause undefined behavior (i.e. segmentation faults and the like).
----------------------------
revision 1.46
date: 2002/08/19 15:40:24;  author: tswift;  state: Exp;  lines: +5 -1
Added a math builtin, pow/3, to support clpqr.
----------------------------
revision 1.45
date: 2002/05/20 17:47:09;  author: tswift;  state: Exp;  lines: +35 -1
branches:  1.45.2;

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.44
date: 2002/03/13 22:40:13;  author: lfcastro;  state: Exp;  lines: +2 -1
* first step in implementing demand
- new (experimental) primitive: demand_once/1
- executes query and, after first answer is returned, deletes all
consumers created during execution; further, any tables created are
also destroyed
----------------------------
revision 1.43
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -2
* Removal of Chat engine
----------------------------
revision 1.42
date: 2002/01/03 23:57:48;  author: tswift;  state: Exp;  lines: +4 -1
branches:  1.42.2;
ifdef-able builtins added for interprolog
----------------------------
revision 1.41
date: 2001/12/29 06:28:15;  author: kifer;  state: Exp;  lines: +1 -3
took out the redundant floating point ops ceil/2, floor/2, etc.
----------------------------
revision 1.40
date: 2001/12/24 00:55:54;  author: kifer;  state: Exp;  lines: +3 -1
added floating point ops round/2, ceil/2, floor/2.
----------------------------
revision 1.39
date: 2001/08/13 04:31:35;  author: kifer;  state: Exp;  lines: +3 -1
added builtin to optimize the storage.P module
----------------------------
revision 1.38
date: 2001/06/29 22:50:48;  author: kifer;  state: Exp;  lines: +3 -3
replaced flora with flora2 in the build
added str_match.
----------------------------
revision 1.37
date: 2001/03/28 08:56:35;  author: kifer;  state: Exp;  lines: +5 -1
sped up conget/conset making them into builtins
----------------------------
revision 1.36
date: 2001/03/26 04:59:02;  author: kifer;  state: Exp;  lines: +1 -2
got rid of the FILE_STAT builtin, replaced with the one in system_xsb.c
Added more path_sysop goodies.
----------------------------
revision 1.35
date: 2000/12/08 17:26:46;  author: ejohnson;  state: Exp;  lines: +2 -1
Altered the manner in which the truth of negated subsumptive
predicates are evaluated.  Originally I relied upon the interpretive
timestamp-based relevant-answer collection function, but this requires
the Time Stamp Indices to be present in the TST.  If the producer has
completed before the collection, then these structures would have
already been be reclaimed.

The new approach checks for a relevant answer using the
trie_get_return/2 builtin.  If one is found, then the literal can be
failed.  Otherwise, the producer must be checked for completion and
whether the negative-delay flag has been set.  This is performed
through a new builtin, lrd_success/2.  Therefore, slg_not/1 is restored
for handling variant tabled predicates only.
----------------------------
revision 1.34
date: 2000/12/04 17:10:42;  author: ejohnson;  state: Exp;  lines: +2 -2
Added support for subsumption-based LRD stratified negation,
including:

o Modification of 't not'/1 to accept all predicates.

o Replacement of predicate get_producer_subgoal_frame/2 with a new
  predicate get_producer_call/3 (ala get_call/3 and friends) to take
  the subgoal and perform a tabling-strategy-dependent lookup,
  returning a producer's subgoal frame and an answer template with
  respect to that producer.

  get_producer_call/3 aborts if given a non-tabled predicate and fails
  if the tabled predicate hasn't been called before.

o Modification of slg_not/1 s.t. it takes two extra arguments: the
  first is the answer template from get_producer_call/3, used by
  negated, properly subsumed predicates for relevant-answer
  collection; the second contains the subgoal which is negated, used
  only for error reporting.

o Extension of certain C functions, e.g. get_variant_sf() and
  get_subsumer_sf() to build and return, in an extra argument, the
  answer template.
----------------------------
revision 1.33
date: 2000/09/28 21:31:02;  author: ejohnson;  state: Exp;  lines: +2 -2
branches:  1.33.2;
Two subsumption-related changes:

(1) Support for incomplete subsumptive subgoals in tfindall/3.
    Two builtins needed modification:
    -- get_subgoal_ptr/2 ==> get_producer_subgoal_frame/2
         Now handles both variant and subsumptive subgoals, returning
	 the producing table entry.
    -- is_incomplete/4 ==> is_incomplete/2
         Now handles both variant and subsumptive subgoals.  Used to
	 encompass some of the functionality of get_subgoal_ptr/2, but
	 since the processing performed by that builtin is more complex,
	 this (partial) functionality is removed.

(2) Standard predicate delete_return/2 produces an error when invoked
    on a subsumptive table entry.
----------------------------
revision 1.32
date: 2000/08/05 07:59:23;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Introduced a new inline builtin: is_attv/1.
----------------------------
revision 1.31
date: 2000/07/31 20:27:54;  author: ejohnson;  state: Exp;  lines: +2 -2
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.30
date: 2000/06/14 21:16:04;  author: kifer;  state: Exp;  lines: +2 -1
Added builtin stub for reclaim_uninterned_nr/trie_reclaim_uninterned_nr.
----------------------------
revision 1.29
date: 2000/04/05 17:42:02;  author: cbaoqiu;  state: Exp;  lines: +3 -1
Added a new builtin WH_RANDOM (53) for random number generator.
----------------------------
revision 1.28
date: 2000/03/01 16:22:33;  author: dwarren;  state: Exp;  lines: +3 -1
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.27
date: 2000/02/22 14:54:15;  author: tswift;  state: Exp;  lines: +5 -1

Changes to integrate catch/throw.  Builtins are presently in the module
standard, but are not automatically imported by the interpreter level.  (I'll
do this after we all kick the predicates around a little).
----------------------------
revision 1.26
date: 1999/12/14 20:41:49;  author: ejohnson;  state: Exp;  lines: +3 -3
get_call/3 rewritten as a builtin, which made the builtin
construct_ret_for_call/1 expendable.  It was only used in support
of get_call/3.

Arity of get_lastnode_cs_retskel changed from 3 to 4.  The extra
argument contains the original call for computing the answer template
for a properly subsumed subgoal.

Note that the builtin code TRIE_GET_CALL is now used for get_call/3,
while that for get_calls/1, which originally used TRIE_GET_CALL, is
changed to TRIE_UNIFY_CALL.
----------------------------
revision 1.25
date: 1999/12/12 03:27:36;  author: kifer;  state: Exp;  lines: +2 -2
removed copy_term0, only copy_term is left.
----------------------------
revision 1.24
date: 1999/10/19 20:11:46;  author: ejohnson;  state: Exp;  lines: +2 -2
Addition of variant/1 to XSB to complement subsumptive/1.
Each one changes the tabled evaluation method of the given
predicate(s).

Modified the structure of related constants to utilize the
preprocessor on the Prolog end.  The builtin which actually makes the
change in the TableInfoFrame is generalized from only making the
switch to subsumptive mode to taking an extra argument indicating the
method to use during the predicate's evaluation.
----------------------------
revision 1.23
date: 1999/10/09 02:00:21;  author: cbaoqiu;  state: Exp;  lines: +6 -1
Changes for attributed variables (first step).
----------------------------
revision 1.22
date: 1999/10/08 07:33:47;  author: kifer;  state: Exp;  lines: +3 -1
added substring, string_substitute
----------------------------
revision 1.21
date: 1999/09/25 16:34:24;  author: kifer;  state: Exp;  lines: +2 -1
Implemented atom/number_chars correctly. Added number digits.
----------------------------
revision 1.20
date: 1999/08/30 16:40:48;  author: kostis;  state: Exp;  lines: +2 -2
Clean up and simplification changes in various builtins and in their use.
----------------------------
revision 1.19
date: 1999/08/28 09:49:06;  author: kostis;  state: Exp;  lines: +2 -1
Introduced psc_set_spy/2 buitlin predicate to avoid ugliness in Prolog.
----------------------------
revision 1.18
date: 1999/08/28 07:54:17;  author: kostis;  state: Exp;  lines: +3 -1
Added new builtins in C that manipulate file names and used them in
consult.P to implement search_module/7.  Should be cleaner and faster
now.
----------------------------
revision 1.17
date: 1999/08/19 15:08:31;  author: kifer;  state: Exp;  lines: +3 -1
added segfault_handler/1
----------------------------
revision 1.16
date: 1999/08/18 12:31:29;  author: kostis;  state: Exp;  lines: +3 -4
Predicate ground/1 made a direct builtin.  Also some unused (and most
probably non-working) builtins taken out.  Small change in xpathname.c.
----------------------------
revision 1.15
date: 1999/08/17 19:30:06;  author: warren;  state: Exp;  lines: +2 -1
convert dynamic P/A to dynamic p(_,_,..), added new builtin
is_most_general_term to return true if given a term with all distinct
variables as subfields.
----------------------------
revision 1.14
date: 1999/08/14 16:41:43;  author: kostis;  state: Exp;  lines: +4 -4
Eliminated obsolete and unused builtins; fixed name and arity
inconsistencies in the definition of builtins.
----------------------------
revision 1.13
date: 1999/08/09 00:34:14;  author: kifer;  state: Exp;  lines: +1 -5
Added process control builtins, deprecated unix.P,
added C preprocessor.
----------------------------
revision 1.12
date: 1999/08/04 14:41:50;  author: ejohnson;  state: Exp;  lines: +3 -1
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.11
date: 1999/07/27 14:55:24;  author: kifer;  state: Exp;  lines: +1 -2
eliminated str_insert, because it duplicates intern_string.
----------------------------
revision 1.10
date: 1999/06/17 07:50:58;  author: kifer;  state: Exp;  lines: +2 -1
Added a new builtin: is_charlist/1 and /2
----------------------------
revision 1.9
date: 1999/05/06 16:01:19;  author: unova;  state: Exp;  lines: +2 -1
Implemented reclaim_space and fixed a bad bug on retract_nr.
----------------------------
revision 1.8
date: 1999/04/27 14:39:42;  author: kifer;  state: Exp;  lines: +3 -1
Made large builtins in the former std_pred.i into inlined subroutines.
Added atom_codes, number_codes and made atom_chars, number_chars into
synonyms to the *_codes builtins.
----------------------------
revision 1.7
date: 1999/04/13 17:24:46;  author: kostis;  state: Exp;  lines: +35 -46
Performed major clean-up and rationalization of the tabling builtins.
----------------------------
revision 1.6
date: 1999/04/04 03:54:47;  author: kifer;  state: Exp;  lines: +2 -2
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.5
date: 1999/04/02 03:48:03;  author: kifer;  state: Exp;  lines: +7 -1
Introduced private_builtin/11
----------------------------
revision 1.4
date: 1999/04/01 05:03:09;  author: kifer;  state: Exp;  lines: +7 -10
Replaced fmt_ builtins with formatted_io().
The fmt_* builtins now hang off of that.
----------------------------
revision 1.3
date: 1999/03/30 16:25:19;  author: kifer;  state: Exp;  lines: +1 -8
Changes associated with moving file_open/close/put/get,
fmt_read/write, etc. to file_io. Unifying the builtins
file_open/close/put/get with file_flush/seek/truncate
under a single builtin file_function.
----------------------------
revision 1.2
date: 1999/03/27 09:33:05;  author: workflow;  state: Exp;  lines: +2 -1

additional file functions and is_deleted(X) macro defn fixes
----------------------------
revision 1.1
date: 1999/03/17 18:34:43;  author: kostis;  state: Exp;
Changes to separate out all builtin #defines from "inst.h" and have them
appear in a new file called "builtin.h".
----------------------------
revision 1.33.2.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.33.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +3 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.42.2.2
date: 2004/10/18 20:45:56;  author: ruim;  state: Exp;  lines: +42 -2
update for version 2.6.1
----------------------------
revision 1.42.2.1
date: 2004/09/29 19:43:54;  author: ruim;  state: Exp;  lines: +7 -2
Sources from rfm repository
----------------------------
revision 1.45.2.6
date: 2003/04/17 17:11:53;  author: lfcastro;  state: Exp;  lines: +5 -2
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.45.2.5
date: 2002/11/01 22:38:27;  author: lfcastro;  state: Exp;  lines: +1 -1
* Use approximate pruning when cutting (only when DEMAND is enabled)
----------------------------
revision 1.45.2.4
date: 2002/08/29 14:17:12;  author: lfcastro;  state: Exp;  lines: +4 -0
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.45.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +3 -0
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.45.2.2
date: 2002/08/07 17:53:34;  author: lfcastro;  state: Exp;  lines: +1 -4
* update to HEAD
----------------------------
revision 1.45.2.1
date: 2002/08/07 17:41:37;  author: lfcastro;  state: Exp;  lines: +4 -1
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.52.2.1
date: 2003/09/11 13:48:09;  author: tschrijvers;  state: Exp;  lines: +3 -1
Changed the emulator in the following way:
- term_new_mod/3 builtin from to copy a term
  to a term in a different module
- globalvar builtin that provides one global variable
- changed behavior of get_attributes and put_attributes:
  attribute value can be anything, not just a vector
- replace pre-unification interrupt handling of attributed variables
  to post-unification handling
----------------------------
revision 1.92.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.92.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +1 -0
no message
----------------------------
revision 1.92.2.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/call_graph_xsb.c,v
Working file: call_graph_xsb.c
head: 1.32
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.20
	ROLLBACK: 1.15
	latest_plus_supp_branch: 1.15.0.2
	latest_plus_supp: 1.15
	Version_3dot2_plus_supp: 1.12.0.2
	Version_3dot2: 1.12
	dec07-perf-results: 1.11
	mt_thesis: 1.7
keyword substitution: kv
total revisions: 35;	selected revisions: 35
description:
----------------------------
revision 1.32
date: 2012/04/04 21:16:45;  author: tswift;  state: Exp;  lines: +8 -6

Fix to not incrementally update tables that depend on a table for
which there are active choice points (visitors).

Also, made some warnings and errors easier to relate back to the
actual function that called them.
----------------------------
revision 1.31
date: 2012/03/19 15:19:59;  author: dwarren;  state: Exp;  lines: +1 -1
Fixed a couple of declarations, not at the beginning of blocks.
Added some casts to quiet MSVC.
Conditioned the inline declarations of prolog_call0 and prolog_code_call,
which can't be external in MSVC.
----------------------------
revision 1.30
date: 2012/03/16 22:10:30;  author: tswift;  state: Exp;  lines: +2 -2

Took out debug statement.
----------------------------
revision 1.29
date: 2012/03/16 19:37:28;  author: tswift;  state: Exp;  lines: +14 -13

Changes for better error reporting, checks for incrementally tabled
predicates, and renaming of functions.
----------------------------
revision 1.28
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +170 -41

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.27
date: 2012/03/07 17:28:42;  author: tswift;  state: Exp;  lines: +2 -2

Fix for MT compilation (how did that problem get in there?) + change
to throw error when we can't update an incremental table.
----------------------------
revision 1.26
date: 2012/03/01 21:26:49;  author: tswift;  state: Exp;  lines: +81 -73

Some documentation updates, changes to more meaningful names, and the
start of a function that might be used in lazy incremental tabling.
----------------------------
revision 1.25
date: 2012/02/19 19:17:55;  author: tswift;  state: Exp;  lines: +36 -5

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.24
date: 2011/04/17 16:57:12;  author: tswift;  state: Exp;  lines: +6 -6

Added some thread context declarations so that things keep compiling
for the MT engine.  Incremental tabling doesnt yet work for the MT
engine, but its not bad for the functions to have the thread contexts
anyway.
----------------------------
revision 1.23
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +9 -12

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.22
date: 2011/04/16 18:01:35;  author: tswift;  state: Exp;  lines: +6 -2

Change to allow subtyping in table errors and change to dfs() to use typed table errors.
----------------------------
revision 1.21
date: 2011/04/12 17:31:59;  author: tswift;  state: Exp;  lines: +45 -47

Fix of abolishing incremental tables when the affected list is
non-empty -- it needed to be re-initialized to null.  In addition, the
changed list also needs to be initted and reinitialized to null, but
this is accessed less often so we haven't yet seen that problem arise.

I also changed the name of the global variables for incremental
tabling to make them more obvious -- names like "changed" and
"affected" arent good.
----------------------------
revision 1.20
date: 2010/09/06 18:34:22;  author: tswift;  state: Exp;  lines: +2 -2

Changed a warning to an error for invalidating an incomplete table,
and made the message more descriptive.
----------------------------
revision 1.19
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.18
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.17
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.15
date: 2010/04/24 20:50:42;  author: tswift;  state: Exp;  lines: +4 -7
branches:  1.15.2;

Changes for incremental tabling based on tries.
----------------------------
revision 1.14
date: 2010/02/20 23:26:33;  author: evansbj;  state: Exp;  lines: +1 -2
Removed a weird little extraneous 'term' variable ...
----------------------------
revision 1.13
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +1 -1

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.12
date: 2008/07/09 18:05:54;  author: dwarren;  state: Exp;  lines: +7 -6
Fixed a bug in create_call_list if stack reallocation takes place.  Have to
preserve actual address across the possible reallocation, and cannot do
relative addressing (i.e., offset from hreg.)
----------------------------
revision 1.11
date: 2007/08/09 04:09:48;  author: evansbj;  state: Exp;  lines: +0 -1
Removed a duplicate #include "cell_xsb.h"
----------------------------
revision 1.10
date: 2007/08/08 17:50:49;  author: dwarren;  state: Exp;  lines: +1 -0
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.9
date: 2007/06/01 22:47:05;  author: tswift;  state: Exp;  lines: +1 -1

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.8
date: 2007/02/09 18:12:16;  author: dwarren;  state: Exp;  lines: +7 -1
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.7
date: 2006/10/16 21:43:15;  author: dwarren;  state: Exp;  lines: +2 -2
Hadn't tested recent changes with multi-threaded.  Shame on me.
Add CTXT as necessary.
----------------------------
revision 1.6
date: 2006/10/13 20:58:42;  author: dwarren;  state: Exp;  lines: +43 -22
All changes for incremental table maintenance:
1. Added filter in call to get changed_goals, so can avoid building huge
   lists of goals that subsequently get ignored.
2. Freed hashtables used in incr when doing abolish all tables.  Closes
   a potentially bad memory leak.
3. Eliminated freekey's call to mem_dealloc.  Turns out we are not allocating
   space for keys at all in hashtables...
----------------------------
revision 1.5
date: 2006/10/11 21:06:22;  author: dwarren;  state: Exp;  lines: +49 -50
Change way terms are copied in creating incr lists of changed terms,
so that the heap is in a valid state if (when) glstack_realloc and
gc_heap might be called.  Avoids segfault in gc_heap.
----------------------------
revision 1.4
date: 2006/09/20 15:01:25;  author: tswift;  state: Exp;  lines: +9 -9

added typedef for KEY in tries.h and changed occurrences of "struct key" in call_graph_xsb.c to KEY.
----------------------------
revision 1.3
date: 2006/09/14 16:13:55;  author: crojo;  state: Exp;  lines: +947 -947
Added two new routines to the C interface:

pipe_xsb_stdin()
  This splits XSB's stdin stream into a read end and a
  write end. The read end takes the place of the original stdin, and
  the write end is accessable through a call to write_to_xsb_stdin,
  another c interface routine. These two calls can be used to pass
  input to a thread running xsb.dll code that is blocking waiting for
  input from stdin. They allow separate threads to interact with the
  interpreter or the trace debugger when xsb is loaded as a DLL.

writeln_to_xsb_stdin(char *)
  This can be called after a call to  pipe_xsb_stdin, and writes a string
  of characters to the write end of xsb's piped stdin stream. If a thread
  running xsb.dll code is blocking on input from stdin, this will unblock
  it.

I've modified the way output is redirected to files on WIN_NT when XSB
is initialized through the C interface. The output files are now sharable.
I've also changed the spacing in call_graph_xsb.c to fix compilation problems
on windows.
----------------------------
revision 1.2
date: 2006/09/06 16:05:05;  author: diptikalyan;  state: Exp;  lines: +1 -1
Incremental Bug fixed.
----------------------------
revision 1.1
date: 2006/09/06 05:15:26;  author: diptikalyan;  state: Exp;
Incremental Code Added.
----------------------------
revision 1.15.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.15.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.15.2.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/call_graph_xsb.h,v
Working file: call_graph_xsb.h
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
----------------------------
revision 1.14
date: 2012/03/16 19:37:28;  author: tswift;  state: Exp;  lines: +2 -2

Changes for better error reporting, checks for incrementally tabled
predicates, and renaming of functions.
----------------------------
revision 1.13
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +3 -1

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.12
date: 2012/03/01 21:26:49;  author: tswift;  state: Exp;  lines: +3 -3

Some documentation updates, changes to more meaningful names, and the
start of a function that might be used in lazy incremental tabling.
----------------------------
revision 1.11
date: 2011/04/17 16:57:12;  author: tswift;  state: Exp;  lines: +1 -1

Added some thread context declarations so that things keep compiling
for the MT engine.  Incremental tabling doesnt yet work for the MT
engine, but its not bad for the functions to have the thread contexts
anyway.
----------------------------
revision 1.10
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +2 -3

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.9
date: 2011/04/12 17:31:59;  author: tswift;  state: Exp;  lines: +13 -9

Fix of abolishing incremental tables when the affected list is
non-empty -- it needed to be re-initialized to null.  In addition, the
changed list also needs to be initted and reinitialized to null, but
this is accessed less often so we haven't yet seen that problem arise.

I also changed the name of the global variables for incremental
tabling to make them more obvious -- names like "changed" and
"affected" arent good.
----------------------------
revision 1.8
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2006/10/16 21:43:15;  author: dwarren;  state: Exp;  lines: +1 -1
branches:  1.4.4;
Hadn't tested recent changes with multi-threaded.  Shame on me.
Add CTXT as necessary.
----------------------------
revision 1.3
date: 2006/10/13 20:58:42;  author: dwarren;  state: Exp;  lines: +2 -1
All changes for incremental table maintenance:
1. Added filter in call to get changed_goals, so can avoid building huge
   lists of goals that subsequently get ignored.
2. Freed hashtables used in incr when doing abolish all tables.  Closes
   a potentially bad memory leak.
3. Eliminated freekey's call to mem_dealloc.  Turns out we are not allocating
   space for keys at all in hashtables...
----------------------------
revision 1.2
date: 2006/10/06 20:04:28;  author: dwarren;  state: Exp;  lines: +58 -65
Updated memory management in hashtable (which manages hashing for incremental
table maintenance.)  It now uses XSB mem_alloc and friends, and there is a new
space type of INCR_TABLE_SPACE.  It is included in SLG Table space in statistics
and is also broken out (if nonzero).
And doing that showed a huge amount of unused space due to many large hashtables
when there's only one edge.  So I changed the minimum size of initial hashtables
(they are automatically expanded if necessary.)  [It reduced incr space usage in
my DSS example from about 340M to 8M... much!! better.]
----------------------------
revision 1.1
date: 2006/09/06 05:15:26;  author: diptikalyan;  state: Exp;
Incremental Code Added.
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/call_xsb_i.h,v
Working file: call_xsb_i.h
head: 1.18
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.16
	ROLLBACK: 1.11
	latest_plus_supp_branch: 1.11.0.4
	latest_plus_supp: 1.11
	Version_3dot2_plus_supp: 1.11.0.2
	release_2_6_plus_supp: 1.6.0.4
	Version_3dot2: 1.11
	dec07-perf-results: 1.11
	mt_thesis: 1.10
	release_3_0: 1.10
	release_2_7_0: 1.7
	multi-threaded-26-engine: 1.4.6.2
	pre-mt: 1.7
	multi-threaded-25-engine-done: 1.4.6.1
	multi-threaded-25-engine: 1.4.0.6
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.2
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.4
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.2
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.2
keyword substitution: kv
total revisions: 28;	selected revisions: 28
description:
----------------------------
revision 1.18
date: 2012/03/19 15:19:59;  author: dwarren;  state: Exp;  lines: +9 -3
Fixed a couple of declarations, not at the beginning of blocks.
Added some casts to quiet MSVC.
Conditioned the inline declarations of prolog_call0 and prolog_code_call,
which can't be external in MSVC.
----------------------------
revision 1.17
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +3 -3

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.16
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.15
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.14
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2007/06/10 18:43:57;  author: tswift;  state: Exp;  lines: +3 -3
branches:  1.11.4;

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.10
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +2 -2


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.9
date: 2005/11/07 20:53:03;  author: dwarren;  state: Exp;  lines: +7 -33
Slight cleanup of calling code.
----------------------------
revision 1.8
date: 2005/01/14 18:30:52;  author: ruim;  state: Exp;  lines: +5 -5
Integration of multithreaded system
----------------------------
revision 1.7
date: 2004/08/13 13:27:12;  author: dwarren;  state: Exp;  lines: +4 -2
Added short-circuit for code_call to 'true'.
----------------------------
revision 1.6
date: 2002/11/05 20:50:37;  author: lfcastro;  state: Exp;  lines: +4 -1
* First cut at an implementation for abolish_table_call/1.
  - at this point, this call deletes all subsuming tables of a given
  term, via backtracking; what is the desired semantics?

*** WARNING ***
This is not a "safe" operator. It does not perform any kind of
checking, so one may, in fact, delete a table which is in use. This
may cause undefined behavior (i.e. segmentation faults and the like).
----------------------------
revision 1.5
date: 2002/08/15 17:00:26;  author: lfcastro;  state: Exp;  lines: +2 -2
* interrupt handling (minor) cleanup:
  removed unnecessary argument to synint_proc & default_inthandler
----------------------------
revision 1.4
date: 2001/11/08 21:35:25;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.4.4;  1.4.6;
Eliminated the indirection of *asynint_ptr and to directly use
asynint_val.  (Also a minor bug-fix in ptoc_longstring.)
----------------------------
revision 1.3
date: 2001/11/07 21:08:00;  author: dwarren;  state: Exp;  lines: +2 -2
I modified slightly the way interrupts are handled.  There had been a
couple of mechanisms, and I tried to consolidate them. I elimitaed
call_intercept and merged it in with *asynint_ptr. Now the keyboard
interrupt can be used for C-user-defined interrupts.  There is a new
variable asynint_code that can be set when an interrupt is signaled.
It is set to 0 by the system signal catcher.  To generate a
user-defined interrupt, you need to set the KEYINT_MARK bit of
*asynint_ptr and set asynint_code to your integer code.  Then when
this interrupt is fielded, it will call the keyboard interrupt handler
(set by set_inthandler imported from loader) which is a two argument
predicate.  When it is called, the first argument will be the goal to
call when continuing out of the interrupt; the second argument will be
the value of asynint_code.
----------------------------
revision 1.2
date: 2000/05/25 23:37:25;  author: cbaoqiu;  state: Exp;  lines: +2 -2
branches:  1.2.2;
Changed file name in the header.
----------------------------
revision 1.1
date: 2000/05/25 23:24:53;  author: kifer;  state: Exp;
made call0 and call_code into inlined functions.
----------------------------
revision 1.2.2.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +9 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.6.2
date: 2004/10/18 20:45:57;  author: ruim;  state: Exp;  lines: +5 -2
update for version 2.6.1
----------------------------
revision 1.4.6.1
date: 2004/09/29 19:43:54;  author: ruim;  state: Exp;  lines: +5 -5
Sources from rfm repository
----------------------------
revision 1.4.4.3
date: 2003/04/17 17:11:53;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.4.4.2
date: 2002/08/28 19:20:26;  author: lfcastro;  state: Exp;  lines: +1 -1
* FIXED problem in once/1 when there are no choicepoints under its
  scope
* MERGED patch from HEAD that fixes bug in interrupt handling (& attv)
* INCLUDED test predicate for demand & negation
----------------------------
revision 1.4.4.1
date: 2002/08/10 00:19:33;  author: lfcastro;  state: Exp;  lines: +4 -1
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.11.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.11.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.11.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/cc.h,v
Working file: cc.h
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	release-2-1: 1.2
	release-2-0-1: 1.2
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.3
date: 1999/12/05 01:27:38;  author: kifer;  state: dead;  lines: +1 -1
this is an old version of cinterf.h, which is no longer used.
----------------------------
revision 1.2
date: 1999/05/03 00:54:18;  author: luis;  state: Exp;  lines: +13 -11
* changes regarding exporting functions under Windows
----------------------------
revision 1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/cell.h,v
Working file: cell.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.7
	without-attv: 1.6
	release-2-0: 1.4
	pre-release-2-0: 1.4
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.8
date: 1999/10/26 06:46:47;  author: kifer;  state: dead;  lines: +1 -1
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.7
date: 1999/10/09 02:00:21;  author: cbaoqiu;  state: Exp;  lines: +4 -1
Changes for attributed variables (first step).
----------------------------
revision 1.6
date: 1999/08/09 00:34:15;  author: kifer;  state: Exp;  lines: +2 -10
Added process control builtins, deprecated unix.P,
added C preprocessor.
----------------------------
revision 1.5
date: 1999/07/06 16:35:06;  author: ejohnson;  state: Exp;  lines: +2 -1
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.4
date: 1999/04/22 07:30:38;  author: kifer;  state: Exp;  lines: +5 -4
Made LINUX_ELF use big mem.
----------------------------
revision 1.3
date: 1999/04/17 16:44:04;  author: kostis;  state: Exp;  lines: +8 -20
Changes necessary for HP machines.
----------------------------
revision 1.2
date: 1999/03/04 06:49:42;  author: cbaoqiu;  state: Exp;  lines: +4 -1
Introduced new macros `makeaddr' and `addr_val', and changed some
`makeint' to `makeaddr' and `int_val' to `addr_val'.
----------------------------
revision 1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:12;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/cell_def_xsb.h,v
Working file: cell_def_xsb.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.10
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	release_2_6_plus_supp: 1.3.0.8
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.5
	release_3_0: 1.5
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.3.6.1
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.3.6.1
	multi-threaded-25-engine: 1.3.0.6
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.4
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.2
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.6
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
----------------------------
revision 1.11
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +7 -1
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.10
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.9
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2005/07/18 21:54:08;  author: crojo;  state: Exp;  lines: +3 -1
branches:  1.5.4;
*** empty log message ***
----------------------------
revision 1.4
date: 2005/01/14 18:30:52;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.3
date: 2001/12/30 05:57:25;  author: kifer;  state: Exp;  lines: +5 -1
branches:  1.3.6;
applied Massimo Zaniboni (zanibonim) patch
----------------------------
revision 1.2
date: 1999/12/10 07:47:28;  author: kifer;  state: Exp;  lines: +5 -1
branches:  1.2.4;
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.1
date: 1999/11/29 00:30:12;  author: kifer;  state: Exp;
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.2.4.2
date: 2000/12/19 15:58:12;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.4.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +7 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.6.1
date: 2004/09/29 19:43:54;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/cell_xsb.h,v
Working file: cell_xsb.h
head: 1.46
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.40
	ROLLBACK: 1.35
	latest_plus_supp_branch: 1.35.0.4
	latest_plus_supp: 1.35
	Version_3dot2_plus_supp: 1.35.0.2
	release_2_6_plus_supp: 1.15.0.4
	Version_3dot2: 1.35
	dec07-perf-results: 1.29
	mt_thesis: 1.27
	release_3_0: 1.27
	release_2_7_0: 1.17
	multi-threaded-26-engine: 1.13.4.2
	pre-mt: 1.17
	multi-threaded-25-engine-done: 1.13.4.1
	multi-threaded-25-engine: 1.13.0.4
	release_2_6_1: 1.15
	release_2_6_final: 1.15
	release_2_6: 1.15.0.2
	last-merged-to-demand: 1.13
	demand_branch: 1.13.0.2
	before_removing_chat: 1.13
	release_2_5: 1.13
	pre-merge-slgwam-gc: 1.12
	multi-threaded-c-engine: 1.12.0.2
	release_2_4: 1.11
	release_2_3: 1.11
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.9
	release-2-2: 1.7
	chat-and-local: 1.7.0.2
	xsb-pre-cleanup: 1.7
	release-2-1: 1.3
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 55;	selected revisions: 55
description:
----------------------------
revision 1.46
date: 2012/02/18 04:46:54;  author: kifer;  state: Exp;  lines: +3 -1
minated some compiler warnings
added DllExport to find_string, mem_alloc, mem_realloc.
----------------------------
revision 1.45
date: 2011/12/15 21:06:15;  author: kifer;  state: Exp;  lines: +2 -2
moved defining GENERAL_TAGGING from configure.in to emu/cells_xsb.h
It was wrong in configure, since it worked only for Linux kernels 2.6.*.
So, XSB was not being configured correctly for Linuxes 3.*
----------------------------
revision 1.44
date: 2011/08/20 21:36:49;  author: tswift;  state: Exp;  lines: +5 -1

Fixed bug in hash opcode where it was throwing an error when encountering an attv.

Will go through occurrences of isref() to make sure things are attv safe (or at least to triage).
----------------------------
revision 1.43
date: 2011/06/26 21:01:13;  author: tswift;  state: Exp;  lines: +2 -1

Support for C-level trace.
----------------------------
revision 1.42
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +2 -1
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.41
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.40
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.39
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.38
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.37
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.36
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.35
date: 2009/03/14 22:04:47;  author: tswift;  state: Exp;  lines: +4 -4
branches:  1.35.4;

Very minor changes to shut up the compiler.
----------------------------
revision 1.34
date: 2008/07/25 20:56:50;  author: tswift;  state: Exp;  lines: +6 -5

fix so that new fast call checks ! properly -- before I was assuming that ! was read as a structure, while it was being read as a string.  Now its properly handled.
----------------------------
revision 1.33
date: 2008/04/02 23:48:06;  author: tswift;  state: Exp;  lines: +5 -3

Took printf out of emuloop.c -- hopefully unifloat will not be needed much,
but still...

cell_xsb.h -- took out check for load_undef in call_directly.  It
turns out that it wasn't needed.
----------------------------
revision 1.32
date: 2008/03/29 19:14:55;  author: tswift;  state: Exp;  lines: +19 -4

Fixed conversion routines for boxed floats.  However in order to get
boxed floats to work right now, you need to compile with a 32 bit engine.  I'll try to fix that soon.

The test suite runs better now, but not perfectly, so there are still a few things to fix, perhaps in the intersection of tabling and assert.
----------------------------
revision 1.31
date: 2008/02/22 17:10:15;  author: tswift;  state: Exp;  lines: +3 -2
Changes to make call/1 go to the cut transform for load_undef -- possibly not needed.
----------------------------
revision 1.30
date: 2008/02/21 20:57:49;  author: tswift;  state: Exp;  lines: +8 -1

Changes to optimize call/1 for atomic predicates (e.g. not ,/2 ;/2 etc.

Also, tweaked an error message for atom_chars/codes
----------------------------
revision 1.29
date: 2007/08/08 17:50:49;  author: dwarren;  state: Exp;  lines: +2 -4
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.28
date: 2007/08/01 22:19:07;  author: tswift;  state: Exp;  lines: +12 -11

Update so that GENERAL TAGGING is not done with BITS64 -- this seems to make things work (in sequential mode except for floats and a few other things).
----------------------------
revision 1.27
date: 2005/12/17 02:46:32;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed accumulated missing casts.  MSVC compiles it now without complaint.
----------------------------
revision 1.26
date: 2005/11/17 21:46:56;  author: dwarren;  state: Exp;  lines: +10 -11
Changes to try to improve floating point handling for doubles.
There are still some issues with compiled indexes on floats, and
they don't work correctly.
----------------------------
revision 1.25
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +3 -3


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.24
date: 2005/07/22 15:42:13;  author: crojo;  state: Exp;  lines: +12 -12

Made double floating point numbers the default. Single precision floats can be reverted to with the configure option --enable-fast-floats
----------------------------
revision 1.23
date: 2005/07/20 21:54:48;  author: crojo;  state: Exp;  lines: +20 -4

updated optimization level for emuloop.c on cygwin when -mno-cygwin is given.
----------------------------
revision 1.22
date: 2005/07/19 14:16:56;  author: dwarren;  state: Exp;  lines: +1 -12
Fixed problem with bld_boxedfloat with oldfloats in multithreading
----------------------------
revision 1.21
date: 2005/07/18 21:54:08;  author: crojo;  state: Exp;  lines: +116 -38
*** empty log message ***
----------------------------
revision 1.20
date: 2005/02/04 22:26:56;  author: dwarren;  state: Exp;  lines: +21 -54
Throw out very old tagging schemes and map them all to use GENERAL_TAGGING.
----------------------------
revision 1.19
date: 2005/02/04 20:02:14;  author: dwarren;  state: Exp;  lines: +2 -2
Some minor cleanup of general_tagging to improve typing slightly.
It does work with Harpreet's recent linux (but to configure with
general-tagging you have to change ALL the CPFLAGS in emuMakefile,
not just the first one !?%$!?!)
----------------------------
revision 1.18
date: 2005/02/04 16:56:09;  author: dwarren;  state: Exp;  lines: +11 -1
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.17
date: 2004/09/29 21:41:55;  author: dwarren;  state: Exp;  lines: +15 -29
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.16
date: 2004/09/03 19:10:32;  author: dwarren;  state: Exp;  lines: +4 -4
Modified build_backtrace to build a boxed int if the psc address is
too big to cast to a simple Prolog int.  (And added cast in bld_oint
to allow addresses to easily be handled there.)
----------------------------
revision 1.15
date: 2002/10/07 15:20:44;  author: dwarren;  state: Exp;  lines: +2 -2
Updates to Prolog builtins to allow boxedintegers to be handled correctly.
----------------------------
revision 1.14
date: 2002/10/04 20:42:00;  author: lfcastro;  state: Exp;  lines: +12 -9
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.13
date: 2002/01/23 17:08:08;  author: dwarren;  state: Exp;  lines: +30 -1
branches:  1.13.2;  1.13.4;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.12
date: 2001/07/27 13:27:02;  author: dwarren;  state: Exp;  lines: +5 -3
Changed signed shift of addrs to unsigned shift to save one more bit
in addresses, for BIG_MEM tagging.
----------------------------
revision 1.11
date: 2001/02/06 16:56:36;  author: lfcastro;  state: Exp;  lines: +1 -8
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.10
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +10 -1
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.9
date: 2000/05/20 06:55:56;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.9.2;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.8
date: 2000/04/29 21:53:50;  author: kifer;  state: Exp;  lines: +15 -15
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.7
date: 2000/01/11 17:04:12;  author: ejohnson;  state: Exp;  lines: +2 -1
Added #def isconstant().
----------------------------
revision 1.6
date: 2000/01/07 08:51:19;  author: kifer;  state: Exp;  lines: +2 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/12/21 22:56:33;  author: warren;  state: Exp;  lines: +2 -2
cleanup to reduce number of warnings given by MSVC compiler.
----------------------------
revision 1.4
date: 1999/11/29 00:30:12;  author: kifer;  state: Exp;  lines: +4 -3
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.3
date: 1999/11/17 03:54:23;  author: kifer;  state: Exp;  lines: +2 -1
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.2
date: 1999/10/27 16:12:58;  author: ejohnson;  state: Exp;  lines: +1 -3
Shifted a few defs around to "proper" places:
 - number of bits needed for Cell tagging scheme
	trie_internals.h -> celltags_xsb.h
 - TrieVar tag
	cell_xsb.h -> celltags_xsb.h
----------------------------
revision 1.1
date: 1999/10/26 06:46:48;  author: kifer;  state: Exp;
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:13;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +6 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.13.4.2
date: 2004/10/18 20:45:57;  author: ruim;  state: Exp;  lines: +11 -12
update for version 2.6.1
----------------------------
revision 1.13.4.1
date: 2004/09/29 19:43:54;  author: ruim;  state: Exp;  lines: +5 -1
Sources from rfm repository
----------------------------
revision 1.13.2.2
date: 2003/04/17 17:11:52;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.13.2.1
date: 2002/10/28 16:49:29;  author: lfcastro;  state: Exp;  lines: +12 -9
* Merge with HEAD
----------------------------
revision 1.35.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.35.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.35.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/celltags.h,v
Working file: celltags.h
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.3
date: 1999/10/26 06:46:50;  author: kifer;  state: dead;  lines: +1 -1
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.2
date: 1999/10/09 02:00:22;  author: cbaoqiu;  state: Exp;  lines: +2 -3
Changes for attributed variables (first step).
----------------------------
revision 1.1
date: 1999/08/09 00:34:16;  author: kifer;  state: Exp;
Added process control builtins, deprecated unix.P,
added C preprocessor.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/celltags_xsb.h,v
Working file: celltags_xsb.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.3.0.12
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.3.10.1
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.3.10.1
	multi-threaded-25-engine: 1.3.0.10
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.8
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.6
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.4
	release_2_4: 1.3
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.2
	pre-threading: 1.3
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.9
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2005/01/14 18:30:52;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.4.4;
Integration of multithreaded system
----------------------------
revision 1.3
date: 2000/04/29 21:53:50;  author: kifer;  state: Exp;  lines: +12 -12
branches:  1.3.2;  1.3.10;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.2
date: 1999/10/27 16:12:59;  author: ejohnson;  state: Exp;  lines: +5 -1
Shifted a few defs around to "proper" places:
 - number of bits needed for Cell tagging scheme
	trie_internals.h -> celltags_xsb.h
 - TrieVar tag
	cell_xsb.h -> celltags_xsb.h
----------------------------
revision 1.1
date: 1999/10/26 06:46:50;  author: kifer;  state: Exp;
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.3.10.1
date: 2004/09/29 19:43:54;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.3.2.2
date: 2000/12/19 15:58:13;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/chat.c,v
Working file: chat.c
head: 1.26
branch:
locks: strict
access list:
symbolic names:
	multi-threaded-25-engine-done: 1.25.2.1
	multi-threaded-25-engine: 1.25.0.2
	before_removing_chat: 1.25
	release_2_5: 1.25
	pre-merge-slgwam-gc: 1.24
	multi-threaded-c-engine: 1.24.0.4
	release_2_4: 1.24
	release_2_3: 1.24
	multi-threaded-engine: 1.24.0.2
	pre-threading: 1.22
	release-2-2: 1.18
	chat-and-local: 1.18.0.2
	xsb-pre-cleanup: 1.18
	release-2-1: 1.15
	release-2-0-1: 1.15
	subsumption: 1.11
	without-attv: 1.11
	release-2-0: 1.8
	pre-release-2-0: 1.8
	v1-9-8: 1.6
keyword substitution: kv
total revisions: 34;	selected revisions: 34
description:
New file for CHAT
----------------------------
revision 1.26
date: 2002/03/12 17:34:00;  author: lfcastro;  state: dead;  lines: +1 -1
* Removal of Chat engine
----------------------------
revision 1.25
date: 2001/12/13 21:13:36;  author: lfcastro;  state: Exp;  lines: +27 -92
branches:  1.25.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.24
date: 2000/06/28 16:54:49;  author: ruim;  state: Exp;  lines: +4 -4
branches:  1.24.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.23
date: 2000/06/22 19:40:30;  author: ruim;  state: Exp;  lines: +3 -3
added casts to malloc calls to avoid warnings in C++
----------------------------
revision 1.22
date: 2000/05/29 04:23:34;  author: ejohnson;  state: Exp;  lines: +7 -7
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.21
date: 2000/05/20 06:55:56;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.20
date: 2000/05/16 19:07:31;  author: lfcastro;  state: Exp;  lines: +22 -1
* bugfix suggested by Kostis to the bug related to abolishing open
completion suspension slots on CHAT
----------------------------
revision 1.19
date: 2000/04/29 21:53:50;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.18
date: 2000/01/27 23:07:08;  author: unova;  state: Exp;  lines: +7 -7
branches:  1.18.2;
Partial fix for 64 bit architectures.
----------------------------
revision 1.17
date: 2000/01/25 03:54:37;  author: cbaoqiu;  state: Exp;  lines: +3 -4
Minor changes to get rid of the warning messages -- ``The variable
"attv_num" is set but never used'' -- when compiled on SGI 64-bit
machine.
----------------------------
revision 1.16
date: 2000/01/07 08:51:20;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.15
date: 1999/10/27 02:46:19;  author: cbaoqiu;  state: Exp;  lines: +4 -3
More changes to support attributed vars under CHAT & LOCAL_EVAL.
----------------------------
revision 1.14
date: 1999/10/26 06:46:51;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.13
date: 1999/10/25 05:57:29;  author: kifer;  state: Exp;  lines: +5 -5
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.12
date: 1999/10/22 20:57:30;  author: ejohnson;  state: Exp;  lines: +25 -1
Enabled subsumption with CHAT.

The interesting changes are in chat.c and chatsched.i.

Changes to the other files just remove CHAT restrictions to
subsumption.
----------------------------
revision 1.11
date: 1999/10/05 04:01:19;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.10
date: 1999/08/16 07:24:05;  author: kifer;  state: Exp;  lines: +40 -37
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.9
date: 1999/07/06 16:35:07;  author: ejohnson;  state: Exp;  lines: +2 -2
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.8
date: 1999/04/09 17:05:54;  author: kostis;  state: Exp;  lines: +27 -19
Added some missing bookkeeping for statistics.
----------------------------
revision 1.7
date: 1999/02/23 10:50:46;  author: kostis;  state: Exp;  lines: +9 -9
Changes to tag number of substitution factor variables in the CP stack and
to considerably speed up garbage collection - many changes in heap.c.
----------------------------
revision 1.6
date: 1999/02/04 20:30:58;  author: kostis;  state: Exp;  lines: +22 -5
Added function that's needed in LOCAL_EVAL.
----------------------------
revision 1.5
date: 1999/01/29 20:06:39;  author: kostis;  state: Exp;  lines: +15 -14
Important changes: Saving of argument registers for completion suspension
choice points is not needed either in the SLG-WAM or in CHAT.
----------------------------
revision 1.4
date: 1999/01/18 10:13:42;  author: kostis;  state: Exp;  lines: +3 -29
Some cleanup changes to delete unnecessary if-defs and related code.
----------------------------
revision 1.3
date: 1999/01/13 20:54:32;  author: kostis;  state: Exp;  lines: +22 -13
Further changes for statistics.
----------------------------
revision 1.2
date: 1999/01/13 20:28:26;  author: kostis;  state: Exp;  lines: +3 -3
Changes to fix statistics.
----------------------------
revision 1.1
date: 1998/12/21 01:07:58;  author: cbaoqiu;  state: Exp;
Kostis' changes for GC and CHAT.
----------------------------
revision 1.18.2.4
date: 2000/09/13 18:41:09;  author: lfcastro;  state: Exp;  lines: +56 -18
Changes:

*Makefile
	- create target for 'make etags'

*emu/binding.h
	- got rid of #ifdef's on WAM_TRAIL

*emu/chat.c
	- commented out a switch_envs(breg) in
	  chat_restore_compl_susp_trail
	- introduced function chat_free_cp_compl_susp_chat_areas
	  needed for bugfix in cut_xsb.h
	- change in restore_answer_template

*emu/cut_xsb.h
	- bugfix in check_table_cut

*lib/Makefile
	- put '-g none' in calls to XSB to be able to compile when GC
	  isn't working

*general
	- changes/introduction in/of debug messages

Status:
Passes the testsuite for all tests, except for the gctests with the
copying collector, which fails for tests wfs_tests/p53 (and up).
----------------------------
revision 1.18.2.3
date: 2000/04/19 18:21:57;  author: lfcastro;  state: Exp;  lines: +2 -2
- fixed memory leak-related bug introduced during cleanup
----------------------------
revision 1.18.2.2
date: 2000/03/31 22:56:57;  author: lfcastro;  state: Exp;  lines: +376 -245
* some more cleanups of chat-related code
* started inserting code comments in a format suitable for automatic
generation of documents
* new version number (tentative)
----------------------------
revision 1.18.2.1
date: 2000/03/28 18:10:30;  author: lfcastro;  state: Exp;  lines: +47 -324
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.24.2.2
date: 2000/12/19 15:58:13;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.24.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +77 -6
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.25.2.2
date: 2004/10/18 20:45:57;  author: ruim;  state: dead;  lines: +1 -1
update for version 2.6.1
----------------------------
revision 1.25.2.1
date: 2004/09/29 19:44:09;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/chat.h,v
Working file: chat.h
head: 1.10
branch:
locks: strict
access list:
symbolic names:
	multi-threaded-25-engine-done: 1.9.2.1
	multi-threaded-25-engine: 1.9.0.2
	before_removing_chat: 1.9
	release_2_5: 1.9
	pre-merge-slgwam-gc: 1.8
	multi-threaded-c-engine: 1.8.0.4
	release_2_4: 1.8
	release_2_3: 1.8
	multi-threaded-engine: 1.8.0.2
	pre-threading: 1.8
	release-2-2: 1.6
	chat-and-local: 1.6.0.2
	xsb-pre-cleanup: 1.6
	release-2-1: 1.5
	release-2-0-1: 1.5
	subsumption: 1.4
	without-attv: 1.4
	release-2-0: 1.4
	pre-release-2-0: 1.4
	v1-9-8: 1.4
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
New file for CHAT
----------------------------
revision 1.10
date: 2002/03/12 17:34:01;  author: lfcastro;  state: dead;  lines: +1 -1
* Removal of Chat engine
----------------------------
revision 1.9
date: 2001/12/13 21:13:36;  author: lfcastro;  state: Exp;  lines: +1 -16
branches:  1.9.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.8
date: 2000/05/29 04:23:34;  author: ejohnson;  state: Exp;  lines: +6 -6
branches:  1.8.2;
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.7
date: 2000/05/16 19:07:32;  author: lfcastro;  state: Exp;  lines: +5 -1
* bugfix suggested by Kostis to the bug related to abolishing open
completion suspension slots on CHAT
----------------------------
revision 1.6
date: 2000/01/27 23:07:10;  author: unova;  state: Exp;  lines: +2 -2
branches:  1.6.2;
Partial fix for 64 bit architectures.
----------------------------
revision 1.5
date: 1999/10/22 20:57:30;  author: ejohnson;  state: Exp;  lines: +4 -1
Enabled subsumption with CHAT.

The interesting changes are in chat.c and chatsched.i.

Changes to the other files just remove CHAT restrictions to
subsumption.
----------------------------
revision 1.4
date: 1999/02/04 20:31:00;  author: kostis;  state: Exp;  lines: +2 -1
Added function that's needed in LOCAL_EVAL.
----------------------------
revision 1.3
date: 1999/01/29 20:06:41;  author: kostis;  state: Exp;  lines: +2 -2
Important changes: Saving of argument registers for completion suspension
choice points is not needed either in the SLG-WAM or in CHAT.
----------------------------
revision 1.2
date: 1999/01/13 20:54:34;  author: kostis;  state: Exp;  lines: +5 -8
Further changes for statistics.
----------------------------
revision 1.1
date: 1998/12/21 01:07:59;  author: cbaoqiu;  state: Exp;
Kostis' changes for GC and CHAT.
----------------------------
revision 1.6.2.3
date: 2000/09/13 18:41:10;  author: lfcastro;  state: Exp;  lines: +4 -1
Changes:

*Makefile
	- create target for 'make etags'

*emu/binding.h
	- got rid of #ifdef's on WAM_TRAIL

*emu/chat.c
	- commented out a switch_envs(breg) in
	  chat_restore_compl_susp_trail
	- introduced function chat_free_cp_compl_susp_chat_areas
	  needed for bugfix in cut_xsb.h
	- change in restore_answer_template

*emu/cut_xsb.h
	- bugfix in check_table_cut

*lib/Makefile
	- put '-g none' in calls to XSB to be able to compile when GC
	  isn't working

*general
	- changes/introduction in/of debug messages

Status:
Passes the testsuite for all tests, except for the gctests with the
copying collector, which fails for tests wfs_tests/p53 (and up).
----------------------------
revision 1.6.2.2
date: 2000/03/31 22:56:57;  author: lfcastro;  state: Exp;  lines: +2 -2
* some more cleanups of chat-related code
* started inserting code comments in a format suitable for automatic
generation of documents
* new version number (tentative)
----------------------------
revision 1.6.2.1
date: 2000/03/28 18:10:31;  author: lfcastro;  state: Exp;  lines: +1 -45
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.8.2.2
date: 2000/12/19 15:58:13;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.8.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.9.2.2
date: 2004/10/18 20:45:58;  author: ruim;  state: dead;  lines: +1 -1
update for version 2.6.1
----------------------------
revision 1.9.2.1
date: 2004/09/29 19:44:10;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/chatsched.i,v
Working file: chatsched.i
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.4
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.2
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
New file for CHAT
----------------------------
revision 1.7
date: 1999/10/25 05:57:30;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.6
date: 1999/10/22 20:57:31;  author: ejohnson;  state: Exp;  lines: +15 -21
Enabled subsumption with CHAT.

The interesting changes are in chat.c and chatsched.i.

Changes to the other files just remove CHAT restrictions to
subsumption.
----------------------------
revision 1.5
date: 1999/10/12 19:54:11;  author: ejohnson;  state: Exp;  lines: +22 -1
Placed comment where change needs to be made to allow subsumption
under CHAT.
----------------------------
revision 1.4
date: 1999/08/16 07:24:06;  author: kifer;  state: Exp;  lines: +15 -15
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.3
date: 1999/04/22 06:49:11;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.2
date: 1999/01/18 10:13:43;  author: kostis;  state: Exp;  lines: +2 -2
Some cleanup changes to delete unnecessary if-defs and related code.
----------------------------
revision 1.1
date: 1998/12/21 01:08:02;  author: cbaoqiu;  state: Exp;
Kostis' changes for GC and CHAT.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/chatsched_xsb_i.h,v
Working file: chatsched_xsb_i.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	multi-threaded-25-engine-done: 1.7.4.1
	multi-threaded-25-engine: 1.7.0.4
	before_removing_chat: 1.7
	release_2_5: 1.7
	pre-merge-slgwam-gc: 1.7
	multi-threaded-c-engine: 1.7.0.2
	release_2_4: 1.7
	release_2_3: 1.6
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.4
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.8
date: 2002/03/12 17:34:01;  author: lfcastro;  state: dead;  lines: +1 -1
* Removal of Chat engine
----------------------------
revision 1.7
date: 2001/05/24 17:54:51;  author: lfcastro;  state: Exp;  lines: +15 -3
branches:  1.7.4;
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.6
date: 2001/01/31 10:23:29;  author: ejohnson;  state: Exp;  lines: +16 -17
Created the macro "table_pending_answer" to hide the details of
obtaining the next answer for consumption, which, in the case of a
properly subsumed subgoal, may require an answer identification step.

Second, removed -- again -- (most) "xtemp1" references.
(Argh!  How does this crap keep creeping back into the system?!?)

These were sprinkled over several files and removed by simply creating
a variable local to each macro in which a temp was needed.

The "need" for this change was precipitated due to the inclusion of an
"xtemp1" declaration within one of the code blocks which
table_pending_answer replaced.
----------------------------
revision 1.5
date: 2000/06/27 17:59:16;  author: ejohnson;  state: Exp;  lines: +3 -3
branches:  1.5.2;
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.4
date: 2000/06/19 07:09:16;  author: ruim;  state: Exp;  lines: +4 -4

changed C++ keyword template
----------------------------
revision 1.3
date: 2000/05/29 04:23:34;  author: ejohnson;  state: Exp;  lines: +42 -30
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.2
date: 2000/05/25 00:32:01;  author: ejohnson;  state: Exp;  lines: +9 -9
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.1
date: 1999/10/25 05:57:31;  author: kifer;  state: Exp;
branches:  1.1.2;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.2.2
date: 2000/09/13 18:41:10;  author: lfcastro;  state: Exp;  lines: +15 -9
Changes:

*Makefile
	- create target for 'make etags'

*emu/binding.h
	- got rid of #ifdef's on WAM_TRAIL

*emu/chat.c
	- commented out a switch_envs(breg) in
	  chat_restore_compl_susp_trail
	- introduced function chat_free_cp_compl_susp_chat_areas
	  needed for bugfix in cut_xsb.h
	- change in restore_answer_template

*emu/cut_xsb.h
	- bugfix in check_table_cut

*lib/Makefile
	- put '-g none' in calls to XSB to be able to compile when GC
	  isn't working

*general
	- changes/introduction in/of debug messages

Status:
Passes the testsuite for all tests, except for the gctests with the
copying collector, which fails for tests wfs_tests/p53 (and up).
----------------------------
revision 1.1.2.1
date: 2000/03/28 18:10:31;  author: lfcastro;  state: Exp;  lines: +2 -37
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:13;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +13 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.7.4.2
date: 2004/10/18 20:45:58;  author: ruim;  state: dead;  lines: +1 -1
update for version 2.6.1
----------------------------
revision 1.7.4.1
date: 2004/09/29 19:44:10;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/choice.h,v
Working file: choice.h
head: 1.45
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.42
	ROLLBACK: 1.36
	latest_plus_supp_branch: 1.32.0.4
	latest_plus_supp: 1.32
	Version_3dot2_plus_supp: 1.32.0.2
	release_2_6_plus_supp: 1.19.0.6
	Version_3dot2: 1.32
	dec07-perf-results: 1.31
	mt_thesis: 1.29
	release_3_0: 1.28
	release_2_7_0: 1.19
	multi-threaded-26-engine: 1.16.2.2
	pre-mt: 1.19
	multi-threaded-25-engine-done: 1.16.2.1
	multi-threaded-25-engine: 1.16.0.2
	release_2_6_1: 1.19
	release_2_6_final: 1.19
	release_2_6: 1.19.0.4
	last-merged-to-demand: 1.19
	demand_branch: 1.19.0.2
	before_removing_chat: 1.18
	release_2_5: 1.16
	pre-merge-slgwam-gc: 1.15
	multi-threaded-c-engine: 1.15.0.2
	release_2_4: 1.13
	release_2_3: 1.12
	multi-threaded-engine: 1.12.0.2
	pre-threading: 1.12
	release-2-2: 1.11
	chat-and-local: 1.11.0.2
	xsb-pre-cleanup: 1.11
	release-2-1: 1.10
	release-2-0-1: 1.10
	subsumption: 1.10
	without-attv: 1.8
	release-2-0: 1.6
	pre-release-2-0: 1.5
	v1-9-8: 1.5
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 58;	selected revisions: 58
description:
----------------------------
revision 1.45
date: 2012/02/29 16:20:37;  author: tswift;  state: Exp;  lines: +2 -2

Forgot to commit!
----------------------------
revision 1.44
date: 2011/08/19 21:44:14;  author: tswift;  state: Exp;  lines: +1 -17

Mostly minor changes to let ctrace print out early completion, and to
allow ctrace to be directed to stdout rather than a file if desired.
This necessitated some minor code refactoring.
----------------------------
revision 1.43
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +2 -2

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.42
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -15
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.41
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.40
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.39
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.38
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.37
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +15 -1
no message
----------------------------
revision 1.36
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.35
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.34
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -14
Backed out code
----------------------------
revision 1.33
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +15 -1
Dipti's code for support graph added
----------------------------
revision 1.32
date: 2008/09/26 20:32:01;  author: tswift;  state: Exp;  lines: +3 -1
branches:  1.32.4;

`Fixes the test pps while not breaking the tests dipti or wine.
The change is a 1-liner.  Other changes are for documentation and
(commented out) debugging.

----------------------------------------------------------------------

Keeping some log notes of the change in the CVS log -- this has proven
useful in understanding the history of minor tabling changes.

I've just spent a while analyzing the pps program to find out why a
cut-over choice point is improperly backtracked into.  Recall that
when I fixed this bug 3 years ago, I broke an example of Dipti's
(which is now in the test suite) along with the wine example.  Taking
out that change apparently fixes both examples.

A complex combination of events give rise to backtracking over a cut
choice point in local evaluation.  First, early completion must be
applied to a subgoal S that is not the leader in an SCC.  Next, the
generator/consumer choice point of S must never have been scheduled
for answer return.  And finally, the generator/consumer choice point
of S must be preceded by a cut-over choice point.

I realize that this is obscure, and I don't yet understand how to
explain it more cogently.  However, I do include 1) a pps program,
slightly modified with debugging info; 2) the debugging output; and 3)
a detailed explanation of what is going on.  I'm not sure whether
these details will be of help to anyone other than me.

Of course the real question is what to do.  My previous "fix" was to
ensure that non-leader GCPs pointed to the leader GCP in local
evaluation when the non-leader GCP was backtracked over and turned
into a CCP.  Exactly why this was causing a problem in the wine and
Dipti examples, I dont know, but I could see that it could be a
problem if there were a chain of non-leader GCPs linked by their
previous CP values.  So anyway, that fix wont work.

Thus, we want the previous CP of non-leader GCPs ot point to the
leader GCP after they have been turned into consumers (as long as they
are not part of a scheduling chain).  Making this adjustment when the
non-leader GCP is turned into a CCP is wrong, as we've seen.  However,
I do believe that making the adjustment at a different time is safe.
Accordingly I made a 1-line change to adjust the previous choice point
of non-leader GCPs to the leader GCP during *fixed-point check
performed by the leader*.

By the way, I really appreciate the work that Michael did to pare down
the bug example to the small pps program.  If it had been much more
complex, I doubt that I could have understood what was going on.

Terry


Its possible that rather than adjusting the non-leader GCPs to have
the leader GCP as their previous choice point when they are turned
into CCPs (which is wrong) this could be done at some other time.

One possibility is to make the adjustment at fixpoint check, as the
CCP (nee GCP) needs to be traversed to check if it has unreturned
answers anyway.

I'll think about doing making that change to the fixed point
computation.  However, at least for now I think the engine is
functioning properly for definite datalog programs without cuts -- at
least in terms of answer scheduling.

------------------------------------------------------------------------------------
% % % pps.P % % %

/* print_cp is more understandable when CP_DEBUG is defined */

:- import print_cp/0 from machine.

:- table w2/2, w3/3.

db(wrapper(app,_)).
db(wrapper(pps,_)).
db(wrapper(p,_)).

test:- w2(pps,foobar).
test1:- w2(pps,_foobar).

%% wrapper/2
w2(pps,_A) :-
%	print_cp,
	writeln(clause1w2(pps,_A)),
        w2(app,foobar),
        fail.
w2(app,_A) :-
	writeln(clause2w2(app,_A)),
	w3(p,_,foobar).
w2(X,Y) :-
	writeln(clause3(w2(X,Y))),
        db(wrapper(X,Y)),
        nl,
	print_cp,
        writeln('About to cut'),
        !,
	print_cp,
        fail.
%% Shouldn't go here after the cut!!!
w2(X,Y) :-
	writeln(clause4(w2(X,Y))),
        writeln('******fell through the cut!!! ' - X).

%% wrapper/3
w3(p,0,X):-
	writeln(clause1(w3(p,-,X))).
w3(p,_A,_B) :-
	writeln(clause2(w3(p,_A,_B))),
        w3(p,_,foobar),
	writeln(calling(w2(pps,foobar))),
        w2(pps,foobar).

------------------------------------------------------------------------------------
% % % Output % % %

| ?- test.
clause1w2(pps,foobar)
clause2w2(app,foobar)
clause1(w3(p,-,foobar))
clause2(w3(p,_h131,foobar))
calling(w2(pps,foobar))
clause3(w2(app,foobar))

About to cut
clause3(w2(pps,foobar))

About to cut
leader scheduling answers                            % printout from engine
performing early completion for: w2(app, foobar)(breg: 5c4c8c pcpf 5c4d18) % printout from engine
clause4(w2(pps,foobar))
******fell through the cut!!!  - pps
performing early completion for: w2(pps, foobar)(breg: 5c4da0 pcpf 5c4da0) % printout from engine
leader scheduling answers % printout from engine
calling(w2(pps,foobar))
leader scheduling answers % printout from engine


------------------------------------------------------------------------------------
% % % The prodigal choice point % % %

Step 1: Generator Choice Point created for w2(pps,foobar) (Failure
continuation set to check_complete)

Step 2: Regular choice point created for _$w2(pps,foobar), (_$w2/2 was
created to handle cut in a clause body of w2/2).

Step 3: GCP created for w2(app,foobar)

Step 4: Regular choice point created for _$w2(app,foobar)

Step 5: GCP created for w3(p,_,foobar)

Step 6: Answer created for w3(p,_,foobar), and Consumer Choice Point
created for w3(p,_,foobar)

Step 7: Answer w3(p,0,foobar) created in step 6 returned to CCP
created in step 6 (while evaluating the second clause of w3/3).
CCP created for w2(pps,foobar).

Step 8: At this point all subgoals are in the same Approximate SCC.
Also, each CP has as its previous CP the CP created in the immediately
preceding step.  The only anwser produced has been consumed, so the
engine backtracks to the CCP of step 7; fails; backtracks to the CCP
created in step 6; fails; backtracks to the GCP created in step 6 and
turns the GCP created in step 5 into a CCP.  (This happens in local
evaluations when backtracking over a GCP for a subgoal that is not a
SCC leader).  Finally, backtracking reaches the CP created in Step 4,
and executes the third clause of _$w2(app,foobar)

Step 9: Forward execution creates a choice point for db/1 whose
previous choice point is the CP of Step 4.  Note that there are two
CPs whose previous CP is that of Step 4: this new one and the one from
step 5.

Step 10: the cut is executed, the CP of step 9 removed, and breg set
to the GCP for Step 3.  Upon failure (immediately after the cut)
backtracking sets the GCP of Step 3 to a CCP, and fails.  Backtracking
follows the previous CP for the Step 3 CCP to the step 2 CP.

Step 11: Similarly to step 9, forward execution executes clause 3 for
_$w2(pps,foobar) (a minor difference is that no CP for db/1 is created
for the goal db(wrpper(app,foobar)) ).  (breg still points to Step 2's
CP)

Step 12: The cut is executed, resetting breg back to the original GCP
of Step 1, which is the leader.  Recall that the failure continuation
for the step 1 GCP is a check_complete, so the leader schedules answer
return for all CCPs in the SCC.  Actually, there is one scheduled.
The answer w3(p,0,foobar) is returned to the CCP (nee GCP) of step 5,
returning the answer to the second clause of _$w2(app,foobar).

Step 13 (the unlucky step): The return of the answer immediately
causes a new answer w2(app,foobar) to be derived for the goal
w2(app,foobar).  Since an answer is returned for a ground goal, early
completion applies and the goal w2(app,foobar) is early completed.

>>!! A heuristic for early completion is to set the breg to the
original GCP for the goal !!<<

and the breg is set to point to the GCP (now a CCP) of w2(app,foobar)
created in step 3.

Step 14.  Note that due to early completion, the breg now points to
the CCP of step 3 which was never scheduled by the leader.  If it had
been scheduled, its previous CP would be the (step 1) leader.
However, as it was never rescheduled, its previous CP is its original
one: that of step 2.

Step 15. The addition of the new answer from step 13 causes an
immediate failure due to local scheduling.  The engine now backtracks
into the (ostensably cut) choicepoint of step 2, which improperly
executes the fourth clause for _$w2(pps,foobar).
----------------------------
revision 1.31
date: 2007/09/26 20:15:22;  author: dwarren;  state: Exp;  lines: +2 -2
This update modifies the trymeorelse instruction (which implements
disjunctions, including if-then-else) to include a check for pending
attv interrupts, and handling them if there are any.  The problem is
that to handle interrupts, the environment must be known and there
must be a "call"-like instruction that allows called routines to find
the size of the parents AR.  This is done here by having the
trymeorelse instruction (when there is a pending interrupt) create
an environment and then branch to a 2-instruction sequence of
check_interrupt,restore_dealloc_proceed.  This last instruction is
new, and it restores registers (if nec, but here it's not since no
registers are active at a trymeorelse), pops the environment and
returns to the original caller, which in this case causes the trymeorelse
instruction to be executed again.
----------------------------
revision 1.30
date: 2007/08/30 14:46:19;  author: dwarren;  state: Exp;  lines: +3 -2
Fixed bug that showed up in GC in handling of reg_array.  reg_arrayptr
was not being reset to indicate reg_array was empty, so GC tried to
relocate garbage pointers.  So this resets reg_array to empty in
all restore-state type instructions.

Also found bug in GC in that it doesn't handle heap pointers in the
attv_interrupts array correctly.  That bug is not fixed.  I think we
need to change the way attv interrupts are accumulated and eliminate
this array.  But that awaits....
----------------------------
revision 1.29
date: 2006/11/06 17:31:53;  author: ruim;  state: Exp;  lines: +12 -6
Fixes to CONC_COMPL:

- compl stack expansion fixed
- freeing of answer_return list finally fixed

it now runs all the tests that batched runs
----------------------------
revision 1.28
date: 2006/01/27 20:29:43;  author: tswift;  state: Exp;  lines: +7 -9

Some changes I recently made broke batched evaluation.  I backed out these changes to fix the batched test suite again.
----------------------------
revision 1.27
date: 2005/12/26 17:17:19;  author: tswift;  state: Exp;  lines: +4 -4
Added check for null pointers to mem_xxxoc() functions.  Thanks to our
now strict use of mem_xxxoc() functions, this means we always check
for null pointers returned by malloc.  Next thing you know, I'll be
rotating my tires every year.  If we do get a null pointer, we call a
non-ISO xsb_memory_error().

Updated documentation in exceptions.tex, and in the course of so doing
added some new ISO-error types to error_handler.P.  There are still
corresponding functions to be added to error_xsb.c Other documentation
for setof and other accumulated changes.

The other change was to get rid of a few stray references to
resume_compl_suspension_inst2.
----------------------------
revision 1.26
date: 2005/11/17 18:22:41;  author: tswift;  state: Exp;  lines: +11 -4

Removed resume_compl_susp_inst2 -- unneeded, and a remnant of old single-stack scheduling (!)
----------------------------
revision 1.25
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;  lines: +14 -3
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.24
date: 2005/08/28 16:42:28;  author: ruim;  state: Exp;  lines: +5 -1
phase 1 of implementation of concurrent completion
----------------------------
revision 1.23
date: 2005/07/21 10:46:35;  author: ruim;  state: Exp;  lines: +8 -1
preliminar implementation of deadlock breaking
----------------------------
revision 1.22
date: 2005/07/20 16:00:56;  author: ruim;  state: Exp;  lines: +1 -8
changed tid from generator cp to sf in preparation for deadlock breaking
----------------------------
revision 1.21
date: 2005/07/04 20:47:00;  author: ruim;  state: Exp;  lines: +8 -1
allow sharing of completed tables
----------------------------
revision 1.20
date: 2005/01/14 18:30:52;  author: ruim;  state: Exp;  lines: +59 -59
Integration of multithreaded system
----------------------------
revision 1.19
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +4 -102
branches:  1.19.2;
* Removal of Chat engine
----------------------------
revision 1.18
date: 2002/03/12 15:13:38;  author: lfcastro;  state: Exp;  lines: +2 -2
* added another statistics/1 capability:
  statistics(7) prints a backtrace of the choicepoints in the stack
* only works if CP_DEBUG is defined during compilation
----------------------------
revision 1.17
date: 2002/03/11 21:52:55;  author: lfcastro;  state: Exp;  lines: +31 -10
* initial conditional support for backtraces by keeping PSC pointers
in choicepoints
----------------------------
revision 1.16
date: 2001/12/13 21:13:36;  author: lfcastro;  state: Exp;  lines: +104 -51
branches:  1.16.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.15
date: 2001/10/01 19:48:29;  author: lfcastro;  state: Exp;  lines: +16 -16
* modified the resumption of completion suspension frames in SLGWAM in
  order to create chains with the original frames, instead of creating
  new ones on the CP stack
----------------------------
revision 1.14
date: 2001/09/24 17:23:52;  author: lfcastro;  state: Exp;  lines: +5 -2
* attempt to cleanup and organize the completion algorithm for LOCAL
evaluation
----------------------------
revision 1.13
date: 2001/05/24 17:54:51;  author: lfcastro;  state: Exp;  lines: +33 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.12
date: 2000/05/19 04:58:33;  author: kifer;  state: Exp;  lines: +3 -2
branches:  1.12.2;
got rid of compiler warnings having to do with casting get_arity.
----------------------------
revision 1.11
date: 1999/12/22 18:06:53;  author: warren;  state: Exp;  lines: +2 -2
branches:  1.11.2;
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.10
date: 1999/10/12 20:28:01;  author: kostis;  state: Exp;  lines: +13 -9
Clean up and localization of variables changes.
----------------------------
revision 1.9
date: 1999/10/12 19:59:34;  author: ejohnson;  state: Exp;  lines: +21 -21
Change in args of def of perform_early_completion, plus some comments
and refinement of def of SaveConsumerCPF.
----------------------------
revision 1.8
date: 1999/08/04 14:41:51;  author: ejohnson;  state: Exp;  lines: +60 -137
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.7
date: 1999/07/15 21:41:11;  author: ejohnson;  state: Exp;  lines: +5 -5
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.6
date: 1999/06/16 14:53:58;  author: kostis;  state: Exp;  lines: +4 -1
Added PTCP register back in Prolog Choice Points.
----------------------------
revision 1.5
date: 1999/02/02 17:17:05;  author: kostis;  state: Exp;  lines: +7 -7
Silly include for debugging taken out.
----------------------------
revision 1.4
date: 1999/01/23 17:41:35;  author: kostis;  state: Exp;  lines: +4 -4
Really minor cleanup.
----------------------------
revision 1.3
date: 1999/01/17 14:56:18;  author: kostis;  state: Exp;  lines: +6 -1
Some small changes for statistics and for hooking up garbage collection.
----------------------------
revision 1.2
date: 1998/12/21 01:08:04;  author: cbaoqiu;  state: Exp;  lines: +207 -241
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:13;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:13;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.11.2.1
date: 2000/03/28 18:10:31;  author: lfcastro;  state: Exp;  lines: +2 -150
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.12.2.2
date: 2000/12/19 15:58:13;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.12.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +7 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.16.2.2
date: 2004/10/18 20:45:58;  author: ruim;  state: Exp;  lines: +33 -110
update for version 2.6.1
----------------------------
revision 1.16.2.1
date: 2004/09/29 19:44:10;  author: ruim;  state: Exp;  lines: +59 -59
Sources from rfm repository
----------------------------
revision 1.19.2.4
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +7 -2
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.19.2.3
date: 2002/08/29 18:49:15;  author: lfcastro;  state: Exp;  lines: +62 -7
* IMPLEMENTED "scope chain"
  - scope of a once cannot be represented by normal backtracking
  chain, since check_complete may modify this chain
  - an additional word is maintained in all choicepoints in order to
  keep this "scope" chain
  - another approach would be to change the completion algorithms to
  keep the right order (?)
----------------------------
revision 1.19.2.2
date: 2002/08/29 14:17:12;  author: lfcastro;  state: Exp;  lines: +4 -14
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.19.2.1
date: 2002/08/10 00:19:33;  author: lfcastro;  state: Exp;  lines: +36 -9
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.32.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.32.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +14 -0
no message
----------------------------
revision 1.32.4.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/cinterf.c,v
Working file: cinterf.c
head: 1.111
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.103
	ROLLBACK: 1.98
	latest_plus_supp_branch: 1.98.0.2
	latest_plus_supp: 1.98
	Version_3dot2_plus_supp: 1.90.0.2
	release_2_6_plus_supp: 1.46.0.4
	Version_3dot2: 1.90
	dec07-perf-results: 1.88
	mt_thesis: 1.67
	release_3_0: 1.66
	release_2_7_0: 1.47
	multi-threaded-26-engine: 1.39.2.2
	pre-mt: 1.47
	multi-threaded-25-engine-done: 1.39.2.1
	multi-threaded-25-engine: 1.39.0.2
	release_2_6_1: 1.46
	release_2_6_final: 1.46
	release_2_6: 1.46.0.2
	last-merged-to-demand: 1.41
	demand_branch: 1.40.0.2
	before_removing_chat: 1.39
	release_2_5: 1.39
	pre-merge-slgwam-gc: 1.38
	multi-threaded-c-engine: 1.38.0.2
	release_2_4: 1.38
	release_2_3: 1.34
	multi-threaded-engine: 1.34.0.2
	pre-threading: 1.33
	release-2-2: 1.31
	chat-and-local: 1.31.0.2
	xsb-pre-cleanup: 1.31
	release-2-1: 1.23
	release-2-0-1: 1.21
	subsumption: 1.19
	without-attv: 1.19
	release-2-0: 1.15
	pre-release-2-0: 1.6
	v1-9-8: 1.4
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.3
	r1-9-b6: 1.3
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 121;	selected revisions: 121
description:
----------------------------
revision 1.111
date: 2011/07/29 06:25:51;  author: kifer;  state: Exp;  lines: +2 -4
made XSB configure under cygwin again
----------------------------
revision 1.110
date: 2011/07/29 05:13:28;  author: kifer;  state: Exp;  lines: +3 -1
made XSB configure under cygwin again
----------------------------
revision 1.109
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +2 -2
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.108
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +12 -11
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.107
date: 2011/05/01 09:36:18;  author: kifer;  state: Exp;  lines: +10 -4
killed most of the warnings
fixed makefile bug
----------------------------
revision 1.106
date: 2011/04/27 17:11:11;  author: pmoura;  state: Exp;  lines: +5 -9
Removed support for using the \z escape sequence for representing Prolog end-of-file. It worked fine for the 0' notation but it caused problems when using the escape sequence on strings an atoms.
----------------------------
revision 1.105
date: 2011/04/26 21:17:32;  author: kifer;  state: Exp;  lines: +2 -2
replaced \s with " "
----------------------------
revision 1.104
date: 2011/04/26 14:00:31;  author: pmoura;  state: Exp;  lines: +9 -1
Implemented 0'\s (space) and 0'\z (Prolog end-of-file). The former is specially useful as writing "0' " is fragile when using tools the reformat source code or when tabing/detabing source files. Second attempt.
----------------------------
revision 1.103
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.102
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.101
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.100
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.99
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.98
date: 2010/06/14 12:45:58;  author: dwarren;  state: Exp;  lines: +3 -2
branches:  1.98.2;
Changed xsb_query_string to use atoms (and not code-lists.)  It is quite a bit
more efficient, and we now have atom gc, and with Michael's query caching, the atoms
are created anyway.
----------------------------
revision 1.97
date: 2010/05/21 23:31:38;  author: kifer;  state: Exp;  lines: +9 -9
added DllExport to p_charlist_to_c_string and c_string_to_p_charlist
----------------------------
revision 1.96
date: 2010/05/03 00:17:25;  author: evansbj;  state: Exp;  lines: +85 -87
Fixed a little something I missed last night.
----------------------------
revision 1.95
date: 2010/05/02 05:11:26;  author: evansbj;  state: Exp;  lines: +45 -67
Update to make thread_exit/1, and xsb_kill_thread work from the C interface. It passes the regression tests as well as before, better actually.
----------------------------
revision 1.94
date: 2010/04/05 06:02:32;  author: evansbj;  state: Exp;  lines: +46 -41
I went to far, fixing a bug I introduced with the last checkin.
----------------------------
revision 1.93
date: 2010/04/04 04:44:51;  author: evansbj;  state: Exp;  lines: +67 -25
Adjusting the Mutex locks, I 'think' this is better. It fixes one of the test cases...
----------------------------
revision 1.92
date: 2010/04/03 23:53:35;  author: evansbj;  state: Exp;  lines: +24 -5
It turns out that pthread_cond_wait can return for reasons other than just the expected signal condition. It should be in a tight while loop that checks an expected state change in something like xsb_ready. Just to be sure that the C thread and the Prolog thread don't collide in signal rich environments.
----------------------------
revision 1.91
date: 2010/02/08 07:01:45;  author: evansbj;  state: Exp;  lines: +1 -2
This count_arity call appears to be left over from some cut and paste and a waste of cycles...
----------------------------
revision 1.90
date: 2008/04/06 23:04:22;  author: tswift;  state: Exp;  lines: +19 -15
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.89
date: 2008/01/02 19:47:42;  author: dwarren;  state: Exp;  lines: +12 -9
Fix (or at least greatly improve) the C-calling-XSB (recursively) interface for
the multi-threaded engine.  There is still an issue with multiple calls of
different C threads, but sharing the same th-context.  But I think the problem
is in more than just this interface.
----------------------------
revision 1.88
date: 2007/10/09 17:15:04;  author: dwarren;  state: Exp;  lines: +44 -1
These changes implement a facility that allows a routine called from
XSB as foreign code to call a predicate back in XSB.  This allows
mutual recursion between XSB and foreign code (and has been tested by
programming a recursive fibonacci in which the Prolog code calls C for
the samller values and C calls Prolog for its smaller values.)

It is similar to the "C calling XSB" interface, with the following
differences:

1. Do not call xsb_init or xsb_init_string.  These functions
initialize XSB, which clearly cannot be done if XSB is already
running.

2. A foreign routine called from XSB that wants to call an XSB
predicate must first call:
	xsb_query_save(NumRegs)

It must do this after retrieving its input parameters from XSB and
before calling any XSB predicate.  NumRegs must be the number of XSB
registers that the current foreign code uses (i.e., the number of
arguments of the XSB predicate used to call this foreign code
routine.)  This call saves the caller registers and sets up the XSB
state to accept queries from the foreign code.  (This is similar to
the XSB state after xsb_init is called.)  So after this call, the
foreign routine can use any of the interface routines for calling XSB,
such as xsb_command, xsb_command_string, xsb_query, xsb_query_string,
etc.

3. Before setting its output parameters and returning to its caller,
the foreign routine must call
	xsb_query_restore()

This restores the XSB parameter registers back to their state when
xsb_query_save() was called, and so prepares the registers to accept
the return values.  (It must be called even if there are no values to
be returned.)

This code works (according to my tests) for the single-threaded
engine.  It does NOT currently work for the multi-threaded engine.
I've put in the necessary CTXT- stuff, but still get crashes.  I'm
sure it can be made to work, but may need help in figuring out how.
----------------------------
revision 1.87
date: 2007/08/21 14:04:26;  author: dwarren;  state: Exp;  lines: +2 -2
DllExport and call_conv added to header of xsb_get_thread_entry.
It was added in the extern in the .h, but not in the actual definition.
----------------------------
revision 1.86
date: 2007/08/18 19:55:20;  author: tswift;  state: Exp;  lines: +6 -1
Made thread_entry() visible to help setting up arrays to threads in Interprolog and XSB.net.
----------------------------
revision 1.85
date: 2007/08/08 17:50:49;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.84
date: 2007/07/26 15:14:28;  author: tswift;  state: Exp;  lines: +10 -1

1) Change to use xsb_initialization_exit() in xsb_basic_abort() to allow proper
behavior in C interface

2) Made changes to ensure proper mutex initializations when calling XSB from C.
----------------------------
revision 1.83
date: 2007/07/22 18:40:48;  author: ruim;  state: Exp;  lines: +2 -3
Changes to allow for main_xsb.c to link in under windows, for
the multi-threaded system.
----------------------------
revision 1.82
date: 2007/07/21 16:24:17;  author: ruim;  state: Exp;  lines: +1 -2
fixed find_context to work during xsb initialization
----------------------------
revision 1.81
date: 2007/05/24 23:11:19;  author: evansbj;  state: Exp;  lines: +17 -10
Strlen doesn't behave nicely on all platforms when passed a NULL, and since
this is a 'public' interface you never know what the client application is
going to do...
----------------------------
revision 1.80
date: 2007/04/06 11:41:48;  author: tswift;  state: Exp;  lines: +50 -36
Changes and additions to comments only (since at least Barry reads the comments :-)
----------------------------
revision 1.79
date: 2007/04/05 17:26:57;  author: tswift;  state: Exp;  lines: +10 -12
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.78
date: 2007/04/03 13:59:44;  author: dwarren;  state: Exp;  lines: +7 -7
Fixed to compile with MSVC:
A few too many call_conv's in cinterf.h and not enough in cinterf.c
----------------------------
revision 1.77
date: 2007/04/03 10:22:34;  author: tswift;  state: Exp;  lines: +106 -63

Updated register-level C API functions so that an XSB thread can
be called from a different C thread.

There are progressively more complicated examples for how to use
the register-level interface in examples/c_calling_xsb --
cregs.c, cregs_thread.c and cregs_thread2.c, which can be made
via make.P make_thread.P and make_thread2.P and I think I
documented everything in the manual.

Also, I made some macros in the new interface into functions so
they can be dynamically linked and Windows would be happy.  I
tried to follow the pattern of other Windows code, but nobody
should trust me regarding Windows stuff :-)

Finally, I initialized signal handlers in xcallxsb.P
----------------------------
revision 1.76
date: 2007/03/14 16:02:52;  author: dwarren;  state: Exp;  lines: +1 -1
Changge format for returning floats to a c-caller of XSB using xsb_query_string_string
from fixed .4 to %lg (scientific noation) so that full precision numbers are returned.
This could break applications using xsb_query_string_string, but is clearly important
to allow full precision of floats to used.
----------------------------
revision 1.75
date: 2007/02/23 20:17:04;  author: tswift;  state: Exp;  lines: +74 -13
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.74
date: 2007/02/22 20:05:02;  author: tswift;  state: Exp;  lines: +4 -3

Fixed some bugs with mutexes in XSB's C API.
----------------------------
revision 1.73
date: 2007/02/22 00:16:04;  author: tswift;  state: Exp;  lines: +129 -59


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.72
date: 2007/02/18 16:26:05;  author: dwarren;  state: Exp;  lines: +20 -0
Added definition of snprintf for MSVC compilation.  Used when HAVE_SNPRINTF
flag is not defined in xsb_config.h  (At the moment needs to be undefined by hand.)
----------------------------
revision 1.71
date: 2007/01/25 20:33:53;  author: tswift;  state: Exp;  lines: +150 -72


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.70
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +120 -80

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.69
date: 2007/01/08 22:09:27;  author: dwarren;  state: Exp;  lines: +5 -0
Added XSB_Deref to p2c_ functions.  Clearly the users of these functions
shouldn't be responsible for knowing dereferencing status of prolog_term's.
----------------------------
revision 1.68
date: 2006/12/31 23:49:40;  author: tswift;  state: Exp;  lines: +2 -1

Fixed buglet (or feature) in xsb_answer_string() which required an external re-initialization of the string each time it is called.  xsb_answer_string now has an explicit call to XSB_StrAppend so that the user wont have to do this.
----------------------------
revision 1.67
date: 2006/09/14 16:13:55;  author: crojo;  state: Exp;  lines: +31 -1
Added two new routines to the C interface:

pipe_xsb_stdin()
  This splits XSB's stdin stream into a read end and a
  write end. The read end takes the place of the original stdin, and
  the write end is accessable through a call to write_to_xsb_stdin,
  another c interface routine. These two calls can be used to pass
  input to a thread running xsb.dll code that is blocking waiting for
  input from stdin. They allow separate threads to interact with the
  interpreter or the trace debugger when xsb is loaded as a DLL.

writeln_to_xsb_stdin(char *)
  This can be called after a call to  pipe_xsb_stdin, and writes a string
  of characters to the write end of xsb's piped stdin stream. If a thread
  running xsb.dll code is blocking on input from stdin, this will unblock
  it.

I've modified the way output is redirected to files on WIN_NT when XSB
is initialized through the C interface. The output files are now sharable.
I've also changed the spacing in call_graph_xsb.c to fix compilation problems
on windows.
----------------------------
revision 1.66
date: 2006/05/05 21:38:02;  author: dwarren;  state: Exp;  lines: +6 -1
Added new routine to be called externally, to expand heap to ensure there
is enough space for expected c2p_functor and c2p_list calls.
----------------------------
revision 1.65
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +2 -2

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.64
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +5 -5
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.63
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +88 -85


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.62
date: 2005/11/13 21:38:37;  author: dwarren;  state: Exp;  lines: +6 -3
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.61
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +4 -4
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.60
date: 2005/11/10 23:05:55;  author: tswift;  state: Exp;  lines: +1 -3

Removed some stray printfs.
----------------------------
revision 1.59
date: 2005/11/09 17:52:27;  author: dwarren;  state: Exp;  lines: +13 -7
Allowed file_open on strings to take code-lists (actually it already could,
but had a bug), and then changed xsb_query_string to build a code-list for
the query on the heap to avoid interning the goal.  And fixed c2p_chars (which
might better be called c2p_codes) to check for heap overflow.  This fixes a
"memory leak" from code calling XSB, pointed out by Michael.
----------------------------
revision 1.58
date: 2005/10/11 15:19:10;  author: dwarren;  state: Exp;  lines: +3 -1
Condition include so it works under Windows
----------------------------
revision 1.57
date: 2005/10/10 12:29:05;  author: kostis;  state: Exp;  lines: +2 -1
Small change to avoid compiler warning.
----------------------------
revision 1.56
date: 2005/08/17 15:58:20;  author: dwarren;  state: Exp;  lines: +4 -2
Re-add typedef required for MT under MS_WIN.
----------------------------
revision 1.55
date: 2005/08/08 21:25:01;  author: dwarren;  state: Exp;  lines: +2 -2
SImple cleanup, mostly using define-cons instead of numbers in various places.
----------------------------
revision 1.54
date: 2005/07/18 21:54:08;  author: crojo;  state: Exp;  lines: +4 -5
*** empty log message ***
----------------------------
revision 1.53
date: 2005/07/15 14:48:53;  author: dwarren;  state: Exp;  lines: +21 -19
Made getting last answer (when answer length overflows buffer) thread-safe.
----------------------------
revision 1.52
date: 2005/07/13 21:58:56;  author: dwarren;  state: Exp;  lines: +22 -19
More thread-safety, in xsb_throw (and relatives)
and some in cinterf (eliminated global buffers, but still some globals left... so
more work is required.)
----------------------------
revision 1.51
date: 2005/06/29 13:58:11;  author: vidrevich;  state: Exp;  lines: +14 -14
incorporating multi-threading into C/XSB interface. In multi-threaded engine xsb_init() takes a pointer to the thread context structure as its first argument and populates that structure with main thread context information to be used in the consequent C/XSB calls. myargc,myargv are passed as the second and the third arguments to the xsb_init() when XSB is configured for multi-threading. Changes should not affect a single-threaded version.
----------------------------
revision 1.50
date: 2005/04/27 04:20:14;  author: evansbj;  state: Exp;  lines: +108 -19
Updated stderr and stdout redirection available via the -q parameter
----------------------------
revision 1.49
date: 2005/03/05 07:49:51;  author: kifer;  state: Exp;  lines: +2 -2
got rid of obvious compiler warnings
----------------------------
revision 1.48
date: 2005/01/14 18:30:53;  author: ruim;  state: Exp;  lines: +107 -101
Integration of multithreaded system
----------------------------
revision 1.47
date: 2004/12/20 19:26:14;  author: dwarren;  state: Exp;  lines: +2 -2
hanged several int's to Integer's for safety.  There is more interest in
the 64-bit port, so I'd like to find the current bugs in it.  This might
be a start.
----------------------------
revision 1.46
date: 2003/05/12 02:26:14;  author: kifer;  state: Exp;  lines: +18 -9
take into account escaped chars when determining what is a printable
prolog string
----------------------------
revision 1.45
date: 2003/04/28 18:04:18;  author: kifer;  state: Exp;  lines: +3 -2
p_charlist_to_c_string(): check for printable characters
----------------------------
revision 1.44
date: 2003/04/26 18:01:03;  author: kifer;  state: Exp;  lines: +3 -2
is_charlist should check chars between 32 and 126, not betw 0 and 255
----------------------------
revision 1.43
date: 2003/02/21 16:43:08;  author: lfcastro;  state: Exp;  lines: +12 -4
* p2c_chars had its interface modified, rendering its uses (most notably, the high-level C interface) broken. Change it back to its original interface.
----------------------------
revision 1.42
date: 2002/12/10 21:59:17;  author: dwarren;  state: Exp;  lines: +7 -5
Fixed bug in which p2c_arity is called on a string; in building a string answer
to return to C-caller.
----------------------------
revision 1.41
date: 2002/08/07 16:15:12;  author: lfcastro;  state: Exp;  lines: +10 -1
* make is_* functions dereference their arguments; fixes bug reported
  by Roberto Bagnara
----------------------------
revision 1.40
date: 2002/06/02 18:43:44;  author: kifer;  state: Exp;  lines: +4 -1
branches:  1.40.2;
made print_pterm aware of attributed variables
----------------------------
revision 1.39
date: 2002/01/23 17:08:08;  author: dwarren;  state: Exp;  lines: +7 -7
branches:  1.39.2;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.38
date: 2001/07/12 00:21:13;  author: kifer;  state: Exp;  lines: +7 -1
added is_atom/1
----------------------------
revision 1.37
date: 2001/07/06 18:19:42;  author: kifer;  state: Exp;  lines: +2 -2
Exported print_pterm, VarStrOps for windows compilation
----------------------------
revision 1.36
date: 2001/05/13 21:01:20;  author: kifer;  state: Exp;  lines: +2 -2
a workaround for fmt_print("%s", a("")).
----------------------------
revision 1.35
date: 2001/03/17 05:44:02;  author: kifer;  state: Exp;  lines: +13 -13
improved error messages
----------------------------
revision 1.34
date: 2000/06/28 16:54:49;  author: ruim;  state: Exp;  lines: +4 -4
branches:  1.34.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.33
date: 2000/05/20 06:55:56;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.32
date: 2000/04/29 21:53:51;  author: kifer;  state: Exp;  lines: +58 -58
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.31
date: 2000/03/15 06:17:21;  author: kifer;  state: Exp;  lines: +3 -3
fixed warnings in c2p_list/nil
----------------------------
revision 1.30
date: 2000/02/23 18:24:00;  author: dwarren;  state: Exp;  lines: +3 -3
Documentation of new c_calling_xsb routines that don't require
varString.  (and fixed some table typos in doc, and added return code
of 3 for answer overflow.)
----------------------------
revision 1.29
date: 2000/02/22 22:38:03;  author: dwarren;  state: Exp;  lines: +76 -9
Extrended interface so that it could interact with VB, and
particularly the MR application.  Also added an option -q to send all
I/O to files (for use when XSB is being used as a backen server.)
----------------------------
revision 1.28
date: 2000/01/07 08:51:21;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.27
date: 1999/12/22 05:10:10;  author: cbaoqiu;  state: Exp;  lines: +7 -1
Added changes to support attributed variables in assert.
----------------------------
revision 1.26
date: 1999/12/21 22:56:35;  author: warren;  state: Exp;  lines: +4 -4
cleanup to reduce number of warnings given by MSVC compiler.
----------------------------
revision 1.25
date: 1999/12/10 07:47:29;  author: kifer;  state: Exp;  lines: +2 -2
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.24
date: 1999/11/29 00:30:13;  author: kifer;  state: Exp;  lines: +100 -112
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.23
date: 1999/11/17 03:54:25;  author: kifer;  state: Exp;  lines: +6 -6
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.22
date: 1999/11/16 19:05:52;  author: kifer;  state: Exp;  lines: +2 -2
Revamped sockets interface.
----------------------------
revision 1.21
date: 1999/10/26 06:46:52;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.20
date: 1999/10/25 05:57:32;  author: kifer;  state: Exp;  lines: +5 -5
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.19
date: 1999/10/05 04:01:20;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.18
date: 1999/09/18 21:14:20;  author: kifer;  state: Exp;  lines: +2 -2
warning files are now in build instead of /tmp/
----------------------------
revision 1.17
date: 1999/07/05 06:13:04;  author: kifer;  state: Exp;  lines: +3 -2
added xsb_sprint_variable to fix the problem with printing vars in
print_pterm: cinterf.c (now fmt_write('%S', f(V)) prints vars the same
way as write(V) does).
----------------------------
revision 1.16
date: 1999/06/27 04:58:31;  author: kifer;  state: Exp;  lines: +5 -1
is_charlist now accepts ""
----------------------------
revision 1.15
date: 1999/06/22 03:20:06;  author: kifer;  state: Exp;  lines: +2 -2
Increased the size of tempstring
----------------------------
revision 1.14
date: 1999/06/17 07:50:58;  author: kifer;  state: Exp;  lines: +3 -2
Added a new builtin: is_charlist/1 and /2
----------------------------
revision 1.13
date: 1999/06/09 17:30:07;  author: luis;  state: Exp;  lines: +54 -3
* introduced is_chars()
----------------------------
revision 1.12
date: 1999/06/04 17:55:14;  author: luis;  state: Exp;  lines: +14 -14
Minor bugfixes for Windows installation
----------------------------
revision 1.11
date: 1999/06/04 16:43:44;  author: kifer;  state: Exp;  lines: +5 -1
Provided declarations for p_to_c_charlist, c_to_p_charlist
----------------------------
revision 1.10
date: 1999/06/02 14:57:56;  author: luis;  state: Exp;  lines: +15 -1
Introduced functions to export lists of chars as strings (and vice-versa)
----------------------------
revision 1.9
date: 1999/05/01 22:38:03;  author: kifer;  state: Exp;  lines: +21 -15
Changed calling sequence for p_charlist_to_c_string to avoid buffer
overruns.
----------------------------
revision 1.8
date: 1999/04/28 18:30:20;  author: kifer;  state: Exp;  lines: +9 -8
Added the regmatch package.
----------------------------
revision 1.7
date: 1999/04/27 14:39:43;  author: kifer;  state: Exp;  lines: +108 -1
Made large builtins in the former std_pred.i into inlined subroutines.
Added atom_codes, number_codes and made atom_chars, number_chars into
synonyms to the *_codes builtins.
----------------------------
revision 1.6
date: 1999/04/04 03:54:47;  author: kifer;  state: Exp;  lines: +13 -15
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.5
date: 1999/03/02 01:00:55;  author: kifer;  state: Exp;  lines: +16 -2
(xsb_init_string): make sure that command line is first copied into a
new string. Otherwise, NT would bark.
----------------------------
revision 1.4
date: 1999/02/18 13:02:16;  author: kostis;  state: Exp;  lines: +4 -2
Changes to check for trail stack overflow in pushtrail0().
----------------------------
revision 1.3
date: 1998/11/19 05:24:19;  author: kifer;  state: Exp;  lines: +11 -9
changed so that C program calling XSb would only pass the top xsb
directory instead of the executable directory
----------------------------
revision 1.2
date: 1998/11/18 07:59:14;  author: kifer;  state: Exp;  lines: +21 -1
Moved initialization of executable, user_home, xsb_config_file to the
new file self_orientation. Added initialization like in xmain.c to
xsb_init in cinterf.c. This should fix the C-calling xsb interface.
----------------------------
revision 1.1
date: 1998/11/05 16:55:13;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:13;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.34.2.2
date: 2000/12/19 15:58:13;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.34.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +82 -3
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.39.2.2
date: 2004/10/18 20:45:58;  author: ruim;  state: Exp;  lines: +46 -13
update for version 2.6.1
----------------------------
revision 1.39.2.1
date: 2004/09/29 19:44:10;  author: ruim;  state: Exp;  lines: +105 -99
Sources from rfm repository
----------------------------
revision 1.40.2.2
date: 2003/04/17 17:11:52;  author: lfcastro;  state: Exp;  lines: +18 -8
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.40.2.1
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +10 -1
* update to HEAD
----------------------------
revision 1.98.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.98.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.98.2.1
date: 2010/06/19 19:36:19;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/cinterf.h,v
Working file: cinterf.h
head: 1.58
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.57
	ROLLBACK: 1.52
	latest_plus_supp_branch: 1.52.0.2
	latest_plus_supp: 1.52
	Version_3dot2_plus_supp: 1.49.0.2
	release_2_6_plus_supp: 1.19.0.4
	Version_3dot2: 1.49
	dec07-perf-results: 1.46
	mt_thesis: 1.33
	release_3_0: 1.32
	release_2_7_0: 1.19
	multi-threaded-26-engine: 1.17.6.2
	pre-mt: 1.19
	multi-threaded-25-engine-done: 1.17.6.1
	multi-threaded-25-engine: 1.17.0.6
	release_2_6_1: 1.19
	release_2_6_final: 1.19
	release_2_6: 1.19.0.2
	last-merged-to-demand: 1.17
	demand_branch: 1.17.0.4
	before_removing_chat: 1.17
	release_2_5: 1.17
	pre-merge-slgwam-gc: 1.17
	multi-threaded-c-engine: 1.17.0.2
	release_2_4: 1.17
	release_2_3: 1.15
	multi-threaded-engine: 1.14.0.2
	pre-threading: 1.14
	release-2-2: 1.12
	chat-and-local: 1.12.0.2
	xsb-pre-cleanup: 1.12
	release-2-1: 1.8
	release-2-0-1: 1.8
	subsumption: 1.8
	without-attv: 1.8
	release-2-0: 1.8
	pre-release-2-0: 1.3
	v1-9-8: 1.3
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.3
	r1-9-b6: 1.3
	r1-9-b5: 1.3
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 71;	selected revisions: 71
description:
----------------------------
revision 1.58
date: 2012/02/18 04:46:54;  author: kifer;  state: Exp;  lines: +2 -2
minated some compiler warnings
added DllExport to find_string, mem_alloc, mem_realloc.
----------------------------
revision 1.57
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.56
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.55
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.54
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.53
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.52
date: 2010/05/21 23:31:38;  author: kifer;  state: Exp;  lines: +5 -3
branches:  1.52.2;
added DllExport to p_charlist_to_c_string and c_string_to_p_charlist
----------------------------
revision 1.51
date: 2010/05/02 05:11:26;  author: evansbj;  state: Exp;  lines: +64 -10
Update to make thread_exit/1, and xsb_kill_thread work from the C interface. It passes the regression tests as well as before, better actually.
----------------------------
revision 1.50
date: 2010/03/18 22:22:17;  author: tswift;  state: Exp;  lines: +2 -5

Added subgoal depth check with actions of fail and error (cf pg. 165 of the manual)
----------------------------
revision 1.49
date: 2008/10/07 02:23:23;  author: kifer;  state: Exp;  lines: +2 -1
included shdlib.h so it'll compile under windows.
----------------------------
revision 1.48
date: 2008/05/07 15:08:31;  author: dwarren;  state: Exp;  lines: +4 -1
To make snprintf available where it is not needed in systems
in which it is not in the library (as MSWIN)
----------------------------
revision 1.47
date: 2008/03/27 19:55:16;  author: tswift;  state: Exp;  lines: +4 -1

A few minor changes for error handling:

Improved error reporting for predicates that call the new C
convert_to_dyna()

Introduced iso_ptoc_callable_arg(), (for now, used only in convert_to_dyna())
----------------------------
revision 1.46
date: 2007/10/09 17:15:04;  author: dwarren;  state: Exp;  lines: +3 -1
These changes implement a facility that allows a routine called from
XSB as foreign code to call a predicate back in XSB.  This allows
mutual recursion between XSB and foreign code (and has been tested by
programming a recursive fibonacci in which the Prolog code calls C for
the samller values and C calls Prolog for its smaller values.)

It is similar to the "C calling XSB" interface, with the following
differences:

1. Do not call xsb_init or xsb_init_string.  These functions
initialize XSB, which clearly cannot be done if XSB is already
running.

2. A foreign routine called from XSB that wants to call an XSB
predicate must first call:
	xsb_query_save(NumRegs)

It must do this after retrieving its input parameters from XSB and
before calling any XSB predicate.  NumRegs must be the number of XSB
registers that the current foreign code uses (i.e., the number of
arguments of the XSB predicate used to call this foreign code
routine.)  This call saves the caller registers and sets up the XSB
state to accept queries from the foreign code.  (This is similar to
the XSB state after xsb_init is called.)  So after this call, the
foreign routine can use any of the interface routines for calling XSB,
such as xsb_command, xsb_command_string, xsb_query, xsb_query_string,
etc.

3. Before setting its output parameters and returning to its caller,
the foreign routine must call
	xsb_query_restore()

This restores the XSB parameter registers back to their state when
xsb_query_save() was called, and so prepares the registers to accept
the return values.  (It must be called even if there are no values to
be returned.)

This code works (according to my tests) for the single-threaded
engine.  It does NOT currently work for the multi-threaded engine.
I've put in the necessary CTXT- stuff, but still get crashes.  I'm
sure it can be made to work, but may need help in figuring out how.
----------------------------
revision 1.45
date: 2007/10/07 17:37:54;  author: tswift;  state: Exp;  lines: +9 -9

Two sets of changes.

First, was to add const declaration modifiers to external ctop and
ptoc routines.  Apparently some C++ compilers can benefit from this
modifier, and it should help the Parma polyhedra group and others who
call XSB from C++.

The second change supports call_cleanup, and fixes a minor bug in the
implementation of catch (see the emails on the XSB group).  This
update does not handle cutting over call cleanup -- I'll try to get
that in soon.
----------------------------
revision 1.44
date: 2007/08/18 19:55:20;  author: tswift;  state: Exp;  lines: +2 -1
Made thread_entry() visible to help setting up arrays to threads in Interprolog and XSB.net.
----------------------------
revision 1.43
date: 2007/07/21 16:24:18;  author: ruim;  state: Exp;  lines: +1 -2
fixed find_context to work during xsb initialization
----------------------------
revision 1.42
date: 2007/07/07 21:02:07;  author: tswift;  state: Exp;  lines: +3 -1
-- Added usleep

-- Fixed concurrency bug with thread aliases in thread create.

-- made thread_join/thread_detach allow thread aliases
on input, and isoified their errors

-- Makde thread_self allow thread aliases on input.  The errors for
   this predicate different from ISO -- I dont really with their error
   designation in this case (at least not yet).

-- made thread_join, thread_detach, and thread_exit all properly
   remove aliases if applicable

-- Brought thread exit statuses in line with ISO working standard
   (mostly -- for now, we still have a cancelled status)

-- Added numerous tests for thread manipulation predicates to mttests.
----------------------------
revision 1.41
date: 2007/06/24 19:03:22;  author: tswift;  state: Exp;  lines: +8 -4
Changes to support thread aliases and other ISO functionality.
----------------------------
revision 1.40
date: 2007/06/10 18:43:57;  author: tswift;  state: Exp;  lines: +3 -1

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.39
date: 2007/04/03 13:59:44;  author: dwarren;  state: Exp;  lines: +22 -22
Fixed to compile with MSVC:
A few too many call_conv's in cinterf.h and not enough in cinterf.c
----------------------------
revision 1.38
date: 2007/04/03 10:22:34;  author: tswift;  state: Exp;  lines: +31 -45

Updated register-level C API functions so that an XSB thread can
be called from a different C thread.

There are progressively more complicated examples for how to use
the register-level interface in examples/c_calling_xsb --
cregs.c, cregs_thread.c and cregs_thread2.c, which can be made
via make.P make_thread.P and make_thread2.P and I think I
documented everything in the manual.

Also, I made some macros in the new interface into functions so
they can be dynamically linked and Windows would be happy.  I
tried to follow the pattern of other Windows code, but nobody
should trust me regarding Windows stuff :-)

Finally, I initialized signal handlers in xcallxsb.P
----------------------------
revision 1.37
date: 2007/02/22 00:16:04;  author: tswift;  state: Exp;  lines: +47 -1


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.36
date: 2007/01/25 20:33:54;  author: tswift;  state: Exp;  lines: +31 -24


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.35
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +37 -1

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.34
date: 2006/12/14 21:59:45;  author: tswift;  state: Exp;  lines: +8 -8

Added some CTXTc's to support the MT engine.
----------------------------
revision 1.33
date: 2006/09/14 16:13:55;  author: crojo;  state: Exp;  lines: +3 -1
Added two new routines to the C interface:

pipe_xsb_stdin()
  This splits XSB's stdin stream into a read end and a
  write end. The read end takes the place of the original stdin, and
  the write end is accessable through a call to write_to_xsb_stdin,
  another c interface routine. These two calls can be used to pass
  input to a thread running xsb.dll code that is blocking waiting for
  input from stdin. They allow separate threads to interact with the
  interpreter or the trace debugger when xsb is loaded as a DLL.

writeln_to_xsb_stdin(char *)
  This can be called after a call to  pipe_xsb_stdin, and writes a string
  of characters to the write end of xsb's piped stdin stream. If a thread
  running xsb.dll code is blocking on input from stdin, this will unblock
  it.

I've modified the way output is redirected to files on WIN_NT when XSB
is initialized through the C interface. The output files are now sharable.
I've also changed the spacing in call_graph_xsb.c to fix compilation problems
on windows.
----------------------------
revision 1.32
date: 2006/07/02 18:36:28;  author: tswift;  state: Exp;  lines: +3 -3
builtin.c and cinterf.h -- change for MT engine

gc_slide: small changes in documentation.
----------------------------
revision 1.31
date: 2006/06/23 18:26:02;  author: tswift;  state: Exp;  lines: +3 -2

Added a few new extern types.
----------------------------
revision 1.30
date: 2006/06/23 14:53:10;  author: tswift;  state: Exp;  lines: +16 -5

Added extern_ macros for C interface functions not yet covered.

Change to box_defines.h to get rid of whitespace before #endif (non-portable)
----------------------------
revision 1.29
date: 2006/06/19 18:23:19;  author: tswift;  state: Exp;  lines: +22 -12

Some additional changes to support the low-level C interface fromt he MT engine.
----------------------------
revision 1.28
date: 2006/06/11 21:35:10;  author: tswift;  state: Exp;  lines: +22 -1



Changes to make the low-level C interface work with the multi-threaded
engine.  The changes are as follows:

1) call_forn now calls a single-parameter function with CTXT in the MT
   engine, while the sequential engine calls a parameterless function.

2) Compiltion of a foreign file (foreign.P) now writes a different
   magic number depending on whether the compilation was done with the
   sequential or multi-threaded engine.  Then when consulting the file
   (in consult.P) a recompile is forced if the compiled file was
   compiled by MT if seq, and seq if MT.

3) Some C interface functions require a thread context to be passed
   and some dont, so I added some defines to handle this of the form

      extern_ptoc_xxx
      extern_ctop_xxx
      extern_p2p_xxx
      extern_p2c_xxx
      extern_p2p_xxx
----------------------------
revision 1.27
date: 2006/05/05 21:38:02;  author: dwarren;  state: Exp;  lines: +2 -1
Added new routine to be called externally, to expand heap to ensure there
is enough space for expected c2p_functor and c2p_list calls.
----------------------------
revision 1.26
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +2 -2


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.25
date: 2005/11/09 17:52:27;  author: dwarren;  state: Exp;  lines: +2 -2
Allowed file_open on strings to take code-lists (actually it already could,
but had a bug), and then changed xsb_query_string to build a code-list for
the query on the heap to avoid interning the goal.  And fixed c2p_chars (which
might better be called c2p_codes) to check for heap overflow.  This fixes a
"memory leak" from code calling XSB, pointed out by Michael.
----------------------------
revision 1.24
date: 2005/07/18 21:54:08;  author: crojo;  state: Exp;  lines: +2 -2
*** empty log message ***
----------------------------
revision 1.23
date: 2005/07/15 14:48:53;  author: dwarren;  state: Exp;  lines: +2 -2
Made getting last answer (when answer length overflows buffer) thread-safe.
----------------------------
revision 1.22
date: 2005/06/29 13:58:13;  author: vidrevich;  state: Exp;  lines: +3 -3
incorporating multi-threading into C/XSB interface. In multi-threaded engine xsb_init() takes a pointer to the thread context structure as its first argument and populates that structure with main thread context information to be used in the consequent C/XSB calls. myargc,myargv are passed as the second and the third arguments to the xsb_init() when XSB is configured for multi-threading. Changes should not affect a single-threaded version.
----------------------------
revision 1.21
date: 2005/04/27 04:20:14;  author: evansbj;  state: Exp;  lines: +2 -1
Updated stderr and stdout redirection available via the -q parameter
----------------------------
revision 1.20
date: 2005/01/14 18:30:53;  author: ruim;  state: Exp;  lines: +43 -36
Integration of multithreaded system
----------------------------
revision 1.19
date: 2003/02/21 16:43:09;  author: lfcastro;  state: Exp;  lines: +2 -2
* p2c_chars had its interface modified, rendering its uses (most notably, the high-level C interface) broken. Change it back to its original interface.
----------------------------
revision 1.18
date: 2002/08/08 17:58:21;  author: lfcastro;  state: Exp;  lines: +12 -1
* insert multiple inclusion guard & c++ wrapper as suggested by
Roberto Bagnara
----------------------------
revision 1.17
date: 2001/07/12 00:21:13;  author: kifer;  state: Exp;  lines: +2 -1
branches:  1.17.4;  1.17.6;
added is_atom/1
----------------------------
revision 1.16
date: 2001/07/06 18:19:42;  author: kifer;  state: Exp;  lines: +2 -2
Exported print_pterm, VarStrOps for windows compilation
----------------------------
revision 1.15
date: 2000/11/22 15:31:23;  author: dwarren;  state: Exp;  lines: +2 -1
Added ptoc_longstring which is like ptoc_string, except that it
accepts a complex structure from Prolog and turns it into a C string.
It accepts lists, regular and ,-separated, containing atoms or small
integers, and constructs a string by concatenating the atoms or chars.
Small ints represent their ascii codes.  It is recursive.  This makes
it easier to send a long string across the C interface, without having
to construct a new atom for it.
----------------------------
revision 1.14
date: 2000/06/17 23:28:52;  author: kifer;  state: Exp;  lines: +3 -1
branches:  1.14.2;
fixed bugs in p_charlist_to_c_string.
Deleted the last argument from file_read_line_*
preds.
Removed the restriction that Lines must be under MAX_IO_SIZE
----------------------------
revision 1.13
date: 2000/04/29 21:53:51;  author: kifer;  state: Exp;  lines: +34 -34
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.12
date: 2000/02/22 22:38:03;  author: dwarren;  state: Exp;  lines: +4 -1
Extrended interface so that it could interact with VB, and
particularly the MR application.  Also added an option -q to send all
I/O to files (for use when XSB is being used as a backen server.)
----------------------------
revision 1.11
date: 1999/12/22 05:10:11;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Added changes to support attributed variables in assert.
----------------------------
revision 1.10
date: 1999/12/10 07:47:30;  author: kifer;  state: Exp;  lines: +3 -2
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.9
date: 1999/11/29 00:30:14;  author: kifer;  state: Exp;  lines: +11 -5
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.8
date: 1999/06/17 07:51:00;  author: kifer;  state: Exp;  lines: +3 -2
Added a new builtin: is_charlist/1 and /2
----------------------------
revision 1.7
date: 1999/06/09 17:30:35;  author: luis;  state: Exp;  lines: +2 -1
* introduced is_chars()
----------------------------
revision 1.6
date: 1999/06/02 14:59:45;  author: luis;  state: Exp;  lines: +4 -1
Introduced functions to export lists of chars as strings (and vice-versa)
----------------------------
revision 1.5
date: 1999/05/25 13:26:36;  author: luis;  state: Exp;  lines: +1 -12
C interface cleanup, 2nd phase
----------------------------
revision 1.4
date: 1999/05/03 00:55:40;  author: luis;  state: Exp;  lines: +12 -11
* changes regarding exporting functions under Windows
----------------------------
revision 1.3
date: 1998/11/17 01:56:44;  author: kifer;  state: Exp;  lines: +3 -12
Changed so that basictypes.h could be included multiple times.
Moved prolog_int and such from cinterf to basictypes.h
----------------------------
revision 1.2
date: 1998/11/14 05:05:23;  author: kifer;  state: Exp;  lines: +1 -2
djusted casts because now bool is typedef short, for NT compatibility.
----------------------------
revision 1.1
date: 1998/11/05 16:55:13;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:13;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.14.2.2
date: 2000/12/19 15:58:13;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.14.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +9 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.17.6.2
date: 2004/10/18 20:45:59;  author: ruim;  state: Exp;  lines: +13 -2
update for version 2.6.1
----------------------------
revision 1.17.6.1
date: 2004/09/29 19:44:10;  author: ruim;  state: Exp;  lines: +43 -36
Sources from rfm repository
----------------------------
revision 1.17.4.5
date: 2003/04/17 17:11:52;  author: lfcastro;  state: Exp;  lines: +2 -3
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.17.4.4
date: 2002/08/10 00:19:33;  author: lfcastro;  state: Exp;  lines: +12 -4
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.17.4.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +3 -0
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.17.4.2
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +1 -4
* update to HEAD
----------------------------
revision 1.17.4.1
date: 2002/08/07 17:41:37;  author: lfcastro;  state: Exp;  lines: +4 -1
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.52.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.52.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.52.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/cinterf_defs.h,v
Working file: cinterf_defs.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.2
	latest_plus_supp: 1.2
keyword substitution: kv
total revisions: 11;	selected revisions: 11
description:
----------------------------
revision 1.8
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +1 -0

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.7
date: 2011/06/05 19:24:03;  author: tswift;  state: Exp;  lines: +4 -0



Changes to

1) Add flag-controlled answer depth checks to variant answer
tables.  (See current_prolog_flag in the manual for details).

2) In support of 1, added sprint_term, which prints a term to a C
string.  This is useful for errors and warnings invoked by C.

3) Added MAXTOINDEX_FLAG, which allows experimentation with the
depth of * indexing.

4) Increased the initial size strbuff from 1000 -> 10000.  This
reduces spurious long atom warnings.
----------------------------
revision 1.6
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/04/03 23:53:36;  author: evansbj;  state: Exp;  lines: +2 -0
branches:  1.2.2;
It turns out that pthread_cond_wait can return for reasons other than just the expected signal condition. It should be in a tight while loop that checks an expected state change in something like xsb_ready. Just to be sure that the C thread and the Prolog thread don't collide in signal rich environments.
----------------------------
revision 1.1
date: 2010/03/18 22:22:17;  author: tswift;  state: Exp;

Added subgoal depth check with actions of fail and error (cf pg. 165 of the manual)
----------------------------
revision 1.2.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.2.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/com_0002fxsb_0002finterprolog_0002fNativeEngine.h,v
Working file: com_0002fxsb_0002finterprolog_0002fNativeEngine.h
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	release_2_6_plus_supp: 1.1.0.8
	multi-threaded-26-engine: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.6
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.4
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.2
	before_removing_chat: 1.1
	release_2_5: 1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.3
date: 2004/10/15 02:13:30;  author: kifer;  state: dead;  lines: +0 -0
re autogenerated
----------------------------
revision 1.2
date: 2004/05/18 13:42:46;  author: tswift;  state: Exp;  lines: +56 -56
Added BACKTRACE flag
----------------------------
revision 1.1
date: 2002/02/22 16:34:47;  author: tswift;  state: Exp;
renamed header file for interprlog
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/com_xsb_interprolog_NativeEngine.h,v
Working file: com_xsb_interprolog_NativeEngine.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	release_2_6_plus_supp: 1.2.0.8
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.5
	release_3_0: 1.5
	release_2_7_0: 1.5
	multi-threaded-26-engine: 1.2
	pre-mt: 1.5
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.6
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.4
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.2
	before_removing_chat: 1.2
	release_2_5: 1.2
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.9
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2004/10/15 05:34:38;  author: kifer;  state: Exp;  lines: +0 -0
branches:  1.5.4;
readded
----------------------------
revision 1.4
date: 2004/10/15 02:13:30;  author: kifer;  state: dead;  lines: +0 -0
re autogenerated
----------------------------
revision 1.3
date: 2004/01/16 20:53:30;  author: dwarren;  state: Exp;  lines: +74 -58
Added capability to pass arguments to xsb executable when starting xsb
from java.
----------------------------
revision 1.2
date: 2002/02/21 21:20:40;  author: tswift;  state: Exp;  lines: +17 -17
Another iteration towards interprolog integration.
----------------------------
revision 1.1
date: 2002/02/18 04:03:38;  author: tswift;  state: Exp;
Initial version of interprolog files
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/complete.i,v
Working file: complete.i
head: 1.20
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.18
	without-attv: 1.13
	release-2-0: 1.11
	pre-release-2-0: 1.11
	v1-9-8: 1.9
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 21;	selected revisions: 21
description:
----------------------------
revision 1.20
date: 1999/10/25 05:57:35;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.19
date: 1999/10/18 18:57:48;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Fixed a problem with the declaration of a local variable tmp.
----------------------------
revision 1.18
date: 1999/10/15 17:32:50;  author: cbaoqiu;  state: Exp;  lines: +20 -5
Changed some places where `template_size' appears, so that attv_num in
the substitution factor is considered.  Functions
table_answer_search() and variant_answer_search() are also modified to
accept one more argument -- attv_num.
----------------------------
revision 1.17
date: 1999/10/15 02:54:12;  author: cbaoqiu;  state: Exp;  lines: +6 -4
Changed functions table_consume_answer() and load_solution_trie() to
take one more argument, attv_num (the number of attributed variables
in the substitution factor).
----------------------------
revision 1.16
date: 1999/10/13 13:59:22;  author: ejohnson;  state: Exp;  lines: +3 -3
Fix comment indentation.
----------------------------
revision 1.15
date: 1999/10/12 20:08:03;  author: ejohnson;  state: Exp;  lines: +70 -51
Modified sections which return an answer to a suspended subgoal.
If the subgoal is properly subsumed, then answers may need to be
retrieved from the producer for consumption.
----------------------------
revision 1.14
date: 1999/10/09 18:37:53;  author: kostis;  state: Exp;  lines: +63 -52
Cleanup changes so that variables are declared and appear only in places
where they are actually needed.  Expect speed-up by doing so.
Also, finally, ugly xtemp[3-15] variables were eliminated.
Sorry, Terry !
----------------------------
revision 1.13
date: 1999/09/18 04:39:41;  author: cbaoqiu;  state: Exp;  lines: +8 -5
Put some delay-variable stuff into ``#ifndef IGNORE_DELAYVAR'' (to
help Kostis debug).  By doing this, we make sure that no substitution
factor of the answer is put into the heap.  [To disable delay-variable
handling, one can put ``#define IGNORE_DELAYVAR'' in the file
$XSB/emu/debugs/debug_delay.h.]
----------------------------
revision 1.12
date: 1999/07/06 16:35:07;  author: ejohnson;  state: Exp;  lines: +2 -3
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.11
date: 1999/04/22 06:49:12;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.10
date: 1999/02/23 10:50:48;  author: kostis;  state: Exp;  lines: +4 -2
Changes to tag number of substitution factor variables in the CP stack and
to considerably speed up garbage collection - many changes in heap.c.
----------------------------
revision 1.9
date: 1999/02/04 21:58:25;  author: kostis;  state: Exp;  lines: +44 -42
Fixed some minor memory leak in the handling of non-stratified negation in
CHAT and rearranged some code so that the structrure is more clear.
----------------------------
revision 1.8
date: 1999/01/29 04:18:18;  author: cbaoqiu;  state: Exp;  lines: +2 -4
Changed string_find("ret", 1) to ret_psc[0].  ret_psc[0] is set at the
time when the system is started.
----------------------------
revision 1.7
date: 1999/01/28 09:00:58;  author: cbaoqiu;  state: Exp;  lines: +15 -7
Changed the call of delay_positively() so that the SUBSF is not always
a CS pointer (it can be a string "ret").
----------------------------
revision 1.6
date: 1999/01/18 17:59:32;  author: kostis;  state: Exp;  lines: +32 -42
Changes to make ptcp pointing to subgoal frame independently of engine used.
----------------------------
revision 1.5
date: 1999/01/12 23:14:14;  author: cbaoqiu;  state: Exp;  lines: +8 -1
Added `delay_it = 1' before return an anwer in LOCAL mode.
----------------------------
revision 1.4
date: 1998/12/22 09:17:59;  author: kostis;  state: Exp;  lines: +1 -2
Fixed problem related to local scheduling.
----------------------------
revision 1.3
date: 1998/12/21 01:08:06;  author: cbaoqiu;  state: Exp;  lines: +98 -103
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:05:52;  author: cbaoqiu;  state: Exp;  lines: +39 -8
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  The call of delay_positively() in check_complete is changed.
----------------------------
revision 1.1
date: 1998/11/05 16:55:13;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:13;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/complete_local.h,v
Working file: complete_local.h
head: 1.41
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.34
	ROLLBACK: 1.27
	latest_plus_supp_branch: 1.23.0.2
	latest_plus_supp: 1.23
	Version_3dot2_plus_supp: 1.19.0.2
	release_2_6_plus_supp: 1.6.0.6
	Version_3dot2: 1.19
	dec07-perf-results: 1.14
	mt_thesis: 1.14
	release_3_0: 1.13
	release_2_7_0: 1.7
	multi-threaded-26-engine: 1.4.2.3
	pre-mt: 1.7
	multi-threaded-25-engine-done: 1.4.2.1
	multi-threaded-25-engine: 1.4.0.2
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.4
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.2
keyword substitution: kv
total revisions: 50;	selected revisions: 50
description:
----------------------------
revision 1.41
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +17 -2

Integrating in Call Abstraction
----------------------------
revision 1.40
date: 2011/08/19 21:44:15;  author: tswift;  state: Exp;  lines: +2 -5

Mostly minor changes to let ctrace print out early completion, and to
allow ctrace to be directed to stdout rather than a file if desired.
This necessitated some minor code refactoring.
----------------------------
revision 1.39
date: 2011/08/19 18:26:30;  author: tswift;  state: Exp;  lines: +2 -2

Changes to support Ctrace (Fview).
----------------------------
revision 1.38
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +10 -1

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.37
date: 2011/07/02 14:27:38;  author: tswift;  state: Exp;  lines: +10 -1

More updates for C-level trace.
----------------------------
revision 1.36
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +5 -5

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.35
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +3 -3

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.34
date: 2010/09/30 22:49:10;  author: tswift;  state: Exp;  lines: +6 -3

Provisional change to fix strict_po.
----------------------------
revision 1.33
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +13 -14
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.32
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.31
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.30
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.29
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.28
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +14 -13
no message
----------------------------
revision 1.27
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.26
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.25
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -1
Backed out code
----------------------------
revision 1.24
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +2 -1
Dipti's code for support graph added
----------------------------
revision 1.23
date: 2010/01/23 19:03:02;  author: tswift;  state: Exp;  lines: +6 -6
branches:  1.23.2;

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.22
date: 2009/11/08 18:29:21;  author: tswift;  state: Exp;  lines: +2 -2

No functionality changes -- just some name changes and simplifications
in preparation for my trip to Portugal.

These were mostly name changes, but I did get rid of a few functions
-- not for efficiency but for simplicity.
----------------------------
revision 1.21
date: 2009/07/30 19:01:28;  author: tswift;  state: Exp;  lines: +11 -10


Moved flag definition of answer completion to flag_defs.h

Commented out call to answer_completion (which was also giving an
error since SCC_delayed was undefined) until Alexandre gets back from
vacation.
----------------------------
revision 1.20
date: 2009/07/24 10:27:18;  author: alexandrempinto;  state: Exp;  lines: +46 -36
Incremental Answer Completion: merge and commit
----------------------------
revision 1.19
date: 2009/02/21 16:47:33;  author: tswift;  state: Exp;  lines: +4 -4

Changes to support

statistics/2
Rui's fix for the mt bug

along with scratch code for answer_completion.
----------------------------
revision 1.18
date: 2009/01/03 01:11:26;  author: tswift;  state: Exp;  lines: +1 -3

Changes were mostly for documentation and code refactoring.

However, also fixed a latent bug in simplification where
was_simplifiable was not properly checking negative delay elements
corresponding to subsumed subgoal frames.  This led to the possibility
of adding un-needed delay elements that might not have been simplified
away.  Surprisingly enough, however, none of the tests in the test
suite checked for this.
----------------------------
revision 1.17
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +23 -2


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.16
date: 2008/06/05 23:28:18;  author: ruim;  state: Exp;  lines: +12 -10
improvements for shared completed tables:
	decreased lock time on completion
	avoided waking up threads for private tables
----------------------------
revision 1.15
date: 2008/06/05 18:15:11;  author: ruim;  state: Exp;  lines: +13 -1
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.14
date: 2006/11/08 17:06:33;  author: ruim;  state: Exp;  lines: +1 -4
solved bug in CONC_COMPL involving completion stack expansion
taken out some unneeded ifded CONC_COMPL
----------------------------
revision 1.13
date: 2005/11/17 23:24:24;  author: tswift;  state: Exp;  lines: +3 -1



Added new mutex, MUTEX_DELAY to synchronize management of de-s
dl-s and pnde-s.  For now, memory management of these data
structures uses common global variables, even in private tables,
hence the need for a mutex.

My placing of the mutexes within the code is still a little
uncertain.  On the one hand, I've over approximated a little so
that (I think) any of the memory management routines are covered.
I've also covered simplification routines (which do not directly
call the mem-management routines), though I'm not entirely
certain that the mutexes are needed there with shared tables and
our algorithm for shared concurrent tables.  More insight on
mutexes and simplification will undoubtedly come with paper
writing.

In addition, we should think in the future about managing de-s,
dl-s and pnde's for private tables using thread-specific memory
management routines.
----------------------------
revision 1.12
date: 2005/11/10 23:05:55;  author: tswift;  state: Exp;  lines: +4 -1

Removed some stray printfs.
----------------------------
revision 1.11
date: 2005/08/28 16:42:28;  author: ruim;  state: Exp;  lines: +4 -1
phase 1 of implementation of concurrent completion
----------------------------
revision 1.10
date: 2005/08/22 22:18:05;  author: tswift;  state: Exp;  lines: +45 -12

A little documentation.  Also removed an unnecessary and confusing CP assignment in ResumeCSFs() that is a remnant of old-style CSF Choice points.
----------------------------
revision 1.9
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +2 -2
made private flags array for sequential engine
----------------------------
revision 1.8
date: 2005/01/14 18:30:53;  author: ruim;  state: Exp;  lines: +8 -6
Integration of multithreaded system
----------------------------
revision 1.7
date: 2004/12/20 19:26:14;  author: dwarren;  state: Exp;  lines: +3 -2
hanged several int's to Integer's for safety.  There is more interest in
the 64-bit port, so I'd like to find the current bugs in it.  This might
be a start.
----------------------------
revision 1.6
date: 2002/05/20 17:47:09;  author: tswift;  state: Exp;  lines: +87 -1
branches:  1.6.2;

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.5
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -26
* Removal of Chat engine
----------------------------
revision 1.4
date: 2001/12/13 21:13:36;  author: lfcastro;  state: Exp;  lines: +9 -84
branches:  1.4.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.3
date: 2001/10/20 21:53:24;  author: lfcastro;  state: Exp;  lines: +4 -2
* fixed ProfileLeader dependence on LOCAL_EVAL
----------------------------
revision 1.2
date: 2001/10/01 19:48:29;  author: lfcastro;  state: Exp;  lines: +22 -9
* modified the resumption of completion suspension frames in SLGWAM in
  order to create chains with the original frames, instead of creating
  new ones on the CP stack
----------------------------
revision 1.1
date: 2001/09/24 17:23:52;  author: lfcastro;  state: Exp;
* attempt to cleanup and organize the completion algorithm for LOCAL
evaluation
----------------------------
revision 1.4.2.3
date: 2004/11/24 21:53:25;  author: ruim;  state: Exp;  lines: +2 -2
made smBTHT and smBTN thread specific
----------------------------
revision 1.4.2.2
date: 2004/10/18 20:45:59;  author: ruim;  state: Exp;  lines: +86 -25
update for version 2.6.1
----------------------------
revision 1.4.2.1
date: 2004/09/29 19:44:10;  author: ruim;  state: Exp;  lines: +7 -5
Sources from rfm repository
----------------------------
revision 1.6.2.3
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +2 -5
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.6.2.2
date: 2002/08/29 14:17:12;  author: lfcastro;  state: Exp;  lines: +15 -16
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.6.2.1
date: 2002/08/10 00:19:33;  author: lfcastro;  state: Exp;  lines: +17 -16
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.23.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.23.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +1 -0
no message
----------------------------
revision 1.23.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/complete_xsb_i.h,v
Working file: complete_xsb_i.h
head: 1.51
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.49
	ROLLBACK: 1.43
	latest_plus_supp_branch: 1.39.0.4
	latest_plus_supp: 1.39
	Version_3dot2_plus_supp: 1.39.0.2
	release_2_6_plus_supp: 1.19.0.6
	Version_3dot2: 1.39
	dec07-perf-results: 1.35
	mt_thesis: 1.33
	release_3_0: 1.30
	release_2_7_0: 1.19
	multi-threaded-26-engine: 1.17.2.2
	pre-mt: 1.19
	multi-threaded-25-engine-done: 1.17.2.1
	multi-threaded-25-engine: 1.17.0.2
	release_2_6_1: 1.19
	release_2_6_final: 1.19
	release_2_6: 1.19.0.4
	last-merged-to-demand: 1.19
	demand_branch: 1.19.0.2
	before_removing_chat: 1.17
	release_2_5: 1.17
	pre-merge-slgwam-gc: 1.15
	multi-threaded-c-engine: 1.15.0.2
	release_2_4: 1.13
	release_2_3: 1.9
	multi-threaded-engine: 1.7.0.2
	pre-threading: 1.5
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.3
	release-2-0-1: 1.3
keyword substitution: kv
total revisions: 62;	selected revisions: 62
description:
----------------------------
revision 1.51
date: 2012/02/12 22:49:12;  author: tswift;  state: Exp;  lines: +9 -12

Fixed bug in throwing exceptions with incomplete tables.  Now tables
are reclaimed by unwind stack so that they stop *between* SCCs: this
allows us to continue reclaiming incomplete tables while at the same
time ensuring that we wont backtrack into a choice point for one of
those tables that we reclaimed.
----------------------------
revision 1.50
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +3 -3

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.49
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -3
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.48
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.47
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.46
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.45
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.44
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +3 -1
no message
----------------------------
revision 1.43
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.42
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.41
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -1
Backed out code
----------------------------
revision 1.40
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +2 -1
Dipti's code for support graph added
----------------------------
revision 1.39
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +2 -1
branches:  1.39.4;


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.38
date: 2008/09/26 20:32:01;  author: tswift;  state: Exp;  lines: +9 -9

`Fixes the test pps while not breaking the tests dipti or wine.
The change is a 1-liner.  Other changes are for documentation and
(commented out) debugging.

----------------------------------------------------------------------

Keeping some log notes of the change in the CVS log -- this has proven
useful in understanding the history of minor tabling changes.

I've just spent a while analyzing the pps program to find out why a
cut-over choice point is improperly backtracked into.  Recall that
when I fixed this bug 3 years ago, I broke an example of Dipti's
(which is now in the test suite) along with the wine example.  Taking
out that change apparently fixes both examples.

A complex combination of events give rise to backtracking over a cut
choice point in local evaluation.  First, early completion must be
applied to a subgoal S that is not the leader in an SCC.  Next, the
generator/consumer choice point of S must never have been scheduled
for answer return.  And finally, the generator/consumer choice point
of S must be preceded by a cut-over choice point.

I realize that this is obscure, and I don't yet understand how to
explain it more cogently.  However, I do include 1) a pps program,
slightly modified with debugging info; 2) the debugging output; and 3)
a detailed explanation of what is going on.  I'm not sure whether
these details will be of help to anyone other than me.

Of course the real question is what to do.  My previous "fix" was to
ensure that non-leader GCPs pointed to the leader GCP in local
evaluation when the non-leader GCP was backtracked over and turned
into a CCP.  Exactly why this was causing a problem in the wine and
Dipti examples, I dont know, but I could see that it could be a
problem if there were a chain of non-leader GCPs linked by their
previous CP values.  So anyway, that fix wont work.

Thus, we want the previous CP of non-leader GCPs ot point to the
leader GCP after they have been turned into consumers (as long as they
are not part of a scheduling chain).  Making this adjustment when the
non-leader GCP is turned into a CCP is wrong, as we've seen.  However,
I do believe that making the adjustment at a different time is safe.
Accordingly I made a 1-line change to adjust the previous choice point
of non-leader GCPs to the leader GCP during *fixed-point check
performed by the leader*.

By the way, I really appreciate the work that Michael did to pare down
the bug example to the small pps program.  If it had been much more
complex, I doubt that I could have understood what was going on.

Terry


Its possible that rather than adjusting the non-leader GCPs to have
the leader GCP as their previous choice point when they are turned
into CCPs (which is wrong) this could be done at some other time.

One possibility is to make the adjustment at fixpoint check, as the
CCP (nee GCP) needs to be traversed to check if it has unreturned
answers anyway.

I'll think about doing making that change to the fixed point
computation.  However, at least for now I think the engine is
functioning properly for definite datalog programs without cuts -- at
least in terms of answer scheduling.

------------------------------------------------------------------------------------
% % % pps.P % % %

/* print_cp is more understandable when CP_DEBUG is defined */

:- import print_cp/0 from machine.

:- table w2/2, w3/3.

db(wrapper(app,_)).
db(wrapper(pps,_)).
db(wrapper(p,_)).

test:- w2(pps,foobar).
test1:- w2(pps,_foobar).

%% wrapper/2
w2(pps,_A) :-
%	print_cp,
	writeln(clause1w2(pps,_A)),
        w2(app,foobar),
        fail.
w2(app,_A) :-
	writeln(clause2w2(app,_A)),
	w3(p,_,foobar).
w2(X,Y) :-
	writeln(clause3(w2(X,Y))),
        db(wrapper(X,Y)),
        nl,
	print_cp,
        writeln('About to cut'),
        !,
	print_cp,
        fail.
%% Shouldn't go here after the cut!!!
w2(X,Y) :-
	writeln(clause4(w2(X,Y))),
        writeln('******fell through the cut!!! ' - X).

%% wrapper/3
w3(p,0,X):-
	writeln(clause1(w3(p,-,X))).
w3(p,_A,_B) :-
	writeln(clause2(w3(p,_A,_B))),
        w3(p,_,foobar),
	writeln(calling(w2(pps,foobar))),
        w2(pps,foobar).

------------------------------------------------------------------------------------
% % % Output % % %

| ?- test.
clause1w2(pps,foobar)
clause2w2(app,foobar)
clause1(w3(p,-,foobar))
clause2(w3(p,_h131,foobar))
calling(w2(pps,foobar))
clause3(w2(app,foobar))

About to cut
clause3(w2(pps,foobar))

About to cut
leader scheduling answers                            % printout from engine
performing early completion for: w2(app, foobar)(breg: 5c4c8c pcpf 5c4d18) % printout from engine
clause4(w2(pps,foobar))
******fell through the cut!!!  - pps
performing early completion for: w2(pps, foobar)(breg: 5c4da0 pcpf 5c4da0) % printout from engine
leader scheduling answers % printout from engine
calling(w2(pps,foobar))
leader scheduling answers % printout from engine


------------------------------------------------------------------------------------
% % % The prodigal choice point % % %

Step 1: Generator Choice Point created for w2(pps,foobar) (Failure
continuation set to check_complete)

Step 2: Regular choice point created for _$w2(pps,foobar), (_$w2/2 was
created to handle cut in a clause body of w2/2).

Step 3: GCP created for w2(app,foobar)

Step 4: Regular choice point created for _$w2(app,foobar)

Step 5: GCP created for w3(p,_,foobar)

Step 6: Answer created for w3(p,_,foobar), and Consumer Choice Point
created for w3(p,_,foobar)

Step 7: Answer w3(p,0,foobar) created in step 6 returned to CCP
created in step 6 (while evaluating the second clause of w3/3).
CCP created for w2(pps,foobar).

Step 8: At this point all subgoals are in the same Approximate SCC.
Also, each CP has as its previous CP the CP created in the immediately
preceding step.  The only anwser produced has been consumed, so the
engine backtracks to the CCP of step 7; fails; backtracks to the CCP
created in step 6; fails; backtracks to the GCP created in step 6 and
turns the GCP created in step 5 into a CCP.  (This happens in local
evaluations when backtracking over a GCP for a subgoal that is not a
SCC leader).  Finally, backtracking reaches the CP created in Step 4,
and executes the third clause of _$w2(app,foobar)

Step 9: Forward execution creates a choice point for db/1 whose
previous choice point is the CP of Step 4.  Note that there are two
CPs whose previous CP is that of Step 4: this new one and the one from
step 5.

Step 10: the cut is executed, the CP of step 9 removed, and breg set
to the GCP for Step 3.  Upon failure (immediately after the cut)
backtracking sets the GCP of Step 3 to a CCP, and fails.  Backtracking
follows the previous CP for the Step 3 CCP to the step 2 CP.

Step 11: Similarly to step 9, forward execution executes clause 3 for
_$w2(pps,foobar) (a minor difference is that no CP for db/1 is created
for the goal db(wrpper(app,foobar)) ).  (breg still points to Step 2's
CP)

Step 12: The cut is executed, resetting breg back to the original GCP
of Step 1, which is the leader.  Recall that the failure continuation
for the step 1 GCP is a check_complete, so the leader schedules answer
return for all CCPs in the SCC.  Actually, there is one scheduled.
The answer w3(p,0,foobar) is returned to the CCP (nee GCP) of step 5,
returning the answer to the second clause of _$w2(app,foobar).

Step 13 (the unlucky step): The return of the answer immediately
causes a new answer w2(app,foobar) to be derived for the goal
w2(app,foobar).  Since an answer is returned for a ground goal, early
completion applies and the goal w2(app,foobar) is early completed.

>>!! A heuristic for early completion is to set the breg to the
original GCP for the goal !!<<

and the breg is set to point to the GCP (now a CCP) of w2(app,foobar)
created in step 3.

Step 14.  Note that due to early completion, the breg now points to
the CCP of step 3 which was never scheduled by the leader.  If it had
been scheduled, its previous CP would be the (step 1) leader.
However, as it was never rescheduled, its previous CP is its original
one: that of step 2.

Step 15. The addition of the new answer from step 13 causes an
immediate failure due to local scheduling.  The engine now backtracks
into the (ostensably cut) choicepoint of step 2, which improperly
executes the fourth clause for _$w2(pps,foobar).
----------------------------
revision 1.37
date: 2008/09/21 19:16:33;  author: tswift;  state: Exp;  lines: +4 -4

Backing out change from 2005-11-08 that broke some programs that had
an iterated fixed point within an SCC along with early completion.
This fixes a program reported by Dipti a while ago along with the wine
bug.

This also breaks a test pps.P and causes some undefined error messages
during compilation.  I'm leaving these in for now so they annoy me and
force me to re-fix the pps.P bug.Killed by signal 2.
----------------------------
revision 1.36
date: 2008/06/05 18:15:12;  author: ruim;  state: Exp;  lines: +3 -1
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.35
date: 2007/11/30 13:09:22;  author: ruim;  state: Exp;  lines: +3 -1
re-introduced lock on the completion instruction
it is needed to avoid deadlocks
however the duration of the lock has been greatly reduced.
----------------------------
revision 1.34
date: 2007/11/24 02:06:32;  author: ruim;  state: Exp;  lines: +1 -6
removed completing lock in the completion instruction for shared
completed tables.
sccs involving private and shared tables still work
----------------------------
revision 1.33
date: 2006/12/02 19:31:57;  author: ruim;  state: Exp;  lines: +58 -61
moved in lock of compl mutex to avoid locking if non leader
some standartization and ifx of potential bugs for conc compl
----------------------------
revision 1.32
date: 2006/11/30 21:10:24;  author: ruim;  state: Exp;  lines: +4 -1
Moved DELAY_MUTEX in, in do_delay_stuff_shared to avoid unneeded locks

New Feature:
 Pseudo Mutexes

  These are system mutexes which are just used for counting in place of
  either sets of mutexes (call trie, struct manager) or mutexes
  that really don't fit in the SYS_MUTEX convention (completing_mut,
  th_mutex)

  It allows to re-use the statistics stuff for these mutexes.
----------------------------
revision 1.31
date: 2006/11/05 23:53:14;  author: ruim;  state: Exp;  lines: +2 -2
Several changes & fixes for Concurrent Completion:
- Locking of the answer return list and consumer list at subgoal frame level
- No longer a dummy generator choice point is created for every external
  consumer
- Threads which don't have a stale view of the round are no longer awaken at
  completion
- The answer return list is not reclaim for shared tables
----------------------------
revision 1.30
date: 2005/11/07 20:37:41;  author: tswift;  state: Exp;  lines: +26 -2

Fixing flora bug by changing check-complete for non-leaders to find leader and
set prevbreg to leader AFTER backtracking to original prevbreg.  For details, see message to xsb-development.
----------------------------
revision 1.29
date: 2005/10/04 12:13:13;  author: ruim;  state: Exp;  lines: +3 -3
partial integration of negation in concurrent completion
----------------------------
revision 1.28
date: 2005/09/30 20:04:26;  author: ruim;  state: Exp;  lines: +7 -5
bugfixes for concurrent completion
----------------------------
revision 1.27
date: 2005/09/29 15:12:43;  author: ruim;  state: Exp;  lines: +1 -2
bugfixes for concurrent completion
----------------------------
revision 1.26
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;  lines: +76 -14
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.25
date: 2005/09/05 08:21:32;  author: ruim;  state: Exp;  lines: +3 -3
rationalized find_fixpoint
----------------------------
revision 1.24
date: 2005/09/01 18:29:38;  author: tswift;  state: Exp;  lines: +3 -1

(mostly minor) documentation changes, and a little code movement.
----------------------------
revision 1.23
date: 2005/08/28 16:42:28;  author: ruim;  state: Exp;  lines: +14 -3
phase 1 of implementation of concurrent completion
----------------------------
revision 1.22
date: 2005/08/18 12:33:41;  author: ruim;  state: Exp;  lines: +3 -10
changed defines for completed shared tables
----------------------------
revision 1.21
date: 2005/07/04 20:47:01;  author: ruim;  state: Exp;  lines: +15 -1
allow sharing of completed tables
----------------------------
revision 1.20
date: 2005/01/14 18:30:53;  author: ruim;  state: Exp;  lines: +8 -8
Integration of multithreaded system
----------------------------
revision 1.19
date: 2002/05/20 17:47:09;  author: tswift;  state: Exp;  lines: +3 -5
branches:  1.19.2;

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.18
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +2 -21
* Removal of Chat engine
----------------------------
revision 1.17
date: 2002/02/22 03:23:45;  author: lfcastro;  state: Exp;  lines: +5 -3
branches:  1.17.2;
* Batched should only reclaim stacks when completing the leader of the
  whole ASCC!
* Fixes the infamous GC bug on slgwam+batched
----------------------------
revision 1.16
date: 2001/12/13 21:13:36;  author: lfcastro;  state: Exp;  lines: +6 -12
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.15
date: 2001/10/05 19:26:49;  author: tswift;  state: Exp;  lines: +3 -2

Added stubs for "answer completion: i.e. remove_unfounded_set
----------------------------
revision 1.14
date: 2001/09/24 17:23:52;  author: lfcastro;  state: Exp;  lines: +54 -364
* attempt to cleanup and organize the completion algorithm for LOCAL
evaluation
----------------------------
revision 1.13
date: 2001/06/22 21:05:47;  author: tswift;  state: Exp;  lines: +3 -3

Fixed buglet and otherwise improved (to my taste) DEBUG_DELAYVARS
----------------------------
revision 1.12
date: 2001/06/21 19:07:59;  author: tswift;  state: Exp;  lines: +56 -2

Added profiling info and traces of SCC shapes.
----------------------------
revision 1.11
date: 2001/04/04 18:28:48;  author: tswift;  state: Exp;  lines: +6 -1

Documentation additions, in particular for new_answer_dealloc.
----------------------------
revision 1.10
date: 2001/04/03 16:37:29;  author: tswift;  state: Exp;  lines: +32 -21

Added/modified documentation.
----------------------------
revision 1.9
date: 2001/01/31 10:23:29;  author: ejohnson;  state: Exp;  lines: +4 -8
Created the macro "table_pending_answer" to hide the details of
obtaining the next answer for consumption, which, in the case of a
properly subsumed subgoal, may require an answer identification step.

Second, removed -- again -- (most) "xtemp1" references.
(Argh!  How does this crap keep creeping back into the system?!?)

These were sprinkled over several files and removed by simply creating
a variable local to each macro in which a temp was needed.

The "need" for this change was precipitated due to the inclusion of an
"xtemp1" declaration within one of the code blocks which
table_pending_answer replaced.
----------------------------
revision 1.8
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +11 -4
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.7
date: 2000/07/31 20:27:55;  author: ejohnson;  state: Exp;  lines: +3 -3
branches:  1.7.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.6
date: 2000/06/22 01:27:50;  author: lfcastro;  state: Exp;  lines: +7 -7
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.5
date: 2000/05/29 04:23:35;  author: ejohnson;  state: Exp;  lines: +4 -4
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.4
date: 2000/04/29 21:53:51;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.3
date: 1999/10/27 14:17:54;  author: kostis;  state: Exp;  lines: +4 -2
branches:  1.3.2;
Added ifdef to suppress warning from gcc... Am I the only one with eyes ?
----------------------------
revision 1.2
date: 1999/10/27 02:46:20;  author: cbaoqiu;  state: Exp;  lines: +12 -15
More changes to support attributed vars under CHAT & LOCAL_EVAL.
----------------------------
revision 1.1
date: 1999/10/25 05:57:37;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.2.1
date: 2000/03/28 18:10:31;  author: lfcastro;  state: Exp;  lines: +8 -166
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.7.2.2
date: 2000/12/19 15:58:13;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.7.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.17.2.2
date: 2004/10/18 20:45:59;  author: ruim;  state: Exp;  lines: +4 -25
update for version 2.6.1
----------------------------
revision 1.17.2.1
date: 2004/09/29 19:44:10;  author: ruim;  state: Exp;  lines: +8 -8
Sources from rfm repository
----------------------------
revision 1.19.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +3 -4
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.19.2.2
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +3 -3
* update to HEAD
----------------------------
revision 1.19.2.1
date: 2002/07/31 20:13:45;  author: lfcastro;  state: Exp;  lines: +3 -3
* demand_once/1 predicate cuts over tables, deleting incomplete tables
whose producer is in the scope of the "cut" (preliminary version)
----------------------------
revision 1.39.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.39.4.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +1 -0
no message
----------------------------
revision 1.39.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/conc_compl.c,v
Working file: conc_compl.c
head: 1.20
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.20
	ROLLBACK: 1.16
	latest_plus_supp_branch: 1.16.0.2
	latest_plus_supp: 1.16
	Version_3dot2_plus_supp: 1.14.0.2
	Version_3dot2: 1.14
	dec07-perf-results: 1.14
	mt_thesis: 1.14
	release_3_0: 1.9
keyword substitution: kv
total revisions: 23;	selected revisions: 23
description:
----------------------------
revision 1.20
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.19
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.18
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.17
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16
date: 2010/01/23 19:03:02;  author: tswift;  state: Exp;  lines: +1 -1
branches:  1.16.2;

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.15
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +1 -1

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.14
date: 2006/11/28 18:59:28;  author: ruim;  state: Exp;  lines: +4 -10
fix for concurrent completion: completed subgoals should really be ignored.
----------------------------
revision 1.13
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +27 -22
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.12
date: 2006/11/20 16:53:41;  author: ruim;  state: Exp;  lines: +2 -2
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.11
date: 2006/11/06 17:31:53;  author: ruim;  state: Exp;  lines: +2 -1
Fixes to CONC_COMPL:

- compl stack expansion fixed
- freeing of answer_return list finally fixed

it now runs all the tests that batched runs
----------------------------
revision 1.10
date: 2006/11/05 23:53:14;  author: ruim;  state: Exp;  lines: +2 -0
Several changes & fixes for Concurrent Completion:
- Locking of the answer return list and consumer list at subgoal frame level
- No longer a dummy generator choice point is created for every external
  consumer
- Threads which don't have a stale view of the round are no longer awaken at
  completion
- The answer return list is not reclaim for shared tables
----------------------------
revision 1.9
date: 2005/10/12 23:06:26;  author: tswift;  state: Exp;  lines: +47 -0


Mostly added documentation.  Other changes

biassert.c -- commented out a debug that prevented -vrb option from
compiling.

Added a !defined(SOLARIS) to the inclusion of POSIX_C_SOURCE in
setjmp_xsb.h, and put the setjmp_xsb.h back into context.  I figured
its best to make the minimal change, rather than taking out the
inclusion of POSIX_C_SOURCE, which somehow would have broken something
down the line.

Terry
----------------------------
revision 1.8
date: 2005/10/04 15:53:08;  author: ruim;  state: Exp;  lines: +1 -0
bugfix for concurrent completion
----------------------------
revision 1.7
date: 2005/10/04 12:13:13;  author: ruim;  state: Exp;  lines: +1 -1
partial integration of negation in concurrent completion
----------------------------
revision 1.6
date: 2005/10/04 11:48:28;  author: ruim;  state: Exp;  lines: +1 -4
simplification of concurrent completion
----------------------------
revision 1.5
date: 2005/10/04 11:21:00;  author: ruim;  state: Exp;  lines: +8 -8
simplification of concurrent completion
----------------------------
revision 1.4
date: 2005/10/03 10:42:15;  author: ruim;  state: Exp;  lines: +13 -5
Small changes to concurrent completion
----------------------------
revision 1.3
date: 2005/09/30 20:04:26;  author: ruim;  state: Exp;  lines: +16 -5
bugfixes for concurrent completion
----------------------------
revision 1.2
date: 2005/09/29 15:12:43;  author: ruim;  state: Exp;  lines: +4 -5
bugfixes for concurrent completion
----------------------------
revision 1.1
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.16.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.16.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/conc_compl.h,v
Working file: conc_compl.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.5
	release_3_0: 1.4
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.9
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2006/11/20 16:53:41;  author: ruim;  state: Exp;  lines: +3 -2
branches:  1.5.4;
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.4
date: 2005/10/04 11:21:00;  author: ruim;  state: Exp;  lines: +0 -1
simplification of concurrent completion
----------------------------
revision 1.3
date: 2005/10/03 10:42:15;  author: ruim;  state: Exp;  lines: +1 -1
Small changes to concurrent completion
----------------------------
revision 1.2
date: 2005/09/30 20:04:26;  author: ruim;  state: Exp;  lines: +1 -0
bugfixes for concurrent completion
----------------------------
revision 1.1
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/conget_xsb_i.h,v
Working file: conget_xsb_i.h
head: 1.10
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.2.0.4
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.1.6.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.6
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.2
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.4
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
	release_2_4: 1.1
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.10
date: 2011/03/05 17:26:23;  author: tswift;  state: Exp;  lines: +5 -3

Improved error reports for conset and conget.
----------------------------
revision 1.9
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2005/07/18 21:54:08;  author: crojo;  state: Exp;  lines: +1 -2
branches:  1.4.4;
*** empty log message ***
----------------------------
revision 1.3
date: 2005/07/11 16:57:02;  author: dwarren;  state: Exp;  lines: +24 -1
Added the standard header to this file (how has it lacked it for lo these many years??)
----------------------------
revision 1.2
date: 2003/06/18 16:32:09;  author: lfcastro;  state: Exp;  lines: +7 -0
* disable conget/conset and psc_prop on predicate PSC's
----------------------------
revision 1.1
date: 2001/03/28 08:56:35;  author: kifer;  state: Exp;
branches:  1.1.6;
sped up conget/conset making them into builtins
----------------------------
revision 1.1.6.1
date: 2004/10/18 20:46:00;  author: ruim;  state: Exp;  lines: +7 -0
update for version 2.6.1
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/context.h,v
Working file: context.h
head: 1.89
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.77
	ROLLBACK: 1.72
	latest_plus_supp_branch: 1.72.0.2
	latest_plus_supp: 1.72
	Version_3dot2_plus_supp: 1.68.0.2
	Version_3dot2: 1.68
	dec07-perf-results: 1.63
	mt_thesis: 1.51
	release_3_0: 1.45
	multi-threaded-26-engine: 1.1.2.6
	multi-threaded-25-engine-done: 1.1.2.1
	multi-threaded-25-engine: 1.1.0.2
keyword substitution: kv
total revisions: 98;	selected revisions: 98
description:
----------------------------
revision 1.89
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +3 -1

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.88
date: 2011/11/12 00:33:31;  author: tswift;  state: Exp;  lines: +7 -1

Added depth check for interned tries -- use tabled answer depth /
action flags.
----------------------------
revision 1.87
date: 2011/10/29 23:27:58;  author: tswift;  state: Exp;  lines: +3 -1

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.86
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +11 -1

Integrating in Call Abstraction
----------------------------
revision 1.85
date: 2011/06/02 22:29:23;  author: tswift;  state: Exp;  lines: +12 -8
Changes	to add stack expansion so that arbitrary numbers of
variables are allowed in interned, asserted tries and tables.

This uncovered a bug.

The problem arose when a conditional answer is interned in the
answer trie and that conditional answer contains variables both
in the answer head and the delay list, and there are variables in
the answer head that are not in the delay list. What happened was
that when the variables were interned in delay_trie_chk_insert,
the mini-trail that the trie routines use for standardizing
variables was reset.  This meant that the variables in the answer
head were not being properly untrailed and, due to the particular
way that variables are standardized, variables were bound to each
other that shouldn't have been, and in this case a circular
dereferencing chain arose, so that XSB hung.  I have no idea why
the bug was uncovered just now.
----------------------------
revision 1.84
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +3 -7

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.83
date: 2011/05/19 15:05:05;  author: tswift;  state: Exp;  lines: +2 -2

Fixes to recompile XSB on Mac.
----------------------------
revision 1.82
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +11 -11
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.81
date: 2010/12/18 00:01:27;  author: tswift;  state: Exp;  lines: +4 -4
changed the names of some data structures whose names had confused me.
----------------------------
revision 1.80
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +7 -7

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.79
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +8 -12

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.78
date: 2010/10/07 17:58:03;  author: dwarren;  state: Exp;  lines: +14 -1
Finally commited changes to allow the multithreaded version to compile under
Cygwin.  I just if-deffed the differences in types required by the windows
p-thread version and linux's.  A hack, but it works for now.
----------------------------
revision 1.77
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.76
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.75
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.74
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.73
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.72
date: 2010/05/05 04:45:29;  author: evansbj;  state: Exp;  lines: +28 -28
branches:  1.72.2;
Added a small cast to hopefully fix the cygwin compiles.
----------------------------
revision 1.71
date: 2010/05/02 05:11:26;  author: evansbj;  state: Exp;  lines: +3 -3
Update to make thread_exit/1, and xsb_kill_thread work from the C interface. It passes the regression tests as well as before, better actually.
----------------------------
revision 1.70
date: 2010/01/30 20:17:37;  author: evansbj;  state: Exp;  lines: +5 -5
*** empty log message ***
----------------------------
revision 1.69
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.68
date: 2009/02/21 16:47:33;  author: tswift;  state: Exp;  lines: +3 -2

Changes to support

statistics/2
Rui's fix for the mt bug

along with scratch code for answer_completion.
----------------------------
revision 1.67
date: 2008/06/08 22:10:04;  author: ruim;  state: Exp;  lines: +2 -1
changes to shared completed tables
	re introduced de dealock break leader
	solved some bugs relating to marking subgoals of threads
	that where already usurped (double deadlocks)
----------------------------
revision 1.66
date: 2008/06/05 18:15:12;  author: ruim;  state: Exp;  lines: +1 -2
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.65
date: 2008/06/04 13:23:24;  author: ruim;  state: Exp;  lines: +2 -2
tidy up of shared completed tables code
completing mut is now locked much less time
----------------------------
revision 1.64
date: 2007/12/24 19:16:59;  author: tswift;  state: Exp;  lines: +7 -3

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.63
date: 2007/11/20 19:17:20;  author: tswift;  state: Exp;  lines: +5 -1


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.62
date: 2007/09/28 21:28:37;  author: tswift;  state: Exp;  lines: +7 -2
Adding a few pointers to the thread context for smodels.
----------------------------
revision 1.61
date: 2007/09/04 00:49:08;  author: dwarren;  state: Exp;  lines: +1 -9
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.60
date: 2007/07/24 20:19:33;  author: ruim;  state: Exp;  lines: +4 -1
hack to allow threads to be interrupted while waiting
for messages
----------------------------
revision 1.59
date: 2007/07/24 19:07:24;  author: ruim;  state: Exp;  lines: +5 -1
changes to make thread cancellation more roubust
----------------------------
revision 1.58
date: 2007/06/27 13:23:15;  author: ruim;  state: Exp;  lines: +3 -3
got rid of usleep in ccalls_xsb_thread_create
made xsb_ready volatile
this code should now be correct
----------------------------
revision 1.57
date: 2007/06/10 18:43:57;  author: tswift;  state: Exp;  lines: +5 -9

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.56
date: 2007/06/01 22:47:06;  author: tswift;  state: Exp;  lines: +35 -8

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.55
date: 2007/04/24 18:35:31;  author: tswift;  state: Exp;  lines: +12 -2

First pass at message queues.
----------------------------
revision 1.54
date: 2007/02/23 20:17:04;  author: tswift;  state: Exp;  lines: +10 -2
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.53
date: 2007/02/22 00:16:04;  author: tswift;  state: Exp;  lines: +12 -2


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.52
date: 2007/01/25 20:33:54;  author: tswift;  state: Exp;  lines: +23 -2


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.51
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +2 -2
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.50
date: 2006/11/26 23:43:43;  author: tswift;  state: Exp;  lines: +7 -1

 changes involve memory allocation
 for the dynamic clause garbage collection frames: rather than
 using malloc() and free() for these frames, I changed the
 various retract(all)s to use structure managers.  This has two
 advantages: first the structure managers are more efficient
 overall than using malloc and free, and second, in the
 multi-threaded engine we now use private structure mangers to
 manage the dynamic gc frames for private dynamic predicates,
 increaing potential concurrency.

Also, changes to experimental retract.
----------------------------
revision 1.49
date: 2006/11/22 16:18:07;  author: ruim;  state: Exp;  lines: +57 -2
Fixed heap expansion and GC to allow concurrency, by
moving global variables into the thread context.

GC_PROFILE was not fixed
----------------------------
revision 1.48
date: 2006/11/20 16:53:41;  author: ruim;  state: Exp;  lines: +2 -1
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.47
date: 2006/11/15 16:38:09;  author: tswift;  state: Exp;  lines: +34 -1

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.46
date: 2006/10/18 20:42:26;  author: dwarren;  state: Exp;  lines: +4 -0
Updates to the ODBC interface:
1) fixed a global variable that would break MT
2) changed to use mem_alloc and new ODBC_SPACE tag to show memory
	usage in statistics.
----------------------------
revision 1.45
date: 2006/04/30 18:27:13;  author: tswift;  state: Exp;  lines: +3 -1

-- Put parentheses around retract-gc definitions to ensure
   correctness.  The engine had been delaying space reclamation and
   garbage collecting far too often, and this seems to fix that problem.

-- A little more thread-safety for token_xsb.c

-- Fixed bug with file_clone/3 that I introduced many moons ago.  The
problem was that I hadn't been giving names to console type files,
and file_clone used the file name in a string_find.  Now console
files have file names and things seem to work fine.
----------------------------
revision 1.44
date: 2006/04/27 21:08:47;  author: tswift;  state: Exp;  lines: +9 -1

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.43
date: 2006/04/24 15:41:16;  author: tswift;  state: Exp;  lines: +3 -1

Changes to make lists of delcfs both shared and private, so that space reclamation of dynamic clauses can occur when more than 1 thread is active.

Also, added reclamation of delcf and deltf frames for thread-private predicates upon exit of a thread.
----------------------------
revision 1.42
date: 2006/04/17 20:54:56;  author: tswift;  state: Exp;  lines: +7 -1

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.41
date: 2006/03/27 00:13:53;  author: tswift;  state: Exp;  lines: +3 -1

1) Split DelTF chain into private and shared chains.  This fixed
   a bug with table garbage collection, but also enabled me to
   allow garbage collection of a threads private tables when
   there is more than one active thread.

2) Extended the delay of space reclamation to abolished subgoals,
   and added subgoal reclamation to the table garbage collector.

I also added tests for these: lease update the various test
suites as the gc stuff may be a little brittle.
----------------------------
revision 1.40
date: 2006/03/24 16:40:28;  author: tswift;  state: Exp;  lines: +11 -7

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.39
date: 2006/03/18 17:37:48;  author: tswift;  state: Exp;  lines: +61 -55
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.38
date: 2006/01/12 21:33:50;  author: tswift;  state: Exp;  lines: +8 -1
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.37
date: 2006/01/09 00:06:30;  author: tswift;  state: Exp;  lines: +44 -5
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.36
date: 2005/12/22 23:33:55;  author: tswift;  state: Exp;  lines: +6 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.35
date: 2005/11/18 23:29:01;  author: tswift;  state: Exp;  lines: +4 -1

Took attv_interrupts array out of global area, and put it into
the thread context.  Also added, _gl suffix to realtime_count.

Other than that, just general documentation.
----------------------------
revision 1.34
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +13 -4


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.33
date: 2005/10/12 23:06:26;  author: tswift;  state: Exp;  lines: +3 -2


Mostly added documentation.  Other changes

biassert.c -- commented out a debug that prevented -vrb option from
compiling.

Added a !defined(SOLARIS) to the inclusion of POSIX_C_SOURCE in
setjmp_xsb.h, and put the setjmp_xsb.h back into context.  I figured
its best to make the minimal change, rather than taking out the
inclusion of POSIX_C_SOURCE, which somehow would have broken something
down the line.

Terry
----------------------------
revision 1.32
date: 2005/10/10 12:28:29;  author: kostis;  state: Exp;  lines: +1 -4
Change to allow XSB to build on Solaris too.
----------------------------
revision 1.31
date: 2005/10/04 11:48:28;  author: ruim;  state: Exp;  lines: +1 -2
simplification of concurrent completion
----------------------------
revision 1.30
date: 2005/10/04 11:21:00;  author: ruim;  state: Exp;  lines: +2 -1
simplification of concurrent completion
----------------------------
revision 1.29
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +23 -5


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.28
date: 2005/09/30 20:04:26;  author: ruim;  state: Exp;  lines: +2 -1
bugfixes for concurrent completion
----------------------------
revision 1.27
date: 2005/09/29 15:12:43;  author: ruim;  state: Exp;  lines: +1 -2
bugfixes for concurrent completion
----------------------------
revision 1.26
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;  lines: +13 -1
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.25
date: 2005/09/16 00:56:41;  author: tswift;  state: Exp;  lines: +9 -7

Changes to make the storage module, which allows backtrackable updates, thread safe.  Storage "objects" (named interned tries) are private to each thread.
----------------------------
revision 1.24
date: 2005/09/12 18:20:35;  author: tswift;  state: Exp;  lines: +2 -5

Some changes to move some info I put into a threads context into a function, so the info is no longer "global".  Also, fixed interned tries so that they are now thread-local.
----------------------------
revision 1.23
date: 2005/09/12 01:09:33;  author: tswift;  state: Exp;  lines: +11 -1

Tonight's changes were to clean up global data structures used to
clean up tries.  This time I was able to make data structures used in deleting
asserted and interned tries, local to the relevant function.  In addition,
I put into the MT context data structures used to manage an array of interned
tries.

Of course, there's more work to allow asserted and interned tries to be used in multi-threading -- but these changes will hopefully save us from one danger, at least.
----------------------------
revision 1.22
date: 2005/09/11 01:29:39;  author: tswift;  state: Exp;  lines: +9 -1

In tonights exciting installment, I made info about the freeing stack thread specific, since this array is used to deallocate tables.  Its called on thread exit to deallocate private tables, so we'd core dump sooner or later if we kept
freeing_stack as a global.
----------------------------
revision 1.21
date: 2005/09/01 18:29:38;  author: tswift;  state: Exp;  lines: +28 -22

(mostly minor) documentation changes, and a little code movement.
----------------------------
revision 1.20
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +13 -11
Made pflags thread private
----------------------------
revision 1.19
date: 2005/08/16 21:39:53;  author: dwarren;  state: Exp;  lines: +23 -1
Made subsumptive tables thread-safe with regard to global variables (I hope.)
So thread_private subsumptive tables should work.  No guarantees at all for
shared subsumptive tables.
----------------------------
revision 1.18
date: 2005/08/08 17:11:30;  author: dwarren;  state: Exp;  lines: +32 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.17
date: 2005/08/01 17:32:25;  author: ruim;  state: Exp;  lines: +2 -2
moved include <sql.h> to WIN_NT section so that system would compile on LINUX
----------------------------
revision 1.16
date: 2005/07/26 22:46:23;  author: crojo;  state: Exp;  lines: +40 -9

Fixed the ODBC interface in the multithreaded configuration.
----------------------------
revision 1.15
date: 2005/07/22 17:21:51;  author: dwarren;  state: Exp;  lines: +1 -2
Minor changes in includes for MT
----------------------------
revision 1.14
date: 2005/07/21 10:46:35;  author: ruim;  state: Exp;  lines: +5 -2
preliminar implementation of deadlock breaking
----------------------------
revision 1.13
date: 2005/07/18 21:54:08;  author: crojo;  state: Exp;  lines: +2 -2
*** empty log message ***
----------------------------
revision 1.12
date: 2005/07/15 15:02:20;  author: dwarren;  state: Exp;  lines: +7 -1
Made assert thread-safe (I hope.)  Problem was asserta, and I added
mutex_lock in jumptbreg when just entering asserted code, and I release
it after the code for the first clause to be executed is found and about
to be entered.  It introduces new instructions: dyntrymeelse, dynnoop, and
dynfail to release the lock.
assertz was made safe (I hope) without locks, by adding the new clause at the
end and then as the last thing, changing the opcode of the old-last clause
from dyntrust to retry.  Since dyntrust doesn't look at any argument, this
should work.
----------------------------
revision 1.11
date: 2005/07/12 21:20:49;  author: dwarren;  state: Exp;  lines: +13 -1
Made the assert buffer local to a thread to reduce length of time required
to hold the lock when asserting.  Also, reordered some code to try to reduce
the time for race-conditions when asserting.
----------------------------
revision 1.10
date: 2005/07/12 15:54:24;  author: ruim;  state: Exp;  lines: +6 -1
added deadlock detection to shared completed tables
----------------------------
revision 1.9
date: 2005/07/11 19:47:19;  author: dwarren;  state: Exp;  lines: +15 -1
Made the random builtins thread-safe.  (But it doesn't look like there's any interface
from Prolog to them??)
----------------------------
revision 1.8
date: 2005/07/11 17:00:32;  author: dwarren;  state: Exp;  lines: +11 -1
Made parsort thread-safe.
----------------------------
revision 1.7
date: 2005/07/08 21:25:21;  author: dwarren;  state: Exp;  lines: +5 -1
More thread-safing: ptoc_longstring(!) and is_most_general_term.
----------------------------
revision 1.6
date: 2005/07/08 20:25:21;  author: dwarren;  state: Exp;  lines: +54 -5
More thread-safe making.  gettoken and read_canonical, this time.
----------------------------
revision 1.5
date: 2005/07/07 16:55:50;  author: dwarren;  state: Exp;  lines: +12 -2
Fixed fmt_read/write for multithreading.  Minor change to write_canonical (still NOT
thread-safe).
Added several (extensible) string buffers to context, since many builtins use
global string buffers.  Idea is to change those places to use these buffers.
They are implemented as varstring's.
----------------------------
revision 1.4
date: 2005/07/06 18:29:12;  author: dwarren;  state: Exp;  lines: +23 -1
FOr Multithreading: Made findall thread-safe by moving its static variables
to the thread structure.  Now each thread has its own chain of findall buffers.
----------------------------
revision 1.3
date: 2005/02/13 15:28:55;  author: vidrevich;  state: Exp;  lines: +1 -2
changes to compile multi-treaded XSB in Windows
----------------------------
revision 1.2
date: 2005/01/14 18:38:37;  author: ruim;  state: Exp;  lines: +254 -0
Integration of multithreaded system
----------------------------
revision 1.1
date: 2004/09/29 19:44:11;  author: ruim;  state: dead;
branches:  1.1.2;
file context.h was initially added on branch multi-threaded-25-engine.
----------------------------
revision 1.1.2.6
date: 2004/12/20 16:26:28;  author: ruim;  state: Exp;  lines: +7 -1
renamed mini_trail to VarEnumerator_trail and put it on thread context
----------------------------
revision 1.1.2.5
date: 2004/12/14 08:47:05;  author: ruim;  state: Exp;  lines: +14 -4
added dynamic stacks to thread context
----------------------------
revision 1.1.2.4
date: 2004/11/24 21:53:26;  author: ruim;  state: Exp;  lines: +12 -1
made smBTHT and smBTN thread specific
----------------------------
revision 1.1.2.3
date: 2004/11/22 23:07:32;  author: ruim;  state: Exp;  lines: +10 -2
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.1.2.2
date: 2004/10/20 16:22:02;  author: ruim;  state: Exp;  lines: +1 -2
include of chat removed
----------------------------
revision 1.1.2.1
date: 2004/09/29 19:44:11;  author: ruim;  state: Exp;  lines: +220 -0
Sources from rfm repository
----------------------------
revision 1.72.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.72.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.72.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/cut.h,v
Working file: cut.h
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.4
	without-attv: 1.4
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.3
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 6;	selected revisions: 6
description:
----------------------------
revision 1.5
date: 1999/10/26 06:46:53;  author: kifer;  state: dead;  lines: +1 -1
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.4
date: 1999/08/16 07:24:07;  author: kifer;  state: Exp;  lines: +8 -9
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.3
date: 1999/01/13 13:09:37;  author: kostis;  state: Exp;  lines: +4 -15
Stuff for cutting over tables (ad hoc attempt) taken out as is dangerous
and probably does not work.  Prolog cut should remain unaffected.
----------------------------
revision 1.2
date: 1998/12/21 01:08:08;  author: cbaoqiu;  state: Exp;  lines: +31 -10
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/cut_xsb.h,v
Working file: cut_xsb.h
head: 1.32
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.29
	ROLLBACK: 1.24
	latest_plus_supp_branch: 1.24.0.4
	latest_plus_supp: 1.24
	Version_3dot2_plus_supp: 1.24.0.2
	release_2_6_plus_supp: 1.13.0.4
	Version_3dot2: 1.24
	dec07-perf-results: 1.23
	mt_thesis: 1.20
	release_3_0: 1.20
	release_2_7_0: 1.13
	multi-threaded-26-engine: 1.10.2.2
	pre-mt: 1.13
	multi-threaded-25-engine-done: 1.10.2.1
	multi-threaded-25-engine: 1.10.0.2
	release_2_6_1: 1.13
	release_2_6_final: 1.13
	release_2_6: 1.13.0.2
	last-merged-to-demand: 1.11
	demand_branch: 1.11.0.2
	before_removing_chat: 1.10
	release_2_5: 1.10
	pre-merge-slgwam-gc: 1.8
	multi-threaded-c-engine: 1.8.0.2
	release_2_4: 1.8
	release_2_3: 1.8
	multi-threaded-engine: 1.7.0.2
	pre-threading: 1.6
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.3
	release-2-0-1: 1.3
keyword substitution: kv
total revisions: 46;	selected revisions: 46
description:
----------------------------
revision 1.32
date: 2012/02/19 19:17:55;  author: tswift;  state: Exp;  lines: +19 -39

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.31
date: 2012/02/12 22:49:12;  author: tswift;  state: Exp;  lines: +6 -1

Fixed bug in throwing exceptions with incomplete tables.  Now tables
are reclaimed by unwind stack so that they stop *between* SCCs: this
allows us to continue reclaiming incomplete tables while at the same
time ensuring that we wont backtrack into a choice point for one of
those tables that we reclaimed.
----------------------------
revision 1.30
date: 2011/01/05 16:16:19;  author: dwarren;  state: Exp;  lines: +5 -6
Changed cut-over-table error message, from printout and abort, to throw a table
error.  Allows better tracking down of these problems (I hope.)
----------------------------
revision 1.29
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.28
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.27
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.26
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.25
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2007/12/27 22:22:23;  author: ruim;  state: Exp;  lines: +9 -3
branches:  1.24.4;
fix for call cleanup in 64 bits
It no longer loops
----------------------------
revision 1.23
date: 2007/10/20 19:13:01;  author: tswift;  state: Exp;  lines: +16 -13


Made some small fixes in init_mq_table -- it appears that some of the
private signal queues were being kept in the private message queue
free list.

Changed some fields in mq table to bit fields.

Ensured that private signal queues are initialized on thread startup.

Cleared up some confusion in creating message queues with default
value vs. creating unbounded message queues.  Now macros are used to
differentiate the two cases.

In cut_code.h, cleaned up some messy code and added documentation.
----------------------------
revision 1.22
date: 2007/10/19 21:15:16;  author: tswift;  state: Exp;  lines: +45 -1

Changes to add call_cleanup/2, whose semantics is ISO compliant as far
as the ISO definition goes.  I also put call_cleanup/2 in std_xsb.P.
Cleanup handlers are scheduled through the attv interrupt chain, so I
needed to hack this code a little to make sure that an interrupt
handler for cleanups is always present.

Also, I made a change to peephole to not optimize away a putpbreg_ci
-- we'll usually need it for call_cleanups.

Right now I'm using a static inline for CHECK_CALL_CLEANUP -- on gcc
this should be as fast as a macro and allows me to trace if there are
any problems.


Adding these changes made me need to adjust a few include statements
in tr_utils.c and tst_retrv.c
----------------------------
revision 1.21
date: 2007/09/28 18:20:11;  author: dwarren;  state: Exp;  lines: +1 -2
This change causes attv interrupts to be handled before cuts.
(It also fixes a bug in the previous checkin to handle attv
interrupts before trymeorelse instructions.)
All the xwam files are changed since this involved generating a
new instruction(s) putpbreg (and the temp version) for cuts that have
parameters for ARsize and NumRegsInUse which are needed if an
interrupt is pending and is to be handled.
Sitll to be done is to figure out how to handle interrupts before
trie_try-type instructions that do unification when retrieving
from tries.
----------------------------
revision 1.20
date: 2006/05/22 15:06:48;  author: tswift;  state: Exp;  lines: +6 -1

Committing bug fix to cut check (thought it had been committed?)
----------------------------
revision 1.19
date: 2006/01/27 20:29:46;  author: tswift;  state: Exp;  lines: +12 -3

Some changes I recently made broke batched evaluation.  I backed out these changes to fix the batched test suite again.
----------------------------
revision 1.18
date: 2006/01/24 14:10:01;  author: tswift;  state: Exp;  lines: +5 -4

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.17
date: 2005/11/17 18:22:41;  author: tswift;  state: Exp;  lines: +4 -3

Removed resume_compl_susp_inst2 -- unneeded, and a remnant of old single-stack scheduling (!)
----------------------------
revision 1.16
date: 2005/11/10 23:05:55;  author: tswift;  state: Exp;  lines: +1 -2

Removed some stray printfs.
----------------------------
revision 1.15
date: 2005/06/28 17:12:05;  author: dwarren;  state: Exp;  lines: +15 -15
Modified throw to handle throwing out of incomplete tables.
Incomplete tables are removed (out to the catch), and unwind_trail is done.
This is probably still not perfect, but I think it's more complete than what we had.
----------------------------
revision 1.14
date: 2005/01/14 18:30:54;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.13
date: 2002/10/04 21:38:39;  author: lfcastro;  state: Exp;  lines: +3 -3
* first bounds-check trreg, then check if its valid, in unwind_trail
----------------------------
revision 1.12
date: 2002/10/04 20:42:00;  author: lfcastro;  state: Exp;  lines: +4 -1
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.11
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +3 -33
branches:  1.11.2;
* Removal of Chat engine
----------------------------
revision 1.10
date: 2002/01/23 17:08:08;  author: dwarren;  state: Exp;  lines: +3 -3
branches:  1.10.2;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.9
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +3 -2
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.8
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +3 -2
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.7
date: 2000/06/22 01:27:50;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.7.2;
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.6
date: 2000/05/16 19:07:32;  author: lfcastro;  state: Exp;  lines: +12 -2
* bugfix suggested by Kostis to the bug related to abolishing open
completion suspension slots on CHAT
----------------------------
revision 1.5
date: 2000/04/29 21:53:51;  author: kifer;  state: Exp;  lines: +3 -3
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.4
date: 2000/03/04 18:33:03;  author: dwarren;  state: Exp;  lines: +5 -3
branches:  1.4.2;
added info on source of cut to cut-over-table error message.
----------------------------
revision 1.3
date: 1999/10/27 21:36:25;  author: warren;  state: Exp;  lines: +6 -4
Modified error message of cut-over-table error to include predicate
name/arity.
----------------------------
revision 1.2
date: 1999/10/26 20:31:33;  author: warren;  state: Exp;  lines: +23 -22
Added check to cut to abort if cutting over a table.
----------------------------
revision 1.1
date: 1999/10/26 06:46:55;  author: kifer;  state: Exp;
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.4.2.2
date: 2000/09/13 18:41:10;  author: lfcastro;  state: Exp;  lines: +7 -7
Changes:

*Makefile
	- create target for 'make etags'

*emu/binding.h
	- got rid of #ifdef's on WAM_TRAIL

*emu/chat.c
	- commented out a switch_envs(breg) in
	  chat_restore_compl_susp_trail
	- introduced function chat_free_cp_compl_susp_chat_areas
	  needed for bugfix in cut_xsb.h
	- change in restore_answer_template

*emu/cut_xsb.h
	- bugfix in check_table_cut

*lib/Makefile
	- put '-g none' in calls to XSB to be able to compile when GC
	  isn't working

*general
	- changes/introduction in/of debug messages

Status:
Passes the testsuite for all tests, except for the gctests with the
copying collector, which fails for tests wfs_tests/p53 (and up).
----------------------------
revision 1.4.2.1
date: 2000/03/28 18:10:31;  author: lfcastro;  state: Exp;  lines: +3 -22
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.7.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.7.2.1
date: 2000/12/17 15:58:07;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.10.2.2
date: 2004/10/18 20:46:00;  author: ruim;  state: Exp;  lines: +8 -35
update for version 2.6.1
----------------------------
revision 1.10.2.1
date: 2004/09/29 19:44:11;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.11.2.5
date: 2003/04/17 17:11:51;  author: lfcastro;  state: Exp;  lines: +2 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.11.2.4
date: 2002/10/28 16:49:29;  author: lfcastro;  state: Exp;  lines: +3 -3
* Merge with HEAD
----------------------------
revision 1.11.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +32 -2
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.11.2.2
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +11 -41
* update to HEAD
----------------------------
revision 1.11.2.1
date: 2002/08/07 17:41:37;  author: lfcastro;  state: Exp;  lines: +41 -11
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.24.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.24.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.24.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/cutils.c,v
Working file: cutils.c
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1999/01/27 13:55:19;  author: unova;  state: dead;  lines: +1 -1
removing obsolete file cutils.c
----------------------------
revision 1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/deadlock.c,v
Working file: deadlock.c
head: 1.29
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.27
	ROLLBACK: 1.21
	latest_plus_supp_branch: 1.21.0.2
	latest_plus_supp: 1.21
	Version_3dot2_plus_supp: 1.19.0.2
	Version_3dot2: 1.19
	dec07-perf-results: 1.15
	mt_thesis: 1.13
	release_3_0: 1.8
keyword substitution: kv
total revisions: 32;	selected revisions: 32
description:
----------------------------
revision 1.29
date: 2012/02/12 22:49:12;  author: tswift;  state: Exp;  lines: +1 -1

Fixed bug in throwing exceptions with incomplete tables.  Now tables
are reclaimed by unwind stack so that they stop *between* SCCs: this
allows us to continue reclaiming incomplete tables while at the same
time ensuring that we wont backtrack into a choice point for one of
those tables that we reclaimed.
----------------------------
revision 1.28
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +14 -6

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.27
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +0 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.26
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.25
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.24
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.23
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.22
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +1 -0
no message
----------------------------
revision 1.21
date: 2010/01/23 19:03:02;  author: tswift;  state: Exp;  lines: +1 -1
branches:  1.21.2;

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.20
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +1 -1

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.19
date: 2009/02/21 19:39:53;  author: tswift;  state: Exp;  lines: +2 -0

Finish commit of Rui's change for deadlock bug.
----------------------------
revision 1.18
date: 2008/06/08 22:10:04;  author: ruim;  state: Exp;  lines: +6 -4
changes to shared completed tables
	re introduced de dealock break leader
	solved some bugs relating to marking subgoals of threads
	that where already usurped (double deadlocks)
----------------------------
revision 1.17
date: 2008/06/05 18:15:12;  author: ruim;  state: Exp;  lines: +0 -2
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.16
date: 2008/06/04 13:23:24;  author: ruim;  state: Exp;  lines: +18 -11
tidy up of shared completed tables code
completing mut is now locked much less time
----------------------------
revision 1.15
date: 2007/11/24 07:38:40;  author: ruim;  state: Exp;  lines: +3 -18
rolled back last commit
it was unsafe
----------------------------
revision 1.14
date: 2007/11/24 06:53:58;  author: ruim;  state: Exp;  lines: +18 -3
released the completing mut during the more heavy duty tasks
when the leader is reseting the other threads in the SCC
in shared completed tables
----------------------------
revision 1.13
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +8 -8
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.12
date: 2006/11/20 16:53:41;  author: ruim;  state: Exp;  lines: +2 -2
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.11
date: 2006/11/07 02:01:07;  author: ruim;  state: Exp;  lines: +6 -2
fixes for restarting tabled subgoals
----------------------------
revision 1.10
date: 2006/11/06 17:31:53;  author: ruim;  state: Exp;  lines: +4 -1
Fixes to CONC_COMPL:

- compl stack expansion fixed
- freeing of answer_return list finally fixed

it now runs all the tests that batched runs
----------------------------
revision 1.9
date: 2006/11/02 02:59:44;  author: ruim;  state: Exp;  lines: +4 -0
added counter for deadlocks to show in statistics
----------------------------
revision 1.8
date: 2006/06/02 23:32:39;  author: ruim;  state: Exp;  lines: +12 -7
Optimization to shared completed tables
----------------------------
revision 1.7
date: 2005/08/13 15:04:02;  author: ruim;  state: Exp;  lines: +1 -1
changed defines to allow concurrent completion
made batch compile under mt
----------------------------
revision 1.6
date: 2005/08/01 19:10:49;  author: ruim;  state: Exp;  lines: +13 -4
changes to break deadlocks in negation and handle early completion
----------------------------
revision 1.5
date: 2005/07/22 22:51:01;  author: ruim;  state: Exp;  lines: +13 -19
fixes for deadlock breaking algorithm
----------------------------
revision 1.4
date: 2005/07/22 17:21:52;  author: dwarren;  state: Exp;  lines: +1 -0
Minor changes in includes for MT
----------------------------
revision 1.3
date: 2005/07/21 16:51:03;  author: dwarren;  state: Exp;  lines: +4 -2
slginsts_xsb_i.h had a mt variable (grabbed) used in non-mt code.  I readjusted
the conditional code to hide all "grabbed" uses from non-mt code.
For deadlock.c, I included xsb_config.h first so MULTI_THREAD is defined
if it's going to be...
----------------------------
revision 1.2
date: 2005/07/21 10:46:35;  author: ruim;  state: Exp;  lines: +86 -2
preliminar implementation of deadlock breaking
----------------------------
revision 1.1
date: 2005/07/20 16:45:22;  author: ruim;  state: Exp;
added file deadlock.c in preparation for implementation of deadlock breaking
----------------------------
revision 1.21.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.21.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.21.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/deadlock.h,v
Working file: deadlock.h
head: 1.15
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.14
	ROLLBACK: 1.10
	latest_plus_supp_branch: 1.10.0.4
	latest_plus_supp: 1.10
	Version_3dot2_plus_supp: 1.10.0.2
	Version_3dot2: 1.10
	dec07-perf-results: 1.10
	mt_thesis: 1.8
	release_3_0: 1.5
keyword substitution: kv
total revisions: 18;	selected revisions: 18
description:
----------------------------
revision 1.15
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +1 -1

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.14
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.13
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.12
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.11
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.10
date: 2007/11/24 07:38:40;  author: ruim;  state: Exp;  lines: +0 -1
branches:  1.10.4;
rolled back last commit
it was unsafe
----------------------------
revision 1.9
date: 2007/11/24 06:53:58;  author: ruim;  state: Exp;  lines: +1 -0
released the completing mut during the more heavy duty tasks
when the leader is reseting the other threads in the SCC
in shared completed tables
----------------------------
revision 1.8
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +1 -1
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.7
date: 2006/11/06 17:31:53;  author: ruim;  state: Exp;  lines: +2 -1
Fixes to CONC_COMPL:

- compl stack expansion fixed
- freeing of answer_return list finally fixed

it now runs all the tests that batched runs
----------------------------
revision 1.6
date: 2006/11/02 02:59:44;  author: ruim;  state: Exp;  lines: +2 -0
added counter for deadlocks to show in statistics
----------------------------
revision 1.5
date: 2005/11/18 23:29:01;  author: tswift;  state: Exp;  lines: +23 -0

Took attv_interrupts array out of global area, and put it into
the thread context.  Also added, _gl suffix to realtime_count.

Other than that, just general documentation.
----------------------------
revision 1.4
date: 2005/08/13 15:04:02;  author: ruim;  state: Exp;  lines: +1 -1
changed defines to allow concurrent completion
made batch compile under mt
----------------------------
revision 1.3
date: 2005/08/01 19:10:49;  author: ruim;  state: Exp;  lines: +1 -0
changes to break deadlocks in negation and handle early completion
----------------------------
revision 1.2
date: 2005/07/21 10:46:35;  author: ruim;  state: Exp;  lines: +1 -0
preliminar implementation of deadlock breaking
----------------------------
revision 1.1
date: 2005/07/20 16:45:22;  author: ruim;  state: Exp;
added file deadlock.c in preparation for implementation of deadlock breaking
----------------------------
revision 1.10.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.10.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.10.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/debug.c,v
Working file: debug.c
head: 1.17
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.16
	without-attv: 1.14
	release-2-0: 1.8
	pre-release-2-0: 1.8
	v1-9-8: 1.5
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 18;	selected revisions: 18
description:
----------------------------
revision 1.17
date: 1999/10/25 05:57:41;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.16
date: 1999/10/12 20:15:18;  author: ejohnson;  state: Exp;  lines: +10 -10
Function of count_subgoals() is subsumed by new statistical routine in
table_stats.c.  But it suffices for file-internal use.

Subgoal Frames are now maintained by Structure_Manager struct rather
than a few variables.
----------------------------
revision 1.15
date: 1999/10/09 02:00:22;  author: cbaoqiu;  state: Exp;  lines: +15 -1
Changes for attributed variables (first step).
----------------------------
revision 1.14
date: 1999/10/05 04:01:22;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.13
date: 1999/09/17 22:20:58;  author: cbaoqiu;  state: Exp;  lines: +16 -7
Fixed two bugs: 1) a bug in print_subgoal(): a subgoal like p(X) was
printed as p(p(X)) before; 2) a bug in print_term_of_subgoal(): LIST
was not printed correctly.
----------------------------
revision 1.12
date: 1999/08/16 12:47:20;  author: kostis;  state: Exp;  lines: +5 -5
Fixed minor inconsistency introduced in MK's cleanup.
----------------------------
revision 1.11
date: 1999/08/16 07:24:08;  author: kifer;  state: Exp;  lines: +312 -306
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.10
date: 1999/08/04 14:41:52;  author: ejohnson;  state: Exp;  lines: +4 -4
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.9
date: 1999/07/06 16:35:08;  author: ejohnson;  state: Exp;  lines: +2 -2
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.8
date: 1999/04/16 16:14:31;  author: unova;  state: Exp;  lines: +2 -2
Changed types in printf for 64 bits portability.
----------------------------
revision 1.7
date: 1999/03/04 06:49:43;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Introduced new macros `makeaddr' and `addr_val', and changed some
`makeint' to `makeaddr' and `int_val' to `addr_val'.
----------------------------
revision 1.6
date: 1999/02/25 15:01:33;  author: kostis;  state: Exp;  lines: +2 -2
Changes for sliding garbage collection made default.
----------------------------
revision 1.5
date: 1999/01/28 09:03:03;  author: cbaoqiu;  state: Exp;  lines: +24 -12
Changed print_delay_element() because the SUBSF in a delay element is
not alway a CS pointer.
----------------------------
revision 1.4
date: 1999/01/19 15:36:22;  author: kostis;  state: Exp;  lines: +6 -33
Delete an unused and very obsolete function and minor cleanup.
----------------------------
revision 1.3
date: 1998/12/21 01:08:10;  author: cbaoqiu;  state: Exp;  lines: +167 -93
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:06:57;  author: cbaoqiu;  state: Exp;  lines: +29 -20
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  Function print_delay_element() is changed.
----------------------------
revision 1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debug_xsb.c,v
Working file: debug_xsb.c
head: 1.98
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.54
	ROLLBACK: 1.48
	latest_plus_supp_branch: 1.48.0.2
	latest_plus_supp: 1.48
	Version_3dot2_plus_supp: 1.46.0.2
	release_2_6_plus_supp: 1.21.0.4
	Version_3dot2: 1.46
	dec07-perf-results: 1.45
	mt_thesis: 1.35
	release_3_0: 1.32
	release_2_7_0: 1.22
	multi-threaded-26-engine: 1.14.2.3
	pre-mt: 1.22
	multi-threaded-25-engine-done: 1.14.2.1
	multi-threaded-25-engine: 1.14.0.2
	release_2_6_1: 1.21
	release_2_6_final: 1.21
	release_2_6: 1.21.0.2
	last-merged-to-demand: 1.20
	demand_branch: 1.20.0.2
	before_removing_chat: 1.15
	release_2_5: 1.14
	pre-merge-slgwam-gc: 1.13
	multi-threaded-c-engine: 1.13.0.2
	release_2_4: 1.13
	release_2_3: 1.11
	multi-threaded-engine: 1.11.0.2
	pre-threading: 1.8
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 114;	selected revisions: 114
description:
----------------------------
revision 1.98
date: 2012/07/13 22:51:50;  author: tswift;  state: Exp;  lines: +129 -114

Some updated debugging routines.
----------------------------
revision 1.97
date: 2012/06/07 19:37:41;  author: tswift;  state: Exp;  lines: +108 -10

A number of changes to extend forest logging to handle negation.
----------------------------
revision 1.96
date: 2012/05/23 14:21:19;  author: dwarren;  state: Exp;  lines: +11 -3
Add quotes around predicate names when needed.
----------------------------
revision 1.95
date: 2012/05/11 15:51:45;  author: tswift;  state: Exp;  lines: +5 -4

Fixed problem in writing out variables in routines used by
printanswertemplate.  This should fix some rough spots for forest
logging.
----------------------------
revision 1.94
date: 2012/02/24 21:06:49;  author: dwarren;  state: Exp;  lines: +2 -2
Minor changes to make ANSI, and quiet compiler.
Changed tempnam to _tempnam, which is current posix, it says.
----------------------------
revision 1.93
date: 2012/02/19 19:17:55;  author: tswift;  state: Exp;  lines: +8 -6

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.92
date: 2012/02/18 04:46:54;  author: kifer;  state: Exp;  lines: +3 -2
minated some compiler warnings
added DllExport to find_string, mem_alloc, mem_realloc.
----------------------------
revision 1.91
date: 2012/02/12 22:49:12;  author: tswift;  state: Exp;  lines: +6 -4

Fixed bug in throwing exceptions with incomplete tables.  Now tables
are reclaimed by unwind stack so that they stop *between* SCCs: this
allows us to continue reclaiming incomplete tables while at the same
time ensuring that we wont backtrack into a choice point for one of
those tables that we reclaimed.
----------------------------
revision 1.90
date: 2012/01/23 14:25:28;  author: dwarren;  state: Exp;  lines: +6 -6
Moved decl to beginning of function (a la ANSI), and added a couple of
casts to quiet 64-bit C compiler.
----------------------------
revision 1.89
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +160 -60
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.88
date: 2012/01/12 14:33:07;  author: dwarren;  state: Exp;  lines: +4 -4
Use a more conservative estimate of space taken by printed integers, floats, etc. in sprint_term.
----------------------------
revision 1.87
date: 2012/01/04 23:19:35;  author: tswift;  state: Exp;  lines: +2 -3

Schedrev -- slight re-integration of EC_OPT1
debug_xsb.c -- quiet the linux compiler.
----------------------------
revision 1.86
date: 2011/12/26 21:08:44;  author: tswift;  state: Exp;  lines: +44 -26

fixed  print_term_of_subgoal to properly print out lists and boxed floats.
----------------------------
revision 1.85
date: 2011/12/26 16:58:18;  author: tswift;  state: Exp;  lines: +4 -4
Changes for print_incomplete_tables/1.
----------------------------
revision 1.84
date: 2011/12/21 21:27:51;  author: tswift;  state: Exp;  lines: +31 -3

(re-) adding print_incomplete_tables.
----------------------------
revision 1.83
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +55 -19

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.82
date: 2011/11/13 18:18:31;  author: tswift;  state: Exp;  lines: +78 -6

Not printing out attributed variables with dots unless specified.
----------------------------
revision 1.81
date: 2011/10/29 23:27:58;  author: tswift;  state: Exp;  lines: +21 -1

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.80
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +3 -3

Integrating in Call Abstraction
----------------------------
revision 1.79
date: 2011/08/27 21:03:12;  author: tswift;  state: Exp;  lines: +2 -2

Took out printf
----------------------------
revision 1.78
date: 2011/08/26 01:42:02;  author: tswift;  state: Exp;  lines: +9 -4

Minor changes to improve printout on errors and Ctrace for certain
types of lists and for attributed variables.
----------------------------
revision 1.77
date: 2011/08/24 21:58:08;  author: tswift;  state: Exp;  lines: +97 -16

Added functionality to CTRACE and added a new debugging statement.
----------------------------
revision 1.76
date: 2011/08/19 18:26:30;  author: tswift;  state: Exp;  lines: +21 -4

Changes to support Ctrace (Fview).
----------------------------
revision 1.75
date: 2011/08/12 15:17:13;  author: tswift;  state: Exp;  lines: +3 -4

Fixes for approximate tabling and correcting memory errors.
----------------------------
revision 1.74
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +2 -2

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.73
date: 2011/07/06 20:19:52;  author: tswift;  state: Exp;  lines: +3 -3

Change to print out heap vars in a similar manner to trie vars.
----------------------------
revision 1.72
date: 2011/07/06 18:49:49;  author: tswift;  state: Exp;  lines: +2 -2

Fixed problem with writing out variables for tabled subgoals in Ctrace.
----------------------------
revision 1.71
date: 2011/07/06 15:43:18;  author: tswift;  state: Exp;  lines: +4 -3

Fixed bug in outputting lists.
----------------------------
revision 1.70
date: 2011/06/27 15:56:07;  author: dwarren;  state: Exp;  lines: +10 -10
Several minor fixes:
1. Added some type coercions to quiet MSVC compiler
2. Added some CTXT-type stuff so it would compile under MT flag.
3. Moved an external declaration from included file to file it's include
in, so that MSVC would compile it.
----------------------------
revision 1.69
date: 2011/06/26 21:24:43;  author: tswift;  state: Exp;  lines: +33 -10

Fixed list printing for tabled subgoals.
----------------------------
revision 1.68
date: 2011/06/26 21:01:13;  author: tswift;  state: Exp;  lines: +192 -45

Support for C-level trace.
----------------------------
revision 1.67
date: 2011/06/19 03:10:17;  author: kifer;  state: Exp;  lines: +3 -3
fixed a mistake in print_term and print_call
----------------------------
revision 1.66
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +8 -8
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.65
date: 2011/06/05 19:24:03;  author: tswift;  state: Exp;  lines: +215 -5



Changes to

1) Add flag-controlled answer depth checks to variant answer
tables.  (See current_prolog_flag in the manual for details).

2) In support of 1, added sprint_term, which prints a term to a C
string.  This is useful for errors and warnings invoked by C.

3) Added MAXTOINDEX_FLAG, which allows experimentation with the
depth of * indexing.

4) Increased the initial size strbuff from 1000 -> 10000.  This
reduces spurious long atom warnings.
----------------------------
revision 1.64
date: 2011/05/20 20:20:26;  author: tswift;  state: Exp;  lines: +6 -10

Fixed a couple of 32/64 compiler warnings.
----------------------------
revision 1.63
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +19 -15
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.62
date: 2011/05/16 01:03:30;  author: kifer;  state: Exp;  lines: +3 -2
squash warnings on windows and linux
----------------------------
revision 1.61
date: 2011/03/05 19:05:30;  author: tswift;  state: Exp;  lines: +5 -5
Better error message when max call term depth exceeded.
----------------------------
revision 1.60
date: 2011/02/23 21:58:22;  author: tswift;  state: Exp;  lines: +3 -3

Minor changes so that print_call can be used for general debugging. Also, tweaked attvar printing in printterm.
----------------------------
revision 1.59
date: 2011/01/17 02:31:33;  author: dwarren;  state: Exp;  lines: +3 -3
Moved some debug messages into conditional, so ptr is defined.
Fixed a couple of formats.
----------------------------
revision 1.58
date: 2011/01/09 22:30:16;  author: tswift;  state: Exp;  lines: +3 -3

Minor code cleanup: some changes in documentation, changes to make a
function name accord with a builtin name, and moved some table
abolishing routines from tries.c to tr_utils.c with all the others.
----------------------------
revision 1.57
date: 2010/12/20 13:58:09;  author: dwarren;  state: Exp;  lines: +3 -3
Changed a couple of int format specs to quiet compiler.
----------------------------
revision 1.56
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +3 -3

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.55
date: 2010/10/20 19:27:11;  author: tswift;  state: Exp;  lines: +107 -57

Added some invariant checks (not invoked unless DEBUG_VM is turned on).
----------------------------
revision 1.54
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +3 -3
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.53
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.52
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.51
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.50
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.49
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +3 -3
no message
----------------------------
revision 1.48
date: 2010/01/23 19:03:02;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.48.2;

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.47
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.46
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +2 -2


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.45
date: 2007/09/28 19:38:56;  author: tswift;  state: Exp;  lines: +2 -2
Minor changes to get rid of compiler warnings on 64-bit linux
----------------------------
revision 1.44
date: 2007/08/22 19:03:45;  author: tswift;  state: Exp;  lines: +2 -2
A couple of changes to get a cleaner compiler.
----------------------------
revision 1.43
date: 2007/08/08 17:50:49;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.42
date: 2007/07/10 20:29:34;  author: dwarren;  state: Exp;  lines: +10 -7
Add heap overflow tests to copying terms out of tries.  At every
push of a structure onto the heap, it checks for overflow.  (I had been
hoping to find a way to test more rarely, but this works and the
slowdown should be pretty minimal, I think.)  The hard
part was to fix garbage collection to handle the reg_array registers
and relocate them as well.  The sliding collector passes the test suite.
The copying collector fails a few tests, but I checked and the previous
cvs version failed the same tests, so I haven't made it any worse.

Also made some minor changes to debug_xsb.c so it would at least compile
for me under cygwin.
----------------------------
revision 1.41
date: 2007/06/08 15:27:03;  author: dwarren;  state: Exp;  lines: +1 -1
Ansi standard C for MSVC.  (I missed this somehow on my last checkin, sorry.)
----------------------------
revision 1.40
date: 2007/06/01 22:47:06;  author: tswift;  state: Exp;  lines: +18 -4

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.39
date: 2007/03/30 18:58:04;  author: dwarren;  state: Exp;  lines: +1 -1
Move a declaration up to beginning of block, so MSVC is happy.
(well, happier.)
----------------------------
revision 1.38
date: 2007/03/30 10:34:06;  author: tswift;  state: Exp;  lines: +20 -1

Changes for debugging: printing out structures (e.g. deleted clref chains) and more informative error reporting.
----------------------------
revision 1.37
date: 2007/02/22 00:16:04;  author: tswift;  state: Exp;  lines: +60 -25


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.36
date: 2007/02/09 18:12:16;  author: dwarren;  state: Exp;  lines: +16 -16
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.35
date: 2006/11/08 00:25:56;  author: tswift;  state: Exp;  lines: +58 -47
Fixed bug in which several "generations" of abolished tabled
predicates gave a core dump upon GC.  The fix compares the deltf
records in the GC chain to the choice points by finding the
call-trie root of the answer and comparing that root to one saved
in the deltf frame.

A new test in the sequential test suite was also added to ensure
the fix stays around.
----------------------------
revision 1.34
date: 2006/08/28 13:58:47;  author: tswift;  state: Exp;  lines: +38 -36

debug_xsb.c -- changes to allow print_delay_list from generic debug config
emuloop.c -- removed call to gdb_dummy
emudef.h --

Change to  affect the ordering of checks for interrupt vectors
at call and proceed.  We had been checking for spy points before
checking for attributed variable interrupts, and I reversed the order,
allowing me to use the debugger/tracer on CHR programs (still not a
great way to debug, but better than nothing for now).  I've been using
this change for a couple of days, and it seems to have no effect (as
indeed it shouldn't) but please let me know if it seems to be changing
anything in your code.
----------------------------
revision 1.33
date: 2006/08/21 10:47:26;  author: kostis;  state: Exp;  lines: +2 -2
Change to suppress GCC warning.
----------------------------
revision 1.32
date: 2006/07/14 16:49:36;  author: tswift;  state: Exp;  lines: +21 -1

Fixed relatively obscure bugs in clause gc.  With these fixes, the gc testsuite is working again, as does the flora testsuite.

Changes are (1 traverse CPS from bfreg if needed; 2 dont reclaim if there are ;/2 or db_get_clause CPs in the stack.

Also changed dis to allow it to print to a file if needed.
----------------------------
revision 1.31
date: 2006/07/08 18:49:11;  author: tswift;  state: Exp;  lines: +401 -325

Checks for private flag CLAUSE_GARBAGE_COLLECT that turns off space reclamation.  Useful for debugging.

In debug_xsb.c, wrote a Choice point stack printout routine with stuff needed for debugging clause/table gc.
----------------------------
revision 1.30
date: 2006/06/21 20:09:24;  author: dwarren;  state: Exp;  lines: +9 -6
Fixed so will compile with debug-vm.  Needs better fixing, but at least will
now compile.  (Problem was with changed way to indicate tabling.)
----------------------------
revision 1.29
date: 2006/03/24 16:40:28;  author: tswift;  state: Exp;  lines: +6 -1

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.28
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +21 -17


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.27
date: 2005/10/21 17:47:52;  author: tswift;  state: Exp;  lines: +10 -6


These are documentation changes only, made while stumbling through unfamiliar code.  I wanted to get them in before I started to make code changes.
----------------------------
revision 1.26
date: 2005/08/08 18:24:34;  author: dwarren;  state: Exp;  lines: +2 -1
Forgot to initialize clause_int to 0.
----------------------------
revision 1.25
date: 2005/08/06 16:29:54;  author: tswift;  state: Exp;  lines: +2 -1

Added check of Choice point stack to abolish_all_tables to ensure that it contains no choice points for completed tables.  Also, added some stubs for gc_clauses.
----------------------------
revision 1.24
date: 2005/07/18 21:54:08;  author: crojo;  state: Exp;  lines: +48 -39
*** empty log message ***
----------------------------
revision 1.23
date: 2005/01/14 18:30:54;  author: ruim;  state: Exp;  lines: +36 -34
Integration of multithreaded system
----------------------------
revision 1.22
date: 2004/09/29 21:41:55;  author: dwarren;  state: Exp;  lines: +9 -8
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.21
date: 2003/01/28 22:57:00;  author: dwarren;  state: Exp;  lines: +1 -2
Move write_canonical (and write_canonical_lettervars) to C.  Not for speed
but so that they can be accessed from C, and used in the ODBC interface to
write terms canonically to character fields.
----------------------------
revision 1.20
date: 2002/05/31 18:17:45;  author: lfcastro;  state: Exp;  lines: +33 -23
branches:  1.20.2;
* got rid of some warning messages
----------------------------
revision 1.19
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +163 -163
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.18
date: 2002/05/22 15:41:12;  author: lfcastro;  state: Exp;  lines: +813 -791
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.17
date: 2002/05/20 17:47:09;  author: tswift;  state: Exp;  lines: +17 -28

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.16
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -41
* Removal of Chat engine
----------------------------
revision 1.15
date: 2002/03/11 21:52:55;  author: lfcastro;  state: Exp;  lines: +1 -6
* initial conditional support for backtraces by keeping PSC pointers
in choicepoints
----------------------------
revision 1.14
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +3 -5
branches:  1.14.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.13
date: 2001/06/05 19:17:58;  author: lfcastro;  state: Exp;  lines: +51 -1
* re-structured XMC package bootstrapping as suggested by Kifer
* simplified process of compilation for the smodels package
----------------------------
revision 1.12
date: 2001/04/28 20:15:36;  author: ejohnson;  state: Exp;  lines: +58 -43
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.11
date: 2000/06/28 16:54:49;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.11.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.10
date: 2000/06/25 16:59:15;  author: ejohnson;  state: Exp;  lines: +17 -1
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.9
date: 2000/06/23 20:54:07;  author: ruim;  state: Exp;  lines: +2 -2
Removed some C++ automatic pointer casting warnings
----------------------------
revision 1.8
date: 2000/05/29 04:23:35;  author: ejohnson;  state: Exp;  lines: +39 -27
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.7
date: 2000/05/25 00:32:01;  author: ejohnson;  state: Exp;  lines: +34 -4
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.6
date: 2000/05/20 06:55:57;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.5
date: 2000/05/12 20:18:15;  author: ejohnson;  state: Exp;  lines: +111 -34
Fix for builtins abolish_all_tables and abolish_table_pred.
Checks that the subgoals are (marked as) complete before destroying
the tables.

Other supporting changes:

Added a field in TableInfoFrames (TIF) for maintaining references to
the subgoals according to predicate, rather than one global list.
Routines which walked this list had to be appropriately modified.

Discovered that TIFs weren't being counted in memory usage, so changed
their allocation to use mem_alloc() instead of malloc().

Moved the code which places a TIF on the alloc chain, maintained
through `first_tip' and `last_tip', into macro New_TIF().
Removed this code from biassert.c and loader_xsb.c.

Made a structure out of `first_tip' and `last_tip'.  Added an extern
for this structure to macro_xsb.h, and hence removed the externs from
biassert.c and builtin.c.  Modified references appropriately.

Producer subgoal frame allocation now puts the SF into the predicate's
TIF.
----------------------------
revision 1.4
date: 2000/04/29 21:53:51;  author: kifer;  state: Exp;  lines: +297 -294
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.3
date: 2000/01/07 08:51:23;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.3.2;
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.2
date: 1999/10/26 06:46:56;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:57:44;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.2.1
date: 2000/03/28 18:10:31;  author: lfcastro;  state: Exp;  lines: +7 -108
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.11.2.3
date: 2001/01/06 18:43:04;  author: ruim;  state: Exp;  lines: +3 -1
Initialization data made static and other small changes
----------------------------
revision 1.11.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.11.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +55 -3
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.14.2.3
date: 2004/11/19 17:09:05;  author: ruim;  state: Exp;  lines: +10 -10
integrated debug-mv confguration
----------------------------
revision 1.14.2.2
date: 2004/10/18 20:46:00;  author: ruim;  state: Exp;  lines: +864 -888
update for version 2.6.1
----------------------------
revision 1.14.2.1
date: 2004/09/29 19:44:11;  author: ruim;  state: Exp;  lines: +35 -34
Sources from rfm repository
----------------------------
revision 1.20.2.5
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +19 -14
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.20.2.4
date: 2003/04/17 17:11:50;  author: lfcastro;  state: Exp;  lines: +1 -2
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.20.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +2 -3
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.20.2.2
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +4 -3
* update to HEAD
----------------------------
revision 1.20.2.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +3 -4
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.48.2.4
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.48.2.3
date: 2010/06/24 21:04:43;  author: spyrosh;  state: Exp;  lines: +2 -2
no message
----------------------------
revision 1.48.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.48.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debug_xsb.h,v
Working file: debug_xsb.h
head: 1.34
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.16
	ROLLBACK: 1.10
	latest_plus_supp_branch: 1.10.0.4
	latest_plus_supp: 1.10
	Version_3dot2_plus_supp: 1.10.0.2
	release_2_6_plus_supp: 1.3.0.8
	Version_3dot2: 1.10
	dec07-perf-results: 1.9
	mt_thesis: 1.8
	release_3_0: 1.7
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.3.6.2
	pre-mt: 1.3
	multi-threaded-25-engine: 1.3.0.6
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.4
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.2
keyword substitution: kv
total revisions: 44;	selected revisions: 44
description:
----------------------------
revision 1.34
date: 2012/07/13 22:51:51;  author: tswift;  state: Exp;  lines: +3 -1

Some updated debugging routines.
----------------------------
revision 1.33
date: 2012/06/07 19:37:42;  author: tswift;  state: Exp;  lines: +6 -4

A number of changes to extend forest logging to handle negation.
----------------------------
revision 1.32
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +14 -10
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.31
date: 2011/12/26 16:58:18;  author: tswift;  state: Exp;  lines: +3 -3
Changes for print_incomplete_tables/1.
----------------------------
revision 1.30
date: 2011/12/24 20:47:12;  author: tswift;  state: Exp;  lines: +3 -1

Fix for MT engine.
----------------------------
revision 1.29
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +5 -1

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.28
date: 2011/10/29 23:27:58;  author: tswift;  state: Exp;  lines: +2 -1

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.27
date: 2011/08/24 21:58:08;  author: tswift;  state: Exp;  lines: +2 -2

Added functionality to CTRACE and added a new debugging statement.
----------------------------
revision 1.26
date: 2011/08/22 16:15:24;  author: dwarren;  state: Exp;  lines: +3 -1
Cleaned up recent checkins to work with MSVC, and avoid warnings.
(Changed bzero to memset, since MS seems not to have bzero.)
Also changed a couple of builtins to be more consistent in their
treatment of string p vs. 0-ary structure symbol p.
----------------------------
revision 1.25
date: 2011/08/19 21:44:15;  author: tswift;  state: Exp;  lines: +3 -1

Mostly minor changes to let ctrace print out early completion, and to
allow ctrace to be directed to stdout rather than a file if desired.
This necessitated some minor code refactoring.
----------------------------
revision 1.24
date: 2011/08/19 18:26:30;  author: tswift;  state: Exp;  lines: +3 -3

Changes to support Ctrace (Fview).
----------------------------
revision 1.23
date: 2011/08/13 20:13:41;  author: tswift;  state: Exp;  lines: +2 -2

Fixed extern declaration for MT engine.
----------------------------
revision 1.22
date: 2011/08/12 15:17:13;  author: tswift;  state: Exp;  lines: +2 -2

Fixes for approximate tabling and correcting memory errors.
----------------------------
revision 1.21
date: 2011/07/02 14:27:38;  author: tswift;  state: Exp;  lines: +3 -1

More updates for C-level trace.
----------------------------
revision 1.20
date: 2011/06/27 15:56:07;  author: dwarren;  state: Exp;  lines: +2 -2
Several minor fixes:
1. Added some type coercions to quiet MSVC compiler
2. Added some CTXT-type stuff so it would compile under MT flag.
3. Moved an external declaration from included file to file it's include
in, so that MSVC would compile it.
----------------------------
revision 1.19
date: 2011/06/26 21:01:13;  author: tswift;  state: Exp;  lines: +5 -3

Support for C-level trace.
----------------------------
revision 1.18
date: 2011/03/05 19:05:30;  author: tswift;  state: Exp;  lines: +3 -2
Better error message when max call term depth exceeded.
----------------------------
revision 1.17
date: 2011/02/23 21:58:22;  author: tswift;  state: Exp;  lines: +2 -1

Minor changes so that print_call can be used for general debugging. Also, tweaked attvar printing in printterm.
----------------------------
revision 1.16
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -5
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.15
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.14
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +5 -1
no message
----------------------------
revision 1.10
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +6 -2
branches:  1.10.4;


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.9
date: 2007/02/22 00:16:04;  author: tswift;  state: Exp;  lines: +1 -6


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.8
date: 2006/08/28 13:58:47;  author: tswift;  state: Exp;  lines: +8 -4

debug_xsb.c -- changes to allow print_delay_list from generic debug config
emuloop.c -- removed call to gdb_dummy
emudef.h --

Change to  affect the ordering of checks for interrupt vectors
at call and proceed.  We had been checking for spy points before
checking for attributed variable interrupts, and I reversed the order,
allowing me to use the debugger/tracer on CHR programs (still not a
great way to debug, but better than nothing for now).  I've been using
this change for a couple of days, and it seems to have no effect (as
indeed it shouldn't) but please let me know if it seems to be changing
anything in your code.
----------------------------
revision 1.7
date: 2006/01/09 00:06:30;  author: tswift;  state: Exp;  lines: +4 -2
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.6
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +2 -2
made private flags array for sequential engine
----------------------------
revision 1.5
date: 2005/07/18 21:54:09;  author: crojo;  state: Exp;  lines: +2 -1
*** empty log message ***
----------------------------
revision 1.4
date: 2005/01/14 18:30:55;  author: ruim;  state: Exp;  lines: +1 -3
Integration of multithreaded system
----------------------------
revision 1.3
date: 2002/05/31 18:17:45;  author: lfcastro;  state: Exp;  lines: +1 -9
branches:  1.3.2;  1.3.6;
* got rid of some warning messages
----------------------------
revision 1.2
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +4 -4
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.1
date: 2002/05/22 15:41:12;  author: lfcastro;  state: Exp;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.3.6.2
date: 2004/11/19 17:09:09;  author: ruim;  state: Exp;  lines: +1 -3
integrated debug-mv confguration
----------------------------
revision 1.3.6.1
date: 2004/10/18 20:46:01;  author: ruim;  state: Exp;  lines: +1 -1
update for version 2.6.1
----------------------------
revision 1.3.2.4
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +15 -14
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.3.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +10 -1
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.3.2.2
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +2 -11
* update to HEAD
----------------------------
revision 1.3.2.1
date: 2002/07/31 20:13:46;  author: lfcastro;  state: Exp;  lines: +11 -2
* demand_once/1 predicate cuts over tables, deleting incomplete tables
whose producer is in the scope of the "cut" (preliminary version)
----------------------------
revision 1.10.4.4
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.10.4.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +4 -0
no message
----------------------------
revision 1.10.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.10.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/demand.c,v
Working file: demand.c
head: 1.1
branch:
locks: strict
access list:
symbolic names:
	demand_branch: 1.1.0.2
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.1
date: 2002/08/07 17:42:24;  author: lfcastro;  state: dead;
branches:  1.1.2;
file demand.c was initially added on branch demand_branch.
----------------------------
revision 1.1.2.15
date: 2003/08/25 18:50:36;  author: lfcastro;  state: Exp;  lines: +28 -92
* Cleanups
----------------------------
revision 1.1.2.14
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +194 -39
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.1.2.13
date: 2003/04/17 17:11:50;  author: lfcastro;  state: Exp;  lines: +25 -16
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.1.2.12
date: 2003/02/11 18:36:28;  author: lfcastro;  state: Exp;  lines: +3 -1
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.1.2.11
date: 2002/11/01 22:38:28;  author: lfcastro;  state: Exp;  lines: +101 -58
* Use approximate pruning when cutting (only when DEMAND is enabled)
----------------------------
revision 1.1.2.10
date: 2002/11/01 14:41:50;  author: lfcastro;  state: Exp;  lines: +27 -6
* bugfixes
* updated tests
----------------------------
revision 1.1.2.9
date: 2002/10/29 15:29:24;  author: lfcastro;  state: Exp;  lines: +171 -143
* rewritten to use Approximate Once algorithm
----------------------------
revision 1.1.2.8
date: 2002/10/10 19:41:46;  author: lfcastro;  state: Exp;  lines: +43 -22
* Detect & abort on cases not handled -- more specifically, when
there's external demand to a table that's inside the scope of the
pruning.
----------------------------
revision 1.1.2.7
date: 2002/08/29 19:25:33;  author: lfcastro;  state: Exp;  lines: +13 -16
* ADDED code to undemand completion suspension choice points
----------------------------
revision 1.1.2.6
date: 2002/08/29 18:49:17;  author: lfcastro;  state: Exp;  lines: +1 -1
* IMPLEMENTED "scope chain"
  - scope of a once cannot be represented by normal backtracking
  chain, since check_complete may modify this chain
  - an additional word is maintained in all choicepoints in order to
  keep this "scope" chain
  - another approach would be to change the completion algorithms to
  keep the right order (?)
----------------------------
revision 1.1.2.5
date: 2002/08/29 14:17:12;  author: lfcastro;  state: Exp;  lines: +22 -13
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.1.2.4
date: 2002/08/28 19:20:26;  author: lfcastro;  state: Exp;  lines: +12 -7
* FIXED problem in once/1 when there are no choicepoints under its
  scope
* MERGED patch from HEAD that fixes bug in interrupt handling (& attv)
* INCLUDED test predicate for demand & negation
----------------------------
revision 1.1.2.3
date: 2002/08/12 18:03:55;  author: lfcastro;  state: Exp;  lines: +4 -2
- fix buglet

Status: demand_once/1 deletes tables in its scope, dealing
(apparently) correctly with suspended consumers & multiple
branches. Reflects (an approximation of) our intended semantics.
----------------------------
revision 1.1.2.2
date: 2002/08/10 00:19:33;  author: lfcastro;  state: Exp;  lines: +127 -92
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.1.2.1
date: 2002/08/07 17:42:24;  author: lfcastro;  state: Exp;  lines: +227 -0
* create new module, demand.o
* guard .h files from multiple inclusion
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/demand.h,v
Working file: demand.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.2.0.8
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.6.1
	pre-mt: 1.2
	multi-threaded-25-engine: 1.2.0.6
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.4
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.2
keyword substitution: kv
total revisions: 24;	selected revisions: 24
description:
----------------------------
revision 1.9
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.8
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2005/01/14 18:30:55;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.3.4;
Integration of multithreaded system
----------------------------
revision 1.2
date: 2002/05/22 15:41:12;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.2.2;  1.2.6;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.1
date: 2002/03/14 22:13:57;  author: lfcastro;  state: Exp;
* first step in implementing demand
- new (experimental) primitive: demand_once/1
- executes query and, after first answer is returned, deletes all
consumers created during execution; further, any tables created are
also destroyed
----------------------------
revision 1.2.6.1
date: 2004/10/18 20:46:01;  author: ruim;  state: Exp;  lines: +1 -1
update for version 2.6.1
----------------------------
revision 1.2.2.11
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +3 -5
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.2.2.10
date: 2003/02/11 18:36:28;  author: lfcastro;  state: Exp;  lines: +15 -8
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.2.2.9
date: 2002/11/01 22:38:29;  author: lfcastro;  state: Exp;  lines: +6 -5
* Use approximate pruning when cutting (only when DEMAND is enabled)
----------------------------
revision 1.2.2.8
date: 2002/10/29 15:29:24;  author: lfcastro;  state: Exp;  lines: +20 -0
* rewritten to use Approximate Once algorithm
----------------------------
revision 1.2.2.7
date: 2002/08/29 14:17:13;  author: lfcastro;  state: Exp;  lines: +3 -3
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.2.2.6
date: 2002/08/28 19:20:25;  author: lfcastro;  state: Exp;  lines: +6 -0
* FIXED problem in once/1 when there are no choicepoints under its
  scope
* MERGED patch from HEAD that fixes bug in interrupt handling (& attv)
* INCLUDED test predicate for demand & negation
----------------------------
revision 1.2.2.5
date: 2002/08/10 00:19:34;  author: lfcastro;  state: Exp;  lines: +18 -0
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.2.2.4
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +5 -82
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.2.2.3
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +83 -6
* update to HEAD
----------------------------
revision 1.2.2.2
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +6 -94
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.2.2.1
date: 2002/07/31 20:13:46;  author: lfcastro;  state: Exp;  lines: +26 -15
* demand_once/1 predicate cuts over tables, deleting incomplete tables
whose producer is in the scope of the "cut" (preliminary version)
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/deref.h,v
Working file: deref.h
head: 1.13
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.13
	ROLLBACK: 1.8
	latest_plus_supp_branch: 1.8.0.4
	latest_plus_supp: 1.8
	Version_3dot2_plus_supp: 1.8.0.2
	release_2_6_plus_supp: 1.6.0.4
	Version_3dot2: 1.8
	dec07-perf-results: 1.8
	mt_thesis: 1.8
	release_3_0: 1.8
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.5.8.2
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.5.8.1
	multi-threaded-25-engine: 1.5.0.8
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.2
	last-merged-to-demand: 1.5
	demand_branch: 1.5.0.6
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.4
	release_2_4: 1.5
	release_2_3: 1.5
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.5
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.4
	release-2-0-1: 1.4
	subsumption: 1.4
	without-attv: 1.3
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 25;	selected revisions: 25
description:
----------------------------
revision 1.13
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.12
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.11
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2005/10/21 17:47:52;  author: tswift;  state: Exp;  lines: +10 -16
branches:  1.8.4;


These are documentation changes only, made while stumbling through unfamiliar code.  I wanted to get them in before I started to make code changes.
----------------------------
revision 1.7
date: 2005/01/14 18:30:55;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.6
date: 2002/10/04 20:42:01;  author: lfcastro;  state: Exp;  lines: +4 -1
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.5
date: 2000/04/29 21:53:52;  author: kifer;  state: Exp;  lines: +7 -7
branches:  1.5.2;  1.5.6;  1.5.8;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.4
date: 1999/10/09 02:00:23;  author: cbaoqiu;  state: Exp;  lines: +44 -1
Changes for attributed variables (first step).
----------------------------
revision 1.3
date: 1999/07/04 10:39:18;  author: kostis;  state: Exp;  lines: +7 -5
Changes in the general unification routine to speed up unification;
around 10-20% for some programs; courtecy of Bart Demoen and Kostis
Sagonas.
----------------------------
revision 1.2
date: 1998/12/21 01:08:13;  author: cbaoqiu;  state: Exp;  lines: +1 -12
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.5.8.2
date: 2004/10/18 20:46:01;  author: ruim;  state: Exp;  lines: +4 -1
update for version 2.6.1
----------------------------
revision 1.5.8.1
date: 2004/09/29 19:44:11;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.5.6.4
date: 2003/04/17 17:11:49;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.5.6.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +3 -0
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.5.6.2
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +1 -4
* update to HEAD
----------------------------
revision 1.5.6.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +4 -1
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.8.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.8.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dis.c,v
Working file: dis.c
head: 1.36
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.35
	ROLLBACK: 1.30
	latest_plus_supp_branch: 1.30.0.2
	latest_plus_supp: 1.30
	Version_3dot2_plus_supp: 1.29.0.2
	release_2_6_plus_supp: 1.17.0.10
	Version_3dot2: 1.29
	dec07-perf-results: 1.29
	mt_thesis: 1.29
	release_3_0: 1.29
	release_2_7_0: 1.20
	multi-threaded-26-engine: 1.17.8.2
	pre-mt: 1.20
	multi-threaded-25-engine-done: 1.17.8.1
	multi-threaded-25-engine: 1.17.0.8
	release_2_6_1: 1.17
	release_2_6_final: 1.17
	release_2_6: 1.17.0.6
	last-merged-to-demand: 1.17
	demand_branch: 1.17.0.4
	before_removing_chat: 1.17
	release_2_5: 1.17
	pre-merge-slgwam-gc: 1.17
	multi-threaded-c-engine: 1.17.0.2
	release_2_4: 1.17
	release_2_3: 1.17
	multi-threaded-engine: 1.15.0.2
	pre-threading: 1.14
	release-2-2: 1.12
	chat-and-local: 1.12.0.2
	xsb-pre-cleanup: 1.12
	release-2-1: 1.9
	release-2-0-1: 1.9
	subsumption: 1.7
	without-attv: 1.7
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 46;	selected revisions: 46
description:
----------------------------
revision 1.36
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.35
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.34
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.33
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.32
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.31
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.30
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.30.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.29
date: 2006/07/14 16:49:36;  author: tswift;  state: Exp;  lines: +16 -17

Fixed relatively obscure bugs in clause gc.  With these fixes, the gc testsuite is working again, as does the flora testsuite.

Changes are (1 traverse CPS from bfreg if needed; 2 dont reclaim if there are ;/2 or db_get_clause CPs in the stack.

Also changed dis to allow it to print to a file if needed.
----------------------------
revision 1.28
date: 2006/04/17 20:54:56;  author: tswift;  state: Exp;  lines: +2 -1

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.27
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +2 -2


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.26
date: 2005/09/09 23:53:21;  author: tswift;  state: Exp;  lines: +2 -2

PSC records are overloaded, so I added some documentation.  Also, got rid of T_FILE PSC type, as all file descriptors should go through the steram table now.
----------------------------
revision 1.25
date: 2005/08/08 17:11:30;  author: dwarren;  state: Exp;  lines: +3 -3
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.24
date: 2005/08/01 23:03:29;  author: tswift;  state: Exp;  lines: +2 -1
1) Changes to error handling in assert, retract, abolish, clause, and
   related predicates to make the error terms a bit more ISO-like.

2) Change to psc_prop to check for T_DYNA in addition to T_PRED.
----------------------------
revision 1.23
date: 2005/07/18 21:54:09;  author: crojo;  state: Exp;  lines: +2 -2
*** empty log message ***
----------------------------
revision 1.22
date: 2005/07/15 15:02:21;  author: dwarren;  state: Exp;  lines: +2 -1
Made assert thread-safe (I hope.)  Problem was asserta, and I added
mutex_lock in jumptbreg when just entering asserted code, and I release
it after the code for the first clause to be executed is found and about
to be entered.  It introduces new instructions: dyntrymeelse, dynnoop, and
dynfail to release the lock.
assertz was made safe (I hope) without locks, by adding the new clause at the
end and then as the last thing, changing the opcode of the old-last clause
from dyntrust to retry.  Since dyntrust doesn't look at any argument, this
should work.
----------------------------
revision 1.21
date: 2005/01/14 18:30:55;  author: ruim;  state: Exp;  lines: +2 -2
Integration of multithreaded system
----------------------------
revision 1.20
date: 2003/10/28 18:03:13;  author: kostis;  state: Exp;  lines: +2 -2
Eliminated trigraph warning
----------------------------
revision 1.19
date: 2003/07/22 18:30:17;  author: lfcastro;  state: Exp;  lines: +19 -7
* Second pass at Prolog-ifying disassemble output (small aesthetic fixes).
----------------------------
revision 1.18
date: 2003/07/22 18:15:47;  author: lfcastro;  state: Exp;  lines: +71 -53
* First pass at Prolog-ifying disassemble output.
----------------------------
revision 1.17
date: 2001/02/06 16:56:36;  author: lfcastro;  state: Exp;  lines: +4 -9
branches:  1.17.8;
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.16
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +25 -15
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.15
date: 2000/06/28 16:54:49;  author: ruim;  state: Exp;  lines: +4 -4
branches:  1.15.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.14
date: 2000/05/20 06:55:57;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.13
date: 2000/04/29 21:53:52;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.12
date: 2000/03/01 16:22:33;  author: dwarren;  state: Exp;  lines: +3 -3
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.11
date: 2000/01/07 08:51:24;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.10
date: 1999/12/21 22:56:38;  author: warren;  state: Exp;  lines: +2 -2
cleanup to reduce number of warnings given by MSVC compiler.
----------------------------
revision 1.9
date: 1999/10/26 06:46:56;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.8
date: 1999/10/25 05:57:47;  author: kifer;  state: Exp;  lines: +5 -5
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.7
date: 1999/10/05 04:01:24;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.6
date: 1999/08/30 13:57:28;  author: kostis;  state: Exp;  lines: +1 -4
Unused and obsolete PSC stuff taken out.
----------------------------
revision 1.5
date: 1999/08/09 00:34:17;  author: kifer;  state: Exp;  lines: +2 -1
Added process control builtins, deprecated unix.P,
added C preprocessor.
----------------------------
revision 1.4
date: 1999/08/04 14:41:54;  author: ejohnson;  state: Exp;  lines: +2 -2
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.3
date: 1999/03/17 18:34:46;  author: kostis;  state: Exp;  lines: +2 -1
Changes to separate out all builtin #defines from "inst.h" and have them
appear in a new file called "builtin.h".
----------------------------
revision 1.2
date: 1999/01/25 18:36:59;  author: kostis;  state: Exp;  lines: +4 -2
Fixed minor inconsistency in the handling of numbers and integers.
----------------------------
revision 1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.15.2.4
date: 2001/01/07 00:32:50;  author: ruim;  state: Exp;  lines: +2 -0
fixes
----------------------------
revision 1.15.2.3
date: 2001/01/06 18:43:04;  author: ruim;  state: Exp;  lines: +11 -1
Initialization data made static and other small changes
----------------------------
revision 1.15.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.15.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.17.8.2
date: 2004/11/04 22:31:12;  author: tswift;  state: Exp;  lines: +2 -2

Changes for compilation in cygwin.  This will not affect the linux distribution (I hope).
Changes are:

	1) execute -> xsb_execute, to avoid conflict with pthread.h in cygwin
	2) Renamed mutex constants to accord with pthread.h in cygwin.
----------------------------
revision 1.17.8.1
date: 2004/09/29 19:44:12;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.30.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.30.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.30.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/dllinit_xsb.cc,v
Working file: dllinit_xsb.cc
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.5
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.14
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.12
	release_2_6_plus_supp: 1.1.0.10
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.8
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.6
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.4
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
	release_2_4: 1.1
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.6
date: 2011/03/28 13:10:50;  author: dwarren;  state: dead;  lines: +0 -0
File no longer needed with new simpler way of generating the xsb dll.
----------------------------
revision 1.5
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 2001/05/17 12:50:20;  author: dwarren;  state: Exp;
branches:  1.1.14;
Allow -mno-cygwin gcc generation of XSB DLL.
----------------------------
revision 1.1.14.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.14.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1.14.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dynamic_stack.c,v
Working file: dynamic_stack.c
head: 1.15
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.13
	ROLLBACK: 1.8
	latest_plus_supp_branch: 1.8.0.4
	latest_plus_supp: 1.8
	Version_3dot2_plus_supp: 1.8.0.2
	release_2_6_plus_supp: 1.4.0.6
	Version_3dot2: 1.8
	dec07-perf-results: 1.8
	mt_thesis: 1.7
	release_3_0: 1.7
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.2.6.2
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.2.6.1
	multi-threaded-25-engine: 1.2.0.6
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.4
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.2
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
keyword substitution: kv
total revisions: 22;	selected revisions: 22
description:
----------------------------
revision 1.15
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +4 -4
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.14
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.13
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.12
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.11
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -1
branches:  1.8.4;
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.7
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +10 -8
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.6
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +5 -4
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.5
date: 2005/01/14 18:30:55;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.4
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +8 -8
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.3
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +15 -16
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.2
date: 2000/06/26 20:09:08;  author: ejohnson;  state: Exp;  lines: +6 -3
branches:  1.2.2;  1.2.6;
Small change to dsExpand().
----------------------------
revision 1.1
date: 2000/06/25 16:59:15;  author: ejohnson;  state: Exp;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.2.6.2
date: 2004/10/18 20:46:01;  author: ruim;  state: Exp;  lines: +18 -19
update for version 2.6.1
----------------------------
revision 1.2.6.1
date: 2004/09/29 19:44:12;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.2.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.8.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.8.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dynamic_stack.h,v
Working file: dynamic_stack.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.10.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.10.1
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.9
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.8
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2005/01/14 18:30:55;  author: ruim;  state: Exp;  lines: +2 -1
branches:  1.3.4;
Integration of multithreaded system
----------------------------
revision 1.2
date: 2000/06/26 15:53:26;  author: ejohnson;  state: Exp;  lines: +6 -1
branches:  1.2.2;  1.2.10;
Converted another stack (tstTrail) utilized by the trie routines from
static to dynamic.
----------------------------
revision 1.1
date: 2000/06/25 16:59:15;  author: ejohnson;  state: Exp;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.2.10.2
date: 2004/12/14 08:47:05;  author: ruim;  state: Exp;  lines: +1 -2
added dynamic stacks to thread context
----------------------------
revision 1.2.10.1
date: 2004/09/29 19:44:12;  author: ruim;  state: Exp;  lines: +3 -1
Sources from rfm repository
----------------------------
revision 1.2.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/dynaout.i,v
Working file: dynaout.i
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.5
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.2
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.2
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.6
date: 1999/10/25 05:57:51;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5
date: 1999/10/05 04:01:25;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.4
date: 1999/08/16 07:24:10;  author: kifer;  state: Exp;  lines: +8 -6
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.3
date: 1999/04/22 06:49:13;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.2
date: 1998/11/13 02:48:57;  author: kifer;  state: Exp;  lines: +3 -1
Modifications for porting to NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:14;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dynaout_xsb_i.h,v
Working file: dynaout_xsb_i.h
head: 1.19
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.19
	ROLLBACK: 1.14
	latest_plus_supp_branch: 1.14.0.4
	latest_plus_supp: 1.14
	Version_3dot2_plus_supp: 1.14.0.2
	release_2_6_plus_supp: 1.9.0.4
	Version_3dot2: 1.14
	dec07-perf-results: 1.13
	mt_thesis: 1.12
	release_3_0: 1.12
	release_2_7_0: 1.9
	multi-threaded-26-engine: 1.6.6.2
	pre-mt: 1.9
	multi-threaded-25-engine-done: 1.6.6.1
	multi-threaded-25-engine: 1.6.0.6
	release_2_6_1: 1.9
	release_2_6_final: 1.9
	release_2_6: 1.9.0.2
	last-merged-to-demand: 1.8
	demand_branch: 1.8.0.2
	before_removing_chat: 1.6
	release_2_5: 1.6
	pre-merge-slgwam-gc: 1.6
	multi-threaded-c-engine: 1.6.0.4
	release_2_4: 1.6
	release_2_3: 1.6
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.6
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 27;	selected revisions: 27
description:
----------------------------
revision 1.19
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.18
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.17
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2008/04/06 23:04:22;  author: tswift;  state: Exp;  lines: +4 -3
branches:  1.14.4;
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.13
date: 2007/08/09 04:11:05;  author: evansbj;  state: Exp;  lines: +2 -1
Add missing #include "context.h"
----------------------------
revision 1.12
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +3 -3

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.11
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +6 -6
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.10
date: 2005/01/14 18:30:55;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.9
date: 2002/09/02 01:00:19;  author: kifer;  state: Exp;  lines: +2 -1
C interface now works under Cygwin.
It utilizes Windows DLLs and works like under Windows.

It appears that the switchover from .O to .xwam wasn't needed for this purpose,
although it probably was a good thing anyway.
----------------------------
revision 1.8
date: 2002/03/15 09:19:51;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.8.2;
renamed loader_defs.h to extensions.h
----------------------------
revision 1.7
date: 2002/03/15 05:01:19;  author: kifer;  state: Exp;  lines: +10 -2
got rid of the dependency on .O
----------------------------
revision 1.6
date: 2000/05/20 06:55:58;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.6.2;  1.6.6;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.5
date: 2000/04/29 21:53:52;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.4
date: 2000/03/01 16:22:33;  author: dwarren;  state: Exp;  lines: +4 -4
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.3
date: 1999/11/30 05:03:12;  author: kifer;  state: Exp;  lines: +2 -6
code cleanup
----------------------------
revision 1.2
date: 1999/10/26 06:46:57;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:57:53;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.6.6.2
date: 2004/10/18 20:46:01;  author: ruim;  state: Exp;  lines: +11 -2
update for version 2.6.1
----------------------------
revision 1.6.6.1
date: 2004/09/29 19:44:12;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.8.2.1
date: 2003/04/17 17:11:49;  author: lfcastro;  state: Exp;  lines: +2 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.14.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.14.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.14.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/dyncoff.i,v
Working file: dyncoff.i
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.5
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.2
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.2
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.6
date: 1999/10/21 06:22:45;  author: kifer;  state: dead;  lines: +1 -1
sent the COFF stuff to the attic
----------------------------
revision 1.5
date: 1999/10/05 04:01:27;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.4
date: 1999/08/16 07:24:11;  author: kifer;  state: Exp;  lines: +8 -6
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.3
date: 1999/04/22 06:49:14;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.2
date: 1998/11/13 02:48:59;  author: kifer;  state: Exp;  lines: +3 -1
Modifications for porting to NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/dynelf.i,v
Working file: dynelf.i
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.5
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.2
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.2
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.9
date: 1999/10/25 05:57:57;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.8
date: 1999/10/18 20:50:31;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changed the file name in the header.
----------------------------
revision 1.7
date: 1999/10/18 20:37:22;  author: luis;  state: Exp;  lines: +14 -14
- setenv isn't standard...
----------------------------
revision 1.6
date: 1999/10/18 20:10:13;  author: luis;  state: Exp;  lines: +20 -2
- introduced handling of shared libraries path from ldoptions when
loading foreign modules
----------------------------
revision 1.5
date: 1999/10/05 04:01:28;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.4
date: 1999/08/16 07:24:12;  author: kifer;  state: Exp;  lines: +7 -5
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.3
date: 1999/04/22 06:49:15;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.2
date: 1998/11/13 02:49:01;  author: kifer;  state: Exp;  lines: +3 -1
Modifications for porting to NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dynelf_xsb_i.h,v
Working file: dynelf_xsb_i.h
head: 1.29
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.29
	ROLLBACK: 1.24
	latest_plus_supp_branch: 1.24.0.4
	latest_plus_supp: 1.24
	Version_3dot2_plus_supp: 1.24.0.2
	release_2_6_plus_supp: 1.20.0.6
	Version_3dot2: 1.24
	dec07-perf-results: 1.24
	mt_thesis: 1.23
	release_3_0: 1.23
	release_2_7_0: 1.20
	multi-threaded-26-engine: 1.17.4.2
	pre-mt: 1.20
	multi-threaded-25-engine-done: 1.17.4.1
	multi-threaded-25-engine: 1.17.0.4
	release_2_6_1: 1.20
	release_2_6_final: 1.20
	release_2_6: 1.20.0.4
	last-merged-to-demand: 1.20
	demand_branch: 1.20.0.2
	before_removing_chat: 1.17
	release_2_5: 1.17
	pre-merge-slgwam-gc: 1.17
	multi-threaded-c-engine: 1.17.0.2
	release_2_4: 1.16
	release_2_3: 1.16
	multi-threaded-engine: 1.16.0.2
	pre-threading: 1.16
	release-2-2: 1.13
	chat-and-local: 1.13.0.2
	xsb-pre-cleanup: 1.13
	release-2-1: 1.6
	release-2-0-1: 1.6
keyword substitution: kv
total revisions: 36;	selected revisions: 36
description:
----------------------------
revision 1.29
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.28
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.27
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.26
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.25
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2007/08/09 01:22:49;  author: evansbj;  state: Exp;  lines: +2 -1
branches:  1.24.4;
I think David missing a #include "context.h"
----------------------------
revision 1.23
date: 2006/06/11 21:35:10;  author: tswift;  state: Exp;  lines: +1 -2



Changes to make the low-level C interface work with the multi-threaded
engine.  The changes are as follows:

1) call_forn now calls a single-parameter function with CTXT in the MT
   engine, while the sequential engine calls a parameterless function.

2) Compiltion of a foreign file (foreign.P) now writes a different
   magic number depending on whether the compilation was done with the
   sequential or multi-threaded engine.  Then when consulting the file
   (in consult.P) a recompile is forced if the compiled file was
   compiled by MT if seq, and seq if MT.

3) Some C interface functions require a thread context to be passed
   and some dont, so I added some defines to handle this of the form

      extern_ptoc_xxx
      extern_ctop_xxx
      extern_p2p_xxx
      extern_p2c_xxx
      extern_p2p_xxx
----------------------------
revision 1.22
date: 2005/01/17 17:51:48;  author: tswift;  state: Exp;  lines: +8 -3

Changes for MAC fli, part 1.
----------------------------
revision 1.21
date: 2005/01/14 18:30:55;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.20
date: 2002/03/15 09:19:51;  author: kifer;  state: Exp;  lines: +2 -2
renamed loader_defs.h to extensions.h
----------------------------
revision 1.19
date: 2002/03/15 05:01:19;  author: kifer;  state: Exp;  lines: +8 -4
got rid of the dependency on .O
----------------------------
revision 1.18
date: 2002/03/13 10:17:48;  author: kifer;  state: Exp;  lines: +2 -2
replaced file extensions with defined preprocessor constants in preparation to
the objfile extension switch
----------------------------
revision 1.17
date: 2001/08/14 00:26:58;  author: kifer;  state: Exp;  lines: +4 -3
branches:  1.17.4;
commented out a putenv declaration. Doesn't seem to be needs for Solaris > 2.5
----------------------------
revision 1.16
date: 2000/05/20 06:55:58;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.16.2;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.15
date: 2000/05/01 06:16:44;  author: kifer;  state: Exp;  lines: +7 -1
Fixed runtime library path stuff. Attempted to enable foreign libraries on SGI
----------------------------
revision 1.14
date: 2000/04/29 21:53:52;  author: kifer;  state: Exp;  lines: +8 -8
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.13
date: 2000/03/01 16:22:33;  author: dwarren;  state: Exp;  lines: +4 -4
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.12
date: 2000/02/22 18:42:34;  author: kostis;  state: Exp;  lines: +2 -2
Change to allow system to compile with non-gcc based compilers.
----------------------------
revision 1.11
date: 1999/12/02 07:07:00;  author: kifer;  state: Exp;  lines: +13 -21
code cleanup.
----------------------------
revision 1.10
date: 1999/12/01 18:13:53;  author: kifer;  state: Exp;  lines: +2 -2
Got rid of warnings
----------------------------
revision 1.9
date: 1999/12/01 17:55:42;  author: kifer;  state: Exp;  lines: +20 -8
Added checks for RUNTIME_LD_PATH. This allows to build runtime library
paths into the .so modules.
----------------------------
revision 1.8
date: 1999/11/30 05:03:14;  author: kifer;  state: Exp;  lines: +20 -21
code cleanup
----------------------------
revision 1.7
date: 1999/11/29 00:30:15;  author: kifer;  state: Exp;  lines: +12 -27
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.6
date: 1999/10/29 11:02:11;  author: kostis;  state: Exp;  lines: +10 -6
Changes to supress warning.
----------------------------
revision 1.5
date: 1999/10/27 06:03:08;  author: kifer;  state: Exp;  lines: +63 -47
LD_LIBRARY_PATH is now automatically set from the header of the .O file.
This means that any -L option specified in ld_options is automatically
taken care of, and the user doesn't need to set LD_LIBRARY_PATH before
letting XSB load a foreign module.
----------------------------
revision 1.4
date: 1999/10/26 20:24:35;  author: luis;  state: Exp;  lines: +6 -5
- some more comments to suppress some warnings...
----------------------------
revision 1.3
date: 1999/10/26 17:42:15;  author: luis;  state: Exp;  lines: +42 -10
- new commented version of code to set LD_LIBRARY_PATH before loading
shared objects; it has problems when deallocating the string.
----------------------------
revision 1.2
date: 1999/10/26 06:46:57;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:57:59;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.16.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.16.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.17.4.2
date: 2004/10/18 20:46:02;  author: ruim;  state: Exp;  lines: +8 -4
update for version 2.6.1
----------------------------
revision 1.17.4.1
date: 2004/09/29 19:44:12;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.24.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.24.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.24.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dynload.c,v
Working file: dynload.c
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.14
	ROLLBACK: 1.9
	latest_plus_supp_branch: 1.9.0.4
	latest_plus_supp: 1.9
	Version_3dot2_plus_supp: 1.9.0.2
	release_2_6_plus_supp: 1.7.0.12
	Version_3dot2: 1.9
	dec07-perf-results: 1.9
	mt_thesis: 1.9
	release_3_0: 1.9
	release_2_7_0: 1.7
	multi-threaded-26-engine: 1.7.10.1
	pre-mt: 1.7
	multi-threaded-25-engine-done: 1.7.10.1
	multi-threaded-25-engine: 1.7.0.10
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.8
	last-merged-to-demand: 1.7
	demand_branch: 1.7.0.6
	before_removing_chat: 1.7
	release_2_5: 1.7
	pre-merge-slgwam-gc: 1.7
	multi-threaded-c-engine: 1.7.0.4
	release_2_4: 1.7
	release_2_3: 1.7
	multi-threaded-engine: 1.7.0.2
	pre-threading: 1.7
	release-2-2: 1.6
	chat-and-local: 1.6.0.2
	xsb-pre-cleanup: 1.6
	release-2-1: 1.5
	release-2-0-1: 1.5
	subsumption: 1.3
	without-attv: 1.3
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.2
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.2
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 21;	selected revisions: 21
description:
----------------------------
revision 1.14
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.13
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.12
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.9.4;

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.8
date: 2005/01/14 18:30:55;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.7
date: 2000/05/20 06:55:58;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.7.2;  1.7.10;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.6
date: 2000/01/07 08:51:25;  author: kifer;  state: Exp;  lines: +2 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/10/25 05:58:01;  author: kifer;  state: Exp;  lines: +5 -5
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.4
date: 1999/10/21 06:22:47;  author: kifer;  state: Exp;  lines: +1 -5
sent the COFF stuff to the attic
----------------------------
revision 1.3
date: 1999/04/19 15:39:19;  author: luis;  state: Exp;  lines: +5 -1
* added support for win32 dll's
----------------------------
revision 1.2
date: 1998/11/19 05:24:21;  author: kifer;  state: Exp;  lines: +2 -2
changed so that C program calling XSb would only pass the top xsb
directory instead of the executable directory
----------------------------
revision 1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.7.10.1
date: 2004/09/29 19:44:13;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.7.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.7.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.9.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.9.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.9.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dynload.h,v
Working file: dynload.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	release_2_6_plus_supp: 1.1.1.1.0.14
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.1.1.1
	multi-threaded-26-engine: 1.1.1.1.12.1
	pre-mt: 1.1.1.1
	multi-threaded-25-engine-done: 1.1.1.1.12.1
	multi-threaded-25-engine: 1.1.1.1.0.12
	release_2_6_1: 1.1.1.1
	release_2_6_final: 1.1.1.1
	release_2_6: 1.1.1.1.0.10
	last-merged-to-demand: 1.1.1.1
	demand_branch: 1.1.1.1.0.8
	before_removing_chat: 1.1.1.1
	release_2_5: 1.1.1.1
	pre-merge-slgwam-gc: 1.1.1.1
	multi-threaded-c-engine: 1.1.1.1.0.6
	release_2_4: 1.1.1.1
	release_2_3: 1.1.1.1
	multi-threaded-engine: 1.1.1.1.0.4
	pre-threading: 1.1.1.1
	release-2-2: 1.1.1.1
	chat-and-local: 1.1.1.1.0.2
	xsb-pre-cleanup: 1.1.1.1
	release-2-1: 1.1.1.1
	release-2-0-1: 1.1.1.1
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2005/01/14 18:30:56;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.2.4;
Integration of multithreaded system
----------------------------
revision 1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;  lines: +0 -0
branches:  1.1.1.1.4;  1.1.1.1.12;
Imported sources
----------------------------
revision 1.1.1.1.12.1
date: 2004/09/29 19:44:13;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.1.1.4.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.1.1.4.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/dynwin32.i,v
Working file: dynwin32.i
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.7
	without-attv: 1.7
	release-2-0: 1.4
	pre-release-2-0: 1.2
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.8
date: 1999/10/25 05:58:04;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.7
date: 1999/10/05 04:01:29;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.6
date: 1999/08/16 07:24:13;  author: kifer;  state: Exp;  lines: +4 -5
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.5
date: 1999/08/09 18:56:06;  author: warren;  state: Exp;  lines: +2 -2
Reorder to put include of stdio.h first.  Didn't work otherwise with
DLL.
----------------------------
revision 1.4
date: 1999/05/25 13:31:18;  author: luis;  state: Exp;  lines: +3 -2
C interface cleanup, 2nd phase
----------------------------
revision 1.3
date: 1999/05/03 19:55:41;  author: luis;  state: Exp;  lines: +14 -2
* changed to understand name mangling imposed by stdcall calling convention
----------------------------
revision 1.2
date: 1999/04/22 06:49:16;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1999/04/19 15:40:45;  author: luis;  state: Exp;
* added support for win32 dll's
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dynwin32_xsb_i.h,v
Working file: dynwin32_xsb_i.h
head: 1.26
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.23
	ROLLBACK: 1.18
	latest_plus_supp_branch: 1.18.0.4
	latest_plus_supp: 1.18
	Version_3dot2_plus_supp: 1.18.0.2
	release_2_6_plus_supp: 1.10.0.4
	Version_3dot2: 1.18
	dec07-perf-results: 1.18
	mt_thesis: 1.15
	release_3_0: 1.15
	release_2_7_0: 1.12
	multi-threaded-26-engine: 1.8.6.2
	pre-mt: 1.12
	multi-threaded-25-engine-done: 1.8.6.1
	multi-threaded-25-engine: 1.8.0.6
	release_2_6_1: 1.10
	release_2_6_final: 1.10
	release_2_6: 1.10.0.2
	last-merged-to-demand: 1.9
	demand_branch: 1.9.0.2
	before_removing_chat: 1.8
	release_2_5: 1.8
	pre-merge-slgwam-gc: 1.8
	multi-threaded-c-engine: 1.8.0.4
	release_2_4: 1.8
	release_2_3: 1.8
	multi-threaded-engine: 1.8.0.2
	pre-threading: 1.8
	release-2-2: 1.5
	chat-and-local: 1.5.0.2
	xsb-pre-cleanup: 1.5
	release-2-1: 1.4
	release-2-0-1: 1.3
keyword substitution: kv
total revisions: 34;	selected revisions: 34
description:
----------------------------
revision 1.26
date: 2011/08/05 09:10:52;  author: kifer;  state: Exp;  lines: +3 -1
ported packages, gpp to x64 windows.
Still there are a number of warnings about convertion from prolog_int to int
and signed/unsigned mismatch between int and size_t on win32
----------------------------
revision 1.25
date: 2011/08/03 07:54:15;  author: kifer;  state: Exp;  lines: +3 -1
adjusted external names mangling for Win64
----------------------------
revision 1.24
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +5 -5
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.23
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.22
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.21
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.20
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.19
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2007/08/17 15:25:12;  author: dwarren;  state: Exp;  lines: +5 -1
branches:  1.18.4;
ifdef-ed so that under MT foriegn functions are decorated with
@4 (instead of @0) since they will have the one th argument.
This fixes a testsuite test.  I'm not sure how general it is.
----------------------------
revision 1.17
date: 2007/08/17 04:13:16;  author: dwarren;  state: Exp;  lines: +2 -2
Slightly more informative error message.
----------------------------
revision 1.16
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.15
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +3 -3

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.14
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +4 -4
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.13
date: 2005/11/13 21:38:37;  author: dwarren;  state: Exp;  lines: +8 -6
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.12
date: 2004/07/28 14:44:55;  author: vidrevich;  state: Exp;  lines: +40 -3
when loading DLL produced from c file look not only in c file directory but also in config/bin directory. If it is not found there let Windows find it.
----------------------------
revision 1.11
date: 2004/01/14 20:27:12;  author: dwarren;  state: Exp;  lines: +1 -2
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.10
date: 2003/02/21 16:45:25;  author: lfcastro;  state: Exp;  lines: +2 -2
* Report Windows' error number when loading a DLL fails
----------------------------
revision 1.9
date: 2002/05/27 02:37:21;  author: kifer;  state: Exp;  lines: +8 -5
branches:  1.9.2;
fixed to work with the .xwam extension on win32
----------------------------
revision 1.8
date: 2000/05/20 06:55:59;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.8.2;  1.8.6;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.7
date: 2000/04/30 20:12:34;  author: kifer;  state: Exp;  lines: +2 -3
fixed typos
----------------------------
revision 1.6
date: 2000/04/29 21:53:53;  author: kifer;  state: Exp;  lines: +3 -3
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.5
date: 2000/03/01 16:22:33;  author: dwarren;  state: Exp;  lines: +4 -4
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.4
date: 1999/11/16 19:05:53;  author: kifer;  state: Exp;  lines: +2 -1
Revamped sockets interface.
----------------------------
revision 1.3
date: 1999/11/08 23:04:11;  author: luis;  state: Exp;  lines: +7 -5
- bugfix: name decoration for stdcall
----------------------------
revision 1.2
date: 1999/10/26 06:46:58;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:58:07;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.8.6.2
date: 2004/10/18 20:46:02;  author: ruim;  state: Exp;  lines: +9 -6
update for version 2.6.1
----------------------------
revision 1.8.6.1
date: 2004/09/29 19:44:13;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.8.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.8.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.9.2.1
date: 2003/04/17 17:11:49;  author: lfcastro;  state: Exp;  lines: +2 -2
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.18.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.18.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.18.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/emudef.h,v
Working file: emudef.h
head: 1.91
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.84
	ROLLBACK: 1.78
	latest_plus_supp_branch: 1.74.0.2
	latest_plus_supp: 1.74
	Version_3dot2_plus_supp: 1.73.0.2
	release_2_6_plus_supp: 1.38.0.4
	Version_3dot2: 1.73
	dec07-perf-results: 1.66
	mt_thesis: 1.61
	release_3_0: 1.59
	release_2_7_0: 1.43
	multi-threaded-26-engine: 1.30.2.2
	pre-mt: 1.43
	multi-threaded-25-engine-done: 1.30.2.1
	multi-threaded-25-engine: 1.30.0.2
	release_2_6_1: 1.38.2.1
	release_2_6_final: 1.38
	release_2_6: 1.38.0.2
	last-merged-to-demand: 1.35
	demand_branch: 1.35.0.2
	before_removing_chat: 1.30
	release_2_5: 1.30
	pre-merge-slgwam-gc: 1.29
	multi-threaded-c-engine: 1.29.0.2
	release_2_4: 1.27
	release_2_3: 1.23
	multi-threaded-engine: 1.21.0.2
	pre-threading: 1.20
	release-2-2: 1.18
	chat-and-local: 1.18.0.2
	xsb-pre-cleanup: 1.18
	release-2-1: 1.15
	release-2-0-1: 1.15
	subsumption: 1.12
	without-attv: 1.10
	release-2-0: 1.9
	pre-release-2-0: 1.7
	v1-9-8: 1.7
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 103;	selected revisions: 103
description:
----------------------------
revision 1.91
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +2 -2
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.90
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +2 -3

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.89
date: 2011/09/23 18:36:07;  author: tswift;  state: Exp;  lines: +14 -3

Changes for timed_call/3
----------------------------
revision 1.88
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +4 -4
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.87
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +6 -3
Getting Linux to Work
----------------------------
revision 1.86
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +4 -4
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.85
date: 2011/01/07 19:52:01;  author: tswift;  state: Exp;  lines: +8 -8
Bug fix.

Fixed copy/paste errors in nunify_with_num, nunify_with_nil, and
nunify_with_con.

The error lead to core dumps in the predicate

qr1(X):- when(nonvar(X),X \= 2),
        r(Y),
        X is Y + 1.

as the specialized instruction addintfastuni was called, which
called nunify_with_num() with its first parameter as op3 rather
than op1 as in all other uses of this macro.  This hit a bug in
the maro which had op1 in the attv case, rather than the macro
parameter OP1.

This bug only arose when attvs were used in arithmetic
expressions that used the instruction addintfastuni.
----------------------------
revision 1.84
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +2 -4
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.83
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.82
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.81
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.80
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.79
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +4 -2
no message
----------------------------
revision 1.78
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.77
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.76
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -2
Backed out code
----------------------------
revision 1.75
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +3 -1
Dipti's code for support graph added
----------------------------
revision 1.74
date: 2010/02/10 19:11:12;  author: dwarren;  state: Exp;  lines: +3 -3
branches:  1.74.2;
Made excess_vars a builtin, for efficiency.
----------------------------
revision 1.73
date: 2008/09/26 20:32:01;  author: tswift;  state: Exp;  lines: +2 -1

`Fixes the test pps while not breaking the tests dipti or wine.
The change is a 1-liner.  Other changes are for documentation and
(commented out) debugging.

----------------------------------------------------------------------

Keeping some log notes of the change in the CVS log -- this has proven
useful in understanding the history of minor tabling changes.

I've just spent a while analyzing the pps program to find out why a
cut-over choice point is improperly backtracked into.  Recall that
when I fixed this bug 3 years ago, I broke an example of Dipti's
(which is now in the test suite) along with the wine example.  Taking
out that change apparently fixes both examples.

A complex combination of events give rise to backtracking over a cut
choice point in local evaluation.  First, early completion must be
applied to a subgoal S that is not the leader in an SCC.  Next, the
generator/consumer choice point of S must never have been scheduled
for answer return.  And finally, the generator/consumer choice point
of S must be preceded by a cut-over choice point.

I realize that this is obscure, and I don't yet understand how to
explain it more cogently.  However, I do include 1) a pps program,
slightly modified with debugging info; 2) the debugging output; and 3)
a detailed explanation of what is going on.  I'm not sure whether
these details will be of help to anyone other than me.

Of course the real question is what to do.  My previous "fix" was to
ensure that non-leader GCPs pointed to the leader GCP in local
evaluation when the non-leader GCP was backtracked over and turned
into a CCP.  Exactly why this was causing a problem in the wine and
Dipti examples, I dont know, but I could see that it could be a
problem if there were a chain of non-leader GCPs linked by their
previous CP values.  So anyway, that fix wont work.

Thus, we want the previous CP of non-leader GCPs ot point to the
leader GCP after they have been turned into consumers (as long as they
are not part of a scheduling chain).  Making this adjustment when the
non-leader GCP is turned into a CCP is wrong, as we've seen.  However,
I do believe that making the adjustment at a different time is safe.
Accordingly I made a 1-line change to adjust the previous choice point
of non-leader GCPs to the leader GCP during *fixed-point check
performed by the leader*.

By the way, I really appreciate the work that Michael did to pare down
the bug example to the small pps program.  If it had been much more
complex, I doubt that I could have understood what was going on.

Terry


Its possible that rather than adjusting the non-leader GCPs to have
the leader GCP as their previous choice point when they are turned
into CCPs (which is wrong) this could be done at some other time.

One possibility is to make the adjustment at fixpoint check, as the
CCP (nee GCP) needs to be traversed to check if it has unreturned
answers anyway.

I'll think about doing making that change to the fixed point
computation.  However, at least for now I think the engine is
functioning properly for definite datalog programs without cuts -- at
least in terms of answer scheduling.

------------------------------------------------------------------------------------
% % % pps.P % % %

/* print_cp is more understandable when CP_DEBUG is defined */

:- import print_cp/0 from machine.

:- table w2/2, w3/3.

db(wrapper(app,_)).
db(wrapper(pps,_)).
db(wrapper(p,_)).

test:- w2(pps,foobar).
test1:- w2(pps,_foobar).

%% wrapper/2
w2(pps,_A) :-
%	print_cp,
	writeln(clause1w2(pps,_A)),
        w2(app,foobar),
        fail.
w2(app,_A) :-
	writeln(clause2w2(app,_A)),
	w3(p,_,foobar).
w2(X,Y) :-
	writeln(clause3(w2(X,Y))),
        db(wrapper(X,Y)),
        nl,
	print_cp,
        writeln('About to cut'),
        !,
	print_cp,
        fail.
%% Shouldn't go here after the cut!!!
w2(X,Y) :-
	writeln(clause4(w2(X,Y))),
        writeln('******fell through the cut!!! ' - X).

%% wrapper/3
w3(p,0,X):-
	writeln(clause1(w3(p,-,X))).
w3(p,_A,_B) :-
	writeln(clause2(w3(p,_A,_B))),
        w3(p,_,foobar),
	writeln(calling(w2(pps,foobar))),
        w2(pps,foobar).

------------------------------------------------------------------------------------
% % % Output % % %

| ?- test.
clause1w2(pps,foobar)
clause2w2(app,foobar)
clause1(w3(p,-,foobar))
clause2(w3(p,_h131,foobar))
calling(w2(pps,foobar))
clause3(w2(app,foobar))

About to cut
clause3(w2(pps,foobar))

About to cut
leader scheduling answers                            % printout from engine
performing early completion for: w2(app, foobar)(breg: 5c4c8c pcpf 5c4d18) % printout from engine
clause4(w2(pps,foobar))
******fell through the cut!!!  - pps
performing early completion for: w2(pps, foobar)(breg: 5c4da0 pcpf 5c4da0) % printout from engine
leader scheduling answers % printout from engine
calling(w2(pps,foobar))
leader scheduling answers % printout from engine


------------------------------------------------------------------------------------
% % % The prodigal choice point % % %

Step 1: Generator Choice Point created for w2(pps,foobar) (Failure
continuation set to check_complete)

Step 2: Regular choice point created for _$w2(pps,foobar), (_$w2/2 was
created to handle cut in a clause body of w2/2).

Step 3: GCP created for w2(app,foobar)

Step 4: Regular choice point created for _$w2(app,foobar)

Step 5: GCP created for w3(p,_,foobar)

Step 6: Answer created for w3(p,_,foobar), and Consumer Choice Point
created for w3(p,_,foobar)

Step 7: Answer w3(p,0,foobar) created in step 6 returned to CCP
created in step 6 (while evaluating the second clause of w3/3).
CCP created for w2(pps,foobar).

Step 8: At this point all subgoals are in the same Approximate SCC.
Also, each CP has as its previous CP the CP created in the immediately
preceding step.  The only anwser produced has been consumed, so the
engine backtracks to the CCP of step 7; fails; backtracks to the CCP
created in step 6; fails; backtracks to the GCP created in step 6 and
turns the GCP created in step 5 into a CCP.  (This happens in local
evaluations when backtracking over a GCP for a subgoal that is not a
SCC leader).  Finally, backtracking reaches the CP created in Step 4,
and executes the third clause of _$w2(app,foobar)

Step 9: Forward execution creates a choice point for db/1 whose
previous choice point is the CP of Step 4.  Note that there are two
CPs whose previous CP is that of Step 4: this new one and the one from
step 5.

Step 10: the cut is executed, the CP of step 9 removed, and breg set
to the GCP for Step 3.  Upon failure (immediately after the cut)
backtracking sets the GCP of Step 3 to a CCP, and fails.  Backtracking
follows the previous CP for the Step 3 CCP to the step 2 CP.

Step 11: Similarly to step 9, forward execution executes clause 3 for
_$w2(pps,foobar) (a minor difference is that no CP for db/1 is created
for the goal db(wrpper(app,foobar)) ).  (breg still points to Step 2's
CP)

Step 12: The cut is executed, resetting breg back to the original GCP
of Step 1, which is the leader.  Recall that the failure continuation
for the step 1 GCP is a check_complete, so the leader schedules answer
return for all CCPs in the SCC.  Actually, there is one scheduled.
The answer w3(p,0,foobar) is returned to the CCP (nee GCP) of step 5,
returning the answer to the second clause of _$w2(app,foobar).

Step 13 (the unlucky step): The return of the answer immediately
causes a new answer w2(app,foobar) to be derived for the goal
w2(app,foobar).  Since an answer is returned for a ground goal, early
completion applies and the goal w2(app,foobar) is early completed.

>>!! A heuristic for early completion is to set the breg to the
original GCP for the goal !!<<

and the breg is set to point to the GCP (now a CCP) of w2(app,foobar)
created in step 3.

Step 14.  Note that due to early completion, the breg now points to
the CCP of step 3 which was never scheduled by the leader.  If it had
been scheduled, its previous CP would be the (step 1) leader.
However, as it was never rescheduled, its previous CP is its original
one: that of step 2.

Step 15. The addition of the new answer from step 13 causes an
immediate failure due to local scheduling.  The engine now backtracks
into the (ostensably cut) choicepoint of step 2, which improperly
executes the fourth clause for _$w2(pps,foobar).
----------------------------
revision 1.72
date: 2008/07/25 20:56:50;  author: tswift;  state: Exp;  lines: +2 -2

fix so that new fast call checks ! properly -- before I was assuming that ! was read as a structure, while it was being read as a string.  Now its properly handled.
----------------------------
revision 1.71
date: 2008/02/22 17:10:16;  author: tswift;  state: Exp;  lines: +2 -2
Changes to make call/1 go to the cut transform for load_undef -- possibly not needed.
----------------------------
revision 1.70
date: 2008/02/21 20:57:49;  author: tswift;  state: Exp;  lines: +2 -2

Changes to optimize call/1 for atomic predicates (e.g. not ,/2 ;/2 etc.

Also, tweaked an error message for atom_chars/codes
----------------------------
revision 1.69
date: 2008/02/16 18:00:42;  author: dwarren;  state: Exp;  lines: +4 -4
Add new instructions putdfloat and getdfloat to handle double floats.
Update the loader to load these instructions from the xwam files.
(There is a possible problem.  The doubles are written into the xwam
file as bitstrings, and read by the loader as the same bitstring.  If
representations on different machines are different, then xwam files
compiled on one system won't run on another.)
----------------------------
revision 1.68
date: 2008/02/03 18:28:55;  author: dwarren;  state: Exp;  lines: +5 -5
Modified expression evaluation to support the recursive evaluation
of terms that represent expressions.  XSB had previously only permitted
constants.  So, for example, now clauses like
p(X,Y) :- Z = X+5, Y is Z+2.
will compile and execute to evaluate the term X+5.
At some point, a builtin should be created to call this C evaluator
and eval/2 in XSB should be modified to be that builtin.
----------------------------
revision 1.67
date: 2008/01/02 19:47:42;  author: dwarren;  state: Exp;  lines: +2 -2
Fix (or at least greatly improve) the C-calling-XSB (recursively) interface for
the multi-threaded engine.  There is still an issue with multiple calls of
different C threads, but sharing the same th-context.  But I think the problem
is in more than just this interface.
----------------------------
revision 1.66
date: 2007/09/28 18:20:11;  author: dwarren;  state: Exp;  lines: +4 -3
This change causes attv interrupts to be handled before cuts.
(It also fixes a bug in the previous checkin to handle attv
interrupts before trymeorelse instructions.)
All the xwam files are changed since this involved generating a
new instruction(s) putpbreg (and the temp version) for cuts that have
parameters for ARsize and NumRegsInUse which are needed if an
interrupt is pending and is to be handled.
Sitll to be done is to figure out how to handle interrupts before
trie_try-type instructions that do unification when retrieving
from tries.
----------------------------
revision 1.65
date: 2007/09/26 20:15:22;  author: dwarren;  state: Exp;  lines: +21 -1
This update modifies the trymeorelse instruction (which implements
disjunctions, including if-then-else) to include a check for pending
attv interrupts, and handling them if there are any.  The problem is
that to handle interrupts, the environment must be known and there
must be a "call"-like instruction that allows called routines to find
the size of the parents AR.  This is done here by having the
trymeorelse instruction (when there is a pending interrupt) create
an environment and then branch to a 2-instruction sequence of
check_interrupt,restore_dealloc_proceed.  This last instruction is
new, and it restores registers (if nec, but here it's not since no
registers are active at a trymeorelse), pops the environment and
returns to the original caller, which in this case causes the trymeorelse
instruction to be executed again.
----------------------------
revision 1.64
date: 2007/09/04 00:49:08;  author: dwarren;  state: Exp;  lines: +16 -21
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.63
date: 2007/06/06 20:43:19;  author: tswift;  state: Exp;  lines: +13 -7

Trey Evan's updates for 64-bits.
----------------------------
revision 1.62
date: 2007/01/25 20:33:54;  author: tswift;  state: Exp;  lines: +4 -2


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.61
date: 2006/10/25 10:46:38;  author: ruim;  state: Exp;  lines: +3 -3
changed thread cancellation so that it works
for threads blocked on IO, by sending a SIGINT signal
----------------------------
revision 1.60
date: 2006/08/28 13:58:47;  author: tswift;  state: Exp;  lines: +9 -6

debug_xsb.c -- changes to allow print_delay_list from generic debug config
emuloop.c -- removed call to gdb_dummy
emudef.h --

Change to  affect the ordering of checks for interrupt vectors
at call and proceed.  We had been checking for spy points before
checking for attributed variable interrupts, and I reversed the order,
allowing me to use the debugger/tracer on CHR programs (still not a
great way to debug, but better than nothing for now).  I've been using
this change for a couple of days, and it seems to have no effect (as
indeed it shouldn't) but please let me know if it seems to be changing
anything in your code.
----------------------------
revision 1.59
date: 2006/02/06 20:20:03;  author: tswift;  state: Exp;  lines: +38 -19

Changed default_system_error_handler so that it asserts a fact
'_$thread_exit_ball'/2 if a joinable thread exits via a thrown
error.  Changed xsb_thread_join/2 so that it returns the exit
ball, if any, along with the exit code of the thread.

Using this, created a new predicate, xsb_thread_cancel(Id) which
puts a new thread interrupt on thread Id's interrupt valus.  When
thread Id checks this value, it throws an error, which if
uncaught will cause Id to exit.
----------------------------
revision 1.58
date: 2006/01/18 19:32:25;  author: dwarren;  state: Exp;  lines: +4 -22
Minor casts and format changes to shut up my compilers...
----------------------------
revision 1.57
date: 2006/01/17 21:50:19;  author: dwarren;  state: Exp;  lines: +20 -2
Fixed to leave untagged integers in instructions, so compiler can
pass full 32-bit integers to runtime.  This (along with change to
flatten, in the compiler) should make the compiler handle full 32-bit
integers.  (Also fixed a bug in which boxed ints were being created
for small integers.)
----------------------------
revision 1.56
date: 2006/01/03 17:14:20;  author: dwarren;  state: Exp;  lines: +9 -9
Fixed float indexing problem in compiler.  Now indexes on floats should work.
(Still not very recommended, but at least the bit patterns pass through.)
Even though compiler still passes only single precision floats, at least now
all those bits are preserved, and converted to double on execution.
----------------------------
revision 1.55
date: 2005/11/17 21:46:56;  author: dwarren;  state: Exp;  lines: +39 -6
Changes to try to improve floating point handling for doubles.
There are still some issues with compiled indexes on floats, and
they don't work correctly.
----------------------------
revision 1.54
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +6 -5


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.53
date: 2005/09/01 18:29:38;  author: tswift;  state: Exp;  lines: +6 -2

(mostly minor) documentation changes, and a little code movement.
----------------------------
revision 1.52
date: 2005/08/08 17:11:31;  author: dwarren;  state: Exp;  lines: +3 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.51
date: 2005/07/18 21:54:09;  author: crojo;  state: Exp;  lines: +2 -2
*** empty log message ***
----------------------------
revision 1.50
date: 2005/07/07 16:55:50;  author: dwarren;  state: Exp;  lines: +6 -1
Fixed fmt_read/write for multithreading.  Minor change to write_canonical (still NOT
thread-safe).
Added several (extensible) string buffers to context, since many builtins use
global string buffers.  Idea is to change those places to use these buffers.
They are implemented as varstring's.
----------------------------
revision 1.49
date: 2005/05/03 17:14:35;  author: dwarren;  state: Exp;  lines: +6 -6
Reset interrupt code correctly, just in case.
----------------------------
revision 1.48
date: 2005/04/22 20:34:42;  author: dwarren;  state: Exp;  lines: +0 -1
Left a useless statement there by mistake in last changes for interrupts...
----------------------------
revision 1.47
date: 2005/04/22 18:36:02;  author: dwarren;  state: Exp;  lines: +31 -11
Added interrupt handling into the proceed instruction. (Why so long???)
----------------------------
revision 1.46
date: 2005/02/04 20:02:15;  author: dwarren;  state: Exp;  lines: +7 -3
Some minor cleanup of general_tagging to improve typing slightly.
It does work with Harpreet's recent linux (but to configure with
general-tagging you have to change ALL the CPFLAGS in emuMakefile,
not just the first one !?%$!?!)
----------------------------
revision 1.45
date: 2005/02/04 16:56:10;  author: dwarren;  state: Exp;  lines: +5 -1
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.44
date: 2005/01/14 18:30:56;  author: ruim;  state: Exp;  lines: +15 -12
Integration of multithreaded system
----------------------------
revision 1.43
date: 2004/08/24 20:41:09;  author: tswift;  state: Exp;  lines: +2 -1

This is a pre-integration of certain parts of the MT engine so that I can run the mttests
in single-threaded mode under 2.6.  This basically defines some stubs so that I can compile and so
that I dont get undefined errors, and won't affect anything anybody is doing.
----------------------------
revision 1.42
date: 2004/03/05 00:58:22;  author: dwarren;  state: Exp;  lines: +2 -2
Cleaned up initialization of constant psc record pointers.  They should
be created in standard, not in usermod.
Also modified term_new_mod to tread mod1:mod2:term as mod1:term.
----------------------------
revision 1.41
date: 2004/01/29 18:44:09;  author: dwarren;  state: Exp;  lines: +7 -7
Modified implementation of profiling to avoid the extra psc-record
field for the count.  Now the counts are kept in the code-ptr records
and accumulated only at accumulation time.  Someday may want to improve
accumulation algorithm.
----------------------------
revision 1.40
date: 2004/01/14 20:27:12;  author: dwarren;  state: Exp;  lines: +7 -3
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.39
date: 2003/09/29 13:05:12;  author: tschrijvers;  state: Exp;  lines: +38 -10
Merged CHR related updates to branch release_2_6 into the HEAD.
----------------------------
revision 1.38
date: 2003/03/14 18:54:28;  author: dwarren;  state: Exp;  lines: +4 -3
branches:  1.38.2;
Minor changes to create and use some "builtin" psc-addresses, rather than
re-insert every time one is needed.
----------------------------
revision 1.37
date: 2002/08/15 17:00:26;  author: lfcastro;  state: Exp;  lines: +3 -37
* interrupt handling (minor) cleanup:
  removed unnecessary argument to synint_proc & default_inthandler
----------------------------
revision 1.36
date: 2002/08/15 16:21:00;  author: lfcastro;  state: Exp;  lines: +51 -23
* fix logic of the interrupt handler dispatcher
----------------------------
revision 1.35
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +8 -8
branches:  1.35.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.34
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +8 -14
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.33
date: 2002/05/20 17:47:09;  author: tswift;  state: Exp;  lines: +2 -2

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.32
date: 2002/03/13 22:40:13;  author: lfcastro;  state: Exp;  lines: +10 -1
* first step in implementing demand
- new (experimental) primitive: demand_once/1
- executes query and, after first answer is returned, deletes all
consumers created during execution; further, any tables created are
also destroyed
----------------------------
revision 1.31
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +2 -3
* Removal of Chat engine
----------------------------
revision 1.30
date: 2002/01/23 17:08:08;  author: dwarren;  state: Exp;  lines: +2 -1
branches:  1.30.2;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.29
date: 2001/11/08 21:35:25;  author: dwarren;  state: Exp;  lines: +6 -7
Eliminated the indirection of *asynint_ptr and to directly use
asynint_val.  (Also a minor bug-fix in ptoc_longstring.)
----------------------------
revision 1.28
date: 2001/11/07 21:08:00;  author: dwarren;  state: Exp;  lines: +9 -16
I modified slightly the way interrupts are handled.  There had been a
couple of mechanisms, and I tried to consolidate them. I elimitaed
call_intercept and merged it in with *asynint_ptr. Now the keyboard
interrupt can be used for C-user-defined interrupts.  There is a new
variable asynint_code that can be set when an interrupt is signaled.
It is set to 0 by the system signal catcher.  To generate a
user-defined interrupt, you need to set the KEYINT_MARK bit of
*asynint_ptr and set asynint_code to your integer code.  Then when
this interrupt is fielded, it will call the keyboard interrupt handler
(set by set_inthandler imported from loader) which is a two argument
predicate.  When it is called, the first argument will be the goal to
call when continuing out of the interrupt; the second argument will be
the value of asynint_code.
----------------------------
revision 1.27
date: 2001/05/24 17:54:51;  author: lfcastro;  state: Exp;  lines: +4 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.26
date: 2001/03/27 17:52:03;  author: dwarren;  state: Exp;  lines: +2 -8
Took out PSC_INT code that MK proposed but is now not needed.  Also
minor changes to pahtname to make it a little more flexible for
cygwin.  Also changed last (?) boolean to xsbBool.
----------------------------
revision 1.25
date: 2001/03/26 01:38:16;  author: kifer;  state: Exp;  lines: +2 -2
added uniform file operation interface:
path_sysop/2 and path_sysop/3.
Several more system calls are now available through it.
----------------------------
revision 1.24
date: 2001/03/23 03:54:31;  author: kifer;  state: Exp;  lines: +11 -34
added new PSC creation interrupt. -- doesn't work yet
----------------------------
revision 1.23
date: 2001/02/06 16:56:36;  author: lfcastro;  state: Exp;  lines: +2 -37
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.22
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +45 -10
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.21
date: 2000/06/22 01:27:50;  author: lfcastro;  state: Exp;  lines: +5 -5
branches:  1.21.2;
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.20
date: 2000/05/23 20:42:08;  author: cbaoqiu;  state: Exp;  lines: +7 -7
Minor changes in comments: verify_attributes/2 ==> '_$attv_int'/2.
----------------------------
revision 1.19
date: 2000/04/29 21:53:53;  author: kifer;  state: Exp;  lines: +10 -10
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.18
date: 2000/03/01 16:22:34;  author: dwarren;  state: Exp;  lines: +42 -33
branches:  1.18.2;
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.17
date: 2000/01/06 03:03:41;  author: cbaoqiu;  state: Exp;  lines: +5 -1
A bug fix to support the execution of the attv interrupt handler
(verify_attributes/2) when tracing.
----------------------------
revision 1.16
date: 1999/12/22 05:10:11;  author: cbaoqiu;  state: Exp;  lines: +20 -1
Added changes to support attributed variables in assert.
----------------------------
revision 1.15
date: 1999/11/05 03:52:10;  author: cbaoqiu;  state: Exp;  lines: +105 -97
Changed some lines used for debugging attv.
----------------------------
revision 1.14
date: 1999/11/04 23:01:24;  author: cbaoqiu;  state: Exp;  lines: +60 -64
1) Moved the counter of the attv interrupts from the first word in the
   heap to `interrupt_counter';
2) Trail the content of array attv_interrupts[][] using pre_image
   trail (as what we did for the interrupt counter);
3) Do not use ATTVINT_MARK and *asynint_ptr to detect attv interrupts.
   Use *interrupt_reg directly (because *asynint_ptr is not trailed
   using pre_image trail).
----------------------------
revision 1.13
date: 1999/10/26 17:19:26;  author: cbaoqiu;  state: Exp;  lines: +1 -5
Moved the definition of get_var_and_attv_nums from emudef.h to
macro_xsb.h.
----------------------------
revision 1.12
date: 1999/10/15 02:54:13;  author: cbaoqiu;  state: Exp;  lines: +5 -1
Changed functions table_consume_answer() and load_solution_trie() to
take one more argument, attv_num (the number of attributed variables
in the substitution factor).
----------------------------
revision 1.11
date: 1999/10/09 02:00:23;  author: cbaoqiu;  state: Exp;  lines: +47 -3
Changes for attributed variables (first step).
----------------------------
revision 1.10
date: 1999/08/30 13:57:25;  author: kostis;  state: Exp;  lines: +1 -3
Unused and obsolete PSC stuff taken out.
----------------------------
revision 1.9
date: 1999/05/13 13:15:44;  author: warren;  state: Exp;  lines: +6 -5
Added braces to avoid a compiler warning.
----------------------------
revision 1.8
date: 1999/04/30 15:53:29;  author: kifer;  state: Exp;  lines: +6 -4
Changed so that when foreign function returns 0 then the corresponding
xsb predicate will fail.
----------------------------
revision 1.7
date: 1999/02/02 19:56:25;  author: kostis;  state: Exp;  lines: +2 -2
Now unncessary test for heap overflow in call instruction taken out.
----------------------------
revision 1.6
date: 1999/01/29 04:18:21;  author: cbaoqiu;  state: Exp;  lines: +5 -3
Changed string_find("ret", 1) to ret_psc[0].  ret_psc[0] is set at the
time when the system is started.
----------------------------
revision 1.5
date: 1999/01/19 16:45:06;  author: kostis;  state: Exp;  lines: +5 -6
Eliminated some dependency on 255's arbitrarily placed in the code.
----------------------------
revision 1.4
date: 1999/01/19 14:45:39;  author: cbaoqiu;  state: Exp;  lines: +2 -4
Removed ret_psc_exists[] (it's redundant).
----------------------------
revision 1.3
date: 1998/12/21 01:08:14;  author: cbaoqiu;  state: Exp;  lines: +3 -1
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:08:21;  author: cbaoqiu;  state: Exp;  lines: +9 -1
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  New global variables ret_psc_exists[] and ret_psc[] are added.
----------------------------
revision 1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.18.2.1
date: 2000/03/28 18:10:31;  author: lfcastro;  state: Exp;  lines: +2 -7
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.21.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.21.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +9 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.30.2.2
date: 2004/10/18 20:46:02;  author: ruim;  state: Exp;  lines: +77 -52
update for version 2.6.1
----------------------------
revision 1.30.2.1
date: 2004/09/29 19:44:13;  author: ruim;  state: Exp;  lines: +14 -11
Sources from rfm repository
----------------------------
revision 1.35.2.2
date: 2003/04/17 17:11:48;  author: lfcastro;  state: Exp;  lines: +4 -3
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.35.2.1
date: 2002/08/28 19:20:25;  author: lfcastro;  state: Exp;  lines: +19 -25
* FIXED problem in once/1 when there are no choicepoints under its
  scope
* MERGED patch from HEAD that fixes bug in interrupt handling (& attv)
* INCLUDED test predicate for demand & negation
----------------------------
revision 1.38.2.1
date: 2003/09/11 13:48:09;  author: tschrijvers;  state: Exp;  lines: +38 -10
Changed the emulator in the following way:
- term_new_mod/3 builtin from to copy a term
  to a term in a different module
- globalvar builtin that provides one global variable
- changed behavior of get_attributes and put_attributes:
  attribute value can be anything, not just a vector
- replace pre-unification interrupt handling of attributed variables
  to post-unification handling
----------------------------
revision 1.74.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.74.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +2 -0
no message
----------------------------
revision 1.74.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/emulator.h,v
Working file: emulator.h
head: 1.1
branch:
locks: strict
access list:
symbolic names:
	multi-threaded-engine: 1.1.0.2
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.1
date: 2000/12/20 18:48:05;  author: ruim;  state: dead;
branches:  1.1.2;
file emulator.h was initially added on branch multi-threaded-engine.
----------------------------
revision 1.1.2.3
date: 2001/01/07 00:32:50;  author: ruim;  state: Exp;  lines: +2 -2
fixes
----------------------------
revision 1.1.2.2
date: 2001/01/06 18:43:04;  author: ruim;  state: Exp;  lines: +5 -1
Initialization data made static and other small changes
----------------------------
revision 1.1.2.1
date: 2000/12/20 18:48:05;  author: ruim;  state: Exp;  lines: +514 -0
added new files
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/emuloop.c,v
Working file: emuloop.c
head: 1.231
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.211
	ROLLBACK: 1.205
	latest_plus_supp_branch: 1.205.0.2
	latest_plus_supp: 1.205
	Version_3dot2_plus_supp: 1.199.0.2
	release_2_6_plus_supp: 1.95.0.4
	Version_3dot2: 1.199
	dec07-perf-results: 1.175
	mt_thesis: 1.147
	release_3_0: 1.141
	release_2_7_0: 1.102
	multi-threaded-26-engine: 1.86.2.4
	pre-mt: 1.102
	multi-threaded-25-engine-done: 1.86.2.1
	multi-threaded-25-engine: 1.86.0.2
	release_2_6_1: 1.95
	release_2_6_final: 1.95
	release_2_6: 1.95.0.2
	last-merged-to-demand: 1.88
	demand_branch: 1.88.0.2
	before_removing_chat: 1.86
	release_2_5: 1.86
	pre-merge-slgwam-gc: 1.84
	multi-threaded-c-engine: 1.84.0.2
	release_2_4: 1.81
	release_2_3: 1.75
	multi-threaded-engine: 1.71.0.2
	pre-threading: 1.68
	release-2-2: 1.61
	chat-and-local: 1.58.0.2
	xsb-pre-cleanup: 1.58
	release-2-1: 1.51
	release-2-0-1: 1.51
	subsumption: 1.42
	without-attv: 1.38
	release-2-0: 1.28
	pre-release-2-0: 1.18
	v1-9-8: 1.9
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.3
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 253;	selected revisions: 253
description:
----------------------------
revision 1.231
date: 2012/07/18 14:21:08;  author: dwarren;  state: Exp;  lines: +3 -3
Fixed printout for unindexed call profiling.
----------------------------
revision 1.230
date: 2012/07/13 22:51:51;  author: tswift;  state: Exp;  lines: +3 -1

Some updated debugging routines.
----------------------------
revision 1.229
date: 2012/06/07 19:37:42;  author: tswift;  state: Exp;  lines: +5 -5

A number of changes to extend forest logging to handle negation.
----------------------------
revision 1.228
date: 2012/06/04 15:59:24;  author: dwarren;  state: Exp;  lines: +56 -1
Added unindexed profiling.
----------------------------
revision 1.227
date: 2012/01/25 22:14:08;  author: tswift;  state: Exp;  lines: +5 -5
Changed	some heap expansion thresholds to use OVERFLOW_MARGIN rather
than the hard-wired	    2000.  OVERFLOW_MARGIN is in fact a settable flag.

The idea is that by setting OVERFLOW_MARGIN a user may be able to
affect to some extent the amount of heap gc that occurs.  If after
heap gc	  there are still not OVERFLOW_MARGIN cells between the heap and
local stack, expansion will occur.  Thus by setting OVERFLOW_MARGIN
high, we'll expand more	    aggressively.

The fly	    in the ointment is dynamic code.  The test_heap	instruction
contains an argument representing an overflow margin at the entry to
clauses for a predicate.  For static code this is always 2000, but for
dynamic code it is function of the size of the clauses for a given
predicate.  I'd been hoping that OVERFLOW_MARGIN could replace the
test-heap argument, but it looks like it cant -- not without having a
separate test_help instruction for static and dynamic code.

So OVERFLOW_MARGIN will *sometimes* affect heap	      gc.
----------------------------
revision 1.226
date: 2011/12/14 22:40:26;  author: dwarren;  state: Exp;  lines: +38 -1
Added fdivreg instruction for div operation.
----------------------------
revision 1.225
date: 2011/11/23 14:31:56;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed a couple of minor bugs in unify-with-occurs-check code.
----------------------------
revision 1.224
date: 2011/11/11 18:21:39;  author: dwarren;  state: Exp;  lines: +34 -1
Added flag[UNIFY_WITH_OCCURS_CHECK_FLAG] that when true causes XSB
to do all unifications with occur_check.  (Not completely tested, and
better efficiency is possible by having compiler generate different
bldval instructions when it can determine that occur-check isn't needed.)
----------------------------
revision 1.223
date: 2011/11/06 20:30:42;  author: tswift;  state: Exp;  lines: +3 -28

Optimized is_cyclic by taking out a malloc()
----------------------------
revision 1.222
date: 2011/11/05 15:11:20;  author: tswift;  state: Exp;  lines: +27 -2

emuloop -- optional FAIL_ON_CYCLES
std_pred_xsb_i.h -- fixed a stupid bug!
----------------------------
revision 1.221
date: 2011/11/04 15:31:07;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed bug in compound/1 so now fails on boxed ints and floats.
----------------------------
revision 1.220
date: 2011/08/31 22:25:10;  author: tswift;  state: Exp;  lines: +7 -6
choice/trail exit to resource error; heap/local abort -> resource error
----------------------------
revision 1.219
date: 2011/07/02 14:27:38;  author: tswift;  state: Exp;  lines: +4 -1

More updates for C-level trace.
----------------------------
revision 1.218
date: 2011/06/27 15:56:07;  author: dwarren;  state: Exp;  lines: +3 -1
Several minor fixes:
1. Added some type coercions to quiet MSVC compiler
2. Added some CTXT-type stuff so it would compile under MT flag.
3. Moved an external declaration from included file to file it's include
in, so that MSVC would compile it.
----------------------------
revision 1.217
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +106 -486
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.216
date: 2011/06/05 19:24:03;  author: tswift;  state: Exp;  lines: +4 -2



Changes to

1) Add flag-controlled answer depth checks to variant answer
tables.  (See current_prolog_flag in the manual for details).

2) In support of 1, added sprint_term, which prints a term to a C
string.  This is useful for errors and warnings invoked by C.

3) Added MAXTOINDEX_FLAG, which allows experimentation with the
depth of * indexing.

4) Increased the initial size strbuff from 1000 -> 10000.  This
reduces spurious long atom warnings.
----------------------------
revision 1.215
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +2 -2
Getting Linux to Work
----------------------------
revision 1.214
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +46 -40
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.213
date: 2011/02/23 22:00:34;  author: tswift;  state: Exp;  lines: +4 -4

Minor documentation change.
----------------------------
revision 1.212
date: 2010/10/20 19:27:11;  author: tswift;  state: Exp;  lines: +28 -15

Added some invariant checks (not invoked unless DEBUG_VM is turned on).
----------------------------
revision 1.211
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +5 -5
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.210
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.209
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.208
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.207
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.206
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +5 -5
no message
----------------------------
revision 1.205
date: 2010/05/02 05:11:26;  author: evansbj;  state: Exp;  lines: +3 -7
branches:  1.205.2;
Update to make thread_exit/1, and xsb_kill_thread work from the C interface. It passes the regression tests as well as before, better actually.
----------------------------
revision 1.204
date: 2010/04/03 23:53:36;  author: evansbj;  state: Exp;  lines: +16 -7
It turns out that pthread_cond_wait can return for reasons other than just the expected signal condition. It should be in a tight while loop that checks an expected state change in something like xsb_ready. Just to be sure that the C thread and the Prolog thread don't collide in signal rich environments.
----------------------------
revision 1.203
date: 2010/04/03 18:38:40;  author: tswift;  state: Exp;  lines: +11 -7


2 changes:
  1) factoring out assignment for main_thread_gl
  2) Made old assertion check in try instruction ifdefed out except for
     sequential debug emulator.
----------------------------
revision 1.202
date: 2010/01/18 13:54:51;  author: dwarren;  state: Exp;  lines: +5 -1
Add ground_term as a case in jumpcof, to allow it to appear in a test without laying
down a choicepoint.
----------------------------
revision 1.201
date: 2009/11/25 16:51:57;  author: dwarren;  state: Exp;  lines: +17 -25
Changes to runtime to support import-as, as in:
:- import member/2 from basics as mymember/2.
This creates a new psc for mymember/2 in the current module that is
tied to the definition of member/2 in basics.  Dynamic loading is supported.
This supports declarations such as:
:- export member/2.
:- import member/2 from basics as member/2.
in a file named listutils.P
This would allow member to be imported from listutils, but remain defined in basics.
(The cost is an extra branch when calling it through listutils.)
----------------------------
revision 1.200
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.199
date: 2009/03/14 22:04:47;  author: tswift;  state: Exp;  lines: +8 -5

Very minor changes to shut up the compiler.
----------------------------
revision 1.198
date: 2008/11/25 18:40:07;  author: dwarren;  state: Exp;  lines: +5 -1
Added new jumpcof builtin: if_number_atom that succeeds if the atom can be
converted to a number by (atom_codes and then) number_codes.  This is necessitated
by the change that to number_codes to throw an error that made it more standard
conforming.
----------------------------
revision 1.197
date: 2008/10/26 15:26:15;  author: tswift;  state: Exp;  lines: +6 -1

Fixed two MT bugs

1) We weren't checking the size of a queue message before copying into the heap

2) We weren't initializing queues for the main thread (0)

ALso, added some scaffolding for queue locking, particularly for debug mode.
----------------------------
revision 1.196
date: 2008/10/16 17:57:58;  author: dwarren;  state: Exp;  lines: +0 -2
Use data field in psc-records for predicates loaded into usermod to point
to the full filename of the file from which it was loaded.  Used this to
print a warning when XSB loads code for a usermod predicate that was previously
defined from a different file.
Will look at extending current_predicate to return this information, but that
has not yet been done.
----------------------------
revision 1.195
date: 2008/10/15 16:41:53;  author: dwarren;  state: Exp;  lines: +1 -2
Extended xsb_profiling to include counts for time in garbage collection.
(This info could be gotten, approximately, from statistics, but it is
nice to see it directly in the profile_call dump.)
----------------------------
revision 1.194
date: 2008/09/15 18:47:45;  author: dwarren;  state: Exp;  lines: +4 -4
Minor change in when string (or atom) garbage collection is triggered.
Keeps it from being called too often.
(Also minor changes in emuloop print tracing, usu (and now) commented out.)
----------------------------
revision 1.193
date: 2008/07/25 20:56:50;  author: tswift;  state: Exp;  lines: +6 -3

fix so that new fast call checks ! properly -- before I was assuming that ! was read as a structure, while it was being read as a string.  Now its properly handled.
----------------------------
revision 1.192
date: 2008/04/06 23:04:22;  author: tswift;  state: Exp;  lines: +4 -3
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.191
date: 2008/04/02 23:48:06;  author: tswift;  state: Exp;  lines: +2 -2

Took printf out of emuloop.c -- hopefully unifloat will not be needed much,
but still...

cell_xsb.h -- took out check for load_undef in call_directly.  It
turns out that it wasn't needed.
----------------------------
revision 1.190
date: 2008/03/29 19:14:55;  author: tswift;  state: Exp;  lines: +42 -7

Fixed conversion routines for boxed floats.  However in order to get
boxed floats to work right now, you need to compile with a 32 bit engine.  I'll try to fix that soon.

The test suite runs better now, but not perfectly, so there are still a few things to fix, perhaps in the intersection of tabling and assert.
----------------------------
revision 1.189
date: 2008/03/10 16:21:49;  author: dwarren;  state: Exp;  lines: +19 -8
Fix bug in addintfastasgn instruction (to trail if binding to a variable.)
Also a cuple of comments to indicate where memory problems are wrt delay lists
(which may reduce search time the next time this bug shows up....)
----------------------------
revision 1.188
date: 2008/02/21 20:57:49;  author: tswift;  state: Exp;  lines: +5 -2

Changes to optimize call/1 for atomic predicates (e.g. not ,/2 ;/2 etc.

Also, tweaked an error message for atom_chars/codes
----------------------------
revision 1.187
date: 2008/02/18 20:16:04;  author: tswift;  state: Exp;  lines: +4 -2

loader_xsb.c - changed environment conflict message from an xsb_error
(a soft error) to a warning.  Two things prompted me to do this.

First, this sort of soft error seems a bit confusing with our (mostly)
ISO-compatable notion of what an error is.  Second, after emitting the
message, calls proceed correctly -- so a warning seems a better choice.
----------------------------
revision 1.186
date: 2008/02/16 18:00:42;  author: dwarren;  state: Exp;  lines: +75 -13
Add new instructions putdfloat and getdfloat to handle double floats.
Update the loader to load these instructions from the xwam files.
(There is a possible problem.  The doubles are written into the xwam
file as bitstrings, and read by the loader as the same bitstring.  If
representations on different machines are different, then xwam files
compiled on one system won't run on another.)
----------------------------
revision 1.185
date: 2008/02/04 18:51:42;  author: dwarren;  state: Exp;  lines: +8 -11
Some cleanup in the C expression evaluator:
1) Added header disclaimer stuff to function.h file.
2) Added a missing error case in ARITHPROC.
3) Improved efficiency of dispatch on operators in xsb_eval.
   (I'm looking at operator strings, meaning that they will
    be recognized as operators regardless of the module
    they're defined in.  It might be better to initialize
    the psc addresses of the symbols in usermod and dispatch
    on them.)
4) Added constants pi and e, which are defined in syslib/eval.P
   (but not in compiled is/2.  So (Pi = pi, X is Pi) compiles and
   executes, but (X is pi) does not compile: an inconsistency that
   should be fixed sometime, but it impacts a number of places in the
   compiler and I'm not up to it today.  At the same time, we might
   want to add user-defined constants (as SWI has, I believe)).
5) Probably a couple of other minor things I've forgotten.
----------------------------
revision 1.184
date: 2008/02/04 03:59:53;  author: dwarren;  state: Exp;  lines: +158 -0
Add a new xwam instruction,cmpreg, replaces subreg for comparisons
to avoid overflow problems.  Now minint is less than maxint....
----------------------------
revision 1.183
date: 2008/02/03 18:28:56;  author: dwarren;  state: Exp;  lines: +409 -110
Modified expression evaluation to support the recursive evaluation
of terms that represent expressions.  XSB had previously only permitted
constants.  So, for example, now clauses like
p(X,Y) :- Z = X+5, Y is Z+2.
will compile and execute to evaluate the term X+5.
At some point, a builtin should be created to call this C evaluator
and eval/2 in XSB should be modified to be that builtin.
----------------------------
revision 1.182
date: 2008/01/30 16:03:03;  author: dwarren;  state: Exp;  lines: +43 -1
Added a new instruction for adding (or subtracting) small integers.
This allows a somewhat more efficient compilation of arithmetic,
for the common case of incrementing or decrementing a value.
----------------------------
revision 1.181
date: 2008/01/03 18:45:20;  author: dwarren;  state: Exp;  lines: +29 -1
Added new mega-instruction: getkpvars, which codes for multiple getpvar's.
Since the compiler generates a sequence of getpvar's of consecutively
increasing register numbers and increasing local variable locations for
heads that have distinct variables that are all permanent variables, this
instruction can be used quite often (as can be seen by the number of
.xwam files that have changed.)  The form is getkpvars(K,V,R) which
codes for K getpvar's with the V and R increasing by one each time.
----------------------------
revision 1.180
date: 2008/01/02 19:47:42;  author: dwarren;  state: Exp;  lines: +11 -10
Fix (or at least greatly improve) the C-calling-XSB (recursively) interface for
the multi-threaded engine.  There is still an issue with multiple calls of
different C threads, but sharing the same th-context.  But I think the problem
is in more than just this interface.
----------------------------
revision 1.179
date: 2008/01/02 17:37:58;  author: dwarren;  state: Exp;  lines: +9 -6
Fixed bug in unitvar_getlist_uninumcon mega-instruction (used in "-strings).
Had been ignoring embedded failure ??!#?!  (Fixes bug pointed out by Carlos.)
----------------------------
revision 1.178
date: 2007/12/28 08:55:41;  author: ruim;  state: Exp;  lines: +59 -71
changed powereg to make it more maintanable
----------------------------
revision 1.177
date: 2007/12/28 08:39:21;  author: ruim;  state: Exp;  lines: +17 -1
taken out the no interrupt assertion for the mt system, because
of thread_signal/cancel
----------------------------
revision 1.176
date: 2007/12/23 07:38:37;  author: ruim;  state: Exp;  lines: +3 -2
fix for error handling in 64 bits
----------------------------
revision 1.175
date: 2007/11/28 16:26:01;  author: dwarren;  state: Exp;  lines: +5 -5
Added explicit casts to quiet MSVC.
----------------------------
revision 1.174
date: 2007/11/20 19:17:20;  author: tswift;  state: Exp;  lines: +2 -2


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.173
date: 2007/11/01 18:48:52;  author: tswift;  state: Exp;  lines: +79 -31
Fixed some problems in **/2 -- Sundays update didn't handle floats
properly, due to a copy and paste error.  Also, I added a domain check
(as in standard) that the number exponientiated isnt negative with a
float exponent.  Finally, I was able to take out the pow builtin as
eval now calls **/2.

In addition, made some of the C error functions DLL-exported so that
they can be used by external C functions.
----------------------------
revision 1.172
date: 2007/10/28 23:32:36;  author: tswift;  state: Exp;  lines: +70 -1


Added evaluable functions **/2 and sign/1, which were in the core standard.

Added an evaluable xor function ></2 which is in the revision.

Rewrote arithmetic_abort to give evaluation errors and instantiation
errors, making us a little more compliant.  We still aren't reporting
underflows or overflows, so we do deviate from the standard in this
respect.
----------------------------
revision 1.171
date: 2007/10/22 16:16:24;  author: dwarren;  state: Exp;  lines: +16 -8
Add check for large string space growth in test_heap, so string space
is garbage collected, even if there is no potential heap overflow.
----------------------------
revision 1.170
date: 2007/10/09 17:15:04;  author: dwarren;  state: Exp;  lines: +21 -4
These changes implement a facility that allows a routine called from
XSB as foreign code to call a predicate back in XSB.  This allows
mutual recursion between XSB and foreign code (and has been tested by
programming a recursive fibonacci in which the Prolog code calls C for
the samller values and C calls Prolog for its smaller values.)

It is similar to the "C calling XSB" interface, with the following
differences:

1. Do not call xsb_init or xsb_init_string.  These functions
initialize XSB, which clearly cannot be done if XSB is already
running.

2. A foreign routine called from XSB that wants to call an XSB
predicate must first call:
	xsb_query_save(NumRegs)

It must do this after retrieving its input parameters from XSB and
before calling any XSB predicate.  NumRegs must be the number of XSB
registers that the current foreign code uses (i.e., the number of
arguments of the XSB predicate used to call this foreign code
routine.)  This call saves the caller registers and sets up the XSB
state to accept queries from the foreign code.  (This is similar to
the XSB state after xsb_init is called.)  So after this call, the
foreign routine can use any of the interface routines for calling XSB,
such as xsb_command, xsb_command_string, xsb_query, xsb_query_string,
etc.

3. Before setting its output parameters and returning to its caller,
the foreign routine must call
	xsb_query_restore()

This restores the XSB parameter registers back to their state when
xsb_query_save() was called, and so prepares the registers to accept
the return values.  (It must be called even if there are no values to
be returned.)

This code works (according to my tests) for the single-threaded
engine.  It does NOT currently work for the multi-threaded engine.
I've put in the necessary CTXT- stuff, but still get crashes.  I'm
sure it can be made to work, but may need help in figuring out how.
----------------------------
revision 1.169
date: 2007/09/28 19:38:56;  author: tswift;  state: Exp;  lines: +2 -2
Minor changes to get rid of compiler warnings on 64-bit linux
----------------------------
revision 1.168
date: 2007/09/28 18:20:11;  author: dwarren;  state: Exp;  lines: +32 -4
This change causes attv interrupts to be handled before cuts.
(It also fixes a bug in the previous checkin to handle attv
interrupts before trymeorelse instructions.)
All the xwam files are changed since this involved generating a
new instruction(s) putpbreg (and the temp version) for cuts that have
parameters for ARsize and NumRegsInUse which are needed if an
interrupt is pending and is to be handled.
Sitll to be done is to figure out how to handle interrupts before
trie_try-type instructions that do unification when retrieving
from tries.
----------------------------
revision 1.167
date: 2007/09/26 20:15:22;  author: dwarren;  state: Exp;  lines: +36 -8
This update modifies the trymeorelse instruction (which implements
disjunctions, including if-then-else) to include a check for pending
attv interrupts, and handling them if there are any.  The problem is
that to handle interrupts, the environment must be known and there
must be a "call"-like instruction that allows called routines to find
the size of the parents AR.  This is done here by having the
trymeorelse instruction (when there is a pending interrupt) create
an environment and then branch to a 2-instruction sequence of
check_interrupt,restore_dealloc_proceed.  This last instruction is
new, and it restores registers (if nec, but here it's not since no
registers are active at a trymeorelse), pops the environment and
returns to the original caller, which in this case causes the trymeorelse
instruction to be executed again.
----------------------------
revision 1.166
date: 2007/09/04 00:49:08;  author: dwarren;  state: Exp;  lines: +2 -2
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.165
date: 2007/08/28 16:47:39;  author: dwarren;  state: Exp;  lines: +6 -3
Added printf's useful for debugging (all commented out)
----------------------------
revision 1.164
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.163
date: 2007/07/26 15:14:29;  author: tswift;  state: Exp;  lines: +1 -11

1) Change to use xsb_initialization_exit() in xsb_basic_abort() to allow proper
behavior in C interface

2) Made changes to ensure proper mutex initializations when calling XSB from C.
----------------------------
revision 1.162
date: 2007/07/25 15:52:15;  author: ruim;  state: Exp;  lines: +5 -1
moved wam_initialized to emuloop.c
----------------------------
revision 1.161
date: 2007/07/22 18:40:48;  author: ruim;  state: Exp;  lines: +8 -1
Changes to allow for main_xsb.c to link in under windows, for
the multi-threaded system.
----------------------------
revision 1.160
date: 2007/06/21 16:55:12;  author: dwarren;  state: Exp;  lines: +19 -9
Main fix is to change test_heap to take into account ebreg in overflow
check.  (An overflow occurred in the compiler, for long clauses, because
ereg got very different from ebreg, and overfow with ebreg wasn't caught.)
Also did a couple of minor cleanups in the compiler that I discovered
in this search.  (And 2 xwam files in cvs seem out of sync so they're
being checked in as well.)
----------------------------
revision 1.159
date: 2007/05/10 16:29:08;  author: tswift;  state: Exp;  lines: +23 -1

Minor changes:

tc_insts -- added some reserve code for testing, and some minor optimization of trie code
emuloop.c -- added a comment (from an email of David)
memory_xsb.h -- took out an old ifdef that confused me one too many times.
----------------------------
revision 1.158
date: 2007/03/30 10:34:07;  author: tswift;  state: Exp;  lines: +3 -3

Changes for debugging: printing out structures (e.g. deleted clref chains) and more informative error reporting.
----------------------------
revision 1.157
date: 2007/03/26 13:34:04;  author: dwarren;  state: Exp;  lines: +1 -1
Do expand-heap (if nec) *before* processing interrupts.  (An interrupt
will require the use of register(s).)
----------------------------
revision 1.156
date: 2007/03/23 18:13:27;  author: dwarren;  state: Exp;  lines: +20 -1
Improved fix to compiler to generate instruction to test heap when
necessary on clause return.
----------------------------
revision 1.155
date: 2007/03/16 20:40:30;  author: dwarren;  state: Exp;  lines: +49 -0
Add new mega-xwam-instructions to compile "abc"-type strings more
efficiently.  This changes almost(?) all xwam files.
The implementation at this point is just thru the peephole
optimizer.  The next step is to change the way the compiler
processes these strings to speed up compilation.
----------------------------
revision 1.154
date: 2007/03/15 21:30:44;  author: dwarren;  state: Exp;  lines: +24 -1
Add new instruction, deallocate_gc, that tests for stack overflow.  Fixes
a bug in which there is a deep recursion, and terms are built on the heap
on returning back up the call stack.  There are no heap-checks in such a
loop and so we can get stack overflow, without this check.
----------------------------
revision 1.153
date: 2007/02/23 20:17:04;  author: tswift;  state: Exp;  lines: +7 -4
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.152
date: 2007/02/22 20:05:02;  author: tswift;  state: Exp;  lines: +1 -2

Fixed some bugs with mutexes in XSB's C API.
----------------------------
revision 1.151
date: 2007/02/22 00:16:04;  author: tswift;  state: Exp;  lines: +21 -4


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.150
date: 2007/01/25 20:33:54;  author: tswift;  state: Exp;  lines: +8 -5


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.149
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +19 -13

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.148
date: 2006/12/22 18:57:39;  author: tswift;  state: Exp;  lines: +46 -46
Added syntax errors to file_read/3.  Previously file_read/3 was
effectively handling its own errors, by printing out to STDERR and
failing.  This was not ISO compliant, and had two pressing
problems: it was not safe for threads that concurrently got syntax
errors while reading different streams, and syntax errors could not be
handled by applications -- an important feature for C calling XSB.

Because the reader is very fragile, I made relatively minimal changes
to handle this.  We're still using PSC records to store where an error
occurred (ugh!) because my attempt to actually throw errors at a
potential misparse broke the backtracking HiLog parser. But now at
lease different threads use different PSC records.  In addition, at
the end of file_read, if there is a syntax error, I package it up and
throw a proper error.

I maintained the old file_read predicate as file_read_fapoe (fail and
print out error), and made cmplib/parse.P call this predicate.  The
rest of the system now calls the new file_read.  Also, I did not
change file_read_foe (fail on error) which had been called in a couple
of places.

Also changed xsb_abort() calls in xsb_token.c to throw specific syntax
errors.

emuloop.c changes are purely indentational, to make the code more clear.
----------------------------
revision 1.147
date: 2006/11/21 01:22:12;  author: ruim;  state: Exp;  lines: +7 -3
activated parameter --max_threads by replacing MAX_THREADS with max_threads_glc
----------------------------
revision 1.146
date: 2006/11/20 16:53:41;  author: ruim;  state: Exp;  lines: +8 -8
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.145
date: 2006/11/04 12:41:26;  author: ruim;  state: Exp;  lines: +2 -2
Fixed what seemed to be a bug in initializing the stack sizes
----------------------------
revision 1.144
date: 2006/10/25 10:46:38;  author: ruim;  state: Exp;  lines: +2 -2
changed thread cancellation so that it works
for threads blocked on IO, by sending a SIGINT signal
----------------------------
revision 1.143
date: 2006/09/06 05:15:26;  author: diptikalyan;  state: Exp;  lines: +2 -2
Incremental Code Added.
----------------------------
revision 1.142
date: 2006/08/28 13:58:47;  author: tswift;  state: Exp;  lines: +1 -2

debug_xsb.c -- changes to allow print_delay_list from generic debug config
emuloop.c -- removed call to gdb_dummy
emudef.h --

Change to  affect the ordering of checks for interrupt vectors
at call and proceed.  We had been checking for spy points before
checking for attributed variable interrupts, and I reversed the order,
allowing me to use the debugger/tracer on CHR programs (still not a
great way to debug, but better than nothing for now).  I've been using
this change for a couple of days, and it seems to have no effect (as
indeed it shouldn't) but please let me know if it seems to be changing
anything in your code.
----------------------------
revision 1.141
date: 2006/07/21 20:20:46;  author: crued;  state: Exp;  lines: +4 -2
Moved declaration of function pointer to top of emuloop() function so that
it compiles on Windows
----------------------------
revision 1.140
date: 2006/06/15 01:19:32;  author: dwarren;  state: Exp;  lines: +12 -5
Fix bug introduced in last update, on indexing oversized ints or floats
with star-indexing.
----------------------------
revision 1.139
date: 2006/06/11 21:35:10;  author: tswift;  state: Exp;  lines: +14 -2



Changes to make the low-level C interface work with the multi-threaded
engine.  The changes are as follows:

1) call_forn now calls a single-parameter function with CTXT in the MT
   engine, while the sequential engine calls a parameterless function.

2) Compiltion of a foreign file (foreign.P) now writes a different
   magic number depending on whether the compilation was done with the
   sequential or multi-threaded engine.  Then when consulting the file
   (in consult.P) a recompile is forced if the compiled file was
   compiled by MT if seq, and seq if MT.

3) Some C interface functions require a thread context to be passed
   and some dont, so I added some defines to handle this of the form

      extern_ptoc_xxx
      extern_ctop_xxx
      extern_p2p_xxx
      extern_p2c_xxx
      extern_p2p_xxx
----------------------------
revision 1.138
date: 2006/04/17 20:54:56;  author: tswift;  state: Exp;  lines: +2 -1

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.137
date: 2006/02/23 15:54:24;  author: dwarren;  state: Exp;  lines: +1 -1
A couple of minor casts or decls to quiet my complaining compiler.
----------------------------
revision 1.136
date: 2006/02/23 15:17:23;  author: dwarren;  state: Exp;  lines: +1 -1
While I'm fixing var to handle attv's, why not fix nonvar as well?  Duh!
----------------------------
revision 1.135
date: 2006/02/23 14:43:05;  author: dwarren;  state: Exp;  lines: +2 -2
Fix jumpcof for var/1 to succeed for attributed variables as well.
----------------------------
revision 1.134
date: 2006/02/03 18:14:13;  author: tswift;  state: Exp;  lines: +3 -3

Added mechanisms to create threads with varying stack sizes, and to create
detached threads.
----------------------------
revision 1.133
date: 2006/01/27 17:50:17;  author: dwarren;  state: Exp;  lines: +75 -7
Added a new instruction to implement unary tests that don't change
the XWAM state.  Examples are integer/1, atom/1, etc.  The compiler
is changed to use these instructions to avoid laying down a choicepoint
in a conditional, and they are used for regular inline calls.
----------------------------
revision 1.132
date: 2006/01/24 14:10:01;  author: tswift;  state: Exp;  lines: +4 -2

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.131
date: 2006/01/18 19:32:25;  author: dwarren;  state: Exp;  lines: +5 -5
Minor casts and format changes to shut up my compilers...
----------------------------
revision 1.130
date: 2006/01/17 21:50:19;  author: dwarren;  state: Exp;  lines: +11 -11
Fixed to leave untagged integers in instructions, so compiler can
pass full 32-bit integers to runtime.  This (along with change to
flatten, in the compiler) should make the compiler handle full 32-bit
integers.  (Also fixed a bug in which boxed ints were being created
for small integers.)
----------------------------
revision 1.129
date: 2006/01/09 00:06:30;  author: tswift;  state: Exp;  lines: +3 -2
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.128
date: 2006/01/03 17:14:21;  author: dwarren;  state: Exp;  lines: +23 -18
Fixed float indexing problem in compiler.  Now indexes on floats should work.
(Still not very recommended, but at least the bit patterns pass through.)
Even though compiler still passes only single precision floats, at least now
all those bits are preserved, and converted to double on execution.
----------------------------
revision 1.127
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +2 -2
Added string table garbage collection.
----------------------------
revision 1.126
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +3 -3

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.125
date: 2005/11/18 23:29:01;  author: tswift;  state: Exp;  lines: +10 -1

Took attv_interrupts array out of global area, and put it into
the thread context.  Also added, _gl suffix to realtime_count.

Other than that, just general documentation.
----------------------------
revision 1.124
date: 2005/11/17 21:46:56;  author: dwarren;  state: Exp;  lines: +26 -9
Changes to try to improve floating point handling for doubles.
There are still some issues with compiled indexes on floats, and
they don't work correctly.
----------------------------
revision 1.123
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +33 -16


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.122
date: 2005/09/02 20:43:13;  author: tswift;  state: Exp;  lines: +13 -1

Fix to abolish_table_xxx and gc_tables to work when stacks are frozen;
and made creation of DelTF frames thread-safe.  Also, got a little
further towards reclaiming retracted clauses.

----------------------------------------------------------------------
builtin.c emuloop.c extensions_xsb.h inst_xsb.h CVS: std_cases_xsb_i.h
tr_utils.c xsb_inst_list.h CVS:
----------------------------------------------------------------------
----------------------------
revision 1.121
date: 2005/08/22 19:52:25;  author: dwarren;  state: Exp;  lines: +10 -5
Left in some debugging help.... Now removed  (Sorry)
----------------------------
revision 1.120
date: 2005/08/22 19:38:22;  author: dwarren;  state: Exp;  lines: +25 -1
Add a little more lock protection when handling private dispatch blocks
----------------------------
revision 1.119
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +4 -4
Made pflags thread private
----------------------------
revision 1.118
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +8 -8
made private flags array for sequential engine
----------------------------
revision 1.117
date: 2005/08/08 17:11:31;  author: dwarren;  state: Exp;  lines: +16 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.116
date: 2005/07/22 15:42:14;  author: crojo;  state: Exp;  lines: +3 -3

Made double floating point numbers the default. Single precision floats can be reverted to with the configure option --enable-fast-floats
----------------------------
revision 1.115
date: 2005/07/20 16:45:22;  author: ruim;  state: Exp;  lines: +2 -1
added file deadlock.c in preparation for implementation of deadlock breaking
----------------------------
revision 1.114
date: 2005/07/19 14:16:57;  author: dwarren;  state: Exp;  lines: +34 -32
Fixed problem with bld_boxedfloat with oldfloats in multithreading
----------------------------
revision 1.113
date: 2005/07/18 21:54:10;  author: crojo;  state: Exp;  lines: +185 -102
*** empty log message ***
----------------------------
revision 1.112
date: 2005/07/15 15:02:30;  author: dwarren;  state: Exp;  lines: +45 -2
Made assert thread-safe (I hope.)  Problem was asserta, and I added
mutex_lock in jumptbreg when just entering asserted code, and I release
it after the code for the first clause to be executed is found and about
to be entered.  It introduces new instructions: dyntrymeelse, dynnoop, and
dynfail to release the lock.
assertz was made safe (I hope) without locks, by adding the new clause at the
end and then as the last thing, changing the opcode of the old-last clause
from dyntrust to retry.  Since dyntrust doesn't look at any argument, this
should work.
----------------------------
revision 1.111
date: 2005/07/12 15:54:24;  author: ruim;  state: Exp;  lines: +3 -3
added deadlock detection to shared completed tables
----------------------------
revision 1.110
date: 2005/07/07 16:55:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed fmt_read/write for multithreading.  Minor change to write_canonical (still NOT
thread-safe).
Added several (extensible) string buffers to context, since many builtins use
global string buffers.  Idea is to change those places to use these buffers.
They are implemented as varstring's.
----------------------------
revision 1.109
date: 2005/06/29 18:01:19;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed bug in switchon3bound, uncovered by MT engine, reg[0] is now no longer
always 0...
----------------------------
revision 1.108
date: 2005/06/29 13:58:14;  author: vidrevich;  state: Exp;  lines: +3 -8
incorporating multi-threading into C/XSB interface. In multi-threaded engine xsb_init() takes a pointer to the thread context structure as its first argument and populates that structure with main thread context information to be used in the consequent C/XSB calls. myargc,myargv are passed as the second and the third arguments to the xsb_init() when XSB is configured for multi-threading. Changes should not affect a single-threaded version.
----------------------------
revision 1.107
date: 2005/04/27 04:20:14;  author: evansbj;  state: Exp;  lines: +5 -1
Updated stderr and stdout redirection available via the -q parameter
----------------------------
revision 1.106
date: 2005/04/22 18:36:03;  author: dwarren;  state: Exp;  lines: +2 -3
Added interrupt handling into the proceed instruction. (Why so long???)
----------------------------
revision 1.105
date: 2005/03/08 22:21:57;  author: tswift;  state: Exp;  lines: +93 -41

Two changes for compatability

1) Changed consult/compile to use .pl and XSB_SRC_EXTENSION (.P) files interchangably, with
preference for XSB_SRC_EXTENSION files.  .pl files are handled as are XSB_SRC_EXTENSION
files, compared to XSB_OBJECT_EXTENSION (.xwam) files used with .H files,etc.  However if
there is a .P file the .pl wont be examined (even if the .pl file is newer)

Unlike the extensions .pl is hard-wired -- as this is what other Prologs mostly use.

2) added min and max as first-class arithmetic functions, so you can now have expresions
like

X is 3*max(Y,min(Z,W+1))

if you want.  Min/max is useful for reading files written for other Prologs, as well as for
full clpqr.  I introduced two new instructions for these -- I might have gotten away with
one.
----------------------------
revision 1.104
date: 2005/03/05 07:49:51;  author: kifer;  state: Exp;  lines: +2 -2
got rid of obvious compiler warnings
----------------------------
revision 1.103
date: 2005/01/14 18:30:56;  author: ruim;  state: Exp;  lines: +76 -51
Integration of multithreaded system
----------------------------
revision 1.102
date: 2004/11/24 22:35:03;  author: dwarren;  state: Exp;  lines: +2 -2
Modified check_glstack_overflow to call gc_heap to try to get the necessary
space to see if it can avoid expanding the stack.  Only expand stack if GC
doesn't get enough space.  This required changes in calls to check_glstack_overflow
since it would accept MAX_ARITY to "over-save" the registers.  But GC requires
the exact number.  I think I got them correctly, except for one in calld, which I
deleted.  I don't know why calld needs to check overflow since the check_heap
in clauses should be enough....
----------------------------
revision 1.101
date: 2004/09/29 21:41:55;  author: dwarren;  state: Exp;  lines: +2 -2
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.100
date: 2004/08/20 18:11:34;  author: dwarren;  state: Exp;  lines: +17 -4
Added uniavar and bldavar WAM instructions for processing anonymous variables.
Fixed a bug in backtrace due to cpreg being used in compiling inline disjunctions
   and thus not pointing after a call WAM instruction.
Fixed initialization to put system-defined constants/predicates (in particular ,/2)
   into both the particular module (standard) AND in usermod.
----------------------------
revision 1.99
date: 2004/03/08 13:56:25;  author: dwarren;  state: Exp;  lines: +17 -1
Added new instruction to compile new @= operator.
----------------------------
revision 1.98
date: 2004/01/28 20:28:07;  author: dwarren;  state: Exp;  lines: +5 -1
Add check for profiling interrupt in trust-type instructions.
Gives better profiling feedback and single bit-check there should be
quite cheap.
----------------------------
revision 1.97
date: 2004/01/16 22:03:56;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed bug in resetting xsb profiling interrupt flag in proceed.
----------------------------
revision 1.96
date: 2004/01/14 20:27:12;  author: dwarren;  state: Exp;  lines: +13 -2
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.95
date: 2003/03/14 18:54:29;  author: dwarren;  state: Exp;  lines: +2 -5
Minor changes to create and use some "builtin" psc-addresses, rather than
re-insert every time one is needed.
----------------------------
revision 1.94
date: 2003/01/31 15:04:58;  author: dwarren;  state: Exp;  lines: +1 -2
Take out forgotten debugging message.
----------------------------
revision 1.93
date: 2003/01/28 22:57:00;  author: dwarren;  state: Exp;  lines: +2 -1
Move write_canonical (and write_canonical_lettervars) to C.  Not for speed
but so that they can be accessed from C, and used in the ODBC interface to
write terms canonically to character fields.
----------------------------
revision 1.92
date: 2002/11/04 18:09:00;  author: dwarren;  state: Exp;  lines: +4 -6
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.91
date: 2002/10/29 21:19:06;  author: lfcastro;  state: Exp;  lines: +16 -18
* Bugfix: removal of reset instruction induced loop in non-jumptable setups
----------------------------
revision 1.90
date: 2002/10/28 15:29:46;  author: lfcastro;  state: Exp;  lines: +12 -20
* Remove 'reset' instruction
----------------------------
revision 1.89
date: 2002/10/28 14:45:05;  author: dwarren;  state: Exp;  lines: +55 -7
Multiple-argument indexing modified and extended.  Now can only do multiple-argument
indexing on arguments 1-127 (down from all 255).  The first bit of the byte
that indicates the argument to index on is now used to indicate whether to use
main functor indexing (0 as before) or "fixed-depth" indexing (1, new).  In
"fixed-depth" indexing, the first N nodes in a depth-first traversal of the term
are used for indexing.  N is a fixed global value (fixed when the XSB system is compiled,
and it is currently set to 5.)  So indexing is used if the first N nodes are nonvariable
(or if the term has fewer than N nodes, the term is ground.)  All nodes contribute to
the index.
----------------------------
revision 1.88
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +8 -9
branches:  1.88.2;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.87
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -25
* Removal of Chat engine
----------------------------
revision 1.86
date: 2002/02/21 16:57:56;  author: lfcastro;  state: Exp;  lines: +13 -1
branches:  1.86.2;
* Support for compiling with SimpleScalar/PISA
* Some fixes wrt boxed integers
----------------------------
revision 1.85
date: 2002/01/23 17:08:08;  author: dwarren;  state: Exp;  lines: +246 -55
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.84
date: 2001/11/09 16:08:34;  author: tswift;  state: Exp;  lines: +9 -5

Added a little documentation about the need to trail in certain SLGWAM
instructions.
----------------------------
revision 1.83
date: 2001/10/05 19:26:49;  author: tswift;  state: Exp;  lines: +2 -1

Added stubs for "answer completion: i.e. remove_unfounded_set
----------------------------
revision 1.82
date: 2001/09/24 17:23:52;  author: lfcastro;  state: Exp;  lines: +2 -1
* attempt to cleanup and organize the completion algorithm for LOCAL
evaluation
----------------------------
revision 1.81
date: 2001/07/02 16:20:02;  author: lfcastro;  state: Exp;  lines: +2 -2
* fixed jumptable macros to compile w/ gcc3.0 without warnings
----------------------------
revision 1.80
date: 2001/05/24 17:54:51;  author: lfcastro;  state: Exp;  lines: +38 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.79
date: 2001/04/28 20:15:37;  author: ejohnson;  state: Exp;  lines: +2 -2
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.78
date: 2001/03/23 03:51:42;  author: kifer;  state: Exp;  lines: +5 -4
replaced numeric consts with symbolic constants
----------------------------
revision 1.77
date: 2001/03/17 05:44:02;  author: kifer;  state: Exp;  lines: +2 -2
improved error messages
----------------------------
revision 1.76
date: 2001/03/07 15:29:08;  author: kifer;  state: Exp;  lines: +2 -2
changed the bug reporting message
----------------------------
revision 1.75
date: 2001/02/13 17:46:06;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed bug in test_heap: before always doubled space when more space is
needed; now gets what's asked for if it's greater than the doubling.
----------------------------
revision 1.74
date: 2001/02/06 16:56:36;  author: lfcastro;  state: Exp;  lines: +9 -32
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.73
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +669 -549
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.72
date: 2000/12/08 21:30:00;  author: dwarren;  state: Exp;  lines: +2 -2
Fix a coercion to avoid an MSVC warning.
----------------------------
revision 1.71
date: 2000/07/15 17:02:47;  author: cbaoqiu;  state: Exp;  lines: +10 -1
branches:  1.71.2;
Added attv interrupt handling in getlist_tvar_tvar (fixed a bug found
in Beata's parser program).
----------------------------
revision 1.70
date: 2000/06/28 16:54:50;  author: ruim;  state: Exp;  lines: +4 -4
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.69
date: 2000/06/22 01:27:50;  author: lfcastro;  state: Exp;  lines: +562 -494
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.68
date: 2000/06/19 07:48:08;  author: ruim;  state: Exp;  lines: +2 -2
Changes to remove warnings
----------------------------
revision 1.67
date: 2000/06/19 07:14:45;  author: ruim;  state: Exp;  lines: +3 -3
Refined argument types of function prototypes
----------------------------
revision 1.66
date: 2000/05/29 04:23:35;  author: ejohnson;  state: Exp;  lines: +2 -2
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.65
date: 2000/05/20 06:55:59;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.64
date: 2000/05/19 22:55:39;  author: kifer;  state: Exp;  lines: +5 -2
removed unreachable statements
----------------------------
revision 1.63
date: 2000/04/29 21:53:53;  author: kifer;  state: Exp;  lines: +51 -51
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.62
date: 2000/04/25 15:22:56;  author: kostis;  state: Exp;  lines: +2 -2
Minor fix in erroneous error message.
----------------------------
revision 1.61
date: 2000/04/11 22:30:27;  author: kifer;  state: Exp;  lines: +2 -2
updated bug reporting info
----------------------------
revision 1.60
date: 2000/04/05 05:10:35;  author: kifer;  state: Exp;  lines: +2 -3
joined split string
----------------------------
revision 1.59
date: 2000/04/04 16:31:45;  author: kifer;  state: Exp;  lines: +3 -2
changed email addr from xsb-contact to xsb-development@lists.sourceforge.net
and xsb-installation@lists.sourceforge.net
----------------------------
revision 1.58
date: 2000/03/01 16:22:34;  author: dwarren;  state: Exp;  lines: +33 -2
branches:  1.58.2;
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.57
date: 2000/02/29 18:43:35;  author: tswift;  state: Exp;  lines: +1 -11

Small changes to take out userfunc
----------------------------
revision 1.56
date: 2000/02/15 07:45:08;  author: bartkul;  state: Exp;  lines: +2 -2
in testsuite.sh supertest.sh gctest.sh

changed testsuite.sh    into    ./testsuite.sh
        makexsb         into    ./makexsb
        configure       into    ./configure

in prolog_tests/c_calls_xsb_make.P

changed c_calls_xsb.exe into    ./c_calls_xsb.exe


in the c and h files: given check_glstack_overflow an extra argument

standard.O ... I have no idea
----------------------------
revision 1.55
date: 2000/01/26 15:01:53;  author: kostis;  state: Exp;  lines: +3 -3
Incorporated Bart's cleaned up version of unify.i that should be faster
for some programs.
----------------------------
revision 1.54
date: 2000/01/07 08:51:27;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.53
date: 1999/12/22 18:06:55;  author: warren;  state: Exp;  lines: +4 -4
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.52
date: 1999/12/22 05:10:12;  author: cbaoqiu;  state: Exp;  lines: +14 -1
Added changes to support attributed variables in assert.
----------------------------
revision 1.51
date: 1999/11/04 23:01:24;  author: cbaoqiu;  state: Exp;  lines: +2 -3
1) Moved the counter of the attv interrupts from the first word in the
   heap to `interrupt_counter';
2) Trail the content of array attv_interrupts[][] using pre_image
   trail (as what we did for the interrupt counter);
3) Do not use ATTVINT_MARK and *asynint_ptr to detect attv interrupts.
   Use *interrupt_reg directly (because *asynint_ptr is not trailed
   using pre_image trail).
----------------------------
revision 1.50
date: 1999/11/03 21:35:44;  author: cbaoqiu;  state: Exp;  lines: +4 -8
Kostis' changes to support long atoms in compiled code.
----------------------------
revision 1.49
date: 1999/10/30 00:00:37;  author: cbaoqiu;  state: Exp;  lines: +23 -1
Added an instruction `check_interrupt'.  This instruction is used
*just before* the `new_answer_dealloc' to handle the pending attv
interrupts (before we put an answer into the answer table).
----------------------------
revision 1.48
date: 1999/10/29 16:01:11;  author: tswift;  state: Exp;  lines: +3 -2
In the sharing engine, Prolog choice points now perform undo-bindings
rather than switch_envs.  A small optimization, that is possible in
batched and batched-local evaluation.
----------------------------
revision 1.47
date: 1999/10/26 06:46:58;  author: kifer;  state: Exp;  lines: +7 -7
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.46
date: 1999/10/25 19:03:40;  author: warren;  state: Exp;  lines: +2 -2
put init_machine back after init_para so that sizes read from command
line actually do cause stack sizes to be set.  (If obscure
initialization bug shows up later, maybe revisit this.)
----------------------------
revision 1.45
date: 1999/10/25 05:58:07;  author: kifer;  state: Exp;  lines: +17 -17
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.44
date: 1999/10/22 04:27:35;  author: kifer;  state: Exp;  lines: +2 -1
got rid of the memset warnings under linux
----------------------------
revision 1.43
date: 1999/10/20 18:22:08;  author: kifer;  state: Exp;  lines: +4 -2
Removed misleading references to DOS, which imply as if DOS is supported
----------------------------
revision 1.42
date: 1999/10/12 20:28:02;  author: kostis;  state: Exp;  lines: +30 -24
Clean up and localization of variables changes.
----------------------------
revision 1.41
date: 1999/10/12 20:17:41;  author: ejohnson;  state: Exp;  lines: +4 -2
Included new header
----------------------------
revision 1.40
date: 1999/10/09 18:37:50;  author: kostis;  state: Exp;  lines: +9 -17
Cleanup changes so that variables are declared and appear only in places
where they are actually needed.  Expect speed-up by doing so.
Also, finally, ugly xtemp[3-15] variables were eliminated.
Sorry, Terry !
----------------------------
revision 1.39
date: 1999/10/09 02:00:24;  author: cbaoqiu;  state: Exp;  lines: +10 -5
Changes for attributed variables (first step).
----------------------------
revision 1.38
date: 1999/10/05 04:01:30;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.37
date: 1999/09/26 06:05:52;  author: kifer;  state: Exp;  lines: +2 -2
changed memory violation msg
----------------------------
revision 1.36
date: 1999/09/21 11:10:31;  author: kostis;  state: Exp;  lines: +6 -8
Changes to fix wrong-initialization order which was introduced by the
addition of I/O/Warning streams to XSB.
----------------------------
revision 1.35
date: 1999/08/16 07:24:13;  author: kifer;  state: Exp;  lines: +8 -7
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.34
date: 1999/08/09 00:34:19;  author: kifer;  state: Exp;  lines: +3 -1
Added process control builtins, deprecated unix.P,
added C preprocessor.
----------------------------
revision 1.33
date: 1999/08/04 16:22:50;  author: kifer;  state: Exp;  lines: +2 -2
ported process control to windows
----------------------------
revision 1.32
date: 1999/08/04 14:41:56;  author: ejohnson;  state: Exp;  lines: +3 -5
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.31
date: 1999/07/22 21:58:17;  author: kifer;  state: Exp;  lines: +7 -3
Incorporated Joshua Engel's changes to get XSB work as a DLL.
In heap.c, got rid of compiler warnings.
----------------------------
revision 1.30
date: 1999/07/15 21:41:12;  author: ejohnson;  state: Exp;  lines: +2 -2
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.29
date: 1999/07/06 16:35:09;  author: ejohnson;  state: Exp;  lines: +10 -7
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.28
date: 1999/06/24 14:13:48;  author: kostis;  state: Exp;  lines: +14 -6
Some more changes to report meaningful things in arithmetic exceptions
(dealt with bit operations this time).
----------------------------
revision 1.27
date: 1999/06/23 21:26:03;  author: kostis;  state: Exp;  lines: +16 -16
Changes to have more meaningful error messages in case of arithmetic
expressions or comparisons.
----------------------------
revision 1.26
date: 1999/06/16 14:53:59;  author: kostis;  state: Exp;  lines: +2 -1
Added PTCP register back in Prolog Choice Points.
----------------------------
revision 1.25
date: 1999/05/25 13:32:02;  author: luis;  state: Exp;  lines: +2 -1
C interface cleanup, 2nd phase
----------------------------
revision 1.24
date: 1999/05/24 16:00:57;  author: luis;  state: Exp;  lines: +14 -1
* C Interface cleanup
----------------------------
revision 1.23
date: 1999/05/18 16:09:05;  author: warren;  state: Exp;  lines: +3 -3
Changed instruction names lshiftl and lshiftr to logshiftl and
logshiftr respectively.  This makes them consistent with the names in
the compiler, and more importantly avoids a name clash with a function
included in dl.h under solaris 2.5.1/gcc.
----------------------------
revision 1.22
date: 1999/05/17 17:20:53;  author: unova;  state: Exp;  lines: +4 -5
Moved reset_inst to init.c and aligned it to word
(must for the -t option in some machines)
----------------------------
revision 1.21
date: 1999/05/03 20:12:29;  author: luis;  state: Exp;  lines: +2 -1
* changes related to the foreign interface under windows
----------------------------
revision 1.20
date: 1999/05/03 00:55:43;  author: luis;  state: Exp;  lines: +3 -3
* changes regarding exporting functions under Windows
----------------------------
revision 1.19
date: 1999/04/27 14:39:45;  author: kifer;  state: Exp;  lines: +1 -2
Made large builtins in the former std_pred.i into inlined subroutines.
Added atom_codes, number_codes and made atom_chars, number_chars into
synonyms to the *_codes builtins.
----------------------------
revision 1.18
date: 1999/04/23 19:41:54;  author: cbaoqiu;  state: Exp;  lines: +23 -14
Added instruction `reset' and changed xsb_segfault_catcher(), so that
both xsb_segfault_catcher() and xsb_abort() longjmp to `case reset' in
emuloop.c.  Seg fault handler is now nicer.
----------------------------
revision 1.17
date: 1999/04/19 23:35:51;  author: cbaoqiu;  state: Exp;  lines: +30 -1
Added some comments on the format of WAM instructions.
----------------------------
revision 1.16
date: 1999/04/19 15:40:17;  author: luis;  state: Exp;  lines: +7 -1
* added support for win32 dll's
----------------------------
revision 1.15
date: 1999/03/29 20:34:30;  author: kifer;  state: Exp;  lines: +6 -3
Refined CIGSEGV catching.
Provided place to longjump from xsb_abort.
This is needed, since if xsb_abort is called from within some loop,
control might not go to top level.
So, now, xsb_abort jumps to case FAIL: in emuloop.c
----------------------------
revision 1.14
date: 1999/03/25 02:47:10;  author: kifer;  state: Exp;  lines: +7 -4
Improved segfault handling: even when DEBUG and segfault handling is
disabled, we can now enable it in certain laces, those where we know
the reasons for segfaulting.
----------------------------
revision 1.13
date: 1999/03/23 05:30:11;  author: kifer;  state: Exp;  lines: +16 -2
Added segfault handling.
----------------------------
revision 1.12
date: 1999/03/04 17:47:02;  author: kostis;  state: Exp;  lines: +1 -3
Changes to have heap expansion independently of engine and to fix a
bug in the expansion of heap on the SLG-WAM.
----------------------------
revision 1.11
date: 1999/02/27 21:49:45;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Declare printterm() as externed.
----------------------------
revision 1.10
date: 1999/02/25 15:01:28;  author: kostis;  state: Exp;  lines: +2 -2
Changes for sliding garbage collection made default.
----------------------------
revision 1.9
date: 1999/02/10 23:19:54;  author: kostis;  state: Exp;  lines: +24 -33
slginsts.i contains changes for storing the substitution factor of generators
in the heap irrespectively of SLG-WAM vs CHAT.

emuloop.c supports these changes and contains some clean-up changes related to
garbage collection.
----------------------------
revision 1.8
date: 1999/02/01 23:56:05;  author: kostis;  state: Exp;  lines: +36 -28
Changes for a first cut of a working heap garbage collector.
----------------------------
revision 1.7
date: 1999/01/27 16:21:31;  author: unova;  state: Exp;  lines: +3 -1
changed test_heap instruction for 64 bit architectures
----------------------------
revision 1.6
date: 1999/01/18 18:55:43;  author: kostis;  state: Exp;  lines: +311 -346
Many changes to cleanup stuff and unsused variables in particular.
----------------------------
revision 1.5
date: 1999/01/10 01:07:01;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Declare print_completion_stack as externed if DEBUG is defined (to
remove the warning message from gcc)
----------------------------
revision 1.4
date: 1998/12/21 01:08:16;  author: cbaoqiu;  state: Exp;  lines: +135 -88
Kostis' changes for GC and CHAT.
----------------------------
revision 1.3
date: 1998/12/09 03:09:31;  author: cbaoqiu;  state: Exp;  lines: +13 -1
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  New global variable ans_var_pos_reg is added, and printterm() is
  declared extern if DEBUG is defined.
----------------------------
revision 1.2
date: 1998/12/01 17:10:40;  author: sbprolog;  state: Exp;  lines: +2 -2
These are small fixes to a couple of stack expansion bugs, mainly
in the placing of the overflow checks.

TRIM_CORE is also updated to deal with heap/local stack expansion.

-- Rui Marques
----------------------------
revision 1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:15;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.58.2.1
date: 2000/03/28 18:10:31;  author: lfcastro;  state: Exp;  lines: +10 -43
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.71.2.4
date: 2001/01/07 00:32:50;  author: ruim;  state: Exp;  lines: +3 -0
fixes
----------------------------
revision 1.71.2.3
date: 2001/01/06 18:43:04;  author: ruim;  state: Exp;  lines: +2 -2
Initialization data made static and other small changes
----------------------------
revision 1.71.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.71.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +26 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.86.2.4
date: 2004/11/22 23:07:32;  author: ruim;  state: Exp;  lines: +3 -1
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.86.2.3
date: 2004/11/04 22:31:12;  author: tswift;  state: Exp;  lines: +2 -2

Changes for compilation in cygwin.  This will not affect the linux distribution (I hope).
Changes are:

	1) execute -> xsb_execute, to avoid conflict with pthread.h in cygwin
	2) Renamed mutex constants to accord with pthread.h in cygwin.
----------------------------
revision 1.86.2.2
date: 2004/10/18 20:46:02;  author: ruim;  state: Exp;  lines: +81 -73
update for version 2.6.1
----------------------------
revision 1.86.2.1
date: 2004/09/29 19:44:13;  author: ruim;  state: Exp;  lines: +74 -51
Sources from rfm repository
----------------------------
revision 1.88.2.8
date: 2003/04/17 17:11:47;  author: lfcastro;  state: Exp;  lines: +2 -5
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.88.2.7
date: 2003/02/11 18:36:25;  author: lfcastro;  state: Exp;  lines: +18 -22
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.88.2.6
date: 2002/11/01 22:38:30;  author: lfcastro;  state: Exp;  lines: +6 -0
* Use approximate pruning when cutting (only when DEMAND is enabled)
----------------------------
revision 1.88.2.5
date: 2002/10/28 16:49:30;  author: lfcastro;  state: Exp;  lines: +65 -25
* Merge with HEAD
----------------------------
revision 1.88.2.4
date: 2002/08/10 00:19:34;  author: lfcastro;  state: Exp;  lines: +39 -30
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.88.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +46 -0
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.88.2.2
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +1 -47
* update to HEAD
----------------------------
revision 1.88.2.1
date: 2002/07/31 20:13:46;  author: lfcastro;  state: Exp;  lines: +47 -1
* demand_once/1 predicate cuts over tables, deleting incomplete tables
whose producer is in the scope of the "cut" (preliminary version)
----------------------------
revision 1.205.2.4
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.205.2.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.205.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.205.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/emuloop.h,v
Working file: emuloop.h
head: 1.10
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.10
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	release_2_6_plus_supp: 1.2.0.14
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.12.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.12.1
	multi-threaded-25-engine: 1.2.0.12
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.10
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.8
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.6
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.2
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
----------------------------
revision 1.10
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.9
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2007/07/25 15:52:15;  author: ruim;  state: Exp;  lines: +3 -1
branches:  1.5.4;
moved wam_initialized to emuloop.c
----------------------------
revision 1.4
date: 2005/06/29 13:58:14;  author: vidrevich;  state: Exp;  lines: +3 -2
incorporating multi-threading into C/XSB interface. In multi-threaded engine xsb_init() takes a pointer to the thread context structure as its first argument and populates that structure with main thread context information to be used in the consequent C/XSB calls. myargc,myargv are passed as the second and the third arguments to the xsb_init() when XSB is configured for multi-threading. Changes should not affect a single-threaded version.
----------------------------
revision 1.3
date: 2005/01/14 18:30:58;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.2
date: 1999/05/03 00:55:44;  author: luis;  state: Exp;  lines: +3 -2
branches:  1.2.4;  1.2.12;
* changes regarding exporting functions under Windows
----------------------------
revision 1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.2.12.1
date: 2004/09/29 19:44:13;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.2.4.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.4.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/emuloop_aux.h,v
Working file: emuloop_aux.h
head: 1.19
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.19
	ROLLBACK: 1.13
	latest_plus_supp_branch: 1.9.0.4
	latest_plus_supp: 1.9
	Version_3dot2_plus_supp: 1.9.0.2
	release_2_6_plus_supp: 1.6.0.6
	Version_3dot2: 1.9
	dec07-perf-results: 1.9
	mt_thesis: 1.9
	release_3_0: 1.9
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.5.2.2
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.5.2.1
	multi-threaded-25-engine: 1.5.0.2
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.4
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.2
	release_2_4: 1.2
	release_2_3: 1.2
keyword substitution: kv
total revisions: 24;	selected revisions: 24
description:
----------------------------
revision 1.19
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +4 -7
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.18
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.17
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +7 -4
no message
----------------------------
revision 1.13
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.12
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.11
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +3 -6
Backed out code
----------------------------
revision 1.10
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +7 -4
Dipti's code for support graph added
----------------------------
revision 1.9
date: 2005/12/12 00:19:12;  author: tswift;  state: Exp;  lines: +2 -5
branches:  1.9.4;

Mutexed socket calls which dont seem to be mutexed.  Also added a
mutex around some rarely used string/symbol table statistics.

Other than that, documentation.
----------------------------
revision 1.8
date: 2005/07/15 14:52:31;  author: dwarren;  state: Exp;  lines: +3 -3
Took XSB_Next_Instr from end of SUBTRYME macro, since all uses
are immediately before an (equivalent) XSB_End_Instr, and this allows
something to be done in main instruction if nec (as well as being
cleaner code.)
----------------------------
revision 1.7
date: 2005/01/14 18:30:58;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.6
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -3
* Removal of Chat engine
----------------------------
revision 1.5
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +19 -2
branches:  1.5.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.4
date: 2001/10/05 19:11:40;  author: tswift;  state: Exp;  lines: +7 -1

Fixed profile so it doesnt bomb on CHAT profile.
----------------------------
revision 1.3
date: 2001/09/21 15:01:15;  author: tswift;  state: Exp;  lines: +25 -3

Updates to profile amount of trapped Prolog choice points (if any) in SLGWAM
----------------------------
revision 1.2
date: 2001/01/31 10:23:29;  author: ejohnson;  state: Exp;  lines: +2 -3
Created the macro "table_pending_answer" to hide the details of
obtaining the next answer for consumption, which, in the case of a
properly subsumed subgoal, may require an answer identification step.

Second, removed -- again -- (most) "xtemp1" references.
(Argh!  How does this crap keep creeping back into the system?!?)

These were sprinkled over several files and removed by simply creating
a variable local to each macro in which a temp was needed.

The "need" for this change was precipitated due to the inclusion of an
"xtemp1" declaration within one of the code blocks which
table_pending_answer replaced.
----------------------------
revision 1.1
date: 2001/01/27 00:02:18;  author: lfcastro;  state: Exp;
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.5.2.2
date: 2004/10/18 20:46:03;  author: ruim;  state: Exp;  lines: +1 -3
update for version 2.6.1
----------------------------
revision 1.5.2.1
date: 2004/09/29 19:44:13;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.9.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.9.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +6 -3
no message
----------------------------
revision 1.9.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/error_xsb.c,v
Working file: error_xsb.c
head: 1.101
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.86
	ROLLBACK: 1.81
	latest_plus_supp_branch: 1.81.0.2
	latest_plus_supp: 1.81
	Version_3dot2_plus_supp: 1.80.0.2
	release_2_6_plus_supp: 1.20.0.4
	Version_3dot2: 1.80
	dec07-perf-results: 1.72
	mt_thesis: 1.55
	release_3_0: 1.53
	release_2_7_0: 1.27
	multi-threaded-26-engine: 1.16.2.3
	pre-mt: 1.27
	multi-threaded-25-engine-done: 1.16.2.1
	multi-threaded-25-engine: 1.16.0.2
	release_2_6_1: 1.20
	release_2_6_final: 1.20
	release_2_6: 1.20.0.2
	last-merged-to-demand: 1.19
	demand_branch: 1.19.0.2
	before_removing_chat: 1.17
	release_2_5: 1.16
	pre-merge-slgwam-gc: 1.15
	multi-threaded-c-engine: 1.15.0.2
	release_2_4: 1.15
	release_2_3: 1.12
	multi-threaded-engine: 1.12.0.2
	pre-threading: 1.11
	release-2-2: 1.7
	chat-and-local: 1.7.0.2
	xsb-pre-cleanup: 1.7
	release-2-1: 1.3
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 116;	selected revisions: 116
description:
----------------------------
revision 1.101
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +5 -4

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.100
date: 2012/02/24 22:02:48;  author: dwarren;  state: Exp;  lines: +3 -2
Fixed tempnam bug I just introduced.
----------------------------
revision 1.99
date: 2012/02/24 21:06:49;  author: dwarren;  state: Exp;  lines: +2 -2
Minor changes to make ANSI, and quiet compiler.
Changed tempnam to _tempnam, which is current posix, it says.
----------------------------
revision 1.98
date: 2012/02/24 17:37:21;  author: tswift;  state: Exp;  lines: +24 -1

abort_pre_action and friends.
----------------------------
revision 1.97
date: 2012/02/19 19:17:55;  author: tswift;  state: Exp;  lines: +57 -1

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.96
date: 2012/02/18 04:46:54;  author: kifer;  state: Exp;  lines: +4 -2
minated some compiler warnings
added DllExport to find_string, mem_alloc, mem_realloc.
----------------------------
revision 1.95
date: 2012/02/12 22:49:12;  author: tswift;  state: Exp;  lines: +26 -15

Fixed bug in throwing exceptions with incomplete tables.  Now tables
are reclaimed by unwind stack so that they stop *between* SCCs: this
allows us to continue reclaiming incomplete tables while at the same
time ensuring that we wont backtrack into a choice point for one of
those tables that we reclaimed.
----------------------------
revision 1.94
date: 2011/12/24 21:09:10;  author: tswift;  state: Exp;  lines: +24 -16

Changes	for memory managemement

1) Now supporting max_memory flag for user-defined memory limits

2) Changed some	  memory errors so that rather than creating an
exception ball,	  a flag is set; the exception handler then checks
for the flag.  The reason for doing this is that allocating
memory to assert an exception ball can get us into trouble.
----------------------------
revision 1.93
date: 2011/10/19 22:51:29;  author: tswift;  state: Exp;  lines: +17 -1

Changes to C trace to indicate the state of a tabled subgoal (new/complete/incomplete)
also emitting where an error was called from.

Also, some small change to get call abstracting compiling under MSVC.
----------------------------
revision 1.92
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +58 -3
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.91
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +18 -14
Getting Linux to Work
----------------------------
revision 1.90
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +20 -20
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.89
date: 2011/04/17 18:25:12;  author: tswift;  state: Exp;  lines: +2 -2

Forgot to intern subtype for table_error.
----------------------------
revision 1.88
date: 2011/04/16 18:01:35;  author: tswift;  state: Exp;  lines: +51 -1

Change to allow subtyping in table errors and change to dfs() to use typed table errors.
----------------------------
revision 1.87
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +7 -7

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.86
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.85
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.84
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.83
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.82
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.81
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.81.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.80
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +3 -3


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.79
date: 2008/11/06 00:05:16;  author: tswift;  state: Exp;  lines: +41 -3


These changes started when I needed to use name/2 on some input
that had characters that are not ASCII printable.  Name was
throwing an exception, and it is better for it not to, as such
cnaracters are becoming more popular in the sort of text we have
to handle.

This should have been a simple fix, but when I started looking at
name, I noticed that it had quite archaic code that I got rid of.
name/2 should now be faster -- and its errors more consistent
with atom_ and number_codes.

Speaking of errors, I also went through the ISO manual and made
XSB's code and manual reflect the error handling for
atom_codes/2, atom_chars/2, number_codes/2 and number_chars/2.
In addition, I tweaked errors for number_digits/2 and of course
name/2.  This led to some tweaks in error functions as well.

The one difference is that to conform with ISO specs,
number_chars/2 now throws an error if it cant make its list into
a number -- rather than failing as before.

So the simple fix somehow took me all afternoon.

Terry
----------------------------
revision 1.78
date: 2008/09/05 22:06:57;  author: tswift;  state: Exp;  lines: +33 -2
*** empty log message ***
----------------------------
revision 1.77
date: 2008/04/06 23:04:22;  author: tswift;  state: Exp;  lines: +34 -34
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.76
date: 2008/03/27 19:55:16;  author: tswift;  state: Exp;  lines: +12 -3

A few minor changes for error handling:

Improved error reporting for predicates that call the new C
convert_to_dyna()

Introduced iso_ptoc_callable_arg(), (for now, used only in convert_to_dyna())
----------------------------
revision 1.75
date: 2008/03/22 19:17:34;  author: tswift;  state: Exp;  lines: +3 -2
Started looking at fmt_write since I thought it would be simple to
address its 64-bit issues.  This led me to update its documentation,
and to integrate it a little better with streams and ISO-style errors.
*That* led me to update error handling a little for other I/O
routines.  I put a Prolog stream check into fmt_write and fmt_read,
but apart from this, I don't think that my changes will cause any
detectable slowdowns in I/O.

error_xsb.c -- prettified output of xsb_abort()
----------------------------
revision 1.74
date: 2007/12/24 11:38:00;  author: ruim;  state: Exp;  lines: +4 -4
put cast to remove warning
----------------------------
revision 1.73
date: 2007/12/23 07:38:38;  author: ruim;  state: Exp;  lines: +4 -2
fix for error handling in 64 bits
----------------------------
revision 1.72
date: 2007/11/01 18:48:52;  author: tswift;  state: Exp;  lines: +0 -5
Fixed some problems in **/2 -- Sundays update didn't handle floats
properly, due to a copy and paste error.  Also, I added a domain check
(as in standard) that the number exponientiated isnt negative with a
float exponent.  Finally, I was able to take out the pow builtin as
eval now calls **/2.

In addition, made some of the C error functions DLL-exported so that
they can be used by external C functions.
----------------------------
revision 1.71
date: 2007/10/28 23:32:36;  author: tswift;  state: Exp;  lines: +92 -10


Added evaluable functions **/2 and sign/1, which were in the core standard.

Added an evaluable xor function ></2 which is in the revision.

Rewrote arithmetic_abort to give evaluation errors and instantiation
errors, making us a little more compliant.  We still aren't reporting
underflows or overflows, so we do deviate from the standard in this
respect.
----------------------------
revision 1.70
date: 2007/10/07 17:37:54;  author: tswift;  state: Exp;  lines: +41 -14

Two sets of changes.

First, was to add const declaration modifiers to external ctop and
ptoc routines.  Apparently some C++ compilers can benefit from this
modifier, and it should help the Parma polyhedra group and others who
call XSB from C++.

The second change supports call_cleanup, and fixes a minor bug in the
implementation of catch (see the emails on the XSB group).  This
update does not handle cutting over call cleanup -- I'll try to get
that in soon.
----------------------------
revision 1.69
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +18 -18
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.68
date: 2007/07/30 12:39:48;  author: tswift;  state: Exp;  lines: +2 -2
Forgot a call_conv in a function prototype.
----------------------------
revision 1.67
date: 2007/07/26 15:14:29;  author: tswift;  state: Exp;  lines: +58 -57

1) Change to use xsb_initialization_exit() in xsb_basic_abort() to allow proper
behavior in C interface

2) Made changes to ensure proper mutex initializations when calling XSB from C.
----------------------------
revision 1.66
date: 2007/07/25 17:07:37;  author: evansbj;  state: Exp;  lines: +3 -4
Calling xsb_thread_self 2 lines apart didn't look to efficient
----------------------------
revision 1.65
date: 2007/07/25 15:52:15;  author: ruim;  state: Exp;  lines: +2 -1
moved wam_initialized to emuloop.c
----------------------------
revision 1.64
date: 2007/07/25 15:43:46;  author: ruim;  state: Exp;  lines: +7 -1
fix for allowing xsb_abort on initialization
removed mt code for message queues from compiling in the sequential engine
----------------------------
revision 1.63
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +9 -25

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.62
date: 2007/04/03 10:22:34;  author: tswift;  state: Exp;  lines: +3 -3

Updated register-level C API functions so that an XSB thread can
be called from a different C thread.

There are progressively more complicated examples for how to use
the register-level interface in examples/c_calling_xsb --
cregs.c, cregs_thread.c and cregs_thread2.c, which can be made
via make.P make_thread.P and make_thread2.P and I think I
documented everything in the manual.

Also, I made some macros in the new interface into functions so
they can be dynamically linked and Windows would be happy.  I
tried to follow the pattern of other Windows code, but nobody
should trust me regarding Windows stuff :-)

Finally, I initialized signal handlers in xcallxsb.P
----------------------------
revision 1.61
date: 2007/02/23 22:02:14;  author: dwarren;  state: Exp;  lines: +14 -0
Define vsnprintf from _vsnprintf conditioned on the system not having
snprintf (e.g., msvc compiled system.)
----------------------------
revision 1.60
date: 2007/02/23 20:17:04;  author: tswift;  state: Exp;  lines: +60 -17
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.59
date: 2007/02/17 20:12:46;  author: dwarren;  state: Exp;  lines: +1 -1
Fix building of [] constant in creating abort ball in resource error.
----------------------------
revision 1.58
date: 2007/01/25 20:33:54;  author: tswift;  state: Exp;  lines: +3 -3


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.57
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +22 -1

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.56
date: 2006/12/22 18:57:39;  author: tswift;  state: Exp;  lines: +33 -1
Added syntax errors to file_read/3.  Previously file_read/3 was
effectively handling its own errors, by printing out to STDERR and
failing.  This was not ISO compliant, and had two pressing
problems: it was not safe for threads that concurrently got syntax
errors while reading different streams, and syntax errors could not be
handled by applications -- an important feature for C calling XSB.

Because the reader is very fragile, I made relatively minimal changes
to handle this.  We're still using PSC records to store where an error
occurred (ugh!) because my attempt to actually throw errors at a
potential misparse broke the backtracking HiLog parser. But now at
lease different threads use different PSC records.  In addition, at
the end of file_read, if there is a syntax error, I package it up and
throw a proper error.

I maintained the old file_read predicate as file_read_fapoe (fail and
print out error), and made cmplib/parse.P call this predicate.  The
rest of the system now calls the new file_read.  Also, I did not
change file_read_foe (fail on error) which had been called in a couple
of places.

Also changed xsb_abort() calls in xsb_token.c to throw specific syntax
errors.

emuloop.c changes are purely indentational, to make the code more clear.
----------------------------
revision 1.55
date: 2006/11/05 19:25:47;  author: tswift;  state: Exp;  lines: +27 -1

Added xsb_misc_error() to C error functions.
----------------------------
revision 1.54
date: 2006/10/08 23:40:39;  author: tswift;  state: Exp;  lines: +49 -11

Changes to error_xsb.[ch] to turn current xsb_throw to xsb_throw_internal, and then re-introduce xsb_throw().  This allows xsb_throw to be used more easily
by foreign C functions and will hopefully solve Roberto Bagnara's problem.

Other changes fixed some typos in error messages.
----------------------------
revision 1.53
date: 2006/05/31 21:28:09;  author: crojo;  state: Exp;  lines: +65 -1

Added alternatives to the exported vararg functions that instead have a fixed
number of arguments. An alternative was added for each of the following functions:

xsb_exit(char*, ...)
xsb_abort(char*, ...)
xsb_bug(char*, ...)
xsb_warn(char*, ...)
xsb_mesg(char*, ...)
xsb_error(char*, ...)
xsb_dbgmsg1(int, char*, ...)

Each alternative is the original funtion name with the front xsb_ dropped and
_xsb added to the end. They are:

exit_xsb(char*)
abort_xsb(char*)
bug_xsb(char*)
warn_xsb(char*)
mesg_xsb(char*)
error_xsb(char*)
dbgmsg1_xsb(int, char*)

This has been done to provide a workaround for a bug when using cygwin-mingw32's
gcc v3.4.4. (most likely in the linker) where the original exported vararg
functions can't be linked against.
----------------------------
revision 1.52
date: 2006/03/15 13:15:53;  author: tswift;  state: Exp;  lines: +2 -1


Introduced two new predicates: abolish_private_tables, and
abolish_shared_tables (CPS check for these predicates is not yet
done).

Fixed bug (I think) for null parent pointer in CPS check.

Adding new test for abolishing tables to testsuite.
----------------------------
revision 1.51
date: 2006/01/16 00:33:23;  author: tswift;  state: Exp;  lines: +44 -11

Began documenting MT predicates in manual.  First pass on adding
error checking to multi-threading predicates.  Added
xsb_existence_error() in C.
----------------------------
revision 1.50
date: 2006/01/03 17:14:21;  author: dwarren;  state: Exp;  lines: +1 -2
Fixed float indexing problem in compiler.  Now indexes on floats should work.
(Still not very recommended, but at least the bit patterns pass through.)
Even though compiler still passes only single precision floats, at least now
all those bits are preserved, and converted to double on execution.
----------------------------
revision 1.49
date: 2006/01/02 16:33:37;  author: dwarren;  state: Exp;  lines: +2 -2
Modified XSB_STREAM_LOCK and _UNLOCK to account for reading from strings.
Commented out debugging function that was causing a warning.
Added cast to quiet warning in xsb_error.
----------------------------
revision 1.48
date: 2005/12/31 23:16:03;  author: tswift;  state: Exp;  lines: +120 -17

Fixed problems with throwing memory errors from mem_xxxoc(), at
least in sequential engine.  When memory cannot be malloced, a
resource error is thrown.  Since throwing errors mallocs memory
in itself, mem_xxxocs used by a throw are changed into
mem_xxxoc_nochecks and an xsb_exit is called if these functions
return NULL pointers.  Care is taken so that when a resource
error is thrown, space for its PSCs has been pre-allocated, and
varstrings are used for the actual message strings (varstring
exits too, if there is not enough memory).

In MT engine, a memory error just exits -- this is because I need
a CTXT to throw an error.  Right now, I'm not sure whether its a
good idea or not to put CTXTs into mem_xxxoc or not.

Not that some of the biggest memory allocations, such as tcp
stack, local-heap stack use straight reallocs and use their own
error handling.

In general, we should be handling most memory errors in a
reasonable, or at least consistent, manner.
----------------------------
revision 1.47
date: 2005/12/26 17:17:20;  author: tswift;  state: Exp;  lines: +21 -2
Added check for null pointers to mem_xxxoc() functions.  Thanks to our
now strict use of mem_xxxoc() functions, this means we always check
for null pointers returned by malloc.  Next thing you know, I'll be
rotating my tires every year.  If we do get a null pointer, we call a
non-ISO xsb_memory_error().

Updated documentation in exceptions.tex, and in the course of so doing
added some new ISO-error types to error_handler.P.  There are still
corresponding functions to be added to error_xsb.c Other documentation
for setof and other accumulated changes.

The other change was to get rid of a few stray references to
resume_compl_suspension_inst2.
----------------------------
revision 1.46
date: 2005/12/15 16:39:52;  author: dwarren;  state: Exp;  lines: +2 -2
1. Changed the XSB tokenizer to be more compatible with the Prolog
standard.  This involved adding escape characters when processing
strings -- single quoted, double quoted and 0-radix, as in 0'\n.  The
escape characters are those in the standard (taken from C).  I did not
add \' as a single quote within a quoted string, since it breaks the
form: '/\', which appears several times in the XSB system code.  (This
could, of course, be changed.)  Backslashes that are not followed by a
legal escape indicator are accepted simply as backslashes.  (I suspect
this is not what the standard expects, but it will break fewer
programs.)  I added the new forms for binary (e.g., 0b101), octal
(e.g., 0o731), and hex (e.g., 0xffef) that the standard requires.  I
left in the non-0 radix notation (after fixing a few bugs in it) which
is not in the standard, so we still process e.g., 8'713 as an octal
integer.  I extended the allowable radix up to 36 (which was partially
there already in a buggy form; I used A-Z for the digits 10-35.)  This
is probably not of much use, but what the hey....

The addition of the escape changed one of the tests in the testsuite.
Update tests from cvs to get the new correct answers.

2. Improved assert_code_to_buff so that it will run out of registers
less often when asserting GROUND structures.  The old version had a
limit of approximately 255 for right-branching when the left-elements
were non-constant.  E.g. arbitrary lists of constants were handled, but
lists of structures were limited to c. 255.  I've changed it so the
limit is now on left-branching instead of right-branching.  Since
right-branching is much more common in Prolog programs, this should
handle more structures that show up in Prolog programs.  (No claim is
made for Flora programs :-).
----------------------------
revision 1.45
date: 2005/11/18 21:09:36;  author: tswift;  state: Exp;  lines: +77 -29


Changes to error reporting when an attempt is made to use
attributed variables in subsumptive tables.  Subsumptive tables
do not yet allow attvs, and I want to wait to implement them
until I can restructure the variant table code -- most likely
after the next release.  So for now, just make the error
reporting better.

In order to do this, I introduced a new error type, table_error
for misc errors involving table semantics / implementation.

Other changes affected only code documentation.
----------------------------
revision 1.44
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +10 -9
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.43
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +12 -12


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.42
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +21 -15
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.41
date: 2005/11/11 21:24:30;  author: tswift;  state: Exp;  lines: +4 -2

Change to make xsb_basic_abort() throw a miscellaneous error.

chenge in subp.c is part of an attempt to get rid of xwammode, a bogus global I introduced when young and callow.
----------------------------
revision 1.40
date: 2005/11/10 16:42:24;  author: dwarren;  state: Exp;  lines: +7 -7
Minor cleanup of malloc vs. mem_alloc and free vs. mem_dealloc
----------------------------
revision 1.39
date: 2005/08/12 15:37:16;  author: tswift;  state: Exp;  lines: +45 -11

Modifications for error handling on OS X.  ALso added xsb_domain_error()
----------------------------
revision 1.38
date: 2005/08/08 21:25:02;  author: dwarren;  state: Exp;  lines: +2 -2
SImple cleanup, mostly using define-cons instead of numbers in various places.
----------------------------
revision 1.37
date: 2005/08/08 17:11:32;  author: dwarren;  state: Exp;  lines: +7 -10
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.36
date: 2005/07/19 21:25:44;  author: dwarren;  state: Exp;  lines: +20 -7
Mostly improvements to xsb_abort, so that aborts from down in the
system will now be prefixed with the thread number.  They must be caught by
the thread they occur in.  A catch is added to the calling of the goal that
is initiated by the thread, with the default handler.
I've also added some thread-specific routines for handling thread-specific tables
and clauses (for assert).  I've named mine "ds_???" to distinguish them from
"ts_???" (since TS obviously stood for Terrance Swift and DS stands for David S.
... that's a joke, guys...)  The ds_??? reoutines are just an initial thought,
and when we get a better idea of what we want, we can decide onthe ds or ts
versions, or more likely, some combination or something new altogether.
----------------------------
revision 1.35
date: 2005/07/18 19:47:45;  author: tswift;  state: Exp;  lines: +2 -2

picayune (my word for the day) changes in predicate names and a little added documentation
based on reviewing abolish_table_pred and friends.
----------------------------
revision 1.34
date: 2005/07/13 21:58:56;  author: dwarren;  state: Exp;  lines: +19 -33
More thread-safety, in xsb_throw (and relatives)
and some in cinterf (eliminated global buffers, but still some globals left... so
more work is required.)
----------------------------
revision 1.33
date: 2005/07/11 16:58:30;  author: dwarren;  state: Exp;  lines: +3 -2
Moved declaration not needed for MT under the condition, to avoid warning.
----------------------------
revision 1.32
date: 2005/06/28 17:12:06;  author: dwarren;  state: Exp;  lines: +12 -2
Modified throw to handle throwing out of incomplete tables.
Incomplete tables are removed (out to the catch), and unwind_trail is done.
This is probably still not perfect, but I think it's more complete than what we had.
----------------------------
revision 1.31
date: 2005/05/13 21:16:52;  author: dwarren;  state: Exp;  lines: +4 -6
Fixed bug in error handling (seen in type error to parsort).  Checked for
null culprit.  Also improved error message for parsort error, to include offending
term.
----------------------------
revision 1.30
date: 2005/02/23 20:50:42;  author: dwarren;  state: Exp;  lines: +5 -5
Added context parameters to calls to build_xsb_backtrace.
----------------------------
revision 1.29
date: 2005/02/04 16:56:10;  author: dwarren;  state: Exp;  lines: +6 -6
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.28
date: 2005/01/14 18:30:58;  author: ruim;  state: Exp;  lines: +41 -31
Integration of multithreaded system
----------------------------
revision 1.27
date: 2004/08/31 15:14:11;  author: tswift;  state: Exp;  lines: +37 -1

Added close/2 predicate

Added C-level xsb_permission_error()

Fixed various small buglets and forgotten cases in streams and I/O.
----------------------------
revision 1.26
date: 2004/08/19 22:15:24;  author: tswift;  state: Exp;  lines: +44 -8

Changes for streams.  Here's hoping...
----------------------------
revision 1.25
date: 2004/08/10 22:37:07;  author: tswift;  state: Exp;  lines: +44 -13

Main change was to introduce a new function xsb_type_error to create an ISO type-error from
C.  I replaced a few uses of err_handle, and then substituted the new function for the TYPE
case of err_handle.
----------------------------
revision 1.24
date: 2004/07/16 16:26:05;  author: dwarren;  state: Exp;  lines: +2 -2
Allocate another word in space for abort term in ball to throw.
(Should have been done when the backtrace was added.)
----------------------------
revision 1.23
date: 2004/06/18 22:05:06;  author: tswift;  state: Exp;  lines: +19 -4


A little documentation of the algorithm behind catch/throw.
----------------------------
revision 1.22
date: 2004/04/12 13:08:00;  author: dwarren;  state: Exp;  lines: +4 -3
Better integration of backtrace into abort handling.
----------------------------
revision 1.21
date: 2004/04/09 21:03:05;  author: dwarren;  state: Exp;  lines: +2 -3
Added 1) print_xsb_backtrace and 2) build_xsb_backtrace functions to 1) print
out the predicates on the forward continuation and the backward continuation
and 2) to build a list of these psc pointers to return to Prolog.
If xsb was not started with the -p option, then the backward continuation
is always empty.  Without the -p option, the predicate names returned as the
forward continuation are gotten from the psc pointers in the calls on the
forward continuation (so it is a weird collection of containing predicates,
given last-call optimization.)  With the -p option, it contains all the
predicates on the forward continuation (assuming their names are found),
as well as the calls (when they add new information.) This is clearly just
an approximation, but might help find where, in the Prolog context, bad
things happen.
----------------------------
revision 1.20
date: 2002/11/04 18:09:01;  author: dwarren;  state: Exp;  lines: +74 -37
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.19
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +16 -11
branches:  1.19.2;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.18
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -4
* Removal of Chat engine
----------------------------
revision 1.17
date: 2002/03/11 21:52:55;  author: lfcastro;  state: Exp;  lines: +10 -1
* initial conditional support for backtraces by keeping PSC pointers
in choicepoints
----------------------------
revision 1.16
date: 2001/12/19 07:36:14;  author: kifer;  state: Exp;  lines: +4 -4
branches:  1.16.2;
changed error/warning format
----------------------------
revision 1.15
date: 2001/07/07 06:10:30;  author: kifer;  state: Exp;  lines: +8 -8
some work to enhance dll support.
VarString cleanup in builtin.c
----------------------------
revision 1.14
date: 2001/06/05 19:17:58;  author: lfcastro;  state: Exp;  lines: +9 -1
* re-structured XMC package bootstrapping as suggested by Kifer
* simplified process of compilation for the smodels package
----------------------------
revision 1.13
date: 2001/03/12 17:51:00;  author: kifer;  state: Exp;  lines: +4 -4
Simplified the undef pred hook.
Improved error messages
----------------------------
revision 1.12
date: 2000/06/28 16:54:50;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.12.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.11
date: 2000/06/19 07:07:24;  author: ruim;  state: Exp;  lines: +2 -1
added include stdlib.h
----------------------------
revision 1.10
date: 2000/05/20 06:55:59;  author: kifer;  state: Exp;  lines: +2 -2
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.9
date: 2000/05/16 19:07:32;  author: lfcastro;  state: Exp;  lines: +4 -1
* bugfix suggested by Kostis to the bug related to abolishing open
completion suspension slots on CHAT
----------------------------
revision 1.8
date: 2000/04/29 21:53:53;  author: kifer;  state: Exp;  lines: +7 -7
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.7
date: 2000/02/17 01:35:49;  author: tswift;  state: Exp;  lines: +89 -3

Starting integration of catch/throw
----------------------------
revision 1.6
date: 2000/01/27 23:07:12;  author: unova;  state: Exp;  lines: +3 -3
Partial fix for 64 bit architectures.
----------------------------
revision 1.5
date: 2000/01/07 08:51:28;  author: kifer;  state: Exp;  lines: +7 -7
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.4
date: 1999/11/29 00:30:16;  author: kifer;  state: Exp;  lines: +19 -16
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.3
date: 1999/11/17 03:54:27;  author: kifer;  state: Exp;  lines: +21 -1
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.2
date: 1999/10/26 06:46:59;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:58:09;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.12.2.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.12.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +36 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.16.2.3
date: 2004/12/26 17:29:21;  author: ruim;  state: Exp;  lines: +8 -6
made exception mechanism multi-threaded
----------------------------
revision 1.16.2.2
date: 2004/10/18 20:46:03;  author: ruim;  state: Exp;  lines: +96 -45
update for version 2.6.1
----------------------------
revision 1.16.2.1
date: 2004/09/29 19:44:13;  author: ruim;  state: Exp;  lines: +18 -14
Sources from rfm repository
----------------------------
revision 1.19.2.7
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +3 -3
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.19.2.6
date: 2003/04/17 17:11:47;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.19.2.5
date: 2003/02/11 18:36:24;  author: lfcastro;  state: Exp;  lines: +73 -36
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.19.2.4
date: 2002/08/29 14:17:13;  author: lfcastro;  state: Exp;  lines: +1 -1
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.19.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +5 -5
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.19.2.2
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +5 -5
* update to HEAD
----------------------------
revision 1.19.2.1
date: 2002/07/31 20:13:46;  author: lfcastro;  state: Exp;  lines: +5 -5
* demand_once/1 predicate cuts over tables, deleting incomplete tables
whose producer is in the scope of the "cut" (preliminary version)
----------------------------
revision 1.81.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.81.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.81.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/error_xsb.h,v
Working file: error_xsb.h
head: 1.59
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.52
	ROLLBACK: 1.46
	latest_plus_supp_branch: 1.42.0.4
	latest_plus_supp: 1.42
	Version_3dot2_plus_supp: 1.42.0.2
	release_2_6_plus_supp: 1.7.0.4
	Version_3dot2: 1.42
	dec07-perf-results: 1.40
	mt_thesis: 1.30
	release_3_0: 1.28
	release_2_7_0: 1.13
	multi-threaded-26-engine: 1.5.4.2
	pre-mt: 1.13
	multi-threaded-25-engine-done: 1.5.4.1
	multi-threaded-25-engine: 1.5.0.4
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.2
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.2
	release_2_4: 1.5
	release_2_3: 1.4
	multi-threaded-engine: 1.3.0.4
	pre-threading: 1.3
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 71;	selected revisions: 71
description:
----------------------------
revision 1.59
date: 2012/02/24 17:37:21;  author: tswift;  state: Exp;  lines: +2 -1

abort_pre_action and friends.
----------------------------
revision 1.58
date: 2011/12/24 22:59:04;  author: dwarren;  state: Exp;  lines: +2 -2
Made declarations consistent (so works on Windows)
----------------------------
revision 1.57
date: 2011/12/24 21:09:10;  author: tswift;  state: Exp;  lines: +2 -1

Changes	for memory managemement

1) Now supporting max_memory flag for user-defined memory limits

2) Changed some	  memory errors so that rather than creating an
exception ball,	  a flag is set; the exception handler then checks
for the flag.  The reason for doing this is that allocating
memory to assert an exception ball can get us into trouble.
----------------------------
revision 1.56
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +2 -2
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.55
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +2 -2
Getting Linux to Work
----------------------------
revision 1.54
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.53
date: 2011/04/16 18:01:35;  author: tswift;  state: Exp;  lines: +2 -1

Change to allow subtyping in table errors and change to dfs() to use typed table errors.
----------------------------
revision 1.52
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +2 -2
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.51
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.50
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.49
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.48
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.47
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +2 -2
no message
----------------------------
revision 1.46
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.45
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.44
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out code
----------------------------
revision 1.43
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +2 -2
Dipti's code for support graph added
----------------------------
revision 1.42
date: 2008/11/06 00:05:16;  author: tswift;  state: Exp;  lines: +4 -2
branches:  1.42.4;


These changes started when I needed to use name/2 on some input
that had characters that are not ASCII printable.  Name was
throwing an exception, and it is better for it not to, as such
cnaracters are becoming more popular in the sort of text we have
to handle.

This should have been a simple fix, but when I started looking at
name, I noticed that it had quite archaic code that I got rid of.
name/2 should now be faster -- and its errors more consistent
with atom_ and number_codes.

Speaking of errors, I also went through the ISO manual and made
XSB's code and manual reflect the error handling for
atom_codes/2, atom_chars/2, number_codes/2 and number_chars/2.
In addition, I tweaked errors for number_digits/2 and of course
name/2.  This led to some tweaks in error functions as well.

The one difference is that to conform with ISO specs,
number_chars/2 now throws an error if it cant make its list into
a number -- rather than failing as before.

So the simple fix somehow took me all afternoon.

Terry
----------------------------
revision 1.41
date: 2008/09/05 22:08:47;  author: tswift;  state: Exp;  lines: +2 -1
A user rightly complained about error messages in univ.  I
restructured univ code a little so that our error reporting for
univ is ISO-compliant (well, almost).  To do this, I had to
create a function xsb_representation_error().

Univ documentation in the manual was also very out of date, so I
updated that.
----------------------------
revision 1.40
date: 2007/11/20 19:17:20;  author: tswift;  state: Exp;  lines: +2 -2


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.39
date: 2007/11/01 18:48:52;  author: tswift;  state: Exp;  lines: +28 -11
Fixed some problems in **/2 -- Sundays update didn't handle floats
properly, due to a copy and paste error.  Also, I added a domain check
(as in standard) that the number exponientiated isnt negative with a
float exponent.  Finally, I was able to take out the pow builtin as
eval now calls **/2.

In addition, made some of the C error functions DLL-exported so that
they can be used by external C functions.
----------------------------
revision 1.38
date: 2007/10/07 17:37:54;  author: tswift;  state: Exp;  lines: +8 -8

Two sets of changes.

First, was to add const declaration modifiers to external ctop and
ptoc routines.  Apparently some C++ compilers can benefit from this
modifier, and it should help the Parma polyhedra group and others who
call XSB from C++.

The second change supports call_cleanup, and fixes a minor bug in the
implementation of catch (see the emails on the XSB group).  This
update does not handle cutting over call cleanup -- I'll try to get
that in soon.
----------------------------
revision 1.37
date: 2007/08/29 22:15:56;  author: tswift;  state: Exp;  lines: +9 -2
Wrapped with an extern C wrapper for use by C++
----------------------------
revision 1.36
date: 2007/07/25 15:52:15;  author: ruim;  state: Exp;  lines: +1 -3
moved wam_initialized to emuloop.c
----------------------------
revision 1.35
date: 2007/07/25 15:43:46;  author: ruim;  state: Exp;  lines: +3 -1
fix for allowing xsb_abort on initialization
removed mt code for message queues from compiling in the sequential engine
----------------------------
revision 1.34
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +4 -6

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.33
date: 2007/02/23 20:17:04;  author: tswift;  state: Exp;  lines: +2 -2
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.32
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +2 -1

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.31
date: 2006/12/22 18:57:39;  author: tswift;  state: Exp;  lines: +2 -1
Added syntax errors to file_read/3.  Previously file_read/3 was
effectively handling its own errors, by printing out to STDERR and
failing.  This was not ISO compliant, and had two pressing
problems: it was not safe for threads that concurrently got syntax
errors while reading different streams, and syntax errors could not be
handled by applications -- an important feature for C calling XSB.

Because the reader is very fragile, I made relatively minimal changes
to handle this.  We're still using PSC records to store where an error
occurred (ugh!) because my attempt to actually throw errors at a
potential misparse broke the backtracking HiLog parser. But now at
lease different threads use different PSC records.  In addition, at
the end of file_read, if there is a syntax error, I package it up and
throw a proper error.

I maintained the old file_read predicate as file_read_fapoe (fail and
print out error), and made cmplib/parse.P call this predicate.  The
rest of the system now calls the new file_read.  Also, I did not
change file_read_foe (fail on error) which had been called in a couple
of places.

Also changed xsb_abort() calls in xsb_token.c to throw specific syntax
errors.

emuloop.c changes are purely indentational, to make the code more clear.
----------------------------
revision 1.30
date: 2006/11/05 19:25:47;  author: tswift;  state: Exp;  lines: +10 -9

Added xsb_misc_error() to C error functions.
----------------------------
revision 1.29
date: 2006/10/08 23:40:39;  author: tswift;  state: Exp;  lines: +2 -2

Changes to error_xsb.[ch] to turn current xsb_throw to xsb_throw_internal, and then re-introduce xsb_throw().  This allows xsb_throw to be used more easily
by foreign C functions and will hopefully solve Roberto Bagnara's problem.

Other changes fixed some typos in error messages.
----------------------------
revision 1.28
date: 2006/05/31 21:28:09;  author: crojo;  state: Exp;  lines: +13 -6

Added alternatives to the exported vararg functions that instead have a fixed
number of arguments. An alternative was added for each of the following functions:

xsb_exit(char*, ...)
xsb_abort(char*, ...)
xsb_bug(char*, ...)
xsb_warn(char*, ...)
xsb_mesg(char*, ...)
xsb_error(char*, ...)
xsb_dbgmsg1(int, char*, ...)

Each alternative is the original funtion name with the front xsb_ dropped and
_xsb added to the end. They are:

exit_xsb(char*)
abort_xsb(char*)
bug_xsb(char*)
warn_xsb(char*)
mesg_xsb(char*)
error_xsb(char*)
dbgmsg1_xsb(int, char*)

This has been done to provide a workaround for a bug when using cygwin-mingw32's
gcc v3.4.4. (most likely in the linker) where the original exported vararg
functions can't be linked against.
----------------------------
revision 1.27
date: 2006/04/17 20:54:57;  author: tswift;  state: Exp;  lines: +1 -15

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.26
date: 2006/03/24 16:40:28;  author: tswift;  state: Exp;  lines: +8 -5

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.25
date: 2006/01/24 14:10:01;  author: tswift;  state: Exp;  lines: +2 -1

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.24
date: 2006/01/16 00:33:23;  author: tswift;  state: Exp;  lines: +4 -3

Began documenting MT predicates in manual.  First pass on adding
error checking to multi-threading predicates.  Added
xsb_existence_error() in C.
----------------------------
revision 1.23
date: 2005/12/31 23:16:03;  author: tswift;  state: Exp;  lines: +4 -2

Fixed problems with throwing memory errors from mem_xxxoc(), at
least in sequential engine.  When memory cannot be malloced, a
resource error is thrown.  Since throwing errors mallocs memory
in itself, mem_xxxocs used by a throw are changed into
mem_xxxoc_nochecks and an xsb_exit is called if these functions
return NULL pointers.  Care is taken so that when a resource
error is thrown, space for its PSCs has been pre-allocated, and
varstrings are used for the actual message strings (varstring
exits too, if there is not enough memory).

In MT engine, a memory error just exits -- this is because I need
a CTXT to throw an error.  Right now, I'm not sure whether its a
good idea or not to put CTXTs into mem_xxxoc or not.

Not that some of the biggest memory allocations, such as tcp
stack, local-heap stack use straight reallocs and use their own
error handling.

In general, we should be handling most memory errors in a
reasonable, or at least consistent, manner.
----------------------------
revision 1.22
date: 2005/12/29 18:06:47;  author: dwarren;  state: Exp;  lines: +2 -2
Minor fixes to Terry's changes to account for Windoze idiosyncracies:
call_conv in declaration in error_xsb.h
and Windoze's re_alloc returns NULL when given size of zero, so return NULL in these cases.
----------------------------
revision 1.21
date: 2005/12/26 17:17:20;  author: tswift;  state: Exp;  lines: +3 -1
Added check for null pointers to mem_xxxoc() functions.  Thanks to our
now strict use of mem_xxxoc() functions, this means we always check
for null pointers returned by malloc.  Next thing you know, I'll be
rotating my tires every year.  If we do get a null pointer, we call a
non-ISO xsb_memory_error().

Updated documentation in exceptions.tex, and in the course of so doing
added some new ISO-error types to error_handler.P.  There are still
corresponding functions to be added to error_xsb.c Other documentation
for setof and other accumulated changes.

The other change was to get rid of a few stray references to
resume_compl_suspension_inst2.
----------------------------
revision 1.20
date: 2005/11/18 21:09:36;  author: tswift;  state: Exp;  lines: +5 -4


Changes to error reporting when an attempt is made to use
attributed variables in subsumptive tables.  Subsumptive tables
do not yet allow attvs, and I want to wait to implement them
until I can restructure the variant table code -- most likely
after the next release.  So for now, just make the error
reporting better.

In order to do this, I introduced a new error type, table_error
for misc errors involving table semantics / implementation.

Other changes affected only code documentation.
----------------------------
revision 1.19
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +2 -2
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.18
date: 2005/10/14 13:24:37;  author: dwarren;  state: Exp;  lines: +2 -1
Added error checking to str_len (and made it throw errors instead of
quietly failing.)
----------------------------
revision 1.17
date: 2005/08/08 17:11:32;  author: dwarren;  state: Exp;  lines: +1 -8
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.16
date: 2005/07/19 21:25:44;  author: dwarren;  state: Exp;  lines: +9 -11
Mostly improvements to xsb_abort, so that aborts from down in the
system will now be prefixed with the thread number.  They must be caught by
the thread they occur in.  A catch is added to the calling of the goal that
is initiated by the thread, with the default handler.
I've also added some thread-specific routines for handling thread-specific tables
and clauses (for assert).  I've named mine "ds_???" to distinguish them from
"ts_???" (since TS obviously stood for Terrance Swift and DS stands for David S.
... that's a joke, guys...)  The ds_??? reoutines are just an initial thought,
and when we get a better idea of what we want, we can decide onthe ds or ts
versions, or more likely, some combination or something new altogether.
----------------------------
revision 1.15
date: 2005/02/23 20:50:42;  author: dwarren;  state: Exp;  lines: +2 -2
Added context parameters to calls to build_xsb_backtrace.
----------------------------
revision 1.14
date: 2005/01/14 18:30:59;  author: ruim;  state: Exp;  lines: +22 -13
Integration of multithreaded system
----------------------------
revision 1.13
date: 2004/09/29 21:41:55;  author: dwarren;  state: Exp;  lines: +2 -2
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.12
date: 2004/08/31 15:14:11;  author: tswift;  state: Exp;  lines: +2 -1

Added close/2 predicate

Added C-level xsb_permission_error()

Fixed various small buglets and forgotten cases in streams and I/O.
----------------------------
revision 1.11
date: 2004/08/19 22:15:24;  author: tswift;  state: Exp;  lines: +2 -1

Changes for streams.  Here's hoping...
----------------------------
revision 1.10
date: 2004/08/10 22:37:08;  author: tswift;  state: Exp;  lines: +3 -1

Main change was to introduce a new function xsb_type_error to create an ISO type-error from
C.  I replaced a few uses of err_handle, and then substituted the new function for the TYPE
case of err_handle.
----------------------------
revision 1.9
date: 2004/04/12 13:08:00;  author: dwarren;  state: Exp;  lines: +3 -1
Better integration of backtrace into abort handling.
----------------------------
revision 1.8
date: 2004/04/09 21:03:06;  author: dwarren;  state: Exp;  lines: +3 -1
Added 1) print_xsb_backtrace and 2) build_xsb_backtrace functions to 1) print
out the predicates on the forward continuation and the backward continuation
and 2) to build a list of these psc pointers to return to Prolog.
If xsb was not started with the -p option, then the backward continuation
is always empty.  Without the -p option, the predicate names returned as the
forward continuation are gotten from the psc pointers in the calls on the
forward continuation (so it is a weird collection of containing predicates,
given last-call optimization.)  With the -p option, it contains all the
predicates on the forward continuation (assuming their names are found),
as well as the calls (when they add new information.) This is clearly just
an approximation, but might help find where, in the Prolog context, bad
things happen.
----------------------------
revision 1.7
date: 2002/11/04 18:09:01;  author: dwarren;  state: Exp;  lines: +24 -1
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.6
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.6.2;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.5
date: 2001/07/07 06:10:30;  author: kifer;  state: Exp;  lines: +9 -8
branches:  1.5.4;
some work to enhance dll support.
VarString cleanup in builtin.c
----------------------------
revision 1.4
date: 2000/12/27 00:26:43;  author: kifer;  state: Exp;  lines: +2 -1
Changed the default for segfault handling.
Fixed bug in the debugger where it fogot to close previously open input
stream.
----------------------------
revision 1.3
date: 2000/02/17 01:35:49;  author: tswift;  state: Exp;  lines: +12 -2
branches:  1.3.4;

Starting integration of catch/throw
----------------------------
revision 1.2
date: 1999/11/17 03:54:28;  author: kifer;  state: Exp;  lines: +3 -2
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.1
date: 1999/10/25 05:58:10;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.4.2
date: 2000/12/19 15:58:14;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.4.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +8 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.5.4.2
date: 2004/10/18 20:46:03;  author: ruim;  state: Exp;  lines: +28 -2
update for version 2.6.1
----------------------------
revision 1.5.4.1
date: 2004/09/29 19:44:13;  author: ruim;  state: Exp;  lines: +12 -6
Sources from rfm repository
----------------------------
revision 1.6.2.5
date: 2003/04/17 17:11:47;  author: lfcastro;  state: Exp;  lines: +2 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.6.2.4
date: 2003/02/11 18:36:23;  author: lfcastro;  state: Exp;  lines: +24 -0
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.6.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +4 -0
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.6.2.2
date: 2002/08/07 17:53:33;  author: lfcastro;  state: Exp;  lines: +1 -5
* update to HEAD
----------------------------
revision 1.6.2.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +5 -1
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.42.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.42.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.42.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/export.h,v
Working file: export.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.3.0.12
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.3.10.1
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.3.10.1
	multi-threaded-25-engine: 1.3.0.10
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.8
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.6
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.4
	release_2_4: 1.3
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.2
	pre-threading: 1.3
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.1
	release-2-0-1: 1.1
	subsumption: 1.1
	without-attv: 1.1
	release-2-0: 1.1
keyword substitution: kv
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.9
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2005/01/14 18:31:15;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.4.4;
Integration of multithreaded system
----------------------------
revision 1.3
date: 2000/05/20 06:56:00;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.3.2;  1.3.10;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.2
date: 2000/01/07 08:51:29;  author: kifer;  state: Exp;  lines: +2 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.1
date: 1999/05/03 00:57:41;  author: luis;  state: Exp;
* changes regarding exporting functions under Windows
----------------------------
revision 1.3.10.1
date: 2004/09/29 19:44:14;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.3.2.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/extensions_xsb.h,v
Working file: extensions_xsb.h
head: 1.17
branch:
locks: strict
access list:
symbolic names:
	latest_plus_supp_branch: 1.16.0.2
	release_2_6_plus_supp: 1.5.0.8
	mt_thesis: 1.5
	release_3_0: 1.5
	release_2_7_0: 1.5
	multi-threaded-26-engine: 1.5.6.1
	pre-mt: 1.5
	multi-threaded-25-engine: 1.5.0.6
	release_2_6_1: 1.5
	release_2_6_final: 1.5
	release_2_6: 1.5.0.4
	last-merged-to-demand: 1.5
	demand_branch: 1.5.0.2
keyword substitution: kv
total revisions: 21;	selected revisions: 21
description:
----------------------------
revision 1.17
date: 2011/05/16 01:03:07;  author: kifer;  state: Exp;  lines: +1 -1
added extentsions_xsb.h to the repository.
Otherwise, windows building problems
----------------------------
revision 1.16
date: 2007/08/18 22:07:55;  author: kifer;  state: dead;  lines: +0 -0
branches:  1.16.2;
removed emu/extensions_xsb.h from CVS. This file is generated by configure and
there are frequent clashes due to that.
----------------------------
revision 1.15
date: 2007/08/18 19:55:20;  author: tswift;  state: Exp;  lines: +1 -1
Made thread_entry() visible to help setting up arrays to threads in Interprolog and XSB.net.
----------------------------
revision 1.14
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +1 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.13
date: 2007/07/26 15:14:29;  author: tswift;  state: Exp;  lines: +1 -1

1) Change to use xsb_initialization_exit() in xsb_basic_abort() to allow proper
behavior in C interface

2) Made changes to ensure proper mutex initializations when calling XSB from C.
----------------------------
revision 1.12
date: 2007/07/17 13:14:22;  author: kifer;  state: Exp;  lines: +1 -1
reversed changes to odbc_driver.c
----------------------------
revision 1.11
date: 2007/07/13 18:34:12;  author: kifer;  state: Exp;  lines: +1 -1
fug fixes in configure.in and related
----------------------------
revision 1.10
date: 2007/07/13 10:34:39;  author: kifer;  state: Exp;  lines: +1 -1
converted to new autoconf
----------------------------
revision 1.9
date: 2007/03/30 10:34:08;  author: tswift;  state: Exp;  lines: +47 -47

Changes for debugging: printing out structures (e.g. deleted clref chains) and more informative error reporting.
----------------------------
revision 1.8
date: 2007/03/16 20:40:31;  author: dwarren;  state: Exp;  lines: +47 -47
Add new mega-xwam-instructions to compile "abc"-type strings more
efficiently.  This changes almost(?) all xwam files.
The implementation at this point is just thru the peephole
optimizer.  The next step is to change the way the compiler
processes these strings to speed up compilation.
----------------------------
revision 1.7
date: 2007/02/22 00:16:04;  author: tswift;  state: Exp;  lines: +47 -47


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.6
date: 2007/02/09 18:12:17;  author: dwarren;  state: Exp;  lines: +47 -47
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.5
date: 2002/03/22 17:14:12;  author: kifer;  state: Exp;  lines: +0 -1
branches:  1.5.6;
don't modify extensions each time (got rid of $ID$)
----------------------------
revision 1.4
date: 2002/03/17 10:36:40;  author: kifer;  state: Exp;  lines: +1 -1
minor
----------------------------
revision 1.3
date: 2002/03/15 10:35:28;  author: kifer;  state: Exp;  lines: +5 -6
cosmetic
----------------------------
revision 1.2
date: 2002/03/15 09:57:20;  author: kifer;  state: Exp;  lines: +10 -2
make extensions_xsb.h generated by configure
----------------------------
revision 1.1
date: 2002/03/15 09:19:51;  author: kifer;  state: Exp;
renamed loader_defs.h to extensions.h
----------------------------
revision 1.5.6.1
date: 2004/10/18 20:46:03;  author: ruim;  state: Exp;  lines: +0 -0
update for version 2.6.1
----------------------------
revision 1.16.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.16.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +47 -0
no message
----------------------------
revision 1.16.2.1
date: 2007/08/18 22:07:55;  author: spyrosh;  state: dead;  lines: +0 -47
file extensions_xsb.h was added on branch latest_plus_supp_branch on 2010-06-19 19:39:51 +0000
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/file_modes_xsb.h,v
Working file: file_modes_xsb.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.12.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.12.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2005/01/14 18:31:15;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.2.4;
Integration of multithreaded system
----------------------------
revision 1.1
date: 1999/11/23 04:06:43;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.12;
Added tmpfile_open.
Cleaned up the file opening modes stuff.
----------------------------
revision 1.1.12.1
date: 2004/09/29 19:44:14;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/findall.c,v
Working file: findall.c
head: 1.58
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.53
	ROLLBACK: 1.48
	latest_plus_supp_branch: 1.48.0.4
	latest_plus_supp: 1.48
	Version_3dot2_plus_supp: 1.48.0.2
	release_2_6_plus_supp: 1.27.0.4
	Version_3dot2: 1.48
	dec07-perf-results: 1.45
	mt_thesis: 1.38
	release_3_0: 1.33
	release_2_7_0: 1.27
	multi-threaded-26-engine: 1.25.6.2
	pre-mt: 1.27
	multi-threaded-25-engine-done: 1.25.6.1
	multi-threaded-25-engine: 1.25.0.6
	release_2_6_1: 1.27
	release_2_6_final: 1.27
	release_2_6: 1.27.0.2
	last-merged-to-demand: 1.26
	demand_branch: 1.25.0.4
	before_removing_chat: 1.25
	release_2_5: 1.25
	pre-merge-slgwam-gc: 1.25
	multi-threaded-c-engine: 1.25.0.2
	release_2_4: 1.25
	release_2_3: 1.23
	multi-threaded-engine: 1.22.0.2
	pre-threading: 1.21
	release-2-2: 1.19
	chat-and-local: 1.19.0.2
	xsb-pre-cleanup: 1.19
	release-2-1: 1.12
	release-2-0-1: 1.12
	subsumption: 1.8
	without-attv: 1.5
	release-2-0: 1.4
	pre-release-2-0: 1.4
	v1-9-8: 1.4
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 70;	selected revisions: 70
description:
----------------------------
revision 1.58
date: 2012/02/10 22:02:39;  author: tswift;  state: Exp;  lines: +7 -4

Fix to avoid a core dump when ysing copy_term on 0-ary strings.
----------------------------
revision 1.57
date: 2011/12/24 21:09:10;  author: tswift;  state: Exp;  lines: +3 -2

Changes	for memory managemement

1) Now supporting max_memory flag for user-defined memory limits

2) Changed some	  memory errors so that rather than creating an
exception ball,	  a flag is set; the exception handler then checks
for the flag.  The reason for doing this is that allocating
memory to assert an exception ball can get us into trouble.
----------------------------
revision 1.56
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +4 -4
Getting Linux to Work
----------------------------
revision 1.55
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +8 -8
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.54
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +3 -2

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.53
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.52
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.51
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.50
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.49
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.48
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +28 -8
branches:  1.48.4;
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.47
date: 2008/10/31 21:50:39;  author: dwarren;  state: Exp;  lines: +2 -1
Fix bug in calculating term size in findall, when generating a list of variables.
----------------------------
revision 1.46
date: 2008/10/23 17:33:54;  author: tswift;  state: Exp;  lines: +10 -2

Added gl check for reallication before copying a goal into the heap of
a newly created thread.  This fixes some memory problems uncovered by MT
logtalk.
----------------------------
revision 1.45
date: 2007/10/27 09:31:57;  author: ruim;  state: Exp;  lines: +6 -6
fixed mistake in last fix
----------------------------
revision 1.44
date: 2007/10/27 08:47:40;  author: ruim;  state: Exp;  lines: +16 -26
rationalized changes to do_copy_term

fix for copying lists

thread_create should be completly correct now
----------------------------
revision 1.43
date: 2007/10/26 21:09:21;  author: ruim;  state: Exp;  lines: +26 -4
fixed bug in copy_term_from_thread which caused incorrect
bindings of variables shared by the term
----------------------------
revision 1.42
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.41
date: 2007/03/12 16:06:20;  author: dwarren;  state: Exp;  lines: +24 -7
Fix findall deallocate routines to handle new situation of having one
chunk allocated but nothing in it.
Added findall_clean_all to free all memory associated with findall
buffers and added call to it when exiting a thread.
----------------------------
revision 1.40
date: 2007/03/09 20:48:43;  author: dwarren;  state: Exp;  lines: +14 -10
Modified findall.c to keep the first chunk on each chain, and not free it.
Read_canonical uses these buffers, and freeing and reallocating (and especially
with the use of mem_calloc reinitializing large buffers to 0) takes a long
time.  E.g. this change reduces the time to load_dync a large file from
14 secs to 9 secs.
----------------------------
revision 1.39
date: 2007/02/23 20:17:04;  author: tswift;  state: Exp;  lines: +6 -6
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.38
date: 2006/11/09 21:22:19;  author: dwarren;  state: Exp;  lines: +9 -2
Fixed a bug we introduced in findall and/or the odbc interface.
Problem was when we changed to boxed floats, updates to these files
weren't consistent, so size was computed incorrectly and resulted heap
in overflow.
----------------------------
revision 1.37
date: 2006/10/02 14:46:57;  author: dwarren;  state: Exp;  lines: +2 -5
Take out earlier attempt to ensure that string gc doesn't access uninitialized
portions of findall chunks.  The mem_calloc makes this code redundant (and it didn't
work anyway.)
----------------------------
revision 1.36
date: 2006/09/28 15:50:14;  author: dwarren;  state: Exp;  lines: +2 -2
Initialized chunks by using mem_calloc (just to see if it shuts valgrind up...)
----------------------------
revision 1.35
date: 2006/09/25 15:53:04;  author: dwarren;  state: Exp;  lines: +5 -0
Initialize unused ends of findall chunks to NULL, so string marking in string gc
doesn't look at uninitialized memory.
----------------------------
revision 1.34
date: 2006/09/01 13:12:39;  author: dwarren;  state: Exp;  lines: +29 -23
findall and unify did not correctly handle 0-ary psc records on the heap.
These are unusual in that they only arise when they represent 0-ary predicate
symbols, so creating them on the heap and unifying them is exceedingly rare.
But it caused a crash when writing a metapredicate to get all tabled predicates,
and a 0-ary one was encountered.  So I fixed it.
----------------------------
revision 1.33
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +22 -1
Added string table garbage collection.
----------------------------
revision 1.32
date: 2005/11/18 22:55:13;  author: dwarren;  state: Exp;  lines: +16 -3
Modified findall_copy_to_heap to convert single floats to doubles
(if not FAST_FLOATS).  This means that read_canonical will create doubles,
since it uses findall_copy_to_heap.
----------------------------
revision 1.31
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +9 -11
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.30
date: 2005/07/06 18:29:12;  author: dwarren;  state: Exp;  lines: +60 -58
FOr Multithreading: Made findall thread-safe by moving its static variables
to the thread structure.  Now each thread has its own chain of findall buffers.
----------------------------
revision 1.29
date: 2005/02/04 16:56:11;  author: dwarren;  state: Exp;  lines: +9 -9
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.28
date: 2005/01/14 18:31:15;  author: ruim;  state: Exp;  lines: +50 -27
Integration of multithreaded system
----------------------------
revision 1.27
date: 2002/11/04 18:09:01;  author: dwarren;  state: Exp;  lines: +3 -3
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.26
date: 2002/08/07 15:42:13;  author: lfcastro;  state: Exp;  lines: +4 -4
* do not use is_* functions (from the C interface) inside the
  emulator.
----------------------------
revision 1.25
date: 2001/03/17 05:44:02;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.25.4;  1.25.6;
improved error messages
----------------------------
revision 1.24
date: 2001/03/10 00:02:17;  author: kifer;  state: Exp;  lines: +5 -4
changed some xsb_exits to xsb_aborts
----------------------------
revision 1.23
date: 2001/02/07 14:35:33;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed a memory leak, in how findall returns buffers.
----------------------------
revision 1.22
date: 2000/06/28 16:54:50;  author: ruim;  state: Exp;  lines: +4 -4
branches:  1.22.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.21
date: 2000/05/20 06:56:00;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.20
date: 2000/04/29 21:53:53;  author: kifer;  state: Exp;  lines: +100 -98
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.19
date: 2000/03/09 04:36:47;  author: cbaoqiu;  state: Exp;  lines: +7 -4
Changed lines like
	cell(to) = (Cell) to++;
to two lines
	cell(to) = (Cell) to;
	to++;
so that the compiler on SGI can *correctly* compile them.  On Solaris
(or Linux) the one-line version and the two-line version have the same
result, but on SGI they are compiled differently.  This change fixed a
bug found on the 64bit configuration (the bug appears in attv_tests).
----------------------------
revision 1.18
date: 2000/02/15 07:45:08;  author: bartkul;  state: Exp;  lines: +3 -7
in testsuite.sh supertest.sh gctest.sh

changed testsuite.sh    into    ./testsuite.sh
        makexsb         into    ./makexsb
        configure       into    ./configure

in prolog_tests/c_calls_xsb_make.P

changed c_calls_xsb.exe into    ./c_calls_xsb.exe


in the c and h files: given check_glstack_overflow an extra argument

standard.O ... I have no idea
----------------------------
revision 1.17
date: 2000/02/13 22:15:42;  author: cbaoqiu;  state: Exp;  lines: +542 -207
Added some changes Bart made to share CS and LIST in copy_term.
----------------------------
revision 1.16
date: 2000/02/13 09:04:36;  author: cbaoqiu;  state: Exp;  lines: +26 -5
Changed case ATTV: in term_size() to handle cyclic terms formed by
attributed variables.  So that attributed variables can really be
shared in copy_term.
----------------------------
revision 1.15
date: 2000/01/07 08:51:30;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.14
date: 1999/12/10 08:25:08;  author: kifer;  state: Exp;  lines: +309 -316
brought indentation and formatting in line with GNU.
----------------------------
revision 1.13
date: 1999/12/10 07:47:31;  author: kifer;  state: Exp;  lines: +212 -210
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.12
date: 1999/11/05 21:43:13;  author: cbaoqiu;  state: Exp;  lines: +73 -16
Added some code in functions findall_copy_to_heap() and
findall_copy_template_to_chunk() to support attributed variables..
----------------------------
revision 1.11
date: 1999/11/03 04:31:22;  author: cbaoqiu;  state: Exp;  lines: +29 -1
Changed term_size() and do_copy_term() to support attributed variables
in copy_term/2.
----------------------------
revision 1.10
date: 1999/10/26 06:47:00;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.9
date: 1999/10/25 05:58:11;  author: kifer;  state: Exp;  lines: +5 -5
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.8
date: 1999/10/12 16:18:48;  author: warren;  state: Exp;  lines: +5 -1
Fixed read_canonical to read the term into the findall chunk buffers,
so that it can check that there is enough hep memory to store the term
that was read (and call gc if not).  Modified findall (splitting it to
findall.c and findall.h) so the buffer routines can be used elsewhere.
----------------------------
revision 1.7
date: 1999/10/11 21:13:46;  author: warren;  state: Exp;  lines: +25 -63
Split findall.h off from findall.c in preparationf for using the chunk
mechanism Bart wrote to store terms before ensuring if there's enough
room on the heap to copy them there.  Will be used in read_canonical.
----------------------------
revision 1.6
date: 1999/10/09 02:00:24;  author: cbaoqiu;  state: Exp;  lines: +7 -1
Changes for attributed variables (first step).
----------------------------
revision 1.5
date: 1999/10/05 04:01:32;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.4
date: 1999/02/10 15:46:02;  author: kifer;  state: Exp;  lines: +1 -2
got rid of malloc.h
----------------------------
revision 1.3
date: 1999/02/02 17:59:20;  author: kostis;  state: Exp;  lines: +2 -2
Added missing include.
----------------------------
revision 1.2
date: 1998/12/01 17:10:38;  author: sbprolog;  state: Exp;  lines: +3 -1
These are small fixes to a couple of stack expansion bugs, mainly
in the placing of the overflow checks.

TRIM_CORE is also updated to deal with heap/local stack expansion.

-- Rui Marques
----------------------------
revision 1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.22.2.3
date: 2001/01/06 18:43:04;  author: ruim;  state: Exp;  lines: +5 -7
Initialization data made static and other small changes
----------------------------
revision 1.22.2.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.22.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +57 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.25.6.2
date: 2004/10/18 20:46:03;  author: ruim;  state: Exp;  lines: +6 -6
update for version 2.6.1
----------------------------
revision 1.25.6.1
date: 2004/09/29 19:44:14;  author: ruim;  state: Exp;  lines: +50 -27
Sources from rfm repository
----------------------------
revision 1.25.4.3
date: 2003/04/17 17:11:47;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.25.4.2
date: 2003/02/11 18:36:22;  author: lfcastro;  state: Exp;  lines: +2 -2
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.25.4.1
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +4 -4
* update to HEAD
----------------------------
revision 1.48.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.48.4.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.48.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/findall.h,v
Working file: findall.h
head: 1.10
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.10
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	release_2_6_plus_supp: 1.3.0.14
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.5
	release_3_0: 1.5
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.3.12.1
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.3.12.1
	multi-threaded-25-engine: 1.3.0.12
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.10
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.8
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.6
	release_2_4: 1.3
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.4
	pre-threading: 1.3
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.2
	subsumption: 1.2
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
declarations for findall.c
----------------------------
revision 1.10
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.9
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2005/07/06 18:29:13;  author: dwarren;  state: Exp;  lines: +15 -7
branches:  1.5.4;
FOr Multithreading: Made findall thread-safe by moving its static variables
to the thread structure.  Now each thread has its own chain of findall buffers.
----------------------------
revision 1.4
date: 2005/01/14 18:31:15;  author: ruim;  state: Exp;  lines: +2 -2
Integration of multithreaded system
----------------------------
revision 1.3
date: 1999/12/10 07:47:32;  author: kifer;  state: Exp;  lines: +36 -39
branches:  1.3.4;  1.3.12;
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.2
date: 1999/10/12 16:18:51;  author: warren;  state: Exp;  lines: +1 -4
Fixed read_canonical to read the term into the findall chunk buffers,
so that it can check that there is enough hep memory to store the term
that was read (and call gc if not).  Modified findall (splitting it to
findall.c and findall.h) so the buffer routines can be used elsewhere.
----------------------------
revision 1.1
date: 1999/10/11 21:13:49;  author: warren;  state: Exp;
Split findall.h off from findall.c in preparationf for using the chunk
mechanism Bart wrote to store terms before ensuring if there's enough
room on the heap to copy them there.  Will be used in read_canonical.
----------------------------
revision 1.3.12.1
date: 2004/09/29 19:44:14;  author: ruim;  state: Exp;  lines: +2 -2
Sources from rfm repository
----------------------------
revision 1.3.4.3
date: 2001/01/06 18:43:05;  author: ruim;  state: Exp;  lines: +2 -3
Initialization data made static and other small changes
----------------------------
revision 1.3.4.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.4.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/flag_defs.h,v
Working file: flag_defs.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.4
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.8
date: 1999/10/26 06:47:01;  author: kifer;  state: dead;  lines: +1 -1
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.7
date: 1999/10/25 05:58:12;  author: kifer;  state: Exp;  lines: +2 -2
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.6
date: 1999/10/19 20:11:46;  author: ejohnson;  state: Exp;  lines: +17 -5
Addition of variant/1 to XSB to complement subsumptive/1.
Each one changes the tabled evaluation method of the given
predicate(s).

Modified the structure of related constants to utilize the
preprocessor on the Prolog end.  The builtin which actually makes the
change in the TableInfoFrame is generalized from only making the
switch to subsumptive mode to taking an extra argument indicating the
method to use during the predicate's evaluation.
----------------------------
revision 1.5
date: 1999/10/09 18:11:34;  author: kostis;  state: Exp;  lines: +4 -5
Small cleanup change.
----------------------------
revision 1.4
date: 1999/10/08 07:32:15;  author: kifer;  state: Exp;  lines: +13 -4
added flags: --nobanner, --noprompt, --quietload
----------------------------
revision 1.3
date: 1999/08/25 13:59:19;  author: kifer;  state: Exp;  lines: +3 -3
fixed a buglet where subprocess stdout was directed to
XSB stderr.
----------------------------
revision 1.2
date: 1999/08/12 14:24:26;  author: kostis;  state: Exp;  lines: +1 -3
Changes to compile x_interp with the cpp-on option and integrate it better
with various defined constants in the emulator.
----------------------------
revision 1.1
date: 1999/08/09 00:34:21;  author: kifer;  state: Exp;
Added process control builtins, deprecated unix.P,
added C preprocessor.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/flag_defs_xsb.h,v
Working file: flag_defs_xsb.h
head: 1.50
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.36
	ROLLBACK: 1.31
	latest_plus_supp_branch: 1.31.0.2
	latest_plus_supp: 1.31
	Version_3dot2_plus_supp: 1.26.0.2
	release_2_6_plus_supp: 1.10.0.4
	Version_3dot2: 1.26
	dec07-perf-results: 1.25
	mt_thesis: 1.19
	release_3_0: 1.18
	release_2_7_0: 1.12
	multi-threaded-26-engine: 1.8.4.2
	pre-mt: 1.12
	multi-threaded-25-engine-done: 1.8.4.1
	multi-threaded-25-engine: 1.8.0.4
	release_2_6_1: 1.10
	release_2_6_final: 1.10
	release_2_6: 1.10.0.2
	last-merged-to-demand: 1.9
	demand_branch: 1.9.0.2
	before_removing_chat: 1.8
	release_2_5: 1.8
	pre-merge-slgwam-gc: 1.8
	multi-threaded-c-engine: 1.8.0.2
	release_2_4: 1.7
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.4
	pre-threading: 1.3
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 60;	selected revisions: 60
description:
----------------------------
revision 1.50
date: 2012/07/25 23:17:37;  author: tswift;  state: Exp;  lines: +2 -1

Bounded rationality for answer depth (ifdeffed out)
----------------------------
revision 1.49
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +2 -2

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.48
date: 2012/06/04 15:59:24;  author: dwarren;  state: Exp;  lines: +5 -3
Added unindexed profiling.
----------------------------
revision 1.47
date: 2012/02/24 17:37:21;  author: tswift;  state: Exp;  lines: +4 -1

abort_pre_action and friends.
----------------------------
revision 1.46
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +2 -1
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.45
date: 2011/12/24 21:09:10;  author: tswift;  state: Exp;  lines: +5 -1

Changes	for memory managemement

1) Now supporting max_memory flag for user-defined memory limits

2) Changed some	  memory errors so that rather than creating an
exception ball,	  a flag is set; the exception handler then checks
for the flag.  The reason for doing this is that allocating
memory to assert an exception ball can get us into trouble.
----------------------------
revision 1.44
date: 2011/11/12 21:23:29;  author: kifer;  state: Exp;  lines: +1 -5
removed conflict (which luckily was just in a comment, so no code was affected
----------------------------
revision 1.43
date: 2011/11/11 18:21:39;  author: dwarren;  state: Exp;  lines: +3 -2
Added flag[UNIFY_WITH_OCCURS_CHECK_FLAG] that when true causes XSB
to do all unifications with occur_check.  (Not completely tested, and
better efficiency is possible by having compiler generate different
bldval instructions when it can determine that occur-check isn't needed.)
----------------------------
revision 1.42
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +5 -5

Integrating in Call Abstraction
----------------------------
revision 1.41
date: 2011/08/24 21:58:08;  author: tswift;  state: Exp;  lines: +3 -2

Added functionality to CTRACE and added a new debugging statement.
----------------------------
revision 1.40
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +4 -2

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.39
date: 2011/06/26 21:01:13;  author: tswift;  state: Exp;  lines: +3 -2

Support for C-level trace.
----------------------------
revision 1.38
date: 2011/06/05 19:24:03;  author: tswift;  state: Exp;  lines: +10 -4



Changes to

1) Add flag-controlled answer depth checks to variant answer
tables.  (See current_prolog_flag in the manual for details).

2) In support of 1, added sprint_term, which prints a term to a C
string.  This is useful for errors and warnings invoked by C.

3) Added MAXTOINDEX_FLAG, which allows experimentation with the
depth of * indexing.

4) Increased the initial size strbuff from 1000 -> 10000.  This
reduces spurious long atom warnings.
----------------------------
revision 1.37
date: 2011/02/14 22:29:45;  author: tswift;  state: Exp;  lines: +3 -4

Added 'write' option for write_attributes.
----------------------------
revision 1.36
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +2 -2
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.35
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +2 -2
Backed out faulty changes
----------------------------
revision 1.34
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +2 -2
no message
----------------------------
revision 1.33
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +2 -2
no message
----------------------------
revision 1.32
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +2 -2
no message
----------------------------
revision 1.31
date: 2010/03/18 22:22:17;  author: tswift;  state: Exp;  lines: +5 -4
branches:  1.31.2;

Added subgoal depth check with actions of fail and error (cf pg. 165 of the manual)
----------------------------
revision 1.30
date: 2009/07/30 19:01:28;  author: tswift;  state: Exp;  lines: +4 -4


Moved flag definition of answer completion to flag_defs.h

Commented out call to answer_completion (which was also giving an
error since SCC_delayed was undefined) until Alexandre gets back from
vacation.
----------------------------
revision 1.29
date: 2009/07/24 10:08:58;  author: alexandrempinto;  state: Exp;  lines: +17 -10
Updating ANSWER_COMPLETION flag number (after updating from CVS)
----------------------------
revision 1.28
date: 2009/05/01 12:54:38;  author: tswift;  state: Exp;  lines: +2 -1


Added flag heap_margin will allows users to set	the heap gc /
overflow margin.  In those cases where XSB's memory management is
somehow not working properly, the flag gives users a possible
work-around until we fix whatever the problem is.  In many cases,
this work-arond may be easier to use than setting -m to	   some
large number.
----------------------------
revision 1.27
date: 2009/04/27 11:06:22;  author: tswift;  state: Exp;  lines: +23 -15

Forgot to add this to support write_attributes flag
----------------------------
revision 1.26
date: 2008/07/25 18:52:53;  author: tswift;  state: Exp;  lines: +7 -1
new flag for warning action.
----------------------------
revision 1.25
date: 2007/11/01 23:46:59;  author: tswift;  state: Exp;  lines: +6 -2


Added a command-line argument, --shared-predicates which, in the MT
engine makes dynamic code and tables shared by default.  If this
command-line argument is not used.  The default behavior is kept in a
flag so it can be queried, but not changed during run time.

Also, fixed a bug in dynamic as an executable directive.  ?-
dyanamic(p/n) succeeded even when p/n was static -- worse, it actually
CHANGED p/n to dynamic, working like an abolish for static predicates.
Don't know how that got in there.
----------------------------
revision 1.24
date: 2007/08/03 20:34:56;  author: tswift;  state: Exp;  lines: +3 -2

Changes to allow an override to restriction that only one thread may be active during a load.

In doing this, I refined the mutexes for syscalls so that system calls only use a mutex when using the proc table.
----------------------------
revision 1.23
date: 2007/07/12 22:53:03;  author: tswift;  state: Exp;  lines: +3 -2
Added contexts for heap overflow check functions

Added queue aliases to message_queue_create, thread_send_message, and
thread_queue_message.

Added mutex aliases for all mutex functions to make them consistent with ISO working group.

Made default maximum queue terms a changeable XSB flag.

Wrote Prolog stub for message_queue_destroy

Manual updated, and mttest suite changed.
----------------------------
revision 1.22
date: 2007/06/27 00:51:29;  author: tswift;  state: Exp;  lines: +2 -1
Minor changes for keeping max_threads as a flag.

Also, updated mttestsuite
----------------------------
revision 1.21
date: 2007/06/26 16:59:58;  author: tswift;  state: Exp;  lines: +7 -2

Now allowing modifications of default values for thread create via xsb_flag.
Altered thread create so that values can either be explicitly passed in, or obtained from flags.

Also, added usleep() as a temporary fix to a problem that I'll send out a note about.
----------------------------
revision 1.20
date: 2007/06/01 22:47:06;  author: tswift;  state: Exp;  lines: +4 -5

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.19
date: 2006/09/08 19:59:47;  author: dwarren;  state: Exp;  lines: +2 -1
Added shared stat_flag (70, STRING_GARBAGE_COLLECTION) to allow user to
turn off string garbage collection.  Added a counter that's printed in
statistics to indicate how many times string garbage collection has been called.
----------------------------
revision 1.18
date: 2006/07/08 18:49:11;  author: tswift;  state: Exp;  lines: +3 -3

Checks for private flag CLAUSE_GARBAGE_COLLECT that turns off space reclamation.  Useful for debugging.

In debug_xsb.c, wrote a Choice point stack printout routine with stuff needed for debugging clause/table gc.
----------------------------
revision 1.17
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +2 -2
Made pflags thread private
----------------------------
revision 1.16
date: 2005/08/19 12:55:08;  author: ruim;  state: Exp;  lines: +51 -49
renumbered flags (again)
----------------------------
revision 1.15
date: 2005/08/19 07:23:54;  author: ruim;  state: Exp;  lines: +64 -60
renumbered flags
----------------------------
revision 1.14
date: 2005/04/27 04:20:15;  author: evansbj;  state: Exp;  lines: +5 -4
Updated stderr and stdout redirection available via the -q parameter
----------------------------
revision 1.13
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +2 -3
Integration of multithreaded system
----------------------------
revision 1.12
date: 2004/08/24 20:41:10;  author: tswift;  state: Exp;  lines: +4 -1

This is a pre-integration of certain parts of the MT engine so that I can run the mttests
in single-threaded mode under 2.6.  This basically defines some stubs so that I can compile and so
that I dont get undefined errors, and won't affect anything anybody is doing.
----------------------------
revision 1.11
date: 2004/05/18 13:42:47;  author: tswift;  state: Exp;  lines: +3 -1
Added BACKTRACE flag
----------------------------
revision 1.10
date: 2002/10/28 14:45:07;  author: dwarren;  state: Exp;  lines: +3 -1
Multiple-argument indexing modified and extended.  Now can only do multiple-argument
indexing on arguments 1-127 (down from all 255).  The first bit of the byte
that indicates the argument to index on is now used to indicate whether to use
main functor indexing (0 as before) or "fixed-depth" indexing (1, new).  In
"fixed-depth" indexing, the first N nodes in a depth-first traversal of the term
are used for indexing.  N is a fixed global value (fixed when the XSB system is compiled,
and it is currently set to 5.)  So indexing is used if the first N nodes are nonvariable
(or if the term has fewer than N nodes, the term is ground.)  All nodes contribute to
the index.
----------------------------
revision 1.9
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +3 -1
branches:  1.9.2;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.8
date: 2001/07/16 05:15:37;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.8.4;
added USERMOD_PSC constant
----------------------------
revision 1.7
date: 2001/05/24 17:54:51;  author: lfcastro;  state: Exp;  lines: +6 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.6
date: 2001/03/28 04:17:25;  author: kifer;  state: Exp;  lines: +1 -2
deleted erroneous comment
----------------------------
revision 1.5
date: 2001/03/27 17:52:03;  author: dwarren;  state: Exp;  lines: +1 -2
Took out PSC_INT code that MK proposed but is now not needed.  Also
minor changes to pahtname to make it a little more flexible for
cygwin.  Also changed last (?) boolean to xsbBool.
----------------------------
revision 1.4
date: 2001/03/23 03:54:31;  author: kifer;  state: Exp;  lines: +15 -9
added new PSC creation interrupt. -- doesn't work yet
----------------------------
revision 1.3
date: 2000/01/11 16:53:15;  author: ejohnson;  state: Exp;  lines: +1 -11
branches:  1.3.4;
Movement of definitions from one header to another; this then required
updating #includes for some files.

Predicate evaluation method #def's moved from file flag_defs_xsb.h to
new file table_status_defs.h which houses these and other new #def's.
----------------------------
revision 1.2
date: 1999/11/16 19:05:54;  author: kifer;  state: Exp;  lines: +2 -1
Revamped sockets interface.
----------------------------
revision 1.1
date: 1999/10/26 06:47:02;  author: kifer;  state: Exp;
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.3.4.3
date: 2000/12/29 20:14:08;  author: tswift;  state: Exp;  lines: +3 -2

Flags for MT engine; this may change, and it may be better to put this
info into xsb_configuration/2, but for now...
----------------------------
revision 1.3.4.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.4.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +4 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.8.4.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +5 -1
update for version 2.6.1
----------------------------
revision 1.8.4.1
date: 2004/09/29 19:44:14;  author: ruim;  state: Exp;  lines: +6 -3
Sources from rfm repository
----------------------------
revision 1.9.2.2
date: 2003/04/17 17:11:46;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.9.2.1
date: 2002/10/28 16:49:30;  author: lfcastro;  state: Exp;  lines: +3 -1
* Merge with HEAD
----------------------------
revision 1.31.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +2 -2
no message
----------------------------
revision 1.31.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.31.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +2 -2
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/flags.h,v
Working file: flags.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.5
	release-2-0: 1.3
	pre-release-2-0: 1.2
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.6
date: 1999/10/26 06:47:03;  author: kifer;  state: dead;  lines: +1 -1
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.5
date: 1999/08/09 00:34:22;  author: kifer;  state: Exp;  lines: +2 -72
Added process control builtins, deprecated unix.P,
added C preprocessor.
----------------------------
revision 1.4
date: 1999/08/04 14:41:57;  author: ejohnson;  state: Exp;  lines: +10 -1
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.3
date: 1999/05/27 16:02:33;  author: kifer;  state: Exp;  lines: +3 -1
Added set_dcg_style/1 and related stuff to enable switching between
XSB-style DCG and Quintus, etc.
----------------------------
revision 1.2
date: 1999/02/01 23:48:17;  author: kostis;  state: Exp;  lines: +9 -7
Added flag and command line option to control type og garbage collection used.
----------------------------
revision 1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/flags_xsb.h,v
Working file: flags_xsb.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.11
	ROLLBACK: 1.6
	latest_plus_supp_branch: 1.6.0.4
	latest_plus_supp: 1.6
	Version_3dot2_plus_supp: 1.6.0.2
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.6
	dec07-perf-results: 1.6
	mt_thesis: 1.6
	release_3_0: 1.6
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.12.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.12.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 19;	selected revisions: 19
description:
----------------------------
revision 1.11
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.10
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.9
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +2 -3
branches:  1.6.4;
Made pflags thread private
----------------------------
revision 1.5
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +2 -1
made private flags array for sequential engine
----------------------------
revision 1.4
date: 2005/08/08 17:11:33;  author: dwarren;  state: Exp;  lines: +4 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.3
date: 2005/07/08 00:54:25;  author: dwarren;  state: Exp;  lines: +4 -1
Fixes to sockets for multi-threading, by Chris Rued.
----------------------------
revision 1.2
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.1
date: 1999/10/26 06:47:04;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.12;
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1.12.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.4
date: 2001/01/07 00:32:50;  author: ruim;  state: Exp;  lines: +0 -2
fixes
----------------------------
revision 1.1.4.3
date: 2001/01/06 18:43:05;  author: ruim;  state: Exp;  lines: +3 -1
Initialization data made static and other small changes
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.6.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.6.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/function.c,v
Working file: function.c
head: 1.40
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.34
	ROLLBACK: 1.26
	latest_plus_supp_branch: 1.26.0.2
	latest_plus_supp: 1.26
	Version_3dot2_plus_supp: 1.23.0.2
	release_2_6_plus_supp: 1.12.0.4
	Version_3dot2: 1.23
	dec07-perf-results: 1.20
	mt_thesis: 1.18
	release_3_0: 1.18
	release_2_7_0: 1.12
	multi-threaded-26-engine: 1.11.4.2
	pre-mt: 1.12
	multi-threaded-25-engine-done: 1.11.4.1
	multi-threaded-25-engine: 1.11.0.4
	release_2_6_1: 1.12
	release_2_6_final: 1.12
	release_2_6: 1.12.0.2
	last-merged-to-demand: 1.11
	demand_branch: 1.11.0.2
	before_removing_chat: 1.11
	release_2_5: 1.11
	pre-merge-slgwam-gc: 1.10
	multi-threaded-c-engine: 1.10.0.2
	release_2_4: 1.10
	release_2_3: 1.9
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.8
	release-2-2: 1.6
	chat-and-local: 1.6.0.2
	xsb-pre-cleanup: 1.6
	release-2-1: 1.5
	release-2-0-1: 1.5
	subsumption: 1.3
	without-attv: 1.3
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 49;	selected revisions: 49
description:
----------------------------
revision 1.40
date: 2011/12/14 22:40:26;  author: dwarren;  state: Exp;  lines: +2 -2
Added fdivreg instruction for div operation.
----------------------------
revision 1.39
date: 2011/12/12 00:07:23;  author: dwarren;  state: Exp;  lines: +8 -8
Fixed xor (and error message in memory_xsb.c)
----------------------------
revision 1.38
date: 2011/12/11 23:07:25;  author: dwarren;  state: Exp;  lines: +29 -1
A number of changes to fix bugs and make XSB more ISO compliant (from U.Neumerkel)
1. Made length/2 slightly more resiliant.
2. Added a cyclic term check in atom_codes.
3. fixed bug in call/n to non-existent predicate
4. Added new operators (for ISO): ^, div, xor (and changed ** to always return float.)
5. Added new ISO predicate names: acyclic_term, and subsumes_term.
6. Made number_codes/chars more ISO compliant (mostly on unusual inputs)
7. Increased precision of floating point numbers in write_canonical.
8. Added cputime to load message (if > 0.0 secs), desired by MK
9. Support reading and writing of 0-ary predicates in form p().  (This is not
	fully implemented and should not in general be used.)
----------------------------
revision 1.37
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +18 -44
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.36
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +5 -5
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.35
date: 2010/10/28 00:57:15;  author: dwarren;  state: Exp;  lines: +6 -1
Ifdeffed the definition of asinh out for windows, where it is not defined.
----------------------------
revision 1.34
date: 2010/09/27 18:03:30;  author: pmoura;  state: Exp;  lines: +27 -1
Implemented arithmetic functions sinh/1, cosh/1, tanh/1, asinh/1 for compatibility with Prolog compilers such as YAP and SICStus Prolog. Definitions for the arithmetic functions acosh/1 and atanh/1 are partially implemented but commented out as I have not idea how to return exceptions when the function argument is out of range.
----------------------------
revision 1.33
date: 2010/09/25 16:25:47;  author: pmoura;  state: Exp;  lines: +13 -1
Defined the arithmentic function atan/2 (butt-ugly alias atan/2 also recognized).
----------------------------
revision 1.32
date: 2010/09/25 15:59:09;  author: pmoura;  state: Exp;  lines: +12 -1
Defined the arithmentic constant epsilon/0.
----------------------------
revision 1.31
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.30
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.29
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.28
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.27
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.26
date: 2009/10/19 16:51:14;  author: dwarren;  state: Exp;  lines: +22 -2
branches:  1.26.2;
Added erf (normal error function) call in function.  (Useful for PRISM-like reasoning.)
Added psc_import_as function, which assigns the entry-point of a psc to point to the
load-address of another PSC.  Will be used for "import a from b as c" functionality,
but it's not complete yet.
----------------------------
revision 1.25
date: 2009/05/05 14:18:13;  author: dwarren;  state: Exp;  lines: +12 -1
Ifdef out the call to the lgamma function for Windows (since it's not in
their mathlib) to give warning and return 0.0.
----------------------------
revision 1.24
date: 2009/04/27 14:02:19;  author: dwarren;  state: Exp;  lines: +12 -2
Added eval function lgamma (from mathlib)
----------------------------
revision 1.23
date: 2008/02/16 18:00:42;  author: dwarren;  state: Exp;  lines: +43 -43
Add new instructions putdfloat and getdfloat to handle double floats.
Update the loader to load these instructions from the xwam files.
(There is a possible problem.  The doubles are written into the xwam
file as bitstrings, and read by the loader as the same bitstring.  If
representations on different machines are different, then xwam files
compiled on one system won't run on another.)
----------------------------
revision 1.22
date: 2008/02/04 18:51:42;  author: dwarren;  state: Exp;  lines: +292 -217
Some cleanup in the C expression evaluator:
1) Added header disclaimer stuff to function.h file.
2) Added a missing error case in ARITHPROC.
3) Improved efficiency of dispatch on operators in xsb_eval.
   (I'm looking at operator strings, meaning that they will
    be recognized as operators regardless of the module
    they're defined in.  It might be better to initialize
    the psc addresses of the symbols in usermod and dispatch
    on them.)
4) Added constants pi and e, which are defined in syslib/eval.P
   (but not in compiled is/2.  So (Pi = pi, X is Pi) compiles and
   executes, but (X is pi) does not compile: an inconsistency that
   should be fixed sometime, but it impacts a number of places in the
   compiler and I'm not up to it today.  At the same time, we might
   want to add user-defined constants (as SWI has, I believe)).
5) Probably a couple of other minor things I've forgotten.
----------------------------
revision 1.21
date: 2008/02/03 18:28:56;  author: dwarren;  state: Exp;  lines: +348 -9
Modified expression evaluation to support the recursive evaluation
of terms that represent expressions.  XSB had previously only permitted
constants.  So, for example, now clauses like
p(X,Y) :- Z = X+5, Y is Z+2.
will compile and execute to evaluate the term X+5.
At some point, a builtin should be created to call this C evaluator
and eval/2 in XSB should be modified to be that builtin.
----------------------------
revision 1.20
date: 2007/10/28 23:32:36;  author: tswift;  state: Exp;  lines: +15 -3


Added evaluable functions **/2 and sign/1, which were in the core standard.

Added an evaluable xor function ></2 which is in the revision.

Rewrote arithmetic_abort to give evaluation errors and instantiation
errors, making us a little more compliant.  We still aren't reporting
underflows or overflows, so we do deviate from the standard in this
respect.
----------------------------
revision 1.19
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.18
date: 2005/08/03 20:09:16;  author: dwarren;  state: Exp;  lines: +5 -5
Fixed the ceiling/round fixes for multi-threading.
----------------------------
revision 1.17
date: 2005/08/03 19:44:21;  author: crojo;  state: Exp;  lines: +11 -11

Corrected return type for the ceiling, truncate, and round functions. They now return integers instead of floats.
----------------------------
revision 1.16
date: 2005/07/19 14:16:59;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed problem with bld_boxedfloat with oldfloats in multithreading
----------------------------
revision 1.15
date: 2005/07/18 21:54:10;  author: crojo;  state: Exp;  lines: +78 -53
*** empty log message ***
----------------------------
revision 1.14
date: 2005/03/05 07:49:51;  author: kifer;  state: Exp;  lines: +2 -2
got rid of obvious compiler warnings
----------------------------
revision 1.13
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +3 -2
Integration of multithreaded system
----------------------------
revision 1.12
date: 2002/12/26 22:47:54;  author: tswift;  state: Exp;  lines: +3 -1
defs for min and max (used by CLP(R)
----------------------------
revision 1.11
date: 2002/01/23 17:08:08;  author: dwarren;  state: Exp;  lines: +48 -44
branches:  1.11.2;  1.11.4;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.10
date: 2001/03/16 13:20:52;  author: tswift;  state: Exp;  lines: +90 -39

Changes are to support more closely the ISO standard for evaluable
functions.  In particular I added truncate/1, ceiling/1, abs/1, and
round/1.
----------------------------
revision 1.9
date: 2000/06/28 16:54:50;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.9.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.8
date: 2000/05/20 06:56:00;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.7
date: 2000/04/29 21:53:54;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.6
date: 2000/01/07 08:51:31;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/10/26 06:47:05;  author: kifer;  state: Exp;  lines: +2 -2
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.4
date: 1999/10/25 05:58:12;  author: kifer;  state: Exp;  lines: +2 -2
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3
date: 1999/10/05 04:01:34;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.2
date: 1999/08/13 03:16:24;  author: kifer;  state: Exp;  lines: +13 -13
cleaned up a number of int -> float assignments without the cast; ifdef'ed
the definitions of min/max
----------------------------
revision 1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.11.4.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +3 -1
update for version 2.6.1
----------------------------
revision 1.11.4.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +3 -2
Sources from rfm repository
----------------------------
revision 1.11.2.1
date: 2003/04/17 17:11:46;  author: lfcastro;  state: Exp;  lines: +3 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.26.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.26.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.26.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/function.h,v
Working file: function.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	Version_3dot2: 1.2
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2008/02/04 18:51:42;  author: dwarren;  state: Exp;  lines: +29 -0
branches:  1.2.4;
Some cleanup in the C expression evaluator:
1) Added header disclaimer stuff to function.h file.
2) Added a missing error case in ARITHPROC.
3) Improved efficiency of dispatch on operators in xsb_eval.
   (I'm looking at operator strings, meaning that they will
    be recognized as operators regardless of the module
    they're defined in.  It might be better to initialize
    the psc addresses of the symbols in usermod and dispatch
    on them.)
4) Added constants pi and e, which are defined in syslib/eval.P
   (but not in compiled is/2.  So (Pi = pi, X is Pi) compiles and
   executes, but (X is pi) does not compile: an inconsistency that
   should be fixed sometime, but it impacts a number of places in the
   compiler and I'm not up to it today.  At the same time, we might
   want to add user-defined constants (as SWI has, I believe)).
5) Probably a couple of other minor things I've forgotten.
----------------------------
revision 1.1
date: 2008/02/03 21:14:41;  author: dwarren;  state: Exp;
Declarations and macros for xsb_eval.
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/gc_copy.h,v
Working file: gc_copy.h
head: 1.18
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.16
	ROLLBACK: 1.10
	latest_plus_supp_branch: 1.10.0.4
	latest_plus_supp: 1.10
	Version_3dot2_plus_supp: 1.10.0.2
	release_2_6_plus_supp: 1.5.0.6
	Version_3dot2: 1.10
	dec07-perf-results: 1.10
	mt_thesis: 1.8
	release_3_0: 1.6
	release_2_7_0: 1.5
	multi-threaded-26-engine: 1.2.2.2
	pre-mt: 1.5
	multi-threaded-25-engine-done: 1.2.2.1
	multi-threaded-25-engine: 1.2.0.2
	release_2_6_1: 1.5
	release_2_6_final: 1.5
	release_2_6: 1.5.0.4
	last-merged-to-demand: 1.5
	demand_branch: 1.5.0.2
	before_removing_chat: 1.2
	release_2_5: 1.2
keyword substitution: kv
total revisions: 23;	selected revisions: 23
description:
----------------------------
revision 1.18
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +4 -4
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.17
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +5 -5

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.16
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -20
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.15
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.14
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +20 -1
no message
----------------------------
revision 1.10
date: 2007/09/04 00:49:09;  author: dwarren;  state: Exp;  lines: +2 -4
branches:  1.10.4;
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.9
date: 2007/07/10 20:29:34;  author: dwarren;  state: Exp;  lines: +16 -1
Add heap overflow tests to copying terms out of tries.  At every
push of a structure onto the heap, it checks for overflow.  (I had been
hoping to find a way to test more rarely, but this works and the
slowdown should be pretty minimal, I think.)  The hard
part was to fix garbage collection to handle the reg_array registers
and relocate them as well.  The sliding collector passes the test suite.
The copying collector fails a few tests, but I checked and the previous
cvs version failed the same tests, so I haven't made it any worse.

Also made some minor changes to debug_xsb.c so it would at least compile
for me under cygwin.
----------------------------
revision 1.8
date: 2006/11/22 16:18:07;  author: ruim;  state: Exp;  lines: +41 -39
Fixed heap expansion and GC to allow concurrency, by
moving global variables into the thread context.

GC_PROFILE was not fixed
----------------------------
revision 1.7
date: 2006/09/02 19:27:52;  author: tswift;  state: Exp;  lines: +4 -2

Modified slide_heap() and copy_heap() by adding a new function
trail_hp_pointer_from_cell() used in the chaining portion of
slide_heap().

hp_pointer_from_cell() returns the address,tag pair if a cell points
to part of the heap.  The trail needs a special function for this
because of pre-image trailing used for handling attributed variables.
The pre-image mark is handled correctly by the garbage collectors --
information about this is set in the array gc_marks in the marking
phase so that subsequent phases deal with clean addresses.  However,
the pre-image value may be a list (or structure) that is in the
attv-interrupt vector rather than in the heap itself.  The new
function thus double-checks to see whether structures or lists are
actually in the heap.

I made a similar change of hp_pointer_from_cell() to
trail_hp_pointer_from_cell() in copy_heap() in gc_copy.h

I also added a new test to the test suite to test this situation.
----------------------------
revision 1.6
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +4 -4
Integration of multithreaded system
----------------------------
revision 1.5
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +10 -10
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.4
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +12 -15
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.3
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -117
* Removal of Chat engine
----------------------------
revision 1.2
date: 2002/02/26 18:22:07;  author: lfcastro;  state: Exp;  lines: +10 -3
branches:  1.2.2;
* Support for attributed variables
----------------------------
revision 1.1
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.2.2.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +13 -132
update for version 2.6.1
----------------------------
revision 1.2.2.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +4 -4
Sources from rfm repository
----------------------------
revision 1.10.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.10.4.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.10.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/gc_mark.h,v
Working file: gc_mark.h
head: 1.41
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.38
	ROLLBACK: 1.32
	latest_plus_supp_branch: 1.32.0.4
	latest_plus_supp: 1.32
	Version_3dot2_plus_supp: 1.32.0.2
	release_2_6_plus_supp: 1.4.0.6
	Version_3dot2: 1.32
	dec07-perf-results: 1.29
	mt_thesis: 1.23
	release_3_0: 1.18
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.3.2.2
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.3.2.1
	multi-threaded-25-engine: 1.3.0.2
	release_2_6_1: 1.4.4.1
	release_2_6_final: 1.4
	release_2_6: 1.4.0.4
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.2
	before_removing_chat: 1.3
	release_2_5: 1.3
keyword substitution: kv
total revisions: 47;	selected revisions: 47
description:
----------------------------
revision 1.41
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +4 -4
Getting Linux to Work
----------------------------
revision 1.40
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +14 -14
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.39
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +6 -6

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.38
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -10
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.37
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.36
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.35
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.34
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.33
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +10 -1
no message
----------------------------
revision 1.32
date: 2009/01/06 21:50:37;  author: dwarren;  state: Exp;  lines: +4 -2
branches:  1.32.4;
Marking (in mark_root) tries to check whether structure-tagged pointer
indeed points to a PSC pointer.  That test however would let pass non-reference
values; clearly strange.  This situation just arose (in the compiler), so I added that check.
So it may be that this is necessary, but just never arose before, or it could
be that there is another bug in constructing structure pointers that this has
uncovered.
I've generated a warning if this case arises.  This may just be kicking the
problem down the road.
----------------------------
revision 1.31
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +6 -6
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.30
date: 2008/10/16 17:57:58;  author: dwarren;  state: Exp;  lines: +5 -1
Use data field in psc-records for predicates loaded into usermod to point
to the full filename of the file from which it was loaded.  Used this to
print a warning when XSB loads code for a usermod predicate that was previously
defined from a different file.
Will look at extending current_predicate to return this information, but that
has not yet been done.
----------------------------
revision 1.29
date: 2007/11/20 19:17:20;  author: tswift;  state: Exp;  lines: +2 -1


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.28
date: 2007/09/04 00:49:09;  author: dwarren;  state: Exp;  lines: +2 -67
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.27
date: 2007/08/30 14:46:19;  author: dwarren;  state: Exp;  lines: +1 -2
Fixed bug that showed up in GC in handling of reg_array.  reg_arrayptr
was not being reset to indicate reg_array was empty, so GC tried to
relocate garbage pointers.  So this resets reg_array to empty in
all restore-state type instructions.

Also found bug in GC in that it doesn't handle heap pointers in the
attv_interrupts array correctly.  That bug is not fixed.  I think we
need to change the way attv interrupts are accumulated and eliminate
this array.  But that awaits....
----------------------------
revision 1.26
date: 2007/08/28 18:54:12;  author: dwarren;  state: Exp;  lines: +7 -6
Fixed one problem in gc, which I introduced when I added gc when in trie-code
and accounting for reg_array.  But there is still a flakey problem that
shows up in rigorous -gc testing, but doesn't seem very reproducible....
----------------------------
revision 1.25
date: 2007/07/10 20:29:34;  author: dwarren;  state: Exp;  lines: +5 -1
Add heap overflow tests to copying terms out of tries.  At every
push of a structure onto the heap, it checks for overflow.  (I had been
hoping to find a way to test more rarely, but this works and the
slowdown should be pretty minimal, I think.)  The hard
part was to fix garbage collection to handle the reg_array registers
and relocate them as well.  The sliding collector passes the test suite.
The copying collector fails a few tests, but I checked and the previous
cvs version failed the same tests, so I haven't made it any worse.

Also made some minor changes to debug_xsb.c so it would at least compile
for me under cygwin.
----------------------------
revision 1.24
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +4 -4
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.23
date: 2006/11/25 22:19:25;  author: tswift;  state: Exp;  lines: +3 -3
Updates to prevent marking strings when mulitple threads are
active.  It turned out that a couple of cases had been overlooked
which led to core dumps that were very difficult to find.
----------------------------
revision 1.22
date: 2006/11/22 16:18:07;  author: ruim;  state: Exp;  lines: +40 -49
Fixed heap expansion and GC to allow concurrency, by
moving global variables into the thread context.

GC_PROFILE was not fixed
----------------------------
revision 1.21
date: 2006/11/21 00:52:20;  author: ruim;  state: Exp;  lines: +8 -1
added lock to gc functions that use global data; however garbage collection
is not fixed as global variables values are assumed to stay the same between
builtin pred calls

added list of holes to thread table and list of threads
----------------------------
revision 1.20
date: 2006/09/08 19:59:47;  author: dwarren;  state: Exp;  lines: +6 -4
Added shared stat_flag (70, STRING_GARBAGE_COLLECTION) to allow user to
turn off string garbage collection.  Added a counter that's printed in
statistics to indicate how many times string garbage collection has been called.
----------------------------
revision 1.19
date: 2006/09/02 19:27:52;  author: tswift;  state: Exp;  lines: +85 -18

Modified slide_heap() and copy_heap() by adding a new function
trail_hp_pointer_from_cell() used in the chaining portion of
slide_heap().

hp_pointer_from_cell() returns the address,tag pair if a cell points
to part of the heap.  The trail needs a special function for this
because of pre-image trailing used for handling attributed variables.
The pre-image mark is handled correctly by the garbage collectors --
information about this is set in the array gc_marks in the marking
phase so that subsequent phases deal with clean addresses.  However,
the pre-image value may be a list (or structure) that is in the
attv-interrupt vector rather than in the heap itself.  The new
function thus double-checks to see whether structures or lists are
actually in the heap.

I made a similar change of hp_pointer_from_cell() to
trail_hp_pointer_from_cell() in copy_heap() in gc_copy.h

I also added a new test to the test suite to test this situation.
----------------------------
revision 1.18
date: 2006/04/24 19:34:14;  author: dwarren;  state: Exp;  lines: +7 -5
Added test for null prref returned, as the possibility of this happening
was pointed out by Terry.
----------------------------
revision 1.17
date: 2006/01/19 20:49:44;  author: dwarren;  state: Exp;  lines: +3 -3
Just comments changed.
----------------------------
revision 1.16
date: 2006/01/12 21:33:50;  author: tswift;  state: Exp;  lines: +4 -2
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.15
date: 2006/01/09 00:06:31;  author: tswift;  state: Exp;  lines: +12 -6
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.14
date: 2005/12/17 02:46:32;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed accumulated missing casts.  MSVC compiles it now without complaint.
----------------------------
revision 1.13
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +209 -2
Added string table garbage collection.
----------------------------
revision 1.12
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +22 -4

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.11
date: 2005/11/16 17:32:03;  author: dwarren;  state: Exp;  lines: +6 -6
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.10
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +7 -6
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.9
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +4 -4
made private flags array for sequential engine
----------------------------
revision 1.8
date: 2005/03/05 07:49:50;  author: kifer;  state: Exp;  lines: +2 -2
got rid of obvious compiler warnings
----------------------------
revision 1.7
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +10 -10
Integration of multithreaded system
----------------------------
revision 1.6
date: 2004/12/20 19:26:15;  author: dwarren;  state: Exp;  lines: +9 -5
hanged several int's to Integer's for safety.  There is more interest in
the 64-bit port, so I'd like to find the current bugs in it.  This might
be a start.
----------------------------
revision 1.5
date: 2003/07/01 14:34:14;  author: lfcastro;  state: Exp;  lines: +3 -1
* New global variable
* New builtin globalvar/1, which returns THE global variable
----------------------------
revision 1.4
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -382
branches:  1.4.4;
* Removal of Chat engine
----------------------------
revision 1.3
date: 2002/02/26 18:22:07;  author: lfcastro;  state: Exp;  lines: +11 -4
branches:  1.3.2;
* Support for attributed variables
----------------------------
revision 1.2
date: 2002/01/28 16:47:55;  author: lfcastro;  state: Exp;  lines: +4 -4
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.1
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.3.2.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +3 -382
update for version 2.6.1
----------------------------
revision 1.3.2.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +11 -11
Sources from rfm repository
----------------------------
revision 1.4.4.1
date: 2003/09/11 13:48:09;  author: tschrijvers;  state: Exp;  lines: +3 -1
Changed the emulator in the following way:
- term_new_mod/3 builtin from to copy a term
  to a term in a different module
- globalvar builtin that provides one global variable
- changed behavior of get_attributes and put_attributes:
  attribute value can be anything, not just a vector
- replace pre-unification interrupt handling of attributed variables
  to post-unification handling
----------------------------
revision 1.32.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.32.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.32.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/gc_print.h,v
Working file: gc_print.h
head: 1.17
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.14
	ROLLBACK: 1.9
	latest_plus_supp_branch: 1.9.0.4
	latest_plus_supp: 1.9
	Version_3dot2_plus_supp: 1.9.0.2
	release_2_6_plus_supp: 1.6.0.6
	Version_3dot2: 1.9
	dec07-perf-results: 1.9
	mt_thesis: 1.9
	release_3_0: 1.7
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.3.2.2
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.3.2.1
	multi-threaded-25-engine: 1.3.0.2
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.4
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.3
	release_2_5: 1.3
keyword substitution: kv
total revisions: 22;	selected revisions: 22
description:
----------------------------
revision 1.17
date: 2011/05/22 15:12:25;  author: tswift;  state: Exp;  lines: +7 -7

Changes to fix compiler warnings on various Mac configurations.
----------------------------
revision 1.16
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +5 -5

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.15
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +28 -28
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.14
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.13
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.12
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2006/11/22 16:18:07;  author: ruim;  state: Exp;  lines: +17 -27
branches:  1.9.4;
Fixed heap expansion and GC to allow concurrency, by
moving global variables into the thread context.

GC_PROFILE was not fixed
----------------------------
revision 1.8
date: 2006/11/21 00:52:20;  author: ruim;  state: Exp;  lines: +11 -1
added lock to gc functions that use global data; however garbage collection
is not fixed as global variables values are assumed to stay the same between
builtin pred calls

added list of holes to thread table and list of threads
----------------------------
revision 1.7
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +12 -12
Integration of multithreaded system
----------------------------
revision 1.6
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +6 -6
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.5
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +6 -6
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.4
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +2 -82
* Removal of Chat engine
----------------------------
revision 1.3
date: 2002/01/28 16:47:55;  author: lfcastro;  state: Exp;  lines: +3 -3
branches:  1.3.2;
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.2
date: 2001/12/17 17:26:26;  author: lfcastro;  state: Exp;  lines: +21 -21
* Modified stack dumps to be read_canonical-safe (at least for slgwam)
----------------------------
revision 1.1
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.3.2.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +7 -87
update for version 2.6.1
----------------------------
revision 1.3.2.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +12 -12
Sources from rfm repository
----------------------------
revision 1.9.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.9.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.9.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/gc_profile.h,v
Working file: gc_profile.h
head: 1.17
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.15
	ROLLBACK: 1.10
	latest_plus_supp_branch: 1.10.0.4
	latest_plus_supp: 1.10
	Version_3dot2_plus_supp: 1.10.0.2
	release_2_6_plus_supp: 1.4.0.6
	Version_3dot2: 1.10
	dec07-perf-results: 1.10
	mt_thesis: 1.10
	release_3_0: 1.9
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.2.2.2
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.2.2.1
	multi-threaded-25-engine: 1.2.0.2
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.4
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.2
	before_removing_chat: 1.2
	release_2_5: 1.2
keyword substitution: kv
total revisions: 22;	selected revisions: 22
description:
----------------------------
revision 1.17
date: 2011/05/22 16:02:21;  author: tswift;  state: Exp;  lines: +2 -2
Getting rid of (most of the) compiler warnings on Linux
----------------------------
revision 1.16
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +6 -6
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.15
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.14
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.13
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2006/09/08 19:59:47;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.10.4;
Added shared stat_flag (70, STRING_GARBAGE_COLLECTION) to allow user to
turn off string garbage collection.  Added a counter that's printed in
statistics to indicate how many times string garbage collection has been called.
----------------------------
revision 1.9
date: 2006/04/27 21:08:47;  author: tswift;  state: Exp;  lines: +3 -3

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.8
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +2 -2
Added string table garbage collection.
----------------------------
revision 1.7
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +4 -4
made private flags array for sequential engine
----------------------------
revision 1.6
date: 2005/07/05 20:21:23;  author: dwarren;  state: Exp;  lines: +2 -2
Try to make print format for gc time better.
----------------------------
revision 1.5
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.4
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +8 -8
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.3
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +5 -5
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.2
date: 2002/01/28 20:44:31;  author: lfcastro;  state: Exp;  lines: +5 -4
branches:  1.2.2;
* fixed segfault when using full GC statistics
----------------------------
revision 1.1
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.2.2.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +8 -8
update for version 2.6.1
----------------------------
revision 1.2.2.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.10.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.10.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.10.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/gc_slide.h,v
Working file: gc_slide.h
head: 1.25
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.23
	ROLLBACK: 1.17
	latest_plus_supp_branch: 1.17.0.2
	latest_plus_supp: 1.17
	Version_3dot2_plus_supp: 1.16.0.2
	release_2_6_plus_supp: 1.8.0.4
	Version_3dot2: 1.16
	dec07-perf-results: 1.15
	mt_thesis: 1.13
	release_3_0: 1.11
	release_2_7_0: 1.9
	multi-threaded-26-engine: 1.4.2.2
	pre-mt: 1.9
	multi-threaded-25-engine-done: 1.4.2.1
	multi-threaded-25-engine: 1.4.0.2
	release_2_6_1: 1.8
	release_2_6_final: 1.8
	release_2_6: 1.8.0.2
	last-merged-to-demand: 1.7
	demand_branch: 1.7.0.2
	before_removing_chat: 1.4
	release_2_5: 1.4
keyword substitution: kv
total revisions: 31;	selected revisions: 31
description:
----------------------------
revision 1.25
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +5 -5
Getting Linux to Work
----------------------------
revision 1.24
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +16 -16
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.23
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +6 -8
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.22
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.21
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.20
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.19
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +8 -6
no message
----------------------------
revision 1.17
date: 2010/04/02 16:10:52;  author: evansbj;  state: Exp;  lines: +5 -4
branches:  1.17.2;
Why do the test if your not doing to display the result?
----------------------------
revision 1.16
date: 2009/03/14 22:04:47;  author: tswift;  state: Exp;  lines: +2 -2

Very minor changes to shut up the compiler.
----------------------------
revision 1.15
date: 2007/09/04 00:49:09;  author: dwarren;  state: Exp;  lines: +2 -2
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.14
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +13 -13
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.13
date: 2006/11/22 16:18:07;  author: ruim;  state: Exp;  lines: +15 -15
Fixed heap expansion and GC to allow concurrency, by
moving global variables into the thread context.

GC_PROFILE was not fixed
----------------------------
revision 1.12
date: 2006/09/02 19:27:52;  author: tswift;  state: Exp;  lines: +5 -2

Modified slide_heap() and copy_heap() by adding a new function
trail_hp_pointer_from_cell() used in the chaining portion of
slide_heap().

hp_pointer_from_cell() returns the address,tag pair if a cell points
to part of the heap.  The trail needs a special function for this
because of pre-image trailing used for handling attributed variables.
The pre-image mark is handled correctly by the garbage collectors --
information about this is set in the array gc_marks in the marking
phase so that subsequent phases deal with clean addresses.  However,
the pre-image value may be a list (or structure) that is in the
attv-interrupt vector rather than in the heap itself.  The new
function thus double-checks to see whether structures or lists are
actually in the heap.

I made a similar change of hp_pointer_from_cell() to
trail_hp_pointer_from_cell() in copy_heap() in gc_copy.h

I also added a new test to the test suite to test this situation.
----------------------------
revision 1.11
date: 2006/07/02 18:36:29;  author: tswift;  state: Exp;  lines: +11 -3
builtin.c and cinterf.h -- change for MT engine

gc_slide: small changes in documentation.
----------------------------
revision 1.10
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +2 -2
made private flags array for sequential engine
----------------------------
revision 1.9
date: 2004/12/20 19:26:15;  author: dwarren;  state: Exp;  lines: +5 -5
hanged several int's to Integer's for safety.  There is more interest in
the 64-bit port, so I'd like to find the current bugs in it.  This might
be a start.
----------------------------
revision 1.8
date: 2003/03/19 16:45:58;  author: lfcastro;  state: Exp;  lines: +6 -1
* Small bugfix
  - fixes random segfaults on Windows when compiling Prolog files
----------------------------
revision 1.7
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +5 -5
branches:  1.7.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.6
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +4 -4
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.5
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -176
* Removal of Chat engine
----------------------------
revision 1.4
date: 2002/02/26 18:22:07;  author: lfcastro;  state: Exp;  lines: +16 -2
branches:  1.4.2;
* Support for attributed variables
----------------------------
revision 1.3
date: 2002/02/21 16:57:56;  author: lfcastro;  state: Exp;  lines: +2 -2
* Support for compiling with SimpleScalar/PISA
* Some fixes wrt boxed integers
----------------------------
revision 1.2
date: 2002/01/28 16:47:56;  author: lfcastro;  state: Exp;  lines: +3 -1
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.1
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.4.2.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +10 -180
update for version 2.6.1
----------------------------
revision 1.4.2.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.7.2.1
date: 2003/04/17 17:11:46;  author: lfcastro;  state: Exp;  lines: +6 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.17.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.17.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.17.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/hash.c,v
Working file: hash.c
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1999/10/25 05:58:14;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/hash.h,v
Working file: hash.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1999/10/25 05:58:15;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/hash_xsb.c,v
Working file: hash_xsb.c
head: 1.27
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.23
	ROLLBACK: 1.18
	latest_plus_supp_branch: 1.18.0.4
	latest_plus_supp: 1.18
	Version_3dot2_plus_supp: 1.18.0.2
	release_2_6_plus_supp: 1.7.0.4
	Version_3dot2: 1.18
	dec07-perf-results: 1.17
	mt_thesis: 1.15
	release_3_0: 1.15
	release_2_7_0: 1.8
	multi-threaded-26-engine: 1.5.6.2
	pre-mt: 1.8
	multi-threaded-25-engine-done: 1.5.6.1
	multi-threaded-25-engine: 1.5.0.6
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.2
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.4
	release_2_4: 1.5
	release_2_3: 1.5
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.4
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 36;	selected revisions: 36
description:
----------------------------
revision 1.27
date: 2011/05/22 16:02:22;  author: tswift;  state: Exp;  lines: +15 -15
Getting rid of (most of the) compiler warnings on Linux
----------------------------
revision 1.26
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +5 -5

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.25
date: 2011/05/19 15:05:05;  author: tswift;  state: Exp;  lines: +2 -1

Fixes to recompile XSB on Mac.
----------------------------
revision 1.24
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +11 -11
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.23
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.22
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.21
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.20
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.19
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2009/01/15 22:43:05;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.18.4;
One more example of incorrect release size, this time when expanding
the string hash table.  Now for the cases I tested, all blocks are freed
with the same length that they were allocated.  There is still some
discrepancy with the amount of table space claimed as allocated in statistics
and the amount of space obtained for table_space through mem_alloc (and
friends.)  That remains to be accounted for.
----------------------------
revision 1.17
date: 2007/10/07 17:37:54;  author: tswift;  state: Exp;  lines: +2 -2

Two sets of changes.

First, was to add const declaration modifiers to external ctop and
ptoc routines.  Apparently some C++ compilers can benefit from this
modifier, and it should help the Parma polyhedra group and others who
call XSB from C++.

The second change supports call_cleanup, and fixes a minor bug in the
implementation of catch (see the emails on the XSB group).  This
update does not handle cutting over call cleanup -- I'll try to get
that in soon.
----------------------------
revision 1.16
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.15
date: 2005/12/22 23:33:56;  author: tswift;  state: Exp;  lines: +4 -4

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.14
date: 2005/12/17 02:46:32;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed accumulated missing casts.  MSVC compiles it now without complaint.
----------------------------
revision 1.13
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +38 -2
Added string table garbage collection.
----------------------------
revision 1.12
date: 2005/12/12 00:19:12;  author: tswift;  state: Exp;  lines: +10 -2

Mutexed socket calls which dont seem to be mutexed.  Also added a
mutex around some rarely used string/symbol table statistics.

Other than that, documentation.
----------------------------
revision 1.11
date: 2005/11/20 21:23:26;  author: dwarren;  state: Exp;  lines: +8 -6
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.10
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +5 -5
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.9
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +6 -5
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.8
date: 2004/12/10 22:03:49;  author: tswift;  state: Exp;  lines: +5 -5

Just a small change to the output for string table statistics.
----------------------------
revision 1.7
date: 2002/08/28 19:25:47;  author: lfcastro;  state: Exp;  lines: +36 -11
* CHANGED hash function to hash on first 250 characters (instead of
  25), which provides a much better (initial, at least) distribution.
----------------------------
revision 1.6
date: 2002/03/27 06:47:32;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.6.2;
typo fix
----------------------------
revision 1.5
date: 2000/06/28 16:54:51;  author: ruim;  state: Exp;  lines: +4 -4
branches:  1.5.2;  1.5.6;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.4
date: 2000/05/20 06:56:01;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.3
date: 2000/01/07 08:51:32;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.2
date: 1999/10/26 06:47:06;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:58:17;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5.6.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +37 -12
update for version 2.6.1
----------------------------
revision 1.5.6.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.6.2.2
date: 2003/04/17 17:11:45;  author: lfcastro;  state: Exp;  lines: +24 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.6.2.1
date: 2002/08/29 14:17:13;  author: lfcastro;  state: Exp;  lines: +13 -11
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.18.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.18.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.18.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/hash_xsb.h,v
Working file: hash_xsb.h
head: 1.12
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.2.0.6
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.1.8.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.1.8.1
	multi-threaded-25-engine: 1.1.0.8
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.4
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.2
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 19;	selected revisions: 19
description:
----------------------------
revision 1.12
date: 2011/05/22 16:02:22;  author: tswift;  state: Exp;  lines: +3 -3
Getting rid of (most of the) compiler warnings on Linux
----------------------------
revision 1.11
date: 2011/05/19 15:05:05;  author: tswift;  state: Exp;  lines: +4 -3

Fixes to recompile XSB on Mac.
----------------------------
revision 1.10
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +5 -5
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.9
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2007/10/07 17:37:54;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.4.4;

Two sets of changes.

First, was to add const declaration modifiers to external ctop and
ptoc routines.  Apparently some C++ compilers can benefit from this
modifier, and it should help the Parma polyhedra group and others who
call XSB from C++.

The second change supports call_cleanup, and fixes a minor bug in the
implementation of catch (see the emails on the XSB group).  This
update does not handle cutting over call cleanup -- I'll try to get
that in soon.
----------------------------
revision 1.3
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.2
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +2 -2
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.1
date: 1999/10/25 05:58:18;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.8;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.8.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +2 -2
update for version 2.6.1
----------------------------
revision 1.1.8.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:08;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/hashtable.c,v
Working file: hashtable.c
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.7
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2006/10/13 20:58:42;  author: dwarren;  state: Exp;  lines: +20 -3
branches:  1.3.4;
All changes for incremental table maintenance:
1. Added filter in call to get changed_goals, so can avoid building huge
   lists of goals that subsequently get ignored.
2. Freed hashtables used in incr when doing abolish all tables.  Closes
   a potentially bad memory leak.
3. Eliminated freekey's call to mem_dealloc.  Turns out we are not allocating
   space for keys at all in hashtables...
----------------------------
revision 1.2
date: 2006/10/06 20:04:28;  author: dwarren;  state: Exp;  lines: +27 -16
Updated memory management in hashtable (which manages hashing for incremental
table maintenance.)  It now uses XSB mem_alloc and friends, and there is a new
space type of INCR_TABLE_SPACE.  It is included in SLG Table space in statistics
and is also broken out (if nonzero).
And doing that showed a huge amount of unused space due to many large hashtables
when there's only one edge.  So I changed the minimum size of initial hashtables
(they are automatically expanded if necessary.)  [It reduced incr space usage in
my DSS example from about 340M to 8M... much!! better.]
----------------------------
revision 1.1
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;
Incremental Code Added.
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/hashtable.h,v
Working file: hashtable.h
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.5
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.4
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.2
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.5
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;
branches:  1.1.4;
Incremental Code Added.
----------------------------
revision 1.1.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/hashtable_itr.c,v
Working file: hashtable_itr.c
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.6
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2006/10/06 20:04:28;  author: dwarren;  state: Exp;  lines: +7 -2
branches:  1.2.4;
Updated memory management in hashtable (which manages hashing for incremental
table maintenance.)  It now uses XSB mem_alloc and friends, and there is a new
space type of INCR_TABLE_SPACE.  It is included in SLG Table space in statistics
and is also broken out (if nonzero).
And doing that showed a huge amount of unused space due to many large hashtables
when there's only one edge.  So I changed the minimum size of initial hashtables
(they are automatically expanded if necessary.)  [It reduced incr space usage in
my DSS example from about 340M to 8M... much!! better.]
----------------------------
revision 1.1
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;
Incremental Code Added.
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/hashtable_itr.h,v
Working file: hashtable_itr.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.1
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.7
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +5 -5
Dipti's code for support graph added
----------------------------
revision 1.2
date: 2007/03/21 15:16:56;  author: dwarren;  state: Exp;  lines: +1 -1
branches:  1.2.4;
Comment out an unneeded include (for inline, which is not being used
any more.)  Quiets a complaining compiler.
----------------------------
revision 1.1
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;
Incremental Code Added.
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +5 -5
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/hashtable_private.h,v
Working file: hashtable_private.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.7
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2006/10/13 20:58:42;  author: dwarren;  state: Exp;  lines: +4 -6
branches:  1.3.4;
All changes for incremental table maintenance:
1. Added filter in call to get changed_goals, so can avoid building huge
   lists of goals that subsequently get ignored.
2. Freed hashtables used in incr when doing abolish all tables.  Closes
   a potentially bad memory leak.
3. Eliminated freekey's call to mem_dealloc.  Turns out we are not allocating
   space for keys at all in hashtables...
----------------------------
revision 1.2
date: 2006/10/06 20:04:28;  author: dwarren;  state: Exp;  lines: +5 -1
Updated memory management in hashtable (which manages hashing for incremental
table maintenance.)  It now uses XSB mem_alloc and friends, and there is a new
space type of INCR_TABLE_SPACE.  It is included in SLG Table space in statistics
and is also broken out (if nonzero).
And doing that showed a huge amount of unused space due to many large hashtables
when there's only one edge.  So I changed the minimum size of initial hashtables
(they are automatically expanded if necessary.)  [It reduced incr space usage in
my DSS example from about 340M to 8M... much!! better.]
----------------------------
revision 1.1
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;
Incremental Code Added.
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/hashtable_xsb.c,v
Working file: hashtable_xsb.c
head: 1.19
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.19
	ROLLBACK: 1.14
	latest_plus_supp_branch: 1.14.0.2
	latest_plus_supp: 1.14
	Version_3dot2_plus_supp: 1.13.0.2
	release_2_6_plus_supp: 1.4.0.6
	Version_3dot2: 1.13
	dec07-perf-results: 1.12
	mt_thesis: 1.10
	release_3_0: 1.10
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.6.2.1
	pre-mt: 1.6
	multi-threaded-25-engine: 1.6.0.2
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.4
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.2
keyword substitution: kv
total revisions: 23;	selected revisions: 23
description:
----------------------------
revision 1.19
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.18
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.17
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.14.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.13
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +1 -5
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.12
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.11
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +7 -7
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.10
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +31 -1
Added string table garbage collection.
----------------------------
revision 1.9
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +7 -7
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.8
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +15 -7
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.7
date: 2005/09/16 00:56:41;  author: tswift;  state: Exp;  lines: +1 -2

Changes to make the storage module, which allows backtrackable updates, thread safe.  Storage "objects" (named interned tries) are private to each thread.
----------------------------
revision 1.6
date: 2004/09/30 14:54:45;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.6.2;
A couple of minor changes to clean code and reduce warnings of 64-bit compiler.
----------------------------
revision 1.5
date: 2004/07/07 22:31:14;  author: dwarren;  state: Exp;  lines: +2 -1
Add a couple of includes to declare necessary symbols, as suggested by a user.
----------------------------
revision 1.4
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +8 -8
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.3
date: 2002/05/22 15:41:13;  author: lfcastro;  state: Exp;  lines: +12 -15
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.2
date: 2002/04/02 06:31:10;  author: kifer;  state: Exp;  lines: +40 -4
fixed bug in deletion from hash table
----------------------------
revision 1.1
date: 2002/03/17 10:37:50;  author: kifer;  state: Exp;
better implementation with a general purpose hashtable ADT
----------------------------
revision 1.6.2.1
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +2 -3
update for version 2.6.1
----------------------------
revision 1.14.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.14.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.14.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/hashtable_xsb.h,v
Working file: hashtable_xsb.h
head: 1.10
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.10
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	release_2_6_plus_supp: 1.2.0.8
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.6.1
	pre-mt: 1.2
	multi-threaded-25-engine: 1.2.0.6
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.4
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.2
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.10
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.9
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +1 -5
branches:  1.5.4;
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.4
date: 2005/09/16 00:56:41;  author: tswift;  state: Exp;  lines: +3 -3

Changes to make the storage module, which allows backtrackable updates, thread safe.  Storage "objects" (named interned tries) are private to each thread.
----------------------------
revision 1.3
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.2
date: 2002/04/02 06:31:10;  author: kifer;  state: Exp;  lines: +23 -0
branches:  1.2.6;
fixed bug in deletion from hash table
----------------------------
revision 1.1
date: 2002/03/17 10:37:50;  author: kifer;  state: Exp;
better implementation with a general purpose hashtable ADT
----------------------------
revision 1.2.6.1
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +1 -1
update for version 2.6.1
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/heap.c,v
Working file: heap.c
head: 1.27
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.26
	without-attv: 1.25
	release-2-0: 1.17
	pre-release-2-0: 1.17
	v1-9-8: 1.10
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.3
	r1-9-b6: 1.2
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 28;	selected revisions: 28
description:
----------------------------
revision 1.27
date: 1999/10/25 05:58:20;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.26
date: 1999/10/09 02:00:25;  author: cbaoqiu;  state: Exp;  lines: +9 -1
Changes for attributed variables (first step).
----------------------------
revision 1.25
date: 1999/10/05 04:01:36;  author: kifer;  state: Exp;  lines: +3 -3
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.24
date: 1999/09/23 14:10:26;  author: kostis;  state: Exp;  lines: +6 -3
Fixed problem in relocation of heap/local stack.
----------------------------
revision 1.23
date: 1999/09/21 11:11:41;  author: kostis;  state: Exp;  lines: +3 -4
Changes to better maintain invariants in the completion stack.
----------------------------
revision 1.22
date: 1999/09/20 12:08:07;  author: kostis;  state: Exp;  lines: +4 -4
Small change to help debugging.
----------------------------
revision 1.21
date: 1999/08/16 07:24:15;  author: kifer;  state: Exp;  lines: +48 -48
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.20
date: 1999/07/22 21:58:19;  author: kifer;  state: Exp;  lines: +6 -6
Incorporated Joshua Engel's changes to get XSB work as a DLL.
In heap.c, got rid of compiler warnings.
----------------------------
revision 1.19
date: 1999/07/22 19:09:15;  author: kifer;  state: Exp;  lines: +13 -6
Got rid of compiler warnings.
----------------------------
revision 1.18
date: 1999/07/06 16:35:10;  author: ejohnson;  state: Exp;  lines: +2 -2
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.17
date: 1999/04/16 16:42:02;  author: unova;  state: Exp;  lines: +4 -4
Correction to the previous change
----------------------------
revision 1.16
date: 1999/04/16 16:14:33;  author: unova;  state: Exp;  lines: +20 -20
Changed types in printf for 64 bits portability.
----------------------------
revision 1.15
date: 1999/04/13 14:03:24;  author: kostis;  state: Exp;  lines: +11 -16
Minor improvement.
----------------------------
revision 1.14
date: 1999/03/04 17:47:00;  author: kostis;  state: Exp;  lines: +3 -4
Changes to have heap expansion independently of engine and to fix a
bug in the expansion of heap on the SLG-WAM.
----------------------------
revision 1.13
date: 1999/02/25 15:01:31;  author: kostis;  state: Exp;  lines: +62 -75
Changes for sliding garbage collection made default.
----------------------------
revision 1.12
date: 1999/02/24 13:35:52;  author: kostis;  state: Exp;  lines: +6 -3
Some debugging messages ifdefed out.
----------------------------
revision 1.11
date: 1999/02/23 10:50:44;  author: kostis;  state: Exp;  lines: +234 -207
Changes to tag number of substitution factor variables in the CP stack and
to considerably speed up garbage collection - many changes in heap.c.
----------------------------
revision 1.10
date: 1999/02/10 23:16:28;  author: kostis;  state: Exp;  lines: +29 -15
Added some debugging stuff.
----------------------------
revision 1.9
date: 1999/02/10 15:46:05;  author: kifer;  state: Exp;  lines: +1 -2
got rid of malloc.h
----------------------------
revision 1.8
date: 1999/02/05 16:07:00;  author: kostis;  state: Exp;  lines: +120 -59
Fixed memory relocation problems and cleaned up some garbage collection
related stuff.
----------------------------
revision 1.7
date: 1999/02/01 23:56:01;  author: kostis;  state: Exp;  lines: +601 -524
Changes for a first cut of a working heap garbage collector.
----------------------------
revision 1.6
date: 1999/01/17 14:56:16;  author: kostis;  state: Exp;  lines: +281 -248
Some small changes for statistics and for hooking up garbage collection.
----------------------------
revision 1.5
date: 1999/01/13 18:19:05;  author: kostis;  state: Exp;  lines: +14 -24
Changes related to printing of WAM stacks.  Corresponding predicates made
builtins and added in machine.P.
----------------------------
revision 1.4
date: 1998/12/21 01:08:18;  author: cbaoqiu;  state: Exp;  lines: +1529 -310
Kostis' changes for GC and CHAT.
----------------------------
revision 1.3
date: 1998/12/01 17:10:36;  author: sbprolog;  state: Exp;  lines: +12 -2
These are small fixes to a couple of stack expansion bugs, mainly
in the placing of the overflow checks.

TRIM_CORE is also updated to deal with heap/local stack expansion.

-- Rui Marques
----------------------------
revision 1.2
date: 1998/11/13 02:49:03;  author: kifer;  state: Exp;  lines: +3 -1
Modifications for porting to NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:16;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/heap.h,v
Working file: heap.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.7
	without-attv: 1.7
	release-2-0: 1.7
	pre-release-2-0: 1.7
	v1-9-8: 1.6
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.8
date: 1999/10/25 05:58:23;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.7
date: 1999/04/13 14:03:26;  author: kostis;  state: Exp;  lines: +2 -1
Minor improvement.
----------------------------
revision 1.6
date: 1999/02/05 16:07:03;  author: kostis;  state: Exp;  lines: +2 -2
Fixed memory relocation problems and cleaned up some garbage collection
related stuff.
----------------------------
revision 1.5
date: 1999/02/01 23:56:03;  author: kostis;  state: Exp;  lines: +8 -2
Changes for a first cut of a working heap garbage collector.
----------------------------
revision 1.4
date: 1999/01/23 17:41:37;  author: kostis;  state: Exp;  lines: +2 -2
Really minor cleanup.
----------------------------
revision 1.3
date: 1999/01/13 18:19:07;  author: kostis;  state: Exp;  lines: +3 -3
Changes related to printing of WAM stacks.  Corresponding predicates made
builtins and added in machine.P.
----------------------------
revision 1.2
date: 1998/12/21 01:08:21;  author: cbaoqiu;  state: Exp;  lines: +16 -1
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/heap_defs_xsb.h,v
Working file: heap_defs_xsb.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.11
	ROLLBACK: 1.6
	latest_plus_supp_branch: 1.6.0.4
	latest_plus_supp: 1.6
	Version_3dot2_plus_supp: 1.6.0.2
	release_2_6_plus_supp: 1.2.0.10
	Version_3dot2: 1.6
	dec07-perf-results: 1.6
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.8.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.8.1
	multi-threaded-25-engine: 1.2.0.8
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.6
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.4
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.2
	release_2_4: 1.2
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
----------------------------
revision 1.11
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.10
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.9
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2007/06/06 21:26:26;  author: dwarren;  state: Exp;  lines: +1 -1
branches:  1.6.4;
Improve (very slightly) an error message to make it easier to read.
----------------------------
revision 1.5
date: 2007/06/01 22:47:06;  author: tswift;  state: Exp;  lines: +5 -1

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.4
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +28 -1
Added string table garbage collection.
----------------------------
revision 1.3
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.2
date: 2001/05/24 17:54:51;  author: lfcastro;  state: Exp;  lines: +5 -4
branches:  1.2.8;
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.1
date: 1999/12/19 15:33:04;  author: kostis;  state: Exp;
branches:  1.1.4;
Added garbage_collection/1 predicate for choosing the type of garbage
collection strategy on the fly.  Also, some minor cleanup changes.
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.2.8.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.6.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.6.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/heap_xsb.c,v
Working file: heap_xsb.c
head: 1.89
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.84
	ROLLBACK: 1.78
	latest_plus_supp_branch: 1.78.0.2
	latest_plus_supp: 1.78
	Version_3dot2_plus_supp: 1.75.0.2
	release_2_6_plus_supp: 1.35.0.6
	Version_3dot2: 1.75
	dec07-perf-results: 1.67
	mt_thesis: 1.57
	release_3_0: 1.52
	release_2_7_0: 1.41
	multi-threaded-26-engine: 1.32.2.2
	pre-mt: 1.41
	multi-threaded-25-engine-done: 1.32.2.1
	multi-threaded-25-engine: 1.32.0.2
	release_2_6_1: 1.35.4.1
	release_2_6_final: 1.35
	release_2_6: 1.35.0.4
	last-merged-to-demand: 1.35
	demand_branch: 1.35.0.2
	before_removing_chat: 1.32
	release_2_5: 1.32
	pre-merge-slgwam-gc: 1.27
	multi-threaded-c-engine: 1.27.0.2
	release_2_4: 1.27
	release_2_3: 1.20
	multi-threaded-engine: 1.18.0.2
	pre-threading: 1.16
	release-2-2: 1.13
	chat-and-local: 1.10.0.2
	xsb-pre-cleanup: 1.10
	release-2-1: 1.4
	release-2-0-1: 1.4
keyword substitution: kv
total revisions: 101;	selected revisions: 101
description:
----------------------------
revision 1.89
date: 2011/12/24 21:09:10;  author: tswift;  state: Exp;  lines: +14 -5

Changes	for memory managemement

1) Now supporting max_memory flag for user-defined memory limits

2) Changed some	  memory errors so that rather than creating an
exception ball,	  a flag is set; the exception handler then checks
for the flag.  The reason for doing this is that allocating
memory to assert an exception ball can get us into trouble.
----------------------------
revision 1.88
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +2 -2

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.87
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +5 -5
Getting Linux to Work
----------------------------
revision 1.86
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +44 -44
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.85
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +16 -16

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.84
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +30 -43
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.83
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.82
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.81
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.80
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.79
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +43 -30
no message
----------------------------
revision 1.78
date: 2010/05/02 05:11:26;  author: evansbj;  state: Exp;  lines: +3 -3
branches:  1.78.2;
Update to make thread_exit/1, and xsb_kill_thread work from the C interface. It passes the regression tests as well as before, better actually.
----------------------------
revision 1.77
date: 2010/04/02 16:34:56;  author: evansbj;  state: Exp;  lines: +3 -1
I think for most C compilers this would cause a strange subtle bug that disappears when DEBUG_VERBOSE is turned on. With DEBUG_VERBOSE off the xsb_dbgmsg line disappears and the 'if' applies to whatever the next line is after the C preprocessor is done...
----------------------------
revision 1.76
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +7 -7

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.75
date: 2009/02/04 16:17:19;  author: dwarren;  state: Exp;  lines: +2 -2
Modified slightly when to force string_gc, so that instead of forcing
string GC whenevery the string space expands 4-fold, to do it only if
the assert space isn't also expanding.  Was finding that for large loads,
unnecessary string GC's were taking half the load time...
----------------------------
revision 1.74
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +3 -3
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.73
date: 2008/10/15 16:41:53;  author: dwarren;  state: Exp;  lines: +4 -1
Extended xsb_profiling to include counts for time in garbage collection.
(This info could be gotten, approximately, from statistics, but it is
nice to see it directly in the profile_call dump.)
----------------------------
revision 1.72
date: 2008/09/15 18:47:46;  author: dwarren;  state: Exp;  lines: +4 -4
Minor change in when string (or atom) garbage collection is triggered.
Keeps it from being called too often.
(Also minor changes in emuloop print tracing, usu (and now) commented out.)
----------------------------
revision 1.71
date: 2008/08/20 19:47:57;  author: tswift;  state: Exp;  lines: +14 -3


A change to stack reallocation from last January uncovered a bug
in Call subsumption, which copied the substitution factor from
the CPS to the heap.  Because of this, it is necessary to reset
pointers from the heap every time the glstack is reallocated,
regardless of whether the heap itself is moved.  So this change
revises the code to always reset heap pointers upon glstack
realloc.  See the documentation in tables.c to see why this is a
safe solution and the heap Substitution factor does not cause
other problems.

This fixes some core dumps in call subsumption.  The bug
exhibited itself on Linux and the Mac for a particular test
program, but the bug could show up anywhere.

Change in trace_xsb.c to fix table operation counts for the MT
engine.
----------------------------
revision 1.70
date: 2008/08/04 16:04:17;  author: dwarren;  state: Exp;  lines: +6 -1
Add a check that there is enough heap space for garbage collection extras, and
give message and exit if not.  (At least tells user the problem better than crash...)
----------------------------
revision 1.69
date: 2008/01/21 18:07:29;  author: dwarren;  state: Exp;  lines: +53 -31
Modify glstack_realloc to support shrinking of the heap-local stack space.
This allows trimcore to reduce the amount of space used for these stacks.
----------------------------
revision 1.68
date: 2008/01/02 19:47:42;  author: dwarren;  state: Exp;  lines: +6 -2
Fix (or at least greatly improve) the C-calling-XSB (recursively) interface for
the multi-threaded engine.  There is still an issue with multiple calls of
different C threads, but sharing the same th-context.  But I think the problem
is in more than just this interface.
----------------------------
revision 1.67
date: 2007/10/22 16:16:24;  author: dwarren;  state: Exp;  lines: +9 -7
Add check for large string space growth in test_heap, so string space
is garbage collected, even if there is no potential heap overflow.
----------------------------
revision 1.66
date: 2007/09/04 00:49:09;  author: dwarren;  state: Exp;  lines: +1 -23
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.65
date: 2007/08/30 19:19:18;  author: dwarren;  state: Exp;  lines: +4 -1
Added just a comment on what I'm pretty sure is a bug in heap/local stack expansion
when there are attv interrupts pending.  For future, to avoid rediscovering it....
----------------------------
revision 1.64
date: 2007/08/30 14:46:19;  author: dwarren;  state: Exp;  lines: +9 -1
Fixed bug that showed up in GC in handling of reg_array.  reg_arrayptr
was not being reset to indicate reg_array was empty, so GC tried to
relocate garbage pointers.  So this resets reg_array to empty in
all restore-state type instructions.

Also found bug in GC in that it doesn't handle heap pointers in the
attv_interrupts array correctly.  That bug is not fixed.  I think we
need to change the way attv interrupts are accumulated and eliminate
this array.  But that awaits....
----------------------------
revision 1.63
date: 2007/08/28 18:54:12;  author: dwarren;  state: Exp;  lines: +18 -12
Fixed one problem in gc, which I introduced when I added gc when in trie-code
and accounting for reg_array.  But there is still a flakey problem that
shows up in rigorous -gc testing, but doesn't seem very reproducible....
----------------------------
revision 1.62
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.61
date: 2007/07/12 14:38:02;  author: dwarren;  state: Exp;  lines: +13 -8
Added heap overflow tests for copying terms out of tries from leaf to root.
This is done when returning answers from non-completed tables or when calling
interned with the leaf address bound.
----------------------------
revision 1.60
date: 2007/07/10 20:29:34;  author: dwarren;  state: Exp;  lines: +21 -3
Add heap overflow tests to copying terms out of tries.  At every
push of a structure onto the heap, it checks for overflow.  (I had been
hoping to find a way to test more rarely, but this works and the
slowdown should be pretty minimal, I think.)  The hard
part was to fix garbage collection to handle the reg_array registers
and relocate them as well.  The sliding collector passes the test suite.
The copying collector fails a few tests, but I checked and the previous
cvs version failed the same tests, so I haven't made it any worse.

Also made some minor changes to debug_xsb.c so it would at least compile
for me under cygwin.
----------------------------
revision 1.59
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +2 -3

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.58
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +3 -3
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.57
date: 2006/11/22 16:18:07;  author: ruim;  state: Exp;  lines: +8 -12
Fixed heap expansion and GC to allow concurrency, by
moving global variables into the thread context.

GC_PROFILE was not fixed
----------------------------
revision 1.56
date: 2006/11/04 00:52:59;  author: ruim;  state: Exp;  lines: +2 -2
Changed minimum pthread stack size to 512 K
Minimum pthread stack size in Linux was previously 10 M,
clearly an exageration
mttest suite breaks with a stack size of 64 K, passes with 128 K
took out some compilation warnings
----------------------------
revision 1.55
date: 2006/09/22 23:41:26;  author: tswift;  state: Exp;  lines: +13 -1
Fixes to get clean run of testsuite under Valgrind for uential
engine.  Most of these were inconsequential and were easily
fixed.  One was non-trivial and exposed an obscure memory bug.

On line 304 of heap_xsb.c is the statement

  ls_top = top_of_localstk - 256;  /* extra space for environment above top */ \

I believe that David put this in a few months ago to fix a
problem with not copying over the topmost local stack environment
when reallocating the global and local stacks.  It fixed some
memory problems, and made XSB a bit more stable.

Since the same definition of ls_top is used for garbage
collecting, 256 uninitialized variables could be encountered
during GC, which could lead to problems.  In addition it is not
impossible that other C functions create "holes" in the heap (I
suspect build_delay_list() in residual.c but could be wrong on
that).  If these holes contain uninitialized cells, we could get
core dumps on GC.

My solution is to initialize cells in the glstack at init time,
and to initialize cells *between* the top of local stack and top
of heap at realloc time.

This hypothesis may seem obscure, but I've been chasing down bugs
the last few weekends that dont seem much more obscure than
this :-)

In addition, we're now set up so that we can rerun Valgrind to
find memory bugs after large changes to XSB.
----------------------------
revision 1.54
date: 2006/09/20 13:52:38;  author: tswift;  state: Exp;  lines: +4 -3

Minor documentation change, but I wanted to get in synch.
----------------------------
revision 1.53
date: 2006/09/08 19:59:47;  author: dwarren;  state: Exp;  lines: +4 -1
Added shared stat_flag (70, STRING_GARBAGE_COLLECTION) to allow user to
turn off string garbage collection.  Added a counter that's printed in
statistics to indicate how many times string garbage collection has been called.
----------------------------
revision 1.52
date: 2006/06/21 20:17:11;  author: dwarren;  state: Exp;  lines: +1 -1
Add (well, subtract) fudge factor to top of local stack when doing gl stack
expanding.  It's possible that a local environment is above the computed
top_of_lstack, and if something in that environment is needed, there can be
a problem.  It showed up in the compiler (compiling ora_call), when atom_codes
was called, and it expanded the glstack, and where it was to put its answer
was in the local environment on the top of the local stack.  That wasn't
shifted so it was getting a 0 and a segfault.
----------------------------
revision 1.51
date: 2006/04/27 21:08:47;  author: tswift;  state: Exp;  lines: +4 -2

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.50
date: 2006/01/19 20:49:45;  author: dwarren;  state: Exp;  lines: +6 -2
Just comments changed.
----------------------------
revision 1.49
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +96 -25
Added string table garbage collection.
----------------------------
revision 1.48
date: 2005/11/20 21:23:27;  author: dwarren;  state: Exp;  lines: +35 -1
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.47
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +13 -13
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.46
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +15 -13
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.45
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +7 -7
made private flags array for sequential engine
----------------------------
revision 1.44
date: 2005/03/05 07:49:50;  author: kifer;  state: Exp;  lines: +5 -5
got rid of obvious compiler warnings
----------------------------
revision 1.43
date: 2005/02/04 16:56:11;  author: dwarren;  state: Exp;  lines: +9 -1
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.42
date: 2005/01/14 18:31:16;  author: ruim;  state: Exp;  lines: +22 -10
Integration of multithreaded system
----------------------------
revision 1.41
date: 2004/11/24 22:35:04;  author: dwarren;  state: Exp;  lines: +14 -1
Modified check_glstack_overflow to call gc_heap to try to get the necessary
space to see if it can avoid expanding the stack.  Only expand stack if GC
doesn't get enough space.  This required changes in calls to check_glstack_overflow
since it would accept MAX_ARITY to "over-save" the registers.  But GC requires
the exact number.  I think I got them correctly, except for one in calld, which I
deleted.  I don't know why calld needs to check overflow since the check_heap
in clauses should be enough....
----------------------------
revision 1.40
date: 2004/07/10 20:57:41;  author: dwarren;  state: Exp;  lines: +13 -1
Added reset of pre-image flag in trail entries in the case in which marking
is done, but no garbage collection follows.
----------------------------
revision 1.39
date: 2004/04/08 23:53:25;  author: dwarren;  state: Exp;  lines: +18 -3
Change so when realloc fails on expanding global-local stacks, try backing off
and getting smaller increment.  Doubling at high sizes may be too much.
----------------------------
revision 1.38
date: 2004/01/14 20:27:12;  author: dwarren;  state: Exp;  lines: +6 -6
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.37
date: 2004/01/05 18:40:21;  author: dwarren;  state: Exp;  lines: +6 -1
Free slide_buf after garbage collect (with indirection).  Had been
accumulating....
----------------------------
revision 1.36
date: 2003/07/16 15:04:50;  author: lfcastro;  state: Exp;  lines: +23 -2
* Make stack reallocation aware of attributed variables and interrupt
  handlers.
----------------------------
revision 1.35
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +14 -14
branches:  1.35.4;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.34
date: 2002/05/22 15:41:14;  author: lfcastro;  state: Exp;  lines: +20 -20
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.33
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +4 -283
* Removal of Chat engine
----------------------------
revision 1.32
date: 2002/02/26 18:22:07;  author: lfcastro;  state: Exp;  lines: +2 -1
branches:  1.32.2;
* Support for attributed variables
----------------------------
revision 1.31
date: 2002/02/21 16:57:56;  author: lfcastro;  state: Exp;  lines: +2 -2
* Support for compiling with SimpleScalar/PISA
* Some fixes wrt boxed integers
----------------------------
revision 1.30
date: 2002/01/28 20:44:31;  author: lfcastro;  state: Exp;  lines: +2 -2
* fixed segfault when using full GC statistics
----------------------------
revision 1.29
date: 2002/01/28 16:47:56;  author: lfcastro;  state: Exp;  lines: +9 -7
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.28
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +426 -2900
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.27
date: 2001/07/02 16:18:53;  author: lfcastro;  state: Exp;  lines: +4 -2
* undone incorrect changes related to inclusion of time.h
----------------------------
revision 1.26
date: 2001/06/29 21:03:29;  author: kifer;  state: Exp;  lines: +4 -2
took care of the time.h/ sys/time.h problem.
----------------------------
revision 1.25
date: 2001/06/05 19:17:58;  author: lfcastro;  state: Exp;  lines: +1 -39
* re-structured XMC package bootstrapping as suggested by Kifer
* simplified process of compilation for the smodels package
----------------------------
revision 1.24
date: 2001/05/24 20:37:06;  author: lfcastro;  state: Exp;  lines: +2 -2
* REALLOC_DEBUG shouldn't be unconditionally defined in heap_xsb.c ;(
----------------------------
revision 1.23
date: 2001/05/24 19:20:08;  author: lfcastro;  state: Exp;  lines: +12 -12
* small buglet fix
----------------------------
revision 1.22
date: 2001/05/24 18:53:47;  author: lfcastro;  state: Exp;  lines: +1 -2
* small buglet fix
----------------------------
revision 1.21
date: 2001/05/24 17:54:51;  author: lfcastro;  state: Exp;  lines: +642 -156
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.20
date: 2001/02/06 16:56:36;  author: lfcastro;  state: Exp;  lines: +3 -3
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.19
date: 2001/01/26 23:56:08;  author: lfcastro;  state: Exp;  lines: +145 -13
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.18
date: 2000/10/04 01:46:34;  author: ejohnson;  state: Exp;  lines: +14 -6
branches:  1.18.2;
Moved some of the DEBUG-mode stack-reallocation msgs out of the
overflow macros and into the XXstack_realloc() functions.  Now such
msgs will be issued whenever the stacks are modified, rather than just
when they overflow.
----------------------------
revision 1.17
date: 2000/06/22 19:40:31;  author: ruim;  state: Exp;  lines: +6 -6
added casts to malloc calls to avoid warnings in C++
----------------------------
revision 1.16
date: 2000/05/29 04:23:35;  author: ejohnson;  state: Exp;  lines: +3 -3
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.15
date: 2000/05/20 06:56:01;  author: kifer;  state: Exp;  lines: +4 -4
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.14
date: 2000/04/29 21:53:54;  author: kifer;  state: Exp;  lines: +379 -370
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.13
date: 2000/04/07 18:36:16;  author: cbaoqiu;  state: Exp;  lines: +4 -4
God rid of a warning message on attv_interrupts[][].
----------------------------
revision 1.12
date: 2000/04/06 11:44:55;  author: cbaoqiu;  state: Exp;  lines: +2 -3
Call mark_from_attv_array() only when CHAT is defined.
----------------------------
revision 1.11
date: 2000/04/04 20:54:06;  author: lfcastro;  state: Exp;  lines: +48 -8
- introduced dealing with attributed variables in garbage collection
----------------------------
revision 1.10
date: 2000/02/17 13:53:57;  author: kostis;  state: Exp;  lines: +276 -234
branches:  1.10.2;
Changes to fix "sieve" problem.
----------------------------
revision 1.9
date: 2000/02/15 12:13:10;  author: kostis;  state: Exp;  lines: +55 -50
Fixed bug related to claning CHAT mark bits after aborted gc attempt.
----------------------------
revision 1.8
date: 2000/02/15 08:09:44;  author: bartkul;  state: Exp;  lines: +6 -2
the attempt to do some gc/expansion policy is temporarily disabled
by making the test fail always
see further comment in file
----------------------------
revision 1.7
date: 2000/01/25 03:54:39;  author: cbaoqiu;  state: Exp;  lines: +4 -4
Minor changes to get rid of the warning messages -- ``The variable
"attv_num" is set but never used'' -- when compiled on SGI 64-bit
machine.
----------------------------
revision 1.6
date: 2000/01/07 08:51:33;  author: kifer;  state: Exp;  lines: +4 -4
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/12/22 18:06:58;  author: warren;  state: Exp;  lines: +9 -9
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.4
date: 1999/10/27 14:20:15;  author: kostis;  state: Exp;  lines: +51 -28
Additions to start enforcing a gc policy; currently gc is not performed if
most heap objects are live and the responsibility to deal with the problem
is given to heap expansion routine.
----------------------------
revision 1.3
date: 1999/10/27 02:46:20;  author: cbaoqiu;  state: Exp;  lines: +4 -3
More changes to support attributed vars under CHAT & LOCAL_EVAL.
----------------------------
revision 1.2
date: 1999/10/26 06:47:06;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:58:24;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.10.2.4
date: 2000/09/13 18:41:11;  author: lfcastro;  state: Exp;  lines: +26 -39
Changes:

*Makefile
	- create target for 'make etags'

*emu/binding.h
	- got rid of #ifdef's on WAM_TRAIL

*emu/chat.c
	- commented out a switch_envs(breg) in
	  chat_restore_compl_susp_trail
	- introduced function chat_free_cp_compl_susp_chat_areas
	  needed for bugfix in cut_xsb.h
	- change in restore_answer_template

*emu/cut_xsb.h
	- bugfix in check_table_cut

*lib/Makefile
	- put '-g none' in calls to XSB to be able to compile when GC
	  isn't working

*general
	- changes/introduction in/of debug messages

Status:
Passes the testsuite for all tests, except for the gctests with the
copying collector, which fails for tests wfs_tests/p53 (and up).
----------------------------
revision 1.10.2.3
date: 2000/04/19 18:25:06;  author: lfcastro;  state: Exp;  lines: +194 -231
- GC almost finished. table_tests/flora1 still fails.
----------------------------
revision 1.10.2.2
date: 2000/03/31 22:56:57;  author: lfcastro;  state: Exp;  lines: +369 -25
* some more cleanups of chat-related code
* started inserting code comments in a format suitable for automatic
generation of documents
* new version number (tentative)
----------------------------
revision 1.10.2.1
date: 2000/03/28 18:10:32;  author: lfcastro;  state: Exp;  lines: +99 -157
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.18.2.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.18.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +82 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.32.2.2
date: 2004/10/18 20:46:04;  author: ruim;  state: Exp;  lines: +47 -305
update for version 2.6.1
----------------------------
revision 1.32.2.1
date: 2004/09/29 19:44:15;  author: ruim;  state: Exp;  lines: +19 -8
Sources from rfm repository
----------------------------
revision 1.35.4.1
date: 2003/08/27 16:07:18;  author: lfcastro;  state: Exp;  lines: +23 -2
* Several bugfixes ported from HEAD, including:

- Fix number_codes to deal with boxed integers. Necessary for using
  java1.4.2.

- newer gpp. The main change is that #include can take a macro as an
  argument

- Generalized transformation of P/A to Skel to comma-lists of P/A's in
  index, dynamic, table declarations.  (I.e., fixed a bug.)

- Added a file-copy builtin

- Fix message/2 when 1st argument is a list --- it was printing on
  STDMSG instead of using the given file handle.
----------------------------
revision 1.78.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.78.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.78.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/heap_xsb.h,v
Working file: heap_xsb.h
head: 1.22
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.21
	ROLLBACK: 1.16
	latest_plus_supp_branch: 1.16.0.4
	latest_plus_supp: 1.16
	Version_3dot2_plus_supp: 1.16.0.2
	release_2_6_plus_supp: 1.7.0.6
	Version_3dot2: 1.16
	dec07-perf-results: 1.16
	mt_thesis: 1.14
	release_3_0: 1.13
	release_2_7_0: 1.8
	multi-threaded-26-engine: 1.6.2.2
	pre-mt: 1.8
	multi-threaded-25-engine-done: 1.6.2.1
	multi-threaded-25-engine: 1.6.0.2
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.4
	last-merged-to-demand: 1.7
	demand_branch: 1.7.0.2
	before_removing_chat: 1.6
	release_2_5: 1.6
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.2
	release_2_4: 1.5
	release_2_3: 1.5
	multi-threaded-engine: 1.4.0.2
	pre-threading: 1.4
	release-2-2: 1.3
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 30;	selected revisions: 30
description:
----------------------------
revision 1.22
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +4 -4
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.21
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.20
date: 2010/08/18 03:09:51;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.19
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2007/09/04 00:49:09;  author: dwarren;  state: Exp;  lines: +1 -4
branches:  1.16.4;
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.15
date: 2007/07/12 14:38:02;  author: dwarren;  state: Exp;  lines: +2 -2
Added heap overflow tests for copying terms out of tries from leaf to root.
This is done when returning answers from non-completed tables or when calling
interned with the leaf address bound.
----------------------------
revision 1.14
date: 2006/09/22 23:41:26;  author: tswift;  state: Exp;  lines: +2 -1
Fixes to get clean run of testsuite under Valgrind for uential
engine.  Most of these were inconsequential and were easily
fixed.  One was non-trivial and exposed an obscure memory bug.

On line 304 of heap_xsb.c is the statement

  ls_top = top_of_localstk - 256;  /* extra space for environment above top */ \

I believe that David put this in a few months ago to fix a
problem with not copying over the topmost local stack environment
when reallocating the global and local stacks.  It fixed some
memory problems, and made XSB a bit more stable.

Since the same definition of ls_top is used for garbage
collecting, 256 uninitialized variables could be encountered
during GC, which could lead to problems.  In addition it is not
impossible that other C functions create "holes" in the heap (I
suspect build_delay_list() in residual.c but could be wrong on
that).  If these holes contain uninitialized cells, we could get
core dumps on GC.

My solution is to initialize cells in the glstack at init time,
and to initialize cells *between* the top of local stack and top
of heap at realloc time.

This hypothesis may seem obscure, but I've been chasing down bugs
the last few weekends that dont seem much more obscure than
this :-)

In addition, we're now set up so that we can rerun Valgrind to
find memory bugs after large changes to XSB.
----------------------------
revision 1.13
date: 2006/04/27 21:08:47;  author: tswift;  state: Exp;  lines: +2 -2

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.12
date: 2005/12/12 18:44:52;  author: dwarren;  state: Exp;  lines: +3 -2
Added string table garbage collection.
----------------------------
revision 1.11
date: 2005/11/18 23:29:01;  author: tswift;  state: Exp;  lines: +3 -2

Took attv_interrupts array out of global area, and put it into
the thread context.  Also added, _gl suffix to realtime_count.

Other than that, just general documentation.
----------------------------
revision 1.10
date: 2005/07/18 21:54:10;  author: crojo;  state: Exp;  lines: +2 -2
*** empty log message ***
----------------------------
revision 1.9
date: 2005/01/14 18:31:18;  author: ruim;  state: Exp;  lines: +13 -12
Integration of multithreaded system
----------------------------
revision 1.8
date: 2004/11/24 22:35:04;  author: dwarren;  state: Exp;  lines: +2 -1
Modified check_glstack_overflow to call gc_heap to try to get the necessary
space to see if it can avoid expanding the stack.  Only expand stack if GC
doesn't get enough space.  This required changes in calls to check_glstack_overflow
since it would accept MAX_ARITY to "over-save" the registers.  But GC requires
the exact number.  I think I got them correctly, except for one in calld, which I
deleted.  I don't know why calld needs to check overflow since the check_heap
in clauses should be enough....
----------------------------
revision 1.7
date: 2002/03/12 18:49:31;  author: lfcastro;  state: Exp;  lines: +1 -2
* Removal of Chat engine -- part 2
----------------------------
revision 1.6
date: 2002/01/28 16:47:56;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.6.2;
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.5
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +3 -3
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.4
date: 2000/04/29 21:53:54;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.4.2;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.3
date: 2000/04/05 00:49:20;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Declared attv_interrupts as an extern variable in heap_xsb.h.
----------------------------
revision 1.2
date: 1999/12/19 15:33:04;  author: kostis;  state: Exp;  lines: +4 -6
branches:  1.2.2;
Added garbage_collection/1 predicate for choosing the type of garbage
collection strategy on the fly.  Also, some minor cleanup changes.
----------------------------
revision 1.1
date: 1999/10/25 05:58:25;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2.2.1
date: 2000/04/19 18:25:07;  author: lfcastro;  state: Exp;  lines: +4 -3
- GC almost finished. table_tests/flora1 still fails.
----------------------------
revision 1.4.2.2
date: 2000/12/19 15:58:15;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.4.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.6.2.2
date: 2004/10/18 20:46:05;  author: ruim;  state: Exp;  lines: +1 -2
update for version 2.6.1
----------------------------
revision 1.6.2.1
date: 2004/09/29 19:44:16;  author: ruim;  state: Exp;  lines: +12 -11
Sources from rfm repository
----------------------------
revision 1.16.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.16.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/incr_xsb.c,v
Working file: incr_xsb.c
head: 1.26
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.14
	ROLLBACK: 1.8
	latest_plus_supp_branch: 1.7.0.2
	latest_plus_supp: 1.7
	Version_3dot2_plus_supp: 1.5.0.2
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.2
keyword substitution: kv
total revisions: 29;	selected revisions: 29
description:
----------------------------
revision 1.26
date: 2012/03/19 15:19:59;  author: dwarren;  state: Exp;  lines: +5 -4
Fixed a couple of declarations, not at the beginning of blocks.
Added some casts to quiet MSVC.
Conditioned the inline declarations of prolog_call0 and prolog_code_call,
which can't be external in MSVC.
----------------------------
revision 1.25
date: 2012/03/16 19:37:28;  author: tswift;  state: Exp;  lines: +38 -36

Changes for better error reporting, checks for incrementally tabled
predicates, and renaming of functions.
----------------------------
revision 1.24
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +63 -16

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.23
date: 2012/03/01 21:26:49;  author: tswift;  state: Exp;  lines: +10 -3

Some documentation updates, changes to more meaningful names, and the
start of a function that might be used in lazy incremental tabling.
----------------------------
revision 1.22
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +2 -2
Getting Linux to Work
----------------------------
revision 1.21
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.20
date: 2011/05/15 07:23:08;  author: kifer;  state: Exp;  lines: +4 -3
fixed the bug introduced by Terry: gcc accepts var declarations interspersed
with code, but MS VC does not. So, it would not compile under windows.
----------------------------
revision 1.19
date: 2011/05/12 14:26:24;  author: tswift;  state: Exp;  lines: +6 -5


Now throwing permission error for incr_invalidate_call if call is to a
non-tabled predicate, rather than seg-faulting.
----------------------------
revision 1.18
date: 2011/04/17 16:57:12;  author: tswift;  state: Exp;  lines: +4 -4

Added some thread context declarations so that things keep compiling
for the MT engine.  Incremental tabling doesnt yet work for the MT
engine, but its not bad for the functions to have the thread contexts
anyway.
----------------------------
revision 1.17
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +1 -5

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.16
date: 2011/04/12 17:31:59;  author: tswift;  state: Exp;  lines: +4 -4

Fix of abolishing incremental tables when the affected list is
non-empty -- it needed to be re-initialized to null.  In addition, the
changed list also needs to be initted and reinitialized to null, but
this is accessed less often so we haven't yet seen that problem arise.

I also changed the name of the global variables for incremental
tabling to make them more obvious -- names like "changed" and
"affected" arent good.
----------------------------
revision 1.15
date: 2010/10/09 22:03:25;  author: tswift;  state: Exp;  lines: +2 -2

Allowing tables to be both subsumptive and opaque.
----------------------------
revision 1.14
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +7 -3
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.13
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.12
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +2 -6
no message
----------------------------
revision 1.8
date: 2010/07/29 17:19:26;  author: tswift;  state: Exp;  lines: +7 -3

Changes to allow psc_get_incr/2 to find out whether a table is
declared opaque.
----------------------------
revision 1.7
date: 2010/04/24 20:50:42;  author: tswift;  state: Exp;  lines: +9 -1
branches:  1.7.2;

Changes for incremental tabling based on tries.
----------------------------
revision 1.6
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.5
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.4
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +2 -2
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.3
date: 2007/02/09 18:12:17;  author: dwarren;  state: Exp;  lines: +13 -3
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.2
date: 2006/10/11 21:06:22;  author: dwarren;  state: Exp;  lines: +199 -199
Change way terms are copied in creating incr lists of changed terms,
so that the heap is in a valid state if (when) glstack_realloc and
gc_heap might be called.  Avoids segfault in gc_heap.
----------------------------
revision 1.1
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;
Incremental Code Added.
----------------------------
revision 1.7.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.7.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/incr_xsb.h,v
Working file: incr_xsb.h
head: 1.12
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.12
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.1.0.4
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.2
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
keyword substitution: o
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.12
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +0 -31
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.11
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.10
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.9
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;  lines: +31 -0
no message
----------------------------
revision 1.6
date: 2010/08/17 19:44:46;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/06/22 23:43:59;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/06/19 19:10:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +28 -28
Dipti's code for support graph added
----------------------------
revision 1.1
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;
branches:  1.1.4;
Incremental Code Added.
----------------------------
revision 1.1.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +28 -28
no message
----------------------------
revision 1.1.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/incr_xsb_defs.h,v
Working file: incr_xsb_defs.h
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.10
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.3.0.2
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.2.0.2
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.1
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
----------------------------
revision 1.14
date: 2012/03/16 19:37:28;  author: tswift;  state: Exp;  lines: +5 -5

Changes for better error reporting, checks for incrementally tabled
predicates, and renaming of functions.
----------------------------
revision 1.13
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +29 -15

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.12
date: 2012/03/01 21:26:49;  author: tswift;  state: Exp;  lines: +2 -1

Some documentation updates, changes to more meaningful names, and the
start of a function that might be used in lazy incremental tabling.
----------------------------
revision 1.11
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +2 -2

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.10
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.9
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/01 22:06:02;  author: tswift;  state: Exp;  lines: +2 -1

biassert.c -- minor doc change

Others: changes to allow directives to change tables among
incremental, nonincremental, and opaque.
----------------------------
revision 1.4
date: 2010/07/29 17:19:26;  author: tswift;  state: Exp;  lines: +5 -1

Changes to allow psc_get_incr/2 to find out whether a table is
declared opaque.
----------------------------
revision 1.3
date: 2010/04/24 20:50:43;  author: tswift;  state: Exp;  lines: +2 -1
branches:  1.3.2;

Changes for incremental tabling based on tries.
----------------------------
revision 1.2
date: 2007/02/09 18:12:17;  author: dwarren;  state: Exp;  lines: +36 -37
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.1
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;
Incremental Code Added.
----------------------------
revision 1.3.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/init.c,v
Working file: init.c
head: 1.39
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.35
	without-attv: 1.31
	release-2-0: 1.20
	pre-release-2-0: 1.17
	v1-9-8: 1.15
	code-fixer-new: 1.7
	code-fixer: 1.7
	delayvar_ok: 1.7
	r1-9-b6: 1.6
	r1-9-b5: 1.5
	devel-1-9-b4-5: 1.5
	devel-1-9-b4-4: 1.5
	devel-1-9-b4-3: 1.5
	xsb-9-1-b4-2: 1.3
	xsb-9-1-b4-1: 1.3
	xsb-1-9-b4: 1.2
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 40;	selected revisions: 40
description:
----------------------------
revision 1.39
date: 1999/10/25 05:58:27;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.38
date: 1999/10/22 20:57:31;  author: ejohnson;  state: Exp;  lines: +1 -8
Enabled subsumption with CHAT.

The interesting changes are in chat.c and chatsched.i.

Changes to the other files just remove CHAT restrictions to
subsumption.
----------------------------
revision 1.37
date: 1999/10/20 18:22:10;  author: kifer;  state: Exp;  lines: +1 -3
Removed misleading references to DOS, which imply as if DOS is supported
----------------------------
revision 1.36
date: 1999/10/19 20:11:47;  author: ejohnson;  state: Exp;  lines: +3 -3
Addition of variant/1 to XSB to complement subsumptive/1.
Each one changes the tabled evaluation method of the given
predicate(s).

Modified the structure of related constants to utilize the
preprocessor on the Prolog end.  The builtin which actually makes the
change in the TableInfoFrame is generalized from only making the
switch to subsumptive mode to taking an extra argument indicating the
method to use during the predicate's evaluation.
----------------------------
revision 1.35
date: 1999/10/12 20:20:13;  author: ejohnson;  state: Exp;  lines: +12 -3
Added XSB startup flag for executing all tabling preds in subsumptive
mode.

Added call to function during startup to init some data areas needed
by subsumptive routines.
----------------------------
revision 1.34
date: 1999/10/10 11:38:14;  author: kostis;  state: Exp;  lines: +1 -2
Changes to fold code of file "load_seg.c" into "loader.c" and thus avoid
communication between these two pieces of code through horrible global
variables.  Files "load_seg.*" are removed.  Some code cleanup took place.
----------------------------
revision 1.33
date: 1999/10/09 18:11:33;  author: kostis;  state: Exp;  lines: +1 -3
Small cleanup change.
----------------------------
revision 1.32
date: 1999/10/09 02:00:26;  author: cbaoqiu;  state: Exp;  lines: +5 -2
Changes for attributed variables (first step).
----------------------------
revision 1.31
date: 1999/10/08 07:32:15;  author: kifer;  state: Exp;  lines: +30 -3
added flags: --nobanner, --noprompt, --quietload
----------------------------
revision 1.30
date: 1999/10/05 04:01:39;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.29
date: 1999/09/21 11:10:30;  author: kostis;  state: Exp;  lines: +76 -68
Changes to fix wrong-initialization order which was introduced by the
addition of I/O/Warning streams to XSB.
----------------------------
revision 1.28
date: 1999/09/20 16:13:44;  author: kostis;  state: Exp;  lines: +5 -1
Minor change.
----------------------------
revision 1.27
date: 1999/08/17 06:30:42;  author: kifer;  state: Exp;  lines: +16 -4
Unbuffered the new streams (stddbg, mstdsg, wstdarn, fstddbk). This took
care of the windoze brain damage
----------------------------
revision 1.26
date: 1999/08/16 07:24:17;  author: kifer;  state: Exp;  lines: +49 -5
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.25
date: 1999/08/13 15:56:50;  author: kifer;  state: Exp;  lines: +2 -2
Fixed the bug where banner was moved along with the config file.
----------------------------
revision 1.24
date: 1999/08/04 14:41:58;  author: ejohnson;  state: Exp;  lines: +5 -1
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.23
date: 1999/07/22 19:09:18;  author: kifer;  state: Exp;  lines: +3 -3
Got rid of compiler warnings.
----------------------------
revision 1.22
date: 1999/07/20 18:54:37;  author: kifer;  state: Exp;  lines: +2 -1
added open_process_pipe/close_process_pipe,
open_process_stream/close_process_stream
----------------------------
revision 1.21
date: 1999/07/15 21:41:13;  author: ejohnson;  state: Exp;  lines: +1 -2
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.20
date: 1999/05/27 16:02:34;  author: kifer;  state: Exp;  lines: +2 -1
Added set_dcg_style/1 and related stuff to enable switching between
XSB-style DCG and Quintus, etc.
----------------------------
revision 1.19
date: 1999/05/17 17:20:49;  author: unova;  state: Exp;  lines: +4 -1
Moved reset_inst to init.c and aligned it to word
(must for the -t option in some machines)
----------------------------
revision 1.18
date: 1999/05/03 00:55:47;  author: luis;  state: Exp;  lines: +3 -2
* changes regarding exporting functions under Windows
----------------------------
revision 1.17
date: 1999/04/24 05:02:17;  author: kifer;  state: Exp;  lines: +2 -5
Made it exit if typo in command line goal.
----------------------------
revision 1.16
date: 1999/02/25 15:01:27;  author: kostis;  state: Exp;  lines: +2 -2
Changes for sliding garbage collection made default.
----------------------------
revision 1.15
date: 1999/02/05 15:51:59;  author: kostis;  state: Exp;  lines: +16 -14
Changes related to the allocation of the "base" choice point.
Made sure that all its fields are initialized to proper values.
----------------------------
revision 1.14
date: 1999/02/01 23:48:15;  author: kostis;  state: Exp;  lines: +37 -22
Added flag and command line option to control type og garbage collection used.
----------------------------
revision 1.13
date: 1999/01/31 14:02:21;  author: kostis;  state: Exp;  lines: +7 -66
Mostly cleanup changes to simplify "tries.h".  Lots of junk code has been
removed and things that are not needed in other files have been moved to
"tries.c".
----------------------------
revision 1.12
date: 1999/01/29 04:18:23;  author: cbaoqiu;  state: Exp;  lines: +7 -3
Changed string_find("ret", 1) to ret_psc[0].  ret_psc[0] is set at the
time when the system is started.
----------------------------
revision 1.11
date: 1999/01/19 16:45:09;  author: kostis;  state: Exp;  lines: +5 -5
Eliminated some dependency on 255's arbitrarily placed in the code.
----------------------------
revision 1.10
date: 1999/01/19 14:45:41;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Removed ret_psc_exists[] (it's redundant).
----------------------------
revision 1.9
date: 1999/01/19 13:40:14;  author: kostis;  state: Exp;  lines: +7 -8
Clean up change.
----------------------------
revision 1.8
date: 1998/12/21 01:08:23;  author: cbaoqiu;  state: Exp;  lines: +6 -15
Kostis' changes for GC and CHAT.
----------------------------
revision 1.7
date: 1998/12/09 03:10:11;  author: cbaoqiu;  state: Exp;  lines: +5 -1
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  Initialize array ret_psc_exists[].
----------------------------
revision 1.6
date: 1998/11/18 07:59:15;  author: kifer;  state: Exp;  lines: +4 -3
Moved initialization of executable, user_home, xsb_config_file to the
new file self_orientation. Added initialization like in xmain.c to
xsb_init in cinterf.c. This should fix the C-calling xsb interface.
----------------------------
revision 1.5
date: 1998/11/14 05:05:25;  author: kifer;  state: Exp;  lines: +1 -2
djusted casts because now bool is typedef short, for NT compatibility.
----------------------------
revision 1.4
date: 1998/11/13 23:08:18;  author: kifer;  state: Exp;  lines: +3 -3
Adjusted various macros for NT
----------------------------
revision 1.3
date: 1998/11/09 03:08:03;  author: sbprolog;  state: Exp;  lines: +2 -2
Changed config.msg to banner.msg
----------------------------
revision 1.2
date: 1998/11/07 01:47:50;  author: sbprolog;  state: Exp;  lines: +12 -9
(version_message): look for config.msg in the configuration-specific directory.
----------------------------
revision 1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/init_xsb.c,v
Working file: init_xsb.c
head: 1.188
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.168
	ROLLBACK: 1.162
	latest_plus_supp_branch: 1.158.0.2
	latest_plus_supp: 1.158
	Version_3dot2_plus_supp: 1.150.0.2
	release_2_6_plus_supp: 1.31.0.4
	Version_3dot2: 1.150
	dec07-perf-results: 1.137
	mt_thesis: 1.117
	release_3_0: 1.98
	release_2_7_0: 1.39
	multi-threaded-26-engine: 1.22.2.3
	pre-mt: 1.39
	multi-threaded-25-engine-done: 1.22.2.1
	multi-threaded-25-engine: 1.22.0.2
	release_2_6_1: 1.31.2.1
	release_2_6_final: 1.31
	release_2_6: 1.31.0.2
	last-merged-to-demand: 1.25
	demand_branch: 1.25.0.2
	before_removing_chat: 1.22
	release_2_5: 1.22
	pre-merge-slgwam-gc: 1.20
	multi-threaded-c-engine: 1.20.0.2
	release_2_4: 1.17
	release_2_3: 1.15
	multi-threaded-engine: 1.14.0.2
	pre-threading: 1.13
	release-2-2: 1.11
	chat-and-local: 1.11.0.2
	xsb-pre-cleanup: 1.11
	release-2-1: 1.7
	release-2-0-1: 1.4
keyword substitution: kv
total revisions: 206;	selected revisions: 206
description:
----------------------------
revision 1.188
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +1 -10

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.187
date: 2012/02/29 15:34:19;  author: tswift;  state: Exp;  lines: +2 -1

Fixed bug in mt engine where vsc_tnot_call was not initialized.
----------------------------
revision 1.186
date: 2012/02/24 17:37:21;  author: tswift;  state: Exp;  lines: +2 -2

abort_pre_action and friends.
----------------------------
revision 1.185
date: 2012/02/19 19:17:55;  author: tswift;  state: Exp;  lines: +3 -1

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.184
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +10 -6
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.183
date: 2011/12/24 21:09:10;  author: tswift;  state: Exp;  lines: +6 -2

Changes	for memory managemement

1) Now supporting max_memory flag for user-defined memory limits

2) Changed some	  memory errors so that rather than creating an
exception ball,	  a flag is set; the exception handler then checks
for the flag.  The reason for doing this is that allocating
memory to assert an exception ball can get us into trouble.
----------------------------
revision 1.182
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +3 -1

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.181
date: 2011/11/11 18:21:39;  author: dwarren;  state: Exp;  lines: +2 -1
Added flag[UNIFY_WITH_OCCURS_CHECK_FLAG] that when true causes XSB
to do all unifications with occur_check.  (Not completely tested, and
better efficiency is possible by having compiler generate different
bldval instructions when it can determine that occur-check isn't needed.)
----------------------------
revision 1.180
date: 2011/11/06 20:30:42;  author: tswift;  state: Exp;  lines: +4 -1

Optimized is_cyclic by taking out a malloc()
----------------------------
revision 1.179
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +41 -3

Integrating in Call Abstraction
----------------------------
revision 1.178
date: 2011/06/05 19:24:03;  author: tswift;  state: Exp;  lines: +6 -1



Changes to

1) Add flag-controlled answer depth checks to variant answer
tables.  (See current_prolog_flag in the manual for details).

2) In support of 1, added sprint_term, which prints a term to a C
string.  This is useful for errors and warnings invoked by C.

3) Added MAXTOINDEX_FLAG, which allows experimentation with the
depth of * indexing.

4) Increased the initial size strbuff from 1000 -> 10000.  This
reduces spurious long atom warnings.
----------------------------
revision 1.177
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +2 -2

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.176
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +9 -9
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.175
date: 2011/05/01 09:36:18;  author: kifer;  state: Exp;  lines: +3 -1
killed most of the warnings
fixed makefile bug
----------------------------
revision 1.174
date: 2011/04/12 17:31:59;  author: tswift;  state: Exp;  lines: +3 -2

Fix of abolishing incremental tables when the affected list is
non-empty -- it needed to be re-initialized to null.  In addition, the
changed list also needs to be initted and reinitialized to null, but
this is accessed less often so we haven't yet seen that problem arise.

I also changed the name of the global variables for incremental
tabling to make them more obvious -- names like "changed" and
"affected" arent good.
----------------------------
revision 1.173
date: 2011/03/11 16:55:17;  author: dwarren;  state: Exp;  lines: +4 -1
When GENERAL_TAGGING, added code (or commented some back in) to add
addresses in the trail to the general_tagging table.  Addresses in the
trail are tagged during garbage collection, when trail pointers into
the heap are reversed (and tagged.)
----------------------------
revision 1.172
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +3 -3

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.171
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +3 -3

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.170
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +2 -2

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.169
date: 2010/10/07 18:20:11;  author: dwarren;  state: Exp;  lines: +5 -1
Modified simplify_neg_fails to not be recursive.  It registers a recursive
call, returns immediately, and then before returning from the top-level
executes all registered calls.  This fixes the problem of the C runstack
overflow observed with the even/1 benchmark.  It's possible that this is
not always correct, but it passes the testsuite and seems to be correct
for the kinds of recursion that shows up for this predicate.
----------------------------
revision 1.168
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -5
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.167
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.166
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.165
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.164
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.163
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +5 -1
no message
----------------------------
revision 1.162
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.161
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.160
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -2
Backed out code
----------------------------
revision 1.159
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +3 -1
Dipti's code for support graph added
----------------------------
revision 1.158
date: 2010/06/10 20:18:08;  author: dwarren;  state: Exp;  lines: +3 -3
branches:  1.158.2;
Added space for final null character for constructed file names. %$#$%#!
----------------------------
revision 1.157
date: 2010/03/18 22:22:17;  author: tswift;  state: Exp;  lines: +3 -1

Added subgoal depth check with actions of fail and error (cf pg. 165 of the manual)
----------------------------
revision 1.156
date: 2010/02/10 19:11:12;  author: dwarren;  state: Exp;  lines: +6 -2
Made excess_vars a builtin, for efficiency.
----------------------------
revision 1.155
date: 2010/01/30 20:17:37;  author: evansbj;  state: Exp;  lines: +3 -3
*** empty log message ***
----------------------------
revision 1.154
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.153
date: 2009/05/01 12:54:38;  author: tswift;  state: Exp;  lines: +2 -1


Added flag heap_margin will allows users to set	the heap gc /
overflow margin.  In those cases where XSB's memory management is
somehow not working properly, the flag gives users a possible
work-around until we fix whatever the problem is.  In many cases,
this work-arond may be easier to use than setting -m to	   some
large number.
----------------------------
revision 1.152
date: 2009/04/02 11:28:49;  author: ruim;  state: Exp;  lines: +2 -2
Increased default size of message queues
----------------------------
revision 1.151
date: 2009/03/29 21:40:10;  author: tswift;  state: Exp;  lines: +9 -2
Changes to allow max_tries as a command-line option.
----------------------------
revision 1.150
date: 2008/11/05 18:26:45;  author: tswift;  state: Exp;  lines: +3 -2

Changes to support cancellable thread_sleep
----------------------------
revision 1.149
date: 2008/07/25 20:56:50;  author: tswift;  state: Exp;  lines: +3 -2

fix so that new fast call checks ! properly -- before I was assuming that ! was read as a structure, while it was being read as a string.  Now its properly handled.
----------------------------
revision 1.148
date: 2008/06/08 22:10:04;  author: ruim;  state: Exp;  lines: +2 -1
changes to shared completed tables
	re introduced de dealock break leader
	solved some bugs relating to marking subgoals of threads
	that where already usurped (double deadlocks)
----------------------------
revision 1.147
date: 2008/06/05 18:15:12;  author: ruim;  state: Exp;  lines: +1 -2
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.146
date: 2008/06/04 13:23:25;  author: ruim;  state: Exp;  lines: +1 -2
tidy up of shared completed tables code
completing mut is now locked much less time
----------------------------
revision 1.145
date: 2008/04/06 23:04:22;  author: tswift;  state: Exp;  lines: +5 -6
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.144
date: 2008/02/22 17:10:16;  author: tswift;  state: Exp;  lines: +5 -3
Changes to make call/1 go to the cut transform for load_undef -- possibly not needed.
----------------------------
revision 1.143
date: 2008/02/21 20:57:49;  author: tswift;  state: Exp;  lines: +3 -2

Changes to optimize call/1 for atomic predicates (e.g. not ,/2 ;/2 etc.

Also, tweaked an error message for atom_chars/codes
----------------------------
revision 1.142
date: 2008/01/30 16:03:03;  author: dwarren;  state: Exp;  lines: +2 -2
Added a new instruction for adding (or subtracting) small integers.
This allows a somewhat more efficient compilation of arithmetic,
for the common case of incrementing or decrementing a value.
----------------------------
revision 1.141
date: 2008/01/02 19:47:43;  author: dwarren;  state: Exp;  lines: +10 -3
Fix (or at least greatly improve) the C-calling-XSB (recursively) interface for
the multi-threaded engine.  There is still an issue with multiple calls of
different C threads, but sharing the same th-context.  But I think the problem
is in more than just this interface.
----------------------------
revision 1.140
date: 2008/01/01 15:29:24;  author: ruim;  state: Exp;  lines: +2 -2
small change to disallow 0 size for mem areas
----------------------------
revision 1.139
date: 2008/01/01 14:41:26;  author: ruim;  state: Exp;  lines: +47 -18
allow to specify a unit for memory area sizes in the command line
lowest unit is KB
default is KB
----------------------------
revision 1.138
date: 2007/12/13 15:33:07;  author: ruim;  state: Exp;  lines: +16 -2
changed default stack size for the multi-threaded system,
so that the user can create more threads without worrying to use
to much memory.
----------------------------
revision 1.137
date: 2007/11/20 19:17:20;  author: tswift;  state: Exp;  lines: +24 -2


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.136
date: 2007/11/04 22:31:45;  author: tswift;  state: Exp;  lines: +27 -28

Minor refactoring before major refactorings later.  Took
initialization of global variables for SLGWAM instructions out of
thread initialiation and put it into system initialization, where it
should be.
----------------------------
revision 1.135
date: 2007/11/02 23:20:55;  author: tswift;  state: Exp;  lines: +5 -2
added a warning when XSB is given a long command-line argument that it
doesn't recognize (a warning had been issued for short arguments, but
not for long ones).
----------------------------
revision 1.134
date: 2007/11/01 23:46:59;  author: tswift;  state: Exp;  lines: +6 -2


Added a command-line argument, --shared-predicates which, in the MT
engine makes dynamic code and tables shared by default.  If this
command-line argument is not used.  The default behavior is kept in a
flag so it can be queried, but not changed during run time.

Also, fixed a bug in dynamic as an executable directive.  ?-
dyanamic(p/n) succeeded even when p/n was static -- worse, it actually
CHANGED p/n to dynamic, working like an abolish for static predicates.
Don't know how that got in there.
----------------------------
revision 1.133
date: 2007/10/23 15:53:19;  author: ruim;  state: Exp;  lines: +20 -3
Introduced command line option max_mqueues to specify maximum limit for
message queues

Rationalized use of max_threads_glc wrt sequential engine
----------------------------
revision 1.132
date: 2007/09/28 18:20:11;  author: dwarren;  state: Exp;  lines: +2 -2
This change causes attv interrupts to be handled before cuts.
(It also fixes a bug in the previous checkin to handle attv
interrupts before trymeorelse instructions.)
All the xwam files are changed since this involved generating a
new instruction(s) putpbreg (and the temp version) for cuts that have
parameters for ARsize and NumRegsInUse which are needed if an
interrupt is pending and is to be handled.
Sitll to be done is to figure out how to handle interrupts before
trie_try-type instructions that do unification when retrieving
from tries.
----------------------------
revision 1.131
date: 2007/09/26 20:15:22;  author: dwarren;  state: Exp;  lines: +22 -1
This update modifies the trymeorelse instruction (which implements
disjunctions, including if-then-else) to include a check for pending
attv interrupts, and handling them if there are any.  The problem is
that to handle interrupts, the environment must be known and there
must be a "call"-like instruction that allows called routines to find
the size of the parents AR.  This is done here by having the
trymeorelse instruction (when there is a pending interrupt) create
an environment and then branch to a 2-instruction sequence of
check_interrupt,restore_dealloc_proceed.  This last instruction is
new, and it restores registers (if nec, but here it's not since no
registers are active at a trymeorelse), pops the environment and
returns to the original caller, which in this case causes the trymeorelse
instruction to be executed again.
----------------------------
revision 1.130
date: 2007/09/04 00:49:09;  author: dwarren;  state: Exp;  lines: +4 -10
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.129
date: 2007/08/08 17:50:50;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.128
date: 2007/07/25 15:52:15;  author: ruim;  state: Exp;  lines: +1 -5
moved wam_initialized to emuloop.c
----------------------------
revision 1.127
date: 2007/07/25 15:43:46;  author: ruim;  state: Exp;  lines: +5 -1
fix for allowing xsb_abort on initialization
removed mt code for message queues from compiling in the sequential engine
----------------------------
revision 1.126
date: 2007/07/12 22:53:03;  author: tswift;  state: Exp;  lines: +4 -1
Added contexts for heap overflow check functions

Added queue aliases to message_queue_create, thread_send_message, and
thread_queue_message.

Added mutex aliases for all mutex functions to make them consistent with ISO working group.

Made default maximum queue terms a changeable XSB flag.

Wrote Prolog stub for message_queue_destroy

Manual updated, and mttest suite changed.
----------------------------
revision 1.125
date: 2007/06/27 00:51:29;  author: tswift;  state: Exp;  lines: +3 -2
Minor changes for keeping max_threads as a flag.

Also, updated mttestsuite
----------------------------
revision 1.124
date: 2007/06/26 16:59:59;  author: tswift;  state: Exp;  lines: +20 -48

Now allowing modifications of default values for thread create via xsb_flag.
Altered thread create so that values can either be explicitly passed in, or obtained from flags.

Also, added usleep() as a temporary fix to a problem that I'll send out a note about.
----------------------------
revision 1.123
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +7 -1

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.122
date: 2007/06/01 22:47:06;  author: tswift;  state: Exp;  lines: +15 -2

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.121
date: 2007/01/25 20:33:54;  author: tswift;  state: Exp;  lines: +11 -2


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.120
date: 2007/01/17 17:41:20;  author: tswift;  state: Exp;  lines: +2 -2

 Changed sorting functions so that they just use area from the
 stack in the case of short lists and so avoid a malloc.  For
 applications that use sorting heavily (e.g. set-based analysis), this
 greately improves scalability for the MT engine, and should improve
 speed a little for single threade applications as well.
----------------------------
revision 1.119
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +58 -43

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.118
date: 2007/01/10 16:31:58;  author: ruim;  state: Exp;  lines: +4 -1
set bound to lwp attribute on thread creation
----------------------------
revision 1.117
date: 2006/11/28 14:18:06;  author: ruim;  state: Exp;  lines: +10 -1
added one mutex to each struct manager so that MUTEX_SM is now obsolete.
this should provide a bit more scalability.
----------------------------
revision 1.116
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +2 -2
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.115
date: 2006/11/26 23:43:43;  author: tswift;  state: Exp;  lines: +7 -1

 changes involve memory allocation
 for the dynamic clause garbage collection frames: rather than
 using malloc() and free() for these frames, I changed the
 various retract(all)s to use structure managers.  This has two
 advantages: first the structure managers are more efficient
 overall than using malloc and free, and second, in the
 multi-threaded engine we now use private structure mangers to
 manage the dynamic gc frames for private dynamic predicates,
 increaing potential concurrency.

Also, changes to experimental retract.
----------------------------
revision 1.114
date: 2006/11/22 16:18:07;  author: ruim;  state: Exp;  lines: +20 -1
Fixed heap expansion and GC to allow concurrency, by
moving global variables into the thread context.

GC_PROFILE was not fixed
----------------------------
revision 1.113
date: 2006/11/21 01:22:12;  author: ruim;  state: Exp;  lines: +7 -5
activated parameter --max_threads by replacing MAX_THREADS with max_threads_glc
----------------------------
revision 1.112
date: 2006/11/15 16:38:09;  author: tswift;  state: Exp;  lines: +23 -1

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.111
date: 2006/11/06 16:54:38;  author: tswift;  state: Exp;  lines: +3 -1

Fixing (I hope) a couple of small bugs evidenced by Valgrind in the MT engine.
----------------------------
revision 1.110
date: 2006/11/04 12:41:26;  author: ruim;  state: Exp;  lines: +13 -20
Fixed what seemed to be a bug in initializing the stack sizes
----------------------------
revision 1.109
date: 2006/11/04 11:53:36;  author: ruim;  state: Exp;  lines: +2 -2
taken out mistake from previous commit
----------------------------
revision 1.108
date: 2006/11/04 11:27:39;  author: ruim;  state: Exp;  lines: +7 -5
adaptation of previous changes for 64 bit machines
----------------------------
revision 1.107
date: 2006/11/04 00:53:00;  author: ruim;  state: Exp;  lines: +19 -7
Changed minimum pthread stack size to 512 K
Minimum pthread stack size in Linux was previously 10 M,
clearly an exageration
mttest suite breaks with a stack size of 64 K, passes with 128 K
took out some compilation warnings
----------------------------
revision 1.106
date: 2006/11/02 02:59:44;  author: ruim;  state: Exp;  lines: +5 -1
added counter for deadlocks to show in statistics
----------------------------
revision 1.105
date: 2006/10/25 15:35:02;  author: ruim;  state: Exp;  lines: +4 -3
Fix for bug in locking iostrs
----------------------------
revision 1.104
date: 2006/10/18 20:42:26;  author: dwarren;  state: Exp;  lines: +6 -0
Updates to the ODBC interface:
1) fixed a global variable that would break MT
2) changed to use mem_alloc and new ODBC_SPACE tag to show memory
	usage in statistics.
----------------------------
revision 1.103
date: 2006/09/27 22:03:43;  author: tswift;  state: Exp;  lines: +3 -2

Changes to get rid of uninitialized memory as reported by valgrind.

1) Initialized IGRhead and deadlock_brk_leader
2) Ensured that tries always use private structure manager
3) initialized num_heap_term_vars to be 0 at each pass through answer_return

The last fixes an obscure memory error in the sequential engine, as well.
----------------------------
revision 1.102
date: 2006/09/22 23:41:26;  author: tswift;  state: Exp;  lines: +5 -1
Fixes to get clean run of testsuite under Valgrind for uential
engine.  Most of these were inconsequential and were easily
fixed.  One was non-trivial and exposed an obscure memory bug.

On line 304 of heap_xsb.c is the statement

  ls_top = top_of_localstk - 256;  /* extra space for environment above top */ \

I believe that David put this in a few months ago to fix a
problem with not copying over the topmost local stack environment
when reallocating the global and local stacks.  It fixed some
memory problems, and made XSB a bit more stable.

Since the same definition of ls_top is used for garbage
collecting, 256 uninitialized variables could be encountered
during GC, which could lead to problems.  In addition it is not
impossible that other C functions create "holes" in the heap (I
suspect build_delay_list() in residual.c but could be wrong on
that).  If these holes contain uninitialized cells, we could get
core dumps on GC.

My solution is to initialize cells in the glstack at init time,
and to initialize cells *between* the top of local stack and top
of heap at realloc time.

This hypothesis may seem obscure, but I've been chasing down bugs
the last few weekends that dont seem much more obscure than
this :-)

In addition, we're now set up so that we can rerun Valgrind to
find memory bugs after large changes to XSB.
----------------------------
revision 1.101
date: 2006/09/14 16:13:55;  author: crojo;  state: Exp;  lines: +48 -13
Added two new routines to the C interface:

pipe_xsb_stdin()
  This splits XSB's stdin stream into a read end and a
  write end. The read end takes the place of the original stdin, and
  the write end is accessable through a call to write_to_xsb_stdin,
  another c interface routine. These two calls can be used to pass
  input to a thread running xsb.dll code that is blocking waiting for
  input from stdin. They allow separate threads to interact with the
  interpreter or the trace debugger when xsb is loaded as a DLL.

writeln_to_xsb_stdin(char *)
  This can be called after a call to  pipe_xsb_stdin, and writes a string
  of characters to the write end of xsb's piped stdin stream. If a thread
  running xsb.dll code is blocking on input from stdin, this will unblock
  it.

I've modified the way output is redirected to files on WIN_NT when XSB
is initialized through the C interface. The output files are now sharable.
I've also changed the spacing in call_graph_xsb.c to fix compilation problems
on windows.
----------------------------
revision 1.100
date: 2006/09/08 19:59:47;  author: dwarren;  state: Exp;  lines: +1 -0
Added shared stat_flag (70, STRING_GARBAGE_COLLECTION) to allow user to
turn off string garbage collection.  Added a counter that's printed in
statistics to indicate how many times string garbage collection has been called.
----------------------------
revision 1.99
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +6 -1
Incremental Code Added.
----------------------------
revision 1.98
date: 2006/07/14 16:49:36;  author: tswift;  state: Exp;  lines: +2 -2

Fixed relatively obscure bugs in clause gc.  With these fixes, the gc testsuite is working again, as does the flora testsuite.

Changes are (1 traverse CPS from bfreg if needed; 2 dont reclaim if there are ;/2 or db_get_clause CPs in the stack.

Also changed dis to allow it to print to a file if needed.
----------------------------
revision 1.97
date: 2006/07/08 18:49:11;  author: tswift;  state: Exp;  lines: +5 -1

Checks for private flag CLAUSE_GARBAGE_COLLECT that turns off space reclamation.  Useful for debugging.

In debug_xsb.c, wrote a Choice point stack printout routine with stuff needed for debugging clause/table gc.
----------------------------
revision 1.96
date: 2006/06/21 20:11:41;  author: dwarren;  state: Exp;  lines: +1 -1
*** empty log message ***
----------------------------
revision 1.95
date: 2006/06/19 23:46:23;  author: evansbj;  state: Exp;  lines: +7 -7
Hello Terry, I am pretty sure these are simple typos
----------------------------
revision 1.94
date: 2006/04/30 18:27:13;  author: tswift;  state: Exp;  lines: +19 -2

-- Put parentheses around retract-gc definitions to ensure
   correctness.  The engine had been delaying space reclamation and
   garbage collecting far too often, and this seems to fix that problem.

-- A little more thread-safety for token_xsb.c

-- Fixed bug with file_clone/3 that I introduced many moons ago.  The
problem was that I hadn't been giving names to console type files,
and file_clone used the file name in a string_find.  Now console
files have file names and things seem to work fine.
----------------------------
revision 1.93
date: 2006/04/27 21:08:47;  author: tswift;  state: Exp;  lines: +12 -2

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.92
date: 2006/04/24 15:41:16;  author: tswift;  state: Exp;  lines: +2 -1

Changes to make lists of delcfs both shared and private, so that space reclamation of dynamic clauses can occur when more than 1 thread is active.

Also, added reclamation of delcf and deltf frames for thread-private predicates upon exit of a thread.
----------------------------
revision 1.91
date: 2006/03/27 00:13:53;  author: tswift;  state: Exp;  lines: +2 -1

1) Split DelTF chain into private and shared chains.  This fixed
   a bug with table garbage collection, but also enabled me to
   allow garbage collection of a threads private tables when
   there is more than one active thread.

2) Extended the delay of space reclamation to abolished subgoals,
   and added subgoal reclamation to the table garbage collector.

I also added tests for these: lease update the various test
suites as the gc stuff may be a little brittle.
----------------------------
revision 1.90
date: 2006/03/18 17:37:49;  author: tswift;  state: Exp;  lines: +4 -1
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.89
date: 2006/03/17 18:17:59;  author: tswift;  state: Exp;  lines: +3 -3


Some updates to fix bugs in table abolishing and garbage
collecting.  Many of the changes have to do with refactoring code
to make it a little faster as well as to reduce bugs.

In addition, there are associated additional files in the test suite.

I'll be making more changes, and hopefully finishing over the weekend.
----------------------------
revision 1.88
date: 2006/03/06 22:45:33;  author: tswift;  state: Exp;  lines: +6 -1

Adjusted some mutexes in file io functions;

destroyed thread-private var strings before deallocating them, to avoid memory leaks.
----------------------------
revision 1.87
date: 2006/02/27 22:03:46;  author: tswift;  state: Exp;  lines: +15 -7
Some miscellaneous changes

1) abolish_table_pred now emits a warning when the table has a
   leaf node with a delay list -- this could cause dangling
   pointers for dependency checking.  Also, modified an error.

2) trie_interned now throws an exception, rather than exiting on
   an error case.

3) max_threads is now a command-line option

4) Added a new define NON_OPT_COMPILE, and memory mutexes are now
   used only with NON_OPT_COMPILE
----------------------------
revision 1.86
date: 2006/02/23 15:54:24;  author: dwarren;  state: Exp;  lines: +9 -6
A couple of minor casts or decls to quiet my complaining compiler.
----------------------------
revision 1.85
date: 2006/02/03 18:14:13;  author: tswift;  state: Exp;  lines: +48 -8

Added mechanisms to create threads with varying stack sizes, and to create
detached threads.
----------------------------
revision 1.84
date: 2006/01/29 22:46:05;  author: ruim;  state: Exp;  lines: +24 -1
changed the dispatch block to 256.
added predicates to change the initial stack sizes of threads.
----------------------------
revision 1.83
date: 2006/01/27 20:29:46;  author: tswift;  state: Exp;  lines: +3 -3

Some changes I recently made broke batched evaluation.  I backed out these changes to fix the batched test suite again.
----------------------------
revision 1.82
date: 2006/01/24 14:10:01;  author: tswift;  state: Exp;  lines: +3 -2

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.81
date: 2006/01/12 21:33:50;  author: tswift;  state: Exp;  lines: +19 -2
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.80
date: 2006/01/09 00:06:31;  author: tswift;  state: Exp;  lines: +64 -2
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.79
date: 2005/12/31 23:16:03;  author: tswift;  state: Exp;  lines: +9 -1

Fixed problems with throwing memory errors from mem_xxxoc(), at
least in sequential engine.  When memory cannot be malloced, a
resource error is thrown.  Since throwing errors mallocs memory
in itself, mem_xxxocs used by a throw are changed into
mem_xxxoc_nochecks and an xsb_exit is called if these functions
return NULL pointers.  Care is taken so that when a resource
error is thrown, space for its PSCs has been pre-allocated, and
varstrings are used for the actual message strings (varstring
exits too, if there is not enough memory).

In MT engine, a memory error just exits -- this is because I need
a CTXT to throw an error.  Right now, I'm not sure whether its a
good idea or not to put CTXTs into mem_xxxoc or not.

Not that some of the biggest memory allocations, such as tcp
stack, local-heap stack use straight reallocs and use their own
error handling.

In general, we should be handling most memory errors in a
reasonable, or at least consistent, manner.
----------------------------
revision 1.78
date: 2005/12/31 01:43:34;  author: tswift;  state: Exp;  lines: +18 -1
Changes to mutex handling for IO that should affect only the MT
engine. Rather than having a global IO mutex, I've added a mutex
for each stream, and used MUTEX_IO to lock the open_files array
itself.  This change was prompted by the fact that I can't have
one thread waiting on an input-stream via, say, a read and have
that thread create other threads that write to the output stream
and exit when done.

The result is that we no longer have contention when different
threads write to different streams.  At the same time, we end up
doing no more locking than before -- a little less, in fact due
to some manipulations in xsb_writ.P Unfortunately, the stream
mutexes are recursive (as with MUTEX_IO).  We can't get rid of
this until we rewrite write_term.

Now, back to handling memory_errors.
----------------------------
revision 1.77
date: 2005/12/29 20:06:43;  author: tswift;  state: Exp;  lines: +65 -36


Refactored init_machine() to include a new function
init_thread_structures() that includes all initializations that
need to be done on a per-thread basis.  Then mem_dealloc'ed all
thread-specific memory, including varstrings and such in
cleanup_tread_structures() (nee cleanup_machine()).  This change
should affect the MT engine only.

At this point, there should be no memory leaks simply for
creating a thread that exits -- apart from interaction with the
string table, etc.  Also, I'm not freeing space for dispatch
blocks for private predicates, which doesn't seem necessary
overall.  I suppose if we want to get rid of that space, the
reclamation should be done in one of the abolish predicates,
rather than xsb_thread_exit()?
----------------------------
revision 1.76
date: 2005/12/26 17:17:20;  author: tswift;  state: Exp;  lines: +3 -3
Added check for null pointers to mem_xxxoc() functions.  Thanks to our
now strict use of mem_xxxoc() functions, this means we always check
for null pointers returned by malloc.  Next thing you know, I'll be
rotating my tires every year.  If we do get a null pointer, we call a
non-ISO xsb_memory_error().

Updated documentation in exceptions.tex, and in the course of so doing
added some new ISO-error types to error_handler.P.  There are still
corresponding functions to be added to error_xsb.c Other documentation
for setof and other accumulated changes.

The other change was to get rid of a few stray references to
resume_compl_suspension_inst2.
----------------------------
revision 1.75
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +17 -17

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.74
date: 2005/11/20 21:23:28;  author: dwarren;  state: Exp;  lines: +3 -3
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.73
date: 2005/11/18 23:29:01;  author: tswift;  state: Exp;  lines: +3 -3

Took attv_interrupts array out of global area, and put it into
the thread context.  Also added, _gl suffix to realtime_count.

Other than that, just general documentation.
----------------------------
revision 1.72
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +28 -28
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.71
date: 2005/11/16 17:17:33;  author: ruim;  state: Exp;  lines: +5 -5
fix to walltime for multi-threaded engine
----------------------------
revision 1.70
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +6 -6


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.69
date: 2005/11/13 21:38:37;  author: dwarren;  state: Exp;  lines: +4 -2
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.68
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +15 -15
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.67
date: 2005/09/30 20:04:26;  author: ruim;  state: Exp;  lines: +2 -1
bugfixes for concurrent completion
----------------------------
revision 1.66
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;  lines: +5 -1
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.65
date: 2005/09/19 01:35:23;  author: tswift;  state: Exp;  lines: +38 -20

Documented and re-factored code -- moved some flag defs init init_flags()
to make this process a little easier to update when needed.
----------------------------
revision 1.64
date: 2005/09/16 00:56:41;  author: tswift;  state: Exp;  lines: +1 -3

Changes to make the storage module, which allows backtrackable updates, thread safe.  Storage "objects" (named interned tries) are private to each thread.
----------------------------
revision 1.63
date: 2005/09/13 15:21:11;  author: tswift;  state: Exp;  lines: +3 -3

Fixed problem in load_backsuite test.  It turned out that when I moved init_newtrie() from init_para to init_machine, I inadvertantly put it insize a MT ifdef.  Oops.  Anyway, now fixed.
----------------------------
revision 1.62
date: 2005/09/12 18:20:35;  author: tswift;  state: Exp;  lines: +4 -2

Some changes to move some info I put into a threads context into a function, so the info is no longer "global".  Also, fixed interned tries so that they are now thread-local.
----------------------------
revision 1.61
date: 2005/09/12 01:09:33;  author: tswift;  state: Exp;  lines: +2 -2

Tonight's changes were to clean up global data structures used to
clean up tries.  This time I was able to make data structures used in deleting
asserted and interned tries, local to the relevant function.  In addition,
I put into the MT context data structures used to manage an array of interned
tries.

Of course, there's more work to allow asserted and interned tries to be used in multi-threading -- but these changes will hopefully save us from one danger, at least.
----------------------------
revision 1.60
date: 2005/08/21 14:22:55;  author: ruim;  state: Exp;  lines: +3 -2
fix for concurrent completion
----------------------------
revision 1.59
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +4 -5
Made pflags thread private
----------------------------
revision 1.58
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +15 -14
made private flags array for sequential engine
----------------------------
revision 1.57
date: 2005/08/16 21:39:53;  author: dwarren;  state: Exp;  lines: +5 -1
Made subsumptive tables thread-safe with regard to global variables (I hope.)
So thread_private subsumptive tables should work.  No guarantees at all for
shared subsumptive tables.
----------------------------
revision 1.56
date: 2005/08/08 18:24:36;  author: dwarren;  state: Exp;  lines: +2 -1
Forgot to initialize clause_int to 0.
----------------------------
revision 1.55
date: 2005/08/08 17:11:33;  author: dwarren;  state: Exp;  lines: +6 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.54
date: 2005/07/18 21:54:10;  author: crojo;  state: Exp;  lines: +1 -2
*** empty log message ***
----------------------------
revision 1.53
date: 2005/07/15 15:02:31;  author: dwarren;  state: Exp;  lines: +7 -1
Made assert thread-safe (I hope.)  Problem was asserta, and I added
mutex_lock in jumptbreg when just entering asserted code, and I release
it after the code for the first clause to be executed is found and about
to be entered.  It introduces new instructions: dyntrymeelse, dynnoop, and
dynfail to release the lock.
assertz was made safe (I hope) without locks, by adding the new clause at the
end and then as the last thing, changing the opcode of the old-last clause
from dyntrust to retry.  Since dyntrust doesn't look at any argument, this
should work.
----------------------------
revision 1.52
date: 2005/07/13 09:21:59;  author: ruim;  state: Exp;  lines: +4 -4
small rationlization of tid initialization
----------------------------
revision 1.51
date: 2005/07/13 09:16:20;  author: ruim;  state: Exp;  lines: +4 -1
fixes in the sequence of deadlock detection
this time run the tests
----------------------------
revision 1.50
date: 2005/07/12 21:20:49;  author: dwarren;  state: Exp;  lines: +8 -1
Made the assert buffer local to a thread to reduce length of time required
to hold the lock when asserting.  Also, reordered some code to try to reduce
the time for race-conditions when asserting.
----------------------------
revision 1.49
date: 2005/07/12 15:54:24;  author: ruim;  state: Exp;  lines: +6 -3
added deadlock detection to shared completed tables
----------------------------
revision 1.48
date: 2005/07/11 19:47:20;  author: dwarren;  state: Exp;  lines: +3 -1
Made the random builtins thread-safe.  (But it doesn't look like there's any interface
from Prolog to them??)
----------------------------
revision 1.47
date: 2005/07/08 21:25:21;  author: dwarren;  state: Exp;  lines: +3 -0
More thread-safing: ptoc_longstring(!) and is_most_general_term.
----------------------------
revision 1.46
date: 2005/07/08 20:25:21;  author: dwarren;  state: Exp;  lines: +12 -1
More thread-safe making.  gettoken and read_canonical, this time.
----------------------------
revision 1.45
date: 2005/07/07 16:55:51;  author: dwarren;  state: Exp;  lines: +12 -1
Fixed fmt_read/write for multithreading.  Minor change to write_canonical (still NOT
thread-safe).
Added several (extensible) string buffers to context, since many builtins use
global string buffers.  Idea is to change those places to use these buffers.
They are implemented as varstring's.
----------------------------
revision 1.44
date: 2005/07/06 18:29:13;  author: dwarren;  state: Exp;  lines: +3 -1
FOr Multithreading: Made findall thread-safe by moving its static variables
to the thread structure.  Now each thread has its own chain of findall buffers.
----------------------------
revision 1.43
date: 2005/04/27 04:20:15;  author: evansbj;  state: Exp;  lines: +25 -11
Updated stderr and stdout redirection available via the -q parameter
----------------------------
revision 1.42
date: 2005/03/05 07:49:50;  author: kifer;  state: Exp;  lines: +3 -3
got rid of obvious compiler warnings
----------------------------
revision 1.41
date: 2005/02/04 16:56:13;  author: dwarren;  state: Exp;  lines: +20 -13
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.40
date: 2005/01/14 18:31:18;  author: ruim;  state: Exp;  lines: +88 -8
Integration of multithreaded system
----------------------------
revision 1.39
date: 2004/09/10 17:29:43;  author: tswift;  state: Exp;  lines: +9 -2

Main changes were to allow both pipes and atoms (strings) to be opened, closed, read,
written by ISO predicates.  Test suite works and playing around seems to work but I still
have to go through the I/O routines systematically.  So there will be more changes over the
next few days.

In addition, I also am starting to keep track of whether the stream is binary or not, although
I'm not yet doing anything with it.
----------------------------
revision 1.38
date: 2004/08/29 22:57:04;  author: tswift;  state: Exp;  lines: +10 -1

The following are the major changes.

1) Started adding checks to the ISO predicates, to make sure they are called with proper
Stream or alias terms, that are open and of the right mode.  All ISO stream predicates now
also allow aliases, by the way.

2) Made a first pass at stream_property/1, open/4, along with some other predicates.

3) Updated documentation.

More to come...
----------------------------
revision 1.37
date: 2004/08/24 16:26:27;  author: tswift;  state: Exp;  lines: +2 -1

1) Changed current_input and current_output to use integer streams in accordance w.
the new impl of streams.

2) Added some error checks for current_xxx for iso cases; also added current_prolog_flag,
which calls xsb flag (for now).

3) Made it so that we backtrace on error by default.
----------------------------
revision 1.36
date: 2004/08/20 18:11:35;  author: dwarren;  state: Exp;  lines: +2 -1
Added uniavar and bldavar WAM instructions for processing anonymous variables.
Fixed a bug in backtrace due to cpreg being used in compiling inline disjunctions
   and thus not pointing after a call WAM instruction.
Fixed initialization to put system-defined constants/predicates (in particular ,/2)
   into both the particular module (standard) AND in usermod.
----------------------------
revision 1.35
date: 2004/08/19 22:15:24;  author: tswift;  state: Exp;  lines: +9 -9

Changes for streams.  Here's hoping...
----------------------------
revision 1.34
date: 2004/03/05 00:58:22;  author: dwarren;  state: Exp;  lines: +33 -44
Cleaned up initialization of constant psc record pointers.  They should
be created in standard, not in usermod.
Also modified term_new_mod to tread mod1:mod2:term as mod1:term.
----------------------------
revision 1.33
date: 2004/01/14 20:27:12;  author: dwarren;  state: Exp;  lines: +6 -2
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.32
date: 2003/07/01 14:34:14;  author: lfcastro;  state: Exp;  lines: +6 -1
* New global variable
* New builtin globalvar/1, which returns THE global variable
----------------------------
revision 1.31
date: 2003/06/18 16:32:09;  author: lfcastro;  state: Exp;  lines: +3 -1
branches:  1.31.2;
* disable conget/conset and psc_prop on predicate PSC's
----------------------------
revision 1.30
date: 2003/04/16 17:34:06;  author: lfcastro;  state: Exp;  lines: +5 -5
Fix bug in last bugfix. ;)
----------------------------
revision 1.29
date: 2003/04/14 19:01:14;  author: lfcastro;  state: Exp;  lines: +15 -1
* Create code for true/0 in emu/init_xsb.c
  - fixes failure on attv_tests/interrupt1.P
----------------------------
revision 1.28
date: 2003/03/14 18:54:29;  author: dwarren;  state: Exp;  lines: +8 -1
Minor changes to create and use some "builtin" psc-addresses, rather than
re-insert every time one is needed.
----------------------------
revision 1.27
date: 2002/10/28 15:29:48;  author: lfcastro;  state: Exp;  lines: +1 -4
* Remove 'reset' instruction
----------------------------
revision 1.26
date: 2002/09/02 20:30:54;  author: kifer;  state: Exp;  lines: +2 -2
fixed typo in a comment
----------------------------
revision 1.25
date: 2002/05/22 15:41:14;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.25.2;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.24
date: 2002/03/15 09:19:50;  author: kifer;  state: Exp;  lines: +2 -2
renamed loader_defs.h to extensions.h
----------------------------
revision 1.23
date: 2002/03/13 10:17:47;  author: kifer;  state: Exp;  lines: +19 -13
replaced file extensions with defined preprocessor constants in preparation to
the objfile extension switch
----------------------------
revision 1.22
date: 2002/01/23 17:08:09;  author: dwarren;  state: Exp;  lines: +5 -1
branches:  1.22.2;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.21
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +4 -2
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.20
date: 2001/11/08 21:35:25;  author: dwarren;  state: Exp;  lines: +4 -4
Eliminated the indirection of *asynint_ptr and to directly use
asynint_val.  (Also a minor bug-fix in ptoc_longstring.)
----------------------------
revision 1.19
date: 2001/11/07 21:08:01;  author: dwarren;  state: Exp;  lines: +5 -4
I modified slightly the way interrupts are handled.  There had been a
couple of mechanisms, and I tried to consolidate them. I elimitaed
call_intercept and merged it in with *asynint_ptr. Now the keyboard
interrupt can be used for C-user-defined interrupts.  There is a new
variable asynint_code that can be set when an interrupt is signaled.
It is set to 0 by the system signal catcher.  To generate a
user-defined interrupt, you need to set the KEYINT_MARK bit of
*asynint_ptr and set asynint_code to your integer code.  Then when
this interrupt is fielded, it will call the keyboard interrupt handler
(set by set_inthandler imported from loader) which is a two argument
predicate.  When it is called, the first argument will be the goal to
call when continuing out of the interrupt; the second argument will be
the value of asynint_code.
----------------------------
revision 1.18
date: 2001/07/16 05:15:37;  author: kifer;  state: Exp;  lines: +2 -2
added USERMOD_PSC constant
----------------------------
revision 1.17
date: 2001/05/24 17:54:52;  author: lfcastro;  state: Exp;  lines: +4 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.16
date: 2001/04/20 15:30:51;  author: dwarren;  state: Exp;  lines: +9 -6
Change setvbuf calls to setbuf calls to set no-buffering.  Supposedly
setvbuf is newer and setbuf calls setvbuf, but -no-cygwin doesn't work
with setvbuf but does with setbuf...
----------------------------
revision 1.15
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +8 -4
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.14
date: 2000/06/22 19:40:31;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.14.2;
added casts to malloc calls to avoid warnings in C++
----------------------------
revision 1.13
date: 2000/05/20 06:56:02;  author: kifer;  state: Exp;  lines: +4 -4
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.12
date: 2000/05/06 21:22:48;  author: kifer;  state: Exp;  lines: +8 -5
Switched default GC to copying.
Added gc to the xsb banner.
----------------------------
revision 1.11
date: 2000/03/01 16:22:34;  author: dwarren;  state: Exp;  lines: +5 -4
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.10
date: 2000/02/22 22:38:03;  author: dwarren;  state: Exp;  lines: +11 -1
Extrended interface so that it could interact with VB, and
particularly the MR application.  Also added an option -q to send all
I/O to files (for use when XSB is being used as a backen server.)
----------------------------
revision 1.9
date: 2000/02/04 03:50:04;  author: kifer;  state: Exp;  lines: +5 -7
Got rid of ifdef NT that unbuffers stdmsg. Reason: cygwin also needs it,
and line buffering for stdmsg doesn't seem harmful.
----------------------------
revision 1.8
date: 2000/01/07 08:51:35;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.7
date: 1999/11/21 05:46:32;  author: kifer;  state: Exp;  lines: +16 -8
Allow multiple -e command line options
----------------------------
revision 1.6
date: 1999/11/17 03:54:29;  author: kifer;  state: Exp;  lines: +2 -2
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.5
date: 1999/11/16 19:05:55;  author: kifer;  state: Exp;  lines: +5 -2
Revamped sockets interface.
----------------------------
revision 1.4
date: 1999/11/04 23:01:25;  author: cbaoqiu;  state: Exp;  lines: +3 -3
1) Moved the counter of the attv interrupts from the first word in the
   heap to `interrupt_counter';
2) Trail the content of array attv_interrupts[][] using pre_image
   trail (as what we did for the interrupt counter);
3) Do not use ATTVINT_MARK and *asynint_ptr to detect attv interrupts.
   Use *interrupt_reg directly (because *asynint_ptr is not trailed
   using pre_image trail).
----------------------------
revision 1.3
date: 1999/10/27 14:15:47;  author: kostis;  state: Exp;  lines: +23 -24
Minor clean up thingy.
----------------------------
revision 1.2
date: 1999/10/26 06:47:07;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:58:29;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.14.2.5
date: 2001/01/07 00:32:50;  author: ruim;  state: Exp;  lines: +0 -4
fixes
----------------------------
revision 1.14.2.4
date: 2001/01/06 18:43:05;  author: ruim;  state: Exp;  lines: +13 -2
Initialization data made static and other small changes
----------------------------
revision 1.14.2.3
date: 2000/12/29 20:14:08;  author: tswift;  state: Exp;  lines: +4 -1

Flags for MT engine; this may change, and it may be better to put this
info into xsb_configuration/2, but for now...
----------------------------
revision 1.14.2.2
date: 2000/12/19 15:58:16;  author: ruim;  state: Exp;  lines: +4 -1
Flags are now copied into threads
----------------------------
revision 1.14.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +33 -4
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.22.2.3
date: 2004/11/22 23:07:34;  author: ruim;  state: Exp;  lines: +3 -3
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.22.2.2
date: 2004/10/18 20:46:05;  author: ruim;  state: Exp;  lines: +49 -18
update for version 2.6.1
----------------------------
revision 1.22.2.1
date: 2004/09/29 19:44:16;  author: ruim;  state: Exp;  lines: +86 -6
Sources from rfm repository
----------------------------
revision 1.25.2.6
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +6 -1
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.25.2.5
date: 2003/04/17 17:11:45;  author: lfcastro;  state: Exp;  lines: +22 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.25.2.4
date: 2002/10/28 16:49:30;  author: lfcastro;  state: Exp;  lines: +1 -4
* Merge with HEAD
----------------------------
revision 1.25.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +5 -0
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.25.2.2
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +1 -6
* update to HEAD
----------------------------
revision 1.25.2.1
date: 2002/07/31 20:13:46;  author: lfcastro;  state: Exp;  lines: +6 -1
* demand_once/1 predicate cuts over tables, deleting incomplete tables
whose producer is in the scope of the "cut" (preliminary version)
----------------------------
revision 1.31.2.1
date: 2003/09/11 13:48:09;  author: tschrijvers;  state: Exp;  lines: +6 -1
Changed the emulator in the following way:
- term_new_mod/3 builtin from to copy a term
  to a term in a different module
- globalvar builtin that provides one global variable
- changed behavior of get_attributes and put_attributes:
  attribute value can be anything, not just a vector
- replace pre-unification interrupt handling of attributed variables
  to post-unification handling
----------------------------
revision 1.158.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.158.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +2 -0
no message
----------------------------
revision 1.158.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/inst.c,v
Working file: inst.c
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.13
	without-attv: 1.13
	release-2-0: 1.10
	pre-release-2-0: 1.9
	v1-9-8: 1.5
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.14
date: 1999/10/26 06:47:08;  author: kifer;  state: dead;  lines: +1 -1
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.13
date: 1999/08/09 00:34:23;  author: kifer;  state: Exp;  lines: +3 -2
Added process control builtins, deprecated unix.P,
added C preprocessor.
----------------------------
revision 1.12
date: 1999/07/13 10:11:06;  author: unova;  state: Exp;  lines: +2 -1
Added trie_root instruction. to instruction table.
----------------------------
revision 1.11
date: 1999/07/06 16:35:11;  author: ejohnson;  state: Exp;  lines: +2 -1
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.10
date: 1999/05/18 16:09:08;  author: warren;  state: Exp;  lines: +3 -3
Changed instruction names lshiftl and lshiftr to logshiftl and
logshiftr respectively.  This makes them consistent with the names in
the compiler, and more importantly avoids a name clash with a function
included in dl.h under solaris 2.5.1/gcc.
----------------------------
revision 1.9
date: 1999/04/23 19:41:56;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Added instruction `reset' and changed xsb_segfault_catcher(), so that
both xsb_segfault_catcher() and xsb_abort() longjmp to `case reset' in
emuloop.c.  Seg fault handler is now nicer.
----------------------------
revision 1.8
date: 1999/03/17 18:34:44;  author: kostis;  state: Exp;  lines: +3 -186
Changes to separate out all builtin #defines from "inst.h" and have them
appear in a new file called "builtin.h".
----------------------------
revision 1.7
date: 1999/03/06 03:34:49;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Added builtin force_truth_value/2.
----------------------------
revision 1.6
date: 1999/02/25 18:12:02;  author: kostis;  state: Exp;  lines: +169 -153
Added a function that Bart needs for exception handling.
----------------------------
revision 1.5
date: 1999/01/19 18:50:59;  author: kostis;  state: Exp;  lines: +1 -3
Fixed foreign language interface bug on Linux and did a major cleanup.
----------------------------
revision 1.4
date: 1999/01/13 18:19:11;  author: kostis;  state: Exp;  lines: +9 -10
Changes related to printing of WAM stacks.  Corresponding predicates made
builtins and added in machine.P.
----------------------------
revision 1.3
date: 1999/01/10 01:05:02;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Change builtin GET_LASTNODE_AND_RETSKEL to GET_LASTNODE_CS_RETSKEL.
----------------------------
revision 1.2
date: 1998/12/21 01:08:26;  author: cbaoqiu;  state: Exp;  lines: +24 -24
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/inst.h,v
Working file: inst.h
head: 1.18
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.17
	without-attv: 1.15
	release-2-0: 1.14
	pre-release-2-0: 1.12
	v1-9-8: 1.7
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 19;	selected revisions: 19
description:
----------------------------
revision 1.18
date: 1999/10/26 06:47:10;  author: kifer;  state: dead;  lines: +1 -1
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.17
date: 1999/10/12 20:21:05;  author: ejohnson;  state: Exp;  lines: +7 -1
Added ifdef to prevent multiple inclusions.
----------------------------
revision 1.16
date: 1999/10/09 02:00:27;  author: cbaoqiu;  state: Exp;  lines: +6 -1
Changes for attributed variables (first step).
----------------------------
revision 1.15
date: 1999/07/06 16:35:12;  author: ejohnson;  state: Exp;  lines: +4 -1
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.14
date: 1999/05/18 16:09:09;  author: warren;  state: Exp;  lines: +3 -3
Changed instruction names lshiftl and lshiftr to logshiftl and
logshiftr respectively.  This makes them consistent with the names in
the compiler, and more importantly avoids a name clash with a function
included in dl.h under solaris 2.5.1/gcc.
----------------------------
revision 1.13
date: 1999/05/17 17:20:51;  author: unova;  state: Exp;  lines: +2 -2
Moved reset_inst to init.c and aligned it to word
(must for the -t option in some machines)
----------------------------
revision 1.12
date: 1999/04/23 19:41:57;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Added instruction `reset' and changed xsb_segfault_catcher(), so that
both xsb_segfault_catcher() and xsb_abort() longjmp to `case reset' in
emuloop.c.  Seg fault handler is now nicer.
----------------------------
revision 1.11
date: 1999/03/18 01:23:28;  author: cbaoqiu;  state: Exp;  lines: +9 -2
Changed instruction number of new_answer_dealloc to 0xcf (207), rename
the original new_answer_dealloc to old_new_answer_dealloc.
----------------------------
revision 1.10
date: 1999/03/17 18:34:45;  author: kostis;  state: Exp;  lines: +1 -206
Changes to separate out all builtin #defines from "inst.h" and have them
appear in a new file called "builtin.h".
----------------------------
revision 1.9
date: 1999/03/06 03:34:51;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Added builtin force_truth_value/2.
----------------------------
revision 1.8
date: 1999/02/22 16:56:52;  author: workflow;  state: Exp;  lines: +3 -1
nr stuff
----------------------------
revision 1.7
date: 1999/02/03 16:07:11;  author: workflow;  state: Exp;  lines: +1 -3
rollback.
rollback
----------------------------
revision 1.6
date: 1999/02/03 11:14:15;  author: workflow;  state: Exp;  lines: +3 -1
*** empty log message ***
----------------------------
revision 1.5
date: 1999/01/19 18:50:57;  author: kostis;  state: Exp;  lines: +2 -6
Fixed foreign language interface bug on Linux and did a major cleanup.
----------------------------
revision 1.4
date: 1999/01/13 18:19:13;  author: kostis;  state: Exp;  lines: +10 -10
Changes related to printing of WAM stacks.  Corresponding predicates made
builtins and added in machine.P.
----------------------------
revision 1.3
date: 1999/01/10 01:05:04;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Change builtin GET_LASTNODE_AND_RETSKEL to GET_LASTNODE_CS_RETSKEL.
----------------------------
revision 1.2
date: 1998/12/21 01:08:28;  author: cbaoqiu;  state: Exp;  lines: +24 -17
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/inst_xsb.c,v
Working file: inst_xsb.c
head: 1.23
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.22
	ROLLBACK: 1.17
	latest_plus_supp_branch: 1.17.0.4
	latest_plus_supp: 1.17
	Version_3dot2_plus_supp: 1.17.0.2
	release_2_6_plus_supp: 1.14.0.6
	Version_3dot2: 1.17
	dec07-perf-results: 1.17
	mt_thesis: 1.16
	release_3_0: 1.16
	release_2_7_0: 1.14
	multi-threaded-26-engine: 1.13.4.2
	pre-mt: 1.14
	multi-threaded-25-engine-done: 1.13.4.1
	multi-threaded-25-engine: 1.13.0.4
	release_2_6_1: 1.14
	release_2_6_final: 1.14
	release_2_6: 1.14.0.4
	last-merged-to-demand: 1.14
	demand_branch: 1.14.0.2
	before_removing_chat: 1.13
	release_2_5: 1.13
	pre-merge-slgwam-gc: 1.13
	multi-threaded-c-engine: 1.13.0.2
	release_2_4: 1.12
	release_2_3: 1.10
	multi-threaded-engine: 1.10.0.2
	pre-threading: 1.9
	release-2-2: 1.8
	chat-and-local: 1.8.0.2
	xsb-pre-cleanup: 1.8
	release-2-1: 1.3
	release-2-0-1: 1.3
keyword substitution: kv
total revisions: 30;	selected revisions: 30
description:
----------------------------
revision 1.23
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.22
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.21
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.20
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.19
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
branches:  1.17.4;
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.16
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +3 -2


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.15
date: 2005/01/14 18:31:18;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.14
date: 2002/05/20 17:47:09;  author: tswift;  state: Exp;  lines: +22 -6

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.13
date: 2001/09/21 15:01:15;  author: tswift;  state: Exp;  lines: +2 -1
branches:  1.13.4;

Updates to profile amount of trapped Prolog choice points (if any) in SLGWAM
----------------------------
revision 1.12
date: 2001/06/21 19:07:59;  author: tswift;  state: Exp;  lines: +9 -3

Added profiling info and traces of SCC shapes.
----------------------------
revision 1.11
date: 2001/05/24 17:54:52;  author: lfcastro;  state: Exp;  lines: +3 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.10
date: 2000/06/22 01:27:50;  author: lfcastro;  state: Exp;  lines: +9 -168
branches:  1.10.2;
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.9
date: 2000/05/20 06:56:02;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.8
date: 2000/03/01 16:22:34;  author: dwarren;  state: Exp;  lines: +3 -1
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.7
date: 2000/02/29 18:43:35;  author: tswift;  state: Exp;  lines: +1 -2

Small changes to take out userfunc
----------------------------
revision 1.6
date: 2000/01/07 08:51:36;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/12/22 15:06:28;  author: kostis;  state: Exp;  lines: +5 -6
Fixed small copy-paste bug of Baoqiu :-)
----------------------------
revision 1.4
date: 1999/12/22 05:10:13;  author: cbaoqiu;  state: Exp;  lines: +3 -1
Added changes to support attributed variables in assert.
----------------------------
revision 1.3
date: 1999/10/30 00:00:39;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Added an instruction `check_interrupt'.  This instruction is used
*just before* the `new_answer_dealloc' to handle the pending attv
interrupts (before we put an answer into the answer table).
----------------------------
revision 1.2
date: 1999/10/29 12:55:57;  author: kostis;  state: Exp;  lines: +15 -14
Fixed definition of new_answer_dealloc and some other minor stuff...
----------------------------
revision 1.1
date: 1999/10/26 06:47:11;  author: kifer;  state: Exp;
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.10.2.2
date: 2000/12/19 15:58:16;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.10.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.13.4.2
date: 2004/10/18 20:46:05;  author: ruim;  state: Exp;  lines: +22 -6
update for version 2.6.1
----------------------------
revision 1.13.4.1
date: 2004/09/29 19:44:16;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.17.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.17.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.17.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/inst_xsb.h,v
Working file: inst_xsb.h
head: 1.43
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.37
	ROLLBACK: 1.32
	latest_plus_supp_branch: 1.32.0.4
	latest_plus_supp: 1.32
	Version_3dot2_plus_supp: 1.32.0.2
	release_2_6_plus_supp: 1.12.0.4
	Version_3dot2: 1.32
	dec07-perf-results: 1.28
	mt_thesis: 1.22
	release_3_0: 1.21
	release_2_7_0: 1.14
	multi-threaded-26-engine: 1.11.6.3
	pre-mt: 1.14
	multi-threaded-25-engine-done: 1.11.6.1
	multi-threaded-25-engine: 1.11.0.6
	release_2_6_1: 1.12
	release_2_6_final: 1.12
	release_2_6: 1.12.0.2
	last-merged-to-demand: 1.11
	demand_branch: 1.11.0.4
	before_removing_chat: 1.11
	release_2_5: 1.11
	pre-merge-slgwam-gc: 1.11
	multi-threaded-c-engine: 1.11.0.2
	release_2_4: 1.11
	release_2_3: 1.9
	multi-threaded-engine: 1.8.0.2
	pre-threading: 1.7
	release-2-2: 1.7
	chat-and-local: 1.7.0.2
	xsb-pre-cleanup: 1.7
	release-2-1: 1.4
	release-2-0-1: 1.4
keyword substitution: kv
total revisions: 53;	selected revisions: 53
description:
----------------------------
revision 1.43
date: 2012/06/04 15:59:24;  author: dwarren;  state: Exp;  lines: +3 -2
Added unindexed profiling.
----------------------------
revision 1.42
date: 2012/02/19 19:17:55;  author: tswift;  state: Exp;  lines: +2 -3

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.41
date: 2011/12/14 22:40:26;  author: dwarren;  state: Exp;  lines: +2 -1
Added fdivreg instruction for div operation.
----------------------------
revision 1.40
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.39
date: 2011/01/09 21:00:44;  author: dwarren;  state: Exp;  lines: +5 -5
Changed xwam instruction codes for the variant_trie_* cp management
instructions.  Code assumes these kinds of instructions start on a 0 mod 4
boundary, and these didn't.  Bug showed up in delete_branch.
----------------------------
revision 1.38
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +9 -4

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.37
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.36
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.35
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.34
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.33
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.32
date: 2008/02/16 18:00:42;  author: dwarren;  state: Exp;  lines: +4 -1
branches:  1.32.4;
Add new instructions putdfloat and getdfloat to handle double floats.
Update the loader to load these instructions from the xwam files.
(There is a possible problem.  The doubles are written into the xwam
file as bitstrings, and read by the loader as the same bitstring.  If
representations on different machines are different, then xwam files
compiled on one system won't run on another.)
----------------------------
revision 1.31
date: 2008/02/04 03:59:53;  author: dwarren;  state: Exp;  lines: +2 -1
Add a new xwam instruction,cmpreg, replaces subreg for comparisons
to avoid overflow problems.  Now minint is less than maxint....
----------------------------
revision 1.30
date: 2008/01/30 16:03:03;  author: dwarren;  state: Exp;  lines: +3 -1
Added a new instruction for adding (or subtracting) small integers.
This allows a somewhat more efficient compilation of arithmetic,
for the common case of incrementing or decrementing a value.
----------------------------
revision 1.29
date: 2008/01/03 18:45:20;  author: dwarren;  state: Exp;  lines: +2 -1
Added new mega-instruction: getkpvars, which codes for multiple getpvar's.
Since the compiler generates a sequence of getpvar's of consecutively
increasing register numbers and increasing local variable locations for
heads that have distinct variables that are all permanent variables, this
instruction can be used quite often (as can be seen by the number of
.xwam files that have changed.)  The form is getkpvars(K,V,R) which
codes for K getpvar's with the V and R increasing by one each time.
----------------------------
revision 1.28
date: 2007/10/28 23:32:35;  author: tswift;  state: Exp;  lines: +3 -2


Added evaluable functions **/2 and sign/1, which were in the core standard.

Added an evaluable xor function ></2 which is in the revision.

Rewrote arithmetic_abort to give evaluation errors and instantiation
errors, making us a little more compliant.  We still aren't reporting
underflows or overflows, so we do deviate from the standard in this
respect.
----------------------------
revision 1.27
date: 2007/09/28 18:20:13;  author: dwarren;  state: Exp;  lines: +3 -1
This change causes attv interrupts to be handled before cuts.
(It also fixes a bug in the previous checkin to handle attv
interrupts before trymeorelse instructions.)
All the xwam files are changed since this involved generating a
new instruction(s) putpbreg (and the temp version) for cuts that have
parameters for ARsize and NumRegsInUse which are needed if an
interrupt is pending and is to be handled.
Sitll to be done is to figure out how to handle interrupts before
trie_try-type instructions that do unification when retrieving
from tries.
----------------------------
revision 1.26
date: 2007/09/26 20:15:22;  author: dwarren;  state: Exp;  lines: +3 -1
This update modifies the trymeorelse instruction (which implements
disjunctions, including if-then-else) to include a check for pending
attv interrupts, and handling them if there are any.  The problem is
that to handle interrupts, the environment must be known and there
must be a "call"-like instruction that allows called routines to find
the size of the parents AR.  This is done here by having the
trymeorelse instruction (when there is a pending interrupt) create
an environment and then branch to a 2-instruction sequence of
check_interrupt,restore_dealloc_proceed.  This last instruction is
new, and it restores registers (if nec, but here it's not since no
registers are active at a trymeorelse), pops the environment and
returns to the original caller, which in this case causes the trymeorelse
instruction to be executed again.
----------------------------
revision 1.25
date: 2007/03/23 18:13:27;  author: dwarren;  state: Exp;  lines: +1 -0
Improved fix to compiler to generate instruction to test heap when
necessary on clause return.
----------------------------
revision 1.24
date: 2007/03/16 20:40:31;  author: dwarren;  state: Exp;  lines: +3 -0
Add new mega-xwam-instructions to compile "abc"-type strings more
efficiently.  This changes almost(?) all xwam files.
The implementation at this point is just thru the peephole
optimizer.  The next step is to change the way the compiler
processes these strings to speed up compilation.
----------------------------
revision 1.23
date: 2007/03/15 21:30:45;  author: dwarren;  state: Exp;  lines: +2 -1
Add new instruction, deallocate_gc, that tests for stack overflow.  Fixes
a bug in which there is a deep recursion, and terms are built on the heap
on returning back up the call stack.  There are no heap-checks in such a
loop and so we can get stack overflow, without this check.
----------------------------
revision 1.22
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +2 -2
Incremental Code Added.
----------------------------
revision 1.21
date: 2006/01/27 17:50:19;  author: dwarren;  state: Exp;  lines: +2 -1
Added a new instruction to implement unary tests that don't change
the XWAM state.  Examples are integer/1, atom/1, etc.  The compiler
is changed to use these instructions to avoid laying down a choicepoint
in a conditional, and they are used for regular inline calls.
----------------------------
revision 1.20
date: 2005/12/12 00:19:12;  author: tswift;  state: Exp;  lines: +2 -2

Mutexed socket calls which dont seem to be mutexed.  Also added a
mutex around some rarely used string/symbol table statistics.

Other than that, documentation.
----------------------------
revision 1.19
date: 2005/09/02 20:43:13;  author: tswift;  state: Exp;  lines: +2 -1

Fix to abolish_table_xxx and gc_tables to work when stacks are frozen;
and made creation of DelTF frames thread-safe.  Also, got a little
further towards reclaiming retracted clauses.

----------------------------------------------------------------------
builtin.c emuloop.c extensions_xsb.h inst_xsb.h CVS: std_cases_xsb_i.h
tr_utils.c xsb_inst_list.h CVS:
----------------------------------------------------------------------
----------------------------
revision 1.18
date: 2005/08/08 17:11:33;  author: dwarren;  state: Exp;  lines: +2 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.17
date: 2005/07/15 15:02:32;  author: dwarren;  state: Exp;  lines: +5 -1
Made assert thread-safe (I hope.)  Problem was asserta, and I added
mutex_lock in jumptbreg when just entering asserted code, and I release
it after the code for the first clause to be executed is found and about
to be entered.  It introduces new instructions: dyntrymeelse, dynnoop, and
dynfail to release the lock.
assertz was made safe (I hope) without locks, by adding the new clause at the
end and then as the last thing, changing the opcode of the old-last clause
from dyntrust to retry.  Since dyntrust doesn't look at any argument, this
should work.
----------------------------
revision 1.16
date: 2005/03/08 22:21:57;  author: tswift;  state: Exp;  lines: +5 -1

Two changes for compatability

1) Changed consult/compile to use .pl and XSB_SRC_EXTENSION (.P) files interchangably, with
preference for XSB_SRC_EXTENSION files.  .pl files are handled as are XSB_SRC_EXTENSION
files, compared to XSB_OBJECT_EXTENSION (.xwam) files used with .H files,etc.  However if
there is a .P file the .pl wont be examined (even if the .pl file is newer)

Unlike the extensions .pl is hard-wired -- as this is what other Prologs mostly use.

2) added min and max as first-class arithmetic functions, so you can now have expresions
like

X is 3*max(Y,min(Z,W+1))

if you want.  Min/max is useful for reading files written for other Prologs, as well as for
full clpqr.  I introduced two new instructions for these -- I might have gotten away with
one.
----------------------------
revision 1.15
date: 2005/01/14 18:31:18;  author: ruim;  state: Exp;  lines: +5 -2
Integration of multithreaded system
----------------------------
revision 1.14
date: 2004/08/20 18:11:35;  author: dwarren;  state: Exp;  lines: +4 -1
Added uniavar and bldavar WAM instructions for processing anonymous variables.
Fixed a bug in backtrace due to cpreg being used in compiling inline disjunctions
   and thus not pointing after a call WAM instruction.
Fixed initialization to put system-defined constants/predicates (in particular ,/2)
   into both the particular module (standard) AND in usermod.
----------------------------
revision 1.13
date: 2004/03/08 13:56:28;  author: dwarren;  state: Exp;  lines: +3 -1
Added new instruction to compile new @= operator.
----------------------------
revision 1.12
date: 2002/10/28 15:29:48;  author: lfcastro;  state: Exp;  lines: +1 -2
* Remove 'reset' instruction
----------------------------
revision 1.11
date: 2001/06/21 19:07:59;  author: tswift;  state: Exp;  lines: +2 -1
branches:  1.11.4;  1.11.6;

Added profiling info and traces of SCC shapes.
----------------------------
revision 1.10
date: 2001/05/24 17:54:52;  author: lfcastro;  state: Exp;  lines: +2 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.9
date: 2001/02/06 16:56:36;  author: lfcastro;  state: Exp;  lines: +2 -1
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.8
date: 2000/06/22 01:27:51;  author: lfcastro;  state: Exp;  lines: +6 -3
branches:  1.8.2;
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.7
date: 2000/03/01 16:22:34;  author: dwarren;  state: Exp;  lines: +3 -1
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.6
date: 2000/02/29 18:43:35;  author: tswift;  state: Exp;  lines: +1 -2

Small changes to take out userfunc
----------------------------
revision 1.5
date: 1999/12/22 05:10:13;  author: cbaoqiu;  state: Exp;  lines: +4 -1
Added changes to support attributed variables in assert.
----------------------------
revision 1.4
date: 1999/11/03 21:35:46;  author: cbaoqiu;  state: Exp;  lines: +8 -9
Kostis' changes to support long atoms in compiled code.
----------------------------
revision 1.3
date: 1999/10/30 00:00:39;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Added an instruction `check_interrupt'.  This instruction is used
*just before* the `new_answer_dealloc' to handle the pending attv
interrupts (before we put an answer into the answer table).
----------------------------
revision 1.2
date: 1999/10/28 10:21:16;  author: kostis;  state: Exp;  lines: +31 -38
Removed unused instructions and changed numbers to some in order to
eventually make the cut-check efficient.
----------------------------
revision 1.1
date: 1999/10/26 06:47:12;  author: kifer;  state: Exp;
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.8.2.2
date: 2000/12/19 15:58:16;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.8.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.11.6.3
date: 2004/11/04 22:31:14;  author: tswift;  state: Exp;  lines: +2 -2

Changes for compilation in cygwin.  This will not affect the linux distribution (I hope).
Changes are:

	1) execute -> xsb_execute, to avoid conflict with pthread.h in cygwin
	2) Renamed mutex constants to accord with pthread.h in cygwin.
----------------------------
revision 1.11.6.2
date: 2004/10/18 20:46:05;  author: ruim;  state: Exp;  lines: +1 -2
update for version 2.6.1
----------------------------
revision 1.11.6.1
date: 2004/09/29 19:44:16;  author: ruim;  state: Exp;  lines: +4 -1
Sources from rfm repository
----------------------------
revision 1.11.4.2
date: 2003/04/17 17:11:45;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.11.4.1
date: 2002/10/28 16:49:30;  author: lfcastro;  state: Exp;  lines: +1 -2
* Merge with HEAD
----------------------------
revision 1.32.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.32.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.32.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/interprolog_callback.c,v
Working file: interprolog_callback.c
head: 1.29
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.22
	ROLLBACK: 1.18
	latest_plus_supp_branch: 1.18.0.4
	latest_plus_supp: 1.18
	Version_3dot2_plus_supp: 1.18.0.2
	release_2_6_plus_supp: 1.7.0.4
	Version_3dot2: 1.18
	dec07-perf-results: 1.18
	mt_thesis: 1.16
	release_3_0: 1.16
	release_2_7_0: 1.9
	multi-threaded-26-engine: 1.4.2.1
	pre-mt: 1.9
	multi-threaded-25-engine-done: 1.4
	multi-threaded-25-engine: 1.4.0.2
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.2
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.4
	release_2_5: 1.4
keyword substitution: kv
total revisions: 34;	selected revisions: 34
description:
----------------------------
revision 1.29
date: 2011/08/15 16:20:30;  author: dwarren;  state: Exp;  lines: +3 -3
Minor, minor type change.
----------------------------
revision 1.28
date: 2011/08/15 15:10:25;  author: dwarren;  state: Exp;  lines: +9 -8
Minor changes to quiet 64-bit compilation (or use 64-bit compatible decls).
Minor change to tokenizer to make it more standardish(?) for \NUM form.
One decl moved to work with ANSI C (MSVC).
----------------------------
revision 1.27
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +1 -8
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.26
date: 2011/05/31 15:16:26;  author: dwarren;  state: Exp;  lines: +316 -298
Added Miguel's changes:
1) added JNI debug option for debugging.
2) Fixed some declarations to prolog_term (for consistency and 64-bit)
3) Fixed xsb_init call to be OK for MT
----------------------------
revision 1.25
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +0 -13
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.24
date: 2011/03/23 17:25:44;  author: dwarren;  state: Exp;  lines: +9 -9
Changed buffer name to avoid re-use of same variable for different function;
just for code clarity.
----------------------------
revision 1.23
date: 2011/03/23 15:45:19;  author: dwarren;  state: Exp;  lines: +8 -5
Fixed bug in interprolog_callback in reuse and deallocation of a byte buffer.
Now interprolog works on Windows 7.
Added missing deref to std_pred_xsb_i.h
Added condition on definition of fileno, so avoid redefinition warnings.
----------------------------
revision 1.22
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.21
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.20
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.19
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.18
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +1 -0
branches:  1.18.4;
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.17
date: 2007/02/09 18:12:17;  author: dwarren;  state: Exp;  lines: +2 -2
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.16
date: 2005/12/17 02:46:32;  author: dwarren;  state: Exp;  lines: +5 -5
Fixed accumulated missing casts.  MSVC compiles it now without complaint.
----------------------------
revision 1.15
date: 2005/12/12 18:44:53;  author: dwarren;  state: Exp;  lines: +1 -1
Added string table garbage collection.
----------------------------
revision 1.14
date: 2005/11/20 21:23:28;  author: dwarren;  state: Exp;  lines: +6 -6
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.13
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +10 -10
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.12
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +10 -9
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.11
date: 2005/07/20 20:52:16;  author: dwarren;  state: Exp;  lines: +1 -0
Add a missing free.
----------------------------
revision 1.10
date: 2005/06/29 13:58:15;  author: vidrevich;  state: Exp;  lines: +53 -37
incorporating multi-threading into C/XSB interface. In multi-threaded engine xsb_init() takes a pointer to the thread context structure as its first argument and populates that structure with main thread context information to be used in the consequent C/XSB calls. myargc,myargv are passed as the second and the third arguments to the xsb_init() when XSB is configured for multi-threading. Changes should not affect a single-threaded version.
----------------------------
revision 1.9
date: 2004/01/19 22:08:11;  author: dwarren;  state: Exp;  lines: +20 -14
Update so that it works under both cygwin and MSVC.
----------------------------
revision 1.8
date: 2004/01/16 20:53:30;  author: dwarren;  state: Exp;  lines: +31 -0
Added capability to pass arguments to xsb executable when starting xsb
from java.
----------------------------
revision 1.7
date: 2002/11/04 18:09:01;  author: dwarren;  state: Exp;  lines: +2 -2
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.6
date: 2002/07/01 16:09:51;  author: dwarren;  state: Exp;  lines: +1 -0
branches:  1.6.2;
Add overflow check to interprolog operation that constructs lists on heap.
(But can't find a way to cause the overflow, so it might not work if/when
an overflow actually occurs.  But I thought I'd put it in just in case.)
----------------------------
revision 1.5
date: 2002/06/24 18:56:29;  author: dwarren;  state: Exp;  lines: +251 -238
Add check for overflow and expand heap/local stack if necessary.
----------------------------
revision 1.4
date: 2002/02/25 18:44:22;  author: dwarren;  state: Exp;  lines: +1 -1
branches:  1.4.2;
Tanya's changes for configuring for interprolog on windows.
----------------------------
revision 1.3
date: 2002/02/22 16:41:23;  author: tswift;  state: Exp;  lines: +1 -1
Changed which header file it calls.
----------------------------
revision 1.2
date: 2002/02/21 21:20:40;  author: tswift;  state: Exp;  lines: +18 -3
Another iteration towards interprolog integration.
----------------------------
revision 1.1
date: 2002/02/18 04:03:38;  author: tswift;  state: Exp;
Initial version of interprolog files
----------------------------
revision 1.4.2.1
date: 2004/10/18 20:46:06;  author: ruim;  state: Exp;  lines: +252 -238
update for version 2.6.1
----------------------------
revision 1.6.2.1
date: 2003/02/11 18:36:21;  author: lfcastro;  state: Exp;  lines: +2 -2
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.18.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.18.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.18.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/interprolog_xsb.h,v
Working file: interprolog_xsb.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.2.0.8
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.6.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.6.1
	multi-threaded-25-engine: 1.2.0.6
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.4
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.2
	before_removing_chat: 1.2
	release_2_5: 1.2
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2005/01/14 18:31:18;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.3.4;
Integration of multithreaded system
----------------------------
revision 1.2
date: 2002/02/21 21:20:40;  author: tswift;  state: Exp;  lines: +4 -2
branches:  1.2.6;
Another iteration towards interprolog integration.
----------------------------
revision 1.1
date: 2002/02/18 04:03:38;  author: tswift;  state: Exp;
Initial version of interprolog files
----------------------------
revision 1.2.6.1
date: 2004/09/29 19:44:16;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/interprolog_xsb_i.h,v
Working file: interprolog_xsb_i.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.1.0.8
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.6.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.6.1
	multi-threaded-25-engine: 1.1.0.6
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.4
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.2
	before_removing_chat: 1.1
	release_2_5: 1.1
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2005/06/29 13:58:15;  author: vidrevich;  state: Exp;  lines: +2 -2
branches:  1.3.4;
incorporating multi-threading into C/XSB interface. In multi-threaded engine xsb_init() takes a pointer to the thread context structure as its first argument and populates that structure with main thread context information to be used in the consequent C/XSB calls. myargc,myargv are passed as the second and the third arguments to the xsb_init() when XSB is configured for multi-threading. Changes should not affect a single-threaded version.
----------------------------
revision 1.2
date: 2005/01/14 18:31:19;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.1
date: 2002/02/22 20:50:45;  author: tswift;  state: Exp;
branches:  1.1.6;
Ooops, forgot this.
----------------------------
revision 1.1.6.1
date: 2004/09/29 19:44:17;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/io_builtins.c,v
Working file: io_builtins.c
head: 1.42
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.41
	without-attv: 1.38
	release-2-0: 1.29
	pre-release-2-0: 1.23
	v1-9-8: 1.4
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.2
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 43;	selected revisions: 43
description:
----------------------------
revision 1.42
date: 1999/10/25 05:58:31;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.41
date: 1999/10/12 17:23:31;  author: warren;  state: Exp;  lines: +31 -6
Added overflow tests (and aborts) for the various stacks.  (In
preparation for automatic realloc of them.)
----------------------------
revision 1.40
date: 1999/10/12 16:18:52;  author: warren;  state: Exp;  lines: +103 -52
Fixed read_canonical to read the term into the findall chunk buffers,
so that it can check that there is enough hep memory to store the term
that was read (and call gc if not).  Modified findall (splitting it to
findall.c and findall.h) so the buffer routines can be used elsewhere.
----------------------------
revision 1.39
date: 1999/10/10 11:38:12;  author: kostis;  state: Exp;  lines: +1 -3
Changes to fold code of file "load_seg.c" into "loader.c" and thus avoid
communication between these two pieces of code through horrible global
variables.  Files "load_seg.*" are removed.  Some code cleanup took place.
----------------------------
revision 1.38
date: 1999/10/08 07:32:16;  author: kifer;  state: Exp;  lines: +2 -1
added flags: --nobanner, --noprompt, --quietload
----------------------------
revision 1.37
date: 1999/10/05 04:01:41;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.36
date: 1999/09/17 21:38:34;  author: warren;  state: Exp;  lines: +7 -39
Fixed faulty treatment of variables beginning with underscore.
----------------------------
revision 1.35
date: 1999/09/11 20:41:50;  author: warren;  state: Exp;  lines: +194 -139
changed read_canonical and write_canonical to handle list
representation.  So lists (with |-ed tails, also) are now considered
canonical.
----------------------------
revision 1.34
date: 1999/08/18 05:49:17;  author: kifer;  state: Exp;  lines: +13 -13
changed pipe2file to fd2ioport
Changed references to xsb file descriptors to xsb I/O ports, to avoid
confusion
----------------------------
revision 1.33
date: 1999/08/17 06:34:11;  author: kifer;  state: Exp;  lines: +86 -17
Added pipe_open, pipe2file.
Fixed compilation bugs on NT from yesterday's.
----------------------------
revision 1.32
date: 1999/08/16 07:24:19;  author: kifer;  state: Exp;  lines: +7 -5
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.31
date: 1999/07/21 21:33:32;  author: kifer;  state: Exp;  lines: +3 -3
socket() now checks if the address is a hostname. If so, convert to IP.
----------------------------
revision 1.30
date: 1999/07/20 18:54:38;  author: kifer;  state: Exp;  lines: +18 -1
added open_process_pipe/close_process_pipe,
open_process_stream/close_process_stream
----------------------------
revision 1.29
date: 1999/06/26 05:01:35;  author: kifer;  state: Exp;  lines: +3 -2
made print_pterm return void and increased buff size in the arithmetic
exception functions.
----------------------------
revision 1.28
date: 1999/06/23 04:34:53;  author: kifer;  state: Exp;  lines: +5 -7
Fixed bug with the %S format.
----------------------------
revision 1.27
date: 1999/06/22 03:05:10;  author: kifer;  state: Exp;  lines: +26 -5
A new %S specifier to fmt_write/_string, which prints any term.
----------------------------
revision 1.26
date: 1999/05/01 22:38:05;  author: kifer;  state: Exp;  lines: +8 -7
Changed calling sequence for p_charlist_to_c_string to avoid buffer
overruns.
----------------------------
revision 1.25
date: 1999/04/28 18:30:22;  author: kifer;  state: Exp;  lines: +22 -16
Added the regmatch package.
----------------------------
revision 1.24
date: 1999/04/27 14:39:46;  author: kifer;  state: Exp;  lines: +2 -77
Made large builtins in the former std_pred.i into inlined subroutines.
Added atom_codes, number_codes and made atom_chars, number_chars into
synonyms to the *_codes builtins.
----------------------------
revision 1.23
date: 1999/04/23 19:42:58;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Changed two xsb_segfault_message strings.
----------------------------
revision 1.22
date: 1999/04/23 19:24:12;  author: luis;  state: Exp;  lines: +3 -1
* minor changes to compile under Windows
----------------------------
revision 1.21
date: 1999/04/22 15:39:56;  author: kifer;  state: Exp;  lines: +5 -3
Improved error messages.
----------------------------
revision 1.20
date: 1999/04/16 13:29:55;  author: unova;  state: Exp;  lines: +12 -9
Changed call to sprintf for compatibility with SUNOS 4.1.4
----------------------------
revision 1.19
date: 1999/04/07 06:00:08;  author: kifer;  state: Exp;  lines: +50 -9
Fixed the bug with assignment suppression in fmt_read.
----------------------------
revision 1.18
date: 1999/04/04 15:53:34;  author: kifer;  state: Exp;  lines: +2 -2
Increased I/O max buf type.
----------------------------
revision 1.17
date: 1999/04/04 03:56:18;  author: kifer;  state: Exp;  lines: +7 -7
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.16
date: 1999/04/03 04:55:34;  author: kifer;  state: Exp;  lines: +1 -3
Moved fileno declaration to io_builtins.i
----------------------------
revision 1.15
date: 1999/04/03 04:46:40;  author: kifer;  state: Exp;  lines: +1 -226
Introduced file_read_line_atom and file_read_line_list.
----------------------------
revision 1.14
date: 1999/04/02 20:18:22;  author: kifer;  state: Exp;  lines: +58 -76
In-lined file_read_line. Improved file_function.
Adjusted documentation.
----------------------------
revision 1.13
date: 1999/04/02 03:48:03;  author: kifer;  state: Exp;  lines: +3 -1
Introduced private_builtin/11
----------------------------
revision 1.12
date: 1999/04/01 05:03:09;  author: kifer;  state: Exp;  lines: +63 -51
Replaced fmt_ builtins with formatted_io().
The fmt_* builtins now hang off of that.
----------------------------
revision 1.11
date: 1999/03/31 06:28:24;  author: kifer;  state: Exp;  lines: +55 -11
Made fmt_* functions recognize escape sequences and updated the
documentation accordingly.
----------------------------
revision 1.10
date: 1999/03/31 03:24:23;  author: kifer;  state: Exp;  lines: +6 -4
Banner is back: use string_find in file_read_line (io_builtins).
Would like to roll that back when the need for this is over.
----------------------------
revision 1.9
date: 1999/03/30 16:25:19;  author: kifer;  state: Exp;  lines: +232 -4
Changes associated with moving file_open/close/put/get,
fmt_read/write, etc. to file_io. Unifying the builtins
file_open/close/put/get with file_flush/seek/truncate
under a single builtin file_function.
----------------------------
revision 1.8
date: 1999/03/29 20:43:31;  author: kifer;  state: Exp;  lines: +548 -132
Completely rewrote all fmt_functions.
They now display floats correctly. Take "strings" (prolog lists) as
well as atoms as formats or arguments.
fmt_read no longer requires the type argument.
----------------------------
revision 1.7
date: 1999/03/26 11:26:36;  author: kostis;  state: Exp;  lines: +1 -3
Unnecessary duplicate include taken out.
----------------------------
revision 1.6
date: 1999/03/25 02:47:12;  author: kifer;  state: Exp;  lines: +12 -5
Improved segfault handling: even when DEBUG and segfault handling is
disabled, we can now enable it in certain laces, those where we know
the reasons for segfaulting.
----------------------------
revision 1.5
date: 1999/03/23 05:30:13;  author: kifer;  state: Exp;  lines: +13 -4
Added segfault handling.
----------------------------
revision 1.4
date: 1999/02/10 15:46:07;  author: kifer;  state: Exp;  lines: +1 -5
got rid of malloc.h
----------------------------
revision 1.3
date: 1998/12/21 01:08:30;  author: cbaoqiu;  state: Exp;  lines: +1 -3
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/11/17 00:29:37;  author: kifer;  state: Exp;  lines: +2 -1
Adjustments for the NT port.
----------------------------
revision 1.1
date: 1998/11/05 16:55:27;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:27;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/io_builtins.h,v
Working file: io_builtins.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.5
	release-2-0: 1.2
	pre-release-2-0: 1.2
keyword substitution: kv
total revisions: 6;	selected revisions: 6
description:
----------------------------
revision 1.6
date: 1999/10/25 05:58:32;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5
date: 1999/08/16 07:24:20;  author: kifer;  state: Exp;  lines: +5 -2
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.4
date: 1999/08/09 00:34:25;  author: kifer;  state: Exp;  lines: +2 -25
Added process control builtins, deprecated unix.P,
added C preprocessor.
----------------------------
revision 1.3
date: 1999/07/20 18:54:39;  author: kifer;  state: Exp;  lines: +5 -1
added open_process_pipe/close_process_pipe,
open_process_stream/close_process_stream
----------------------------
revision 1.2
date: 1999/04/04 03:54:49;  author: kifer;  state: Exp;  lines: +2 -1
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.1
date: 1999/04/01 05:03:10;  author: kifer;  state: Exp;
Replaced fmt_ builtins with formatted_io().
The fmt_* builtins now hang off of that.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/io_builtins.i,v
Working file: io_builtins.i
head: 1.22
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.20
	without-attv: 1.19
	release-2-0: 1.13
	pre-release-2-0: 1.10
keyword substitution: kv
total revisions: 22;	selected revisions: 22
description:
----------------------------
revision 1.22
date: 1999/10/25 05:58:34;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.21
date: 1999/10/20 18:22:11;  author: kifer;  state: Exp;  lines: +3 -3
Removed misleading references to DOS, which imply as if DOS is supported
----------------------------
revision 1.20
date: 1999/10/11 15:43:06;  author: kostis;  state: Exp;  lines: +2 -1
Clean up changes and changes to make variables used in the smallest possible
enclosing block.  This last step is still incomplete, however, it is a good
first step.
----------------------------
revision 1.19
date: 1999/09/03 19:42:58;  author: warren;  state: Exp;  lines: +13 -1
Added a call to clearerr to the general file_function call.
----------------------------
revision 1.18
date: 1999/08/18 05:49:19;  author: kifer;  state: Exp;  lines: +37 -38
changed pipe2file to fd2ioport
Changed references to xsb file descriptors to xsb I/O ports, to avoid
confusion
----------------------------
revision 1.17
date: 1999/08/17 06:34:12;  author: kifer;  state: Exp;  lines: +85 -11
Added pipe_open, pipe2file.
Fixed compilation bugs on NT from yesterday's.
----------------------------
revision 1.16
date: 1999/08/16 07:24:20;  author: kifer;  state: Exp;  lines: +92 -8
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.15
date: 1999/07/22 19:09:19;  author: kifer;  state: Exp;  lines: +2 -2
Got rid of compiler warnings.
----------------------------
revision 1.14
date: 1999/07/20 18:54:40;  author: kifer;  state: Exp;  lines: +5 -13
added open_process_pipe/close_process_pipe,
open_process_stream/close_process_stream
----------------------------
revision 1.13
date: 1999/05/05 03:35:14;  author: kifer;  state: Exp;  lines: +4 -4
Small cleanup in file_operation.
----------------------------
revision 1.12
date: 1999/05/04 20:40:53;  author: workflow;  state: Exp;  lines: +2 -1

bug fix with truncate
----------------------------
revision 1.11
date: 1999/05/01 22:38:06;  author: kifer;  state: Exp;  lines: +6 -4
Changed calling sequence for p_charlist_to_c_string to avoid buffer
overruns.
----------------------------
revision 1.10
date: 1999/04/23 19:24:39;  author: luis;  state: Exp;  lines: +5 -1
* minor changes to compile under Windows
* file_truncate disabled under Windows
----------------------------
revision 1.9
date: 1999/04/22 06:49:16;  author: kifer;  state: Exp;  lines: +3 -2
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.8
date: 1999/04/21 02:22:07;  author: kifer;  state: Exp;  lines: +6 -4
(file_function): fixed the undefined variable ch.
----------------------------
revision 1.7
date: 1999/04/16 04:10:42;  author: kifer;  state: Exp;  lines: +4 -4
Minor changes to pacify non-gcc compilers.
----------------------------
revision 1.6
date: 1999/04/15 14:30:30;  author: unova;  state: Exp;  lines: +3 -1

Modification to allow compilation on systems that define fileno as a macro.
----------------------------
revision 1.5
date: 1999/04/14 03:03:09;  author: kifer;  state: Exp;  lines: +2 -2
made file_function static.
Also added -Wdynamic and -finline-functions to gcc CFLAGS.
----------------------------
revision 1.4
date: 1999/04/04 15:53:35;  author: kifer;  state: Exp;  lines: +8 -8
Increased I/O max buf type.
----------------------------
revision 1.3
date: 1999/04/04 03:54:49;  author: kifer;  state: Exp;  lines: +59 -22
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.2
date: 1999/04/03 04:55:35;  author: kifer;  state: Exp;  lines: +4 -3
Moved fileno declaration to io_builtins.i
----------------------------
revision 1.1
date: 1999/04/03 04:46:41;  author: kifer;  state: Exp;
Introduced file_read_line_atom and file_read_line_list.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/io_builtins_xsb.c,v
Working file: io_builtins_xsb.c
head: 1.102
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.86
	ROLLBACK: 1.80
	latest_plus_supp_branch: 1.80.0.2
	latest_plus_supp: 1.80
	Version_3dot2_plus_supp: 1.76.0.2
	release_2_6_plus_supp: 1.33.0.4
	Version_3dot2: 1.76
	dec07-perf-results: 1.69
	mt_thesis: 1.66
	release_3_0: 1.66
	release_2_7_0: 1.46
	multi-threaded-26-engine: 1.23.2.2
	pre-mt: 1.46
	multi-threaded-25-engine-done: 1.23.2.1
	multi-threaded-25-engine: 1.23.0.2
	release_2_6_1: 1.33
	release_2_6_final: 1.33
	release_2_6: 1.33.0.2
	last-merged-to-demand: 1.25
	demand_branch: 1.24.0.2
	before_removing_chat: 1.23
	release_2_5: 1.23
	pre-merge-slgwam-gc: 1.22
	multi-threaded-c-engine: 1.22.0.2
	release_2_4: 1.22
	release_2_3: 1.19
	multi-threaded-engine: 1.19.0.2
	pre-threading: 1.18
	release-2-2: 1.14
	chat-and-local: 1.14.0.2
	xsb-pre-cleanup: 1.14
	release-2-1: 1.7
	release-2-0-1: 1.4
keyword substitution: kv
total revisions: 114;	selected revisions: 114
description:
----------------------------
revision 1.102
date: 2012/07/20 16:31:30;  author: tswift;  state: Exp;  lines: +3 -2

Changed sprintf format from 1.18g to g which improvies number/atom conversion.
----------------------------
revision 1.101
date: 2012/03/19 15:19:59;  author: dwarren;  state: Exp;  lines: +4 -4
Fixed a couple of declarations, not at the beginning of blocks.
Added some casts to quiet MSVC.
Conditioned the inline declarations of prolog_call0 and prolog_code_call,
which can't be external in MSVC.
----------------------------
revision 1.100
date: 2012/03/10 19:18:28;  author: kifer;  state: Exp;  lines: +2 -1
fixed syntax error
----------------------------
revision 1.99
date: 2012/03/09 18:21:45;  author: kifer;  state: Exp;  lines: +29 -1
added a case for windows similar to snprintf
----------------------------
revision 1.98
date: 2012/02/26 22:29:13;  author: kifer;  state: Exp;  lines: +21 -15
fixed a bug in fmt_write_string
----------------------------
revision 1.97
date: 2012/02/14 21:09:43;  author: dwarren;  state: Exp;  lines: +5 -2
Added missing size incrementation for floats in read_canonical.
----------------------------
revision 1.96
date: 2011/12/23 23:24:48;  author: tswift;  state: Exp;  lines: +3 -3

More for MT compilation.
----------------------------
revision 1.95
date: 2011/12/11 23:07:25;  author: dwarren;  state: Exp;  lines: +24 -20
A number of changes to fix bugs and make XSB more ISO compliant (from U.Neumerkel)
1. Made length/2 slightly more resiliant.
2. Added a cyclic term check in atom_codes.
3. fixed bug in call/n to non-existent predicate
4. Added new operators (for ISO): ^, div, xor (and changed ** to always return float.)
5. Added new ISO predicate names: acyclic_term, and subsumes_term.
6. Made number_codes/chars more ISO compliant (mostly on unusual inputs)
7. Increased precision of floating point numbers in write_canonical.
8. Added cputime to load message (if > 0.0 secs), desired by MK
9. Support reading and writing of 0-ary predicates in form p().  (This is not
	fully implemented and should not in general be used.)
----------------------------
revision 1.94
date: 2011/06/26 21:02:10;  author: tswift;  state: Exp;  lines: +4 -2
Support for C-level trace.
----------------------------
revision 1.93
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +7 -7
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.92
date: 2011/05/20 20:37:01;  author: tswift;  state: Exp;  lines: +3 -3

Fixed a 32/64 bit problem.
----------------------------
revision 1.91
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +38 -39
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.90
date: 2011/05/16 01:03:30;  author: kifer;  state: Exp;  lines: +4 -3
squash warnings on windows and linux
----------------------------
revision 1.89
date: 2011/04/27 17:11:11;  author: pmoura;  state: Exp;  lines: +2 -3
Removed support for using the \z escape sequence for representing Prolog end-of-file. It worked fine for the 0' notation but it caused problems when using the escape sequence on strings an atoms.
----------------------------
revision 1.88
date: 2011/04/26 14:00:30;  author: pmoura;  state: Exp;  lines: +2 -1
Implemented 0'\s (space) and 0'\z (Prolog end-of-file). The former is specially useful as writing "0' " is fragile when using tools the reformat source code or when tabing/detabing source files. Second attempt.
----------------------------
revision 1.87
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +2 -2

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.86
date: 2010/08/20 01:31:36;  author: dwarren;  state: Exp;  lines: +3 -3
Was incorrectly computing the size of the read_canonical space.
Had forgotten to multiply the number of records by the size of each
record on freeing the space.
----------------------------
revision 1.85
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.84
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.83
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.82
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.81
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.80
date: 2010/06/14 12:48:38;  author: dwarren;  state: Exp;  lines: +33 -11
branches:  1.80.2;
Improved error messages for low-level ptoc_ type functions (and a few others)
Now print the actual term that is found that is incorrect.  May help localize
errors better.
----------------------------
revision 1.79
date: 2010/01/20 15:32:12;  author: pmoura;  state: Exp;  lines: +2 -2
Committed Gonalo Lopes suggested patch in order to solve a compilation error on MacOS X 10.6 (Snow Leopard).
----------------------------
revision 1.78
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.77
date: 2009/08/26 21:21:25;  author: dwarren;  state: Exp;  lines: +27 -15
Fixed an off-by-one error in XSB_StrAppendC of varstring.
(IN searching for this bug, I improved the implementation of
write_canonical slightly when it writes strings that require quotes.)
----------------------------
revision 1.76
date: 2008/03/31 12:26:00;  author: tswift;  state: Exp;  lines: +2 -2

Fixed typo in new call to ctop_addr that caused compilation error.
----------------------------
revision 1.75
date: 2008/03/29 21:04:05;  author: tswift;  state: Exp;  lines: +7 -4

Fixed 64-bit bugs in read_canonical_term.  It passes back an "old" psc
record, but was using the int type for the psc rether than Integer in
a couple of places.  This mostly affected load_dync.
----------------------------
revision 1.74
date: 2008/03/22 19:17:35;  author: tswift;  state: Exp;  lines: +4 -3
Started looking at fmt_write since I thought it would be simple to
address its 64-bit issues.  This led me to update its documentation,
and to integrate it a little better with streams and ISO-style errors.
*That* led me to update error handling a little for other I/O
routines.  I put a Prolog stream check into fmt_write and fmt_read,
but apart from this, I don't think that my changes will cause any
detectable slowdowns in I/O.

error_xsb.c -- prettified output of xsb_abort()
----------------------------
revision 1.73
date: 2008/03/12 13:48:03;  author: dwarren;  state: Exp;  lines: +13 -11
Fix my erroneous fix of writing floats in write_canonical.  Misued buffers fixed.
----------------------------
revision 1.72
date: 2008/03/11 19:10:43;  author: dwarren;  state: Exp;  lines: +31 -8
Fixed write_canonical to add decimal points to floating point numbers
that look like integers.  My previous hack was not complete.
----------------------------
revision 1.71
date: 2008/02/07 16:01:03;  author: dwarren;  state: Exp;  lines: +5 -3
Fix a problem in write_canonical pointed out by Paulo, that it wrote
floats that are whole numbers without a decimal point, so they would
be read back in as integers.  Now if they don't have a decimal point,
the string ".0" is appended.
----------------------------
revision 1.70
date: 2008/02/01 17:11:33;  author: dwarren;  state: Exp;  lines: +3 -3
Fixed a bug in fmt_write when %% is used to write a single %, pointed
out by Paulo Maura.
The bug was in the case that no regularly formatted item followed
the %%.  Should work now.
----------------------------
revision 1.69
date: 2007/08/17 04:21:11;  author: dwarren;  state: Exp;  lines: +6 -3
Enlarge buffer for fmt_write_string when system doesn't have snprintf.
(Fixes failure in testsuite.)  And add clearer message when it *does*
overflow.
----------------------------
revision 1.68
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.67
date: 2007/04/20 14:40:53;  author: tswift;  state: Exp;  lines: +2 -2

Made changes to several occurrences of ctop_string to avoid interning the string twice.  I only took the obvious cases, but there were several af them.  Probably at some point we should take a closer look at a few of them to make sure we aren't interning things unnecessarily, but this depends on understanding the actual uses in detail.
----------------------------
revision 1.66
date: 2006/01/14 16:25:32;  author: dwarren;  state: Exp;  lines: +39 -7
Fix read_canonical to read floats into doubles,
Change write_canonical to write full precision floats (compatibility?)
Move MAXINT-type declarations, perhaps for giving to Prolog.
----------------------------
revision 1.65
date: 2006/01/03 18:14:08;  author: dwarren;  state: Exp;  lines: +9 -2
Restricted writeq to escape only backslashes that were folloed by an character
that would cause it to be interpreted as an escape.
----------------------------
revision 1.64
date: 2006/01/03 17:34:20;  author: dwarren;  state: Exp;  lines: +4 -1
Added escape of backslash (with backslash) when writing out in string, with
writeq and write_canonical.  This should ensure that strings being written
out can be read back in (after the changes we made to the scanner to make it more ISO
compatible.)
----------------------------
revision 1.63
date: 2005/12/17 02:46:32;  author: dwarren;  state: Exp;  lines: +7 -7
Fixed accumulated missing casts.  MSVC compiles it now without complaint.
----------------------------
revision 1.62
date: 2005/12/12 18:44:53;  author: dwarren;  state: Exp;  lines: +13 -2
Added string table garbage collection.
----------------------------
revision 1.61
date: 2005/11/20 21:23:28;  author: dwarren;  state: Exp;  lines: +4 -1
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.60
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +16 -16
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.59
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +18 -16
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.58
date: 2005/08/16 19:19:09;  author: dwarren;  state: Exp;  lines: +4 -4
Changes for multi-threading:
1. Added open/4 to allow forcing of a new open.  open/3 returns previously opened
file (with same name and mode) if there is one.  This is needed in multithreading
to allow each thread to open the same file to read it.
2. Reworked how table directives are passed from the compiler to the execution
state.  It is now passed through the xwam files, and use_subsumptive_tabling
and use_variant_tabling is also passed this way.  shared/private, and tabling (variant
or subsumptive) tags are kept in the psc record (in bits in the env byte.)
This is not completely compatible with old .xwam files, so they shoudl be
recompiled.  If they aren't, then all tabled predicates are assumed to be tabled
with variant tabling, and a warning is given.
3. Updated the compiler so that most (all?) of its output files are now
written to explicit streams (instead of using tell.)
----------------------------
revision 1.57
date: 2005/07/18 21:54:10;  author: crojo;  state: Exp;  lines: +29 -15
*** empty log message ***
----------------------------
revision 1.56
date: 2005/07/11 16:49:01;  author: dwarren;  state: Exp;  lines: +3 -3
Minor comment changes
----------------------------
revision 1.55
date: 2005/07/08 20:25:21;  author: dwarren;  state: Exp;  lines: +36 -40
More thread-safe making.  gettoken and read_canonical, this time.
----------------------------
revision 1.54
date: 2005/07/07 21:46:23;  author: dwarren;  state: Exp;  lines: +53 -48
thread-safer for fmt_read/write....(?)
----------------------------
revision 1.53
date: 2005/07/07 18:59:43;  author: dwarren;  state: Exp;  lines: +64 -91
Made write_canonical thread-safe
----------------------------
revision 1.52
date: 2005/07/07 16:55:52;  author: dwarren;  state: Exp;  lines: +61 -42
Fixed fmt_read/write for multithreading.  Minor change to write_canonical (still NOT
thread-safe).
Added several (extensible) string buffers to context, since many builtins use
global string buffers.  Idea is to change those places to use these buffers.
They are implemented as varstring's.
----------------------------
revision 1.51
date: 2005/07/07 02:23:10;  author: dwarren;  state: Exp;  lines: +42 -24
Made fmt_read/write thread-safe.
----------------------------
revision 1.50
date: 2005/07/06 18:29:13;  author: dwarren;  state: Exp;  lines: +20 -21
FOr Multithreading: Made findall thread-safe by moving its static variables
to the thread structure.  Now each thread has its own chain of findall buffers.
----------------------------
revision 1.49
date: 2005/03/04 05:57:10;  author: kifer;  state: Exp;  lines: +2 -2
add call_conv to write_term_canonical
----------------------------
revision 1.48
date: 2005/01/14 18:31:19;  author: ruim;  state: Exp;  lines: +92 -92
Integration of multithreaded system
----------------------------
revision 1.47
date: 2005/01/03 22:32:57;  author: dwarren;  state: Exp;  lines: +3 -2
Change write_canonical to write more complete floating point numbers.
----------------------------
revision 1.46
date: 2004/10/15 14:26:07;  author: dwarren;  state: Exp;  lines: +9 -9
Minor changes to fix file_puttoken to properly quote (or double quote) tokens.
Renamed no_quotes_needed to quotes_are_needed to reflect its semantics.
----------------------------
revision 1.45
date: 2004/10/11 13:08:48;  author: dwarren;  state: Exp;  lines: +3 -6
write-quoted when /*, take 3.....
----------------------------
revision 1.44
date: 2004/10/11 01:33:15;  author: dwarren;  state: Exp;  lines: +6 -3
Fix to write_canonical, writeq to quote /* situations.  Take 2... (Thanks, Kostis.)
----------------------------
revision 1.43
date: 2004/10/08 14:40:57;  author: dwarren;  state: Exp;  lines: +2 -1
Make write_canonical and writeq quote the string /*.
----------------------------
revision 1.42
date: 2004/10/04 22:09:41;  author: dwarren;  state: Exp;  lines: +2 -2
Add a couple of DllExports, as requested by Saikat for db interface.
----------------------------
revision 1.41
date: 2004/09/03 18:39:05;  author: dwarren;  state: Exp;  lines: +2 -2
Commented out tracing print stmt.
----------------------------
revision 1.40
date: 2004/09/02 19:48:51;  author: tswift;  state: Exp;  lines: +25 -5

1) added ISO predicates peek_char/1,2 peek_code/1,2, at_end_of_stream/1,2
set_stream_position/2

2) A bit of code cleanup by fixing print_openfiles.

3) Fixed error in spawning processes intro'd by new stream stuff.

4) Revised I/O documentation (more to come).
----------------------------
revision 1.39
date: 2004/08/31 00:19:13;  author: dwarren;  state: Exp;  lines: +2 -2
Added option to generate anonymous var bld and uni in assert.
(and very monor cleanup to avoid warnings.)
----------------------------
revision 1.38
date: 2004/08/19 22:15:25;  author: tswift;  state: Exp;  lines: +86 -7

Changes for streams.  Here's hoping...
----------------------------
revision 1.37
date: 2004/07/16 16:24:32;  author: dwarren;  state: Exp;  lines: +3 -3
Changed several xsb_exit's to xsb_abort's to give control back to user
as seems appropriate.
----------------------------
revision 1.36
date: 2004/07/14 15:59:01;  author: dwarren;  state: Exp;  lines: +16 -8
Fixed bug in read_canonical/3 so that it returns the PSC of the
previously read term (head, if of the form :-/2).  This feature
was being used in load_dync to make it faster.  Actually, the feature
didn't work and resulted in some rules in files loaded by load_dync
being lost.  This fixes that bug, and also now does take advantage
of that attempted optimization.  It seems to speed up load_dync-ing of large
fact files of one predicate (e.g. wordnet synonyms) by more than 25%
(if memory serves.)
----------------------------
revision 1.35
date: 2003/10/02 23:44:56;  author: dwarren;  state: Exp;  lines: +3 -2
Fixed a bug in handling variables (set globals needed by findall_copy..)
----------------------------
revision 1.34
date: 2003/09/18 18:43:52;  author: dwarren;  state: Exp;  lines: +91 -34
Extended read_canonical to read ',' as an infix operator (in most cases).
So it reads terms of the form: (a,b,c), and prolog does.  It also
reads terms of the form (a) as a, ignoring the superfluous parentheses.
Notice that it does NOT read a term like:
a,b,c.
without the parens.
Also I fixed a bug (which I introduced when allowing read_canonical_term
to be called from odbc routines) in handling stack expansion to support
reading very large terms.
----------------------------
revision 1.33
date: 2003/03/14 18:54:29;  author: dwarren;  state: Exp;  lines: +2 -2
Minor changes to create and use some "builtin" psc-addresses, rather than
re-insert every time one is needed.
----------------------------
revision 1.32
date: 2003/02/27 20:36:53;  author: dwarren;  state: Exp;  lines: +5 -4
Mods to allow odbc interface to use the write_canonical c-code, for
reading and writing prolog terms from/into character fields.
----------------------------
revision 1.31
date: 2003/02/10 17:18:06;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed quotes check, to quote the empty string...
----------------------------
revision 1.30
date: 2003/02/07 15:26:56;  author: lfcastro;  state: Exp;  lines: +2 -2
Get rid of signed/unsigned comparison warning on MSVC
----------------------------
revision 1.29
date: 2003/02/03 22:50:21;  author: dwarren;  state: Exp;  lines: +5 -4
Change read_canonical to accept an EOF as an end-of-clause, so when reading
from string, don't need the ending period.
(and fixed a bug in handling errors when reading from string.)
----------------------------
revision 1.28
date: 2003/01/28 22:57:01;  author: dwarren;  state: Exp;  lines: +212 -48
Move write_canonical (and write_canonical_lettervars) to C.  Not for speed
but so that they can be accessed from C, and used in the ODBC interface to
write terms canonically to character fields.
----------------------------
revision 1.27
date: 2002/11/04 18:09:02;  author: dwarren;  state: Exp;  lines: +3 -3
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.26
date: 2002/09/20 13:42:29;  author: dwarren;  state: Exp;  lines: +11 -3
Added %! format type to fmt_write and fmt_write_string to cause the
corresponding value to be ignored (or skipped).
----------------------------
revision 1.25
date: 2002/08/07 15:42:13;  author: lfcastro;  state: Exp;  lines: +35 -35
* do not use is_* functions (from the C interface) inside the
  emulator.
----------------------------
revision 1.24
date: 2002/05/20 17:47:09;  author: tswift;  state: Exp;  lines: +85 -1
branches:  1.24.2;

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.23
date: 2002/01/23 17:08:09;  author: dwarren;  state: Exp;  lines: +6 -6
branches:  1.23.2;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.22
date: 2001/07/06 18:19:42;  author: kifer;  state: Exp;  lines: +1 -2
Exported print_pterm, VarStrOps for windows compilation
----------------------------
revision 1.21
date: 2001/05/13 21:01:20;  author: kifer;  state: Exp;  lines: +3 -3
a workaround for fmt_print("%s", a("")).
----------------------------
revision 1.20
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +28 -28
improved error messages
----------------------------
revision 1.19
date: 2000/06/29 06:23:46;  author: kifer;  state: Exp;  lines: +3 -1
branches:  1.19.2;
fixed a bug in the %S formatting for fmt_write.
----------------------------
revision 1.18
date: 2000/06/17 23:28:52;  author: kifer;  state: Exp;  lines: +12 -15
fixed bugs in p_charlist_to_c_string.
Deleted the last argument from file_read_line_*
preds.
Removed the restriction that Lines must be under MAX_IO_SIZE
----------------------------
revision 1.17
date: 2000/06/16 04:57:52;  author: kifer;  state: Exp;  lines: +3 -1
fixed the file_clone bug and the bug in intern_file (the lack of checking for
null ptr). 3rd arg in file_clone now returns the error code as advertized.
----------------------------
revision 1.16
date: 2000/05/20 06:56:02;  author: kifer;  state: Exp;  lines: +4 -4
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.15
date: 2000/04/29 21:53:54;  author: kifer;  state: Exp;  lines: +27 -27
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.14
date: 2000/02/15 07:45:08;  author: bartkul;  state: Exp;  lines: +2 -2
in testsuite.sh supertest.sh gctest.sh

changed testsuite.sh    into    ./testsuite.sh
        makexsb         into    ./makexsb
        configure       into    ./configure

in prolog_tests/c_calls_xsb_make.P

changed c_calls_xsb.exe into    ./c_calls_xsb.exe


in the c and h files: given check_glstack_overflow an extra argument

standard.O ... I have no idea
----------------------------
revision 1.13
date: 2000/01/10 18:29:18;  author: warren;  state: Exp;  lines: +91 -79
made stacks for reading read_canonical auto-expanding.
----------------------------
revision 1.12
date: 2000/01/07 08:51:37;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.11
date: 1999/12/28 17:25:57;  author: warren;  state: Exp;  lines: +45 -3
Added handling of double-quoted strings to read-canonical.
----------------------------
revision 1.10
date: 1999/12/10 07:47:33;  author: kifer;  state: Exp;  lines: +5 -3
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.9
date: 1999/11/29 00:30:17;  author: kifer;  state: Exp;  lines: +142 -138
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.8
date: 1999/11/27 23:27:24;  author: warren;  state: Exp;  lines: +3 -1
fixed bug of using term after what it points to has been freed.
----------------------------
revision 1.7
date: 1999/11/17 03:54:30;  author: kifer;  state: Exp;  lines: +2 -2
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.6
date: 1999/11/16 19:05:56;  author: kifer;  state: Exp;  lines: +2 -3
Revamped sockets interface.
----------------------------
revision 1.5
date: 1999/11/15 21:16:51;  author: warren;  state: Exp;  lines: +32 -21
Fixed read_canonical to handle reading of integers, floats, and even
variables. At the same time, discovered and fixed a bug cuased by a
lack of trailing the binding made to return the value.
----------------------------
revision 1.4
date: 1999/10/29 10:42:55;  author: kostis;  state: Exp;  lines: +1 -2
Minor cleanup.
----------------------------
revision 1.3
date: 1999/10/27 04:12:05;  author: kifer;  state: Exp;  lines: +7 -1
Fixed the bug when the last format specifier has a conversion suppression
character in fmt_read.
----------------------------
revision 1.2
date: 1999/10/26 06:47:13;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:58:35;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.19.2.3
date: 2001/01/06 18:43:05;  author: ruim;  state: Exp;  lines: +1 -2
Initialization data made static and other small changes
----------------------------
revision 1.19.2.2
date: 2000/12/19 15:58:16;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.19.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +33 -3
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.23.2.2
date: 2004/10/18 20:46:06;  author: ruim;  state: Exp;  lines: +345 -86
update for version 2.6.1
----------------------------
revision 1.23.2.1
date: 2004/09/29 19:44:17;  author: ruim;  state: Exp;  lines: +83 -82
Sources from rfm repository
----------------------------
revision 1.24.2.4
date: 2003/04/17 17:11:44;  author: lfcastro;  state: Exp;  lines: +219 -52
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.24.2.3
date: 2003/02/11 18:36:18;  author: lfcastro;  state: Exp;  lines: +2 -2
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.24.2.2
date: 2002/10/28 16:49:31;  author: lfcastro;  state: Exp;  lines: +10 -2
* Merge with HEAD
----------------------------
revision 1.24.2.1
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +35 -35
* update to HEAD
----------------------------
revision 1.80.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.80.2.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.80.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/io_builtins_xsb.h,v
Working file: io_builtins_xsb.h
head: 1.22
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.21
	ROLLBACK: 1.16
	latest_plus_supp_branch: 1.16.0.4
	latest_plus_supp: 1.16
	Version_3dot2_plus_supp: 1.16.0.2
	release_2_6_plus_supp: 1.3.0.4
	Version_3dot2: 1.16
	dec07-perf-results: 1.15
	mt_thesis: 1.15
	release_3_0: 1.13
	release_2_7_0: 1.9
	multi-threaded-26-engine: 1.1.8.2
	pre-mt: 1.9
	multi-threaded-25-engine-done: 1.1.8.1
	multi-threaded-25-engine: 1.1.0.8
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.2
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.2
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 30;	selected revisions: 30
description:
----------------------------
revision 1.22
date: 2011/06/26 21:02:10;  author: tswift;  state: Exp;  lines: +2 -2
Support for C-level trace.
----------------------------
revision 1.21
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.20
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.19
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2008/03/29 21:04:06;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.16.4;

Fixed 64-bit bugs in read_canonical_term.  It passes back an "old" psc
record, but was using the int type for the psc rether than Integer in
a couple of places.  This mostly affected load_dync.
----------------------------
revision 1.15
date: 2006/10/25 17:53:34;  author: ruim;  state: Exp;  lines: +8 -9
added check to ownership of iostr entry before call to strclose
----------------------------
revision 1.14
date: 2006/10/25 15:35:03;  author: ruim;  state: Exp;  lines: +33 -1
Fix for bug in locking iostrs
----------------------------
revision 1.13
date: 2005/12/31 01:43:34;  author: tswift;  state: Exp;  lines: +6 -2
Changes to mutex handling for IO that should affect only the MT
engine. Rather than having a global IO mutex, I've added a mutex
for each stream, and used MUTEX_IO to lock the open_files array
itself.  This change was prompted by the fact that I can't have
one thread waiting on an input-stream via, say, a read and have
that thread create other threads that write to the output stream
and exit when done.

The result is that we no longer have contention when different
threads write to different streams.  At the same time, we end up
doing no more locking than before -- a little less, in fact due
to some manipulations in xsb_writ.P Unfortunately, the stream
mutexes are recursive (as with MUTEX_IO).  We can't get rid of
this until we rewrite write_term.

Now, back to handling memory_errors.
----------------------------
revision 1.12
date: 2005/08/16 19:19:09;  author: dwarren;  state: Exp;  lines: +2 -2
Changes for multi-threading:
1. Added open/4 to allow forcing of a new open.  open/3 returns previously opened
file (with same name and mode) if there is one.  This is needed in multithreading
to allow each thread to open the same file to read it.
2. Reworked how table directives are passed from the compiler to the execution
state.  It is now passed through the xwam files, and use_subsumptive_tabling
and use_variant_tabling is also passed this way.  shared/private, and tabling (variant
or subsumptive) tags are kept in the psc record (in bits in the env byte.)
This is not completely compatible with old .xwam files, so they shoudl be
recompiled.  If they aren't, then all tabled predicates are assumed to be tabled
with variant tabling, and a warning is given.
3. Updated the compiler so that most (all?) of its output files are now
written to explicit streams (instead of using tell.)
----------------------------
revision 1.11
date: 2005/07/06 18:29:14;  author: dwarren;  state: Exp;  lines: +6 -1
FOr Multithreading: Made findall thread-safe by moving its static variables
to the thread structure.  Now each thread has its own chain of findall buffers.
----------------------------
revision 1.10
date: 2005/01/14 18:31:19;  author: ruim;  state: Exp;  lines: +3 -3
Integration of multithreaded system
----------------------------
revision 1.9
date: 2004/10/15 14:26:08;  author: dwarren;  state: Exp;  lines: +2 -2
Minor changes to fix file_puttoken to properly quote (or double quote) tokens.
Renamed no_quotes_needed to quotes_are_needed to reflect its semantics.
----------------------------
revision 1.8
date: 2004/09/28 17:24:45;  author: tswift;  state: Exp;  lines: +1 -10

Second pass on streams.  Added new ISO predicates, improved functionality of stream-based
predicates and made all predicates work on files,
pipes and atoms, when applicable.  Added fcntl fuctionality for Cygwin.

Updated ODBC interface so that it uses a findall for the relational interface and
documented.

Updated documentation: rewrote section on streams; rearranged sections on OS interaction;
added sections on typing for errors, on redefinition of standard predicates, and started
a section on ISO compatability.
----------------------------
revision 1.7
date: 2004/09/02 19:48:51;  author: tswift;  state: Exp;  lines: +2 -2

1) added ISO predicates peek_char/1,2 peek_code/1,2, at_end_of_stream/1,2
set_stream_position/2

2) A bit of code cleanup by fixing print_openfiles.

3) Fixed error in spawning processes intro'd by new stream stuff.

4) Revised I/O documentation (more to come).
----------------------------
revision 1.6
date: 2004/08/29 22:57:04;  author: tswift;  state: Exp;  lines: +1 -5

The following are the major changes.

1) Started adding checks to the ISO predicates, to make sure they are called with proper
Stream or alias terms, that are open and of the right mode.  All ISO stream predicates now
also allow aliases, by the way.

2) Made a first pass at stream_property/1, open/4, along with some other predicates.

3) Updated documentation.

More to come...
----------------------------
revision 1.5
date: 2004/08/19 22:15:25;  author: tswift;  state: Exp;  lines: +26 -3

Changes for streams.  Here's hoping...
----------------------------
revision 1.4
date: 2003/09/18 18:43:52;  author: dwarren;  state: Exp;  lines: +2 -2
Extended read_canonical to read ',' as an infix operator (in most cases).
So it reads terms of the form: (a,b,c), and prolog does.  It also
reads terms of the form (a) as a, ignoring the superfluous parentheses.
Notice that it does NOT read a term like:
a,b,c.
without the parens.
Also I fixed a bug (which I introduced when allowing read_canonical_term
to be called from odbc routines) in handling stack expansion to support
reading very large terms.
----------------------------
revision 1.3
date: 2003/01/28 22:57:04;  author: dwarren;  state: Exp;  lines: +6 -1
Move write_canonical (and write_canonical_lettervars) to C.  Not for speed
but so that they can be accessed from C, and used in the ODBC interface to
write terms canonically to character fields.
----------------------------
revision 1.2
date: 2002/05/20 17:47:10;  author: tswift;  state: Exp;  lines: +5 -1
branches:  1.2.2;

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.1
date: 1999/10/25 05:58:36;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.8;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.8.2
date: 2004/10/18 20:46:06;  author: ruim;  state: Exp;  lines: +10 -1
update for version 2.6.1
----------------------------
revision 1.1.8.1
date: 2004/09/29 19:44:17;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:16;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.2.2.1
date: 2003/04/17 17:11:44;  author: lfcastro;  state: Exp;  lines: +6 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.16.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.16.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/io_builtins_xsb_i.h,v
Working file: io_builtins_xsb_i.h
head: 1.66
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.61
	ROLLBACK: 1.56
	latest_plus_supp_branch: 1.56.0.4
	latest_plus_supp: 1.56
	Version_3dot2_plus_supp: 1.56.0.2
	release_2_6_plus_supp: 1.16.0.4
	Version_3dot2: 1.56
	dec07-perf-results: 1.55
	mt_thesis: 1.49
	release_3_0: 1.46
	release_2_7_0: 1.27
	multi-threaded-26-engine: 1.14.2.2
	pre-mt: 1.27
	multi-threaded-25-engine-done: 1.14.2.1
	multi-threaded-25-engine: 1.14.0.2
	release_2_6_1: 1.16
	release_2_6_final: 1.16
	release_2_6: 1.16.0.2
	last-merged-to-demand: 1.16
	demand_branch: 1.15.0.2
	before_removing_chat: 1.14
	release_2_5: 1.14
	pre-merge-slgwam-gc: 1.13
	multi-threaded-c-engine: 1.13.0.2
	release_2_4: 1.13
	release_2_3: 1.10
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.8
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.3
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 75;	selected revisions: 75
description:
----------------------------
revision 1.66
date: 2011/06/27 15:52:24;  author: dwarren;  state: Exp;  lines: +3 -2
Give more helpful error message in close permission error.
----------------------------
revision 1.65
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +2 -2
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.64
date: 2011/05/20 20:20:26;  author: tswift;  state: Exp;  lines: +2 -2

Fixed a couple of 32/64 compiler warnings.
----------------------------
revision 1.63
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +2 -2
Getting Linux to Work
----------------------------
revision 1.62
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +37 -32
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.61
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.60
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.59
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.58
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.57
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.56
date: 2008/03/22 19:17:35;  author: tswift;  state: Exp;  lines: +3 -2
branches:  1.56.4;
Started looking at fmt_write since I thought it would be simple to
address its 64-bit issues.  This led me to update its documentation,
and to integrate it a little better with streams and ISO-style errors.
*That* led me to update error handling a little for other I/O
routines.  I put a Prolog stream check into fmt_write and fmt_read,
but apart from this, I don't think that my changes will cause any
detectable slowdowns in I/O.

error_xsb.c -- prettified output of xsb_abort()
----------------------------
revision 1.55
date: 2007/08/22 19:03:45;  author: tswift;  state: Exp;  lines: +3 -2
A couple of changes to get a cleaner compiler.
----------------------------
revision 1.54
date: 2007/04/20 14:40:54;  author: tswift;  state: Exp;  lines: +3 -3

Made changes to several occurrences of ctop_string to avoid interning the string twice.  I only took the obvious cases, but there were several af them.  Probably at some point we should take a closer look at a few of them to make sure we aren't interning things unnecessarily, but this depends on understanding the actual uses in detail.
----------------------------
revision 1.53
date: 2007/04/16 16:14:15;  author: tswift;  state: Exp;  lines: +13 -1

Got rid of some unnecessary calls to string_find().  There are
plenty left due to ctop_string() calls.

--- It turned out that read/[1,2] was interning each token 3
    times, and I got rid of 2 of those 3, by tweaking the builtin
    call and by redefining the unnecessary read_getcon.

-- It also turned out that nl, and file_nl were performing
   unnecessary string interns because of windows_os_loader.  I
   got rid of that function and moved file_nl to C (in
   file_function).  Also, I redefined nl/0 to call file_nl.
----------------------------
revision 1.52
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +2 -2
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.51
date: 2007/02/20 21:01:40;  author: harpreet_singh;  state: Exp;  lines: +3 -3
Commented out debug print out in file_read_line_list.
----------------------------
revision 1.50
date: 2007/02/18 16:20:13;  author: dwarren;  state: Exp;  lines: +3 -1
Adjust test for file_read_line_list buffer overflow to account for possible
string null terminator.
----------------------------
revision 1.49
date: 2006/10/25 17:53:39;  author: ruim;  state: Exp;  lines: +2 -1
added check to ownership of iostr entry before call to strclose
----------------------------
revision 1.48
date: 2006/10/25 15:35:03;  author: ruim;  state: Exp;  lines: +8 -21
Fix for bug in locking iostrs
----------------------------
revision 1.47
date: 2006/10/08 23:40:39;  author: tswift;  state: Exp;  lines: +2 -2

Changes to error_xsb.[ch] to turn current xsb_throw to xsb_throw_internal, and then re-introduce xsb_throw().  This allows xsb_throw to be used more easily
by foreign C functions and will hopefully solve Roberto Bagnara's problem.

Other changes fixed some typos in error messages.
----------------------------
revision 1.46
date: 2006/05/22 15:40:04;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed FILE_PEEK for strings.  (It had been consuming the character.)
----------------------------
revision 1.45
date: 2006/03/06 22:45:34;  author: tswift;  state: Exp;  lines: +23 -16

Adjusted some mutexes in file io functions;

destroyed thread-private var strings before deallocating them, to avoid memory leaks.
----------------------------
revision 1.44
date: 2006/01/16 00:33:23;  author: tswift;  state: Exp;  lines: +2 -2

Began documenting MT predicates in manual.  First pass on adding
error checking to multi-threading predicates.  Added
xsb_existence_error() in C.
----------------------------
revision 1.43
date: 2006/01/02 16:33:37;  author: dwarren;  state: Exp;  lines: +9 -6
Modified XSB_STREAM_LOCK and _UNLOCK to account for reading from strings.
Commented out debugging function that was causing a warning.
Added cast to quiet warning in xsb_error.
----------------------------
revision 1.42
date: 2005/12/31 01:43:35;  author: tswift;  state: Exp;  lines: +147 -32
Changes to mutex handling for IO that should affect only the MT
engine. Rather than having a global IO mutex, I've added a mutex
for each stream, and used MUTEX_IO to lock the open_files array
itself.  This change was prompted by the fact that I can't have
one thread waiting on an input-stream via, say, a read and have
that thread create other threads that write to the output stream
and exit when done.

The result is that we no longer have contention when different
threads write to different streams.  At the same time, we end up
doing no more locking than before -- a little less, in fact due
to some manipulations in xsb_writ.P Unfortunately, the stream
mutexes are recursive (as with MUTEX_IO).  We can't get rid of
this until we rewrite write_term.

Now, back to handling memory_errors.
----------------------------
revision 1.41
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +9 -9
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.40
date: 2005/11/13 21:38:37;  author: dwarren;  state: Exp;  lines: +2 -0
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.39
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +4 -3
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.38
date: 2005/11/09 17:52:27;  author: dwarren;  state: Exp;  lines: +16 -7
Allowed file_open on strings to take code-lists (actually it already could,
but had a bug), and then changed xsb_query_string to build a code-list for
the query on the heap to avoid interning the goal.  And fixed c2p_chars (which
might better be called c2p_codes) to check for heap overflow.  This fixes a
"memory leak" from code calling XSB, pointed out by Michael.
----------------------------
revision 1.37
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +5 -5
made private flags array for sequential engine
----------------------------
revision 1.36
date: 2005/08/16 19:19:09;  author: dwarren;  state: Exp;  lines: +12 -10
Changes for multi-threading:
1. Added open/4 to allow forcing of a new open.  open/3 returns previously opened
file (with same name and mode) if there is one.  This is needed in multithreading
to allow each thread to open the same file to read it.
2. Reworked how table directives are passed from the compiler to the execution
state.  It is now passed through the xwam files, and use_subsumptive_tabling
and use_variant_tabling is also passed this way.  shared/private, and tabling (variant
or subsumptive) tags are kept in the psc record (in bits in the env byte.)
This is not completely compatible with old .xwam files, so they shoudl be
recompiled.  If they aren't, then all tabled predicates are assumed to be tabled
with variant tabling, and a warning is given.
3. Updated the compiler so that most (all?) of its output files are now
written to explicit streams (instead of using tell.)
----------------------------
revision 1.35
date: 2005/08/02 17:06:20;  author: dwarren;  state: Exp;  lines: +9 -6
Fix memory leak in file_read_line_list introduced when trying to make thread-safe.
----------------------------
revision 1.34
date: 2005/07/15 14:53:46;  author: dwarren;  state: Exp;  lines: +2 -2
Made stat buffer local to make thread-safe.
----------------------------
revision 1.33
date: 2005/07/11 16:50:48;  author: dwarren;  state: Exp;  lines: +4 -1
Moved iostrs declaration into file where it is used. (Cleanup)
----------------------------
revision 1.32
date: 2005/07/04 13:17:09;  author: dwarren;  state: Exp;  lines: +28 -17
Made some I/O builtins thread-safe(r) by making static variables automatic.
----------------------------
revision 1.31
date: 2005/06/24 14:36:31;  author: dwarren;  state: Exp;  lines: +2 -2
Changed type so 255 character is not treated as EOF in file_read_line_list
----------------------------
revision 1.30
date: 2005/03/05 07:51:06;  author: kifer;  state: Exp;  lines: +3 -3
fixed the definition of write_canonical_term
Tatyana's earlier change was wrong.
----------------------------
revision 1.29
date: 2005/03/01 22:10:40;  author: dwarren;  state: Exp;  lines: +8 -3
Implemented file_truncate in MS_WIN (using _chsize())
----------------------------
revision 1.28
date: 2005/01/14 18:31:19;  author: ruim;  state: Exp;  lines: +99 -99
Integration of multithreaded system
----------------------------
revision 1.27
date: 2004/09/30 14:54:45;  author: dwarren;  state: Exp;  lines: +2 -2
A couple of minor changes to clean code and reduce warnings of 64-bit compiler.
----------------------------
revision 1.26
date: 2004/09/28 17:24:46;  author: tswift;  state: Exp;  lines: +49 -9

Second pass on streams.  Added new ISO predicates, improved functionality of stream-based
predicates and made all predicates work on files,
pipes and atoms, when applicable.  Added fcntl fuctionality for Cygwin.

Updated ODBC interface so that it uses a findall for the relational interface and
documented.

Updated documentation: rewrote section on streams; rearranged sections on OS interaction;
added sections on typing for errors, on redefinition of standard predicates, and started
a section on ISO compatability.
----------------------------
revision 1.25
date: 2004/09/10 17:29:44;  author: tswift;  state: Exp;  lines: +78 -33

Main changes were to allow both pipes and atoms (strings) to be opened, closed, read,
written by ISO predicates.  Test suite works and playing around seems to work but I still
have to go through the I/O routines systematically.  So there will be more changes over the
next few days.

In addition, I also am starting to keep track of whether the stream is binary or not, although
I'm not yet doing anything with it.
----------------------------
revision 1.24
date: 2004/09/02 19:48:51;  author: tswift;  state: Exp;  lines: +45 -10

1) added ISO predicates peek_char/1,2 peek_code/1,2, at_end_of_stream/1,2
set_stream_position/2

2) A bit of code cleanup by fixing print_openfiles.

3) Fixed error in spawning processes intro'd by new stream stuff.

4) Revised I/O documentation (more to come).
----------------------------
revision 1.23
date: 2004/08/31 15:14:11;  author: tswift;  state: Exp;  lines: +22 -14

Added close/2 predicate

Added C-level xsb_permission_error()

Fixed various small buglets and forgotten cases in streams and I/O.
----------------------------
revision 1.22
date: 2004/08/31 00:19:14;  author: dwarren;  state: Exp;  lines: +5 -2
Added option to generate anonymous var bld and uni in assert.
(and very monor cleanup to avoid warnings.)
----------------------------
revision 1.21
date: 2004/08/29 22:57:04;  author: tswift;  state: Exp;  lines: +46 -11

The following are the major changes.

1) Started adding checks to the ISO predicates, to make sure they are called with proper
Stream or alias terms, that are open and of the right mode.  All ISO stream predicates now
also allow aliases, by the way.

2) Made a first pass at stream_property/1, open/4, along with some other predicates.

3) Updated documentation.

More to come...
----------------------------
revision 1.20
date: 2004/08/20 18:11:35;  author: dwarren;  state: Exp;  lines: +2 -1
Added uniavar and bldavar WAM instructions for processing anonymous variables.
Fixed a bug in backtrace due to cpreg being used in compiling inline disjunctions
   and thus not pointing after a call WAM instruction.
Fixed initialization to put system-defined constants/predicates (in particular ,/2)
   into both the particular module (standard) AND in usermod.
----------------------------
revision 1.19
date: 2004/08/19 22:15:25;  author: tswift;  state: Exp;  lines: +37 -21

Changes for streams.  Here's hoping...
----------------------------
revision 1.18
date: 2004/05/18 20:23:28;  author: dwarren;  state: Exp;  lines: +22 -21
Rewrote file_read_line_list so that it can handle \0 within a line.
(Yes, we are seeing such files.  This might be a stopgap measure until
we really have to face wide characters in XSB.)
----------------------------
revision 1.17
date: 2004/04/19 18:30:55;  author: dwarren;  state: Exp;  lines: +51 -1
Added option to read a line directly into codes, without going through inserting
the line into the atom table.
----------------------------
revision 1.16
date: 2002/08/07 15:42:13;  author: lfcastro;  state: Exp;  lines: +9 -9
* do not use is_* functions (from the C interface) inside the
  emulator.
----------------------------
revision 1.15
date: 2002/07/01 16:12:27;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.15.2;
Changed ptoc_string to ptoc_longstring, to allow file_open on a string to
work when given a list of strings.  Avoids atom hacking within XSB to add a
terminating '.', for example.
----------------------------
revision 1.14
date: 2002/01/23 17:08:09;  author: dwarren;  state: Exp;  lines: +3 -3
branches:  1.14.2;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.13
date: 2001/04/20 02:11:36;  author: kifer;  state: Exp;  lines: +2 -2
null terminated getbuff'ed string.
----------------------------
revision 1.12
date: 2001/03/26 04:59:02;  author: kifer;  state: Exp;  lines: +1 -46
got rid of the FILE_STAT builtin, replaced with the one in system_xsb.c
Added more path_sysop goodies.
----------------------------
revision 1.11
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +9 -9
improved error messages
----------------------------
revision 1.10
date: 2000/12/27 00:30:05;  author: kifer;  state: Exp;  lines: +22 -3
Incorporated push/pop_stdin to improve handling of the -e option.
----------------------------
revision 1.9
date: 2000/06/24 04:05:11;  author: kifer;  state: Exp;  lines: +16 -16
branches:  1.9.2;
made documentation and program comments to agree with each other
----------------------------
revision 1.8
date: 2000/06/17 23:28:53;  author: kifer;  state: Exp;  lines: +43 -31
fixed bugs in p_charlist_to_c_string.
Deleted the last argument from file_read_line_*
preds.
Removed the restriction that Lines must be under MAX_IO_SIZE
----------------------------
revision 1.7
date: 2000/06/16 04:57:52;  author: kifer;  state: Exp;  lines: +49 -18
fixed the file_clone bug and the bug in intern_file (the lack of checking for
null ptr). 3rd arg in file_clone now returns the error code as advertized.
----------------------------
revision 1.6
date: 2000/04/29 21:53:55;  author: kifer;  state: Exp;  lines: +3 -3
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.5
date: 2000/04/29 01:16:46;  author: kifer;  state: Exp;  lines: +3 -3
fixed the Invalid open file mode warning.
----------------------------
revision 1.4
date: 1999/12/10 07:47:34;  author: kifer;  state: Exp;  lines: +1 -2
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.3
date: 1999/11/23 04:06:44;  author: kifer;  state: Exp;  lines: +121 -66
Added tmpfile_open.
Cleaned up the file opening modes stuff.
----------------------------
revision 1.2
date: 1999/11/16 19:05:56;  author: kifer;  state: Exp;  lines: +5 -4
Revamped sockets interface.
----------------------------
revision 1.1
date: 1999/10/25 05:58:37;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:16;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +9 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.14.2.2
date: 2004/10/18 20:46:06;  author: ruim;  state: Exp;  lines: +10 -10
update for version 2.6.1
----------------------------
revision 1.14.2.1
date: 2004/09/29 19:44:17;  author: ruim;  state: Exp;  lines: +75 -75
Sources from rfm repository
----------------------------
revision 1.15.2.2
date: 2003/04/17 17:11:44;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.15.2.1
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +9 -9
* update to HEAD
----------------------------
revision 1.56.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.56.4.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.56.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/io_defs.h,v
Working file: io_defs.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.5
keyword substitution: kv
total revisions: 6;	selected revisions: 6
description:
----------------------------
revision 1.6
date: 1999/10/25 05:58:38;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5
date: 1999/09/03 19:43:00;  author: warren;  state: Exp;  lines: +2 -1
Added a call to clearerr to the general file_function call.
----------------------------
revision 1.4
date: 1999/08/18 05:49:20;  author: kifer;  state: Exp;  lines: +2 -2
changed pipe2file to fd2ioport
Changed references to xsb file descriptors to xsb I/O ports, to avoid
confusion
----------------------------
revision 1.3
date: 1999/08/17 06:34:13;  author: kifer;  state: Exp;  lines: +3 -1
Added pipe_open, pipe2file.
Fixed compilation bugs on NT from yesterday's.
----------------------------
revision 1.2
date: 1999/08/16 07:24:21;  author: kifer;  state: Exp;  lines: +3 -1
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.1
date: 1999/08/09 00:34:26;  author: kifer;  state: Exp;
Added process control builtins, deprecated unix.P,
added C preprocessor.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/io_defs_xsb.h,v
Working file: io_defs_xsb.h
head: 1.18
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.18
	ROLLBACK: 1.13
	latest_plus_supp_branch: 1.13.0.4
	latest_plus_supp: 1.13
	Version_3dot2_plus_supp: 1.13.0.2
	release_2_6_plus_supp: 1.4.0.10
	Version_3dot2: 1.13
	dec07-perf-results: 1.13
	mt_thesis: 1.11
	release_3_0: 1.11
	release_2_7_0: 1.10
	multi-threaded-26-engine: 1.4.8.1
	pre-mt: 1.10
	multi-threaded-25-engine-done: 1.4.8.1
	multi-threaded-25-engine: 1.4.0.8
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.6
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.4
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.2
	release_2_4: 1.4
	release_2_3: 1.3
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 24;	selected revisions: 24
description:
----------------------------
revision 1.18
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.17
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.16
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2007/06/01 22:47:06;  author: tswift;  state: Exp;  lines: +9 -1
branches:  1.13.4;

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.12
date: 2007/04/16 16:14:16;  author: tswift;  state: Exp;  lines: +6 -1

Got rid of some unnecessary calls to string_find().  There are
plenty left due to ctop_string() calls.

--- It turned out that read/[1,2] was interning each token 3
    times, and I got rid of 2 of those 3, by tweaking the builtin
    call and by redefining the unnecessary read_getcon.

-- It also turned out that nl, and file_nl were performing
   unnecessary string interns because of windows_os_loader.  I
   got rid of that function and moved file_nl to C (in
   file_function).  Also, I redefined nl/0 to call file_nl.
----------------------------
revision 1.11
date: 2005/12/31 01:43:35;  author: tswift;  state: Exp;  lines: +3 -1
Changes to mutex handling for IO that should affect only the MT
engine. Rather than having a global IO mutex, I've added a mutex
for each stream, and used MUTEX_IO to lock the open_files array
itself.  This change was prompted by the fact that I can't have
one thread waiting on an input-stream via, say, a read and have
that thread create other threads that write to the output stream
and exit when done.

The result is that we no longer have contention when different
threads write to different streams.  At the same time, we end up
doing no more locking than before -- a little less, in fact due
to some manipulations in xsb_writ.P Unfortunately, the stream
mutexes are recursive (as with MUTEX_IO).  We can't get rid of
this until we rewrite write_term.

Now, back to handling memory_errors.
----------------------------
revision 1.10
date: 2004/09/28 17:24:46;  author: tswift;  state: Exp;  lines: +4 -1

Second pass on streams.  Added new ISO predicates, improved functionality of stream-based
predicates and made all predicates work on files,
pipes and atoms, when applicable.  Added fcntl fuctionality for Cygwin.

Updated ODBC interface so that it uses a findall for the relational interface and
documented.

Updated documentation: rewrote section on streams; rearranged sections on OS interaction;
added sections on typing for errors, on redefinition of standard predicates, and started
a section on ISO compatability.
----------------------------
revision 1.9
date: 2004/09/10 17:29:44;  author: tswift;  state: Exp;  lines: +10 -4

Main changes were to allow both pipes and atoms (strings) to be opened, closed, read,
written by ISO predicates.  Test suite works and playing around seems to work but I still
have to go through the I/O routines systematically.  So there will be more changes over the
next few days.

In addition, I also am starting to keep track of whether the stream is binary or not, although
I'm not yet doing anything with it.
----------------------------
revision 1.8
date: 2004/09/02 19:48:52;  author: tswift;  state: Exp;  lines: +6 -1

1) added ISO predicates peek_char/1,2 peek_code/1,2, at_end_of_stream/1,2
set_stream_position/2

2) A bit of code cleanup by fixing print_openfiles.

3) Fixed error in spawning processes intro'd by new stream stuff.

4) Revised I/O documentation (more to come).
----------------------------
revision 1.7
date: 2004/08/31 15:14:11;  author: tswift;  state: Exp;  lines: +7 -2

Added close/2 predicate

Added C-level xsb_permission_error()

Fixed various small buglets and forgotten cases in streams and I/O.
----------------------------
revision 1.6
date: 2004/08/29 22:57:04;  author: tswift;  state: Exp;  lines: +20 -2

The following are the major changes.

1) Started adding checks to the ISO predicates, to make sure they are called with proper
Stream or alias terms, that are open and of the right mode.  All ISO stream predicates now
also allow aliases, by the way.

2) Made a first pass at stream_property/1, open/4, along with some other predicates.

3) Updated documentation.

More to come...
----------------------------
revision 1.5
date: 2004/04/19 18:30:56;  author: dwarren;  state: Exp;  lines: +3 -1
Added option to read a line directly into codes, without going through inserting
the line into the atom table.
----------------------------
revision 1.4
date: 2001/03/26 04:59:02;  author: kifer;  state: Exp;  lines: +1 -5
branches:  1.4.8;
got rid of the FILE_STAT builtin, replaced with the one in system_xsb.c
Added more path_sysop goodies.
----------------------------
revision 1.3
date: 2000/12/27 00:30:05;  author: kifer;  state: Exp;  lines: +2 -1
Incorporated push/pop_stdin to improve handling of the -e option.
----------------------------
revision 1.2
date: 1999/11/23 04:06:44;  author: kifer;  state: Exp;  lines: +2 -1
branches:  1.2.4;
Added tmpfile_open.
Cleaned up the file opening modes stuff.
----------------------------
revision 1.1
date: 1999/10/25 05:58:38;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2.4.2
date: 2000/12/19 15:58:16;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.4.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.8.1
date: 2004/09/29 19:44:17;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.13.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.13.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.13.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/load_seg.c,v
Working file: load_seg.c
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	without-attv: 1.6
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.8
date: 1999/10/10 11:38:10;  author: kostis;  state: dead;  lines: +1 -1
Changes to fold code of file "load_seg.c" into "loader.c" and thus avoid
communication between these two pieces of code through horrible global
variables.  Files "load_seg.*" are removed.  Some code cleanup took place.
----------------------------
revision 1.7
date: 1999/10/09 16:48:27;  author: kostis;  state: Exp;  lines: +218 -230
Cleanup changes.
----------------------------
revision 1.6
date: 1999/10/05 04:01:42;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.5
date: 1999/08/16 07:24:21;  author: kifer;  state: Exp;  lines: +5 -3
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.4
date: 1999/08/10 14:39:33;  author: warren;  state: Exp;  lines: +1 -2
removed setting of hptr, which should have been eliminated when memory
management was improved.
----------------------------
revision 1.3
date: 1999/08/04 14:41:59;  author: ejohnson;  state: Exp;  lines: +5 -7
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.2
date: 1999/01/31 14:02:30;  author: kostis;  state: Exp;  lines: +171 -172
Mostly cleanup changes to simplify "tries.h".  Lots of junk code has been
removed and things that are not needed in other files have been moved to
"tries.c".
----------------------------
revision 1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:17;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/load_seg.h,v
Working file: load_seg.h
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	without-attv: 1.2
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.3
date: 1999/10/10 11:38:08;  author: kostis;  state: dead;  lines: +1 -1
Changes to fold code of file "load_seg.c" into "loader.c" and thus avoid
communication between these two pieces of code through horrible global
variables.  Files "load_seg.*" are removed.  Some code cleanup took place.
----------------------------
revision 1.2
date: 1999/07/20 18:54:41;  author: kifer;  state: Exp;  lines: +1 -3
added open_process_pipe/close_process_pipe,
open_process_stream/close_process_stream
----------------------------
revision 1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/loader.c,v
Working file: loader.c
head: 1.15
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.13
	without-attv: 1.10
	release-2-0: 1.7
	pre-release-2-0: 1.7
	v1-9-8: 1.4
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.15
date: 1999/10/25 05:58:40;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.14
date: 1999/10/18 20:11:02;  author: luis;  state: Exp;  lines: +6 -2
- bugfix: tests size of ldoptions string BEFORE reading it from object
file
----------------------------
revision 1.13
date: 1999/10/10 16:15:51;  author: kifer;  state: Exp;  lines: +2 -2
replaced xsb_exit with xsb_abort.
----------------------------
revision 1.12
date: 1999/10/10 11:38:06;  author: kostis;  state: Exp;  lines: +420 -16
Changes to fold code of file "load_seg.c" into "loader.c" and thus avoid
communication between these two pieces of code through horrible global
variables.  Files "load_seg.*" are removed.  Some code cleanup took place.
----------------------------
revision 1.11
date: 1999/10/09 16:48:26;  author: kostis;  state: Exp;  lines: +149 -161
Cleanup changes.
----------------------------
revision 1.10
date: 1999/08/30 13:57:25;  author: kostis;  state: Exp;  lines: +232 -243
Unused and obsolete PSC stuff taken out.
----------------------------
revision 1.9
date: 1999/08/16 07:24:22;  author: kifer;  state: Exp;  lines: +21 -22
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.8
date: 1999/08/04 14:42:00;  author: ejohnson;  state: Exp;  lines: +9 -9
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.7
date: 1999/03/18 20:18:07;  author: warren;  state: Exp;  lines: +4 -4
Modified error/warning messages for old bytecode formats.
----------------------------
revision 1.6
date: 1999/03/18 01:24:46;  author: cbaoqiu;  state: Exp;  lines: +26 -16
Add some warning messages when the user load an old .O file.
----------------------------
revision 1.5
date: 1999/03/06 07:21:47;  author: cbaoqiu;  state: Exp;  lines: +15 -2
Changed loader() so that old byte code format is allowed, but the
users are given a warning message and recommended to recompile the
file.
----------------------------
revision 1.4
date: 1999/01/19 13:40:13;  author: kostis;  state: Exp;  lines: +3 -3
Clean up change.
----------------------------
revision 1.3
date: 1998/12/21 01:46:06;  author: cbaoqiu;  state: Exp;  lines: +3 -1
Define V2_OBJECT_FORMAT.  Only allow new object file format.
----------------------------
revision 1.2
date: 1998/12/21 01:08:32;  author: cbaoqiu;  state: Exp;  lines: +34 -23
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/loader.h,v
Working file: loader.h
head: 1.4
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.3
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 5;	selected revisions: 5
description:
----------------------------
revision 1.4
date: 1999/10/25 05:58:42;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3
date: 1999/10/10 11:38:07;  author: kostis;  state: Exp;  lines: +8 -5
Changes to fold code of file "load_seg.c" into "loader.c" and thus avoid
communication between these two pieces of code through horrible global
variables.  Files "load_seg.*" are removed.  Some code cleanup took place.
----------------------------
revision 1.2
date: 1999/10/09 16:48:27;  author: kostis;  state: Exp;  lines: +20 -24
Cleanup changes.
----------------------------
revision 1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/loader_defs.h,v
Working file: loader_defs.h
head: 1.4
branch:
locks: strict
access list:
symbolic names:
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.4
date: 2002/03/15 09:19:50;  author: kifer;  state: dead;  lines: +1 -1
renamed loader_defs.h to extensions.h
----------------------------
revision 1.3
date: 2002/03/15 08:09:43;  author: kifer;  state: Exp;  lines: +5 -5
conversion to .xwam
----------------------------
revision 1.2
date: 2002/03/14 09:55:03;  author: kifer;  state: Exp;  lines: +2 -2
use variables instead of explicit .O in makefiles
----------------------------
revision 1.1
date: 2002/03/13 10:17:47;  author: kifer;  state: Exp;
replaced file extensions with defined preprocessor constants in preparation to
the objfile extension switch
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/loader_xsb.c,v
Working file: loader_xsb.c
head: 1.93
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.88
	ROLLBACK: 1.83
	latest_plus_supp_branch: 1.83.0.2
	latest_plus_supp: 1.83
	Version_3dot2_plus_supp: 1.81.0.2
	release_2_6_plus_supp: 1.31.0.4
	Version_3dot2: 1.81
	dec07-perf-results: 1.70
	mt_thesis: 1.64
	release_3_0: 1.62
	release_2_7_0: 1.34
	multi-threaded-26-engine: 1.23.4.2
	pre-mt: 1.34
	multi-threaded-25-engine-done: 1.23.4.1
	multi-threaded-25-engine: 1.23.0.4
	release_2_6_1: 1.31
	release_2_6_final: 1.31
	release_2_6: 1.31.0.2
	last-merged-to-demand: 1.27
	demand_branch: 1.27.0.2
	before_removing_chat: 1.23
	release_2_5: 1.23
	pre-merge-slgwam-gc: 1.23
	multi-threaded-c-engine: 1.23.0.2
	release_2_4: 1.23
	release_2_3: 1.20
	multi-threaded-engine: 1.18.0.2
	pre-threading: 1.16
	release-2-2: 1.13
	chat-and-local: 1.13.0.2
	xsb-pre-cleanup: 1.13
	release-2-1: 1.4
	release-2-0-1: 1.3
keyword substitution: kv
total revisions: 101;	selected revisions: 101
description:
----------------------------
revision 1.93
date: 2011/09/14 18:24:26;  author: dwarren;  state: Exp;  lines: +26 -18
Fixed bugs in xsb-profiling in the 64-bit ports, and added compiled index records
to the profiling data structure to improve coverage.
----------------------------
revision 1.92
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +3 -3
Getting Linux to Work
----------------------------
revision 1.91
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +35 -34
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.90
date: 2011/05/16 01:03:30;  author: kifer;  state: Exp;  lines: +33 -25
squash warnings on windows and linux
----------------------------
revision 1.89
date: 2011/05/01 09:36:18;  author: kifer;  state: Exp;  lines: +3 -1
killed most of the warnings
fixed makefile bug
----------------------------
revision 1.88
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.87
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.86
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.85
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.84
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.83
date: 2009/11/25 16:51:57;  author: dwarren;  state: Exp;  lines: +28 -8
branches:  1.83.2;
Changes to runtime to support import-as, as in:
:- import member/2 from basics as mymember/2.
This creates a new psc for mymember/2 in the current module that is
tied to the definition of member/2 in basics.  Dynamic loading is supported.
This supports declarations such as:
:- export member/2.
:- import member/2 from basics as member/2.
in a file named listutils.P
This would allow member to be imported from listutils, but remain defined in basics.
(The cost is an extra branch when calling it through listutils.)
----------------------------
revision 1.82
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.81
date: 2008/11/12 20:59:37;  author: dwarren;  state: Exp;  lines: +13 -2
Changed check for over-loading a predicate, to make it easier to change.
----------------------------
revision 1.80
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +3 -4
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.79
date: 2008/10/24 18:55:20;  author: dwarren;  state: Exp;  lines: +5 -1
A couple of minor changes:
1. Use case-insensitive compare of filenames for redefining test on Windows machines.
2. Minor change to Profiling to accumulate interrupt counts and apply all to the
point of the next interrupt.  This now seems to me to be slightly better.  It doesn't
much change the few profiles I tested, but it seems better to me, so...
----------------------------
revision 1.78
date: 2008/10/16 17:57:58;  author: dwarren;  state: Exp;  lines: +33 -35
Use data field in psc-records for predicates loaded into usermod to point
to the full filename of the file from which it was loaded.  Used this to
print a warning when XSB loads code for a usermod predicate that was previously
defined from a different file.
Will look at extending current_predicate to return this information, but that
has not yet been done.
----------------------------
revision 1.77
date: 2008/10/10 14:54:01;  author: dwarren;  state: Exp;  lines: +82 -4
Added a check if redefining a predicate will release code that
is currently being executed.  This catches rare but very obscure
problems that are very difficult to track down.

I'm thinking of adding a warning if you redefine a predicate from a
different file.  It would require keeping for each usermod predicate
the file from which it was defined.  The flat predicate namespace of
usermod is getting to be a problem for our large and spreadout programs.
(If they'd only use modules...)
----------------------------
revision 1.76
date: 2008/09/04 19:19:17;  author: tswift;  state: Exp;  lines: +2 -2

Tiny change to output a more meaningful error message.
----------------------------
revision 1.75
date: 2008/05/07 15:08:31;  author: dwarren;  state: Exp;  lines: +2 -1
To make snprintf available where it is not needed in systems
in which it is not in the library (as MSWIN)
----------------------------
revision 1.74
date: 2008/04/06 23:04:22;  author: tswift;  state: Exp;  lines: +2 -2
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.73
date: 2008/03/27 19:55:17;  author: tswift;  state: Exp;  lines: +10 -4

A few minor changes for error handling:

Improved error reporting for predicates that call the new C
convert_to_dyna()

Introduced iso_ptoc_callable_arg(), (for now, used only in convert_to_dyna())
----------------------------
revision 1.72
date: 2008/02/18 20:16:04;  author: tswift;  state: Exp;  lines: +17 -12

loader_xsb.c - changed environment conflict message from an xsb_error
(a soft error) to a warning.  Two things prompted me to do this.

First, this sort of soft error seems a bit confusing with our (mostly)
ISO-compatable notion of what an error is.  Second, after emitting the
message, calls proceed correctly -- so a warning seems a better choice.
----------------------------
revision 1.71
date: 2008/02/16 18:00:42;  author: dwarren;  state: Exp;  lines: +25 -1
Add new instructions putdfloat and getdfloat to handle double floats.
Update the loader to load these instructions from the xwam files.
(There is a possible problem.  The doubles are written into the xwam
file as bitstrings, and read by the loader as the same bitstring.  If
representations on different machines are different, then xwam files
compiled on one system won't run on another.)
----------------------------
revision 1.70
date: 2007/11/15 23:02:14;  author: tswift;  state: Exp;  lines: +22 -4
Update for handling thread_private/1 declarations when
--shared_predicates is defined.  The loader wasn't properly setting
the SHARED_DET bit so that the shared bits were ignored for
thread_private.  In addition, the loader sometimes overwrote
thread_private to thread_shared during import of a predicate by a
module.

These problems affected exception balls when XSB was called with
shared_predicates.  Anyway this seems to fix the bug discovered by the
logtalk benchmark examples.

Added a test to mttest to make sure this continues to work.
----------------------------
revision 1.69
date: 2007/11/01 23:46:59;  author: tswift;  state: Exp;  lines: +6 -2


Added a command-line argument, --shared-predicates which, in the MT
engine makes dynamic code and tables shared by default.  If this
command-line argument is not used.  The default behavior is kept in a
flag so it can be queried, but not changed during run time.

Also, fixed a bug in dynamic as an executable directive.  ?-
dyanamic(p/n) succeeded even when p/n was static -- worse, it actually
CHANGED p/n to dynamic, working like an abolish for static predicates.
Don't know how that got in there.
----------------------------
revision 1.68
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +9 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.67
date: 2007/02/28 15:02:08;  author: dwarren;  state: Exp;  lines: +2 -2
Minor fix (in case of profiling) to refusal to reload catch/3
----------------------------
revision 1.66
date: 2007/02/27 18:53:15;  author: dwarren;  state: Exp;  lines: +7 -2
Changed loader to refuse to re-load standard:catch/3, since a pending
catch will have a pointer into the old catch code.  So moving the code
is not a good idea.  So this just refuses to load a new version of that
code.
----------------------------
revision 1.65
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +9 -9
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.64
date: 2006/11/21 01:22:12;  author: ruim;  state: Exp;  lines: +3 -3
activated parameter --max_threads by replacing MAX_THREADS with max_threads_glc
----------------------------
revision 1.63
date: 2006/11/20 16:53:42;  author: ruim;  state: Exp;  lines: +4 -4
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.62
date: 2006/06/23 14:53:10;  author: tswift;  state: Exp;  lines: +4 -1

Added extern_ macros for C interface functions not yet covered.

Change to box_defines.h to get rid of whitespace before #endif (non-portable)
----------------------------
revision 1.61
date: 2006/06/20 14:14:43;  author: dwarren;  state: Exp;  lines: +1 -1
Add a coercion to shut up the VERY picky MSVC.
----------------------------
revision 1.60
date: 2006/06/11 21:35:10;  author: tswift;  state: Exp;  lines: +3 -2



Changes to make the low-level C interface work with the multi-threaded
engine.  The changes are as follows:

1) call_forn now calls a single-parameter function with CTXT in the MT
   engine, while the sequential engine calls a parameterless function.

2) Compiltion of a foreign file (foreign.P) now writes a different
   magic number depending on whether the compilation was done with the
   sequential or multi-threaded engine.  Then when consulting the file
   (in consult.P) a recompile is forced if the compiled file was
   compiled by MT if seq, and seq if MT.

3) Some C interface functions require a thread context to be passed
   and some dont, so I added some defines to handle this of the form

      extern_ptoc_xxx
      extern_ctop_xxx
      extern_p2p_xxx
      extern_p2c_xxx
      extern_p2p_xxx
----------------------------
revision 1.59
date: 2006/06/01 13:20:40;  author: dwarren;  state: Exp;  lines: +3 -3
Minor improvement in error message.
----------------------------
revision 1.58
date: 2006/05/02 14:30:38;  author: dwarren;  state: Exp;  lines: +5 -6
Fixed loader to correctly reset (or not) tabled bit for predicate.
Required passing "defined" indication in symbol table from compiler.
----------------------------
revision 1.57
date: 2006/04/17 20:54:57;  author: tswift;  state: Exp;  lines: +2 -1

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.56
date: 2006/04/10 14:21:04;  author: dwarren;  state: Exp;  lines: +6 -4
Fixed so when loading a file that uses an already-defined dynamic predicate,
it doesn't change its tabling status.
----------------------------
revision 1.55
date: 2006/03/18 17:37:49;  author: tswift;  state: Exp;  lines: +17 -8
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.54
date: 2006/03/14 20:27:08;  author: dwarren;  state: Exp;  lines: +2 -2
Found why data field of psc was sometimes not set to module.
Fixed.  May not have got them all.
----------------------------
revision 1.53
date: 2006/02/27 22:03:46;  author: tswift;  state: Exp;  lines: +3 -3
Some miscellaneous changes

1) abolish_table_pred now emits a warning when the table has a
   leaf node with a delay list -- this could cause dangling
   pointers for dependency checking.  Also, modified an error.

2) trie_interned now throws an exception, rather than exiting on
   an error case.

3) max_threads is now a command-line option

4) Added a new define NON_OPT_COMPILE, and memory mutexes are now
   used only with NON_OPT_COMPILE
----------------------------
revision 1.52
date: 2006/01/23 21:21:31;  author: tswift;  state: Exp;  lines: +19 -17

Fixed bug in is_incomplete: no overflow check was made before
allocating a completion suspension frame.

The bug was uncovered during testing thread-safety of the MT
engine.  This 1-line change took me most of the day to find ...
c'est la vie.
----------------------------
revision 1.51
date: 2006/01/17 21:50:20;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed to leave untagged integers in instructions, so compiler can
pass full 32-bit integers to runtime.  This (along with change to
flatten, in the compiler) should make the compiler handle full 32-bit
integers.  (Also fixed a bug in which boxed ints were being created
for small integers.)
----------------------------
revision 1.50
date: 2006/01/03 17:14:21;  author: dwarren;  state: Exp;  lines: +26 -13
Fixed float indexing problem in compiler.  Now indexes on floats should work.
(Still not very recommended, but at least the bit patterns pass through.)
Even though compiler still passes only single precision floats, at least now
all those bits are preserved, and converted to double on execution.
----------------------------
revision 1.49
date: 2005/12/12 00:19:12;  author: tswift;  state: Exp;  lines: +25 -13

Mutexed socket calls which dont seem to be mutexed.  Also added a
mutex around some rarely used string/symbol table statistics.

Other than that, documentation.
----------------------------
revision 1.48
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +17 -17
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.47
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +2 -2


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.46
date: 2005/11/13 21:38:37;  author: dwarren;  state: Exp;  lines: +6 -5
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.45
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +13 -16
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.44
date: 2005/09/13 13:02:04;  author: dwarren;  state: Exp;  lines: +3 -3
Fixed abolish_table_pred to work with private tables in multithreaded
(but there seems to be a memory leak that still needs to be tracked down.)
Also improved documentation of psc fields for tabling and sharedness.
Changed TDispBlk_t type for table dispatch blocks to allow direct coercion
to a TIF (so they agree on the psc and method fields.)
(Also, the load_backsuite test fails on cygwin, for a reason yet to be determined.)
----------------------------
revision 1.43
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +4 -4
Made pflags thread private
----------------------------
revision 1.42
date: 2005/08/16 19:19:09;  author: dwarren;  state: Exp;  lines: +14 -7
Changes for multi-threading:
1. Added open/4 to allow forcing of a new open.  open/3 returns previously opened
file (with same name and mode) if there is one.  This is needed in multithreading
to allow each thread to open the same file to read it.
2. Reworked how table directives are passed from the compiler to the execution
state.  It is now passed through the xwam files, and use_subsumptive_tabling
and use_variant_tabling is also passed this way.  shared/private, and tabling (variant
or subsumptive) tags are kept in the psc record (in bits in the env byte.)
This is not completely compatible with old .xwam files, so they shoudl be
recompiled.  If they aren't, then all tabled predicates are assumed to be tabled
with variant tabling, and a warning is given.
3. Updated the compiler so that most (all?) of its output files are now
written to explicit streams (instead of using tell.)
----------------------------
revision 1.41
date: 2005/08/10 19:34:42;  author: dwarren;  state: Exp;  lines: +4 -3
If any definition of a predicate is declared shared, it is taken as shared.
----------------------------
revision 1.40
date: 2005/08/08 21:25:02;  author: dwarren;  state: Exp;  lines: +4 -4
SImple cleanup, mostly using define-cons instead of numbers in various places.
----------------------------
revision 1.39
date: 2005/08/08 17:11:33;  author: dwarren;  state: Exp;  lines: +72 -16
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.38
date: 2005/08/08 15:11:25;  author: crojo;  state: Exp;  lines: +3 -23

Corrected the byte-backwards problem for floating points on a Mac.
----------------------------
revision 1.37
date: 2005/07/18 21:54:11;  author: crojo;  state: Exp;  lines: +26 -4
*** empty log message ***
----------------------------
revision 1.36
date: 2005/06/21 19:40:30;  author: dwarren;  state: Exp;  lines: +9 -3
Improved an error message.
----------------------------
revision 1.35
date: 2005/01/14 18:31:20;  author: ruim;  state: Exp;  lines: +9 -2
Integration of multithreaded system
----------------------------
revision 1.34
date: 2004/08/20 18:11:35;  author: dwarren;  state: Exp;  lines: +2 -2
Added uniavar and bldavar WAM instructions for processing anonymous variables.
Fixed a bug in backtrace due to cpreg being used in compiling inline disjunctions
   and thus not pointing after a call WAM instruction.
Fixed initialization to put system-defined constants/predicates (in particular ,/2)
   into both the particular module (standard) AND in usermod.
----------------------------
revision 1.33
date: 2004/03/08 13:56:28;  author: dwarren;  state: Exp;  lines: +2 -1
Added new instruction to compile new @= operator.
----------------------------
revision 1.32
date: 2004/01/14 20:27:12;  author: dwarren;  state: Exp;  lines: +11 -2
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.31
date: 2003/06/20 15:58:44;  author: lfcastro;  state: Exp;  lines: +4 -3
* Ensure only T_DYNA and T_PRED get their ->data field with module's
  PSC.
  Fixes problem with compiling xsb_configuration.P
----------------------------
revision 1.30
date: 2003/06/18 16:32:08;  author: lfcastro;  state: Exp;  lines: +16 -5
* disable conget/conset and psc_prop on predicate PSC's
----------------------------
revision 1.29
date: 2003/01/28 22:57:05;  author: dwarren;  state: Exp;  lines: +2 -2
Move write_canonical (and write_canonical_lettervars) to C.  Not for speed
but so that they can be accessed from C, and used in the ODBC interface to
write terms canonically to character fields.
----------------------------
revision 1.28
date: 2002/12/26 22:45:49;  author: tswift;  state: Exp;  lines: +16 -8

Just added a little documentation about loading undefined predicates.
----------------------------
revision 1.27
date: 2002/05/31 15:09:02;  author: lfcastro;  state: Exp;  lines: +12 -12
branches:  1.27.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.26
date: 2002/05/22 15:41:14;  author: lfcastro;  state: Exp;  lines: +4 -2
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.25
date: 2002/03/15 09:19:50;  author: kifer;  state: Exp;  lines: +2 -2
renamed loader_defs.h to extensions.h
----------------------------
revision 1.24
date: 2002/03/13 10:17:47;  author: kifer;  state: Exp;  lines: +5 -4
replaced file extensions with defined preprocessor constants in preparation to
the objfile extension switch
----------------------------
revision 1.23
date: 2001/07/02 17:14:00;  author: dwarren;  state: Exp;  lines: +3 -2
branches:  1.23.4;
Fix odd construction that gcc 3.0 complains about.
----------------------------
revision 1.22
date: 2001/03/23 03:51:41;  author: kifer;  state: Exp;  lines: +2 -2
replaced numeric consts with symbolic constants
----------------------------
revision 1.21
date: 2001/03/17 05:42:24;  author: kifer;  state: Exp;  lines: +11 -6
added explicit case to catch the user trying to compile a dynamic predicate
Can't load predicate now causes an abort.
----------------------------
revision 1.20
date: 2001/02/06 16:56:37;  author: lfcastro;  state: Exp;  lines: +5 -22
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.19
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +29 -4
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.18
date: 2000/06/28 16:54:51;  author: ruim;  state: Exp;  lines: +4 -4
branches:  1.18.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.17
date: 2000/06/28 06:41:39;  author: kifer;  state: Exp;  lines: +2 -2
added static to inline
----------------------------
revision 1.16
date: 2000/05/20 06:56:03;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.15
date: 2000/05/12 20:18:15;  author: ejohnson;  state: Exp;  lines: +3 -7
Fix for builtins abolish_all_tables and abolish_table_pred.
Checks that the subgoals are (marked as) complete before destroying
the tables.

Other supporting changes:

Added a field in TableInfoFrames (TIF) for maintaining references to
the subgoals according to predicate, rather than one global list.
Routines which walked this list had to be appropriately modified.

Discovered that TIFs weren't being counted in memory usage, so changed
their allocation to use mem_alloc() instead of malloc().

Moved the code which places a TIF on the alloc chain, maintained
through `first_tip' and `last_tip', into macro New_TIF().
Removed this code from biassert.c and loader_xsb.c.

Made a structure out of `first_tip' and `last_tip'.  Added an extern
for this structure to macro_xsb.h, and hence removed the externs from
biassert.c and builtin.c.  Modified references appropriately.

Producer subgoal frame allocation now puts the SF into the predicate's
TIF.
----------------------------
revision 1.14
date: 2000/04/29 21:53:55;  author: kifer;  state: Exp;  lines: +11 -11
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.13
date: 2000/03/01 16:22:34;  author: dwarren;  state: Exp;  lines: +5 -5
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.12
date: 2000/01/31 20:01:25;  author: unova;  state: Exp;  lines: +2 -2
64 bit integer sign extension fix for the loader.
This completes the 64 bit fixes for Jan 2000.
----------------------------
revision 1.11
date: 2000/01/27 23:07:14;  author: unova;  state: Exp;  lines: +2 -2
Partial fix for 64 bit architectures.
----------------------------
revision 1.10
date: 2000/01/07 08:51:38;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.9
date: 1999/12/22 18:07:00;  author: warren;  state: Exp;  lines: +6 -6
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.8
date: 1999/12/02 07:07:01;  author: kifer;  state: Exp;  lines: +21 -25
code cleanup.
----------------------------
revision 1.7
date: 1999/11/30 05:03:15;  author: kifer;  state: Exp;  lines: +46 -45
code cleanup
----------------------------
revision 1.6
date: 1999/11/29 03:01:53;  author: kifer;  state: Exp;  lines: +2 -2
Minor message change
----------------------------
revision 1.5
date: 1999/11/29 00:30:18;  author: kifer;  state: Exp;  lines: +4 -2
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.4
date: 1999/11/17 04:16:27;  author: kifer;  state: Exp;  lines: +2 -2
deleted "inlined" from read_magic
----------------------------
revision 1.3
date: 1999/11/03 21:35:46;  author: cbaoqiu;  state: Exp;  lines: +84 -62
Kostis' changes to support long atoms in compiled code.
----------------------------
revision 1.2
date: 1999/10/26 06:47:13;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:58:43;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.18.2.2
date: 2000/12/19 15:58:16;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.18.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +9 -2
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.23.4.2
date: 2004/10/18 20:46:06;  author: ruim;  state: Exp;  lines: +50 -27
update for version 2.6.1
----------------------------
revision 1.23.4.1
date: 2004/09/29 19:44:17;  author: ruim;  state: Exp;  lines: +9 -2
Sources from rfm repository
----------------------------
revision 1.27.2.1
date: 2003/04/17 17:11:44;  author: lfcastro;  state: Exp;  lines: +17 -9
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.83.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.83.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.83.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/loader_xsb.h,v
Working file: loader_xsb.h
head: 1.13
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.12
	ROLLBACK: 1.7
	latest_plus_supp_branch: 1.7.0.4
	latest_plus_supp: 1.7
	Version_3dot2_plus_supp: 1.7.0.2
	release_2_6_plus_supp: 1.4.0.12
	Version_3dot2: 1.7
	dec07-perf-results: 1.7
	mt_thesis: 1.7
	release_3_0: 1.7
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.4.10.1
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.4.10.1
	multi-threaded-25-engine: 1.4.0.10
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.8
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.6
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.4
	release_2_4: 1.4
	release_2_3: 1.4
	multi-threaded-engine: 1.4.0.2
	pre-threading: 1.4
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 19;	selected revisions: 19
description:
----------------------------
revision 1.13
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.12
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.11
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.10
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +1 -2
branches:  1.7.4;
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.6
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +3 -2
Made pflags thread private
----------------------------
revision 1.5
date: 2005/01/14 18:31:21;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.4
date: 2000/04/29 21:53:55;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.4.2;  1.4.10;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.3
date: 1999/11/30 05:03:16;  author: kifer;  state: Exp;  lines: +4 -2
code cleanup
----------------------------
revision 1.2
date: 1999/11/03 21:35:47;  author: cbaoqiu;  state: Exp;  lines: +2 -21
Kostis' changes to support long atoms in compiled code.
----------------------------
revision 1.1
date: 1999/10/25 05:58:44;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.4.10.1
date: 2004/09/29 19:44:17;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.4.2.2
date: 2000/12/19 15:58:16;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.4.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.7.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.7.4.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/macro_xsb.h,v
Working file: macro_xsb.h
head: 1.72
branch:
locks: strict
access list:
symbolic names:
	Version_3dot2_plus_supp: 1.70.0.2
	release_2_6_plus_supp: 1.21.0.4
	Version_3dot2: 1.70
	dec07-perf-results: 1.66
	mt_thesis: 1.59
	release_3_0: 1.48
	release_2_7_0: 1.21
	multi-threaded-26-engine: 1.17.2.2
	pre-mt: 1.21
	multi-threaded-25-engine-done: 1.17.2.1
	multi-threaded-25-engine: 1.17.0.2
	release_2_6_1: 1.21
	release_2_6_final: 1.21
	release_2_6: 1.21.0.2
	last-merged-to-demand: 1.20
	demand_branch: 1.20.0.2
	before_removing_chat: 1.17
	release_2_5: 1.17
	pre-merge-slgwam-gc: 1.16
	multi-threaded-c-engine: 1.16.0.2
	release_2_4: 1.16
	release_2_3: 1.16
	multi-threaded-engine: 1.15.0.2
	pre-threading: 1.10
	release-2-2: 1.6
	chat-and-local: 1.6.0.2
	xsb-pre-cleanup: 1.6
	release-2-1: 1.4
	release-2-0-1: 1.3
keyword substitution: kv
total revisions: 81;	selected revisions: 81
description:
----------------------------
revision 1.72
date: 2009/11/17 14:59:34;  author: tswift;  state: dead;  lines: +1 -1

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.71
date: 2009/04/25 17:24:52;  author: tswift;  state: Exp;  lines: +4 -1

Added a little documentation for an obscure function.
----------------------------
revision 1.70
date: 2009/01/10 23:37:07;  author: tswift;  state: Exp;  lines: +3 -3

Extended (almost) all the marking routines for tabled predicates
so that subgoals in the heap delay list are checked.  This rather
obscure bug caused a crash in a Flora program for defeasible
logic.  I'll try to finish that part tomorrow.

The problem was that space was reclaimed for a table T that had a
delay element in the heap pointing to it.  When the answer with
the delay element was added, the engine tried to adjust the
backpointers for T and crashed.

Also made some minor ajustments for efficency to some of the
marking functions.  And I changed abolish_table_info to the
clearer abolish_all_tables.
----------------------------
revision 1.69
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +10 -2


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.68
date: 2008/10/28 12:37:29;  author: tswift;  state: Exp;  lines: +3 -7

Fixed reporting of pthread_mutex routines.
----------------------------
revision 1.67
date: 2008/06/05 18:15:12;  author: ruim;  state: Exp;  lines: +16 -1
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.66
date: 2007/08/02 19:07:41;  author: tswift;  state: Exp;  lines: +5 -5

Minor optimization for thread dispatch blocks.
----------------------------
revision 1.65
date: 2007/07/23 16:18:43;  author: ruim;  state: Exp;  lines: +3 -1
small change to help portability for 64 bits
----------------------------
revision 1.64
date: 2007/07/08 01:24:32;  author: dwarren;  state: Exp;  lines: +4 -2
check for overflow for pdl stack (used for tries.)  Still exit, but at least
give appropriate overflow message, not just segfault.  (This happens
when naively tabling a CHR predicate, which tries to table a cyclic
term, which overflows pdl stack.)
----------------------------
revision 1.63
date: 2007/06/16 22:16:28;  author: tswift;  state: Exp;  lines: +20 -11

Fixed some bugs in table gc as uncovered by Flora.  These bugs related
to having "dangling" deltfs that pointed to structures that had
already been reclaimed.

1) Added a DELETED bit to subgoal frames to ensure that the same
   subgoal frame won't be added twice to a DelTF list.

2) Ensured that deltfs are freed whenever abolish_all_*_tables is
   called.  This prevents a case where a table is put on the deltf
   chain, abolish_all_tables frees it, and then gc tries to reclaim a
   stale subgoal or predicate.
----------------------------
revision 1.62
date: 2007/06/01 22:47:07;  author: tswift;  state: Exp;  lines: +45 -99

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.61
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +4 -4
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.60
date: 2007/01/25 20:33:54;  author: tswift;  state: Exp;  lines: +2 -2


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.59
date: 2006/12/07 00:26:45;  author: tswift;  state: Exp;  lines: +2 -1

-- Added reclamation of conditional answer information (including
   subgoal PNDEs and delay tries) when variant predicates/subgoals are
   abolished in abolish_table_pred/1, abolish_table_call/1, and
   close_open_tables/0.  Also, wrote delete_delay_trie() to delete
   answer substitution factor for delay elements, and made sure this
   was used whenever des are reclaimed -- (e.g. by abolishes and
   simplifications).

-- fixed some bugs in MT engine where situations could arise where
   trie allocation type was not properly set before abolishes called
   in table gc sweeps or reloading tabled predicates.

-- Fixed numerous bugs in performing simplification in the MT engine.
   In general simplification routines may reclaim structures for delay
   lists, delay elements, answer branches, asis and pndes.  Whenever
   any of these structures are reclaimed in the MT engine a check must
   be made to determine whether these elements use private or shared
   memory management -- either struture managers or the managers for
   des/dls/pndes.  Keeping all of this straight required some thinking
   as the code flits from table to table by traversing pndes --
   however I think I was able to extend the code without undue mess
   (at least this time :-)
----------------------------
revision 1.58
date: 2006/12/03 17:09:28;  author: ruim;  state: Exp;  lines: +1 -29
Bug fix for concurrent completion:
  added a lock to protect insertion of consumers on subgoal asf list
----------------------------
revision 1.57
date: 2006/11/29 02:10:20;  author: ruim;  state: Exp;  lines: +2 -1
fixed shared completed tables call trie lock bug - it was an optical
ilusion because of the tangled if-ifdef structure

initialize lock even for private tifs, just in case they become shared
removed ifdef out incremental stuff for mt that looked prejudicial
----------------------------
revision 1.56
date: 2006/11/26 23:43:43;  author: tswift;  state: Exp;  lines: +3 -1

 changes involve memory allocation
 for the dynamic clause garbage collection frames: rather than
 using malloc() and free() for these frames, I changed the
 various retract(all)s to use structure managers.  This has two
 advantages: first the structure managers are more efficient
 overall than using malloc and free, and second, in the
 multi-threaded engine we now use private structure mangers to
 manage the dynamic gc frames for private dynamic predicates,
 increaing potential concurrency.

Also, changes to experimental retract.
----------------------------
revision 1.55
date: 2006/11/20 16:53:42;  author: ruim;  state: Exp;  lines: +8 -8
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.54
date: 2006/11/08 01:42:57;  author: ruim;  state: Exp;  lines: +2 -1
eliminated bug in releasing private tables
----------------------------
revision 1.53
date: 2006/11/06 12:02:19;  author: ruim;  state: Exp;  lines: +5 -3
Taken out lock on subgoal frame as it doesn't seem necessary
Fixed check for reclamation of private tables answer return list
for concurrent completion
----------------------------
revision 1.52
date: 2006/11/05 23:53:14;  author: ruim;  state: Exp;  lines: +50 -25
Several changes & fixes for Concurrent Completion:
- Locking of the answer return list and consumer list at subgoal frame level
- No longer a dummy generator choice point is created for every external
  consumer
- Threads which don't have a stale view of the round are no longer awaken at
  completion
- The answer return list is not reclaim for shared tables
----------------------------
revision 1.51
date: 2006/11/05 13:59:43;  author: ruim;  state: Exp;  lines: +16 -1
added lock to call trie in MT
private tables initialize and destroy the lock, but don't use it
otherwise
----------------------------
revision 1.50
date: 2006/09/22 23:41:26;  author: tswift;  state: Exp;  lines: +2 -4
Fixes to get clean run of testsuite under Valgrind for uential
engine.  Most of these were inconsequential and were easily
fixed.  One was non-trivial and exposed an obscure memory bug.

On line 304 of heap_xsb.c is the statement

  ls_top = top_of_localstk - 256;  /* extra space for environment above top */ \

I believe that David put this in a few months ago to fix a
problem with not copying over the topmost local stack environment
when reallocating the global and local stacks.  It fixed some
memory problems, and made XSB a bit more stable.

Since the same definition of ls_top is used for garbage
collecting, 256 uninitialized variables could be encountered
during GC, which could lead to problems.  In addition it is not
impossible that other C functions create "holes" in the heap (I
suspect build_delay_list() in residual.c but could be wrong on
that).  If these holes contain uninitialized cells, we could get
core dumps on GC.

My solution is to initialize cells in the glstack at init time,
and to initialize cells *between* the top of local stack and top
of heap at realloc time.

This hypothesis may seem obscure, but I've been chasing down bugs
the last few weekends that dont seem much more obscure than
this :-)

In addition, we're now set up so that we can rerun Valgrind to
find memory bugs after large changes to XSB.
----------------------------
revision 1.49
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +14 -1
Incremental Code Added.
----------------------------
revision 1.48
date: 2006/07/04 01:28:18;  author: tswift;  state: Exp;  lines: +2 -2

Fixed typo in the MT engine's handling of DelTF frames.  This fixes several bugs in the flora testsuite.
----------------------------
revision 1.47
date: 2006/04/17 20:54:57;  author: tswift;  state: Exp;  lines: +89 -1

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.46
date: 2006/04/07 19:34:07;  author: ruim;  state: Exp;  lines: +2 -2
fixed bad bug in private/shared subgoal frame
----------------------------
revision 1.45
date: 2006/03/27 00:13:54;  author: tswift;  state: Exp;  lines: +158 -8

1) Split DelTF chain into private and shared chains.  This fixed
   a bug with table garbage collection, but also enabled me to
   allow garbage collection of a threads private tables when
   there is more than one active thread.

2) Extended the delay of space reclamation to abolished subgoals,
   and added subgoal reclamation to the table garbage collector.

I also added tests for these: lease update the various test
suites as the gc stuff may be a little brittle.
----------------------------
revision 1.44
date: 2006/03/24 16:40:28;  author: tswift;  state: Exp;  lines: +19 -16

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.43
date: 2006/03/18 17:37:49;  author: tswift;  state: Exp;  lines: +48 -50
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.42
date: 2006/03/17 18:17:59;  author: tswift;  state: Exp;  lines: +46 -22


Some updates to fix bugs in table abolishing and garbage
collecting.  Many of the changes have to do with refactoring code
to make it a little faster as well as to reduce bugs.

In addition, there are associated additional files in the test suite.

I'll be making more changes, and hopefully finishing over the weekend.
----------------------------
revision 1.41
date: 2006/02/27 22:03:46;  author: tswift;  state: Exp;  lines: +1 -3
Some miscellaneous changes

1) abolish_table_pred now emits a warning when the table has a
   leaf node with a delay list -- this could cause dangling
   pointers for dependency checking.  Also, modified an error.

2) trie_interned now throws an exception, rather than exiting on
   an error case.

3) max_threads is now a command-line option

4) Added a new define NON_OPT_COMPILE, and memory mutexes are now
   used only with NON_OPT_COMPILE
----------------------------
revision 1.40
date: 2006/01/29 22:46:05;  author: ruim;  state: Exp;  lines: +2 -2
changed the dispatch block to 256.
added predicates to change the initial stack sizes of threads.
----------------------------
revision 1.39
date: 2006/01/12 21:33:50;  author: tswift;  state: Exp;  lines: +16 -50
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.38
date: 2006/01/09 00:06:31;  author: tswift;  state: Exp;  lines: +17 -10
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.37
date: 2005/12/22 23:33:56;  author: tswift;  state: Exp;  lines: +33 -6

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.36
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +5 -5
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.35
date: 2005/11/10 16:42:24;  author: dwarren;  state: Exp;  lines: +3 -3
Minor cleanup of malloc vs. mem_alloc and free vs. mem_dealloc
----------------------------
revision 1.34
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +84 -14


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.33
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;  lines: +7 -1
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.32
date: 2005/09/13 13:02:04;  author: dwarren;  state: Exp;  lines: +6 -5
Fixed abolish_table_pred to work with private tables in multithreaded
(but there seems to be a memory leak that still needs to be tracked down.)
Also improved documentation of psc fields for tabling and sharedness.
Changed TDispBlk_t type for table dispatch blocks to allow direct coercion
to a TIF (so they agree on the psc and method fields.)
(Also, the load_backsuite test fails on cygwin, for a reason yet to be determined.)
----------------------------
revision 1.31
date: 2005/09/01 18:37:06;  author: tswift;  state: Exp;  lines: +81 -19


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.30
date: 2005/08/28 16:42:28;  author: ruim;  state: Exp;  lines: +9 -2
phase 1 of implementation of concurrent completion
----------------------------
revision 1.29
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +2 -2
made private flags array for sequential engine
----------------------------
revision 1.28
date: 2005/08/16 19:19:09;  author: dwarren;  state: Exp;  lines: +17 -2
Changes for multi-threading:
1. Added open/4 to allow forcing of a new open.  open/3 returns previously opened
file (with same name and mode) if there is one.  This is needed in multithreading
to allow each thread to open the same file to read it.
2. Reworked how table directives are passed from the compiler to the execution
state.  It is now passed through the xwam files, and use_subsumptive_tabling
and use_variant_tabling is also passed this way.  shared/private, and tabling (variant
or subsumptive) tags are kept in the psc record (in bits in the env byte.)
This is not completely compatible with old .xwam files, so they shoudl be
recompiled.  If they aren't, then all tabled predicates are assumed to be tabled
with variant tabling, and a warning is given.
3. Updated the compiler so that most (all?) of its output files are now
written to explicit streams (instead of using tell.)
----------------------------
revision 1.27
date: 2005/08/13 15:04:02;  author: ruim;  state: Exp;  lines: +2 -2
changed defines to allow concurrent completion
made batch compile under mt
----------------------------
revision 1.26
date: 2005/08/08 17:11:33;  author: dwarren;  state: Exp;  lines: +17 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.25
date: 2005/07/21 21:04:24;  author: dwarren;  state: Exp;  lines: +18 -1
When tabled dynamic code was abolished, the TIF and any tables computed for
that dynamic predicate were left around and their space not reclaimed.  This
update reclaims the table space and the TIF.
Also, abolish did not retract the fact that the dynamic predicate was tabled,
so this update fixes that as well.
----------------------------
revision 1.24
date: 2005/07/20 16:00:56;  author: ruim;  state: Exp;  lines: +8 -1
changed tid from generator cp to sf in preparation for deadlock breaking
----------------------------
revision 1.23
date: 2005/07/18 19:47:45;  author: tswift;  state: Exp;  lines: +3 -3

picayune (my word for the day) changes in predicate names and a little added documentation
based on reviewing abolish_table_pred and friends.
----------------------------
revision 1.22
date: 2005/01/14 18:31:21;  author: ruim;  state: Exp;  lines: +4 -4
Integration of multithreaded system
----------------------------
revision 1.21
date: 2002/10/04 20:42:01;  author: lfcastro;  state: Exp;  lines: +5 -1
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.20
date: 2002/05/22 15:41:14;  author: lfcastro;  state: Exp;  lines: +4 -2
branches:  1.20.2;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.19
date: 2002/03/13 22:40:13;  author: lfcastro;  state: Exp;  lines: +12 -2
* first step in implementing demand
- new (experimental) primitive: demand_once/1
- executes query and, after first answer is returned, deletes all
consumers created during execution; further, any tables created are
also destroyed
----------------------------
revision 1.18
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +2 -93
* Removal of Chat engine
----------------------------
revision 1.17
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +26 -37
branches:  1.17.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.16
date: 2001/01/31 10:23:29;  author: ejohnson;  state: Exp;  lines: +1 -10
Created the macro "table_pending_answer" to hide the details of
obtaining the next answer for consumption, which, in the case of a
properly subsumed subgoal, may require an answer identification step.

Second, removed -- again -- (most) "xtemp1" references.
(Argh!  How does this crap keep creeping back into the system?!?)

These were sprinkled over several files and removed by simply creating
a variable local to each macro in which a temp was needed.

The "need" for this change was precipitated due to the inclusion of an
"xtemp1" declaration within one of the code blocks which
table_pending_answer replaced.
----------------------------
revision 1.15
date: 2000/09/28 21:31:03;  author: ejohnson;  state: Exp;  lines: +14 -13
branches:  1.15.2;
Two subsumption-related changes:

(1) Support for incomplete subsumptive subgoals in tfindall/3.
    Two builtins needed modification:
    -- get_subgoal_ptr/2 ==> get_producer_subgoal_frame/2
         Now handles both variant and subsumptive subgoals, returning
	 the producing table entry.
    -- is_incomplete/4 ==> is_incomplete/2
         Now handles both variant and subsumptive subgoals.  Used to
	 encompass some of the functionality of get_subgoal_ptr/2, but
	 since the processing performed by that builtin is more complex,
	 this (partial) functionality is removed.

(2) Standard predicate delete_return/2 produces an error when invoked
    on a subsumptive table entry.
----------------------------
revision 1.14
date: 2000/06/26 19:09:26;  author: ruim;  state: Exp;  lines: +3 -3
Getting XSB to compile under g++ AGAIN
----------------------------
revision 1.13
date: 2000/06/25 16:59:15;  author: ejohnson;  state: Exp;  lines: +3 -3
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.12
date: 2000/06/23 20:54:08;  author: ruim;  state: Exp;  lines: +4 -4
Removed some C++ automatic pointer casting warnings
----------------------------
revision 1.11
date: 2000/06/22 01:27:51;  author: lfcastro;  state: Exp;  lines: +2 -1
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.10
date: 2000/05/29 04:23:36;  author: ejohnson;  state: Exp;  lines: +82 -69
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.9
date: 2000/05/25 00:32:01;  author: ejohnson;  state: Exp;  lines: +126 -89
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.8
date: 2000/05/12 20:18:15;  author: ejohnson;  state: Exp;  lines: +95 -66
Fix for builtins abolish_all_tables and abolish_table_pred.
Checks that the subgoals are (marked as) complete before destroying
the tables.

Other supporting changes:

Added a field in TableInfoFrames (TIF) for maintaining references to
the subgoals according to predicate, rather than one global list.
Routines which walked this list had to be appropriately modified.

Discovered that TIFs weren't being counted in memory usage, so changed
their allocation to use mem_alloc() instead of malloc().

Moved the code which places a TIF on the alloc chain, maintained
through `first_tip' and `last_tip', into macro New_TIF().
Removed this code from biassert.c and loader_xsb.c.

Made a structure out of `first_tip' and `last_tip'.  Added an extern
for this structure to macro_xsb.h, and hence removed the externs from
biassert.c and builtin.c.  Modified references appropriately.

Producer subgoal frame allocation now puts the SF into the predicate's
TIF.
----------------------------
revision 1.7
date: 2000/04/29 21:53:55;  author: kifer;  state: Exp;  lines: +6 -6
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.6
date: 2000/01/11 16:53:16;  author: ejohnson;  state: Exp;  lines: +8 -6
branches:  1.6.2;
Movement of definitions from one header to another; this then required
updating #includes for some files.

Predicate evaluation method #def's moved from file flag_defs_xsb.h to
new file table_status_defs.h which houses these and other new #def's.
----------------------------
revision 1.5
date: 1999/12/14 21:05:45;  author: ejohnson;  state: Exp;  lines: +2 -1
Added macro SubgoalHasOwnAnswerSet().
----------------------------
revision 1.4
date: 1999/11/17 17:41:57;  author: ejohnson;  state: Exp;  lines: +9 -9
Warning fixes, noticed under 64-bit mode compilation:
- type mismatches, in assignment and print formats
- unused variables
----------------------------
revision 1.3
date: 1999/10/26 17:19:27;  author: cbaoqiu;  state: Exp;  lines: +7 -1
Moved the definition of get_var_and_attv_nums from emudef.h to
macro_xsb.h.
----------------------------
revision 1.2
date: 1999/10/26 06:47:14;  author: kifer;  state: Exp;  lines: +2 -2
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:58:45;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.6.2.1
date: 2000/03/28 18:10:32;  author: lfcastro;  state: Exp;  lines: +7 -130
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.15.2.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.15.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +5 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.17.2.2
date: 2004/10/18 20:46:06;  author: ruim;  state: Exp;  lines: +18 -98
update for version 2.6.1
----------------------------
revision 1.17.2.1
date: 2004/09/29 19:44:17;  author: ruim;  state: Exp;  lines: +11 -6
Sources from rfm repository
----------------------------
revision 1.20.2.4
date: 2003/04/17 17:11:43;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.20.2.3
date: 2002/10/28 16:49:31;  author: lfcastro;  state: Exp;  lines: +4 -0
* Merge with HEAD
----------------------------
revision 1.20.2.2
date: 2002/08/29 14:17:13;  author: lfcastro;  state: Exp;  lines: +1 -1
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.20.2.1
date: 2002/08/10 00:19:35;  author: lfcastro;  state: Exp;  lines: +26 -2
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/main_xsb.c,v
Working file: main_xsb.c
head: 1.18
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.18
	ROLLBACK: 1.13
	latest_plus_supp_branch: 1.13.0.4
	latest_plus_supp: 1.13
	Version_3dot2_plus_supp: 1.13.0.2
	release_2_6_plus_supp: 1.5.0.12
	Version_3dot2: 1.13
	dec07-perf-results: 1.13
	mt_thesis: 1.10
	release_3_0: 1.10
	release_2_7_0: 1.5
	multi-threaded-26-engine: 1.5.10.1
	pre-mt: 1.5
	multi-threaded-25-engine-done: 1.5.10.1
	multi-threaded-25-engine: 1.5.0.10
	release_2_6_1: 1.5
	release_2_6_final: 1.5
	release_2_6: 1.5.0.8
	last-merged-to-demand: 1.5
	demand_branch: 1.5.0.6
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.4
	release_2_4: 1.5
	release_2_3: 1.5
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.5
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.2
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 24;	selected revisions: 24
description:
----------------------------
revision 1.18
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.17
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.16
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2007/07/22 18:40:48;  author: ruim;  state: Exp;  lines: +1 -4
branches:  1.13.4;
Changes to allow for main_xsb.c to link in under windows, for
the multi-threaded system.
----------------------------
revision 1.12
date: 2007/07/21 16:24:18;  author: ruim;  state: Exp;  lines: +4 -1
fixed find_context to work during xsb initialization
----------------------------
revision 1.11
date: 2007/01/12 23:33:28;  author: tswift;  state: Exp;  lines: +4 -4

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.10
date: 2005/12/22 23:33:56;  author: tswift;  state: Exp;  lines: +3 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.9
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +2 -2
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.8
date: 2005/07/18 21:54:11;  author: crojo;  state: Exp;  lines: +2 -2
*** empty log message ***
----------------------------
revision 1.7
date: 2005/06/29 13:58:15;  author: vidrevich;  state: Exp;  lines: +12 -4
incorporating multi-threading into C/XSB interface. In multi-threaded engine xsb_init() takes a pointer to the thread context structure as its first argument and populates that structure with main thread context information to be used in the consequent C/XSB calls. myargc,myargv are passed as the second and the third arguments to the xsb_init() when XSB is configured for multi-threading. Changes should not affect a single-threaded version.
----------------------------
revision 1.6
date: 2005/01/14 18:31:21;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.5
date: 2000/05/20 06:56:03;  author: kifer;  state: Exp;  lines: +4 -4
branches:  1.5.2;  1.5.10;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.4
date: 2000/01/07 08:51:40;  author: kifer;  state: Exp;  lines: +2 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.3
date: 1999/12/10 07:47:35;  author: kifer;  state: Exp;  lines: +2 -2
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.2
date: 1999/11/16 19:05:57;  author: kifer;  state: Exp;  lines: +2 -2
Revamped sockets interface.
----------------------------
revision 1.1
date: 1999/10/25 05:58:45;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5.10.1
date: 2004/09/29 19:44:17;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.13.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.13.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.13.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/memory.c,v
Working file: memory.c
head: 1.12
branch:
locks: strict
access list:
symbolic names:
	release-2-0: 1.7
	pre-release-2-0: 1.7
	v1-9-8: 1.7
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.12
date: 1999/10/05 04:01:45;  author: kifer;  state: dead;  lines: +1 -1
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.11
date: 1999/09/08 13:56:09;  author: warren;  state: Exp;  lines: +5 -3
fix warning of unused variable introduced by previous update.
----------------------------
revision 1.10
date: 1999/09/08 13:45:29;  author: warren;  state: Exp;  lines: +3 -1
ifdefed trail readjustment routine so that it is not called in CHAT
mode.  Fixed a CP reallocation problem.  Thanks to Bart!
----------------------------
revision 1.9
date: 1999/08/04 14:42:01;  author: ejohnson;  state: Exp;  lines: +1 -4
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.8
date: 1999/07/06 16:35:13;  author: ejohnson;  state: Exp;  lines: +2 -2
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.7
date: 1999/02/18 13:02:17;  author: kostis;  state: Exp;  lines: +16 -1
Changes to check for trail stack overflow in pushtrail0().
----------------------------
revision 1.6
date: 1999/02/10 15:46:09;  author: kifer;  state: Exp;  lines: +1 -2
got rid of malloc.h
----------------------------
revision 1.5
date: 1999/01/31 15:42:05;  author: kostis;  state: Exp;  lines: +14 -14
Changed use of obsolete function bcopy() to memmove().
----------------------------
revision 1.4
date: 1999/01/18 17:59:33;  author: kostis;  state: Exp;  lines: +1 -5
Changes to make ptcp pointing to subgoal frame independently of engine used.
----------------------------
revision 1.3
date: 1999/01/13 16:58:11;  author: kostis;  state: Exp;  lines: +7 -10
Small change to enable Trail/CP stack expansion in CHAT.
----------------------------
revision 1.2
date: 1998/12/21 01:08:34;  author: cbaoqiu;  state: Exp;  lines: +13 -1
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/memory.h,v
Working file: memory.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	release-2-0: 1.5
	pre-release-2-0: 1.4
	v1-9-8: 1.4
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.9
date: 1999/10/05 04:01:47;  author: kifer;  state: dead;  lines: +1 -1
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.8
date: 1999/08/16 07:24:23;  author: kifer;  state: Exp;  lines: +24 -25
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.7
date: 1999/08/04 14:42:02;  author: ejohnson;  state: Exp;  lines: +98 -77
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.6
date: 1999/07/15 21:41:14;  author: ejohnson;  state: Exp;  lines: +6 -1
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.5
date: 1999/05/17 17:20:52;  author: unova;  state: Exp;  lines: +3 -2
Moved reset_inst to init.c and aligned it to word
(must for the -t option in some machines)
----------------------------
revision 1.4
date: 1999/02/18 13:02:18;  author: kostis;  state: Exp;  lines: +2 -1
Changes to check for trail stack overflow in pushtrail0().
----------------------------
revision 1.3
date: 1999/02/05 16:07:05;  author: kostis;  state: Exp;  lines: +15 -22
Fixed memory relocation problems and cleaned up some garbage collection
related stuff.
----------------------------
revision 1.2
date: 1998/12/21 01:08:37;  author: cbaoqiu;  state: Exp;  lines: +13 -7
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/memory_defs.h,v
Working file: memory_defs.h
head: 1.1
branch:
locks: strict
access list:
symbolic names:
keyword substitution: kv
total revisions: 1;	selected revisions: 1
description:
----------------------------
revision 1.1
date: 2011/12/24 21:11:03;  author: tswift;  state: Exp;

Factored this out so we can use it for error messages in Prolog
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/memory_xsb.c,v
Working file: memory_xsb.c
head: 1.79
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.67
	ROLLBACK: 1.62
	latest_plus_supp_branch: 1.62.0.2
	latest_plus_supp: 1.62
	Version_3dot2_plus_supp: 1.58.0.2
	release_2_6_plus_supp: 1.9.0.6
	Version_3dot2: 1.58
	dec07-perf-results: 1.50
	mt_thesis: 1.39
	release_3_0: 1.30
	release_2_7_0: 1.10
	multi-threaded-26-engine: 1.6.6.2
	pre-mt: 1.10
	multi-threaded-25-engine-done: 1.6.6.1
	multi-threaded-25-engine: 1.6.0.6
	release_2_6_1: 1.9
	release_2_6_final: 1.9
	release_2_6: 1.9.0.4
	last-merged-to-demand: 1.9
	demand_branch: 1.9.0.2
	before_removing_chat: 1.6
	release_2_5: 1.6
	pre-merge-slgwam-gc: 1.6
	multi-threaded-c-engine: 1.6.0.4
	release_2_4: 1.6
	release_2_3: 1.6
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.5
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 88;	selected revisions: 88
description:
----------------------------
revision 1.79
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +2 -1

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.78
date: 2012/02/18 04:46:54;  author: kifer;  state: Exp;  lines: +3 -3
minated some compiler warnings
added DllExport to find_string, mem_alloc, mem_realloc.
----------------------------
revision 1.77
date: 2012/02/03 20:38:52;  author: tswift;  state: Exp;  lines: +2 -2
Got rid of stray printf.
----------------------------
revision 1.76
date: 2011/12/24 21:09:11;  author: tswift;  state: Exp;  lines: +113 -58

Changes	for memory managemement

1) Now supporting max_memory flag for user-defined memory limits

2) Changed some	  memory errors so that rather than creating an
exception ball,	  a flag is set; the exception handler then checks
for the flag.  The reason for doing this is that allocating
memory to assert an exception ball can get us into trouble.
----------------------------
revision 1.75
date: 2011/12/12 00:07:23;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed xor (and error message in memory_xsb.c)
----------------------------
revision 1.74
date: 2011/12/11 23:07:25;  author: dwarren;  state: Exp;  lines: +2 -2
A number of changes to fix bugs and make XSB more ISO compliant (from U.Neumerkel)
1. Made length/2 slightly more resiliant.
2. Added a cyclic term check in atom_codes.
3. fixed bug in call/n to non-existent predicate
4. Added new operators (for ISO): ^, div, xor (and changed ** to always return float.)
5. Added new ISO predicate names: acyclic_term, and subsumes_term.
6. Made number_codes/chars more ISO compliant (mostly on unusual inputs)
7. Increased precision of floating point numbers in write_canonical.
8. Added cputime to load message (if > 0.0 secs), desired by MK
9. Support reading and writing of 0-ary predicates in form p().  (This is not
	fully implemented and should not in general be used.)
----------------------------
revision 1.73
date: 2011/08/31 22:25:10;  author: tswift;  state: Exp;  lines: +3 -2
choice/trail exit to resource error; heap/local abort -> resource error
----------------------------
revision 1.72
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +8 -8
Getting Linux to Work
----------------------------
revision 1.71
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +32 -32
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.70
date: 2011/05/11 17:56:21;  author: tswift;  state: Exp;  lines: +5 -4
xsb_exit for resource error
----------------------------
revision 1.69
date: 2011/05/05 16:49:06;  author: tswift;  state: Exp;  lines: +3 -1
catching linux overflows
----------------------------
revision 1.68
date: 2011/03/11 16:55:17;  author: dwarren;  state: Exp;  lines: +3 -4
When GENERAL_TAGGING, added code (or commented some back in) to add
addresses in the trail to the general_tagging table.  Addresses in the
trail are tagged during garbage collection, when trail pointers into
the heap are reversed (and tagged.)
----------------------------
revision 1.67
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.66
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.65
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.64
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.63
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.62
date: 2010/01/23 19:03:02;  author: tswift;  state: Exp;  lines: +4 -4
branches:  1.62.2;

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.61
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.60
date: 2009/08/30 21:07:09;  author: tswift;  state: Exp;  lines: +11 -36

A few more updates to support atom space statistics in MT opt.
----------------------------
revision 1.59
date: 2009/08/30 19:42:28;  author: tswift;  state: Exp;  lines: +2 -6

Now accounting for space in all allocs (including optimal mt).
----------------------------
revision 1.58
date: 2009/03/29 16:32:50;  author: tswift;  state: Exp;  lines: +7 -3
Getting rid of an error message for a clean compile.
----------------------------
revision 1.57
date: 2009/03/14 22:46:21;  author: tswift;  state: Exp;  lines: +2 -2
Fixed problem introduced when trying to get rid of a compiler message.
----------------------------
revision 1.56
date: 2009/03/14 22:04:47;  author: tswift;  state: Exp;  lines: +2 -1

Very minor changes to shut up the compiler.
----------------------------
revision 1.55
date: 2009/02/21 23:13:07;  author: ruim;  state: Exp;  lines: +2 -2
fixed small problem in mt compilation
----------------------------
revision 1.54
date: 2009/02/21 19:39:53;  author: tswift;  state: Exp;  lines: +2 -2

Finish commit of Rui's change for deadlock bug.
----------------------------
revision 1.53
date: 2009/01/15 22:43:05;  author: dwarren;  state: Exp;  lines: +9 -8
One more example of incorrect release size, this time when expanding
the string hash table.  Now for the cases I tested, all blocks are freed
with the same length that they were allocated.  There is still some
discrepancy with the amount of table space claimed as allocated in statistics
and the amount of space obtained for table_space through mem_alloc (and
friends.)  That remains to be accounted for.
----------------------------
revision 1.52
date: 2009/01/15 18:53:47;  author: dwarren;  state: Exp;  lines: +19 -8
Fixed a bug in accounting for mem_dealloc size in a particular case
of table processing.  This makes the table space statistics (more) correct.
----------------------------
revision 1.51
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +40 -5
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.50
date: 2007/12/09 18:53:13;  author: ruim;  state: Exp;  lines: +33 -3
fixes to last change
had removed memory counters for sequential system!
----------------------------
revision 1.49
date: 2007/12/09 18:41:38;  author: ruim;  state: Exp;  lines: +6 -6
Removed global counters for stastics (including mem space values)
from multi-threaded system if not in debug mode.
Those counters were hurting scalability on a multi-processor badly
----------------------------
revision 1.48
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.47
date: 2007/07/03 14:56:53;  author: dwarren;  state: Exp;  lines: +2 -2
Commented out a couple of debugging log messages.
----------------------------
revision 1.46
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +2 -3

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.45
date: 2007/06/06 20:43:19;  author: tswift;  state: Exp;  lines: +12 -5

Trey Evan's updates for 64-bits.
----------------------------
revision 1.44
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +5 -6
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.43
date: 2007/01/25 20:33:55;  author: tswift;  state: Exp;  lines: +3 -2


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.42
date: 2007/01/16 03:43:58;  author: tswift;  state: Exp;  lines: +2 -2

Fixed typo for general tagging pointed out by Chris Rued.
----------------------------
revision 1.41
date: 2007/01/13 23:10:36;  author: tswift;  state: Exp;  lines: +34 -2
Put statistics about memory use in statistics(mutex) -- this should help in
tracking down when we're using too many  mallocs and frees which hurts scalability of the MT engine.  Right now they're only compiled in for NON-OPT-COMPILE.
----------------------------
revision 1.40
date: 2007/01/12 23:33:29;  author: tswift;  state: Exp;  lines: +1 -2

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.39
date: 2006/11/20 16:53:42;  author: ruim;  state: Exp;  lines: +2 -2
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.38
date: 2006/11/08 17:06:33;  author: ruim;  state: Exp;  lines: +7 -1
solved bug in CONC_COMPL involving completion stack expansion
taken out some unneeded ifded CONC_COMPL
----------------------------
revision 1.37
date: 2006/11/06 17:31:53;  author: ruim;  state: Exp;  lines: +19 -2
Fixes to CONC_COMPL:

- compl stack expansion fixed
- freeing of answer_return list finally fixed

it now runs all the tests that batched runs
----------------------------
revision 1.36
date: 2006/11/06 10:31:39;  author: ruim;  state: Exp;  lines: +4 -4
Changed counter to unsigned long
Changed several counting variables to unsigned
Fixed a wrong thing in previous memory_xsb.c fix
----------------------------
revision 1.35
date: 2006/11/06 08:15:20;  author: ruim;  state: Exp;  lines: +4 -2
updated comments
----------------------------
revision 1.34
date: 2006/11/06 08:04:21;  author: ruim;  state: Exp;  lines: +4 -3
replaced check with extra instruction after loop
to increase efficiency  of pointer check in tcp stack expansion
----------------------------
revision 1.33
date: 2006/11/06 07:56:04;  author: ruim;  state: Exp;  lines: +9 -1
Added error for tcp stack expansion with concurrent completion
----------------------------
revision 1.32
date: 2006/11/06 01:41:32;  author: tswift;  state: Exp;  lines: +3 -3

Change to prevent read outside of reallocated memory in tcpstack_realloc.  The read is probably harmless, but it does cause a number of valgrind error messages.
----------------------------
revision 1.31
date: 2006/11/05 11:50:32;  author: ruim;  state: Exp;  lines: +3 -2
Fixed bug in tcpstack_realloc that showed up at thread exit
----------------------------
revision 1.30
date: 2006/07/25 14:25:54;  author: dwarren;  state: Exp;  lines: +2 -0
Added commented out code for setting freed space to an odd bit pattern.
Useful for debugging memory management, and thought I'd keep it around
in case it might prove useful in the future.
----------------------------
revision 1.29
date: 2006/02/27 22:03:46;  author: tswift;  state: Exp;  lines: +28 -1
Some miscellaneous changes

1) abolish_table_pred now emits a warning when the table has a
   leaf node with a delay list -- this could cause dangling
   pointers for dependency checking.  Also, modified an error.

2) trie_interned now throws an exception, rather than exiting on
   an error case.

3) max_threads is now a command-line option

4) Added a new define NON_OPT_COMPILE, and memory mutexes are now
   used only with NON_OPT_COMPILE
----------------------------
revision 1.28
date: 2006/01/23 21:21:31;  author: tswift;  state: Exp;  lines: +3 -2

Fixed bug in is_incomplete: no overflow check was made before
allocating a completion suspension frame.

The bug was uncovered during testing thread-safety of the MT
engine.  This 1-line change took me most of the day to find ...
c'est la vie.
----------------------------
revision 1.27
date: 2005/12/31 23:16:03;  author: tswift;  state: Exp;  lines: +41 -6

Fixed problems with throwing memory errors from mem_xxxoc(), at
least in sequential engine.  When memory cannot be malloced, a
resource error is thrown.  Since throwing errors mallocs memory
in itself, mem_xxxocs used by a throw are changed into
mem_xxxoc_nochecks and an xsb_exit is called if these functions
return NULL pointers.  Care is taken so that when a resource
error is thrown, space for its PSCs has been pre-allocated, and
varstrings are used for the actual message strings (varstring
exits too, if there is not enough memory).

In MT engine, a memory error just exits -- this is because I need
a CTXT to throw an error.  Right now, I'm not sure whether its a
good idea or not to put CTXTs into mem_xxxoc or not.

Not that some of the biggest memory allocations, such as tcp
stack, local-heap stack use straight reallocs and use their own
error handling.

In general, we should be handling most memory errors in a
reasonable, or at least consistent, manner.
----------------------------
revision 1.26
date: 2005/12/29 18:06:50;  author: dwarren;  state: Exp;  lines: +4 -4
Minor fixes to Terry's changes to account for Windoze idiosyncracies:
call_conv in declaration in error_xsb.h
and Windoze's re_alloc returns NULL when given size of zero, so return NULL in these cases.
----------------------------
revision 1.25
date: 2005/12/26 18:48:54;  author: tswift;  state: Exp;  lines: +10 -10

Fixed compiler warning that I didn't notice before.
----------------------------
revision 1.24
date: 2005/12/26 17:17:20;  author: tswift;  state: Exp;  lines: +13 -4
Added check for null pointers to mem_xxxoc() functions.  Thanks to our
now strict use of mem_xxxoc() functions, this means we always check
for null pointers returned by malloc.  Next thing you know, I'll be
rotating my tires every year.  If we do get a null pointer, we call a
non-ISO xsb_memory_error().

Updated documentation in exceptions.tex, and in the course of so doing
added some new ISO-error types to error_handler.P.  There are still
corresponding functions to be added to error_xsb.c Other documentation
for setof and other accumulated changes.

The other change was to get rid of a few stray references to
resume_compl_suspension_inst2.
----------------------------
revision 1.23
date: 2005/12/22 23:33:57;  author: tswift;  state: Exp;  lines: +17 -12

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.22
date: 2005/11/20 21:23:29;  author: dwarren;  state: Exp;  lines: +10 -6
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.21
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +11 -11
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.20
date: 2005/11/13 21:38:37;  author: dwarren;  state: Exp;  lines: +4 -4
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.19
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +37 -1
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.18
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +2 -2
made private flags array for sequential engine
----------------------------
revision 1.17
date: 2005/07/20 21:42:45;  author: dwarren;  state: Exp;  lines: +1 -1
Moved the hacking of the enc/dec tables (when GENERAL_TAGGING) to inside
the critical section.  (Thought I'd do it now since I noticed it.)
----------------------------
revision 1.16
date: 2005/07/20 20:54:23;  author: dwarren;  state: Exp;  lines: +3 -3
Moved incrementing/decrementing of space count to inside critical region.
----------------------------
revision 1.15
date: 2005/07/03 22:27:44;  author: ruim;  state: Exp;  lines: +6 -1
fixed multi-threaded bug with dynamic memory allocation
----------------------------
revision 1.14
date: 2005/02/04 21:50:24;  author: dwarren;  state: Exp;  lines: +2 -2
Forgot to update this for minor changes in tag table type.
----------------------------
revision 1.13
date: 2005/02/04 20:02:15;  author: dwarren;  state: Exp;  lines: +1 -1
Some minor cleanup of general_tagging to improve typing slightly.
It does work with Harpreet's recent linux (but to configure with
general-tagging you have to change ALL the CPFLAGS in emuMakefile,
not just the first one !?%$!?!)
----------------------------
revision 1.12
date: 2005/02/04 16:56:13;  author: dwarren;  state: Exp;  lines: +31 -2
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.11
date: 2005/01/14 18:31:22;  author: ruim;  state: Exp;  lines: +5 -5
Integration of multithreaded system
----------------------------
revision 1.10
date: 2004/07/10 20:56:13;  author: dwarren;  state: Exp;  lines: +7 -4
Made tcpstack_realloc (expand cp and trail stack) aware of pre-image trailing.
----------------------------
revision 1.9
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +16 -16
branches:  1.9.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.8
date: 2002/05/22 15:41:14;  author: lfcastro;  state: Exp;  lines: +15 -26
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.7
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -9
* Removal of Chat engine
----------------------------
revision 1.6
date: 2000/10/04 01:46:34;  author: ejohnson;  state: Exp;  lines: +95 -65
branches:  1.6.2;  1.6.6;
Moved some of the DEBUG-mode stack-reallocation msgs out of the
overflow macros and into the XXstack_realloc() functions.  Now such
msgs will be issued whenever the stacks are modified, rather than just
when they overflow.
----------------------------
revision 1.5
date: 2000/05/29 04:23:36;  author: ejohnson;  state: Exp;  lines: +4 -4
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.4
date: 2000/05/20 06:56:03;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.3
date: 2000/01/07 08:51:40;  author: kifer;  state: Exp;  lines: +4 -4
branches:  1.3.2;
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.2
date: 1999/10/26 06:47:15;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:58:46;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.2.1
date: 2000/03/28 18:10:32;  author: lfcastro;  state: Exp;  lines: +5 -13
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.6.6.2
date: 2004/10/18 20:46:07;  author: ruim;  state: Exp;  lines: +19 -38
update for version 2.6.1
----------------------------
revision 1.6.6.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +5 -5
Sources from rfm repository
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +17 -5
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.9.2.1
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +19 -10
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.62.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.62.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.62.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/memory_xsb.h,v
Working file: memory_xsb.h
head: 1.53
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.44
	ROLLBACK: 1.39
	latest_plus_supp_branch: 1.39.0.2
	latest_plus_supp: 1.39
	Version_3dot2_plus_supp: 1.38.0.2
	release_2_6_plus_supp: 1.12.0.4
	Version_3dot2: 1.38
	dec07-perf-results: 1.37
	mt_thesis: 1.31
	release_3_0: 1.28
	release_2_7_0: 1.14
	multi-threaded-26-engine: 1.8.2.2
	pre-mt: 1.14
	multi-threaded-25-engine-done: 1.8.2.1
	multi-threaded-25-engine: 1.8.0.2
	release_2_6_1: 1.12
	release_2_6_final: 1.12
	release_2_6: 1.12.0.2
	last-merged-to-demand: 1.10
	demand_branch: 1.10.0.2
	before_removing_chat: 1.8
	release_2_5: 1.8
	pre-merge-slgwam-gc: 1.7
	multi-threaded-c-engine: 1.7.0.2
	release_2_4: 1.7
	release_2_3: 1.7
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.3
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 70;	selected revisions: 70
description:
----------------------------
revision 1.53
date: 2012/02/19 19:17:55;  author: tswift;  state: Exp;  lines: +2 -2

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.52
date: 2012/02/18 04:46:54;  author: kifer;  state: Exp;  lines: +5 -3
minated some compiler warnings
added DllExport to find_string, mem_alloc, mem_realloc.
----------------------------
revision 1.51
date: 2012/02/01 22:03:13;  author: dwarren;  state: Exp;  lines: +2 -2
Added cast to quiet 64-bit MSVC compiler
----------------------------
revision 1.50
date: 2012/01/25 22:14:08;  author: tswift;  state: Exp;  lines: +2 -2
Changed	some heap expansion thresholds to use OVERFLOW_MARGIN rather
than the hard-wired	    2000.  OVERFLOW_MARGIN is in fact a settable flag.

The idea is that by setting OVERFLOW_MARGIN a user may be able to
affect to some extent the amount of heap gc that occurs.  If after
heap gc	  there are still not OVERFLOW_MARGIN cells between the heap and
local stack, expansion will occur.  Thus by setting OVERFLOW_MARGIN
high, we'll expand more	    aggressively.

The fly	    in the ointment is dynamic code.  The test_heap	instruction
contains an argument representing an overflow margin at the entry to
clauses for a predicate.  For static code this is always 2000, but for
dynamic code it is function of the size of the clauses for a given
predicate.  I'd been hoping that OVERFLOW_MARGIN could replace the
test-heap argument, but it looks like it cant -- not without having a
separate test_help instruction for static and dynamic code.

So OVERFLOW_MARGIN will *sometimes* affect heap	      gc.
----------------------------
revision 1.49
date: 2011/12/24 21:09:11;  author: tswift;  state: Exp;  lines: +5 -27

Changes	for memory managemement

1) Now supporting max_memory flag for user-defined memory limits

2) Changed some	  memory errors so that rather than creating an
exception ball,	  a flag is set; the exception handler then checks
for the flag.  The reason for doing this is that allocating
memory to assert an exception ball can get us into trouble.
----------------------------
revision 1.48
date: 2011/05/20 22:00:29;  author: tswift;  state: Exp;  lines: +3 -3

More changes for 32/64 bits.
----------------------------
revision 1.47
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +2 -2

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.46
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +17 -17
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.45
date: 2010/10/20 19:27:11;  author: tswift;  state: Exp;  lines: +4 -1

Added some invariant checks (not invoked unless DEBUG_VM is turned on).
----------------------------
revision 1.44
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.43
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.42
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.41
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.40
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.39
date: 2009/05/01 12:54:38;  author: tswift;  state: Exp;  lines: +3 -2
branches:  1.39.2;


Added flag heap_margin will allows users to set	the heap gc /
overflow margin.  In those cases where XSB's memory management is
somehow not working properly, the flag gives users a possible
work-around until we fix whatever the problem is.  In many cases,
this work-arond may be easier to use than setting -m to	   some
large number.
----------------------------
revision 1.38
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +2 -1
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.37
date: 2007/11/18 18:53:00;  author: evansbj;  state: Exp;  lines: +3 -3
Typos in the definition of IsInTrail and IsInCPS ???
----------------------------
revision 1.36
date: 2007/09/26 20:15:22;  author: dwarren;  state: Exp;  lines: +5 -4
This update modifies the trymeorelse instruction (which implements
disjunctions, including if-then-else) to include a check for pending
attv interrupts, and handling them if there are any.  The problem is
that to handle interrupts, the environment must be known and there
must be a "call"-like instruction that allows called routines to find
the size of the parents AR.  This is done here by having the
trymeorelse instruction (when there is a pending interrupt) create
an environment and then branch to a 2-instruction sequence of
check_interrupt,restore_dealloc_proceed.  This last instruction is
new, and it restores registers (if nec, but here it's not since no
registers are active at a trymeorelse), pops the environment and
returns to the original caller, which in this case causes the trymeorelse
instruction to be executed again.
----------------------------
revision 1.35
date: 2007/07/12 14:38:02;  author: dwarren;  state: Exp;  lines: +7 -13
Added heap overflow tests for copying terms out of tries from leaf to root.
This is done when returning answers from non-completed tables or when calling
interned with the leaf address bound.
----------------------------
revision 1.34
date: 2007/05/10 16:29:09;  author: tswift;  state: Exp;  lines: +1 -70

Minor changes:

tc_insts -- added some reserve code for testing, and some minor optimization of trie code
emuloop.c -- added a comment (from an email of David)
memory_xsb.h -- took out an old ifdef that confused me one too many times.
----------------------------
revision 1.33
date: 2007/01/25 20:33:55;  author: tswift;  state: Exp;  lines: +5 -1


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.32
date: 2007/01/13 23:10:36;  author: tswift;  state: Exp;  lines: +2 -1
Put statistics about memory use in statistics(mutex) -- this should help in
tracking down when we're using too many  mallocs and frees which hurts scalability of the MT engine.  Right now they're only compiled in for NON-OPT-COMPILE.
----------------------------
revision 1.31
date: 2006/10/18 20:42:26;  author: dwarren;  state: Exp;  lines: +2 -1
Updates to the ODBC interface:
1) fixed a global variable that would break MT
2) changed to use mem_alloc and new ODBC_SPACE tag to show memory
	usage in statistics.
----------------------------
revision 1.30
date: 2006/10/06 20:04:28;  author: dwarren;  state: Exp;  lines: +2 -1
Updated memory management in hashtable (which manages hashing for incremental
table maintenance.)  It now uses XSB mem_alloc and friends, and there is a new
space type of INCR_TABLE_SPACE.  It is included in SLG Table space in statistics
and is also broken out (if nonzero).
And doing that showed a huge amount of unused space due to many large hashtables
when there's only one edge.  So I changed the minimum size of initial hashtables
(they are automatically expanded if necessary.)  [It reduced incr space usage in
my DSS example from about 340M to 8M... much!! better.]
----------------------------
revision 1.29
date: 2006/09/01 13:08:50;  author: dwarren;  state: Exp;  lines: +3 -3
Added maximum size of top environment in local-stack overflow test.  It was added in the
gc routines to fix a bug a month or so ago, but I forgot to add it here.
----------------------------
revision 1.28
date: 2006/01/27 20:29:47;  author: tswift;  state: Exp;  lines: +2 -2

Some changes I recently made broke batched evaluation.  I backed out these changes to fix the batched test suite again.
----------------------------
revision 1.27
date: 2005/12/31 23:16:03;  author: tswift;  state: Exp;  lines: +3 -1

Fixed problems with throwing memory errors from mem_xxxoc(), at
least in sequential engine.  When memory cannot be malloced, a
resource error is thrown.  Since throwing errors mallocs memory
in itself, mem_xxxocs used by a throw are changed into
mem_xxxoc_nochecks and an xsb_exit is called if these functions
return NULL pointers.  Care is taken so that when a resource
error is thrown, space for its PSCs has been pre-allocated, and
varstrings are used for the actual message strings (varstring
exits too, if there is not enough memory).

In MT engine, a memory error just exits -- this is because I need
a CTXT to throw an error.  Right now, I'm not sure whether its a
good idea or not to put CTXTs into mem_xxxoc or not.

Not that some of the biggest memory allocations, such as tcp
stack, local-heap stack use straight reallocs and use their own
error handling.

In general, we should be handling most memory errors in a
reasonable, or at least consistent, manner.
----------------------------
revision 1.26
date: 2005/11/20 21:23:29;  author: dwarren;  state: Exp;  lines: +21 -19
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.25
date: 2005/11/17 18:22:41;  author: tswift;  state: Exp;  lines: +3 -2

Removed resume_compl_susp_inst2 -- unneeded, and a remnant of old single-stack scheduling (!)
----------------------------
revision 1.24
date: 2005/11/16 22:34:54;  author: dwarren;  state: Exp;  lines: +4 -3
Minor memory management cleanup, to reduce initial space usage.
----------------------------
revision 1.23
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +26 -6
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.22
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +2 -2


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.21
date: 2005/11/13 21:38:37;  author: dwarren;  state: Exp;  lines: +4 -4
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.20
date: 2005/11/12 15:48:50;  author: dwarren;  state: Exp;  lines: +3 -1
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.19
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +6 -1


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.18
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +7 -7
made private flags array for sequential engine
----------------------------
revision 1.17
date: 2005/07/15 15:02:33;  author: dwarren;  state: Exp;  lines: +3 -3
Made assert thread-safe (I hope.)  Problem was asserta, and I added
mutex_lock in jumptbreg when just entering asserted code, and I release
it after the code for the first clause to be executed is found and about
to be entered.  It introduces new instructions: dyntrymeelse, dynnoop, and
dynfail to release the lock.
assertz was made safe (I hope) without locks, by adding the new clause at the
end and then as the last thing, changing the opcode of the old-last clause
from dyntrust to retry.  Since dyntrust doesn't look at any argument, this
should work.
----------------------------
revision 1.16
date: 2005/02/04 16:56:13;  author: dwarren;  state: Exp;  lines: +2 -2
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.15
date: 2005/01/14 18:31:22;  author: ruim;  state: Exp;  lines: +26 -15
Integration of multithreaded system
----------------------------
revision 1.14
date: 2004/11/24 22:35:04;  author: dwarren;  state: Exp;  lines: +3 -4
Modified check_glstack_overflow to call gc_heap to try to get the necessary
space to see if it can avoid expanding the stack.  Only expand stack if GC
doesn't get enough space.  This required changes in calls to check_glstack_overflow
since it would accept MAX_ARITY to "over-save" the registers.  But GC requires
the exact number.  I think I got them correctly, except for one in calld, which I
deleted.  I don't know why calld needs to check overflow since the check_heap
in clauses should be enough....
----------------------------
revision 1.13
date: 2004/09/29 21:41:55;  author: dwarren;  state: Exp;  lines: +3 -2
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.12
date: 2002/11/04 18:09:03;  author: dwarren;  state: Exp;  lines: +13 -23
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.11
date: 2002/10/28 15:29:48;  author: lfcastro;  state: Exp;  lines: +2 -3
* Remove 'reset' instruction
----------------------------
revision 1.10
date: 2002/05/22 15:41:14;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.10.2;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.9
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -9
* Removal of Chat engine
----------------------------
revision 1.8
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +4 -2
branches:  1.8.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.7
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +5 -3
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.6
date: 2000/10/04 01:46:35;  author: ejohnson;  state: Exp;  lines: +6 -30
branches:  1.6.2;
Moved some of the DEBUG-mode stack-reallocation msgs out of the
overflow macros and into the XXstack_realloc() functions.  Now such
msgs will be issued whenever the stacks are modified, rather than just
when they overflow.
----------------------------
revision 1.5
date: 2000/06/25 16:59:15;  author: ejohnson;  state: Exp;  lines: +115 -113
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.4
date: 2000/06/22 01:27:51;  author: lfcastro;  state: Exp;  lines: +7 -7
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.3
date: 2000/02/15 07:45:08;  author: bartkul;  state: Exp;  lines: +7 -7
branches:  1.3.2;
in testsuite.sh supertest.sh gctest.sh

changed testsuite.sh    into    ./testsuite.sh
        makexsb         into    ./makexsb
        configure       into    ./configure

in prolog_tests/c_calls_xsb_make.P

changed c_calls_xsb.exe into    ./c_calls_xsb.exe


in the c and h files: given check_glstack_overflow an extra argument

standard.O ... I have no idea
----------------------------
revision 1.2
date: 1999/12/22 18:07:01;  author: warren;  state: Exp;  lines: +2 -2
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.1
date: 1999/10/25 05:58:47;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.2.2
date: 2000/04/19 18:27:38;  author: lfcastro;  state: Exp;  lines: +1 -10
- still some cleanup
----------------------------
revision 1.3.2.1
date: 2000/03/28 18:10:32;  author: lfcastro;  state: Exp;  lines: +2 -3
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.6.2.3
date: 2001/01/06 18:43:05;  author: ruim;  state: Exp;  lines: +4 -1
Initialization data made static and other small changes
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +6 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.8.2.2
date: 2004/10/18 20:46:07;  author: ruim;  state: Exp;  lines: +14 -32
update for version 2.6.1
----------------------------
revision 1.8.2.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +28 -18
Sources from rfm repository
----------------------------
revision 1.10.2.7
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +7 -1
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.10.2.6
date: 2003/04/17 17:11:43;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.10.2.5
date: 2003/02/11 18:36:17;  author: lfcastro;  state: Exp;  lines: +12 -22
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.10.2.4
date: 2002/10/28 16:49:31;  author: lfcastro;  state: Exp;  lines: +1 -2
* Merge with HEAD
----------------------------
revision 1.10.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +3 -1
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.10.2.2
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +2 -4
* update to HEAD
----------------------------
revision 1.10.2.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +4 -2
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.39.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.39.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.39.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/msyscall.h,v
Working file: msyscall.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1999/10/25 05:58:48;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/odbc_def_xsb.h,v
Working file: odbc_def_xsb.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.2
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.1.0.2
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.6
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/01/30 20:24:32;  author: evansbj;  state: Exp;  lines: +1 -1
branches:  1.2.2;
Replaced Cursor with the more specific ODBC_Cursor it was causing some conflicts with other libraries out in the wild.
----------------------------
revision 1.1
date: 2005/07/26 22:46:23;  author: crojo;  state: Exp;

Fixed the ODBC interface in the multithreaded configuration.
----------------------------
revision 1.2.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.2.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/odbc_string.h,v
Working file: odbc_string.h
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.5
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.14
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.12
	release_2_6_plus_supp: 1.1.0.10
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.8
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.6
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.4
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
	release_2_4: 1.1
	release_2_3: 1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.5
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 2001/01/30 21:08:37;  author: dwarren;  state: Exp;
branches:  1.1.14;
Fixing problems with ODBC for cygwin
----------------------------
revision 1.1.14.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.14.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1.14.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/odbc_xsb.c,v
Working file: odbc_xsb.c
head: 1.79
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.76
	ROLLBACK: 1.71
	latest_plus_supp_branch: 1.71.0.2
	latest_plus_supp: 1.71
	Version_3dot2_plus_supp: 1.70.0.2
	release_2_6_plus_supp: 1.29.0.4
	Version_3dot2: 1.70
	dec07-perf-results: 1.67
	mt_thesis: 1.64
	release_3_0: 1.60
	release_2_7_0: 1.38
	multi-threaded-26-engine: 1.22.4.2
	pre-mt: 1.38
	multi-threaded-25-engine-done: 1.22.4.1
	multi-threaded-25-engine: 1.22.0.4
	release_2_6_1: 1.29
	release_2_6_final: 1.29
	release_2_6: 1.29.0.2
	last-merged-to-demand: 1.22
	demand_branch: 1.22.0.2
	before_removing_chat: 1.22
	release_2_5: 1.22
	pre-merge-slgwam-gc: 1.21
	multi-threaded-c-engine: 1.21.0.2
	release_2_4: 1.19
	release_2_3: 1.17
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.6
	release-2-2: 1.5
	chat-and-local: 1.5.0.2
	xsb-pre-cleanup: 1.5
	release-2-1: 1.2
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 87;	selected revisions: 87
description:
----------------------------
revision 1.79
date: 2011/07/26 17:27:49;  author: dwarren;  state: Exp;  lines: +27 -23
Fixed bug in ODBC interface that showed up under 64-bit port.  SQLTYPES were
not used consistently in malloc and free.
Minor change to tokenizer to be more Prolog standardish. (Mostly unused
string escapes.)
----------------------------
revision 1.78
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +3 -3
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.77
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +39 -38
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.76
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.75
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.74
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.73
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.72
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.71
date: 2010/01/30 20:24:32;  author: evansbj;  state: Exp;  lines: +38 -38
branches:  1.71.2;
Replaced Cursor with the more specific ODBC_Cursor it was causing some conflicts with other libraries out in the wild.
----------------------------
revision 1.70
date: 2008/09/04 14:07:13;  author: dwarren;  state: Exp;  lines: +2 -2
Change declaration from char to byte, so that "ascii" characters greater than
127 are positive integers, not negative in the codes list generated.
----------------------------
revision 1.69
date: 2008/04/06 23:04:23;  author: tswift;  state: Exp;  lines: +5 -5
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.68
date: 2007/12/11 06:57:16;  author: crued;  state: Exp;  lines: +2 -1
Needed to compile on cygwin/gcc version 3.4.4 with --disable-no-cygwin --with-odbc
----------------------------
revision 1.67
date: 2007/10/01 17:01:00;  author: dwarren;  state: Exp;  lines: +6 -4
getcolumns wasn't handling a single . modifier to a table name. (0 or 2
were ok, but 1 didn't result in the right argument shuffling.)
----------------------------
revision 1.66
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +3 -3
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.65
date: 2007/04/20 14:40:54;  author: tswift;  state: Exp;  lines: +2 -2

Made changes to several occurrences of ctop_string to avoid interning the string twice.  I only took the obvious cases, but there were several af them.  Probably at some point we should take a closer look at a few of them to make sure we aren't interning things unnecessarily, but this depends on understanding the actual uses in detail.
----------------------------
revision 1.64
date: 2006/11/09 21:51:21;  author: dwarren;  state: Exp;  lines: +8 -8
Made recent fix for floats slightly cleaner.  (And for long ints as well.)
----------------------------
revision 1.63
date: 2006/11/09 21:22:20;  author: dwarren;  state: Exp;  lines: +13 -1
Fixed a bug we introduced in findall and/or the odbc interface.
Problem was when we changed to boxed floats, updates to these files
weren't consistent, so size was computed incorrectly and resulted heap
in overflow.
----------------------------
revision 1.62
date: 2006/10/18 20:42:26;  author: dwarren;  state: Exp;  lines: +72 -55
Updates to the ODBC interface:
1) fixed a global variable that would break MT
2) changed to use mem_alloc and new ODBC_SPACE tag to show memory
	usage in statistics.
----------------------------
revision 1.61
date: 2006/10/16 21:44:45;  author: dwarren;  state: Exp;  lines: +160 -84
Updated odbc error handling so it always returns an error ball that can
be thrown (and caught.)  Makes error handling in odbc more consistent and uniform.
----------------------------
revision 1.60
date: 2006/06/08 14:27:42;  author: evansbj;  state: Exp;  lines: +2 -12
Sorry the previous changes shouldn't have gotten out into the wild.
----------------------------
revision 1.59
date: 2006/06/07 16:57:38;  author: evansbj;  state: Exp;  lines: +12 -2
Fix for every X cycle support
----------------------------
revision 1.58
date: 2006/02/16 18:30:13;  author: dwarren;  state: Exp;  lines: +0 -1
Remove old debugging message.
----------------------------
revision 1.57
date: 2006/02/09 19:29:23;  author: dwarren;  state: Exp;  lines: +19 -6
Again work on string lengths.  The new string length handling broke
the Access ODBC driver.  It just seems not to handle the explicit string
length API.  Since we need the Access ODBC interface to work, I added
a field to the cursor to hold a "driver_code".  It is set when the cursor
is opened, using SQLGetInfo, and converting the name to a number.  Then
how strings are passed to Bind is dependent on the driver_code.
Ugly, but we need this driver to work and I can't see any other way to do
it.  If there is someone who knows more about strings and Mac and SQL Server
and MS Access and MySQL ODBC drivers and can get one interface that works
for all, I'd be very happy to remove this ugly conditioning.
----------------------------
revision 1.56
date: 2006/01/18 19:31:07;  author: dwarren;  state: Exp;  lines: +13 -22
Took out conditional DARWIN length computation, from Barry.
Redid length array to make it consistent with other Bind arrays that are used.
(Seems cleaner.)
----------------------------
revision 1.55
date: 2006/01/17 22:51:12;  author: dwarren;  state: Exp;  lines: +15 -8
When passing lengths of bind values, we pass the address, and that seems
to have to be stable till the call to execute the query.  So I made an
array of lengths so each bind variable will have a place for its length.
----------------------------
revision 1.54
date: 2006/01/17 21:23:50;  author: dwarren;  state: Exp;  lines: +1682 -1674
Terry added length for bind strings as length+1.  This breaks our SQLServer driver,
which wants the actual length.
I conditioned the +1 for DARWIN, and for others set it to the actual length.
Terry and/or Barry should check that this works for them.
----------------------------
revision 1.53
date: 2005/12/17 20:33:18;  author: dwarren;  state: Exp;  lines: +2 -2
Commented out a declaration of a variable my compiler noted as unused.
Just being anal....
----------------------------
revision 1.52
date: 2005/12/17 18:37:46;  author: tswift;  state: Exp;  lines: +51 -54

Committing changes make by Barry Evans to fix string lengths that are sent to SQLBindParameter.  It also ups the number of cursors.
----------------------------
revision 1.51
date: 2005/11/08 02:13:15;  author: tswift;  state: Exp;  lines: +1677 -1677

Checking in changes by Barry Evans:

Added lengths to SQLBindParameter for SQL_NTS values. This is necessary
for some ODBC interfaces like freeTDS to MS SQL server ...
----------------------------
revision 1.50
date: 2005/07/26 22:46:23;  author: crojo;  state: Exp;  lines: +46 -31

Fixed the ODBC interface in the multithreaded configuration.
----------------------------
revision 1.49
date: 2005/07/07 18:59:43;  author: dwarren;  state: Exp;  lines: +7 -11
Made write_canonical thread-safe
----------------------------
revision 1.48
date: 2005/07/07 16:55:52;  author: dwarren;  state: Exp;  lines: +4 -7
Fixed fmt_read/write for multithreading.  Minor change to write_canonical (still NOT
thread-safe).
Added several (extensible) string buffers to context, since many builtins use
global string buffers.  Idea is to change those places to use these buffers.
They are implemented as varstring's.
----------------------------
revision 1.47
date: 2005/06/28 15:46:57;  author: vidrevich;  state: Exp;  lines: +4 -4
added CTXT for calls that were missing it, so that the files compile with multi-threaded engine
----------------------------
revision 1.46
date: 2005/06/06 16:04:22;  author: dwarren;  state: Exp;  lines: +7 -4
When asking for string (codes) to be returned, return string(null(_)) if value
to be returned is null in DB.
----------------------------
revision 1.45
date: 2005/03/05 07:50:50;  author: kifer;  state: Exp;  lines: +2 -2
fixed the definition of write_canonical_term
Tatyana's earlier change was wrong.
----------------------------
revision 1.44
date: 2005/03/04 15:11:17;  author: vidrevich;  state: Exp;  lines: +2 -2
changed declaration of write_canonical_term() to correspond to the recently changed definition in io_builtins_xsb.c. Otherwise the file was not compiling in Windows.
----------------------------
revision 1.43
date: 2005/02/14 19:32:05;  author: harpreet_singh;  state: Exp;  lines: +26 -15
added ifdefs to add support for iodbc
----------------------------
revision 1.42
date: 2005/02/11 01:54:27;  author: vidrevich;  state: Exp;  lines: +125 -123
put thread context macro in for multi-threaded versions
----------------------------
revision 1.41
date: 2005/01/17 20:39:22;  author: dwarren;  state: Exp;  lines: +56 -3
Add transaction-commit call to try to better clean up before closing.  (Doesn't
seem to solve my problem with Access.)
Added new ODBCRowCount() function to return the row-count so ODBC user
can get access to number of rows affected in a UPDATE, DELETE, of INSERT
sql call.
----------------------------
revision 1.40
date: 2005/01/14 18:31:22;  author: ruim;  state: Exp;  lines: +2 -6
Integration of multithreaded system
----------------------------
revision 1.39
date: 2005/01/03 22:34:32;  author: dwarren;  state: Exp;  lines: +7 -3
Enlarge MAXVARSTRLEN to allow bigger Prolog terms to be saved, and
also print warning message if this seems to cause truncation.
----------------------------
revision 1.38
date: 2004/08/04 13:24:15;  author: dwarren;  state: Exp;  lines: +4 -4
Fixed to use right defined constant (instead of wrong one with the
same definition?!)  Also took an assignment out of an if-condition to
ease (my) understanding.
----------------------------
revision 1.37
date: 2004/07/21 17:05:10;  author: dwarren;  state: Exp;  lines: +2 -8
Fixed bug in disconnect: arose when odbc_close-ing in situation when
2 connections are open.  The interface had been keeping a flag serverConnected
to try to do better error detection, but this wasn't updated when multiple
connections were added.  Solution was to delete the flag and leave it to
the ODBC routines to give error messages when trying to access a disconnected
connection.
----------------------------
revision 1.36
date: 2004/07/16 14:47:56;  author: dwarren;  state: Exp;  lines: +18 -18
Changed a bunch of xsb_exits to xsb_aborts to be slightly more polite.
----------------------------
revision 1.35
date: 2004/06/13 14:49:37;  author: dwarren;  state: Exp;  lines: +10 -12
Minor cleanup of changes to handle Null values better.
----------------------------
revision 1.34
date: 2004/06/12 22:31:44;  author: dwarren;  state: Exp;  lines: +53 -17
Handle null values, representing them as 'NULL'(_) in Prolog.
----------------------------
revision 1.33
date: 2004/02/06 15:15:55;  author: dwarren;  state: Exp;  lines: +46 -10
Support string(X) terms in BindList and ResultList of odbc_sql to allow
writing and reading of Prolog code-lists to and from database CHAR (and BYTE)
fields.
----------------------------
revision 1.32
date: 2004/02/05 22:17:34;  author: dwarren;  state: Exp;  lines: +50 -13
Add option in retrieving a character field to get it back as a code-list
to allow user to avoid filling the atom-table with atoms.
----------------------------
revision 1.31
date: 2004/01/27 15:23:24;  author: harpreet_singh;  state: Exp;  lines: +324 -61
Added ODBCGetInfo to retrieve meta data information about the connection.
----------------------------
revision 1.30
date: 2003/09/18 18:43:52;  author: dwarren;  state: Exp;  lines: +3 -10
Extended read_canonical to read ',' as an infix operator (in most cases).
So it reads terms of the form: (a,b,c), and prolog does.  It also
reads terms of the form (a) as a, ignoring the superfluous parentheses.
Notice that it does NOT read a term like:
a,b,c.
without the parens.
Also I fixed a bug (which I introduced when allowing read_canonical_term
to be called from odbc routines) in handling stack expansion to support
reading very large terms.
----------------------------
revision 1.29
date: 2003/04/16 14:11:31;  author: lfcastro;  state: Exp;  lines: +7 -7
* Fix buglet in odbc_data_sources
----------------------------
revision 1.28
date: 2003/04/02 18:35:17;  author: lfcastro;  state: Exp;  lines: +85 -9
* New ODBC predicate: odbc_data_sources(DSN,Description) returns all
  data sources, one at a time.
----------------------------
revision 1.27
date: 2003/03/26 18:36:45;  author: lfcastro;  state: Exp;  lines: +32 -1
* Fixes to use the ODBC interface on Linux + MySQL
  - Add support for BLOBs, to overcome limitation in size of strings
  - Document MyODBC quirks in the manual
  - Use gcc to create libxsb.so when possible (via ./makexsb
  dynmodule)
----------------------------
revision 1.26
date: 2003/03/24 20:23:01;  author: lfcastro;  state: Exp;  lines: +15 -6
* Use SQLFreeStmt(handle,SQL_CLOSE) instead of SQLCancel(handle)
  before reusing a cursor; the former works also with MySQL.
----------------------------
revision 1.25
date: 2003/03/20 21:29:32;  author: lfcastro;  state: Exp;  lines: +10 -3
* Bugfix: ODBC cursors used in SQLTables should not be reused.
----------------------------
revision 1.24
date: 2003/02/27 20:36:51;  author: dwarren;  state: Exp;  lines: +28 -4
Mods to allow odbc interface to use the write_canonical c-code, for
reading and writing prolog terms from/into character fields.
----------------------------
revision 1.23
date: 2003/01/28 22:57:05;  author: dwarren;  state: Exp;  lines: +18 -1
Move write_canonical (and write_canonical_lettervars) to C.  Not for speed
but so that they can be accessed from C, and used in the ODBC interface to
write terms canonically to character fields.
----------------------------
revision 1.22
date: 2002/01/23 17:08:09;  author: dwarren;  state: Exp;  lines: +3 -3
branches:  1.22.2;  1.22.4;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.21
date: 2001/08/30 11:59:53;  author: dwarren;  state: Exp;  lines: +8 -6
Tanya's changes to make ODBC work under linux.
----------------------------
revision 1.20
date: 2001/08/08 15:05:32;  author: dwarren;  state: Exp;  lines: +36 -21
Added new calls for opening a database, giving the entire connection
string, so as not to have to depend on the ODBC registry.
----------------------------
revision 1.19
date: 2001/05/17 00:44:31;  author: kifer;  state: Exp;  lines: +3 -3
remove some odbc misconfiguration
----------------------------
revision 1.18
date: 2001/04/03 19:41:53;  author: dwarren;  state: Exp;  lines: +1 -2
Delete unnecessary include file.
----------------------------
revision 1.17
date: 2001/02/05 23:02:47;  author: dwarren;  state: Exp;  lines: +55 -16
Tanya: maxcursors applies to each connection, not to total as previously.
----------------------------
revision 1.16
date: 2001/02/05 14:18:49;  author: dwarren;  state: Exp;  lines: +24 -21
Fix bug with HDBC handles for multiple connections.
Brittle fix: need to keep numcursors separately for each connection.
----------------------------
revision 1.15
date: 2001/01/30 21:02:47;  author: dwarren;  state: Exp;  lines: +4 -4
Fixing problem added with ODBC compilation under cygwin
----------------------------
revision 1.14
date: 2001/01/29 22:59:31;  author: dwarren;  state: Exp;  lines: +310 -302
Updates to allow ODBC interface to be compiled under cygwin on Windows.
----------------------------
revision 1.13
date: 2001/01/29 14:37:17;  author: dwarren;  state: Exp;  lines: +9 -2
fixed a syntax bug in odbc_call.P (sorry!), and added simple error test to odbc_xsb.c
----------------------------
revision 1.12
date: 2001/01/08 18:05:01;  author: dwarren;  state: Exp;  lines: +272 -177
Many updates to ODBC interface.  Made it a module.  Can now connect to multiple ODBC sources. And much more.
----------------------------
revision 1.11
date: 2001/01/03 20:40:23;  author: dwarren;  state: Exp;  lines: +529 -524
Update of XSB-ODBC Interface:
	Simplified basic ODBC_SQL call to take bindlist, sql query, and return result set.
	Simplified bind variable passing to ODBC (more done in XSB)
	Eliminated special handling of negative cursor numbers and first stmt numbers
		by adding special calls for those special cases.
	Changed cursor handling from a fixed array to an extensible list.
	Modified bindlist handling in C to pass pointer to strings, without making a copy.
	Move unification of returned strings to C side, to avoid internning atoms unnecessarily.
	Changed the way types are supported (minor)
----------------------------
revision 1.10
date: 2000/12/19 22:44:02;  author: dwarren;  state: Exp;  lines: +13 -4
Allow qualified table names (requires 3 parts, separated by periods (.))
----------------------------
revision 1.9
date: 2000/12/08 21:31:05;  author: dwarren;  state: Exp;  lines: +15 -6
Release cursor after an SQL statement that has no result set.
----------------------------
revision 1.8
date: 2000/11/22 15:25:49;  author: dwarren;  state: Exp;  lines: +18 -13
Added ptoc_longstring which is like ptoc_string, except that it
accepts a complex structure from Prolog and turns it into a C string.
It accepts lists, regular and ,-separated, containing atoms or small
integers, and constructs a string by concatenating the atoms or chars.
Small ints represent their ascii codes.  It is recursive.  This makes
it easier to send a long string across the C interface, without having
to construct a new atom for it.
----------------------------
revision 1.7
date: 2000/11/13 21:40:59;  author: dwarren;  state: Exp;  lines: +10 -5
Added ``pseudo'' types so that MS SQL Server works.  (Where do they get those wierd types?)
----------------------------
revision 1.6
date: 2000/05/20 06:56:04;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.6.2;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.5
date: 2000/01/07 08:51:41;  author: kifer;  state: Exp;  lines: +2 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.4
date: 1999/12/30 06:21:13;  author: cbaoqiu;  state: Exp;  lines: +65 -25
Got rid of assert()'s, which are ignored when the system is built for
release version in MS VC++.
----------------------------
revision 1.3
date: 1999/12/22 18:07:02;  author: warren;  state: Exp;  lines: +10 -8
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.2
date: 1999/11/16 19:05:58;  author: kifer;  state: Exp;  lines: +8 -1
Revamped sockets interface.
----------------------------
revision 1.1
date: 1999/10/25 05:58:49;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.22.4.2
date: 2004/10/18 20:46:07;  author: ruim;  state: Exp;  lines: +170 -6
update for version 2.6.1
----------------------------
revision 1.22.4.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.22.2.1
date: 2003/04/17 17:11:42;  author: lfcastro;  state: Exp;  lines: +170 -6
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.71.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.71.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.71.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/odbc_xsb.h,v
Working file: odbc_xsb.h
head: 1.13
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.13
	ROLLBACK: 1.8
	latest_plus_supp_branch: 1.8.0.4
	latest_plus_supp: 1.8
	Version_3dot2_plus_supp: 1.8.0.2
	release_2_6_plus_supp: 1.4.0.4
	Version_3dot2: 1.8
	dec07-perf-results: 1.8
	mt_thesis: 1.8
	release_3_0: 1.8
	release_2_7_0: 1.5
	multi-threaded-26-engine: 1.3.6.2
	pre-mt: 1.5
	multi-threaded-25-engine-done: 1.3.6.1
	multi-threaded-25-engine: 1.3.0.6
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.2
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.4
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.2
	release_2_4: 1.3
	release_2_3: 1.3
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 21;	selected revisions: 21
description:
----------------------------
revision 1.13
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.12
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.11
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2005/07/26 22:46:24;  author: crojo;  state: Exp;  lines: +10 -21
branches:  1.8.4;

Fixed the ODBC interface in the multithreaded configuration.
----------------------------
revision 1.7
date: 2005/02/11 01:54:27;  author: vidrevich;  state: Exp;  lines: +19 -19
put thread context macro in for multi-threaded versions
----------------------------
revision 1.6
date: 2005/01/17 20:39:24;  author: dwarren;  state: Exp;  lines: +4 -2
Add transaction-commit call to try to better clean up before closing.  (Doesn't
seem to solve my problem with Access.)
Added new ODBCRowCount() function to return the row-count so ODBC user
can get access to number of rows affected in a UPDATE, DELETE, of INSERT
sql call.
----------------------------
revision 1.5
date: 2004/01/27 15:23:24;  author: harpreet_singh;  state: Exp;  lines: +8 -6
Added ODBCGetInfo to retrieve meta data information about the connection.
----------------------------
revision 1.4
date: 2003/04/02 18:35:17;  author: lfcastro;  state: Exp;  lines: +3 -1
* New ODBC predicate: odbc_data_sources(DSN,Description) returns all
  data sources, one at a time.
----------------------------
revision 1.3
date: 2001/01/08 18:05:01;  author: dwarren;  state: Exp;  lines: +7 -3
branches:  1.3.4;  1.3.6;
Many updates to ODBC interface.  Made it a module.  Can now connect to multiple ODBC sources. And much more.
----------------------------
revision 1.2
date: 2001/01/03 20:40:23;  author: dwarren;  state: Exp;  lines: +16 -7
Update of XSB-ODBC Interface:
	Simplified basic ODBC_SQL call to take bindlist, sql query, and return result set.
	Simplified bind variable passing to ODBC (more done in XSB)
	Eliminated special handling of negative cursor numbers and first stmt numbers
		by adding special calls for those special cases.
	Changed cursor handling from a fixed array to an extensible list.
	Modified bindlist handling in C to pass pointer to strings, without making a copy.
	Move unification of returned strings to C side, to avoid internning atoms unnecessarily.
	Changed the way types are supported (minor)
----------------------------
revision 1.1
date: 1999/10/25 05:58:50;  author: kifer;  state: Exp;
branches:  1.1.4;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.6.2
date: 2004/10/18 20:46:07;  author: ruim;  state: Exp;  lines: +3 -1
update for version 2.6.1
----------------------------
revision 1.3.6.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.3.4.1
date: 2003/04/17 17:11:41;  author: lfcastro;  state: Exp;  lines: +3 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.8.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.8.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/odbc_xsb_i.h,v
Working file: odbc_xsb_i.h
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.13
	ROLLBACK: 1.8
	latest_plus_supp_branch: 1.8.0.4
	latest_plus_supp: 1.8
	Version_3dot2_plus_supp: 1.8.0.2
	release_2_6_plus_supp: 1.4.0.4
	Version_3dot2: 1.8
	dec07-perf-results: 1.8
	mt_thesis: 1.8
	release_3_0: 1.8
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.3.6.2
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.3.6.1
	multi-threaded-25-engine: 1.3.0.6
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.2
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.4
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.2
	release_2_4: 1.3
	release_2_3: 1.3
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 22;	selected revisions: 22
description:
----------------------------
revision 1.14
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.13
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.12
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.11
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2005/06/28 15:46:58;  author: vidrevich;  state: Exp;  lines: +21 -21
branches:  1.8.4;
added CTXT for calls that were missing it, so that the files compile with multi-threaded engine
----------------------------
revision 1.7
date: 2005/01/17 20:39:24;  author: dwarren;  state: Exp;  lines: +4 -1
Add transaction-commit call to try to better clean up before closing.  (Doesn't
seem to solve my problem with Access.)
Added new ODBCRowCount() function to return the row-count so ODBC user
can get access to number of rows affected in a UPDATE, DELETE, of INSERT
sql call.
----------------------------
revision 1.6
date: 2004/12/20 19:26:15;  author: dwarren;  state: Exp;  lines: +2 -2
hanged several int's to Integer's for safety.  There is more interest in
the 64-bit port, so I'd like to find the current bugs in it.  This might
be a start.
----------------------------
revision 1.5
date: 2004/01/27 15:23:24;  author: harpreet_singh;  state: Exp;  lines: +19 -16
Added ODBCGetInfo to retrieve meta data information about the connection.
----------------------------
revision 1.4
date: 2003/04/02 18:35:16;  author: lfcastro;  state: Exp;  lines: +4 -1
* New ODBC predicate: odbc_data_sources(DSN,Description) returns all
  data sources, one at a time.
----------------------------
revision 1.3
date: 2001/01/08 18:05:01;  author: dwarren;  state: Exp;  lines: +9 -3
branches:  1.3.4;  1.3.6;
Many updates to ODBC interface.  Made it a module.  Can now connect to multiple ODBC sources. And much more.
----------------------------
revision 1.2
date: 2001/01/03 20:40:23;  author: dwarren;  state: Exp;  lines: +51 -34
Update of XSB-ODBC Interface:
	Simplified basic ODBC_SQL call to take bindlist, sql query, and return result set.
	Simplified bind variable passing to ODBC (more done in XSB)
	Eliminated special handling of negative cursor numbers and first stmt numbers
		by adding special calls for those special cases.
	Changed cursor handling from a fixed array to an extensible list.
	Modified bindlist handling in C to pass pointer to strings, without making a copy.
	Move unification of returned strings to C side, to avoid internning atoms unnecessarily.
	Changed the way types are supported (minor)
----------------------------
revision 1.1
date: 1999/10/25 05:58:51;  author: kifer;  state: Exp;
branches:  1.1.4;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.6.2
date: 2004/10/18 20:46:07;  author: ruim;  state: Exp;  lines: +4 -1
update for version 2.6.1
----------------------------
revision 1.3.6.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.3.4.1
date: 2003/04/17 17:11:41;  author: lfcastro;  state: Exp;  lines: +4 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.8.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.8.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/oracle.h,v
Working file: oracle.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1999/10/25 05:58:52;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:18;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/oracle.i,v
Working file: oracle.i
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.3
date: 1999/10/25 05:58:53;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/04/22 06:49:17;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1998/11/05 16:55:19;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:19;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/oracle_xsb.h,v
Working file: oracle_xsb.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.12.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.12.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2005/01/14 18:31:24;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.2.4;
Integration of multithreaded system
----------------------------
revision 1.1
date: 1999/10/25 05:58:54;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.12;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.12.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/oracle_xsb_i.h,v
Working file: oracle_xsb_i.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.12.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.12.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2005/01/14 18:31:25;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.2.4;
Integration of multithreaded system
----------------------------
revision 1.1
date: 1999/10/25 05:58:55;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.12;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.12.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/orastuff.c,v
Working file: orastuff.c
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1998/11/13 20:10:40;  author: kifer;  state: dead;  lines: +3 -3
deleted orastuff.c, since it is generated from orastuff.pc
----------------------------
revision 1.1
date: 1998/11/05 16:55:19;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:19;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff.h,v
Working file: orastuff.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.11
	ROLLBACK: 1.6
	latest_plus_supp_branch: 1.6.0.4
	latest_plus_supp: 1.6
	Version_3dot2_plus_supp: 1.6.0.2
	release_2_6_plus_supp: 1.5.0.12
	Version_3dot2: 1.6
	dec07-perf-results: 1.6
	mt_thesis: 1.6
	release_3_0: 1.6
	release_2_7_0: 1.5
	multi-threaded-26-engine: 1.5.10.1
	pre-mt: 1.5
	multi-threaded-25-engine-done: 1.5.10.1
	multi-threaded-25-engine: 1.5.0.10
	release_2_6_1: 1.5
	release_2_6_final: 1.5
	release_2_6: 1.5.0.8
	last-merged-to-demand: 1.5
	demand_branch: 1.5.0.6
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.4
	release_2_4: 1.5
	release_2_3: 1.5
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.4
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.3
	release-2-0-1: 1.2
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 18;	selected revisions: 18
description:
----------------------------
revision 1.11
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.10
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.9
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2005/01/14 18:31:25;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.6.4;
Integration of multithreaded system
----------------------------
revision 1.5
date: 2000/10/02 13:53:35;  author: ejohnson;  state: Exp;  lines: +1 -28
branches:  1.5.2;  1.5.10;
Include XSB headers to get macros, types, and prototypes available
system-wide: Is[Non]NULL, xsbBool, string_find().

Removed unused prototype for xsb_abort().

Made xsb_config.h the first include.
----------------------------
revision 1.4
date: 2000/04/29 21:53:55;  author: kifer;  state: Exp;  lines: +4 -4
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.3
date: 1999/11/22 22:58:33;  author: warren;  state: Exp;  lines: +3 -11
updated declarations of cinterf routines (actually from builtins).
----------------------------
revision 1.2
date: 1999/10/25 05:58:55;  author: kifer;  state: Exp;  lines: +2 -2
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.5.10.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:17;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.6.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.6.4.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff.pc,v
Working file: orastuff.pc
head: 1.18
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.18
	ROLLBACK: 1.13
	latest_plus_supp_branch: 1.13.0.16
	latest_plus_supp: 1.13
	Version_3dot2_plus_supp: 1.13.0.14
	release_2_6_plus_supp: 1.13.0.12
	Version_3dot2: 1.13
	dec07-perf-results: 1.13
	mt_thesis: 1.13
	release_3_0: 1.13
	release_2_7_0: 1.13
	multi-threaded-26-engine: 1.13.10.1
	pre-mt: 1.13
	multi-threaded-25-engine-done: 1.13.10.1
	multi-threaded-25-engine: 1.13.0.10
	release_2_6_1: 1.13
	release_2_6_final: 1.13
	release_2_6: 1.13.0.8
	last-merged-to-demand: 1.13
	demand_branch: 1.13.0.6
	before_removing_chat: 1.13
	release_2_5: 1.13
	pre-merge-slgwam-gc: 1.13
	multi-threaded-c-engine: 1.13.0.4
	release_2_4: 1.13
	release_2_3: 1.13
	multi-threaded-engine: 1.13.0.2
	pre-threading: 1.12
	release-2-2: 1.10
	chat-and-local: 1.10.0.2
	xsb-pre-cleanup: 1.10
	release-2-1: 1.8
	release-2-0-1: 1.7
	subsumption: 1.3
	without-attv: 1.3
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.2
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.2
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 23;	selected revisions: 23
description:
----------------------------
revision 1.18
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.17
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.16
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2000/10/02 13:53:36;  author: ejohnson;  state: Exp;  lines: +8 -3
branches:  1.13.10;  1.13.16;
Include XSB headers to get macros, types, and prototypes available
system-wide: Is[Non]NULL, xsbBool, string_find().

Removed unused prototype for xsb_abort().

Made xsb_config.h the first include.
----------------------------
revision 1.12
date: 2000/05/20 06:56:04;  author: kifer;  state: Exp;  lines: +2 -2
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.11
date: 2000/04/29 21:53:56;  author: kifer;  state: Exp;  lines: +7 -7
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.10
date: 2000/03/16 21:24:16;  author: dwarren;  state: Exp;  lines: +2 -2
config.h --> xsb_config.h
----------------------------
revision 1.9
date: 1999/12/20 17:52:55;  author: warren;  state: Exp;  lines: +2 -2
changed include of cc.h to include of cinterf.h.
----------------------------
revision 1.8
date: 1999/11/22 22:58:34;  author: warren;  state: Exp;  lines: +2 -1
updated declarations of cinterf routines (actually from builtins).
----------------------------
revision 1.7
date: 1999/10/26 06:47:15;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.6
date: 1999/10/25 05:58:57;  author: kifer;  state: Exp;  lines: +9 -9
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5
date: 1999/10/20 13:49:36;  author: warren;  state: Exp;  lines: +2 -2
FOr some strange reason it didn't like inisgned int; so I changed it
to unsigned int...... oops.
----------------------------
revision 1.4
date: 1999/10/20 13:37:16;  author: warren;  state: Exp;  lines: +2 -2
typedef uint was not recognized by the PRO-C preprocessor, so I
changed the reference back to unsigned int.
----------------------------
revision 1.3
date: 1999/08/16 07:24:25;  author: kifer;  state: Exp;  lines: +75 -85
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.2
date: 1998/11/13 02:49:06;  author: kifer;  state: Exp;  lines: +2 -2
Modifications for porting to NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:27;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:27;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.13.16.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.13.16.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.13.16.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.13.10.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orient_xsb.c,v
Working file: orient_xsb.c
head: 1.28
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.27
	ROLLBACK: 1.22
	latest_plus_supp_branch: 1.22.0.2
	latest_plus_supp: 1.22
	Version_3dot2_plus_supp: 1.21.0.2
	release_2_6_plus_supp: 1.13.4.1.0.2
	Version_3dot2: 1.21
	dec07-perf-results: 1.20
	mt_thesis: 1.17
	release_3_0: 1.17
	release_2_7_0: 1.14
	multi-threaded-26-engine: 1.11.2.2
	pre-mt: 1.14
	multi-threaded-25-engine-done: 1.11.2.1
	multi-threaded-25-engine: 1.11.0.2
	release_2_6_1: 1.13.4.1
	release_2_6_final: 1.13.4.1
	release_2_6: 1.13.0.4
	last-merged-to-demand: 1.13
	demand_branch: 1.13.0.2
	before_removing_chat: 1.11
	release_2_5: 1.11
	pre-merge-slgwam-gc: 1.10
	multi-threaded-c-engine: 1.10.0.2
	release_2_4: 1.10
	release_2_3: 1.8
	multi-threaded-engine: 1.8.0.2
	pre-threading: 1.8
	release-2-2: 1.5
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.2
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 36;	selected revisions: 36
description:
----------------------------
revision 1.28
date: 2011/05/16 01:34:23;  author: kifer;  state: Exp;  lines: +3 -2
squashed some warnings
----------------------------
revision 1.27
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.26
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.25
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2010/01/17 06:30:45;  author: kifer;  state: Exp;  lines: +6 -3
branches:  1.22.2;
fix the windows bug, which prevented correct setting for user home directory
----------------------------
revision 1.21
date: 2008/04/06 23:04:23;  author: tswift;  state: Exp;  lines: +10 -10
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.20
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.19
date: 2007/07/26 02:15:35;  author: evansbj;  state: Exp;  lines: +4 -3
If you launched xsb in a directory, with a directory named xsb you
would not get what you expected. Add a test to make sure we haven't
found a directory named xsb when we are looking for the executable
----------------------------
revision 1.18
date: 2007/01/12 23:33:29;  author: tswift;  state: Exp;  lines: +71 -37

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.17
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +34 -34

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.16
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +5 -5
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.15
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +6 -5
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.14
date: 2003/06/25 16:49:23;  author: lfcastro;  state: Exp;  lines: +23 -8
* Fix random segfaults on WinXP with gcc+no-cygwin (from branch
  Release_2_6)
----------------------------
revision 1.13
date: 2002/03/15 09:19:50;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.13.4;
renamed loader_defs.h to extensions.h
----------------------------
revision 1.12
date: 2002/03/13 10:17:46;  author: kifer;  state: Exp;  lines: +5 -3
replaced file extensions with defined preprocessor constants in preparation to
the objfile extension switch
----------------------------
revision 1.11
date: 2002/02/21 16:57:56;  author: lfcastro;  state: Exp;  lines: +3 -1
branches:  1.11.2;
* Support for compiling with SimpleScalar/PISA
* Some fixes wrt boxed integers
----------------------------
revision 1.10
date: 2001/03/07 17:22:05;  author: dwarren;  state: Exp;  lines: +4 -4
made cygwin/windows more compatible wrt filenames.  Now for windows
users, all forward slashes are converted to backslashes in filenames.
----------------------------
revision 1.9
date: 2001/03/07 15:29:08;  author: kifer;  state: Exp;  lines: +4 -3
changed the bug reporting message
----------------------------
revision 1.8
date: 2000/05/20 06:56:04;  author: kifer;  state: Exp;  lines: +4 -4
branches:  1.8.2;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.7
date: 2000/05/17 23:12:47;  author: kifer;  state: Exp;  lines: +10 -27
if xsb can't create .xsb/, .xsb/config, etc.
then just give a warning, not an error.
----------------------------
revision 1.6
date: 2000/04/29 21:53:56;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.5
date: 2000/04/04 16:31:45;  author: kifer;  state: Exp;  lines: +2 -2
changed email addr from xsb-contact to xsb-development@lists.sourceforge.net
and xsb-installation@lists.sourceforge.net
----------------------------
revision 1.4
date: 2000/01/07 08:51:42;  author: kifer;  state: Exp;  lines: +2 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.3
date: 1999/12/10 07:47:36;  author: kifer;  state: Exp;  lines: +2 -1
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.2
date: 1999/11/16 19:05:59;  author: kifer;  state: Exp;  lines: +10 -9
Revamped sockets interface.
----------------------------
revision 1.1
date: 1999/10/25 05:58:58;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.8.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.8.2.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.11.2.2
date: 2004/10/18 20:46:07;  author: ruim;  state: Exp;  lines: +27 -10
update for version 2.6.1
----------------------------
revision 1.11.2.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.13.4.1
date: 2003/06/25 16:40:20;  author: lfcastro;  state: Exp;  lines: +23 -8

* Allocate 'struct stat' structures in C heap (instead of C stack).
- (apparently) solves random segfaults in startup when compiling
with current cygwin+--enable-no-cygwin & high optimization level
----------------------------
revision 1.22.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.22.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.22.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orient_xsb.h,v
Working file: orient_xsb.h
head: 1.10
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.12.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.12.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.10
date: 2012/02/24 17:37:21;  author: tswift;  state: Exp;  lines: +2 -1

abort_pre_action and friends.
----------------------------
revision 1.9
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2007/01/12 23:33:29;  author: tswift;  state: Exp;  lines: +2 -1
branches:  1.4.4;

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.3
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +2 -2

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.2
date: 2005/01/14 18:31:25;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.1
date: 1999/10/25 05:58:59;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.12;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.12.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:09;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/pathname_xsb.c,v
Working file: pathname_xsb.c
head: 1.43
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.40
	ROLLBACK: 1.35
	latest_plus_supp_branch: 1.35.0.2
	latest_plus_supp: 1.35
	Version_3dot2_plus_supp: 1.34.0.2
	release_2_6_plus_supp: 1.17.0.4
	Version_3dot2: 1.34
	dec07-perf-results: 1.32
	mt_thesis: 1.29
	release_3_0: 1.29
	release_2_7_0: 1.19
	multi-threaded-26-engine: 1.13.2.2
	pre-mt: 1.19
	multi-threaded-25-engine-done: 1.13.2.1
	multi-threaded-25-engine: 1.13.0.2
	release_2_6_1: 1.17
	release_2_6_final: 1.17
	release_2_6: 1.17.0.2
	last-merged-to-demand: 1.15
	demand_branch: 1.15.0.2
	before_removing_chat: 1.13
	release_2_5: 1.13
	pre-merge-slgwam-gc: 1.12
	multi-threaded-c-engine: 1.12.0.2
	release_2_4: 1.12
	release_2_3: 1.9
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.8
	release-2-2: 1.6
	chat-and-local: 1.6.0.2
	xsb-pre-cleanup: 1.6
	release-2-1: 1.4
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 51;	selected revisions: 51
description:
----------------------------
revision 1.43
date: 2011/08/06 04:17:23;  author: kifer;  state: Exp;  lines: +8 -5
two fixes:
1. In transform_cygwin_pathname, if the file name starts with // or /Letter,
   do not do cygwin-to-win conversion. The previous transform was doing strange
   things like //foo/bar --> f:oo/bar

2. In rectify_pathname, a trailing '\0' was missing if the file was just '/' or
    '\'.
----------------------------
revision 1.42
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +4 -4
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.41
date: 2011/05/16 01:34:23;  author: kifer;  state: Exp;  lines: +3 -2
squashed some warnings
----------------------------
revision 1.40
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.39
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.38
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.37
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.36
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.35
date: 2010/02/20 20:57:38;  author: evansbj;  state: Exp;  lines: +7 -4
branches:  1.35.2;
Work the test 'if (*extension != quote quote )' out of the code
----------------------------
revision 1.34
date: 2008/04/06 23:04:23;  author: tswift;  state: Exp;  lines: +6 -5
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.33
date: 2008/02/16 20:11:09;  author: dwarren;  state: Exp;  lines: +2 -1
A minor change that allows cygwin pathname processing to handle one
more drive specification syntax (that showed up when running gdb.
Not sure why....)
----------------------------
revision 1.32
date: 2007/07/16 17:18:30;  author: evansbj;  state: Exp;  lines: +45 -47
Checking for a null result from malloc is a good idead in both cases not just SIMPLESCALAR
----------------------------
revision 1.31
date: 2007/04/20 14:41:00;  author: tswift;  state: Exp;  lines: +4 -4

Made changes to several occurrences of ctop_string to avoid interning the string twice.  I only took the obvious cases, but there were several af them.  Probably at some point we should take a closer look at a few of them to make sure we aren't interning things unnecessarily, but this depends on understanding the actual uses in detail.
----------------------------
revision 1.30
date: 2007/03/09 15:45:49;  author: kifer;  state: Exp;  lines: +4 -2
fixed get_basename: use rectify pathname
----------------------------
revision 1.29
date: 2006/04/17 20:54:57;  author: tswift;  state: Exp;  lines: +2 -1

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.28
date: 2006/01/03 21:16:36;  author: dwarren;  state: Exp;  lines: +8 -2
In almost_search_module, returned ok if it might be a modlue with a suffix.
----------------------------
revision 1.27
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +3 -3

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.26
date: 2005/11/16 17:32:04;  author: dwarren;  state: Exp;  lines: +2 -2
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.25
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +3 -3
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.24
date: 2005/07/05 20:20:44;  author: dwarren;  state: Exp;  lines: +32 -26
Fixed pathname to be thread-safe, mostly by putting names that were
static into the atom-table.  They'll get there anyway.  Also used
malloc instead of mem_alloc once since it was used before mutexes were
initialized, and so crashes (at least on cygwin.)
----------------------------
revision 1.23
date: 2005/03/08 22:21:57;  author: tswift;  state: Exp;  lines: +4 -1

Two changes for compatability

1) Changed consult/compile to use .pl and XSB_SRC_EXTENSION (.P) files interchangably, with
preference for XSB_SRC_EXTENSION files.  .pl files are handled as are XSB_SRC_EXTENSION
files, compared to XSB_OBJECT_EXTENSION (.xwam) files used with .H files,etc.  However if
there is a .P file the .pl wont be examined (even if the .pl file is newer)

Unlike the extensions .pl is hard-wired -- as this is what other Prologs mostly use.

2) added min and max as first-class arithmetic functions, so you can now have expresions
like

X is 3*max(Y,min(Z,W+1))

if you want.  Min/max is useful for reading files written for other Prologs, as well as for
full clpqr.  I introduced two new instructions for these -- I might have gotten away with
one.
----------------------------
revision 1.22
date: 2005/02/04 16:56:14;  author: dwarren;  state: Exp;  lines: +3 -2
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.21
date: 2005/01/24 14:58:04;  author: dwarren;  state: Exp;  lines: +4 -1
Change by Tanya to allow .cpp files to be compiled, loaded and called
from XSB. (along with changes to consult.)
----------------------------
revision 1.20
date: 2005/01/14 18:31:25;  author: ruim;  state: Exp;  lines: +10 -10
Integration of multithreaded system
----------------------------
revision 1.19
date: 2004/02/27 00:49:48;  author: kostis;  state: Exp;  lines: +5 -1
Minor change to make it compile on Solaris -- change is untested and perhaps WIN_NT case can be simplified, but I do not have access to a Windows machine.
----------------------------
revision 1.18
date: 2004/02/16 17:16:39;  author: dwarren;  state: Exp;  lines: +6 -5
Modified existing_file_extension to return a filename only if the file
is not a directory.  This eliminates the
++Error[XSB]: [Runtime/C] [SYS_SYSCALL] Unknown system call number, 9
error when trying to consult a directory (or when a directory is found
before the .P file in the lib-directory search.)
----------------------------
revision 1.17
date: 2003/03/12 14:53:41;  author: lfcastro;  state: Exp;  lines: +11 -25
* Cosmetic fix: minimize (source) differences between Unix & Windows
  versions of expand_filename()
----------------------------
revision 1.16
date: 2003/02/12 21:15:59;  author: lfcastro;  state: Exp;  lines: +3 -3
* Fix bugs in path manipulation
  search_module('./file',_,_,_,_,_) failed when file existed
----------------------------
revision 1.15
date: 2002/03/15 09:19:50;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.15.2;
renamed loader_defs.h to extensions.h
----------------------------
revision 1.14
date: 2002/03/13 10:17:46;  author: kifer;  state: Exp;  lines: +8 -5
replaced file extensions with defined preprocessor constants in preparation to
the objfile extension switch
----------------------------
revision 1.13
date: 2002/02/21 16:57:56;  author: lfcastro;  state: Exp;  lines: +28 -1
branches:  1.13.2;
* Support for compiling with SimpleScalar/PISA
* Some fixes wrt boxed integers
----------------------------
revision 1.12
date: 2001/03/27 17:52:03;  author: dwarren;  state: Exp;  lines: +5 -1
Took out PSC_INT code that MK proposed but is now not needed.  Also
minor changes to pahtname to make it a little more flexible for
cygwin.  Also changed last (?) boolean to xsbBool.
----------------------------
revision 1.11
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +6 -4
improved error messages
----------------------------
revision 1.10
date: 2001/03/07 17:22:05;  author: dwarren;  state: Exp;  lines: +60 -18
made cygwin/windows more compatible wrt filenames.  Now for windows
users, all forward slashes are converted to backslashes in filenames.
----------------------------
revision 1.9
date: 2000/07/01 17:26:09;  author: kifer;  state: Exp;  lines: +5 -8
branches:  1.9.2;
fix to stop clobbering //<driveletter> in cygwin.
----------------------------
revision 1.8
date: 2000/05/20 06:56:05;  author: kifer;  state: Exp;  lines: +5 -5
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.7
date: 2000/04/29 21:53:56;  author: kifer;  state: Exp;  lines: +4 -4
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.6
date: 2000/01/07 08:51:43;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/11/29 00:30:19;  author: kifer;  state: Exp;  lines: +2 -2
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.4
date: 1999/11/17 03:54:32;  author: kifer;  state: Exp;  lines: +2 -2
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.3
date: 1999/11/16 19:06:00;  author: kifer;  state: Exp;  lines: +12 -2
Revamped sockets interface.
----------------------------
revision 1.2
date: 1999/10/26 06:47:17;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:59:00;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +6 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.13.2.2
date: 2004/10/18 20:46:07;  author: ruim;  state: Exp;  lines: +20 -31
update for version 2.6.1
----------------------------
revision 1.13.2.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +10 -10
Sources from rfm repository
----------------------------
revision 1.15.2.1
date: 2003/04/17 17:11:41;  author: lfcastro;  state: Exp;  lines: +13 -27
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.35.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.35.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.35.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/private_builtin.c,v
Working file: private_builtin.c
head: 1.20
branch:
locks: strict
access list:
symbolic names:
	latest_plus_supp: 1.17
	latest_plus_supp_branch: 1.14.0.2
	release_2_6_plus_supp: 1.10.0.8
	release_2_7_0: 1.10
	multi-threaded-26-engine: 1.10.6.1
	pre-mt: 1.10
	multi-threaded-25-engine-done: 1.10.6.1
	multi-threaded-25-engine: 1.10.0.6
	release_2_6_1: 1.10
	release_2_6_final: 1.10
	release_2_6: 1.10.0.4
	last-merged-to-demand: 1.10
	demand_branch: 1.10.0.2
	before_removing_chat: 1.10
	release_2_5: 1.10
	pre-merge-slgwam-gc: 1.9
	multi-threaded-c-engine: 1.9.0.4
	release_2_4: 1.9
	release_2_3: 1.9
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.9
	release-2-2: 1.7
	chat-and-local: 1.7.0.2
	xsb-pre-cleanup: 1.7
	release-2-1: 1.6
	release-2-0-1: 1.6
	subsumption: 1.4
	without-attv: 1.4
	release-2-0: 1.3
keyword substitution: o
total revisions: 26;	selected revisions: 26
description:
----------------------------
revision 1.20
date: 2010/08/19 15:03:36;  author: spyrosh;  state: dead;  lines: +0 -0
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.19
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.18
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.17
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.15
date: 2010/08/17 20:11:37;  author: spyrosh;  state: Exp;  lines: +50 -137
no message
----------------------------
revision 1.14
date: 2005/05/31 18:38:23;  author: kifer;  state: dead;  lines: +1 -1
branches:  1.14.2;
updated build/private_builtin.in
removed emu/private_builtin.c - this file should have never been committed in
				the first place
----------------------------
revision 1.13
date: 2005/04/29 10:54:22;  author: ruim;  state: Exp;  lines: +13 -13
Fix for multithreading
----------------------------
revision 1.12
date: 2005/03/08 22:21:58;  author: tswift;  state: Exp;  lines: +134 -46

Two changes for compatability

1) Changed consult/compile to use .pl and XSB_SRC_EXTENSION (.P) files interchangably, with
preference for XSB_SRC_EXTENSION files.  .pl files are handled as are XSB_SRC_EXTENSION
files, compared to XSB_OBJECT_EXTENSION (.xwam) files used with .H files,etc.  However if
there is a .P file the .pl wont be examined (even if the .pl file is newer)

Unlike the extensions .pl is hard-wired -- as this is what other Prologs mostly use.

2) added min and max as first-class arithmetic functions, so you can now have expresions
like

X is 3*max(Y,min(Z,W+1))

if you want.  Min/max is useful for reading files written for other Prologs, as well as for
full clpqr.  I introduced two new instructions for these -- I might have gotten away with
one.
----------------------------
revision 1.11
date: 2005/01/14 18:31:25;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.10
date: 2002/01/28 16:47:56;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.10.6;
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.9
date: 2000/05/20 06:56:05;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.9.2;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.8
date: 2000/04/29 21:53:56;  author: kifer;  state: Exp;  lines: +3 -3
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.7
date: 2000/01/07 08:51:44;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.6
date: 1999/10/26 06:47:17;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.5
date: 1999/10/25 05:59:00;  author: kifer;  state: Exp;  lines: +4 -4
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.4
date: 1999/10/05 04:01:49;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.3
date: 1999/06/04 17:54:56;  author: luis;  state: Exp;  lines: +3 -1
Minor bugfixes for Windows installation
----------------------------
revision 1.2
date: 1999/04/02 04:06:58;  author: kifer;  state: dead;  lines: +1 -1
private_builtin.c is copied from build/ directory
----------------------------
revision 1.1
date: 1999/04/02 03:48:05;  author: kifer;  state: Exp;
Introduced private_builtin/11
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.10.6.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.14.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.14.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +113 -0
no message
----------------------------
revision 1.14.2.1
date: 2005/05/31 18:38:23;  author: spyrosh;  state: dead;  lines: +0 -200
file private_builtin.c was added on branch latest_plus_supp_branch on 2010-06-19 19:39:50 +0000
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/proc.mk,v
Working file: proc.mk
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.16
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.14
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.10.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.10.1
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.1.1.1
	release-2-2: 1.1.1.1
	chat-and-local: 1.1.1.1.0.2
	xsb-pre-cleanup: 1.1.1.1
	release-2-1: 1.1.1.1
	release-2-0-1: 1.1.1.1
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2000/09/27 06:02:45;  author: kifer;  state: Exp;  lines: +2 -4
branches:  1.2.10;  1.2.16;
minor changes
----------------------------
revision 1.1
date: 1998/11/05 16:55:27;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:27;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.2.16.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.16.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.16.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.10.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/psc.c,v
Working file: psc.c
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.7
	without-attv: 1.7
	release-2-0: 1.4
	pre-release-2-0: 1.4
	v1-9-8: 1.4
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.9
date: 1999/10/26 06:47:18;  author: kifer;  state: dead;  lines: +1 -1
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.8
date: 1999/10/25 05:59:01;  author: kifer;  state: Exp;  lines: +6 -6
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.7
date: 1999/10/05 04:01:50;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.6
date: 1999/08/04 14:42:03;  author: ejohnson;  state: Exp;  lines: +9 -9
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.5
date: 1999/07/06 16:35:13;  author: ejohnson;  state: Exp;  lines: +17 -3
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.4
date: 1999/01/19 14:45:43;  author: cbaoqiu;  state: Exp;  lines: +3 -5
Removed ret_psc_exists[] (it's redundant).
----------------------------
revision 1.3
date: 1998/12/21 01:08:39;  author: cbaoqiu;  state: Exp;  lines: +7 -1
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:10:48;  author: cbaoqiu;  state: Exp;  lines: +20 -1
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  Function get_ret_psc() is added.
----------------------------
revision 1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/psc.h,v
Working file: psc.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.7
	without-attv: 1.6
	release-2-0: 1.4
	pre-release-2-0: 1.4
	v1-9-8: 1.4
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.9
date: 1999/10/26 06:47:20;  author: kifer;  state: dead;  lines: +1 -1
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.8
date: 1999/10/23 21:19:26;  author: kifer;  state: Exp;  lines: +3 -16
separated psc_defs.h from psc.h
----------------------------
revision 1.7
date: 1999/10/12 20:21:48;  author: ejohnson;  state: Exp;  lines: +6 -1
Added ifdef to prevent multiple inclusions.
----------------------------
revision 1.6
date: 1999/08/30 13:57:24;  author: kostis;  state: Exp;  lines: +11 -17
Unused and obsolete PSC stuff taken out.
----------------------------
revision 1.5
date: 1999/07/06 16:35:14;  author: ejohnson;  state: Exp;  lines: +3 -2
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.4
date: 1999/01/19 16:45:07;  author: kostis;  state: Exp;  lines: +2 -2
Eliminated some dependency on 255's arbitrarily placed in the code.
----------------------------
revision 1.3
date: 1999/01/19 14:45:45;  author: cbaoqiu;  state: Exp;  lines: +1 -2
Removed ret_psc_exists[] (it's redundant).
----------------------------
revision 1.2
date: 1998/12/09 03:12:47;  author: cbaoqiu;  state: Exp;  lines: +5 -1
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  ret_psc_exists[], ret_psc[], and get_ret_psc() are declared extern.
----------------------------
revision 1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/psc_defs.h,v
Working file: psc_defs.h
head: 1.21
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.21
	ROLLBACK: 1.15
	latest_plus_supp_branch: 1.13.0.2
	latest_plus_supp: 1.13
	Version_3dot2_plus_supp: 1.12.0.2
	release_2_6_plus_supp: 1.4.0.10
	Version_3dot2: 1.12
	dec07-perf-results: 1.12
	mt_thesis: 1.11
	release_3_0: 1.11
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.4.8.1
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.4.8.1
	multi-threaded-25-engine: 1.4.0.8
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.6
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.4
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.2
	release_2_4: 1.3
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 27;	selected revisions: 27
description:
----------------------------
revision 1.21
date: 2010/09/05 18:47:17;  author: tswift;  state: Exp;  lines: +4 -1

Fixes to make incremental tabling work properly when opaque is
switched to incremental.  I had made a fix to predicate_property to
distinguish incremenel from opaque that apparently broke things.
----------------------------
revision 1.20
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.19
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.18
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/07 18:18:26;  author: tswift;  state: Exp;  lines: +2 -1

Refactored and expanded code for dynamic/1 and table/1.  I fixed
a bug with dynamic pred as tabled, rewrote some obscure code to
fix a memory leak in double allocation of prrefs, and fixed a bug
to allow static code to be rewritten as nonincremental or as
opaque.  Also, I added inconsistency checks for dynamic and
tabled options.
----------------------------
revision 1.14
date: 2010/07/31 17:29:09;  author: tswift;  state: Exp;  lines: +4 -1

Forgot to commit these when expanding predicate property for various
types of tabling.
----------------------------
revision 1.13
date: 2009/11/25 16:51:57;  author: dwarren;  state: Exp;  lines: +2 -1
branches:  1.13.2;
Changes to runtime to support import-as, as in:
:- import member/2 from basics as mymember/2.
This creates a new psc for mymember/2 in the current module that is
tied to the definition of member/2 in basics.  Dynamic loading is supported.
This supports declarations such as:
:- export member/2.
:- import member/2 from basics as member/2.
in a file named listutils.P
This would allow member to be imported from listutils, but remain defined in basics.
(The cost is an extra branch when calling it through listutils.)
----------------------------
revision 1.12
date: 2007/11/01 23:46:59;  author: tswift;  state: Exp;  lines: +1 -2


Added a command-line argument, --shared-predicates which, in the MT
engine makes dynamic code and tables shared by default.  If this
command-line argument is not used.  The default behavior is kept in a
flag so it can be queried, but not changed during run time.

Also, fixed a bug in dynamic as an executable directive.  ?-
dyanamic(p/n) succeeded even when p/n was static -- worse, it actually
CHANGED p/n to dynamic, working like an abolish for static predicates.
Don't know how that got in there.
----------------------------
revision 1.11
date: 2006/05/02 14:30:39;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed loader to correctly reset (or not) tabled bit for predicate.
Required passing "defined" indication in symbol table from compiler.
----------------------------
revision 1.10
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +2 -4


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.9
date: 2005/09/13 13:02:05;  author: dwarren;  state: Exp;  lines: +13 -7
Fixed abolish_table_pred to work with private tables in multithreaded
(but there seems to be a memory leak that still needs to be tracked down.)
Also improved documentation of psc fields for tabling and sharedness.
Changed TDispBlk_t type for table dispatch blocks to allow direct coercion
to a TIF (so they agree on the psc and method fields.)
(Also, the load_backsuite test fails on cygwin, for a reason yet to be determined.)
----------------------------
revision 1.8
date: 2005/09/09 23:53:21;  author: tswift;  state: Exp;  lines: +10 -2

PSC records are overloaded, so I added some documentation.  Also, got rid of T_FILE PSC type, as all file descriptors should go through the steram table now.
----------------------------
revision 1.7
date: 2005/08/16 19:19:09;  author: dwarren;  state: Exp;  lines: +6 -3
Changes for multi-threading:
1. Added open/4 to allow forcing of a new open.  open/3 returns previously opened
file (with same name and mode) if there is one.  This is needed in multithreading
to allow each thread to open the same file to read it.
2. Reworked how table directives are passed from the compiler to the execution
state.  It is now passed through the xwam files, and use_subsumptive_tabling
and use_variant_tabling is also passed this way.  shared/private, and tabling (variant
or subsumptive) tags are kept in the psc record (in bits in the env byte.)
This is not completely compatible with old .xwam files, so they shoudl be
recompiled.  If they aren't, then all tabled predicates are assumed to be tabled
with variant tabling, and a warning is given.
3. Updated the compiler so that most (all?) of its output files are now
written to explicit streams (instead of using tell.)
----------------------------
revision 1.6
date: 2005/08/08 21:25:02;  author: dwarren;  state: Exp;  lines: +6 -1
SImple cleanup, mostly using define-cons instead of numbers in various places.
----------------------------
revision 1.5
date: 2005/01/14 18:31:26;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.4
date: 2001/07/16 05:15:37;  author: kifer;  state: Exp;  lines: +6 -1
branches:  1.4.8;
added USERMOD_PSC constant
----------------------------
revision 1.3
date: 2001/05/24 17:54:52;  author: lfcastro;  state: Exp;  lines: +4 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.2
date: 1999/11/03 21:35:48;  author: cbaoqiu;  state: Exp;  lines: +10 -3
branches:  1.2.4;
Kostis' changes to support long atoms in compiled code.
----------------------------
revision 1.1
date: 1999/10/23 21:19:27;  author: kifer;  state: Exp;
separated psc_defs.h from psc.h
----------------------------
revision 1.2.4.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.4.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.8.1
date: 2004/09/29 19:44:18;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.13.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.13.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.13.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/psc_xsb.c,v
Working file: psc_xsb.c
head: 1.59
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.57
	ROLLBACK: 1.51
	latest_plus_supp_branch: 1.47.0.2
	latest_plus_supp: 1.47
	Version_3dot2_plus_supp: 1.43.0.2
	release_2_6_plus_supp: 1.12.0.4
	Version_3dot2: 1.43
	dec07-perf-results: 1.38
	mt_thesis: 1.34
	release_3_0: 1.31
	release_2_7_0: 1.17
	multi-threaded-26-engine: 1.10.6.2
	pre-mt: 1.17
	multi-threaded-25-engine-done: 1.10.6.1
	multi-threaded-25-engine: 1.10.0.6
	release_2_6_1: 1.12
	release_2_6_final: 1.12
	release_2_6: 1.12.0.2
	last-merged-to-demand: 1.10
	demand_branch: 1.10.0.4
	before_removing_chat: 1.10
	release_2_5: 1.10
	pre-merge-slgwam-gc: 1.10
	multi-threaded-c-engine: 1.10.0.2
	release_2_4: 1.10
	release_2_3: 1.7
	multi-threaded-engine: 1.7.0.2
	pre-threading: 1.5
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 68;	selected revisions: 68
description:
----------------------------
revision 1.59
date: 2012/02/18 04:46:54;  author: kifer;  state: Exp;  lines: +2 -2
minated some compiler warnings
added DllExport to find_string, mem_alloc, mem_realloc.
----------------------------
revision 1.58
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.57
date: 2010/08/19 15:03:36;  author: spyrosh;  state: Exp;  lines: +2 -3
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.56
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.55
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.54
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.53
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.52
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +3 -2
no message
----------------------------
revision 1.51
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.50
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.49
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +1 -2
Backed out code
----------------------------
revision 1.48
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +3 -2
Dipti's code for support graph added
----------------------------
revision 1.47
date: 2009/11/30 19:19:36;  author: dwarren;  state: Exp;  lines: +6 -4
branches:  1.47.2;
Fixed set_psc_ep_to_psc to allow redefinition of ep to the same value.
Avoids spurious warning (and error.)
----------------------------
revision 1.46
date: 2009/11/25 16:51:57;  author: dwarren;  state: Exp;  lines: +2 -2
Changes to runtime to support import-as, as in:
:- import member/2 from basics as mymember/2.
This creates a new psc for mymember/2 in the current module that is
tied to the definition of member/2 in basics.  Dynamic loading is supported.
This supports declarations such as:
:- export member/2.
:- import member/2 from basics as member/2.
in a file named listutils.P
This would allow member to be imported from listutils, but remain defined in basics.
(The cost is an extra branch when calling it through listutils.)
----------------------------
revision 1.45
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.44
date: 2009/10/19 16:51:14;  author: dwarren;  state: Exp;  lines: +14 -1
Added erf (normal error function) call in function.  (Useful for PRISM-like reasoning.)
Added psc_import_as function, which assigns the entry-point of a psc to point to the
load-address of another PSC.  Will be used for "import a from b as c" functionality,
but it's not complete yet.
----------------------------
revision 1.43
date: 2009/03/12 13:13:43;  author: dwarren;  state: Exp;  lines: +2 -2
Change slightly the condition that triggers string garbage collection.
----------------------------
revision 1.42
date: 2009/02/04 16:17:19;  author: dwarren;  state: Exp;  lines: +6 -2
Modified slightly when to force string_gc, so that instead of forcing
string GC whenevery the string space expands 4-fold, to do it only if
the assert space isn't also expanding.  Was finding that for large loads,
unnecessary string GC's were taking half the load time...
----------------------------
revision 1.41
date: 2009/01/30 22:31:34;  author: dwarren;  state: Exp;  lines: +15 -9
Fixed bug in printing warning message, when module is usermod, since
now psc_data may be a string.
----------------------------
revision 1.40
date: 2008/05/07 15:08:31;  author: dwarren;  state: Exp;  lines: +2 -1
To make snprintf available where it is not needed in systems
in which it is not in the library (as MSWIN)
----------------------------
revision 1.39
date: 2008/04/06 23:04:23;  author: tswift;  state: Exp;  lines: +3 -3
A couple of weeks ago, we had a weekend crisis at Customs due to
the fact that some string buffers were overflowing because we had
used sprintf() rather than snprintf().  Fortunately we were able
to localize the problem relatively quickly, but this motivated me
to go through XSB's code to change sprintfs into snprintfs.  In
any case, it took almost no time to make the changes.

So most of the dubious sprintfs have been changed,
where "dubious" means that the format string contains at least
one %s.  Nearly all of these sprintfs were in error cases or in
startup so they will not be done at all commonly and the sprintf
-snprintf should make no difference for speed.
----------------------------
revision 1.38
date: 2007/10/22 16:16:24;  author: dwarren;  state: Exp;  lines: +3 -1
Add check for large string space growth in test_heap, so string space
is garbage collected, even if there is no potential heap overflow.
----------------------------
revision 1.37
date: 2007/10/07 17:37:54;  author: tswift;  state: Exp;  lines: +2 -2

Two sets of changes.

First, was to add const declaration modifiers to external ctop and
ptoc routines.  Apparently some C++ compilers can benefit from this
modifier, and it should help the Parma polyhedra group and others who
call XSB from C++.

The second change supports call_cleanup, and fixes a minor bug in the
implementation of catch (see the emails on the XSB group).  This
update does not handle cutting over call cleanup -- I'll try to get
that in soon.
----------------------------
revision 1.36
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.35
date: 2007/04/16 16:14:16;  author: tswift;  state: Exp;  lines: +2 -1

Got rid of some unnecessary calls to string_find().  There are
plenty left due to ctop_string() calls.

--- It turned out that read/[1,2] was interning each token 3
    times, and I got rid of 2 of those 3, by tweaking the builtin
    call and by redefining the unnecessary read_getcon.

-- It also turned out that nl, and file_nl were performing
   unnecessary string interns because of windows_os_loader.  I
   got rid of that function and moved file_nl to C (in
   file_function).  Also, I redefined nl/0 to call file_nl.
----------------------------
revision 1.34
date: 2006/11/20 16:53:42;  author: ruim;  state: Exp;  lines: +3 -3
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.33
date: 2006/09/06 15:11:27;  author: dwarren;  state: Exp;  lines: +1 -0
Initialize psc field incr to 0.
----------------------------
revision 1.32
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +9 -4
Incremental Code Added.
----------------------------
revision 1.31
date: 2006/04/10 13:06:25;  author: dwarren;  state: Exp;  lines: +1 -4
Renamed "length" byte in psc record to unused, (and took out initialization)
since it is no longer used.  Now have space for other bits.
----------------------------
revision 1.30
date: 2006/03/18 17:37:49;  author: tswift;  state: Exp;  lines: +2 -2
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.29
date: 2006/01/13 23:56:57;  author: tswift;  state: Exp;  lines: +11 -4

psc_xsb.c changed so that get_tip returns NULL when called with a
non-tabled predicate in the MT engine -- calling routines such as
abolish_table_pred/1 can then throw an error.

statistics files changed pretty minimally.  Basically, I just changed
them enough to prevent core dumps when calling statistics (due to the
new structure managers).  Or at least to sometimes prevent core dumps :-)
More work on them will be needed.
----------------------------
revision 1.28
date: 2005/12/22 23:33:57;  author: tswift;  state: Exp;  lines: +13 -10

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.27
date: 2005/12/12 18:44:53;  author: dwarren;  state: Exp;  lines: +14 -1
Added string table garbage collection.
----------------------------
revision 1.26
date: 2005/11/20 21:23:29;  author: dwarren;  state: Exp;  lines: +4 -4
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.25
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +4 -4
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.24
date: 2005/09/13 13:02:05;  author: dwarren;  state: Exp;  lines: +9 -4
Fixed abolish_table_pred to work with private tables in multithreaded
(but there seems to be a memory leak that still needs to be tracked down.)
Also improved documentation of psc fields for tabling and sharedness.
Changed TDispBlk_t type for table dispatch blocks to allow direct coercion
to a TIF (so they agree on the psc and method fields.)
(Also, the load_backsuite test fails on cygwin, for a reason yet to be determined.)
----------------------------
revision 1.23
date: 2005/09/09 23:53:21;  author: tswift;  state: Exp;  lines: +1 -3

PSC records are overloaded, so I added some documentation.  Also, got rid of T_FILE PSC type, as all file descriptors should go through the steram table now.
----------------------------
revision 1.22
date: 2005/08/25 00:19:05;  author: dwarren;  state: Exp;  lines: +12 -2
Fix bug in abolish_table_pred for thread_private dynamic predicates.
----------------------------
revision 1.21
date: 2005/08/13 15:18:17;  author: dwarren;  state: Exp;  lines: +6 -3
Initialize the env byte (including shared bit) to 0!!!
----------------------------
revision 1.20
date: 2005/08/08 17:11:33;  author: dwarren;  state: Exp;  lines: +27 -10
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.19
date: 2005/05/03 17:12:47;  author: dwarren;  state: Exp;  lines: +5 -4
Fix a bug in a warning message, when module is represented by Null pointer in psc data field.
----------------------------
revision 1.18
date: 2005/01/14 18:31:26;  author: ruim;  state: Exp;  lines: +19 -6
Integration of multithreaded system
----------------------------
revision 1.17
date: 2004/09/30 13:22:21;  author: dwarren;  state: Exp;  lines: +3 -3
Refine 64-bit mods (and fix some inconsistencies I introduced yesterday...)
----------------------------
revision 1.16
date: 2004/01/29 18:44:09;  author: dwarren;  state: Exp;  lines: +1 -2
Modified implementation of profiling to avoid the extra psc-record
field for the count.  Now the counts are kept in the code-ptr records
and accumulated only at accumulation time.  Someday may want to improve
accumulation algorithm.
----------------------------
revision 1.15
date: 2004/01/28 16:41:40;  author: dwarren;  state: Exp;  lines: +3 -11
Take out "optimization" of moving found pair record to front of hash
bucket chain. Breaks Prolog's running of chain in currsym.P
----------------------------
revision 1.14
date: 2004/01/14 20:27:13;  author: dwarren;  state: Exp;  lines: +14 -3
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.13
date: 2003/09/08 16:51:00;  author: dwarren;  state: Exp;  lines: +12 -6
Improved warning message when loading a predicate defined in another module.
----------------------------
revision 1.12
date: 2003/06/18 16:37:35;  author: lfcastro;  state: Exp;  lines: +2 -2
* Ensure invariant that psc->data for predicates always points to the
  corresponding module's psc.
----------------------------
revision 1.11
date: 2002/08/15 17:00:26;  author: lfcastro;  state: Exp;  lines: +2 -2
* interrupt handling (minor) cleanup:
  removed unnecessary argument to synint_proc & default_inthandler
----------------------------
revision 1.10
date: 2001/05/24 17:54:52;  author: lfcastro;  state: Exp;  lines: +2 -1
branches:  1.10.4;  1.10.6;
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.9
date: 2001/03/27 17:52:03;  author: dwarren;  state: Exp;  lines: +1 -7
Took out PSC_INT code that MK proposed but is now not needed.  Also
minor changes to pahtname to make it a little more flexible for
cygwin.  Also changed last (?) boolean to xsbBool.
----------------------------
revision 1.8
date: 2001/03/23 03:54:31;  author: kifer;  state: Exp;  lines: +16 -6
added new PSC creation interrupt. -- doesn't work yet
----------------------------
revision 1.7
date: 2000/06/30 19:34:04;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.7.2;
initialized data filed in psc-record so that conget would get 0
initially.
----------------------------
revision 1.6
date: 2000/06/28 16:54:51;  author: ruim;  state: Exp;  lines: +4 -4
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.5
date: 2000/05/20 06:56:05;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.4
date: 2000/03/01 16:22:34;  author: dwarren;  state: Exp;  lines: +12 -9
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.3
date: 2000/01/07 08:51:45;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.2
date: 1999/12/22 18:07:03;  author: warren;  state: Exp;  lines: +5 -5
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.1
date: 1999/10/26 06:47:21;  author: kifer;  state: Exp;
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.7.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.7.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +4 -3
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.10.6.2
date: 2004/10/18 20:46:08;  author: ruim;  state: Exp;  lines: +3 -3
update for version 2.6.1
----------------------------
revision 1.10.6.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +19 -6
Sources from rfm repository
----------------------------
revision 1.10.4.2
date: 2003/04/17 17:11:41;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.10.4.1
date: 2002/08/28 19:20:25;  author: lfcastro;  state: Exp;  lines: +2 -2
* FIXED problem in once/1 when there are no choicepoints under its
  scope
* MERGED patch from HEAD that fixes bug in interrupt handling (& attv)
* INCLUDED test predicate for demand & negation
----------------------------
revision 1.47.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.47.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +2 -1
no message
----------------------------
revision 1.47.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/psc_xsb.h,v
Working file: psc_xsb.h
head: 1.52
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.49
	ROLLBACK: 1.42
	latest_plus_supp_branch: 1.37.0.2
	latest_plus_supp: 1.37
	Version_3dot2_plus_supp: 1.33.0.2
	release_2_6_plus_supp: 1.9.0.4
	Version_3dot2: 1.33
	dec07-perf-results: 1.29
	mt_thesis: 1.23
	release_3_0: 1.21
	release_2_7_0: 1.12
	multi-threaded-26-engine: 1.8.4.2
	pre-mt: 1.12
	multi-threaded-25-engine-done: 1.8.4.1
	multi-threaded-25-engine: 1.8.0.4
	release_2_6_1: 1.9
	release_2_6_final: 1.9
	release_2_6: 1.9.0.2
	last-merged-to-demand: 1.8
	demand_branch: 1.8.0.2
	before_removing_chat: 1.8
	release_2_5: 1.8
	pre-merge-slgwam-gc: 1.7
	multi-threaded-c-engine: 1.7.0.2
	release_2_4: 1.7
	release_2_3: 1.6
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.5
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 60;	selected revisions: 60
description:
----------------------------
revision 1.52
date: 2012/02/18 04:46:55;  author: kifer;  state: Exp;  lines: +4 -2
minated some compiler warnings
added DllExport to find_string, mem_alloc, mem_realloc.
----------------------------
revision 1.51
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +2 -1
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.50
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +4 -1

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.49
date: 2010/09/05 18:47:17;  author: tswift;  state: Exp;  lines: +22 -12

Fixes to make incremental tabling work properly when opaque is
switched to incremental.  I had made a fix to predicate_property to
distinguish incremenel from opaque that apparently broke things.
----------------------------
revision 1.48
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +2 -6
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.47
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.46
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.45
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.44
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.43
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +6 -2
no message
----------------------------
revision 1.42
date: 2010/08/07 18:18:26;  author: tswift;  state: Exp;  lines: +3 -2

Refactored and expanded code for dynamic/1 and table/1.  I fixed
a bug with dynamic pred as tabled, rewrote some obscure code to
fix a memory leak in double allocation of prrefs, and fixed a bug
to allow static code to be rewritten as nonincremental or as
opaque.  Also, I added inconsistency checks for dynamic and
tabled options.
----------------------------
revision 1.41
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.40
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.39
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +1 -5
Backed out code
----------------------------
revision 1.38
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +6 -2
Dipti's code for support graph added
----------------------------
revision 1.37
date: 2010/02/10 19:11:12;  author: dwarren;  state: Exp;  lines: +4 -1
branches:  1.37.2;
Made excess_vars a builtin, for efficiency.
----------------------------
revision 1.36
date: 2010/02/06 19:26:56;  author: evansbj;  state: Exp;  lines: +9 -1
this file sometime goes through a c++ compiler
----------------------------
revision 1.35
date: 2009/11/25 16:51:57;  author: dwarren;  state: Exp;  lines: +6 -4
Changes to runtime to support import-as, as in:
:- import member/2 from basics as mymember/2.
This creates a new psc for mymember/2 in the current module that is
tied to the definition of member/2 in basics.  Dynamic loading is supported.
This supports declarations such as:
:- export member/2.
:- import member/2 from basics as member/2.
in a file named listutils.P
This would allow member to be imported from listutils, but remain defined in basics.
(The cost is an extra branch when calling it through listutils.)
----------------------------
revision 1.34
date: 2009/10/19 16:51:14;  author: dwarren;  state: Exp;  lines: +2 -1
Added erf (normal error function) call in function.  (Useful for PRISM-like reasoning.)
Added psc_import_as function, which assigns the entry-point of a psc to point to the
load-address of another PSC.  Will be used for "import a from b as c" functionality,
but it's not complete yet.
----------------------------
revision 1.33
date: 2008/07/25 22:07:37;  author: tswift;  state: Exp;  lines: +2 -1

Forgot to commit this -- thanks Barry!
----------------------------
revision 1.32
date: 2008/02/22 17:10:16;  author: tswift;  state: Exp;  lines: +2 -1
Changes to make call/1 go to the cut transform for load_undef -- possibly not needed.
----------------------------
revision 1.31
date: 2008/02/21 20:57:50;  author: tswift;  state: Exp;  lines: +3 -1

Changes to optimize call/1 for atomic predicates (e.g. not ,/2 ;/2 etc.

Also, tweaked an error message for atom_chars/codes
----------------------------
revision 1.30
date: 2008/01/02 19:47:43;  author: dwarren;  state: Exp;  lines: +3 -2
Fix (or at least greatly improve) the C-calling-XSB (recursively) interface for
the multi-threaded engine.  There is still an issue with multiple calls of
different C threads, but sharing the same th-context.  But I think the problem
is in more than just this interface.
----------------------------
revision 1.29
date: 2007/10/28 23:32:35;  author: tswift;  state: Exp;  lines: +2 -1


Added evaluable functions **/2 and sign/1, which were in the core standard.

Added an evaluable xor function ></2 which is in the revision.

Rewrote arithmetic_abort to give evaluation errors and instantiation
errors, making us a little more compliant.  We still aren't reporting
underflows or overflows, so we do deviate from the standard in this
respect.
----------------------------
revision 1.28
date: 2007/10/22 16:16:25;  author: dwarren;  state: Exp;  lines: +3 -1
Add check for large string space growth in test_heap, so string space
is garbage collected, even if there is no potential heap overflow.
----------------------------
revision 1.27
date: 2007/10/07 17:37:54;  author: tswift;  state: Exp;  lines: +2 -2

Two sets of changes.

First, was to add const declaration modifiers to external ctop and
ptoc routines.  Apparently some C++ compilers can benefit from this
modifier, and it should help the Parma polyhedra group and others who
call XSB from C++.

The second change supports call_cleanup, and fixes a minor bug in the
implementation of catch (see the emails on the XSB group).  This
update does not handle cutting over call cleanup -- I'll try to get
that in soon.
----------------------------
revision 1.26
date: 2007/06/01 22:47:09;  author: tswift;  state: Exp;  lines: +5 -3

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.25
date: 2007/02/09 18:12:17;  author: dwarren;  state: Exp;  lines: +4 -5
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.24
date: 2007/01/25 20:33:55;  author: tswift;  state: Exp;  lines: +2 -1


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.23
date: 2006/11/28 22:43:05;  author: tswift;  state: Exp;  lines: +8 -10

Changes in documentation mostly -- but also ifdeffed out some incremental completion stuff that seemed not to work with multi-threading.
----------------------------
revision 1.22
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +8 -4
Incremental Code Added.
----------------------------
revision 1.21
date: 2006/04/17 20:54:57;  author: tswift;  state: Exp;  lines: +7 -2

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.20
date: 2006/04/10 13:06:25;  author: dwarren;  state: Exp;  lines: +2 -2
Renamed "length" byte in psc record to unused, (and took out initialization)
since it is no longer used.  Now have space for other bits.
----------------------------
revision 1.19
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +5 -5


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.18
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +10 -9


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.17
date: 2005/09/13 13:02:05;  author: dwarren;  state: Exp;  lines: +11 -4
Fixed abolish_table_pred to work with private tables in multithreaded
(but there seems to be a memory leak that still needs to be tracked down.)
Also improved documentation of psc fields for tabling and sharedness.
Changed TDispBlk_t type for table dispatch blocks to allow direct coercion
to a TIF (so they agree on the psc and method fields.)
(Also, the load_backsuite test fails on cygwin, for a reason yet to be determined.)
----------------------------
revision 1.16
date: 2005/09/09 23:53:21;  author: tswift;  state: Exp;  lines: +35 -1

PSC records are overloaded, so I added some documentation.  Also, got rid of T_FILE PSC type, as all file descriptors should go through the steram table now.
----------------------------
revision 1.15
date: 2005/08/16 19:19:09;  author: dwarren;  state: Exp;  lines: +5 -5
Changes for multi-threading:
1. Added open/4 to allow forcing of a new open.  open/3 returns previously opened
file (with same name and mode) if there is one.  This is needed in multithreading
to allow each thread to open the same file to read it.
2. Reworked how table directives are passed from the compiler to the execution
state.  It is now passed through the xwam files, and use_subsumptive_tabling
and use_variant_tabling is also passed this way.  shared/private, and tabling (variant
or subsumptive) tags are kept in the psc record (in bits in the env byte.)
This is not completely compatible with old .xwam files, so they shoudl be
recompiled.  If they aren't, then all tabled predicates are assumed to be tabled
with variant tabling, and a warning is given.
3. Updated the compiler so that most (all?) of its output files are now
written to explicit streams (instead of using tell.)
----------------------------
revision 1.14
date: 2005/08/08 21:25:02;  author: dwarren;  state: Exp;  lines: +6 -6
SImple cleanup, mostly using define-cons instead of numbers in various places.
----------------------------
revision 1.13
date: 2005/08/08 17:11:33;  author: dwarren;  state: Exp;  lines: +13 -7
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.12
date: 2004/03/05 00:58:22;  author: dwarren;  state: Exp;  lines: +2 -1
Cleaned up initialization of constant psc record pointers.  They should
be created in standard, not in usermod.
Also modified term_new_mod to tread mod1:mod2:term as mod1:term.
----------------------------
revision 1.11
date: 2004/01/29 18:44:09;  author: dwarren;  state: Exp;  lines: +1 -2
Modified implementation of profiling to avoid the extra psc-record
field for the count.  Now the counts are kept in the code-ptr records
and accumulated only at accumulation time.  Someday may want to improve
accumulation algorithm.
----------------------------
revision 1.10
date: 2004/01/14 20:27:13;  author: dwarren;  state: Exp;  lines: +2 -1
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.9
date: 2003/03/14 18:54:29;  author: dwarren;  state: Exp;  lines: +4 -1
Minor changes to create and use some "builtin" psc-addresses, rather than
re-insert every time one is needed.
----------------------------
revision 1.8
date: 2002/01/23 17:08:10;  author: dwarren;  state: Exp;  lines: +2 -1
branches:  1.8.2;  1.8.4;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.7
date: 2001/05/24 17:54:52;  author: lfcastro;  state: Exp;  lines: +8 -1
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.6
date: 2000/07/31 20:27:55;  author: ejohnson;  state: Exp;  lines: +2 -1
branches:  1.6.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.5
date: 2000/04/29 21:53:57;  author: kifer;  state: Exp;  lines: +3 -3
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.4
date: 2000/03/01 16:22:34;  author: dwarren;  state: Exp;  lines: +13 -3
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.3
date: 1999/12/22 18:07:04;  author: warren;  state: Exp;  lines: +2 -2
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.2
date: 1999/12/14 21:11:14;  author: ejohnson;  state: Exp;  lines: +3 -1
Added extern to function get_tip(Psc).
----------------------------
revision 1.1
date: 1999/10/26 06:47:22;  author: kifer;  state: Exp;
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +4 -4
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.8.4.2
date: 2004/10/18 20:46:08;  author: ruim;  state: Exp;  lines: +4 -1
update for version 2.6.1
----------------------------
revision 1.8.4.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.8.2.1
date: 2003/04/17 17:11:40;  author: lfcastro;  state: Exp;  lines: +4 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.37.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.37.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +5 -1
no message
----------------------------
revision 1.37.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/ptoc_tag_xsb_i.h,v
Working file: ptoc_tag_xsb_i.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.3.0.6
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.2.6.2
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.2.6.1
	multi-threaded-25-engine: 1.2.0.6
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.4
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.2
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.2
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.9
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2005/01/14 18:31:27;  author: ruim;  state: Exp;  lines: +2 -2
branches:  1.4.4;
Integration of multithreaded system
----------------------------
revision 1.3
date: 2002/03/13 22:40:13;  author: lfcastro;  state: Exp;  lines: +5 -2
* first step in implementing demand
- new (experimental) primitive: demand_once/1
- executes query and, after first answer is returned, deletes all
consumers created during execution; further, any tables created are
also destroyed
----------------------------
revision 1.2
date: 2000/04/29 21:53:57;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.2.2;  1.2.6;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.1
date: 1999/12/10 07:47:36;  author: kifer;  state: Exp;
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.2.6.2
date: 2004/10/18 20:46:08;  author: ruim;  state: Exp;  lines: +5 -2
update for version 2.6.1
----------------------------
revision 1.2.6.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +2 -2
Sources from rfm repository
----------------------------
revision 1.2.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +5 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/random_xsb.c,v
Working file: random_xsb.c
head: 1.20
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.18
	ROLLBACK: 1.13
	latest_plus_supp_branch: 1.13.0.4
	latest_plus_supp: 1.13
	Version_3dot2_plus_supp: 1.13.0.2
	release_2_6_plus_supp: 1.6.0.8
	Version_3dot2: 1.13
	dec07-perf-results: 1.12
	mt_thesis: 1.11
	release_3_0: 1.11
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.6.6.1
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.6.6.1
	multi-threaded-25-engine: 1.6.0.6
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.4
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.6
	release_2_5: 1.6
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.4
	release_2_4: 1.5
	release_2_3: 1.5
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.5
	release-2-2: 1.4
keyword substitution: kv
total revisions: 26;	selected revisions: 26
description:
----------------------------
revision 1.20
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +4 -4
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.19
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +4 -4
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.18
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.17
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.16
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2008/02/16 18:00:42;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.13.4;
Add new instructions putdfloat and getdfloat to handle double floats.
Update the loader to load these instructions from the xwam files.
(There is a possible problem.  The doubles are written into the xwam
file as bitstrings, and read by the loader as the same bitstring.  If
representations on different machines are different, then xwam files
compiled on one system won't run on another.)
----------------------------
revision 1.12
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.11
date: 2006/01/05 22:49:52;  author: dwarren;  state: Exp;  lines: +3 -3
Fix a bug in initializing seed (float part.)  Caused repeated generation
of same random float too often....
----------------------------
revision 1.10
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +2 -2
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.9
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +3 -2
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.8
date: 2005/07/11 19:47:20;  author: dwarren;  state: Exp;  lines: +43 -24
Made the random builtins thread-safe.  (But it doesn't look like there's any interface
from Prolog to them??)
----------------------------
revision 1.7
date: 2005/01/14 18:31:27;  author: ruim;  state: Exp;  lines: +15 -15
Integration of multithreaded system
----------------------------
revision 1.6
date: 2002/01/23 17:08:10;  author: dwarren;  state: Exp;  lines: +4 -4
branches:  1.6.6;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.5
date: 2000/05/20 06:56:06;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.5.2;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.4
date: 2000/04/07 19:16:03;  author: cbaoqiu;  state: Exp;  lines: +6 -6
Removed some new warnings.
----------------------------
revision 1.3
date: 2000/04/07 18:37:17;  author: cbaoqiu;  state: Exp;  lines: +7 -6
God rid of some type mismatch between floats and integers.
----------------------------
revision 1.2
date: 2000/04/06 11:19:15;  author: cbaoqiu;  state: Exp;  lines: +9 -9
Let ret_random() and getrand() return TRUE or FALSE (instead of 0 and
-1) to be consistent with other builtin implementations.
----------------------------
revision 1.1
date: 2000/04/05 17:39:41;  author: cbaoqiu;  state: Exp;
Added new files random_xsb.c and random_xsb.h.
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +19 -4
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.6.6.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +15 -15
Sources from rfm repository
----------------------------
revision 1.13.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.13.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.13.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/random_xsb.h,v
Working file: random_xsb.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	release_2_6_plus_supp: 1.1.0.12
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.10.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.10.1
	multi-threaded-25-engine: 1.1.0.10
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.8
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.6
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.4
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.2
	pre-threading: 1.1
	release-2-2: 1.1
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2005/01/14 18:31:28;  author: ruim;  state: Exp;  lines: +4 -4
branches:  1.2.4;
Integration of multithreaded system
----------------------------
revision 1.1
date: 2000/04/05 17:39:41;  author: cbaoqiu;  state: Exp;
branches:  1.1.2;  1.1.10;
Added new files random_xsb.c and random_xsb.h.
----------------------------
revision 1.1.10.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +4 -4
Sources from rfm repository
----------------------------
revision 1.1.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/realloc.h,v
Working file: realloc.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.5
	release_3_0: 1.5
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.2.10.1
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2.8.1
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.2
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
	subsumption: 1.1
	without-attv: 1.1
	release-2-0: 1.1
	pre-release-2-0: 1.1
	v1-9-8: 1.1
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
New files added by Kostis for GC & CHAT
----------------------------
revision 1.9
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2005/10/27 21:20:07;  author: tswift;  state: Exp;  lines: +4 -0
branches:  1.5.4;

Bug fix to take account of attributed variables when reallocating global/local stacks.
----------------------------
revision 1.4
date: 2004/01/14 20:27:13;  author: dwarren;  state: Exp;  lines: +2 -2
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.3
date: 2003/07/16 15:04:49;  author: lfcastro;  state: Exp;  lines: +11 -0
* Make stack reallocation aware of attributed variables and interrupt
  handlers.
----------------------------
revision 1.2
date: 2000/04/29 21:53:57;  author: kifer;  state: Exp;  lines: +13 -12
branches:  1.2.8;  1.2.10;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.1
date: 1998/12/21 01:08:40;  author: cbaoqiu;  state: Exp;
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2.10.1
date: 2004/10/18 20:46:08;  author: ruim;  state: Exp;  lines: +11 -0
update for version 2.6.1
----------------------------
revision 1.2.8.1
date: 2003/08/27 16:07:18;  author: lfcastro;  state: Exp;  lines: +11 -0
* Several bugfixes ported from HEAD, including:

- Fix number_codes to deal with boxed integers. Necessary for using
  java1.4.2.

- newer gpp. The main change is that #include can take a macro as an
  argument

- Generalized transformation of P/A to Skel to comma-lists of P/A's in
  index, dynamic, table declarations.  (I.e., fixed a bug.)

- Added a file-copy builtin

- Fix message/2 when 1st argument is a list --- it was printing on
  STDMSG instead of using the given file handle.
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/register.h,v
Working file: register.h
head: 1.20
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.20
	ROLLBACK: 1.14
	latest_plus_supp_branch: 1.10.0.4
	latest_plus_supp: 1.10
	Version_3dot2_plus_supp: 1.10.0.2
	release_2_6_plus_supp: 1.7.0.4
	Version_3dot2: 1.10
	dec07-perf-results: 1.9
	mt_thesis: 1.9
	release_3_0: 1.9
	release_2_7_0: 1.7
	multi-threaded-26-engine: 1.4.4.2
	pre-mt: 1.7
	multi-threaded-25-engine-done: 1.4.4.1
	multi-threaded-25-engine: 1.4.0.4
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.2
	last-merged-to-demand: 1.7
	demand_branch: 1.6.0.2
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.2
	release_2_4: 1.4
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.4
	pre-threading: 1.3
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.3
	release-2-0-1: 1.3
	subsumption: 1.3
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 31;	selected revisions: 31
description:
----------------------------
revision 1.20
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -2
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.19
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.18
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +2 -1
no message
----------------------------
revision 1.14
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.13
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.12
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -1
Backed out code
----------------------------
revision 1.11
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +2 -1
Dipti's code for support graph added
----------------------------
revision 1.10
date: 2008/09/26 20:32:01;  author: tswift;  state: Exp;  lines: +3 -1
branches:  1.10.4;

`Fixes the test pps while not breaking the tests dipti or wine.
The change is a 1-liner.  Other changes are for documentation and
(commented out) debugging.

----------------------------------------------------------------------

Keeping some log notes of the change in the CVS log -- this has proven
useful in understanding the history of minor tabling changes.

I've just spent a while analyzing the pps program to find out why a
cut-over choice point is improperly backtracked into.  Recall that
when I fixed this bug 3 years ago, I broke an example of Dipti's
(which is now in the test suite) along with the wine example.  Taking
out that change apparently fixes both examples.

A complex combination of events give rise to backtracking over a cut
choice point in local evaluation.  First, early completion must be
applied to a subgoal S that is not the leader in an SCC.  Next, the
generator/consumer choice point of S must never have been scheduled
for answer return.  And finally, the generator/consumer choice point
of S must be preceded by a cut-over choice point.

I realize that this is obscure, and I don't yet understand how to
explain it more cogently.  However, I do include 1) a pps program,
slightly modified with debugging info; 2) the debugging output; and 3)
a detailed explanation of what is going on.  I'm not sure whether
these details will be of help to anyone other than me.

Of course the real question is what to do.  My previous "fix" was to
ensure that non-leader GCPs pointed to the leader GCP in local
evaluation when the non-leader GCP was backtracked over and turned
into a CCP.  Exactly why this was causing a problem in the wine and
Dipti examples, I dont know, but I could see that it could be a
problem if there were a chain of non-leader GCPs linked by their
previous CP values.  So anyway, that fix wont work.

Thus, we want the previous CP of non-leader GCPs ot point to the
leader GCP after they have been turned into consumers (as long as they
are not part of a scheduling chain).  Making this adjustment when the
non-leader GCP is turned into a CCP is wrong, as we've seen.  However,
I do believe that making the adjustment at a different time is safe.
Accordingly I made a 1-line change to adjust the previous choice point
of non-leader GCPs to the leader GCP during *fixed-point check
performed by the leader*.

By the way, I really appreciate the work that Michael did to pare down
the bug example to the small pps program.  If it had been much more
complex, I doubt that I could have understood what was going on.

Terry


Its possible that rather than adjusting the non-leader GCPs to have
the leader GCP as their previous choice point when they are turned
into CCPs (which is wrong) this could be done at some other time.

One possibility is to make the adjustment at fixpoint check, as the
CCP (nee GCP) needs to be traversed to check if it has unreturned
answers anyway.

I'll think about doing making that change to the fixed point
computation.  However, at least for now I think the engine is
functioning properly for definite datalog programs without cuts -- at
least in terms of answer scheduling.

------------------------------------------------------------------------------------
% % % pps.P % % %

/* print_cp is more understandable when CP_DEBUG is defined */

:- import print_cp/0 from machine.

:- table w2/2, w3/3.

db(wrapper(app,_)).
db(wrapper(pps,_)).
db(wrapper(p,_)).

test:- w2(pps,foobar).
test1:- w2(pps,_foobar).

%% wrapper/2
w2(pps,_A) :-
%	print_cp,
	writeln(clause1w2(pps,_A)),
        w2(app,foobar),
        fail.
w2(app,_A) :-
	writeln(clause2w2(app,_A)),
	w3(p,_,foobar).
w2(X,Y) :-
	writeln(clause3(w2(X,Y))),
        db(wrapper(X,Y)),
        nl,
	print_cp,
        writeln('About to cut'),
        !,
	print_cp,
        fail.
%% Shouldn't go here after the cut!!!
w2(X,Y) :-
	writeln(clause4(w2(X,Y))),
        writeln('******fell through the cut!!! ' - X).

%% wrapper/3
w3(p,0,X):-
	writeln(clause1(w3(p,-,X))).
w3(p,_A,_B) :-
	writeln(clause2(w3(p,_A,_B))),
        w3(p,_,foobar),
	writeln(calling(w2(pps,foobar))),
        w2(pps,foobar).

------------------------------------------------------------------------------------
% % % Output % % %

| ?- test.
clause1w2(pps,foobar)
clause2w2(app,foobar)
clause1(w3(p,-,foobar))
clause2(w3(p,_h131,foobar))
calling(w2(pps,foobar))
clause3(w2(app,foobar))

About to cut
clause3(w2(pps,foobar))

About to cut
leader scheduling answers                            % printout from engine
performing early completion for: w2(app, foobar)(breg: 5c4c8c pcpf 5c4d18) % printout from engine
clause4(w2(pps,foobar))
******fell through the cut!!!  - pps
performing early completion for: w2(pps, foobar)(breg: 5c4da0 pcpf 5c4da0) % printout from engine
leader scheduling answers % printout from engine
calling(w2(pps,foobar))
leader scheduling answers % printout from engine


------------------------------------------------------------------------------------
% % % The prodigal choice point % % %

Step 1: Generator Choice Point created for w2(pps,foobar) (Failure
continuation set to check_complete)

Step 2: Regular choice point created for _$w2(pps,foobar), (_$w2/2 was
created to handle cut in a clause body of w2/2).

Step 3: GCP created for w2(app,foobar)

Step 4: Regular choice point created for _$w2(app,foobar)

Step 5: GCP created for w3(p,_,foobar)

Step 6: Answer created for w3(p,_,foobar), and Consumer Choice Point
created for w3(p,_,foobar)

Step 7: Answer w3(p,0,foobar) created in step 6 returned to CCP
created in step 6 (while evaluating the second clause of w3/3).
CCP created for w2(pps,foobar).

Step 8: At this point all subgoals are in the same Approximate SCC.
Also, each CP has as its previous CP the CP created in the immediately
preceding step.  The only anwser produced has been consumed, so the
engine backtracks to the CCP of step 7; fails; backtracks to the CCP
created in step 6; fails; backtracks to the GCP created in step 6 and
turns the GCP created in step 5 into a CCP.  (This happens in local
evaluations when backtracking over a GCP for a subgoal that is not a
SCC leader).  Finally, backtracking reaches the CP created in Step 4,
and executes the third clause of _$w2(app,foobar)

Step 9: Forward execution creates a choice point for db/1 whose
previous choice point is the CP of Step 4.  Note that there are two
CPs whose previous CP is that of Step 4: this new one and the one from
step 5.

Step 10: the cut is executed, the CP of step 9 removed, and breg set
to the GCP for Step 3.  Upon failure (immediately after the cut)
backtracking sets the GCP of Step 3 to a CCP, and fails.  Backtracking
follows the previous CP for the Step 3 CCP to the step 2 CP.

Step 11: Similarly to step 9, forward execution executes clause 3 for
_$w2(pps,foobar) (a minor difference is that no CP for db/1 is created
for the goal db(wrpper(app,foobar)) ).  (breg still points to Step 2's
CP)

Step 12: The cut is executed, resetting breg back to the original GCP
of Step 1, which is the leader.  Recall that the failure continuation
for the step 1 GCP is a check_complete, so the leader schedules answer
return for all CCPs in the SCC.  Actually, there is one scheduled.
The answer w3(p,0,foobar) is returned to the CCP (nee GCP) of step 5,
returning the answer to the second clause of _$w2(app,foobar).

Step 13 (the unlucky step): The return of the answer immediately
causes a new answer w2(app,foobar) to be derived for the goal
w2(app,foobar).  Since an answer is returned for a ground goal, early
completion applies and the goal w2(app,foobar) is early completed.

>>!! A heuristic for early completion is to set the breg to the
original GCP for the goal !!<<

and the breg is set to point to the GCP (now a CCP) of w2(app,foobar)
created in step 3.

Step 14.  Note that due to early completion, the breg now points to
the CCP of step 3 which was never scheduled by the leader.  If it had
been scheduled, its previous CP would be the (step 1) leader.
However, as it was never rescheduled, its previous CP is its original
one: that of step 2.

Step 15. The addition of the new answer from step 13 causes an
immediate failure due to local scheduling.  The engine now backtracks
into the (ostensably cut) choicepoint of step 2, which improperly
executes the fourth clause for _$w2(pps,foobar).
----------------------------
revision 1.9
date: 2005/07/07 16:55:52;  author: dwarren;  state: Exp;  lines: +8 -1
Fixed fmt_read/write for multithreading.  Minor change to write_canonical (still NOT
thread-safe).
Added several (extensible) string buffers to context, since many builtins use
global string buffers.  Idea is to change those places to use these buffers.
They are implemented as varstring's.
----------------------------
revision 1.8
date: 2005/01/14 18:31:28;  author: ruim;  state: Exp;  lines: +5 -1
Integration of multithreaded system
----------------------------
revision 1.7
date: 2002/08/07 15:42:13;  author: lfcastro;  state: Exp;  lines: +5 -1
* do not use is_* functions (from the C interface) inside the
  emulator.
----------------------------
revision 1.6
date: 2002/03/13 22:40:13;  author: lfcastro;  state: Exp;  lines: +10 -1
branches:  1.6.2;
* first step in implementing demand
- new (experimental) primitive: demand_once/1
- executes query and, after first answer is returned, deletes all
consumers created during execution; further, any tables created are
also destroyed
----------------------------
revision 1.5
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -3
* Removal of Chat engine
----------------------------
revision 1.4
date: 2001/05/24 17:54:52;  author: lfcastro;  state: Exp;  lines: +5 -1
branches:  1.4.4;
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.3
date: 1999/10/09 02:00:27;  author: cbaoqiu;  state: Exp;  lines: +2 -1
branches:  1.3.2;  1.3.4;
Changes for attributed variables (first step).
----------------------------
revision 1.2
date: 1998/12/21 01:08:42;  author: cbaoqiu;  state: Exp;  lines: +3 -1
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.3.4.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.4.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +9 -2
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.2.1
date: 2000/03/28 18:10:32;  author: lfcastro;  state: Exp;  lines: +2 -7
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.4.4.2
date: 2004/10/18 20:46:08;  author: ruim;  state: Exp;  lines: +14 -3
update for version 2.6.1
----------------------------
revision 1.4.4.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +5 -1
Sources from rfm repository
----------------------------
revision 1.6.2.2
date: 2003/04/17 17:11:40;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.6.2.1
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +5 -1
* update to HEAD
----------------------------
revision 1.10.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.10.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +1 -0
no message
----------------------------
revision 1.10.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/remove_unf.c,v
Working file: remove_unf.c
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.2
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.2.0.6
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.1.4.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.4
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.4
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.2
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.9
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +1 -1
branches:  1.5.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.4
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +1 -0
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.3
date: 2005/03/18 16:05:10;  author: dwarren;  state: Exp;  lines: +1 -1
Changed conditional compile flag from debug to debug_verbose, to define
a necessary function.  Chris R. uncovered this when compiling for debug under windows.
----------------------------
revision 1.2
date: 2002/05/20 17:47:10;  author: tswift;  state: Exp;  lines: +46 -0

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.1
date: 2001/10/05 19:26:49;  author: tswift;  state: Exp;
branches:  1.1.4;

Added stubs for "answer completion: i.e. remove_unfounded_set
----------------------------
revision 1.1.4.1
date: 2004/10/18 20:46:08;  author: ruim;  state: Exp;  lines: +46 -0
update for version 2.6.1
----------------------------
revision 1.5.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.5.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/remove_unf.h,v
Working file: remove_unf.h
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.5
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.14
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.12
	release_2_6_plus_supp: 1.1.0.10
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.8
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.6
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.4
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.5
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 2001/10/05 19:26:49;  author: tswift;  state: Exp;
branches:  1.1.14;

Added stubs for "answer completion: i.e. remove_unfounded_set
----------------------------
revision 1.1.14.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.14.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1.14.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/residual.c,v
Working file: residual.c
head: 1.33
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.31
	ROLLBACK: 1.25
	latest_plus_supp_branch: 1.25.0.2
	latest_plus_supp: 1.25
	Version_3dot2_plus_supp: 1.24.0.2
	release_2_6_plus_supp: 1.20.0.6
	Version_3dot2: 1.24
	dec07-perf-results: 1.23
	mt_thesis: 1.22
	release_3_0: 1.22
	release_2_7_0: 1.20
	multi-threaded-26-engine: 1.18.2.2
	pre-mt: 1.20
	multi-threaded-25-engine-done: 1.18.2.1
	multi-threaded-25-engine: 1.18.0.2
	release_2_6_1: 1.20
	release_2_6_final: 1.20
	release_2_6: 1.20.0.4
	last-merged-to-demand: 1.20
	demand_branch: 1.20.0.2
	before_removing_chat: 1.18
	release_2_5: 1.18
	pre-merge-slgwam-gc: 1.17
	multi-threaded-c-engine: 1.17.0.4
	release_2_4: 1.17
	release_2_3: 1.17
	multi-threaded-engine: 1.17.0.2
	pre-threading: 1.16
	release-2-2: 1.14
	chat-and-local: 1.14.0.2
	xsb-pre-cleanup: 1.14
	release-2-1: 1.13
	release-2-0-1: 1.13
	subsumption: 1.11
	without-attv: 1.9
	release-2-0: 1.5
	pre-release-2-0: 1.5
	v1-9-8: 1.5
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 41;	selected revisions: 41
description:
----------------------------
revision 1.33
date: 2012/07/25 22:53:42;  author: tswift;  state: Exp;  lines: +11 -3

Fixed bug in get_residual when there are a large number of variables in head and/or body.  Here's the comment.

        /* TLS: Need to set copy_of_var_addr back to addr.  Most of
           the time, they will be equal, as cova was set to va.
           However, var_addr might have been expanded during
           load_delay_trie().  If so, then the values will be
           different, and the deallocation of cova in the builtin
           build_delay_lists will abort */
----------------------------
revision 1.32
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +3 -3
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.31
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +2 -2
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.30
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.29
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.28
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.27
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.26
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +2 -2
no message
----------------------------
revision 1.25
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.25.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.24
date: 2008/03/10 16:21:50;  author: dwarren;  state: Exp;  lines: +4 -4
Fix bug in addintfastasgn instruction (to trail if binding to a variable.)
Also a cuple of comments to indicate where memory problems are wrt delay lists
(which may reduce search time the next time this bug shows up....)
----------------------------
revision 1.23
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.22
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +5 -6


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.21
date: 2005/01/14 18:31:28;  author: ruim;  state: Exp;  lines: +6 -6
Integration of multithreaded system
----------------------------
revision 1.20
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +18 -18
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.19
date: 2002/05/22 15:41:15;  author: lfcastro;  state: Exp;  lines: +14 -22
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.18
date: 2002/01/23 17:08:10;  author: dwarren;  state: Exp;  lines: +3 -1
branches:  1.18.2;
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.17
date: 2000/06/28 16:54:52;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.17.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.16
date: 2000/05/29 04:23:36;  author: ejohnson;  state: Exp;  lines: +3 -3
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.15
date: 2000/05/20 06:56:06;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.14
date: 2000/01/07 08:51:46;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.13
date: 1999/10/26 06:47:22;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.12
date: 1999/10/25 05:59:02;  author: kifer;  state: Exp;  lines: +7 -7
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.11
date: 1999/10/15 02:54:13;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Changed functions table_consume_answer() and load_solution_trie() to
take one more argument, attv_num (the number of attributed variables
in the substitution factor).
----------------------------
revision 1.10
date: 1999/10/12 20:22:56;  author: ejohnson;  state: Exp;  lines: +2 -2
Replaced renamed macro.
----------------------------
revision 1.9
date: 1999/10/05 04:01:51;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.8
date: 1999/09/18 04:39:43;  author: cbaoqiu;  state: Exp;  lines: +3 -1
Put some delay-variable stuff into ``#ifndef IGNORE_DELAYVAR'' (to
help Kostis debug).  By doing this, we make sure that no substitution
factor of the answer is put into the heap.  [To disable delay-variable
handling, one can put ``#define IGNORE_DELAYVAR'' in the file
$XSB/emu/debugs/debug_delay.h.]
----------------------------
revision 1.7
date: 1999/08/16 07:24:27;  author: kifer;  state: Exp;  lines: +159 -151
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.6
date: 1999/08/04 14:42:04;  author: ejohnson;  state: Exp;  lines: +5 -5
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.5
date: 1999/02/18 13:02:15;  author: kostis;  state: Exp;  lines: +2 -1
Changes to check for trail stack overflow in pushtrail0().
----------------------------
revision 1.4
date: 1999/01/31 14:02:24;  author: kostis;  state: Exp;  lines: +18 -1
Mostly cleanup changes to simplify "tries.h".  Lots of junk code has been
removed and things that are not needed in other files have been moved to
"tries.c".
----------------------------
revision 1.3
date: 1999/01/05 19:37:05;  author: cbaoqiu;  state: Exp;  lines: +11 -6
Remove field subs_fact from struct delay_element; it is only needed
when DEBUG_DELAYVAR is defined.
----------------------------
revision 1.2
date: 1998/12/09 03:14:37;  author: cbaoqiu;  state: Exp;  lines: +164 -78
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  Function build_delay_list() is rewritten to handle variables in
  delay list.
----------------------------
revision 1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:20;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.17.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.17.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +5 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.18.2.2
date: 2004/10/18 20:46:08;  author: ruim;  state: Exp;  lines: +20 -28
update for version 2.6.1
----------------------------
revision 1.18.2.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +6 -6
Sources from rfm repository
----------------------------
revision 1.25.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.25.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.25.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/residual.h,v
Working file: residual.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.2.0.14
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.12.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.12.1
	multi-threaded-25-engine: 1.2.0.12
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.10
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.8
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.6
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.2
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.2
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2005/01/14 18:31:28;  author: ruim;  state: Exp;  lines: +2 -2
branches:  1.3.4;
Integration of multithreaded system
----------------------------
revision 1.2
date: 1998/12/09 03:15:47;  author: cbaoqiu;  state: Exp;  lines: +2 -2
branches:  1.2.4;  1.2.12;
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  Prototype of build_delay_list() is changed.
----------------------------
revision 1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.2.12.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +2 -2
Sources from rfm repository
----------------------------
revision 1.2.4.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.4.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/rw_lock.c,v
Working file: rw_lock.c
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	multi-threaded-26-engine: 1.1.2.1
	multi-threaded-25-engine-done: 1.1.2.1
	multi-threaded-25-engine: 1.1.0.2
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.9
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2005/12/07 13:23:02;  author: ruim;  state: Exp;  lines: +2 -2
branches:  1.4.4;
removed rw lock from tries in Multi-threaded engine
----------------------------
revision 1.3
date: 2005/02/11 13:14:29;  author: vidrevich;  state: Exp;  lines: +1 -2
changes to compile in Windows multi-threaded mode
----------------------------
revision 1.2
date: 2005/01/14 18:31:28;  author: ruim;  state: Exp;  lines: +86 -0
Integration of multithreaded system
----------------------------
revision 1.1
date: 2004/09/29 20:05:06;  author: ruim;  state: dead;
branches:  1.1.2;
file rw_lock.c was initially added on branch multi-threaded-25-engine.
----------------------------
revision 1.1.2.1
date: 2004/09/29 20:05:06;  author: ruim;  state: Exp;  lines: +86 -0
Sources imported from rfm
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/rw_lock.h,v
Working file: rw_lock.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.2.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.2.1
	multi-threaded-25-engine: 1.1.0.2
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.9
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2005/12/07 13:23:02;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.4.4;
removed rw lock from tries in Multi-threaded engine
----------------------------
revision 1.3
date: 2005/02/11 13:14:29;  author: vidrevich;  state: Exp;  lines: +7 -1
changes to compile in Windows multi-threaded mode
----------------------------
revision 1.2
date: 2005/01/14 18:31:28;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.1
date: 2004/08/29 22:52:16;  author: tswift;  state: Exp;
branches:  1.1.2;
Forgot another one.
----------------------------
revision 1.1.2.1
date: 2004/09/29 20:05:19;  author: ruim;  state: Exp;  lines: +0 -0
Sources imported from rfm
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/scc.c,v
Working file: scc.c
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.3
date: 1999/10/25 05:59:04;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/09/20 09:06:02;  author: kostis;  state: Exp;  lines: +4 -1
Changes to fix problem that caused the flora1 bug.  Changes affect both
SLG-WAM and CHAT emulators.
----------------------------
revision 1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/scc.h,v
Working file: scc.h
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.3
date: 1999/10/25 05:59:05;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/09/20 09:06:02;  author: kostis;  state: Exp;  lines: +3 -1
Changes to fix problem that caused the flora1 bug.  Changes affect both
SLG-WAM and CHAT emulators.
----------------------------
revision 1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/scc_xsb.c,v
Working file: scc_xsb.c
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.14
	ROLLBACK: 1.9
	latest_plus_supp_branch: 1.9.0.2
	latest_plus_supp: 1.9
	Version_3dot2_plus_supp: 1.8.0.2
	release_2_6_plus_supp: 1.6.0.8
	Version_3dot2: 1.8
	dec07-perf-results: 1.8
	mt_thesis: 1.7
	release_3_0: 1.7
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.6.6.1
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.6.6.1
	multi-threaded-25-engine: 1.6.0.6
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.4
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.6
	release_2_5: 1.6
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.4
	release_2_4: 1.5
	release_2_3: 1.5
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.4
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 21;	selected revisions: 21
description:
----------------------------
revision 1.14
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.13
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.12
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.9.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.8
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.7
date: 2005/01/14 18:31:28;  author: ruim;  state: Exp;  lines: +4 -2
Integration of multithreaded system
----------------------------
revision 1.6
date: 2002/02/05 21:34:43;  author: tswift;  state: Exp;  lines: +33 -1
branches:  1.6.6;
Added lots of documentation to these files.
----------------------------
revision 1.5
date: 2000/06/28 16:54:52;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.5.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.4
date: 2000/05/20 06:56:06;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.3
date: 2000/01/07 08:51:47;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.3.2;
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.2
date: 1999/10/26 06:47:23;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:59:07;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.2.1
date: 2000/03/28 18:10:32;  author: lfcastro;  state: Exp;  lines: +1 -45
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +5 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.6.6.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +4 -2
Sources from rfm repository
----------------------------
revision 1.9.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.9.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.9.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/scc_xsb.h,v
Working file: scc_xsb.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.12.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.12.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2005/01/14 18:31:28;  author: ruim;  state: Exp;  lines: +2 -2
branches:  1.2.4;
Integration of multithreaded system
----------------------------
revision 1.1
date: 1999/10/25 05:59:07;  author: kifer;  state: Exp;
branches:  1.1.2;  1.1.4;  1.1.12;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.12.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +2 -2
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.1.2.1
date: 2000/03/28 18:10:32;  author: lfcastro;  state: Exp;  lines: +1 -5
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/schedrev.i,v
Working file: schedrev.i
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.6
	without-attv: 1.4
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.7
date: 1999/10/25 05:59:08;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.6
date: 1999/10/12 20:13:15;  author: ejohnson;  state: Exp;  lines: +66 -49
Modified section which checks whether there are answer(s) to return to
a suspended subgoal.  If the subgoal is properly subsumed, then
answers may need to be retrieved from the producer for consumption.

Some cleanup.
----------------------------
revision 1.5
date: 1999/10/09 18:37:54;  author: kostis;  state: Exp;  lines: +4 -4
Cleanup changes so that variables are declared and appear only in places
where they are actually needed.  Expect speed-up by doing so.
Also, finally, ugly xtemp[3-15] variables were eliminated.
Sorry, Terry !
----------------------------
revision 1.4
date: 1999/08/16 07:24:28;  author: kifer;  state: Exp;  lines: +9 -9
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.3
date: 1999/07/15 21:41:15;  author: ejohnson;  state: Exp;  lines: +2 -2
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.2
date: 1999/04/22 06:49:18;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/schedrev_xsb_i.h,v
Working file: schedrev_xsb_i.h
head: 1.30
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.29
	ROLLBACK: 1.24
	latest_plus_supp_branch: 1.24.0.2
	latest_plus_supp: 1.24
	Version_3dot2_plus_supp: 1.22.0.2
	release_2_6_plus_supp: 1.12.0.6
	Version_3dot2: 1.22
	dec07-perf-results: 1.21
	mt_thesis: 1.21
	release_3_0: 1.18
	release_2_7_0: 1.12
	multi-threaded-26-engine: 1.9.2.2
	pre-mt: 1.12
	multi-threaded-25-engine-done: 1.9.2.1
	multi-threaded-25-engine: 1.9.0.2
	release_2_6_1: 1.12
	release_2_6_final: 1.12
	release_2_6: 1.12.0.4
	last-merged-to-demand: 1.12
	demand_branch: 1.12.0.2
	before_removing_chat: 1.9
	release_2_5: 1.9
	pre-merge-slgwam-gc: 1.8
	multi-threaded-c-engine: 1.8.0.2
	release_2_4: 1.8
	release_2_3: 1.6
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.4
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 43;	selected revisions: 43
description:
----------------------------
revision 1.30
date: 2012/01/04 23:19:35;  author: tswift;  state: Exp;  lines: +56 -8

Schedrev -- slight re-integration of EC_OPT1
debug_xsb.c -- quiet the linux compiler.
----------------------------
revision 1.29
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.28
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.27
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.26
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.25
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/03/26 22:06:48;  author: tswift;  state: Exp;  lines: +5 -2
branches:  1.24.2;

(Temporary) fix for the wierd bug that shows up with Flora defeasibility.a
----------------------------
revision 1.23
date: 2010/01/23 19:03:03;  author: tswift;  state: Exp;  lines: +3 -3

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.22
date: 2008/09/26 20:32:01;  author: tswift;  state: Exp;  lines: +19 -8

`Fixes the test pps while not breaking the tests dipti or wine.
The change is a 1-liner.  Other changes are for documentation and
(commented out) debugging.

----------------------------------------------------------------------

Keeping some log notes of the change in the CVS log -- this has proven
useful in understanding the history of minor tabling changes.

I've just spent a while analyzing the pps program to find out why a
cut-over choice point is improperly backtracked into.  Recall that
when I fixed this bug 3 years ago, I broke an example of Dipti's
(which is now in the test suite) along with the wine example.  Taking
out that change apparently fixes both examples.

A complex combination of events give rise to backtracking over a cut
choice point in local evaluation.  First, early completion must be
applied to a subgoal S that is not the leader in an SCC.  Next, the
generator/consumer choice point of S must never have been scheduled
for answer return.  And finally, the generator/consumer choice point
of S must be preceded by a cut-over choice point.

I realize that this is obscure, and I don't yet understand how to
explain it more cogently.  However, I do include 1) a pps program,
slightly modified with debugging info; 2) the debugging output; and 3)
a detailed explanation of what is going on.  I'm not sure whether
these details will be of help to anyone other than me.

Of course the real question is what to do.  My previous "fix" was to
ensure that non-leader GCPs pointed to the leader GCP in local
evaluation when the non-leader GCP was backtracked over and turned
into a CCP.  Exactly why this was causing a problem in the wine and
Dipti examples, I dont know, but I could see that it could be a
problem if there were a chain of non-leader GCPs linked by their
previous CP values.  So anyway, that fix wont work.

Thus, we want the previous CP of non-leader GCPs ot point to the
leader GCP after they have been turned into consumers (as long as they
are not part of a scheduling chain).  Making this adjustment when the
non-leader GCP is turned into a CCP is wrong, as we've seen.  However,
I do believe that making the adjustment at a different time is safe.
Accordingly I made a 1-line change to adjust the previous choice point
of non-leader GCPs to the leader GCP during *fixed-point check
performed by the leader*.

By the way, I really appreciate the work that Michael did to pare down
the bug example to the small pps program.  If it had been much more
complex, I doubt that I could have understood what was going on.

Terry


Its possible that rather than adjusting the non-leader GCPs to have
the leader GCP as their previous choice point when they are turned
into CCPs (which is wrong) this could be done at some other time.

One possibility is to make the adjustment at fixpoint check, as the
CCP (nee GCP) needs to be traversed to check if it has unreturned
answers anyway.

I'll think about doing making that change to the fixed point
computation.  However, at least for now I think the engine is
functioning properly for definite datalog programs without cuts -- at
least in terms of answer scheduling.

------------------------------------------------------------------------------------
% % % pps.P % % %

/* print_cp is more understandable when CP_DEBUG is defined */

:- import print_cp/0 from machine.

:- table w2/2, w3/3.

db(wrapper(app,_)).
db(wrapper(pps,_)).
db(wrapper(p,_)).

test:- w2(pps,foobar).
test1:- w2(pps,_foobar).

%% wrapper/2
w2(pps,_A) :-
%	print_cp,
	writeln(clause1w2(pps,_A)),
        w2(app,foobar),
        fail.
w2(app,_A) :-
	writeln(clause2w2(app,_A)),
	w3(p,_,foobar).
w2(X,Y) :-
	writeln(clause3(w2(X,Y))),
        db(wrapper(X,Y)),
        nl,
	print_cp,
        writeln('About to cut'),
        !,
	print_cp,
        fail.
%% Shouldn't go here after the cut!!!
w2(X,Y) :-
	writeln(clause4(w2(X,Y))),
        writeln('******fell through the cut!!! ' - X).

%% wrapper/3
w3(p,0,X):-
	writeln(clause1(w3(p,-,X))).
w3(p,_A,_B) :-
	writeln(clause2(w3(p,_A,_B))),
        w3(p,_,foobar),
	writeln(calling(w2(pps,foobar))),
        w2(pps,foobar).

------------------------------------------------------------------------------------
% % % Output % % %

| ?- test.
clause1w2(pps,foobar)
clause2w2(app,foobar)
clause1(w3(p,-,foobar))
clause2(w3(p,_h131,foobar))
calling(w2(pps,foobar))
clause3(w2(app,foobar))

About to cut
clause3(w2(pps,foobar))

About to cut
leader scheduling answers                            % printout from engine
performing early completion for: w2(app, foobar)(breg: 5c4c8c pcpf 5c4d18) % printout from engine
clause4(w2(pps,foobar))
******fell through the cut!!!  - pps
performing early completion for: w2(pps, foobar)(breg: 5c4da0 pcpf 5c4da0) % printout from engine
leader scheduling answers % printout from engine
calling(w2(pps,foobar))
leader scheduling answers % printout from engine


------------------------------------------------------------------------------------
% % % The prodigal choice point % % %

Step 1: Generator Choice Point created for w2(pps,foobar) (Failure
continuation set to check_complete)

Step 2: Regular choice point created for _$w2(pps,foobar), (_$w2/2 was
created to handle cut in a clause body of w2/2).

Step 3: GCP created for w2(app,foobar)

Step 4: Regular choice point created for _$w2(app,foobar)

Step 5: GCP created for w3(p,_,foobar)

Step 6: Answer created for w3(p,_,foobar), and Consumer Choice Point
created for w3(p,_,foobar)

Step 7: Answer w3(p,0,foobar) created in step 6 returned to CCP
created in step 6 (while evaluating the second clause of w3/3).
CCP created for w2(pps,foobar).

Step 8: At this point all subgoals are in the same Approximate SCC.
Also, each CP has as its previous CP the CP created in the immediately
preceding step.  The only anwser produced has been consumed, so the
engine backtracks to the CCP of step 7; fails; backtracks to the CCP
created in step 6; fails; backtracks to the GCP created in step 6 and
turns the GCP created in step 5 into a CCP.  (This happens in local
evaluations when backtracking over a GCP for a subgoal that is not a
SCC leader).  Finally, backtracking reaches the CP created in Step 4,
and executes the third clause of _$w2(app,foobar)

Step 9: Forward execution creates a choice point for db/1 whose
previous choice point is the CP of Step 4.  Note that there are two
CPs whose previous CP is that of Step 4: this new one and the one from
step 5.

Step 10: the cut is executed, the CP of step 9 removed, and breg set
to the GCP for Step 3.  Upon failure (immediately after the cut)
backtracking sets the GCP of Step 3 to a CCP, and fails.  Backtracking
follows the previous CP for the Step 3 CCP to the step 2 CP.

Step 11: Similarly to step 9, forward execution executes clause 3 for
_$w2(pps,foobar) (a minor difference is that no CP for db/1 is created
for the goal db(wrpper(app,foobar)) ).  (breg still points to Step 2's
CP)

Step 12: The cut is executed, resetting breg back to the original GCP
of Step 1, which is the leader.  Recall that the failure continuation
for the step 1 GCP is a check_complete, so the leader schedules answer
return for all CCPs in the SCC.  Actually, there is one scheduled.
The answer w3(p,0,foobar) is returned to the CCP (nee GCP) of step 5,
returning the answer to the second clause of _$w2(app,foobar).

Step 13 (the unlucky step): The return of the answer immediately
causes a new answer w2(app,foobar) to be derived for the goal
w2(app,foobar).  Since an answer is returned for a ground goal, early
completion applies and the goal w2(app,foobar) is early completed.

>>!! A heuristic for early completion is to set the breg to the
original GCP for the goal !!<<

and the breg is set to point to the GCP (now a CCP) of w2(app,foobar)
created in step 3.

Step 14.  Note that due to early completion, the breg now points to
the CCP of step 3 which was never scheduled by the leader.  If it had
been scheduled, its previous CP would be the (step 1) leader.
However, as it was never rescheduled, its previous CP is its original
one: that of step 2.

Step 15. The addition of the new answer from step 13 causes an
immediate failure due to local scheduling.  The engine now backtracks
into the (ostensably cut) choicepoint of step 2, which improperly
executes the fourth clause for _$w2(pps,foobar).
----------------------------
revision 1.21
date: 2006/12/03 17:09:28;  author: ruim;  state: Exp;  lines: +1 -3
Bug fix for concurrent completion:
  added a lock to protect insertion of consumers on subgoal asf list
----------------------------
revision 1.20
date: 2006/11/20 16:53:42;  author: ruim;  state: Exp;  lines: +2 -2
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.19
date: 2006/11/05 23:53:15;  author: ruim;  state: Exp;  lines: +3 -1
Several changes & fixes for Concurrent Completion:
- Locking of the answer return list and consumer list at subgoal frame level
- No longer a dummy generator choice point is created for every external
  consumer
- Threads which don't have a stale view of the round are no longer awaken at
  completion
- The answer return list is not reclaim for shared tables
----------------------------
revision 1.18
date: 2006/05/22 20:47:45;  author: tswift;  state: Exp;  lines: +3 -2

Prolog code for unify_with_occur_check

In addition, fixed bug in batched evaluation that I believe is of long standing.

In the batched fixed point, a subgoal S may be checked for fixed
point even if it has been completed and its answer return lists
have been reclaimed.  This doesn't usually happen but can if S is
the leader of the ASCC.  In such a case, the fixed point check
traverses each consumer choice point for S and determines whether
all answers have been returned to the choice point.  However, if
the answer return list for S has been reclaimed and its space
reused, the fixpoint check may mistakenly think that an answer
has not been returned to the choice point -- a dangerous situation.

The fix is simple -- a check for reclamation of the subgoal.  The
check will also be made for local evaluation, even though it
won't be needed there.
----------------------------
revision 1.17
date: 2005/11/10 23:05:55;  author: tswift;  state: Exp;  lines: +27 -13

Removed some stray printfs.
----------------------------
revision 1.16
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;  lines: +15 -7
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.15
date: 2005/09/05 08:21:32;  author: ruim;  state: Exp;  lines: +16 -19
rationalized find_fixpoint
----------------------------
revision 1.14
date: 2005/08/28 16:42:28;  author: ruim;  state: Exp;  lines: +12 -1
phase 1 of implementation of concurrent completion
----------------------------
revision 1.13
date: 2005/01/14 18:31:29;  author: ruim;  state: Exp;  lines: +7 -5
Integration of multithreaded system
----------------------------
revision 1.12
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +7 -7
branches:  1.12.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.11
date: 2002/05/22 15:41:15;  author: lfcastro;  state: Exp;  lines: +4 -9
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.10
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -11
* Removal of Chat engine
----------------------------
revision 1.9
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +14 -27
branches:  1.9.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.8
date: 2001/04/04 19:58:02;  author: tswift;  state: Exp;  lines: +4 -6

Remembered to take out some out-of-date documentation
----------------------------
revision 1.7
date: 2001/04/04 19:54:00;  author: tswift;  state: Exp;  lines: +4 -2

Added a little documentation.
----------------------------
revision 1.6
date: 2001/01/31 10:23:29;  author: ejohnson;  state: Exp;  lines: +15 -12
Created the macro "table_pending_answer" to hide the details of
obtaining the next answer for consumption, which, in the case of a
properly subsumed subgoal, may require an answer identification step.

Second, removed -- again -- (most) "xtemp1" references.
(Argh!  How does this crap keep creeping back into the system?!?)

These were sprinkled over several files and removed by simply creating
a variable local to each macro in which a temp was needed.

The "need" for this change was precipitated due to the inclusion of an
"xtemp1" declaration within one of the code blocks which
table_pending_answer replaced.
----------------------------
revision 1.5
date: 2000/06/27 17:59:16;  author: ejohnson;  state: Exp;  lines: +4 -3
branches:  1.5.2;
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.4
date: 2000/05/29 04:23:36;  author: ejohnson;  state: Exp;  lines: +37 -28
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.3
date: 2000/05/25 00:32:01;  author: ejohnson;  state: Exp;  lines: +9 -9
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.2
date: 2000/04/29 21:53:57;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.1
date: 1999/10/25 05:59:10;  author: kifer;  state: Exp;
branches:  1.1.2;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.2.1
date: 2000/03/28 18:10:32;  author: lfcastro;  state: Exp;  lines: +2 -3
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.9.2.2
date: 2004/10/18 20:46:09;  author: ruim;  state: Exp;  lines: +7 -22
update for version 2.6.1
----------------------------
revision 1.9.2.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +7 -5
Sources from rfm repository
----------------------------
revision 1.12.2.5
date: 2002/08/29 14:17:13;  author: lfcastro;  state: Exp;  lines: +12 -12
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.12.2.4
date: 2002/08/10 00:19:35;  author: lfcastro;  state: Exp;  lines: +12 -12
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.12.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +9 -0
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.12.2.2
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +1 -8
* update to HEAD
----------------------------
revision 1.12.2.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +8 -1
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.24.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.24.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.24.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/self_orientation.c,v
Working file: self_orientation.c
head: 1.20
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.19
	without-attv: 1.19
	release-2-0: 1.14
	pre-release-2-0: 1.10
	v1-9-8: 1.8
	code-fixer-new: 1.6
	code-fixer: 1.6
	delayvar_ok: 1.6
	r1-9-b6: 1.6
keyword substitution: kv
total revisions: 20;	selected revisions: 20
description:
----------------------------
revision 1.20
date: 1999/10/25 05:59:11;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.19
date: 1999/08/09 00:29:26;  author: kifer;  state: Exp;  lines: +10 -5
Changes for windows installation
----------------------------
revision 1.18
date: 1999/07/26 22:51:53;  author: kifer;  state: Exp;  lines: +5 -5
fixed the .exe bug, moved .obj to saved.o
----------------------------
revision 1.17
date: 1999/07/22 21:58:22;  author: kifer;  state: Exp;  lines: +2 -2
Incorporated Joshua Engel's changes to get XSB work as a DLL.
In heap.c, got rid of compiler warnings.
----------------------------
revision 1.16
date: 1999/07/22 19:09:21;  author: kifer;  state: Exp;  lines: +3 -1
Got rid of compiler warnings.
----------------------------
revision 1.15
date: 1999/07/20 02:12:55;  author: kifer;  state: Exp;  lines: +6 -2
lowercase .exe when checking whether an executable.exe exists
----------------------------
revision 1.14
date: 1999/05/25 13:39:29;  author: luis;  state: Exp;  lines: +5 -1
C interface cleanup, 2nd phase
----------------------------
revision 1.13
date: 1999/05/24 16:01:11;  author: luis;  state: Exp;  lines: +6 -6
* C Interface cleanup
----------------------------
revision 1.12
date: 1999/05/10 13:26:49;  author: unova;  state: Exp;  lines: +2 -2
Changed S_IREAD to POSIX's S_IRUSR.
----------------------------
revision 1.11
date: 1999/05/03 00:55:49;  author: luis;  state: Exp;  lines: +8 -7
* changes regarding exporting functions under Windows
----------------------------
revision 1.10
date: 1999/04/19 15:41:16;  author: luis;  state: Exp;  lines: +14 -1
* added support for Cygwin-style pathnames under Windows
----------------------------
revision 1.9
date: 1999/03/02 01:00:57;  author: kifer;  state: Exp;  lines: +5 -3
(xsb_init_string): make sure that command line is first copied into a
new string. Otherwise, NT would bark.
----------------------------
revision 1.8
date: 1998/12/23 21:09:17;  author: kifer;  state: Exp;  lines: +6 -3
improved detection of symlinks; commented out readlink() for NT
----------------------------
revision 1.7
date: 1998/12/23 05:25:26;  author: kifer;  state: Exp;  lines: +11 -3
allowed symbolic links to bin/xsb and xsb executable. updated the
manual to reflect this
----------------------------
revision 1.6
date: 1998/11/24 17:28:43;  author: kifer;  state: Exp;  lines: +2 -2
Small changes related to the NT port.
----------------------------
revision 1.5
date: 1998/11/23 23:09:55;  author: kifer;  state: Exp;  lines: +13 -10
Changes related to the NT port.
----------------------------
revision 1.4
date: 1998/11/19 05:24:21;  author: kifer;  state: Exp;  lines: +5 -5
changed so that C program calling XSb would only pass the top xsb
directory instead of the executable directory
----------------------------
revision 1.3
date: 1998/11/18 21:07:00;  author: kifer;  state: Exp;  lines: +7 -2
(xsb_executable_full_path): Make sure .exe is added to the executable on NT.
----------------------------
revision 1.2
date: 1998/11/18 16:15:50;  author: kifer;  state: Exp;  lines: +7 -3
Changed to allow building C-callable XSB modules.
----------------------------
revision 1.1
date: 1998/11/18 07:59:16;  author: kifer;  state: Exp;
Moved initialization of executable, user_home, xsb_config_file to the
new file self_orientation. Added initialization like in xmain.c to
xsb_init in cinterf.c. This should fix the C-calling xsb interface.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/self_orientation.h,v
Working file: self_orientation.h
head: 1.4
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.3
	without-attv: 1.3
	release-2-0: 1.3
	pre-release-2-0: 1.1
	v1-9-8: 1.1
	code-fixer-new: 1.1
	code-fixer: 1.1
	delayvar_ok: 1.1
	r1-9-b6: 1.1
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.4
date: 1999/10/25 05:59:12;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3
date: 1999/05/24 16:01:20;  author: luis;  state: Exp;  lines: +7 -7
* C Interface cleanup
----------------------------
revision 1.2
date: 1999/05/03 00:55:51;  author: luis;  state: Exp;  lines: +8 -6
* changes regarding exporting functions under Windows
----------------------------
revision 1.1
date: 1998/11/19 05:24:22;  author: kifer;  state: Exp;
changed so that C program calling XSb would only pass the top xsb
directory instead of the executable directory
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/setjmp_xsb.h,v
Working file: setjmp_xsb.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.11
	ROLLBACK: 1.6
	latest_plus_supp_branch: 1.6.0.4
	latest_plus_supp: 1.6
	Version_3dot2_plus_supp: 1.6.0.2
	release_2_6_plus_supp: 1.4.0.14
	Version_3dot2: 1.6
	dec07-perf-results: 1.6
	mt_thesis: 1.6
	release_3_0: 1.6
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.4.12.1
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.4.12.1
	multi-threaded-25-engine: 1.4.0.12
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.10
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.8
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.6
	release_2_4: 1.4
	release_2_3: 1.4
	multi-threaded-engine: 1.4.0.4
	pre-threading: 1.4
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.2
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
----------------------------
revision 1.11
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.10
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.9
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2005/10/12 23:06:26;  author: tswift;  state: Exp;  lines: +3 -3
branches:  1.6.4;


Mostly added documentation.  Other changes

biassert.c -- commented out a debug that prevented -vrb option from
compiling.

Added a !defined(SOLARIS) to the inclusion of POSIX_C_SOURCE in
setjmp_xsb.h, and put the setjmp_xsb.h back into context.  I figured
its best to make the minimal change, rather than taking out the
inclusion of POSIX_C_SOURCE, which somehow would have broken something
down the line.

Terry
----------------------------
revision 1.5
date: 2005/01/14 18:31:29;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.4
date: 2000/01/07 06:17:14;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.4.4;  1.4.12;
Gensym changes, small typo fix in setjmp
----------------------------
revision 1.3
date: 2000/01/07 05:56:10;  author: kifer;  state: Exp;  lines: +13 -4
Put in Owen's changes to make slackware compile.
----------------------------
revision 1.2
date: 1999/11/17 04:36:12;  author: kifer;  state: Exp;  lines: +3 -1
Define _POSIX_C_SOURCE only if it isn't defined already
----------------------------
revision 1.1
date: 1999/11/17 03:54:33;  author: kifer;  state: Exp;
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.4.12.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.4.4.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.4.4.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.6.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.6.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/sig.h,v
Working file: sig.h
head: 1.4
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.3
	without-attv: 1.2
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 5;	selected revisions: 5
description:
----------------------------
revision 1.4
date: 1999/10/25 05:59:14;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3
date: 1999/10/09 02:00:27;  author: cbaoqiu;  state: Exp;  lines: +3 -1
Changes for attributed variables (first step).
----------------------------
revision 1.2
date: 1999/08/12 14:24:25;  author: kostis;  state: Exp;  lines: +6 -29
Changes to compile x_interp with the cpp-on option and integrate it better
with various defined constants in the emulator.
----------------------------
revision 1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/sig_xsb.h,v
Working file: sig_xsb.h
head: 1.12
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.10
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	release_2_6_plus_supp: 1.3.0.10
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.5
	release_3_0: 1.5
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.3.8.1
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.3.8.1
	multi-threaded-25-engine: 1.3.0.8
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.6
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.4
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.2
	release_2_4: 1.2
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 18;	selected revisions: 18
description:
----------------------------
revision 1.12
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +2 -1

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.11
date: 2011/09/23 18:36:07;  author: tswift;  state: Exp;  lines: +7 -6

Changes for timed_call/3
----------------------------
revision 1.10
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.9
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2006/02/06 20:20:04;  author: tswift;  state: Exp;  lines: +5 -1
branches:  1.5.4;

Changed default_system_error_handler so that it asserts a fact
'_$thread_exit_ball'/2 if a joinable thread exits via a thrown
error.  Changed xsb_thread_join/2 so that it returns the exit
ball, if any, along with the exit code of the thread.

Using this, created a new predicate, xsb_thread_cancel(Id) which
puts a new thread interrupt on thread Id's interrupt valus.  When
thread Id checks this value, it throws an error, which if
uncaught will cause Id to exit.
----------------------------
revision 1.4
date: 2004/01/14 20:27:13;  author: dwarren;  state: Exp;  lines: +2 -1
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.3
date: 2001/11/08 21:35:25;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.3.8;
Eliminated the indirection of *asynint_ptr and to directly use
asynint_val.  (Also a minor bug-fix in ptoc_longstring.)
----------------------------
revision 1.2
date: 2001/03/23 03:54:31;  author: kifer;  state: Exp;  lines: +2 -1
added new PSC creation interrupt. -- doesn't work yet
----------------------------
revision 1.1
date: 1999/10/25 05:59:15;  author: kifer;  state: Exp;
branches:  1.1.4;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +2 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.8.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/slgdelay.c,v
Working file: slgdelay.c
head: 1.87
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.76
	ROLLBACK: 1.70
	latest_plus_supp_branch: 1.67.0.2
	latest_plus_supp: 1.67
	Version_3dot2_plus_supp: 1.64.0.2
	release_2_6_plus_supp: 1.37.0.6
	Version_3dot2: 1.64
	dec07-perf-results: 1.57
	mt_thesis: 1.54
	release_3_0: 1.47
	release_2_7_0: 1.37
	multi-threaded-26-engine: 1.34.4.4
	pre-mt: 1.37
	multi-threaded-25-engine-done: 1.34.4.1
	multi-threaded-25-engine: 1.34.0.4
	release_2_6_1: 1.37
	release_2_6_final: 1.37
	release_2_6: 1.37.0.4
	last-merged-to-demand: 1.37
	demand_branch: 1.37.0.2
	before_removing_chat: 1.34
	release_2_5: 1.34
	pre-merge-slgwam-gc: 1.34
	multi-threaded-c-engine: 1.34.0.2
	release_2_4: 1.34
	release_2_3: 1.33
	multi-threaded-engine: 1.33.0.2
	pre-threading: 1.31
	release-2-2: 1.27
	chat-and-local: 1.27.0.2
	xsb-pre-cleanup: 1.27
	release-2-1: 1.23
	release-2-0-1: 1.22
	subsumption: 1.20
	without-attv: 1.19
	release-2-0: 1.15
	pre-release-2-0: 1.13
	v1-9-8: 1.9
	code-fixer-new: 1.4
	code-fixer: 1.4
	delayvar_ok: 1.4
	kostis_version: 1.3
	r1-9-b6: 1.3
	r1-9-b5: 1.3
	devel-1-9-b4-5: 1.3
	devel-1-9-b4-4: 1.3
	devel-1-9-b4-3: 1.3
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: o
total revisions: 99;	selected revisions: 99
description:
----------------------------
revision 1.87
date: 2012/06/07 19:37:42;  author: tswift;  state: Exp;  lines: +73 -13

A number of changes to extend forest logging to handle negation.
----------------------------
revision 1.86
date: 2012/04/26 18:19:27;  author: tswift;  state: Exp;  lines: +4 -2

Updates so that incremental tabling works with full WFS.

Also refactored the incremental tabling code a little.
----------------------------
revision 1.85
date: 2011/08/22 16:15:24;  author: dwarren;  state: Exp;  lines: +1 -0
Cleaned up recent checkins to work with MSVC, and avoid warnings.
(Changed bzero to memset, since MS seems not to have bzero.)
Also changed a couple of builtins to be more consistent in their
treatment of string p vs. 0-ary structure symbol p.
----------------------------
revision 1.84
date: 2011/08/19 21:44:15;  author: tswift;  state: Exp;  lines: +2 -2

Mostly minor changes to let ctrace print out early completion, and to
allow ctrace to be directed to stdout rather than a file if desired.
This necessitated some minor code refactoring.
----------------------------
revision 1.83
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +1 -1

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.82
date: 2011/06/02 22:29:23;  author: tswift;  state: Exp;  lines: +2 -0
Changes	to add stack expansion so that arbitrary numbers of
variables are allowed in interned, asserted tries and tables.

This uncovered a bug.

The problem arose when a conditional answer is interned in the
answer trie and that conditional answer contains variables both
in the answer head and the delay list, and there are variables in
the answer head that are not in the delay list. What happened was
that when the variables were interned in delay_trie_chk_insert,
the mini-trail that the trie routines use for standardizing
variables was reset.  This meant that the variables in the answer
head were not being properly untrailed and, due to the particular
way that variables are standardized, variables were bound to each
other that shouldn't have been, and in this case a circular
dereferencing chain arose, so that XSB hung.  I have no idea why
the bug was uncovered just now.
----------------------------
revision 1.81
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +19 -21
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.80
date: 2011/04/23 01:15:17;  author: tswift;  state: Exp;  lines: +0 -1

Taking out negation_defs.h include.
----------------------------
revision 1.79
date: 2011/04/22 19:28:56;  author: tswift;  state: Exp;  lines: +5 -4

Made negation simplification stack dynamically expandable.
----------------------------
revision 1.78
date: 2011/04/22 19:27:21;  author: tswift;  state: Exp;  lines: +27 -6



ModifiedCVS: ----------------------------------------------------------------------
----------------------------
revision 1.77
date: 2010/10/07 18:20:11;  author: dwarren;  state: Exp;  lines: +41 -12
Modified simplify_neg_fails to not be recursive.  It registers a recursive
call, returns immediately, and then before returning from the top-level
executes all registered calls.  This fixes the problem of the C runstack
overflow observed with the even/1 benchmark.  It's possible that this is
not always correct, but it passes the testsuite and seems to be correct
for the kinds of recursion that shows up for this predicate.
----------------------------
revision 1.76
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +30 -52
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.75
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.74
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.73
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.72
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.71
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +52 -30
no message
----------------------------
revision 1.70
date: 2010/06/22 23:51:37;  author: spyrosh;  state: Exp;  lines: +5 -6
no message
----------------------------
revision 1.69
date: 2010/06/19 19:10:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.68
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +6 -5
Dipti's code for support graph added
----------------------------
revision 1.67
date: 2010/02/20 21:48:13;  author: evansbj;  state: Exp;  lines: +4 -4
branches:  1.67.2;
Replaced += for =+ to make the llvm compiler happy. I don't think this will break anything...
----------------------------
revision 1.66
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.65
date: 2009/07/24 10:27:18;  author: alexandrempinto;  state: Exp;  lines: +86 -80
Incremental Answer Completion: merge and commit
----------------------------
revision 1.64
date: 2009/02/21 16:47:33;  author: tswift;  state: Exp;  lines: +6 -6

Changes to support

statistics/2
Rui's fix for the mt bug

along with scratch code for answer_completion.
----------------------------
revision 1.63
date: 2009/01/10 23:37:07;  author: tswift;  state: Exp;  lines: +8 -31

Extended (almost) all the marking routines for tabled predicates
so that subgoals in the heap delay list are checked.  This rather
obscure bug caused a crash in a Flora program for defeasible
logic.  I'll try to finish that part tomorrow.

The problem was that space was reclaimed for a table T that had a
delay element in the heap pointing to it.  When the answer with
the delay element was added, the engine tried to adjust the
backpointers for T and crashed.

Also made some minor ajustments for efficency to some of the
marking functions.  And I changed abolish_table_info to the
clearer abolish_all_tables.
----------------------------
revision 1.62
date: 2009/01/06 15:37:10;  author: dwarren;  state: Exp;  lines: +5 -5
A couple of minor changes to make these files compile under MSVC.
One change in slgdelay.c to add coercion (through using a macro)
may be a problem.  Perhaps Terry can check.
----------------------------
revision 1.61
date: 2009/01/03 01:11:26;  author: tswift;  state: Exp;  lines: +175 -127

Changes were mostly for documentation and code refactoring.

However, also fixed a latent bug in simplification where
was_simplifiable was not properly checking negative delay elements
corresponding to subsumed subgoal frames.  This led to the possibility
of adding un-needed delay elements that might not have been simplified
away.  Surprisingly enough, however, none of the tests in the test
suite checked for this.
----------------------------
revision 1.60
date: 2009/01/02 17:50:03;  author: tswift;  state: Exp;  lines: +10 -4


Updating a number of files so that delete_branch() will work with call
subsumption (it needs to know that it deallocates BTNs rather than
TSTNs).  This fixed a latent bug in simplification and allows another
test to be run for call subsumption. It also provides a step towards
supporting answer subsumption on call subsumptive tables.  There are
also some other documentationstyle changes.

Adding a new test for copying attributed variables into delay elements
/ lists.  I hadn't thought this worked, but apparently it does !

Also, I'm adding a very simple test for incremental evaluation -- more
cases need to be added here, but at least this is a start.
----------------------------
revision 1.59
date: 2009/01/01 20:16:56;  author: tswift;  state: Exp;  lines: +13 -10

tr_utils.c -- fixed bug for abolish_all_tables in mt engine that
showed up when running some subsumption tests on mt engine.  Now the
mt engine runs the sequential test suite in the same way as the
sequential engine.

slgdelay.c -- minor changes to get rid of compiler warnings.
----------------------------
revision 1.58
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +319 -10


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.57
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.56
date: 2007/05/01 14:52:29;  author: tswift;  state: Exp;  lines: +2 -1

Adding scratch code for table inspection functions that may, if they're good, grow up into answer_completion and the like.
----------------------------
revision 1.55
date: 2006/12/14 19:38:07;  author: tswift;  state: Exp;  lines: +5 -3
Changes to handle uninitialized/freed data in tabling delay lists and in garbage colleting data.
----------------------------
revision 1.54
date: 2006/12/07 00:26:45;  author: tswift;  state: Exp;  lines: +156 -156

-- Added reclamation of conditional answer information (including
   subgoal PNDEs and delay tries) when variant predicates/subgoals are
   abolished in abolish_table_pred/1, abolish_table_call/1, and
   close_open_tables/0.  Also, wrote delete_delay_trie() to delete
   answer substitution factor for delay elements, and made sure this
   was used whenever des are reclaimed -- (e.g. by abolishes and
   simplifications).

-- fixed some bugs in MT engine where situations could arise where
   trie allocation type was not properly set before abolishes called
   in table gc sweeps or reloading tabled predicates.

-- Fixed numerous bugs in performing simplification in the MT engine.
   In general simplification routines may reclaim structures for delay
   lists, delay elements, answer branches, asis and pndes.  Whenever
   any of these structures are reclaimed in the MT engine a check must
   be made to determine whether these elements use private or shared
   memory management -- either struture managers or the managers for
   des/dls/pndes.  Keeping all of this straight required some thinking
   as the code flits from table to table by traversing pndes --
   however I think I was able to extend the code without undue mess
   (at least this time :-)
----------------------------
revision 1.53
date: 2006/11/30 21:10:24;  author: ruim;  state: Exp;  lines: +9 -7
Moved DELAY_MUTEX in, in do_delay_stuff_shared to avoid unneeded locks

New Feature:
 Pseudo Mutexes

  These are system mutexes which are just used for counting in place of
  either sets of mutexes (call trie, struct manager) or mutexes
  that really don't fit in the SYS_MUTEX convention (completing_mut,
  th_mutex)

  It allows to re-use the statistics stuff for these mutexes.
----------------------------
revision 1.52
date: 2006/11/15 23:23:45;  author: tswift;  state: Exp;  lines: +2 -2
update to comment.
----------------------------
revision 1.51
date: 2006/11/15 22:02:20;  author: tswift;  state: Exp;  lines: +25 -3

Fixes to slgdelay.c to properly deallocate Answer Substitution Frames upon simplification, etc.
----------------------------
revision 1.50
date: 2006/11/15 16:38:09;  author: tswift;  state: Exp;  lines: +355 -66

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.49
date: 2006/11/14 23:51:20;  author: ruim;  state: Exp;  lines: +2 -2
Change to allow compilation on picky c compiler
----------------------------
revision 1.48
date: 2006/11/12 20:00:18;  author: tswift;  state: Exp;  lines: +15 -1


Fixed minor memory leak in WF evaluation.  The ASI structure was not
being deallocated upon abolish_all_tables.  I changed its allocation
to use a structure manager and released it in abolish_all_tables.

This only addresses sequential memory issues.  Tomorrow I intend to
update the MT system to use private WFS structures for private tables
and shared WFS structures for shared tables.  The private WFS
structures will then be released upon thread exit.
----------------------------
revision 1.47
date: 2006/03/18 17:37:49;  author: tswift;  state: Exp;  lines: +5 -3
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.46
date: 2006/01/19 23:33:00;  author: tswift;  state: Exp;  lines: +23 -7
 * TLS: moved mutex_delay into conditionals in do_delay_styff().
This avoids the need to lock the
 * delay mutex when adding an answer for a LRD stratified program.
 * For non-LRD programs the placement of mutexes may mean that we lock
 * the mutex more than once per answer, but such cases will be
 * uncommon for the most part (as two of the cases engender
 * simplification).  And in any case, if we optimize non-LRD programs
 * for MT, we'd probably want to deal with shared and non-shared DL/DE
 * alloction along the lines of structure managers.  Finally, I'm not
 * completely sure that simplification requires a mutex -- I need to
 * figure this out.
----------------------------
revision 1.45
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +3 -1
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.44
date: 2005/12/22 23:33:58;  author: tswift;  state: Exp;  lines: +11 -11

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.43
date: 2005/11/17 23:24:24;  author: tswift;  state: Exp;  lines: +96 -76



Added new mutex, MUTEX_DELAY to synchronize management of de-s
dl-s and pnde-s.  For now, memory management of these data
structures uses common global variables, even in private tables,
hence the need for a mutex.

My placing of the mutexes within the code is still a little
uncertain.  On the one hand, I've over approximated a little so
that (I think) any of the memory management routines are covered.
I've also covered simplification routines (which do not directly
call the mem-management routines), though I'm not entirely
certain that the mutexes are needed there with shared tables and
our algorithm for shared concurrent tables.  More insight on
mutexes and simplification will undoubtedly come with paper
writing.

In addition, we should think in the future about managing de-s,
dl-s and pnde's for private tables using thread-specific memory
management routines.
----------------------------
revision 1.42
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +7 -7
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.41
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +7 -7
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.40
date: 2005/10/28 21:50:29;  author: tswift;  state: Exp;  lines: +18 -14

These changes are for documentation only, before I go ahead and fiddle around with some trie stuff.
----------------------------
revision 1.39
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;  lines: +2 -1
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.38
date: 2005/01/14 18:31:30;  author: ruim;  state: Exp;  lines: +35 -35
Integration of multithreaded system
----------------------------
revision 1.37
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +14 -14
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.36
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +18 -13
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.35
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -6
* Removal of Chat engine
----------------------------
revision 1.34
date: 2001/06/22 21:05:47;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.34.4;

Fixed buglet and otherwise improved (to my taste) DEBUG_DELAYVARS
----------------------------
revision 1.33
date: 2000/09/27 22:09:05;  author: lfcastro;  state: Exp;  lines: +4 -4
branches:  1.33.2;
* Bugfix: when deleting answers, simplify conditional answers which
depend on this one.
----------------------------
revision 1.32
date: 2000/06/28 16:54:52;  author: ruim;  state: Exp;  lines: +4 -4
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.31
date: 2000/05/29 18:08:28;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Minor comment changes.
----------------------------
revision 1.30
date: 2000/05/29 04:23:37;  author: ejohnson;  state: Exp;  lines: +13 -13
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.29
date: 2000/05/20 06:56:07;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.28
date: 2000/04/29 21:53:57;  author: kifer;  state: Exp;  lines: +5 -5
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.27
date: 2000/03/02 20:00:13;  author: cbaoqiu;  state: Exp;  lines: +57 -55
branches:  1.27.2;
Changed the way how a DE and its PDE (or NDE) are released: whenever
we remove a DE, its PDE (or NDE) must be removed from the PNDE list
*first* using remove_pnde().
----------------------------
revision 1.26
date: 2000/03/01 17:36:54;  author: cbaoqiu;  state: Exp;  lines: +9 -4
Fixed a potential bug in remove_pnde.
----------------------------
revision 1.25
date: 2000/02/24 19:42:39;  author: cbaoqiu;  state: Exp;  lines: +16 -9
Changed the way how NDEs (PDEs) are deleted in simplify_neg_succeeds()
(simplify_pos_unsupported()): set subg_nde_list(subgoal)
(asi_pdes(asi)) to NULL first (to `forget' this PNDE list).  This is
safer and also fixes a bug found in a program written by Terry and
David for XSB, Inc.
----------------------------
revision 1.24
date: 2000/01/07 08:51:48;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.23
date: 1999/11/19 23:44:26;  author: cbaoqiu;  state: Exp;  lines: +21 -7
Fixed a bug in remove_pnde() (see the comments before the definition
of remove_pnde()), which was found by Terry and David in a program
written for XSB Inc.
----------------------------
revision 1.22
date: 1999/10/26 06:47:24;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.21
date: 1999/10/25 05:59:16;  author: kifer;  state: Exp;  lines: +5 -5
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.20
date: 1999/10/12 20:25:09;  author: ejohnson;  state: Exp;  lines: +2 -2
Comment change (updated mentioned function name).
----------------------------
revision 1.19
date: 1999/10/05 04:01:53;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.18
date: 1999/09/18 04:39:44;  author: cbaoqiu;  state: Exp;  lines: +7 -4
Put some delay-variable stuff into ``#ifndef IGNORE_DELAYVAR'' (to
help Kostis debug).  By doing this, we make sure that no substitution
factor of the answer is put into the heap.  [To disable delay-variable
handling, one can put ``#define IGNORE_DELAYVAR'' in the file
$XSB/emu/debugs/debug_delay.h.]
----------------------------
revision 1.17
date: 1999/08/16 07:24:29;  author: kifer;  state: Exp;  lines: +23 -22
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.16
date: 1999/07/06 16:35:15;  author: ejohnson;  state: Exp;  lines: +9 -8
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.15
date: 1999/06/18 22:27:18;  author: cbaoqiu;  state: Exp;  lines: +3 -4
Fixed a small bug.
----------------------------
revision 1.14
date: 1999/06/18 18:21:21;  author: cbaoqiu;  state: Exp;  lines: +75 -1
Added statistics information for DEs and DLs.
----------------------------
revision 1.13
date: 1999/03/11 18:13:43;  author: kostis;  state: Exp;  lines: +1 -2
Deleted an unnecessary line.
----------------------------
revision 1.12
date: 1999/03/06 03:34:53;  author: cbaoqiu;  state: Exp;  lines: +55 -15
Added builtin force_truth_value/2.
----------------------------
revision 1.11
date: 1999/03/04 06:49:44;  author: cbaoqiu;  state: Exp;  lines: +5 -5
Introduced new macros `makeaddr' and `addr_val', and changed some
`makeint' to `makeaddr' and `int_val' to `addr_val'.
----------------------------
revision 1.10
date: 1999/02/27 21:58:46;  author: cbaoqiu;  state: Exp;  lines: +122 -88
Cleaned the simplification code for delay, and added some lines in
simplify_pos_unconditional() to release all the DLs and their DEs.
The DelayInfo node will be freed when it is not needed.
----------------------------
revision 1.9
date: 1999/02/06 17:18:22;  author: kostis;  state: Exp;  lines: +31 -32
Fixed minor memory leak of CHAT and cleaned up some things.
----------------------------
revision 1.8
date: 1999/01/28 09:08:08;  author: cbaoqiu;  state: Exp;  lines: +16 -9
Changed the first two arguments of 'DL'/3 to INT.  The third argument
set to integer 0 for a negative DE, and string "ret" or ret/n for a
positive DE.
----------------------------
revision 1.7
date: 1999/01/24 17:07:40;  author: kostis;  state: Exp;  lines: +2 -2
Rectified type definitions in delete_branch().
----------------------------
revision 1.6
date: 1999/01/05 19:37:07;  author: cbaoqiu;  state: Exp;  lines: +13 -3
Remove field subs_fact from struct delay_element; it is only needed
when DEBUG_DELAYVAR is defined.
----------------------------
revision 1.5
date: 1998/12/21 01:08:44;  author: cbaoqiu;  state: Exp;  lines: +21 -11
Kostis' changes for GC and CHAT.
----------------------------
revision 1.4
date: 1998/12/09 03:17:38;  author: cbaoqiu;  state: Exp;  lines: +548 -598
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  The whole file is almost rewritten to support new data structure of
  delay element/list.
----------------------------
revision 1.3
date: 1998/11/14 23:53:44;  author: kifer;  state: Exp;  lines: +5 -3
(remove_idl_from_idl_list, remove_ide_from_idl): fixed the return
value to be a true Boolean.
----------------------------
revision 1.2
date: 1998/11/14 05:05:26;  author: kifer;  state: Exp;  lines: +3 -3
djusted casts because now bool is typedef short, for NT compatibility.
----------------------------
revision 1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.27.2.1
date: 2000/03/28 18:10:33;  author: lfcastro;  state: Exp;  lines: +1 -12
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.33.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.33.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +47 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.34.4.4
date: 2004/12/14 08:47:05;  author: ruim;  state: Exp;  lines: +2 -2
added dynamic stacks to thread context
----------------------------
revision 1.34.4.3
date: 2004/11/24 21:53:26;  author: ruim;  state: Exp;  lines: +28 -28
made smBTHT and smBTN thread specific
----------------------------
revision 1.34.4.2
date: 2004/10/18 20:46:09;  author: ruim;  state: Exp;  lines: +18 -18
update for version 2.6.1
----------------------------
revision 1.34.4.1
date: 2004/09/29 19:44:19;  author: ruim;  state: Exp;  lines: +7 -7
Sources from rfm repository
----------------------------
revision 1.67.2.4
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.67.2.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.67.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +5 -4
no message
----------------------------
revision 1.67.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/slgdelay.h,v
Working file: slgdelay.h
head: 1.42
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.39
	ROLLBACK: 1.34
	latest_plus_supp_branch: 1.34.0.2
	latest_plus_supp: 1.34
	Version_3dot2_plus_supp: 1.32.0.2
	release_2_6_plus_supp: 1.18.0.4
	Version_3dot2: 1.32
	dec07-perf-results: 1.29
	mt_thesis: 1.27
	release_3_0: 1.24
	release_2_7_0: 1.18
	multi-threaded-26-engine: 1.16.6.3
	pre-mt: 1.18
	multi-threaded-25-engine-done: 1.16.6.1
	multi-threaded-25-engine: 1.16.0.6
	release_2_6_1: 1.18
	release_2_6_final: 1.18
	release_2_6: 1.18.0.2
	last-merged-to-demand: 1.17
	demand_branch: 1.17.0.2
	before_removing_chat: 1.16
	release_2_5: 1.16
	pre-merge-slgwam-gc: 1.16
	multi-threaded-c-engine: 1.16.0.4
	release_2_4: 1.16
	release_2_3: 1.16
	multi-threaded-engine: 1.16.0.2
	pre-threading: 1.15
	release-2-2: 1.12
	chat-and-local: 1.12.0.2
	xsb-pre-cleanup: 1.12
	release-2-1: 1.12
	release-2-0-1: 1.12
	subsumption: 1.12
	without-attv: 1.11
	release-2-0: 1.10
	pre-release-2-0: 1.9
	v1-9-8: 1.6
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 53;	selected revisions: 53
description:
----------------------------
revision 1.42
date: 2012/04/26 18:19:27;  author: tswift;  state: Exp;  lines: +3 -1

Updates so that incremental tabling works with full WFS.

Also refactored the incremental tabling code a little.
----------------------------
revision 1.41
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +3 -3

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.40
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +10 -10
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.39
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.38
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.37
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.36
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.35
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.34
date: 2009/11/17 19:32:08;  author: dwarren;  state: Exp;  lines: +7 -6
branches:  1.34.2;
Added pointers in the Child field of leaf nodes of answers to point to
the ALN node *preceding* the ALN node that points to it.
This pointer is used in the deletion of an answer.
It is tagged so that it can be known what the pointer is.
If there are conditional answers, this field is used for pointing
to the delay elements, and so is not used for this ALN pointer.
In that case, the entire ALN list must be run when deleting an answer
with a delay list.
----------------------------
revision 1.33
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.32
date: 2009/02/21 16:47:33;  author: tswift;  state: Exp;  lines: +4 -1

Changes to support

statistics/2
Rui's fix for the mt bug

along with scratch code for answer_completion.
----------------------------
revision 1.31
date: 2009/01/03 01:11:26;  author: tswift;  state: Exp;  lines: +4 -18

Changes were mostly for documentation and code refactoring.

However, also fixed a latent bug in simplification where
was_simplifiable was not properly checking negative delay elements
corresponding to subsumed subgoal frames.  This led to the possibility
of adding un-needed delay elements that might not have been simplified
away.  Surprisingly enough, however, none of the tests in the test
suite checked for this.
----------------------------
revision 1.30
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +14 -2


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.29
date: 2007/07/23 16:18:43;  author: ruim;  state: Exp;  lines: +2 -2
small change to help portability for 64 bits
----------------------------
revision 1.28
date: 2007/05/01 14:52:29;  author: tswift;  state: Exp;  lines: +4 -10

Adding scratch code for table inspection functions that may, if they're good, grow up into answer_completion and the like.
----------------------------
revision 1.27
date: 2006/12/07 00:26:45;  author: tswift;  state: Exp;  lines: +31 -6

-- Added reclamation of conditional answer information (including
   subgoal PNDEs and delay tries) when variant predicates/subgoals are
   abolished in abolish_table_pred/1, abolish_table_call/1, and
   close_open_tables/0.  Also, wrote delete_delay_trie() to delete
   answer substitution factor for delay elements, and made sure this
   was used whenever des are reclaimed -- (e.g. by abolishes and
   simplifications).

-- fixed some bugs in MT engine where situations could arise where
   trie allocation type was not properly set before abolishes called
   in table gc sweeps or reloading tabled predicates.

-- Fixed numerous bugs in performing simplification in the MT engine.
   In general simplification routines may reclaim structures for delay
   lists, delay elements, answer branches, asis and pndes.  Whenever
   any of these structures are reclaimed in the MT engine a check must
   be made to determine whether these elements use private or shared
   memory management -- either struture managers or the managers for
   des/dls/pndes.  Keeping all of this straight required some thinking
   as the code flits from table to table by traversing pndes --
   however I think I was able to extend the code without undue mess
   (at least this time :-)
----------------------------
revision 1.26
date: 2006/11/15 16:38:09;  author: tswift;  state: Exp;  lines: +20 -11

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.25
date: 2006/11/12 20:00:18;  author: tswift;  state: Exp;  lines: +6 -1


Fixed minor memory leak in WF evaluation.  The ASI structure was not
being deallocated upon abolish_all_tables.  I changed its allocation
to use a structure manager and released it in abolish_all_tables.

This only addresses sequential memory issues.  Tomorrow I intend to
update the MT system to use private WFS structures for private tables
and shared WFS structures for shared tables.  The private WFS
structures will then be released upon thread exit.
----------------------------
revision 1.24
date: 2005/12/22 23:33:58;  author: tswift;  state: Exp;  lines: +9 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.23
date: 2005/12/12 18:44:53;  author: dwarren;  state: Exp;  lines: +2 -2
Added string table garbage collection.
----------------------------
revision 1.22
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +2 -2
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.21
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +4 -1


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.20
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +2 -2
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.19
date: 2005/01/14 18:31:30;  author: ruim;  state: Exp;  lines: +11 -1
Integration of multithreaded system
----------------------------
revision 1.18
date: 2002/10/04 20:42:01;  author: lfcastro;  state: Exp;  lines: +5 -1
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.17
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +1 -6
branches:  1.17.2;
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.16
date: 2000/09/27 22:09:06;  author: lfcastro;  state: Exp;  lines: +3 -2
branches:  1.16.2;  1.16.6;
* Bugfix: when deleting answers, simplify conditional answers which
depend on this one.
----------------------------
revision 1.15
date: 2000/05/29 18:08:28;  author: cbaoqiu;  state: Exp;  lines: +6 -5
Minor comment changes.
----------------------------
revision 1.14
date: 2000/05/29 04:23:37;  author: ejohnson;  state: Exp;  lines: +6 -6
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.13
date: 2000/04/29 21:53:57;  author: kifer;  state: Exp;  lines: +4 -4
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.12
date: 1999/10/12 20:24:03;  author: ejohnson;  state: Exp;  lines: +3 -1
Moved delaying macro from tries.h to here.
----------------------------
revision 1.11
date: 1999/07/06 16:35:16;  author: ejohnson;  state: Exp;  lines: +3 -3
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.10
date: 1999/06/18 18:21:23;  author: cbaoqiu;  state: Exp;  lines: +6 -1
Added statistics information for DEs and DLs.
----------------------------
revision 1.9
date: 1999/03/27 09:33:07;  author: workflow;  state: Exp;  lines: +2 -2

additional file functions and is_deleted(X) macro defn fixes
----------------------------
revision 1.8
date: 1999/03/04 06:49:45;  author: cbaoqiu;  state: Exp;  lines: +6 -6
Introduced new macros `makeaddr' and `addr_val', and changed some
`makeint' to `makeaddr' and `int_val' to `addr_val'.
----------------------------
revision 1.7
date: 1999/02/27 21:58:47;  author: cbaoqiu;  state: Exp;  lines: +12 -7
Cleaned the simplification code for delay, and added some lines in
simplify_pos_unconditional() to release all the DLs and their DEs.
The DelayInfo node will be freed when it is not needed.
----------------------------
revision 1.6
date: 1999/02/06 17:18:24;  author: kostis;  state: Exp;  lines: +1 -14
Fixed minor memory leak of CHAT and cleaned up some things.
----------------------------
revision 1.5
date: 1999/01/28 09:08:10;  author: cbaoqiu;  state: Exp;  lines: +8 -8
Changed the first two arguments of 'DL'/3 to INT.  The third argument
set to integer 0 for a negative DE, and string "ret" or ret/n for a
positive DE.
----------------------------
revision 1.4
date: 1999/01/05 19:37:09;  author: cbaoqiu;  state: Exp;  lines: +6 -2
Remove field subs_fact from struct delay_element; it is only needed
when DEBUG_DELAYVAR is defined.
----------------------------
revision 1.3
date: 1998/12/21 01:08:46;  author: cbaoqiu;  state: Exp;  lines: +7 -7
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:18:45;  author: cbaoqiu;  state: Exp;  lines: +160 -209
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  The whole file is almost rewritten to support new data structure of
  delay element/list.
----------------------------
revision 1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.16.6.3
date: 2004/11/24 21:53:26;  author: ruim;  state: Exp;  lines: +7 -2
made smBTHT and smBTN thread specific
----------------------------
revision 1.16.6.2
date: 2004/10/18 20:46:09;  author: ruim;  state: Exp;  lines: +5 -10
update for version 2.6.1
----------------------------
revision 1.16.6.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +10 -1
Sources from rfm repository
----------------------------
revision 1.16.2.2
date: 2000/12/19 15:58:18;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.16.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +3 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.17.2.2
date: 2003/04/17 17:11:40;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.17.2.1
date: 2002/10/28 16:49:31;  author: lfcastro;  state: Exp;  lines: +5 -1
* Merge with HEAD
----------------------------
revision 1.34.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.34.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.34.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/slginsts.i,v
Working file: slginsts.i
head: 1.29
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.28
	without-attv: 1.23
	release-2-0: 1.17
	pre-release-2-0: 1.17
	v1-9-8: 1.12
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.3
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 30;	selected revisions: 30
description:
----------------------------
revision 1.29
date: 1999/10/25 05:59:18;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.28
date: 1999/10/15 17:32:51;  author: cbaoqiu;  state: Exp;  lines: +22 -7
Changed some places where `template_size' appears, so that attv_num in
the substitution factor is considered.  Functions
table_answer_search() and variant_answer_search() are also modified to
accept one more argument -- attv_num.
----------------------------
revision 1.27
date: 1999/10/15 02:54:14;  author: cbaoqiu;  state: Exp;  lines: +13 -8
Changed functions table_consume_answer() and load_solution_trie() to
take one more argument, attv_num (the number of attributed variables
in the substitution factor).
----------------------------
revision 1.26
date: 1999/10/13 14:01:30;  author: ejohnson;  state: Exp;  lines: +436 -309
Many, many changes.

Added pictorial of placement of answer template in the CPS and Heap.

tabletry/tabletrysingle:
New segment for the creation of properly subsumed subgoal.  This
handling is folded together with normal consumers as they share most
of the same procesing.  A small subbranch determines whether answers
must be collected from the subsuming subgoal.  Then similar processing
resumes with the consumption of the first available answer.
Consumption is abstracted by the function table_consume_answer() which
issues the correct consumption op depending on whether we are
evaluating the predicate using variant or subsumptive tabling.

answer_return:
Also needs to check, for properly subsumed subgoals, whether answers
must be collected so that one is available for consumption.  Uses
table_consume_answer().

new_answer_dealloc:
table_answer_search() abstracts the tabling operation of looking-up a
newly derived answer.  Issues the correct insertion routine depending
on tabling evaluation method.
----------------------------
revision 1.25
date: 1999/10/12 20:28:03;  author: kostis;  state: Exp;  lines: +3 -2
Clean up and localization of variables changes.
----------------------------
revision 1.24
date: 1999/10/09 18:37:55;  author: kostis;  state: Exp;  lines: +162 -241
Cleanup changes so that variables are declared and appear only in places
where they are actually needed.  Expect speed-up by doing so.
Also, finally, ugly xtemp[3-15] variables were eliminated.
Sorry, Terry !
----------------------------
revision 1.23
date: 1999/09/20 09:06:03;  author: kostis;  state: Exp;  lines: +24 -15
Changes to fix problem that caused the flora1 bug.  Changes affect both
SLG-WAM and CHAT emulators.
----------------------------
revision 1.22
date: 1999/09/18 04:39:45;  author: cbaoqiu;  state: Exp;  lines: +29 -10
Put some delay-variable stuff into ``#ifndef IGNORE_DELAYVAR'' (to
help Kostis debug).  By doing this, we make sure that no substitution
factor of the answer is put into the heap.  [To disable delay-variable
handling, one can put ``#define IGNORE_DELAYVAR'' in the file
$XSB/emu/debugs/debug_delay.h.]
----------------------------
revision 1.21
date: 1999/08/16 07:24:30;  author: kifer;  state: Exp;  lines: +22 -22
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.20
date: 1999/08/04 14:42:06;  author: ejohnson;  state: Exp;  lines: +102 -160
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.19
date: 1999/07/21 16:36:47;  author: cbaoqiu;  state: Exp;  lines: +1 -19
Removed `ifdef CHAT' in old_new_answer_dealloc, so that the warning
msg about uninitialized variable xcurcall is avoided (in CHAT).
----------------------------
revision 1.18
date: 1999/07/06 16:35:17;  author: ejohnson;  state: Exp;  lines: +140 -96
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.17
date: 1999/04/22 06:49:19;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.16
date: 1999/03/26 06:37:39;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Correctly set SUBGOAL in old_new_answer_dealloc.
----------------------------
revision 1.15
date: 1999/03/18 01:25:44;  author: cbaoqiu;  state: Exp;  lines: +111 -1
Added old_new_answer_dealloc to make the system backward compatible.
----------------------------
revision 1.14
date: 1999/02/27 21:51:56;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changed the place where SUBGOAL is set in answer_return.
----------------------------
revision 1.13
date: 1999/02/23 10:50:47;  author: kostis;  state: Exp;  lines: +9 -14
Changes to tag number of substitution factor variables in the CP stack and
to considerably speed up garbage collection - many changes in heap.c.
----------------------------
revision 1.12
date: 1999/02/10 23:19:50;  author: kostis;  state: Exp;  lines: +4 -8
slginsts.i contains changes for storing the substitution factor of generators
in the heap irrespectively of SLG-WAM vs CHAT.

emuloop.c supports these changes and contains some clean-up changes related to
garbage collection.
----------------------------
revision 1.11
date: 1999/02/04 22:16:52;  author: kostis;  state: Exp;  lines: +1 -7
Unnecessary, and in fact commented, code taken out.
----------------------------
revision 1.10
date: 1999/02/02 17:17:03;  author: kostis;  state: Exp;  lines: +1 -2
Silly include for debugging taken out.
----------------------------
revision 1.9
date: 1999/01/29 04:18:25;  author: cbaoqiu;  state: Exp;  lines: +5 -10
Changed string_find("ret", 1) to ret_psc[0].  ret_psc[0] is set at the
time when the system is started.
----------------------------
revision 1.8
date: 1999/01/28 09:08:58;  author: cbaoqiu;  state: Exp;  lines: +42 -17
Changed the call of delay_positively() so that the SUBSF is not always
a CS pointer (it can be a string "ret").
----------------------------
revision 1.7
date: 1999/01/22 12:48:40;  author: kostis;  state: Exp;  lines: +2 -7
Removed unnecessary code used in debugging the integration.
----------------------------
revision 1.6
date: 1999/01/18 17:59:36;  author: kostis;  state: Exp;  lines: +1 -9
Changes to make ptcp pointing to subgoal frame independently of engine used.
----------------------------
revision 1.5
date: 1999/01/10 01:07:57;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Set delay_it to 1 in return_table_code.
----------------------------
revision 1.4
date: 1998/12/21 01:08:48;  author: cbaoqiu;  state: Exp;  lines: +256 -312
Kostis' changes for GC and CHAT.
----------------------------
revision 1.3
date: 1998/12/09 03:21:53;  author: cbaoqiu;  state: Exp;  lines: +133 -25
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  The ways to call delay_positively() in new_answer_dealloc,
  retry_active, and lay_down_active are changed.
----------------------------
revision 1.2
date: 1998/12/01 17:10:34;  author: sbprolog;  state: Exp;  lines: +3 -2
These are small fixes to a couple of stack expansion bugs, mainly
in the placing of the overflow checks.

TRIM_CORE is also updated to deal with heap/local stack expansion.

-- Rui Marques
----------------------------
revision 1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/slginsts_xsb_i.h,v
Working file: slginsts_xsb_i.h
head: 1.141
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.100
	ROLLBACK: 1.93
	latest_plus_supp_branch: 1.87.0.2
	latest_plus_supp: 1.87
	Version_3dot2_plus_supp: 1.83.0.2
	release_2_6_plus_supp: 1.27.0.4
	Version_3dot2: 1.83
	dec07-perf-results: 1.76
	mt_thesis: 1.72
	release_3_0: 1.59
	release_2_7_0: 1.28
	multi-threaded-26-engine: 1.22.2.2
	pre-mt: 1.28
	multi-threaded-25-engine-done: 1.22.2.1
	multi-threaded-25-engine: 1.22.0.2
	release_2_6_1: 1.27
	release_2_6_final: 1.27
	release_2_6: 1.27.0.2
	last-merged-to-demand: 1.25
	demand_branch: 1.25.0.2
	before_removing_chat: 1.22
	release_2_5: 1.22
	pre-merge-slgwam-gc: 1.19
	multi-threaded-c-engine: 1.19.0.2
	release_2_4: 1.18
	release_2_3: 1.16
	multi-threaded-engine: 1.14.0.2
	pre-threading: 1.9
	release-2-2: 1.6
	chat-and-local: 1.6.0.2
	xsb-pre-cleanup: 1.6
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: o
total revisions: 159;	selected revisions: 159
description:
----------------------------
revision 1.141
date: 2012/07/13 22:51:51;  author: tswift;  state: Exp;  lines: +11 -4

Some updated debugging routines.
----------------------------
revision 1.140
date: 2012/06/07 19:37:42;  author: tswift;  state: Exp;  lines: +24 -20

A number of changes to extend forest logging to handle negation.
----------------------------
revision 1.139
date: 2012/06/03 18:28:21;  author: tswift;  state: Exp;  lines: +8 -5
Another fix for negative calls.
----------------------------
revision 1.138
date: 2012/06/03 17:27:01;  author: tswift;  state: Exp;  lines: +21 -31

Setting up to log negative calls.
----------------------------
revision 1.137
date: 2012/05/27 21:45:31;  author: tswift;  state: Exp;  lines: +1 -1

comp -> cmp in forest log tc facts.
----------------------------
revision 1.136
date: 2012/04/06 16:20:11;  author: tswift;  state: Exp;  lines: +11 -2

XSB keeps track of choice points in two ways.  1) by running the
choice point stack (for table and clause gc).  2) by maintaining
a "visitors" field in tabled subgoal frames to determine when a
given completed table is being backtracked through (used by
incremental tabling).  The visitors field is incremented when a
completed table is called, and decremented when backtracking out
of the table.  In addition, if the choice point is cut over or
thrown over by an exception, the visitors field is similarly
decremented.

However when a table T is early completed the breg is reset to
the choice point for T, cutting over intermediate choice points.
This seems correct (as opposed to simply resetting the choice
point for T but not breg), but in this case the cut-over choice
points need to be examined so that their visitors field is
decremented.  In addition, the choice points need to be	checked
to perform any call cleanup.

To fix this I put a simple while loop to check for choice points
that need to be handled	   before resetting the breg after
performing early completion.
----------------------------
revision 1.135
date: 2012/03/19 15:19:59;  author: dwarren;  state: Exp;  lines: +3 -5
Fixed a couple of declarations, not at the beginning of blocks.
Added some casts to quiet MSVC.
Conditioned the inline declarations of prolog_call0 and prolog_code_call,
which can't be external in MSVC.
----------------------------
revision 1.134
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +33 -18

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.133
date: 2012/03/07 15:57:00;  author: dwarren;  state: Exp;  lines: +1 -1
Moved some decls to beginning of block, for MSVC.
----------------------------
revision 1.132
date: 2012/03/01 16:27:50;  author: tswift;  state: Exp;  lines: +18 -23

Minor change to tabletry to avoid an unnecessary if statement for
incremental tabling.
----------------------------
revision 1.131
date: 2012/02/03 23:58:49;  author: tswift;  state: Exp;  lines: +10 -2

Put in a check for timer_calls in answer return.

I'm thinking this is somewhat experimental -- while I think its
correct, I'm not 100% sure its needed.
----------------------------
revision 1.130
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +3 -3
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.129
date: 2011/11/12 00:55:43;  author: tswift;  state: Exp;  lines: +1 -1

Fix to ctrace.
----------------------------
revision 1.128
date: 2011/10/19 22:51:29;  author: tswift;  state: Exp;  lines: +4 -4

Changes to C trace to indicate the state of a tabled subgoal (new/complete/incomplete)
also emitting where an error was called from.

Also, some small change to get call abstracting compiling under MSVC.
----------------------------
revision 1.127
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +69 -27

Integrating in Call Abstraction
----------------------------
revision 1.126
date: 2011/09/30 17:18:51;  author: tswift;  state: Exp;  lines: +5 -5

Some changes to allow compilation with CALL_ABSTRACTION set on
(tables.c not committed yet, though).  This change should not affect
regular compilation or evaluation.
----------------------------
revision 1.125
date: 2011/08/25 12:59:33;  author: dwarren;  state: Exp;  lines: +2 -2
Add a couple of coercions to quiet the warnings.
----------------------------
revision 1.124
date: 2011/08/24 21:58:08;  author: tswift;  state: Exp;  lines: +29 -18

Added functionality to CTRACE and added a new debugging statement.
----------------------------
revision 1.123
date: 2011/08/22 16:15:24;  author: dwarren;  state: Exp;  lines: +5 -3
Cleaned up recent checkins to work with MSVC, and avoid warnings.
(Changed bzero to memset, since MS seems not to have bzero.)
Also changed a couple of builtins to be more consistent in their
treatment of string p vs. 0-ary structure symbol p.
----------------------------
revision 1.122
date: 2011/08/19 21:44:15;  author: tswift;  state: Exp;  lines: +1 -1

Mostly minor changes to let ctrace print out early completion, and to
allow ctrace to be directed to stdout rather than a file if desired.
This necessitated some minor code refactoring.
----------------------------
revision 1.121
date: 2011/08/19 18:26:30;  author: tswift;  state: Exp;  lines: +44 -7

Changes to support Ctrace (Fview).
----------------------------
revision 1.120
date: 2011/08/15 15:10:25;  author: dwarren;  state: Exp;  lines: +2 -2
Minor changes to quiet 64-bit compilation (or use 64-bit compatible decls).
Minor change to tokenizer to make it more standardish(?) for \NUM form.
One decl moved to work with ANSI C (MSVC).
----------------------------
revision 1.119
date: 2011/08/01 12:35:34;  author: tswift;  state: Exp;  lines: +2 -2
Took cut a couple mroe printfs
----------------------------
revision 1.118
date: 2011/07/31 21:59:03;  author: tswift;  state: Exp;  lines: +15 -13
took out a printf
----------------------------
revision 1.117
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +117 -42

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.116
date: 2011/07/02 14:27:38;  author: tswift;  state: Exp;  lines: +2 -2

More updates for C-level trace.
----------------------------
revision 1.115
date: 2011/06/27 15:56:07;  author: dwarren;  state: Exp;  lines: +2 -4
Several minor fixes:
1. Added some type coercions to quiet MSVC compiler
2. Added some CTXT-type stuff so it would compile under MT flag.
3. Moved an external declaration from included file to file it's include
in, so that MSVC would compile it.
----------------------------
revision 1.114
date: 2011/06/26 21:02:10;  author: tswift;  state: Exp;  lines: +23 -0
Support for C-level trace.
----------------------------
revision 1.113
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +1 -1

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.112
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +8 -11
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.111
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +4 -3

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.110
date: 2011/04/12 17:31:59;  author: tswift;  state: Exp;  lines: +10 -10

Fix of abolishing incremental tables when the affected list is
non-empty -- it needed to be re-initialized to null.  In addition, the
changed list also needs to be initted and reinitialized to null, but
this is accessed less often so we haven't yet seen that problem arise.

I also changed the name of the global variables for incremental
tabling to make them more obvious -- names like "changed" and
"affected" arent good.
----------------------------
revision 1.109
date: 2010/12/23 19:47:45;  author: tswift;  state: Exp;  lines: +7 -6
Changed some misleading documentation about CPS A.T.
----------------------------
revision 1.108
date: 2010/12/23 18:12:43;  author: tswift;  state: Exp;  lines: +22 -22

The handling of answer templates within the SLG instructions is
extremely confusing, as there is a CallInfo and a CallLUR answer
template AND an answer template may be on the CPS or the heap at
different times.  I renamed some variables to make it clear wither the
AT was on the heap or CPS, and added a few comments.
----------------------------
revision 1.107
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +8 -7

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.106
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +2 -2

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.105
date: 2010/12/16 16:47:13;  author: tswift;  state: Exp;  lines: +3 -3
Changed the name of VarVectorLoc to the more meaningful (to me) AnsTempl
----------------------------
revision 1.104
date: 2010/12/09 19:15:38;  author: tswift;  state: Exp;  lines: +13 -1

Added a return code for tabled_call_check_incr, to handle failures
from variant_call_check.
----------------------------
revision 1.103
date: 2010/12/09 17:55:53;  author: tswift;  state: Exp;  lines: +8 -8

Changed CallLUR_VarVector to CallLUR_AnsTempl, which is much more
meaningful (to me, at least).
----------------------------
revision 1.102
date: 2010/12/09 17:28:45;  author: tswift;  state: Exp;  lines: +11 -77

Reformatted tabletry, which had gotten to be practically unreadable.
The major change was putting the usurpation action into a separate
include file.
----------------------------
revision 1.101
date: 2010/12/06 16:27:37;  author: dwarren;  state: Exp;  lines: +2 -1
This is an update that Pablo Chico recommended.  With this line commented out
(as it was before this change puts it back in), early completion can result in
duplicate computation.
----------------------------
revision 1.100
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +2 -86
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.99
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.98
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.97
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.96
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.95
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;  lines: +85 -1
no message
----------------------------
revision 1.94
date: 2010/08/17 19:44:54;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.93
date: 2010/08/13 19:55:05;  author: tswift;  state: Exp;  lines: +24 -32

Added check for opaque in tabletrysinglnoanswers.  This allow us to
switch dynamic predicates back and forth between opaque and
incremental.
----------------------------
revision 1.92
date: 2010/07/29 19:57:47;  author: tswift;  state: Exp;  lines: +10 -5

change to allow opaque tables to depend on incremental tables.
----------------------------
revision 1.91
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.90
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.89
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +1 -60
Backed out code
----------------------------
revision 1.88
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +61 -2
Dipti's code for support graph added
----------------------------
revision 1.87
date: 2010/03/18 22:22:17;  author: tswift;  state: Exp;  lines: +5 -2
branches:  1.87.2;

Added subgoal depth check with actions of fail and error (cf pg. 165 of the manual)
----------------------------
revision 1.86
date: 2010/02/08 16:36:30;  author: tswift;  state: Exp;  lines: +1 -16

No code change -- removed some spurious and misleading documentation.
----------------------------
revision 1.85
date: 2010/01/23 19:03:03;  author: tswift;  state: Exp;  lines: +4 -4

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.84
date: 2009/11/08 18:29:21;  author: tswift;  state: Exp;  lines: +2 -2

No functionality changes -- just some name changes and simplifications
in preparation for my trip to Portugal.

These were mostly name changes, but I did get rid of a few functions
-- not for efficiency but for simplicity.
----------------------------
revision 1.83
date: 2009/02/21 16:47:33;  author: tswift;  state: Exp;  lines: +7 -3

Changes to support

statistics/2
Rui's fix for the mt bug

along with scratch code for answer_completion.
----------------------------
revision 1.82
date: 2009/01/06 15:37:10;  author: dwarren;  state: Exp;  lines: +2 -2
A couple of minor changes to make these files compile under MSVC.
One change in slgdelay.c to add coercion (through using a macro)
may be a problem.  Perhaps Terry can check.
----------------------------
revision 1.81
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +3 -2


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.80
date: 2008/09/26 20:32:01;  author: tswift;  state: Exp;  lines: +6 -1

`Fixes the test pps while not breaking the tests dipti or wine.
The change is a 1-liner.  Other changes are for documentation and
(commented out) debugging.

----------------------------------------------------------------------

Keeping some log notes of the change in the CVS log -- this has proven
useful in understanding the history of minor tabling changes.

I've just spent a while analyzing the pps program to find out why a
cut-over choice point is improperly backtracked into.  Recall that
when I fixed this bug 3 years ago, I broke an example of Dipti's
(which is now in the test suite) along with the wine example.  Taking
out that change apparently fixes both examples.

A complex combination of events give rise to backtracking over a cut
choice point in local evaluation.  First, early completion must be
applied to a subgoal S that is not the leader in an SCC.  Next, the
generator/consumer choice point of S must never have been scheduled
for answer return.  And finally, the generator/consumer choice point
of S must be preceded by a cut-over choice point.

I realize that this is obscure, and I don't yet understand how to
explain it more cogently.  However, I do include 1) a pps program,
slightly modified with debugging info; 2) the debugging output; and 3)
a detailed explanation of what is going on.  I'm not sure whether
these details will be of help to anyone other than me.

Of course the real question is what to do.  My previous "fix" was to
ensure that non-leader GCPs pointed to the leader GCP in local
evaluation when the non-leader GCP was backtracked over and turned
into a CCP.  Exactly why this was causing a problem in the wine and
Dipti examples, I dont know, but I could see that it could be a
problem if there were a chain of non-leader GCPs linked by their
previous CP values.  So anyway, that fix wont work.

Thus, we want the previous CP of non-leader GCPs ot point to the
leader GCP after they have been turned into consumers (as long as they
are not part of a scheduling chain).  Making this adjustment when the
non-leader GCP is turned into a CCP is wrong, as we've seen.  However,
I do believe that making the adjustment at a different time is safe.
Accordingly I made a 1-line change to adjust the previous choice point
of non-leader GCPs to the leader GCP during *fixed-point check
performed by the leader*.

By the way, I really appreciate the work that Michael did to pare down
the bug example to the small pps program.  If it had been much more
complex, I doubt that I could have understood what was going on.

Terry


Its possible that rather than adjusting the non-leader GCPs to have
the leader GCP as their previous choice point when they are turned
into CCPs (which is wrong) this could be done at some other time.

One possibility is to make the adjustment at fixpoint check, as the
CCP (nee GCP) needs to be traversed to check if it has unreturned
answers anyway.

I'll think about doing making that change to the fixed point
computation.  However, at least for now I think the engine is
functioning properly for definite datalog programs without cuts -- at
least in terms of answer scheduling.

------------------------------------------------------------------------------------
% % % pps.P % % %

/* print_cp is more understandable when CP_DEBUG is defined */

:- import print_cp/0 from machine.

:- table w2/2, w3/3.

db(wrapper(app,_)).
db(wrapper(pps,_)).
db(wrapper(p,_)).

test:- w2(pps,foobar).
test1:- w2(pps,_foobar).

%% wrapper/2
w2(pps,_A) :-
%	print_cp,
	writeln(clause1w2(pps,_A)),
        w2(app,foobar),
        fail.
w2(app,_A) :-
	writeln(clause2w2(app,_A)),
	w3(p,_,foobar).
w2(X,Y) :-
	writeln(clause3(w2(X,Y))),
        db(wrapper(X,Y)),
        nl,
	print_cp,
        writeln('About to cut'),
        !,
	print_cp,
        fail.
%% Shouldn't go here after the cut!!!
w2(X,Y) :-
	writeln(clause4(w2(X,Y))),
        writeln('******fell through the cut!!! ' - X).

%% wrapper/3
w3(p,0,X):-
	writeln(clause1(w3(p,-,X))).
w3(p,_A,_B) :-
	writeln(clause2(w3(p,_A,_B))),
        w3(p,_,foobar),
	writeln(calling(w2(pps,foobar))),
        w2(pps,foobar).

------------------------------------------------------------------------------------
% % % Output % % %

| ?- test.
clause1w2(pps,foobar)
clause2w2(app,foobar)
clause1(w3(p,-,foobar))
clause2(w3(p,_h131,foobar))
calling(w2(pps,foobar))
clause3(w2(app,foobar))

About to cut
clause3(w2(pps,foobar))

About to cut
leader scheduling answers                            % printout from engine
performing early completion for: w2(app, foobar)(breg: 5c4c8c pcpf 5c4d18) % printout from engine
clause4(w2(pps,foobar))
******fell through the cut!!!  - pps
performing early completion for: w2(pps, foobar)(breg: 5c4da0 pcpf 5c4da0) % printout from engine
leader scheduling answers % printout from engine
calling(w2(pps,foobar))
leader scheduling answers % printout from engine


------------------------------------------------------------------------------------
% % % The prodigal choice point % % %

Step 1: Generator Choice Point created for w2(pps,foobar) (Failure
continuation set to check_complete)

Step 2: Regular choice point created for _$w2(pps,foobar), (_$w2/2 was
created to handle cut in a clause body of w2/2).

Step 3: GCP created for w2(app,foobar)

Step 4: Regular choice point created for _$w2(app,foobar)

Step 5: GCP created for w3(p,_,foobar)

Step 6: Answer created for w3(p,_,foobar), and Consumer Choice Point
created for w3(p,_,foobar)

Step 7: Answer w3(p,0,foobar) created in step 6 returned to CCP
created in step 6 (while evaluating the second clause of w3/3).
CCP created for w2(pps,foobar).

Step 8: At this point all subgoals are in the same Approximate SCC.
Also, each CP has as its previous CP the CP created in the immediately
preceding step.  The only anwser produced has been consumed, so the
engine backtracks to the CCP of step 7; fails; backtracks to the CCP
created in step 6; fails; backtracks to the GCP created in step 6 and
turns the GCP created in step 5 into a CCP.  (This happens in local
evaluations when backtracking over a GCP for a subgoal that is not a
SCC leader).  Finally, backtracking reaches the CP created in Step 4,
and executes the third clause of _$w2(app,foobar)

Step 9: Forward execution creates a choice point for db/1 whose
previous choice point is the CP of Step 4.  Note that there are two
CPs whose previous CP is that of Step 4: this new one and the one from
step 5.

Step 10: the cut is executed, the CP of step 9 removed, and breg set
to the GCP for Step 3.  Upon failure (immediately after the cut)
backtracking sets the GCP of Step 3 to a CCP, and fails.  Backtracking
follows the previous CP for the Step 3 CCP to the step 2 CP.

Step 11: Similarly to step 9, forward execution executes clause 3 for
_$w2(pps,foobar) (a minor difference is that no CP for db/1 is created
for the goal db(wrpper(app,foobar)) ).  (breg still points to Step 2's
CP)

Step 12: The cut is executed, resetting breg back to the original GCP
of Step 1, which is the leader.  Recall that the failure continuation
for the step 1 GCP is a check_complete, so the leader schedules answer
return for all CCPs in the SCC.  Actually, there is one scheduled.
The answer w3(p,0,foobar) is returned to the CCP (nee GCP) of step 5,
returning the answer to the second clause of _$w2(app,foobar).

Step 13 (the unlucky step): The return of the answer immediately
causes a new answer w2(app,foobar) to be derived for the goal
w2(app,foobar).  Since an answer is returned for a ground goal, early
completion applies and the goal w2(app,foobar) is early completed.

>>!! A heuristic for early completion is to set the breg to the
original GCP for the goal !!<<

and the breg is set to point to the GCP (now a CCP) of w2(app,foobar)
created in step 3.

Step 14.  Note that due to early completion, the breg now points to
the CCP of step 3 which was never scheduled by the leader.  If it had
been scheduled, its previous CP would be the (step 1) leader.
However, as it was never rescheduled, its previous CP is its original
one: that of step 2.

Step 15. The addition of the new answer from step 13 causes an
immediate failure due to local scheduling.  The engine now backtracks
into the (ostensably cut) choicepoint of step 2, which improperly
executes the fourth clause for _$w2(pps,foobar).
----------------------------
revision 1.79
date: 2008/06/08 22:10:04;  author: ruim;  state: Exp;  lines: +5 -3
changes to shared completed tables
	re introduced de dealock break leader
	solved some bugs relating to marking subgoals of threads
	that where already usurped (double deadlocks)
----------------------------
revision 1.78
date: 2008/06/05 18:15:13;  author: ruim;  state: Exp;  lines: +5 -11
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.77
date: 2008/06/04 13:23:25;  author: ruim;  state: Exp;  lines: +47 -42
tidy up of shared completed tables code
completing mut is now locked much less time
----------------------------
revision 1.76
date: 2007/11/24 07:38:40;  author: ruim;  state: Exp;  lines: +0 -4
rolled back last commit
it was unsafe
----------------------------
revision 1.75
date: 2007/11/24 06:53:58;  author: ruim;  state: Exp;  lines: +5 -1
released the completing mut during the more heavy duty tasks
when the leader is reseting the other threads in the SCC
in shared completed tables
----------------------------
revision 1.74
date: 2007/02/22 00:16:04;  author: tswift;  state: Exp;  lines: +4 -5


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.73
date: 2007/02/09 18:12:17;  author: dwarren;  state: Exp;  lines: +3 -3
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.72
date: 2006/12/03 17:09:28;  author: ruim;  state: Exp;  lines: +23 -19
Bug fix for concurrent completion:
  added a lock to protect insertion of consumers on subgoal asf list
----------------------------
revision 1.71
date: 2006/12/02 19:31:57;  author: ruim;  state: Exp;  lines: +5 -3
moved in lock of compl mutex to avoid locking if non leader
some standartization and ifx of potential bugs for conc compl
----------------------------
revision 1.70
date: 2006/11/30 21:10:24;  author: ruim;  state: Exp;  lines: +6 -3
Moved DELAY_MUTEX in, in do_delay_stuff_shared to avoid unneeded locks

New Feature:
 Pseudo Mutexes

  These are system mutexes which are just used for counting in place of
  either sets of mutexes (call trie, struct manager) or mutexes
  that really don't fit in the SYS_MUTEX convention (completing_mut,
  th_mutex)

  It allows to re-use the statistics stuff for these mutexes.
----------------------------
revision 1.69
date: 2006/11/29 02:10:21;  author: ruim;  state: Exp;  lines: +2 -2
fixed shared completed tables call trie lock bug - it was an optical
ilusion because of the tangled if-ifdef structure

initialize lock even for private tifs, just in case they become shared
removed ifdef out incremental stuff for mt that looked prejudicial
----------------------------
revision 1.68
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +6 -4
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.67
date: 2006/11/20 16:53:42;  author: ruim;  state: Exp;  lines: +8 -8
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.66
date: 2006/11/06 07:56:04;  author: ruim;  state: Exp;  lines: +3 -2
Added error for tcp stack expansion with concurrent completion
----------------------------
revision 1.65
date: 2006/11/05 23:53:15;  author: ruim;  state: Exp;  lines: +24 -34
Several changes & fixes for Concurrent Completion:
- Locking of the answer return list and consumer list at subgoal frame level
- No longer a dummy generator choice point is created for every external
  consumer
- Threads which don't have a stale view of the round are no longer awaken at
  completion
- The answer return list is not reclaim for shared tables
----------------------------
revision 1.64
date: 2006/11/05 13:59:43;  author: ruim;  state: Exp;  lines: +28 -8
added lock to call trie in MT
private tables initialize and destroy the lock, but don't use it
otherwise
----------------------------
revision 1.63
date: 2006/10/26 08:10:55;  author: ruim;  state: Exp;  lines: +8 -4
changed lock to table try in shared completed tables
to only lock the table it is shared
----------------------------
revision 1.62
date: 2006/09/27 22:03:43;  author: tswift;  state: Exp;  lines: +7 -2

Changes to get rid of uninitialized memory as reported by valgrind.

1) Initialized IGRhead and deadlock_brk_leader
2) Ensured that tries always use private structure manager
3) initialized num_heap_term_vars to be 0 at each pass through answer_return

The last fixes an obscure memory error in the sequential engine, as well.
----------------------------
revision 1.61
date: 2006/09/15 20:09:43;  author: tswift;  state: Exp;  lines: +5 -1
Fix for bug that showed up as a core dump in a Flora program.
The bug had to do with the variable num_heap_term_vars not being
initialized when it went through the "ground" path of
table_consume_answer() in tabletry.  The lack of initialization
meant that a value was inappropriately copied to a delay list;
then the core dump arose when an answer using the delay
list (including the bad value) was copied into table space.
----------------------------
revision 1.60
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +163 -2
Incremental Code Added.
----------------------------
revision 1.59
date: 2006/06/02 23:32:39;  author: ruim;  state: Exp;  lines: +1 -2
Optimization to shared completed tables
----------------------------
revision 1.58
date: 2006/01/12 21:33:51;  author: tswift;  state: Exp;  lines: +9 -12
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.57
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +7 -2
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.56
date: 2005/12/22 23:33:58;  author: tswift;  state: Exp;  lines: +4 -1

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.55
date: 2005/12/07 13:23:02;  author: ruim;  state: Exp;  lines: +3 -3
removed rw lock from tries in Multi-threaded engine
----------------------------
revision 1.54
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +3 -1
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.53
date: 2005/11/08 01:05:16;  author: tswift;  state: Exp;  lines: +30 -6

Documentation changes only -- how attvs are traversed in variant_call_search and the setup for using trie instructions on completed tables.
----------------------------
revision 1.52
date: 2005/10/21 20:19:58;  author: tswift;  state: Exp;  lines: +3 -2

Committing a change that fixes a bug in copying attributed variables
out of tables.   The end condition and the iteration statement of the
for() were clearly wrong.
----------------------------
revision 1.51
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +2 -12


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.50
date: 2005/09/30 20:04:26;  author: ruim;  state: Exp;  lines: +1 -2
bugfixes for concurrent completion
----------------------------
revision 1.49
date: 2005/09/29 15:12:43;  author: ruim;  state: Exp;  lines: +4 -5
bugfixes for concurrent completion
----------------------------
revision 1.48
date: 2005/09/28 22:23:57;  author: ruim;  state: Exp;  lines: +30 -36
Integration of concurrent completion -- still not fully debugged
----------------------------
revision 1.47
date: 2005/09/13 18:12:08;  author: dwarren;  state: Exp;  lines: +3 -3
Eliminated an unnecessary cast, and added a comment.
----------------------------
revision 1.46
date: 2005/09/13 13:02:05;  author: dwarren;  state: Exp;  lines: +3 -3
Fixed abolish_table_pred to work with private tables in multithreaded
(but there seems to be a memory leak that still needs to be tracked down.)
Also improved documentation of psc fields for tabling and sharedness.
Changed TDispBlk_t type for table dispatch blocks to allow direct coercion
to a TIF (so they agree on the psc and method fields.)
(Also, the load_backsuite test fails on cygwin, for a reason yet to be determined.)
----------------------------
revision 1.45
date: 2005/08/28 16:42:28;  author: ruim;  state: Exp;  lines: +64 -1
phase 1 of implementation of concurrent completion
----------------------------
revision 1.44
date: 2005/08/13 15:04:02;  author: ruim;  state: Exp;  lines: +7 -5
changed defines to allow concurrent completion
made batch compile under mt
----------------------------
revision 1.43
date: 2005/08/08 17:11:34;  author: dwarren;  state: Exp;  lines: +17 -2
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.42
date: 2005/08/04 19:35:20;  author: ruim;  state: Exp;  lines: +1 -5
fix for deadlock breaking with negation
----------------------------
revision 1.41
date: 2005/07/22 22:51:02;  author: ruim;  state: Exp;  lines: +1 -5
fixes for deadlock breaking algorithm
----------------------------
revision 1.40
date: 2005/07/21 16:51:03;  author: dwarren;  state: Exp;  lines: +14 -4
slginsts_xsb_i.h had a mt variable (grabbed) used in non-mt code.  I readjusted
the conditional code to hide all "grabbed" uses from non-mt code.
For deadlock.c, I included xsb_config.h first so MULTI_THREAD is defined
if it's going to be...
----------------------------
revision 1.39
date: 2005/07/21 14:03:56;  author: ruim;  state: Exp;  lines: +1 -2
disable deadlock break (accidentally enabled)
----------------------------
revision 1.38
date: 2005/07/21 14:03:07;  author: ruim;  state: Exp;  lines: +2 -1
small changes to thread table in Linux
----------------------------
revision 1.37
date: 2005/07/21 10:46:35;  author: ruim;  state: Exp;  lines: +46 -8
preliminar implementation of deadlock breaking
----------------------------
revision 1.36
date: 2005/07/20 16:00:57;  author: ruim;  state: Exp;  lines: +7 -6
changed tid from generator cp to sf in preparation for deadlock breaking
----------------------------
revision 1.35
date: 2005/07/18 19:39:19;  author: ruim;  state: Exp;  lines: +10 -15
small change to completing shared tables in view of implementing deadlock breaking
----------------------------
revision 1.34
date: 2005/07/12 19:52:11;  author: dwarren;  state: Exp;  lines: +3 -2
Added parens after condition, when checking for completed tables
for threads.  Looks like a typo and it fixes an infinite loop.
Rui should check it out...
----------------------------
revision 1.33
date: 2005/07/12 15:54:24;  author: ruim;  state: Exp;  lines: +9 -3
added deadlock detection to shared completed tables
----------------------------
revision 1.32
date: 2005/07/10 19:05:05;  author: ruim;  state: Exp;  lines: +8 -3
Fix for sharing completed tables
----------------------------
revision 1.31
date: 2005/07/05 05:39:43;  author: ruim;  state: Exp;  lines: +13 -7
fix for sharing completed tables
----------------------------
revision 1.30
date: 2005/07/04 20:47:01;  author: ruim;  state: Exp;  lines: +18 -1
allow sharing of completed tables
----------------------------
revision 1.29
date: 2005/01/14 18:31:31;  author: ruim;  state: Exp;  lines: +25 -5
Integration of multithreaded system
----------------------------
revision 1.28
date: 2004/11/24 22:35:04;  author: dwarren;  state: Exp;  lines: +4 -4
Modified check_glstack_overflow to call gc_heap to try to get the necessary
space to see if it can avoid expanding the stack.  Only expand stack if GC
doesn't get enough space.  This required changes in calls to check_glstack_overflow
since it would accept MAX_ARITY to "over-save" the registers.  But GC requires
the exact number.  I think I got them correctly, except for one in calld, which I
deleted.  I don't know why calld needs to check overflow since the check_heap
in clauses should be enough....
----------------------------
revision 1.27
date: 2002/11/04 18:09:03;  author: dwarren;  state: Exp;  lines: +4 -4
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.26
date: 2002/10/04 20:42:02;  author: lfcastro;  state: Exp;  lines: +1 -22
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.25
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +12 -12
branches:  1.25.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.24
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +23 -25
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.23
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +13 -76
* Removal of Chat engine
----------------------------
revision 1.22
date: 2002/02/22 21:59:46;  author: lfcastro;  state: Exp;  lines: +25 -3
branches:  1.22.2;
* Don't call heap expansion from table_call_search()
* Closes bug #521293
----------------------------
revision 1.21
date: 2002/01/28 16:47:56;  author: lfcastro;  state: Exp;  lines: +3 -2
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.20
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +83 -39
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.19
date: 2001/10/01 19:48:29;  author: lfcastro;  state: Exp;  lines: +18 -21
* modified the resumption of completion suspension frames in SLGWAM in
  order to create chains with the original frames, instead of creating
  new ones on the CP stack
----------------------------
revision 1.18
date: 2001/04/28 20:15:37;  author: ejohnson;  state: Exp;  lines: +2 -2
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.17
date: 2001/04/04 18:28:48;  author: tswift;  state: Exp;  lines: +22 -10

Documentation additions, in particular for new_answer_dealloc.
----------------------------
revision 1.16
date: 2001/01/31 10:23:29;  author: ejohnson;  state: Exp;  lines: +31 -40
Created the macro "table_pending_answer" to hide the details of
obtaining the next answer for consumption, which, in the case of a
properly subsumed subgoal, may require an answer identification step.

Second, removed -- again -- (most) "xtemp1" references.
(Argh!  How does this crap keep creeping back into the system?!?)

These were sprinkled over several files and removed by simply creating
a variable local to each macro in which a temp was needed.

The "need" for this change was precipitated due to the inclusion of an
"xtemp1" declaration within one of the code blocks which
table_pending_answer replaced.
----------------------------
revision 1.15
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +46 -37
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.14
date: 2000/10/05 17:23:15;  author: ejohnson;  state: Exp;  lines: +2 -3
branches:  1.14.2;
Added two more structure tests to Structure Manager code:
- smIsAllocatedStruct(SM,struct) checks whether a known valid struct is
    currently allocated wrt its SM.
- smIsAllocatedStructRef(SM,struct) combines the functionality of
    smIsValidStructRef() and smIsAllocatedStruct().
Also changed argument passing style of SM from pass-by-ref to pass-by value.

Added extra checks to TRIE_DELETE_RETURN builtin to ensure that (1)
leaf node is currently allocated, (2) that it is in fact a leaf, and
(3) that it appears in the answer set associated with the given
subgoal frame.
----------------------------
revision 1.13
date: 2000/07/31 20:27:56;  author: ejohnson;  state: Exp;  lines: +7 -7
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.12
date: 2000/07/14 16:19:13;  author: lfcastro;  state: Exp;  lines: +2 -2
* get_delay_lists is now obsolete (not exported anymore), and should
be substituted by get_returns_and_dls in user applications; this is in
order to hide erroneous dependencies between get_returns and
get_delay_lists from the user

* delete_return now eagerly reclaims space for deleted trie nodes; in
order to enforce that no choicepoints keep pointers to deleted answer
list nodes, the CP stack is inspected (in CHAT); before, only
choicepoints in the CHAT area were updated, and some choicepoints in
the stack could still have invalid pointers (this happened in
empty_answer.P, in the testsuite)
----------------------------
revision 1.11
date: 2000/06/27 17:59:16;  author: ejohnson;  state: Exp;  lines: +6 -5
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.10
date: 2000/06/22 01:27:51;  author: lfcastro;  state: Exp;  lines: +35 -33
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.9
date: 2000/05/29 04:23:37;  author: ejohnson;  state: Exp;  lines: +14 -12
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.8
date: 2000/05/25 00:32:01;  author: ejohnson;  state: Exp;  lines: +15 -14
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.7
date: 2000/04/29 21:53:58;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.6
date: 2000/02/24 19:44:15;  author: cbaoqiu;  state: Exp;  lines: +4 -4
branches:  1.6.2;
Minor changes to have the debugging messages printed in a nicer
format.
----------------------------
revision 1.5
date: 2000/02/15 07:45:09;  author: bartkul;  state: Exp;  lines: +3 -3
in testsuite.sh supertest.sh gctest.sh

changed testsuite.sh    into    ./testsuite.sh
        makexsb         into    ./makexsb
        configure       into    ./configure

in prolog_tests/c_calls_xsb_make.P

changed c_calls_xsb.exe into    ./c_calls_xsb.exe


in the c and h files: given check_glstack_overflow an extra argument

standard.O ... I have no idea
----------------------------
revision 1.4
date: 1999/12/22 19:05:02;  author: kostis;  state: Exp;  lines: +2 -2
Minor change.
----------------------------
revision 1.3
date: 1999/12/22 18:07:05;  author: warren;  state: Exp;  lines: +2 -2
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.2
date: 1999/10/27 03:06:58;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Minor change in a comment.
----------------------------
revision 1.1
date: 1999/10/25 05:59:20;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.6.2.3
date: 2000/09/13 18:41:12;  author: lfcastro;  state: Exp;  lines: +3 -2
Changes:

*Makefile
	- create target for 'make etags'

*emu/binding.h
	- got rid of #ifdef's on WAM_TRAIL

*emu/chat.c
	- commented out a switch_envs(breg) in
	  chat_restore_compl_susp_trail
	- introduced function chat_free_cp_compl_susp_chat_areas
	  needed for bugfix in cut_xsb.h
	- change in restore_answer_template

*emu/cut_xsb.h
	- bugfix in check_table_cut

*lib/Makefile
	- put '-g none' in calls to XSB to be able to compile when GC
	  isn't working

*general
	- changes/introduction in/of debug messages

Status:
Passes the testsuite for all tests, except for the gctests with the
copying collector, which fails for tests wfs_tests/p53 (and up).
----------------------------
revision 1.6.2.2
date: 2000/03/31 22:56:57;  author: lfcastro;  state: Exp;  lines: +2 -2
* some more cleanups of chat-related code
* started inserting code comments in a format suitable for automatic
generation of documents
* new version number (tentative)
----------------------------
revision 1.6.2.1
date: 2000/03/28 18:10:33;  author: lfcastro;  state: Exp;  lines: +8 -102
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.14.2.2
date: 2000/12/19 15:58:19;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.14.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +2 -2
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.22.2.2
date: 2004/10/18 20:46:09;  author: ruim;  state: Exp;  lines: +40 -126
update for version 2.6.1
----------------------------
revision 1.22.2.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +26 -6
Sources from rfm repository
----------------------------
revision 1.25.2.8
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +18 -2
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.25.2.7
date: 2003/04/17 17:11:40;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.25.2.6
date: 2003/02/11 18:36:16;  author: lfcastro;  state: Exp;  lines: +3 -3
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.25.2.5
date: 2002/08/29 14:17:13;  author: lfcastro;  state: Exp;  lines: +2 -2
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.25.2.4
date: 2002/08/10 00:19:35;  author: lfcastro;  state: Exp;  lines: +23 -7
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.25.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +72 -23
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.25.2.2
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +24 -73
* update to HEAD
----------------------------
revision 1.25.2.1
date: 2002/07/31 20:13:46;  author: lfcastro;  state: Exp;  lines: +73 -24
* demand_once/1 predicate cuts over tables, deleting incomplete tables
whose producer is in the scope of the "cut" (preliminary version)
----------------------------
revision 1.87.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.87.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +60 -1
no message
----------------------------
revision 1.87.2.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/slginsts_xsb_i.h.default,v
Working file: slginsts_xsb_i.h.default
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	latest_plus_supp: 1.3
keyword substitution: o
total revisions: 6;	selected revisions: 6
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: dead;  lines: +0 -0
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/socket_defs.h,v
Working file: socket_defs.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1
	without-attv: 1.1
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
----------------------------
revision 1.2
date: 1999/10/25 05:59:21;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1999/09/06 17:32:22;  author: kifer;  state: Exp;
Changes that enable XSB to work with GPP instead of CPP.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/socket_defs_xsb.h,v
Working file: socket_defs_xsb.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.3.0.14
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.3.12.1
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.3.12.1
	multi-threaded-25-engine: 1.3.0.12
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.10
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.8
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.6
	release_2_4: 1.3
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.4
	pre-threading: 1.3
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.3
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.9
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2005/01/14 18:31:31;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.4.4;
Integration of multithreaded system
----------------------------
revision 1.3
date: 1999/11/16 19:06:01;  author: kifer;  state: Exp;  lines: +10 -2
branches:  1.3.4;  1.3.12;
Revamped sockets interface.
----------------------------
revision 1.2
date: 1999/11/09 04:31:34;  author: kifer;  state: Exp;  lines: +6 -1
prelim steps for the integration socket_select
----------------------------
revision 1.1
date: 1999/10/25 05:59:21;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.12.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.3.4.2
date: 2000/12/19 15:58:19;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.4.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/socket_xsb.c,v
Working file: socket_xsb.c
head: 1.50
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.47
	ROLLBACK: 1.42
	latest_plus_supp_branch: 1.42.0.4
	latest_plus_supp: 1.42
	Version_3dot2_plus_supp: 1.42.0.2
	release_2_6_plus_supp: 1.25.0.4
	Version_3dot2: 1.42
	dec07-perf-results: 1.41
	mt_thesis: 1.37
	release_3_0: 1.35
	release_2_7_0: 1.27
	multi-threaded-26-engine: 1.24.6.2
	pre-mt: 1.27
	multi-threaded-25-engine-done: 1.24.6.1
	multi-threaded-25-engine: 1.24.0.6
	release_2_6_1: 1.25
	release_2_6_final: 1.25
	release_2_6: 1.25.0.2
	last-merged-to-demand: 1.25
	demand_branch: 1.24.0.4
	before_removing_chat: 1.24
	release_2_5: 1.24
	pre-merge-slgwam-gc: 1.24
	multi-threaded-c-engine: 1.24.0.2
	release_2_4: 1.24
	release_2_3: 1.21
	multi-threaded-engine: 1.20.0.2
	pre-threading: 1.18
	release-2-2: 1.11
	chat-and-local: 1.11.0.2
	xsb-pre-cleanup: 1.11
	release-2-1: 1.6
	release-2-0-1: 1.3
keyword substitution: kv
total revisions: 59;	selected revisions: 59
description:
----------------------------
revision 1.50
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +4 -4
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.49
date: 2011/05/22 15:12:25;  author: tswift;  state: Exp;  lines: +3 -3

Changes to fix compiler warnings on various Mac configurations.
----------------------------
revision 1.48
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +26 -26
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.47
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.46
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.45
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.44
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.43
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.42
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +2 -7
branches:  1.42.4;
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.41
date: 2007/08/18 22:15:28;  author: kifer;  state: Exp;  lines: +795 -777
Fixed a bug in SOCKET_SELECT.
Also, changed things a bit to allow XSB sockets to reseive messages from
datagram sockets (provided they obey the xsb higher level protocol).
Ultimately, we should add datagram-level socket calls.
----------------------------
revision 1.40
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +3 -3
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.39
date: 2007/07/22 10:12:32;  author: ruim;  state: Exp;  lines: +17 -1
added some error handling for sockets
----------------------------
revision 1.38
date: 2007/04/20 14:41:00;  author: tswift;  state: Exp;  lines: +3 -3

Made changes to several occurrences of ctop_string to avoid interning the string twice.  I only took the obvious cases, but there were several af them.  Probably at some point we should take a closer look at a few of them to make sure we aren't interning things unnecessarily, but this depends on understanding the actual uses in detail.
----------------------------
revision 1.37
date: 2006/11/04 00:53:00;  author: ruim;  state: Exp;  lines: +3 -3
Changed minimum pthread stack size to 512 K
Minimum pthread stack size in Linux was previously 10 M,
clearly an exageration
mttest suite breaks with a stack size of 64 K, passes with 128 K
took out some compilation warnings
----------------------------
revision 1.36
date: 2006/10/23 15:26:25;  author: ruim;  state: Exp;  lines: +16 -7
got MUTEX_SOCKET deeper in socket code
----------------------------
revision 1.35
date: 2005/12/22 23:33:58;  author: tswift;  state: Exp;  lines: +4 -4

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.34
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +11 -11
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.33
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +19 -16
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.32
date: 2005/09/20 22:51:38;  author: crued;  state: Exp;  lines: +6 -5
Fixed error in socket_put that was causing incorrect error values to be
returned.  The most common case was that TIMED_OUT was being returned
whenever a socket_put actually succeeded.
----------------------------
revision 1.31
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +7 -7
made private flags array for sequential engine
----------------------------
revision 1.30
date: 2005/07/08 14:55:31;  author: dwarren;  state: Exp;  lines: +13 -10
Fix bug under SOLARIS, due poor include ordering and undefined symbol.
(Maybe other systems than SOLARIS also need this symbol defined(?)
But found that XSB doesn't run on Solaris anymore, so......
----------------------------
revision 1.29
date: 2005/07/08 00:54:25;  author: dwarren;  state: Exp;  lines: +842 -805
Fixes to sockets for multi-threading, by Chris Rued.
----------------------------
revision 1.28
date: 2005/01/14 18:31:31;  author: ruim;  state: Exp;  lines: +87 -87
Integration of multithreaded system
----------------------------
revision 1.27
date: 2004/12/20 19:26:15;  author: dwarren;  state: Exp;  lines: +2 -2
hanged several int's to Integer's for safety.  There is more interest in
the 64-bit port, so I'd like to find the current bugs in it.  This might
be a start.
----------------------------
revision 1.26
date: 2004/02/02 20:29:48;  author: dwarren;  state: Exp;  lines: +3 -3
Change min and max macros to xsb_min and xsb_max to avoid name clash
as requested by a user.
----------------------------
revision 1.25
date: 2002/08/07 15:42:13;  author: lfcastro;  state: Exp;  lines: +9 -6
* do not use is_* functions (from the C interface) inside the
  emulator.
----------------------------
revision 1.24
date: 2001/06/29 21:03:29;  author: kifer;  state: Exp;  lines: +3 -2
branches:  1.24.4;  1.24.6;
took care of the time.h/ sys/time.h problem.
----------------------------
revision 1.23
date: 2001/03/27 22:59:31;  author: dwarren;  state: Exp;  lines: +2 -2
modifications to configure (and a couple of other files) to support
the no-cygwin option to compile to a native windows executable usgin
cygwin's gcc compiler.  This allows XSB to use the jump-table
capabilities of gcc (for efficiency) without needing cygwin to
execute.
----------------------------
revision 1.22
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +21 -21
improved error messages
----------------------------
revision 1.21
date: 2000/12/01 07:29:14;  author: kifer;  state: Exp;  lines: +11 -11
replaced 0/1 with true/false
----------------------------
revision 1.20
date: 2000/09/27 02:25:02;  author: kifer;  state: Exp;  lines: +6 -3
branches:  1.20.2;
added
#undef __STRICT_ANSI__
to avoid errors under cygwin
----------------------------
revision 1.19
date: 2000/06/23 20:54:08;  author: ruim;  state: Exp;  lines: +3 -3
Removed some C++ automatic pointer casting warnings
----------------------------
revision 1.18
date: 2000/06/06 03:13:55;  author: kifer;  state: Exp;  lines: +57 -39
added timeouts to socket accept. other improvements
----------------------------
revision 1.17
date: 2000/05/31 16:46:59;  author: kifer;  state: Exp;  lines: +10 -8
fixed a problem with the timeout setup.
----------------------------
revision 1.16
date: 2000/05/31 06:14:03;  author: kifer;  state: Exp;  lines: +49 -18
fixed buglets in socket_select
----------------------------
revision 1.15
date: 2000/05/25 23:23:05;  author: kifer;  state: Exp;  lines: +11 -11
removed unnecessary casts
----------------------------
revision 1.14
date: 2000/05/22 05:48:06;  author: kifer;  state: Exp;  lines: +429 -323
enabled socket timeout on windows
----------------------------
revision 1.13
date: 2000/05/20 06:56:07;  author: kifer;  state: Exp;  lines: +6 -6
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.12
date: 2000/04/29 21:53:58;  author: kifer;  state: Exp;  lines: +8 -8
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.11
date: 2000/01/07 08:51:50;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.10
date: 1999/12/22 18:07:07;  author: warren;  state: Exp;  lines: +3 -2
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.9
date: 1999/12/10 07:47:37;  author: kifer;  state: Exp;  lines: +1 -2
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.8
date: 1999/12/06 06:20:23;  author: kifer;  state: Exp;  lines: +11 -3
added the reuse_address option
----------------------------
revision 1.7
date: 1999/12/02 17:24:02;  author: kostis;  state: Exp;  lines: +2 -6
Eliminated warning when compiling wth Sun CC.
----------------------------
revision 1.6
date: 1999/11/17 03:54:34;  author: kifer;  state: Exp;  lines: +6 -8
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.5
date: 1999/11/16 20:39:14;  author: kifer;  state: Exp;  lines: +4 -1
(Now hopefully) Fixed the include files for the latest gcc
----------------------------
revision 1.4
date: 1999/11/16 19:06:01;  author: kifer;  state: Exp;  lines: +573 -169
Revamped sockets interface.
----------------------------
revision 1.3
date: 1999/11/09 04:31:35;  author: kifer;  state: Exp;  lines: +31 -7
prelim steps for the integration socket_select
----------------------------
revision 1.2
date: 1999/10/26 06:47:25;  author: kifer;  state: Exp;  lines: +2 -2
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:59:22;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.20.2.2
date: 2000/12/19 15:58:19;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.20.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +79 -8
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.24.6.2
date: 2004/10/18 20:46:10;  author: ruim;  state: Exp;  lines: +9 -6
update for version 2.6.1
----------------------------
revision 1.24.6.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +87 -87
Sources from rfm repository
----------------------------
revision 1.24.4.2
date: 2003/04/17 17:11:40;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.24.4.1
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +9 -6
* update to HEAD
----------------------------
revision 1.42.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.42.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.42.4.1
date: 2010/06/19 19:36:20;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/socket_xsb.h,v
Working file: socket_xsb.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.10
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	release_2_6_plus_supp: 1.2.0.14
	Version_3dot2: 1.5
	dec07-perf-results: 1.5
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.12.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.12.1
	multi-threaded-25-engine: 1.2.0.12
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.10
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.8
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.6
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
----------------------------
revision 1.11
date: 2011/05/16 01:03:30;  author: kifer;  state: Exp;  lines: +5 -1
squash warnings on windows and linux
----------------------------
revision 1.10
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.9
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2007/08/18 22:06:48;  author: kifer;  state: Exp;  lines: +2 -1
branches:  1.5.4;
added another error condition
----------------------------
revision 1.4
date: 2005/07/08 00:54:25;  author: dwarren;  state: Exp;  lines: +36 -7
Fixes to sockets for multi-threading, by Chris Rued.
----------------------------
revision 1.3
date: 2005/01/14 18:31:31;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.2
date: 1999/11/16 19:06:02;  author: kifer;  state: Exp;  lines: +14 -2
branches:  1.2.4;  1.2.12;
Revamped sockets interface.
----------------------------
revision 1.1
date: 1999/10/25 05:59:23;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2.12.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.2.4.2
date: 2000/12/19 15:58:19;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.4.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/sp_unify.i,v
Working file: sp_unify.i
head: 1.4
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.3
	without-attv: 1.3
	release-2-0: 1.3
	pre-release-2-0: 1.2
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 5;	selected revisions: 5
description:
----------------------------
revision 1.4
date: 1999/10/25 05:59:24;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3
date: 1999/06/23 19:50:50;  author: kostis;  state: Exp;  lines: +11 -20
Changes to speed up definition and use of specialized unification.
----------------------------
revision 1.2
date: 1999/04/22 06:49:21;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/sp_unify_xsb_i.h,v
Working file: sp_unify_xsb_i.h
head: 1.10
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.3.0.12
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.3.10.1
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.3.10.1
	multi-threaded-25-engine: 1.3.0.10
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.8
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.6
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.4
	release_2_4: 1.3
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.2
	pre-threading: 1.3
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.10
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +4 -2
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.9
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2005/01/14 18:31:31;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.4.4;
Integration of multithreaded system
----------------------------
revision 1.3
date: 2000/04/29 21:53:58;  author: kifer;  state: Exp;  lines: +7 -7
branches:  1.3.2;  1.3.10;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.2
date: 1999/12/10 07:47:38;  author: kifer;  state: Exp;  lines: +3 -3
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.1
date: 1999/10/25 05:59:25;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.10.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +3 -3
Sources from rfm repository
----------------------------
revision 1.3.2.2
date: 2000/12/19 15:58:19;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +9 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/sql.h,v
Working file: sql.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	release_2_6_plus_supp: 1.1.0.10
	multi-threaded-26-engine: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.8
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.6
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.4
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
	release_2_4: 1.1
	release_2_3: 1.1
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
----------------------------
revision 1.2
date: 2003/09/28 22:22:13;  author: kifer;  state: dead;  lines: +0 -0
moved sql*h to build/odbc.
Now configure copies them to windows-specific config/x86-pc-windows/
----------------------------
revision 1.1
date: 2001/01/29 22:59:31;  author: dwarren;  state: Exp;
Updates to allow ODBC interface to be compiled under cygwin on Windows.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/sqlext.h,v
Working file: sqlext.h
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	release_2_6_plus_supp: 1.2.0.10
	multi-threaded-26-engine: 1.2
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.8
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.6
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.4
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.2
	release_2_4: 1.1
	release_2_3: 1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.3
date: 2003/09/28 22:22:13;  author: kifer;  state: dead;  lines: +0 -0
moved sql*h to build/odbc.
Now configure copies them to windows-specific config/x86-pc-windows/
----------------------------
revision 1.2
date: 2001/08/08 15:08:04;  author: dwarren;  state: Exp;  lines: +1 -1
Fix bug in proc prototype decl.
----------------------------
revision 1.1
date: 2001/01/29 22:59:31;  author: dwarren;  state: Exp;
Updates to allow ODBC interface to be compiled under cygwin on Windows.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/sqltypes.h,v
Working file: sqltypes.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	release_2_6_plus_supp: 1.1.0.10
	multi-threaded-26-engine: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.8
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.6
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.4
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
	release_2_4: 1.1
	release_2_3: 1.1
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
----------------------------
revision 1.2
date: 2003/09/28 22:22:13;  author: kifer;  state: dead;  lines: +0 -0
moved sql*h to build/odbc.
Now configure copies them to windows-specific config/x86-pc-windows/
----------------------------
revision 1.1
date: 2001/01/29 22:59:31;  author: dwarren;  state: Exp;
Updates to allow ODBC interface to be compiled under cygwin on Windows.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/std_cases.i,v
Working file: std_cases.i
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.5
	release-2-0: 1.3
keyword substitution: kv
total revisions: 6;	selected revisions: 6
description:
----------------------------
revision 1.6
date: 1999/10/25 05:59:26;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5
date: 1999/09/25 16:34:24;  author: kifer;  state: Exp;  lines: +12 -7
Implemented atom/number_chars correctly. Added number digits.
----------------------------
revision 1.4
date: 1999/08/17 19:30:06;  author: warren;  state: Exp;  lines: +4 -1
convert dynamic P/A to dynamic p(_,_,..), added new builtin
is_most_general_term to return true if given a term with all distinct
variables as subfields.
----------------------------
revision 1.3
date: 1999/04/28 18:30:23;  author: kifer;  state: Exp;  lines: +2 -2
Added the regmatch package.
----------------------------
revision 1.2
date: 1999/04/27 17:20:53;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changed the file name in the header to std_cases.i.
----------------------------
revision 1.1
date: 1999/04/27 14:39:49;  author: kifer;  state: Exp;
Made large builtins in the former std_pred.i into inlined subroutines.
Added atom_codes, number_codes and made atom_chars, number_chars into
synonyms to the *_codes builtins.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/std_cases_xsb_i.h,v
Working file: std_cases_xsb_i.h
head: 1.37
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.27
	ROLLBACK: 1.22
	latest_plus_supp_branch: 1.22.0.2
	latest_plus_supp: 1.22
	Version_3dot2_plus_supp: 1.21.0.2
	release_2_6_plus_supp: 1.6.0.4
	Version_3dot2: 1.21
	dec07-perf-results: 1.19
	mt_thesis: 1.18
	release_3_0: 1.17
	release_2_7_0: 1.8
	multi-threaded-26-engine: 1.4.6.2
	pre-mt: 1.8
	multi-threaded-25-engine-done: 1.4.6.1
	multi-threaded-25-engine: 1.4.0.6
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.2
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.4
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.2
	release_2_4: 1.4
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.2
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 46;	selected revisions: 46
description:
----------------------------
revision 1.37
date: 2012/02/24 21:06:49;  author: dwarren;  state: Exp;  lines: +2 -2
Minor changes to make ANSI, and quiet compiler.
Changed tempnam to _tempnam, which is current posix, it says.
----------------------------
revision 1.36
date: 2012/02/05 16:44:58;  author: tswift;  state: Exp;  lines: +2 -2

Added ground_and_acyclic/1.
----------------------------
revision 1.35
date: 2011/12/19 21:40:25;  author: waltergwilson;  state: Exp;  lines: +7 -1
ground_cyc/1
----------------------------
revision 1.34
date: 2011/11/04 23:21:10;  author: tswift;  state: Exp;  lines: +26 -21

is_acyclic/1.
----------------------------
revision 1.33
date: 2011/10/09 19:41:13;  author: waltergwilson;  state: Exp;  lines: +6 -1
term_size_limit/2
----------------------------
revision 1.32
date: 2011/10/05 19:15:34;  author: waltergwilson;  state: Exp;  lines: +6 -1
term_size/2
----------------------------
revision 1.31
date: 2011/08/13 19:56:20;  author: tswift;  state: Exp;  lines: +6 -1

is_cyclic + fix to weird bug with not initializaing memory errors...
----------------------------
revision 1.30
date: 2011/08/04 19:52:57;  author: tswift;  state: Exp;  lines: +6 -2


term_depth/1
----------------------------
revision 1.29
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +7 -7
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.28
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.27
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.26
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.25
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2010/04/08 06:45:24;  author: evansbj;  state: Exp;  lines: +2 -2
branches:  1.22.2;
A similar example of losing the high order bits in 64 bit mode, should never be a problem, but just in case...
----------------------------
revision 1.21
date: 2009/03/14 22:04:47;  author: tswift;  state: Exp;  lines: +2 -2

Very minor changes to shut up the compiler.
----------------------------
revision 1.20
date: 2008/02/21 20:57:50;  author: tswift;  state: Exp;  lines: +1 -3

Changes to optimize call/1 for atomic predicates (e.g. not ,/2 ;/2 etc.

Also, tweaked an error message for atom_chars/codes
----------------------------
revision 1.19
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +5 -5

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.18
date: 2006/09/01 13:04:40;  author: dwarren;  state: Exp;  lines: +12 -0
Add warning messages when var, nonvar,... builtins are called, since
these should not be called anymore now that they are inlined by the
compiler.  The entire cases should come out at some point if these messages
never show up.
----------------------------
revision 1.17
date: 2006/01/27 17:50:19;  author: dwarren;  state: Exp;  lines: +3 -15
Added a new instruction to implement unary tests that don't change
the XWAM state.  Examples are integer/1, atom/1, etc.  The compiler
is changed to use these instructions to avoid laying down a choicepoint
in a conditional, and they are used for regular inline calls.
----------------------------
revision 1.16
date: 2005/12/12 18:44:53;  author: dwarren;  state: Exp;  lines: +1 -13
Added string table garbage collection.
----------------------------
revision 1.15
date: 2005/09/28 13:37:04;  author: dwarren;  state: Exp;  lines: +2 -2
Fix bug in atomic, introduced with boxedfloats, and pointed out by M.Kifer.
----------------------------
revision 1.14
date: 2005/09/02 20:43:13;  author: tswift;  state: Exp;  lines: +3 -3

Fix to abolish_table_xxx and gc_tables to work when stacks are frozen;
and made creation of DelTF frames thread-safe.  Also, got a little
further towards reclaiming retracted clauses.

----------------------------------------------------------------------
builtin.c emuloop.c extensions_xsb.h inst_xsb.h CVS: std_cases_xsb_i.h
tr_utils.c xsb_inst_list.h CVS:
----------------------------------------------------------------------
----------------------------
revision 1.13
date: 2005/09/01 18:37:06;  author: tswift;  state: Exp;  lines: +13 -3


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.12
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +3 -3
made private flags array for sequential engine
----------------------------
revision 1.11
date: 2005/08/06 16:29:54;  author: tswift;  state: Exp;  lines: +4 -1

Added check of Choice point stack to abolish_all_tables to ensure that it contains no choice points for completed tables.  Also, added some stubs for gc_clauses.
----------------------------
revision 1.10
date: 2005/07/18 21:54:11;  author: crojo;  state: Exp;  lines: +20 -18
*** empty log message ***
----------------------------
revision 1.9
date: 2005/01/14 18:31:31;  author: ruim;  state: Exp;  lines: +29 -29
Integration of multithreaded system
----------------------------
revision 1.8
date: 2004/09/29 21:41:56;  author: dwarren;  state: Exp;  lines: +16 -4
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.7
date: 2003/11/11 19:40:25;  author: dwarren;  state: Exp;  lines: +6 -1
Added new sorting predicate: parsort, which takes a more complicated
sorting specification and supports ascending, descending sort on
subfileds of terms.  It generalizes both sort and keysort (which have
not been changed.)  See manual1 (comparison) for details.
----------------------------
revision 1.6
date: 2002/10/07 15:20:45;  author: dwarren;  state: Exp;  lines: +8 -7
Updates to Prolog builtins to allow boxedintegers to be handled correctly.
----------------------------
revision 1.5
date: 2002/10/04 20:42:02;  author: lfcastro;  state: Exp;  lines: +5 -3
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.4
date: 2001/03/23 03:51:41;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.4.4;  1.4.6;
replaced numeric consts with symbolic constants
----------------------------
revision 1.3
date: 2000/08/05 07:59:23;  author: cbaoqiu;  state: Exp;  lines: +3 -1
branches:  1.3.2;
Introduced a new inline builtin: is_attv/1.
----------------------------
revision 1.2
date: 1999/10/29 14:29:05;  author: kostis;  state: Exp;  lines: +21 -16
Many changes to define variables in smallest possible block that they are
used.  There is a *significant* speedup potential by doing so.  I will,
hopefully soon, write a mail about this.
----------------------------
revision 1.1
date: 1999/10/25 05:59:27;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3.2.2
date: 2000/12/19 15:58:19;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.6.2
date: 2004/10/18 20:46:10;  author: ruim;  state: Exp;  lines: +12 -9
update for version 2.6.1
----------------------------
revision 1.4.6.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +28 -28
Sources from rfm repository
----------------------------
revision 1.4.4.2
date: 2003/04/17 17:11:39;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.4.4.1
date: 2002/10/28 16:49:31;  author: lfcastro;  state: Exp;  lines: +12 -9
* Merge with HEAD
----------------------------
revision 1.22.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.22.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.22.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/std_pred.i,v
Working file: std_pred.i
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.13
	without-attv: 1.11
	release-2-0: 1.10
	pre-release-2-0: 1.6
	v1-9-8: 1.4
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.2
	r1-9-b6: 1.2
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.14
date: 1999/10/25 05:59:28;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.13
date: 1999/10/11 19:08:26;  author: warren;  state: Exp;  lines: +27 -5
use expandable buffer instead of heap for the atom of
atom_codes/chars.  Also added check for enough space for list of chars
with call to garbage collector.
----------------------------
revision 1.12
date: 1999/10/11 15:43:05;  author: kostis;  state: Exp;  lines: +2 -1
Clean up changes and changes to make variables used in the smallest possible
enclosing block.  This last step is still incomplete, however, it is a good
first step.
----------------------------
revision 1.11
date: 1999/09/25 16:34:25;  author: kifer;  state: Exp;  lines: +106 -41
Implemented atom/number_chars correctly. Added number digits.
----------------------------
revision 1.10
date: 1999/06/23 19:50:51;  author: kostis;  state: Exp;  lines: +5 -1
Changes to speed up definition and use of specialized unification.
----------------------------
revision 1.9
date: 1999/04/30 15:53:30;  author: kifer;  state: Exp;  lines: +2 -2
Changed so that when foreign function returns 0 then the corresponding
xsb predicate will fail.
----------------------------
revision 1.8
date: 1999/04/28 18:30:24;  author: kifer;  state: Exp;  lines: +2 -2
Added the regmatch package.
----------------------------
revision 1.7
date: 1999/04/27 14:39:49;  author: kifer;  state: Exp;  lines: +484 -465
Made large builtins in the former std_pred.i into inlined subroutines.
Added atom_codes, number_codes and made atom_chars, number_chars into
synonyms to the *_codes builtins.
----------------------------
revision 1.6
date: 1999/04/22 06:49:22;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.5
date: 1999/04/01 05:03:11;  author: kifer;  state: Exp;  lines: +1 -10
Replaced fmt_ builtins with formatted_io().
The fmt_* builtins now hang off of that.
----------------------------
revision 1.4
date: 1998/12/21 01:08:50;  author: cbaoqiu;  state: Exp;  lines: +1 -1
Kostis' changes for GC and CHAT.
----------------------------
revision 1.3
date: 1998/12/17 16:58:19;  author: kostis;  state: Exp;  lines: +2 -1
Fixed problem with univ. - Kostis.
----------------------------
revision 1.2
date: 1998/11/14 05:05:28;  author: kifer;  state: Exp;  lines: +2 -2
djusted casts because now bool is typedef short, for NT compatibility.
----------------------------
revision 1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:22;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/std_pred_xsb_i.h,v
Working file: std_pred_xsb_i.h
head: 1.85
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.53
	ROLLBACK: 1.48
	latest_plus_supp_branch: 1.48.0.2
	latest_plus_supp: 1.48
	Version_3dot2_plus_supp: 1.45.0.2
	release_2_6_plus_supp: 1.14.0.4
	Version_3dot2: 1.45
	dec07-perf-results: 1.38
	mt_thesis: 1.36
	release_3_0: 1.34
	release_2_7_0: 1.20
	multi-threaded-26-engine: 1.12.6.2
	pre-mt: 1.20
	multi-threaded-25-engine-done: 1.12.6.1
	multi-threaded-25-engine: 1.12.0.6
	release_2_6_1: 1.14.2.1
	release_2_6_final: 1.14
	release_2_6: 1.14.0.2
	last-merged-to-demand: 1.12
	demand_branch: 1.12.0.4
	before_removing_chat: 1.12
	release_2_5: 1.12
	pre-merge-slgwam-gc: 1.12
	multi-threaded-c-engine: 1.12.0.2
	release_2_4: 1.9
	release_2_3: 1.8
	multi-threaded-engine: 1.8.0.2
	pre-threading: 1.7
	release-2-2: 1.5
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 97;	selected revisions: 97
description:
----------------------------
revision 1.85
date: 2012/02/05 16:44:58;  author: tswift;  state: Exp;  lines: +6 -4

Added ground_and_acyclic/1.
----------------------------
revision 1.84
date: 2011/12/26 19:27:25;  author: tswift;  state: Exp;  lines: +8 -15

1) Fix to memory allocation/deallacation in ground_or_cyclic/1

2) When running out of space for pdlstack we abort rather than exiting.
----------------------------
revision 1.83
date: 2011/12/24 20:45:12;  author: tswift;  state: Exp;  lines: +3 -5

Fix for n2c for MT XSB + fixed some MT compiler errors
----------------------------
revision 1.82
date: 2011/12/23 22:42:18;  author: tswift;  state: Exp;  lines: +6 -6

Fixes for MT compilation.
----------------------------
revision 1.81
date: 2011/12/19 21:40:39;  author: waltergwilson;  state: Exp;  lines: +71 -1
ground_cyc/1
----------------------------
revision 1.80
date: 2011/12/11 23:07:25;  author: dwarren;  state: Exp;  lines: +32 -22
A number of changes to fix bugs and make XSB more ISO compliant (from U.Neumerkel)
1. Made length/2 slightly more resiliant.
2. Added a cyclic term check in atom_codes.
3. fixed bug in call/n to non-existent predicate
4. Added new operators (for ISO): ^, div, xor (and changed ** to always return float.)
5. Added new ISO predicate names: acyclic_term, and subsumes_term.
6. Made number_codes/chars more ISO compliant (mostly on unusual inputs)
7. Increased precision of floating point numbers in write_canonical.
8. Added cputime to load message (if > 0.0 secs), desired by MK
9. Support reading and writing of 0-ary predicates in form p().  (This is not
	fully implemented and should not in general be used.)
----------------------------
revision 1.79
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +3 -38

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.78
date: 2011/11/25 21:42:54;  author: dwarren;  state: Exp;  lines: +4 -3
Fix bug I introduced in using unify to make the binding (to make unify_occurs_check_flag work right.)
----------------------------
revision 1.77
date: 2011/11/23 14:31:57;  author: dwarren;  state: Exp;  lines: +6 -5
Fixed a couple of minor bugs in unify-with-occurs-check code.
----------------------------
revision 1.76
date: 2011/11/11 18:21:39;  author: dwarren;  state: Exp;  lines: +1 -37
Added flag[UNIFY_WITH_OCCURS_CHECK_FLAG] that when true causes XSB
to do all unifications with occur_check.  (Not completely tested, and
better efficiency is possible by having compiler generate different
bldval instructions when it can determine that occur-check isn't needed.)
----------------------------
revision 1.75
date: 2011/11/06 20:30:42;  author: tswift;  state: Exp;  lines: +15 -17

Optimized is_cyclic by taking out a malloc()
----------------------------
revision 1.74
date: 2011/11/05 15:11:20;  author: tswift;  state: Exp;  lines: +2 -2

emuloop -- optional FAIL_ON_CYCLES
std_pred_xsb_i.h -- fixed a stupid bug!
----------------------------
revision 1.73
date: 2011/11/04 15:31:07;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed bug in compound/1 so now fails on boxed ints and floats.
----------------------------
revision 1.72
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +3 -3

Integrating in Call Abstraction
----------------------------
revision 1.71
date: 2011/10/10 18:59:22;  author: dwarren;  state: Exp;  lines: +5 -4
Moved a decl to beginning of block so MSVC will compile it.
----------------------------
revision 1.70
date: 2011/10/10 01:14:21;  author: waltergwilson;  state: Exp;  lines: +9 -4
fix memory leak in term_depth/2
----------------------------
revision 1.69
date: 2011/10/09 19:40:45;  author: waltergwilson;  state: Exp;  lines: +106 -8
term_size_limit/2
----------------------------
revision 1.68
date: 2011/10/05 19:15:02;  author: waltergwilson;  state: Exp;  lines: +40 -4
term_size/2
----------------------------
revision 1.67
date: 2011/09/28 21:14:51;  author: dwarren;  state: Exp;  lines: +32 -26
1. Fixed a bug in unify_with_occurs_check for structures, and modified code
to use a tail-recursion optimization (here and in not_occurs_in, too) in
C with a goto.
2. Fixed timed_call setup for Windows.  It seems to work on windows now.
3. Minor spacing change in statistics printout, which makes it look better
to me...
----------------------------
revision 1.66
date: 2011/09/28 16:32:15;  author: tswift;  state: Exp;  lines: +3 -1

Fixed bug in uwoc.
----------------------------
revision 1.65
date: 2011/08/22 16:15:24;  author: dwarren;  state: Exp;  lines: +4 -3
Cleaned up recent checkins to work with MSVC, and avoid warnings.
(Changed bzero to memset, since MS seems not to have bzero.)
Also changed a couple of builtins to be more consistent in their
treatment of string p vs. 0-ary structure symbol p.
----------------------------
revision 1.64
date: 2011/08/15 15:10:25;  author: dwarren;  state: Exp;  lines: +3 -2
Minor changes to quiet 64-bit compilation (or use 64-bit compatible decls).
Minor change to tokenizer to make it more standardish(?) for \NUM form.
One decl moved to work with ANSI C (MSVC).
----------------------------
revision 1.63
date: 2011/08/13 19:56:20;  author: tswift;  state: Exp;  lines: +130 -1

is_cyclic + fix to weird bug with not initializaing memory errors...
----------------------------
revision 1.62
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +4 -4
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.61
date: 2011/08/04 20:49:51;  author: tswift;  state: Exp;  lines: +23 -23

Oops -- had to make a change to avoid a name conflict for the MT engine.
----------------------------
revision 1.60
date: 2011/08/04 19:52:57;  author: tswift;  state: Exp;  lines: +115 -1


term_depth/1
----------------------------
revision 1.59
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +6 -13
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.58
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +18 -17
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.57
date: 2011/05/08 18:59:45;  author: tswift;  state: Exp;  lines: +3 -2

Fixed core dump when length of list is > max_arity in univ.
----------------------------
revision 1.56
date: 2011/03/23 15:45:19;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed bug in interprolog_callback in reuse and deallocation of a byte buffer.
Now interprolog works on Windows 7.
Added missing deref to std_pred_xsb_i.h
Added condition on definition of fileno, so avoid redefinition warnings.
----------------------------
revision 1.55
date: 2011/02/14 20:47:32;  author: dwarren;  state: Exp;  lines: +3 -2
Added missing deref, and change bind_int to bind_oint to support full
32-bit integers in number_codes(and friends).
----------------------------
revision 1.54
date: 2011/02/11 15:08:03;  author: tswift;  state: Exp;  lines: +2 -2

Fixes for attributed variable bug (typo fix) and fix for atom_codes
when it encounters a 0-ary predicate.
----------------------------
revision 1.53
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.52
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.51
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.50
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.49
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.48
date: 2010/04/08 06:06:07;  author: evansbj;  state: Exp;  lines: +4 -3
branches:  1.48.2;
Fixed a small problem with a rare situation where bad arguments are passed to functor/3.
----------------------------
revision 1.47
date: 2009/05/05 14:21:18;  author: dwarren;  state: Exp;  lines: +3 -3
Move assignment to ctail out of if, so is defined for later use.
(Thanks, MSVC.)  [But it seems that we check outside and do not
allow X =.. [5] to get here, which the lower level code would
interprets as X = 5.  Was the ISO standard the reason for this change?]
----------------------------
revision 1.46
date: 2009/04/24 21:30:46;  author: dwarren;  state: Exp;  lines: +17 -16
Fixed deref bug in univ.  Someone (me?) was dereffing the actually memory location
in the heap, instead of a copy.  This can mess up untrailing, and did in this
case.  (I noticed other uses of deref in trie-code which looks a little suspicious
to me, where dereffing is done to *reg_arrayptr.  But there is code there I don't
quite understand, so I didn't try to modify it.  It may or may not be a problem.)
----------------------------
revision 1.45
date: 2009/03/14 22:04:47;  author: tswift;  state: Exp;  lines: +4 -4

Very minor changes to shut up the compiler.
----------------------------
revision 1.44
date: 2008/11/06 00:05:16;  author: tswift;  state: Exp;  lines: +13 -9


These changes started when I needed to use name/2 on some input
that had characters that are not ASCII printable.  Name was
throwing an exception, and it is better for it not to, as such
cnaracters are becoming more popular in the sort of text we have
to handle.

This should have been a simple fix, but when I started looking at
name, I noticed that it had quite archaic code that I got rid of.
name/2 should now be faster -- and its errors more consistent
with atom_ and number_codes.

Speaking of errors, I also went through the ISO manual and made
XSB's code and manual reflect the error handling for
atom_codes/2, atom_chars/2, number_codes/2 and number_chars/2.
In addition, I tweaked errors for number_digits/2 and of course
name/2.  This led to some tweaks in error functions as well.

The one difference is that to conform with ISO specs,
number_chars/2 now throws an error if it cant make its list into
a number -- rather than failing as before.

So the simple fix somehow took me all afternoon.

Terry
----------------------------
revision 1.43
date: 2008/09/05 22:08:47;  author: tswift;  state: Exp;  lines: +16 -9
A user rightly complained about error messages in univ.  I
restructured univ code a little so that our error reporting for
univ is ISO-compliant (well, almost).  To do this, I had to
create a function xsb_representation_error().

Univ documentation in the manual was also very out of date, so I
updated that.
----------------------------
revision 1.42
date: 2008/02/21 20:57:50;  author: tswift;  state: Exp;  lines: +3 -3

Changes to optimize call/1 for atomic predicates (e.g. not ,/2 ;/2 etc.

Also, tweaked an error message for atom_chars/codes
----------------------------
revision 1.41
date: 2008/01/02 19:47:43;  author: dwarren;  state: Exp;  lines: +12 -1
Fix (or at least greatly improve) the C-calling-XSB (recursively) interface for
the multi-threaded engine.  There is still an issue with multiple calls of
different C threads, but sharing the same th-context.  But I think the problem
is in more than just this interface.
----------------------------
revision 1.40
date: 2007/12/24 19:16:59;  author: tswift;  state: Exp;  lines: +4 -2

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.39
date: 2007/12/22 22:04:36;  author: tswift;  state: Exp;  lines: +10 -4

Updated arg/3 so that it accords with the ISO semantics:

1) it now throws a type error, rather than failing, if the second
   argument is not a compound term

2) it now throws a domain error, rather than failing, if the
   first argument is less than 0.
----------------------------
revision 1.38
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +41 -40

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.37
date: 2007/01/17 17:41:20;  author: tswift;  state: Exp;  lines: +24 -5

 Changed sorting functions so that they just use area from the
 stack in the case of short lists and so avoid a malloc.  For
 applications that use sorting heavily (e.g. set-based analysis), this
 greately improves scalability for the MT engine, and should improve
 speed a little for single threade applications as well.
----------------------------
revision 1.36
date: 2006/10/18 17:12:37;  author: dwarren;  state: Exp;  lines: +6 -13
Remove unnecessary ATOM_BUFF mutex, and fix memory allocation for atom_to_list.
----------------------------
revision 1.35
date: 2006/08/20 18:58:08;  author: tswift;  state: Exp;  lines: +27 -16

Fixed problems with lists in unify_with_occurs_check.
----------------------------
revision 1.34
date: 2006/06/22 18:54:10;  author: dwarren;  state: Exp;  lines: +1 -1
Fixed a bug in arg in its treatment of boxed ints and floats in the 2nd position.
----------------------------
revision 1.33
date: 2006/05/22 23:57:17;  author: tswift;  state: Exp;  lines: +1 -1

Unify with occurs check: third time's the charm.
----------------------------
revision 1.32
date: 2006/05/22 23:30:51;  author: tswift;  state: Exp;  lines: +9 -5

Copied wrong code when reconstructing for new CVS.
----------------------------
revision 1.31
date: 2006/05/22 20:47:45;  author: tswift;  state: Exp;  lines: +89 -1

Prolog code for unify_with_occur_check

In addition, fixed bug in batched evaluation that I believe is of long standing.

In the batched fixed point, a subgoal S may be checked for fixed
point even if it has been completed and its answer return lists
have been reclaimed.  This doesn't usually happen but can if S is
the leader of the ASCC.  In such a case, the fixed point check
traverses each consumer choice point for S and determines whether
all answers have been returned to the choice point.  However, if
the answer return list for S has been reclaimed and its space
reused, the fixpoint check may mistakenly think that an answer
has not been returned to the choice point -- a dangerous situation.

The fix is simple -- a check for reclamation of the subgoal.  The
check will also be made for local evaluation, even though it
won't be needed there.
----------------------------
revision 1.30
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +10 -10
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.29
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +4 -4


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.28
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +12 -13
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.27
date: 2005/10/13 14:25:28;  author: dwarren;  state: Exp;  lines: +7 -1
Add documentation saying why the special qsort0 is needed in multi-threaded engine.
----------------------------
revision 1.26
date: 2005/07/24 18:51:39;  author: dwarren;  state: Exp;  lines: +2 -2
Allow desc and sort specification (type check didn't account for it.)
----------------------------
revision 1.25
date: 2005/07/22 15:42:17;  author: crojo;  state: Exp;  lines: +2 -2

Made double floating point numbers the default. Single precision floats can be reverted to with the configure option --enable-fast-floats
----------------------------
revision 1.24
date: 2005/07/18 21:54:11;  author: crojo;  state: Exp;  lines: +12 -9
*** empty log message ***
----------------------------
revision 1.23
date: 2005/07/11 17:00:33;  author: dwarren;  state: Exp;  lines: +17 -17
Made parsort thread-safe.
----------------------------
revision 1.22
date: 2005/05/13 21:16:52;  author: dwarren;  state: Exp;  lines: +3 -3
Fixed bug in error handling (seen in type error to parsort).  Checked for
null culprit.  Also improved error message for parsort error, to include offending
term.
----------------------------
revision 1.21
date: 2005/01/14 18:31:32;  author: ruim;  state: Exp;  lines: +197 -100
Integration of multithreaded system
----------------------------
revision 1.20
date: 2004/08/10 22:37:08;  author: tswift;  state: Exp;  lines: +27 -34

Main change was to introduce a new function xsb_type_error to create an ISO type-error from
C.  I replaced a few uses of err_handle, and then substituted the new function for the TYPE
case of err_handle.
----------------------------
revision 1.19
date: 2004/03/18 16:26:01;  author: dwarren;  state: Exp;  lines: +3 -1
Fixed bug in univ, when constructing a term that is a list, by adding derefs.
----------------------------
revision 1.18
date: 2003/11/11 20:55:07;  author: dwarren;  state: Exp;  lines: +9 -6
Fix buglet in parsort of not handling list terms correctly.
----------------------------
revision 1.17
date: 2003/11/11 19:40:25;  author: dwarren;  state: Exp;  lines: +140 -1
Added new sorting predicate: parsort, which takes a more complicated
sorting specification and supports ascending, descending sort on
subfileds of terms.  It generalizes both sort and keysort (which have
not been changed.)  See manual1 (comparison) for details.
----------------------------
revision 1.16
date: 2003/07/30 17:44:22;  author: dwarren;  state: Exp;  lines: +7 -5
Added new builtin in machine: term_new_mod(+Mod,+Term,-TermInMod), which
creates a term whose main functor symbol has the same name and arity as
Term, but is in module Mod, and the arguments are the arguments of Term.
The new functor symbol is assumed to be a predicate, and set to be imported
from Mod, if it's not already loaded.  We may want another parameter if we
want to build function symbols, and not predicates, in the new module.
----------------------------
revision 1.15
date: 2003/07/07 16:54:55;  author: lfcastro;  state: Exp;  lines: +7 -3
* Fix number_codes to deal with boxed integers. Necessary for using java1.4.2.
----------------------------
revision 1.14
date: 2002/11/04 18:09:03;  author: dwarren;  state: Exp;  lines: +4 -5
branches:  1.14.2;
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.13
date: 2002/10/07 15:20:45;  author: dwarren;  state: Exp;  lines: +6 -5
Updates to Prolog builtins to allow boxedintegers to be handled correctly.
----------------------------
revision 1.12
date: 2001/10/23 16:34:48;  author: tswift;  state: Exp;  lines: +18 -11
branches:  1.12.4;  1.12.6;

Change to functor/3 to handle core dumps when functor(X,1,2) is
called.  The change passes the testsuite and fixes an outstanding bug
on the tracker.  In addition, I tested it with about 30 combinations,
ensuring it had the correct behavior (I did not make this into a
script since correct behaviour often involves one or another sort of
error).

Hopefully I didnt break anything.  Despite Kostis' good coding, the C
code for functor is complicated, due to the many cases which it must
handle.  The specific changes are documented in the file.
----------------------------
revision 1.11
date: 2001/08/13 20:12:31;  author: dwarren;  state: Exp;  lines: +4 -2
Added memory check to keysort to expand heap when overflow
would have occurred.  (Last week did same to sort, for forgot
this one...)
----------------------------
revision 1.10
date: 2001/08/08 15:05:32;  author: dwarren;  state: Exp;  lines: +5 -2
Added new calls for opening a database, giving the entire connection
string, so as not to have to depend on the ODBC registry.
----------------------------
revision 1.9
date: 2001/03/12 17:51:00;  author: kifer;  state: Exp;  lines: +4 -6
Simplified the undef pred hook.
Improved error messages
----------------------------
revision 1.8
date: 2000/06/22 19:40:31;  author: ruim;  state: Exp;  lines: +2 -2
branches:  1.8.2;
added casts to malloc calls to avoid warnings in C++
----------------------------
revision 1.7
date: 2000/06/19 07:48:08;  author: ruim;  state: Exp;  lines: +2 -2
Changes to remove warnings
----------------------------
revision 1.6
date: 2000/04/29 21:53:58;  author: kifer;  state: Exp;  lines: +28 -28
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.5
date: 2000/04/06 08:21:55;  author: bartkul;  state: Exp;  lines: +8 -4
spurious message in univ_builtin suppressed by putting a return FALSE
after a call to err_handle
----------------------------
revision 1.4
date: 2000/02/15 07:45:09;  author: bartkul;  state: Exp;  lines: +2 -2
in testsuite.sh supertest.sh gctest.sh

changed testsuite.sh    into    ./testsuite.sh
        makexsb         into    ./makexsb
        configure       into    ./configure

in prolog_tests/c_calls_xsb_make.P

changed c_calls_xsb.exe into    ./c_calls_xsb.exe


in the c and h files: given check_glstack_overflow an extra argument

standard.O ... I have no idea
----------------------------
revision 1.3
date: 1999/12/21 22:56:40;  author: warren;  state: Exp;  lines: +5 -5
cleanup to reduce number of warnings given by MSVC compiler.
----------------------------
revision 1.2
date: 1999/12/14 03:38:18;  author: kifer;  state: Exp;  lines: +2 -2
small comments changes
----------------------------
revision 1.1
date: 1999/10/25 05:59:29;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.8.2.3
date: 2001/01/03 20:04:51;  author: ruim;  state: Exp;  lines: +5 -2
fixes
----------------------------
revision 1.8.2.2
date: 2000/12/19 15:58:19;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.8.2.1
date: 2000/12/17 15:58:10;  author: ruim;  state: Exp;  lines: +111 -2
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.12.6.2
date: 2004/10/18 20:46:10;  author: ruim;  state: Exp;  lines: +15 -11
update for version 2.6.1
----------------------------
revision 1.12.6.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +174 -81
Sources from rfm repository
----------------------------
revision 1.12.4.3
date: 2003/04/17 17:11:39;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.12.4.2
date: 2003/02/11 18:36:15;  author: lfcastro;  state: Exp;  lines: +3 -4
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.12.4.1
date: 2002/10/28 16:49:31;  author: lfcastro;  state: Exp;  lines: +6 -5
* Merge with HEAD
----------------------------
revision 1.14.2.1
date: 2003/08/27 16:07:18;  author: lfcastro;  state: Exp;  lines: +7 -3
* Several bugfixes ported from HEAD, including:

- Fix number_codes to deal with boxed integers. Necessary for using
  java1.4.2.

- newer gpp. The main change is that #include can take a macro as an
  argument

- Generalized transformation of P/A to Skel to comma-lists of P/A's in
  index, dynamic, table declarations.  (I.e., fixed a bug.)

- Added a file-copy builtin

- Fix message/2 when 1st argument is a list --- it was printing on
  STDMSG instead of using the given file handle.
----------------------------
revision 1.48.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.48.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.48.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/storage_xsb.c,v
Working file: storage_xsb.c
head: 1.22
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.21
	ROLLBACK: 1.16
	latest_plus_supp_branch: 1.16.0.2
	latest_plus_supp: 1.16
	Version_3dot2_plus_supp: 1.12.0.2
	release_2_6_plus_supp: 1.6.0.6
	Version_3dot2: 1.12
	dec07-perf-results: 1.12
	mt_thesis: 1.9
	release_3_0: 1.9
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.2.2.2
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.2.2.1
	multi-threaded-25-engine: 1.2.0.2
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.4
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
keyword substitution: kv
total revisions: 27;	selected revisions: 27
description:
----------------------------
revision 1.22
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.21
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.20
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.19
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2010/05/22 18:38:55;  author: evansbj;  state: Exp;  lines: +10 -10
branches:  1.16.2;
Missed one.
----------------------------
revision 1.15
date: 2010/05/22 17:51:53;  author: kifer;  state: Exp;  lines: +3 -3
removed redundant declarations of CTXTdeclc
----------------------------
revision 1.14
date: 2010/05/21 23:58:10;  author: kifer;  state: Exp;  lines: +9 -5
made the storage builtin/module to understand trie types
----------------------------
revision 1.13
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.12
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.11
date: 2007/06/01 22:47:10;  author: tswift;  state: Exp;  lines: +2 -2

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.10
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +3 -3
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.9
date: 2005/09/16 00:56:41;  author: tswift;  state: Exp;  lines: +15 -17

Changes to make the storage module, which allows backtrackable updates, thread safe.  Storage "objects" (named interned tries) are private to each thread.
----------------------------
revision 1.8
date: 2005/09/12 01:09:33;  author: tswift;  state: Exp;  lines: +5 -5

Tonight's changes were to clean up global data structures used to
clean up tries.  This time I was able to make data structures used in deleting
asserted and interned tries, local to the relevant function.  In addition,
I put into the MT context data structures used to manage an array of interned
tries.

Of course, there's more work to allow asserted and interned tries to be used in multi-threading -- but these changes will hopefully save us from one danger, at least.
----------------------------
revision 1.7
date: 2005/01/14 18:31:32;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.6
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +7 -7
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.5
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +12 -16
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.4
date: 2002/04/02 06:31:10;  author: kifer;  state: Exp;  lines: +17 -2
fixed bug in deletion from hash table
----------------------------
revision 1.3
date: 2002/03/17 10:37:50;  author: kifer;  state: Exp;  lines: +26 -95
better implementation with a general purpose hashtable ADT
----------------------------
revision 1.2
date: 2002/03/10 05:06:15;  author: kifer;  state: Exp;  lines: +104 -40
branches:  1.2.2;
efficiency improvements in storage_* primitives.
----------------------------
revision 1.1
date: 2001/08/13 04:31:35;  author: kifer;  state: Exp;
added builtin to optimize the storage.P module
----------------------------
revision 1.2.2.2
date: 2004/10/18 20:46:10;  author: ruim;  state: Exp;  lines: +40 -98
update for version 2.6.1
----------------------------
revision 1.2.2.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.16.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.16.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/storage_xsb.h,v
Working file: storage_xsb.h
head: 1.13
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.13
	ROLLBACK: 1.8
	latest_plus_supp_branch: 1.8.0.2
	latest_plus_supp: 1.8
	Version_3dot2_plus_supp: 1.6.0.2
	release_2_6_plus_supp: 1.3.0.6
	Version_3dot2: 1.6
	dec07-perf-results: 1.6
	mt_thesis: 1.6
	release_3_0: 1.6
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.2.2.2
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.2.2.1
	multi-threaded-25-engine: 1.2.0.2
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.4
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.2
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
keyword substitution: kv
total revisions: 18;	selected revisions: 18
description:
----------------------------
revision 1.13
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.12
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.11
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2010/05/22 17:51:53;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.8.2;
removed redundant declarations of CTXTdeclc
----------------------------
revision 1.7
date: 2010/05/21 23:58:10;  author: kifer;  state: Exp;  lines: +2 -2
made the storage builtin/module to understand trie types
----------------------------
revision 1.6
date: 2005/09/16 00:56:41;  author: tswift;  state: Exp;  lines: +7 -1

Changes to make the storage module, which allows backtrackable updates, thread safe.  Storage "objects" (named interned tries) are private to each thread.
----------------------------
revision 1.5
date: 2005/09/12 01:09:33;  author: tswift;  state: Exp;  lines: +2 -2

Tonight's changes were to clean up global data structures used to
clean up tries.  This time I was able to make data structures used in deleting
asserted and interned tries, local to the relevant function.  In addition,
I put into the MT context data structures used to manage an array of interned
tries.

Of course, there's more work to allow asserted and interned tries to be used in multi-threading -- but these changes will hopefully save us from one danger, at least.
----------------------------
revision 1.4
date: 2005/01/14 18:31:32;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.3
date: 2002/03/17 10:37:50;  author: kifer;  state: Exp;  lines: +2 -9
better implementation with a general purpose hashtable ADT
----------------------------
revision 1.2
date: 2002/03/10 05:06:15;  author: kifer;  state: Exp;  lines: +17 -6
branches:  1.2.2;
efficiency improvements in storage_* primitives.
----------------------------
revision 1.1
date: 2001/08/13 04:31:35;  author: kifer;  state: Exp;
added builtin to optimize the storage.P module
----------------------------
revision 1.2.2.2
date: 2004/10/18 20:46:10;  author: ruim;  state: Exp;  lines: +2 -9
update for version 2.6.1
----------------------------
revision 1.2.2.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.8.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.8.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/storage_xsb_defs.h,v
Working file: storage_xsb_defs.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.2.0.8
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.6.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.6.1
	multi-threaded-25-engine: 1.2.0.6
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.4
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.2
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2005/01/14 18:31:32;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.3.4;
Integration of multithreaded system
----------------------------
revision 1.2
date: 2002/03/10 05:06:15;  author: kifer;  state: Exp;  lines: +2 -1
branches:  1.2.6;
efficiency improvements in storage_* primitives.
----------------------------
revision 1.1
date: 2001/08/13 04:31:35;  author: kifer;  state: Exp;
added builtin to optimize the storage.P module
----------------------------
revision 1.2.6.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/string.h,v
Working file: string.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
----------------------------
revision 1.2
date: 2001/01/30 21:08:37;  author: dwarren;  state: dead;  lines: +0 -0
Fixing problems with ODBC for cygwin
----------------------------
revision 1.1
date: 2001/01/29 22:59:31;  author: dwarren;  state: Exp;
Updates to allow ODBC interface to be compiled under cygwin on Windows.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/string_xsb.c,v
Working file: string_xsb.c
head: 1.30
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.28
	ROLLBACK: 1.24
	latest_plus_supp_branch: 1.21.0.2
	latest_plus_supp: 1.21
	Version_3dot2_plus_supp: 1.20.0.2
	release_2_6_plus_supp: 1.15.0.4
	Version_3dot2: 1.20
	dec07-perf-results: 1.20
	mt_thesis: 1.19
	release_3_0: 1.19
	release_2_7_0: 1.15
	multi-threaded-26-engine: 1.13.2.2
	pre-mt: 1.15
	multi-threaded-25-engine-done: 1.13.2.1
	multi-threaded-25-engine: 1.13.0.2
	release_2_6_1: 1.15
	release_2_6_final: 1.15
	release_2_6: 1.15.0.2
	last-merged-to-demand: 1.15
	demand_branch: 1.14.0.2
	before_removing_chat: 1.13
	release_2_5: 1.13
	pre-merge-slgwam-gc: 1.12
	multi-threaded-c-engine: 1.12.0.2
	release_2_4: 1.12
	release_2_3: 1.9
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.8
	release-2-2: 1.6
	chat-and-local: 1.6.0.2
	xsb-pre-cleanup: 1.6
	release-2-1: 1.3
	release-2-0-1: 1.2
keyword substitution: o
total revisions: 39;	selected revisions: 39
description:
----------------------------
revision 1.30
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +12 -12
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.29
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +8 -8
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.28
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.27
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.26
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.25
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.24
date: 2010/06/22 23:51:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/06/19 19:10:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +394 -394
Dipti's code for support graph added
----------------------------
revision 1.21
date: 2009/08/19 22:52:34;  author: tswift;  state: Exp;  lines: +394 -394
branches:  1.21.2;

Committing Barry's changes that fix these routines to work with the MT engine.
----------------------------
revision 1.20
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.19
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +3 -3
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.18
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +6 -4
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.17
date: 2005/11/09 17:52:27;  author: dwarren;  state: Exp;  lines: +4 -4
Allowed file_open on strings to take code-lists (actually it already could,
but had a bug), and then changed xsb_query_string to build a code-list for
the query on the heap to avoid interning the goal.  And fixed c2p_chars (which
might better be called c2p_codes) to check for heap overflow.  This fixes a
"memory leak" from code calling XSB, pointed out by Michael.
----------------------------
revision 1.16
date: 2005/01/14 18:31:32;  author: ruim;  state: Exp;  lines: +29 -29
Integration of multithreaded system
----------------------------
revision 1.15
date: 2002/08/07 15:42:13;  author: lfcastro;  state: Exp;  lines: +19 -18
* do not use is_* functions (from the C interface) inside the
  emulator.
----------------------------
revision 1.14
date: 2002/03/15 05:01:19;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.14.2;
got rid of the dependency on .O
----------------------------
revision 1.13
date: 2002/02/26 10:23:21;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.13.2;
buglet fix: wasn't matching equal strings in reverse direction
----------------------------
revision 1.12
date: 2001/07/11 06:14:31;  author: kifer;  state: Exp;  lines: +9 -9
use isatom instead of isstring in string functions.
----------------------------
revision 1.11
date: 2001/06/29 22:50:48;  author: kifer;  state: Exp;  lines: +117 -32
replaced flora with flora2 in the build
added str_match.
----------------------------
revision 1.10
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +13 -13
improved error messages
----------------------------
revision 1.9
date: 2000/06/28 16:54:52;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.9.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.8
date: 2000/05/20 06:56:07;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.7
date: 2000/04/29 21:53:59;  author: kifer;  state: Exp;  lines: +16 -16
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.6
date: 2000/01/07 08:51:50;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/12/10 07:47:39;  author: kifer;  state: Exp;  lines: +3 -3
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.4
date: 1999/11/29 00:30:20;  author: kifer;  state: Exp;  lines: +29 -37
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.3
date: 1999/11/20 06:46:51;  author: kifer;  state: Exp;  lines: +2 -2
Made sys-unlink work on NT
----------------------------
revision 1.2
date: 1999/10/26 06:47:26;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:59:30;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +19 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.13.2.2
date: 2004/10/18 20:46:10;  author: ruim;  state: Exp;  lines: +21 -20
update for version 2.6.1
----------------------------
revision 1.13.2.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +29 -29
Sources from rfm repository
----------------------------
revision 1.14.2.2
date: 2003/04/17 17:11:39;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.14.2.1
date: 2002/08/07 17:53:32;  author: lfcastro;  state: Exp;  lines: +19 -18
* update to HEAD
----------------------------
revision 1.21.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.21.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +394 -394
no message
----------------------------
revision 1.21.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/string_xsb.h,v
Working file: string_xsb.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	release_2_6_plus_supp: 1.1.0.8
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.6.1
	pre-mt: 1.1
	multi-threaded-25-engine: 1.1.0.6
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.4
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.2
keyword substitution: kv
total revisions: 11;	selected revisions: 11
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.2.4;
Integration of multithreaded system
----------------------------
revision 1.1
date: 2002/03/15 05:01:19;  author: kifer;  state: Exp;
branches:  1.1.6;
got rid of the dependency on .O
----------------------------
revision 1.1.6.1
date: 2004/10/18 20:46:11;  author: ruim;  state: Exp;  lines: +1 -1
update for version 2.6.1
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/struct_manager.c,v
Working file: struct_manager.c
head: 1.36
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.31
	ROLLBACK: 1.26
	latest_plus_supp_branch: 1.26.0.4
	latest_plus_supp: 1.26
	Version_3dot2_plus_supp: 1.26.0.2
	release_2_6_plus_supp: 1.13.0.6
	Version_3dot2: 1.26
	dec07-perf-results: 1.25
	mt_thesis: 1.22
	release_3_0: 1.19
	release_2_7_0: 1.13
	multi-threaded-26-engine: 1.12.4.2
	pre-mt: 1.13
	multi-threaded-25-engine-done: 1.12.4.1
	multi-threaded-25-engine: 1.12.0.4
	release_2_6_1: 1.13
	release_2_6_final: 1.13
	release_2_6: 1.13.0.4
	last-merged-to-demand: 1.13
	demand_branch: 1.13.0.2
	before_removing_chat: 1.12
	release_2_5: 1.12
	pre-merge-slgwam-gc: 1.12
	multi-threaded-c-engine: 1.12.0.2
	release_2_4: 1.12
	release_2_3: 1.11
	multi-threaded-engine: 1.11.0.2
	pre-threading: 1.9
	release-2-2: 1.7
	chat-and-local: 1.7.0.2
	xsb-pre-cleanup: 1.7
	release-2-1: 1.6
	release-2-0-1: 1.5
	subsumption: 1.3
	without-attv: 1.2
keyword substitution: kv
total revisions: 43;	selected revisions: 43
description:
----------------------------
revision 1.36
date: 2011/12/24 21:09:11;  author: tswift;  state: Exp;  lines: +7 -6

Changes	for memory managemement

1) Now supporting max_memory flag for user-defined memory limits

2) Changed some	  memory errors so that rather than creating an
exception ball,	  a flag is set; the exception handler then checks
for the flag.  The reason for doing this is that allocating
memory to assert an exception ball can get us into trouble.
----------------------------
revision 1.35
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +3 -3
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.34
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +2 -2

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.33
date: 2011/05/22 16:02:22;  author: tswift;  state: Exp;  lines: +2 -2
Getting rid of (most of the) compiler warnings on Linux
----------------------------
revision 1.32
date: 2011/05/22 15:12:25;  author: tswift;  state: Exp;  lines: +3 -3

Changes to fix compiler warnings on various Mac configurations.
----------------------------
revision 1.31
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.30
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.29
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.28
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.27
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.26
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.26.4;
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.25
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.24
date: 2007/02/22 00:16:05;  author: tswift;  state: Exp;  lines: +2 -2


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.23
date: 2007/01/25 20:33:55;  author: tswift;  state: Exp;  lines: +3 -3


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.22
date: 2006/11/30 18:18:43;  author: dwarren;  state: Exp;  lines: +6 -0
Added ifdef to condition include of pthreads.h (as done in rw_lock.c) so it will
compile on windows and cygwin.
----------------------------
revision 1.21
date: 2006/11/28 16:42:58;  author: tswift;  state: Exp;  lines: +2 -1
Added an include so that the file compiles on the Mac.
----------------------------
revision 1.20
date: 2006/11/06 10:31:39;  author: ruim;  state: Exp;  lines: +4 -4
Changed counter to unsigned long
Changed several counting variables to unsigned
Fixed a wrong thing in previous memory_xsb.c fix
----------------------------
revision 1.19
date: 2006/01/18 19:32:26;  author: dwarren;  state: Exp;  lines: +3 -3
Minor casts and format changes to shut up my compilers...
----------------------------
revision 1.18
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +15 -1
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.17
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +3 -3
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.16
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +2 -2
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.15
date: 2005/02/04 16:56:14;  author: dwarren;  state: Exp;  lines: +4 -3
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.14
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.13
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +5 -8
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.12
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.12.4;
improved error messages
----------------------------
revision 1.11
date: 2000/10/05 17:23:16;  author: ejohnson;  state: Exp;  lines: +51 -6
branches:  1.11.2;
Added two more structure tests to Structure Manager code:
- smIsAllocatedStruct(SM,struct) checks whether a known valid struct is
    currently allocated wrt its SM.
- smIsAllocatedStructRef(SM,struct) combines the functionality of
    smIsValidStructRef() and smIsAllocatedStruct().
Also changed argument passing style of SM from pass-by-ref to pass-by value.

Added extra checks to TRIE_DELETE_RETURN builtin to ensure that (1)
leaf node is currently allocated, (2) that it is in fact a leaf, and
(3) that it appears in the answer set associated with the given
subgoal frame.
----------------------------
revision 1.10
date: 2000/07/25 20:45:59;  author: ejohnson;  state: Exp;  lines: +53 -8
Added function for performing validity checks for structure references
on structures maintained by Structure Manager.  Useful when users
provide pointer values as arguments to builtins.

Used this function in builtin table_status/4 for checking subgoal
frame reference validity.

Reinstated correct semantics for get_calls_for_table/2.

Added builtin get_returns/3 to list of standard predicates.  This was
apparently left off this list accidentally???  According to the
manual, it is a standard predicate.
----------------------------
revision 1.9
date: 2000/05/30 14:09:28;  author: ejohnson;  state: Exp;  lines: +2 -2
Small change to printf output.
----------------------------
revision 1.8
date: 2000/05/20 06:56:07;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.7
date: 2000/01/07 08:51:51;  author: kifer;  state: Exp;  lines: +4 -4
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.6
date: 1999/11/17 17:41:58;  author: ejohnson;  state: Exp;  lines: +2 -2
Warning fixes, noticed under 64-bit mode compilation:
- type mismatches, in assignment and print formats
- unused variables
----------------------------
revision 1.5
date: 1999/10/26 06:47:26;  author: kifer;  state: Exp;  lines: +2 -2
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.4
date: 1999/10/25 05:59:31;  author: kifer;  state: Exp;  lines: +2 -2
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3
date: 1999/10/12 20:27:58;  author: ejohnson;  state: Exp;  lines: +15 -12
Comments, spacing, and added leading "0x" to printed addresses.
----------------------------
revision 1.2
date: 1999/08/16 07:24:32;  author: kifer;  state: Exp;  lines: +4 -5
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.1
date: 1999/07/15 21:41:16;  author: ejohnson;  state: Exp;
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.11.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.11.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.12.4.2
date: 2004/10/18 20:46:11;  author: ruim;  state: Exp;  lines: +5 -8
update for version 2.6.1
----------------------------
revision 1.12.4.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.26.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.26.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.26.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/struct_manager.h,v
Working file: struct_manager.h
head: 1.29
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.28
	ROLLBACK: 1.23
	latest_plus_supp_branch: 1.23.0.4
	latest_plus_supp: 1.23
	Version_3dot2_plus_supp: 1.23.0.2
	release_2_6_plus_supp: 1.4.0.12
	Version_3dot2: 1.23
	dec07-perf-results: 1.20
	mt_thesis: 1.15
	release_3_0: 1.11
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.4.10.2
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.4.10.1
	multi-threaded-25-engine: 1.4.0.10
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.8
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.6
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.4
	release_2_4: 1.4
	release_2_3: 1.4
	multi-threaded-engine: 1.4.0.2
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.2
	subsumption: 1.2
	without-attv: 1.1
keyword substitution: kv
total revisions: 36;	selected revisions: 36
description:
----------------------------
revision 1.29
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +2 -2

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.28
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.27
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.26
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.25
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/08/17 20:44:28;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2009/01/02 17:50:03;  author: tswift;  state: Exp;  lines: +3 -3
branches:  1.23.4;


Updating a number of files so that delete_branch() will work with call
subsumption (it needs to know that it deallocates BTNs rather than
TSTNs).  This fixed a latent bug in simplification and allows another
test to be run for call subsumption. It also provides a step towards
supporting answer subsumption on call subsumptive tables.  There are
also some other documentationstyle changes.

Adding a new test for copying attributed variables into delay elements
/ lists.  I hadn't thought this worked, but apparently it does !

Also, I'm adding a very simple test for incremental evaluation -- more
cases need to be added here, but at least this is a start.
----------------------------
revision 1.22
date: 2007/12/13 21:47:58;  author: ruim;  state: Exp;  lines: +6 -24
taken out last changes as they were found to be irrelevant
----------------------------
revision 1.21
date: 2007/12/13 18:22:26;  author: ruim;  state: Exp;  lines: +24 -6
changes to align structs to 16 byte addresses in the multi-threaded system
preliminar results indicate that we may want to do that for the sequential
system
----------------------------
revision 1.20
date: 2007/12/08 20:58:22;  author: ruim;  state: Exp;  lines: +3 -3
Fixes to last changes - some wrong files were commited by mistake
----------------------------
revision 1.19
date: 2007/12/06 23:24:55;  author: ruim;  state: Exp;  lines: +6 -19
replaced shared struct manangers with malloc
which improves scalabilty on a multi-processor

that required a number of small fixes to have coherency
between shared and private struct managers
----------------------------
revision 1.18
date: 2007/06/06 20:43:19;  author: tswift;  state: Exp;  lines: +5 -5

Trey Evan's updates for 64-bits.
----------------------------
revision 1.17
date: 2007/02/22 00:16:05;  author: tswift;  state: Exp;  lines: +13 -1


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.16
date: 2007/01/25 20:33:55;  author: tswift;  state: Exp;  lines: +19 -1


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.15
date: 2006/11/30 21:10:24;  author: ruim;  state: Exp;  lines: +4 -2
Moved DELAY_MUTEX in, in do_delay_stuff_shared to avoid unneeded locks

New Feature:
 Pseudo Mutexes

  These are system mutexes which are just used for counting in place of
  either sets of mutexes (call trie, struct manager) or mutexes
  that really don't fit in the SYS_MUTEX convention (completing_mut,
  th_mutex)

  It allows to re-use the statistics stuff for these mutexes.
----------------------------
revision 1.14
date: 2006/11/28 14:18:06;  author: ruim;  state: Exp;  lines: +48 -6
added one mutex to each struct manager so that MUTEX_SM is now obsolete.
this should provide a bit more scalability.
----------------------------
revision 1.13
date: 2006/11/09 16:58:34;  author: ruim;  state: Exp;  lines: +5 -10
SET_TRIE_ALLOCATION_TYPE_TIP: I think this would not have worked
for thread private tabled dynamic predicates, so changed to a safer code

TRIE_ASSERT: there's only one structure manager for trie assert,
so had to use SHARED struct manager mode
I also added a lock on trie asserted tries, but as reading is not
protected this is not entirely safe
----------------------------
revision 1.12
date: 2006/11/08 01:42:57;  author: ruim;  state: Exp;  lines: +31 -25
eliminated bug in releasing private tables
----------------------------
revision 1.11
date: 2006/02/06 20:20:04;  author: tswift;  state: Exp;  lines: +1 -2

Changed default_system_error_handler so that it asserts a fact
'_$thread_exit_ball'/2 if a joinable thread exits via a thrown
error.  Changed xsb_thread_join/2 so that it returns the exit
ball, if any, along with the exit code of the thread.

Using this, created a new predicate, xsb_thread_cancel(Id) which
puts a new thread interrupt on thread Id's interrupt valus.  When
thread Id checks this value, it throws an error, which if
uncaught will cause Id to exit.
----------------------------
revision 1.10
date: 2006/01/12 21:33:51;  author: tswift;  state: Exp;  lines: +74 -12
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.9
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +78 -4
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.8
date: 2005/12/12 18:44:53;  author: dwarren;  state: Exp;  lines: +3 -3
Added string table garbage collection.
----------------------------
revision 1.7
date: 2005/11/20 21:23:29;  author: dwarren;  state: Exp;  lines: +8 -1
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.6
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +2 -1


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.5
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +5 -1
Integration of multithreaded system
----------------------------
revision 1.4
date: 2000/10/05 17:23:17;  author: ejohnson;  state: Exp;  lines: +4 -2
branches:  1.4.2;  1.4.10;
Added two more structure tests to Structure Manager code:
- smIsAllocatedStruct(SM,struct) checks whether a known valid struct is
    currently allocated wrt its SM.
- smIsAllocatedStructRef(SM,struct) combines the functionality of
    smIsValidStructRef() and smIsAllocatedStruct().
Also changed argument passing style of SM from pass-by-ref to pass-by value.

Added extra checks to TRIE_DELETE_RETURN builtin to ensure that (1)
leaf node is currently allocated, (2) that it is in fact a leaf, and
(3) that it appears in the answer set associated with the given
subgoal frame.
----------------------------
revision 1.3
date: 2000/07/25 20:45:59;  author: ejohnson;  state: Exp;  lines: +4 -3
Added function for performing validity checks for structure references
on structures maintained by Structure Manager.  Useful when users
provide pointer values as arguments to builtins.

Used this function in builtin table_status/4 for checking subgoal
frame reference validity.

Reinstated correct semantics for get_calls_for_table/2.

Added builtin get_returns/3 to list of standard predicates.  This was
apparently left off this list accidentally???  According to the
manual, it is a standard predicate.
----------------------------
revision 1.2
date: 1999/10/12 20:32:38;  author: ejohnson;  state: Exp;  lines: +34 -18
Fixed bug in macro SM_NumStructsLeftInBlock: since an unsigned value
takes part in the calculation, negative values will be coerced to huge
unsigned numbers.

Added macro SM_RawUsage for reporting total bytes taken by the managed
structure.

Doc changes.
----------------------------
revision 1.1
date: 1999/07/15 21:41:17;  author: ejohnson;  state: Exp;
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.4.10.2
date: 2004/11/22 16:36:30;  author: ruim;  state: Exp;  lines: +5 -1
added lock on struct manager
----------------------------
revision 1.4.10.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.4.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.4.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.23.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.23.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.23.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/sub_delete.c,v
Working file: sub_delete.c
head: 1.27
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.27
	ROLLBACK: 1.22
	latest_plus_supp_branch: 1.22.0.2
	latest_plus_supp: 1.22
	Version_3dot2_plus_supp: 1.18.0.2
	release_2_6_plus_supp: 1.6.0.4
	Version_3dot2: 1.18
	dec07-perf-results: 1.18
	mt_thesis: 1.16
	release_3_0: 1.15
	release_2_7_0: 1.7
	multi-threaded-26-engine: 1.5.8.3
	pre-mt: 1.7
	multi-threaded-25-engine-done: 1.5.8.1
	multi-threaded-25-engine: 1.5.0.8
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.2
	last-merged-to-demand: 1.5
	demand_branch: 1.5.0.6
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.4
	release_2_4: 1.5
	release_2_3: 1.5
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.5
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
keyword substitution: kv
total revisions: 36;	selected revisions: 36
description:
----------------------------
revision 1.27
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.26
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.25
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2010/05/21 16:07:55;  author: tswift;  state: Exp;  lines: +5 -3
branches:  1.22.2;

tr_utils.c: removed increment of ans_deletes
sub_delete.c: resolved (potentially) ambiguous else.
----------------------------
revision 1.21
date: 2010/05/20 18:12:43;  author: tswift;  state: Exp;  lines: +2 -2

Additional places to chech for ALN tag before reclaiming space for conditional answers.
----------------------------
revision 1.20
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.19
date: 2009/09/07 21:08:04;  author: tswift;  state: Exp;  lines: +26 -1

Implemented abolish_table_call for subsumptive predicates.
----------------------------
revision 1.18
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.17
date: 2007/02/22 21:17:04;  author: tswift;  state: Exp;  lines: +13 -1

Oops -- forgot to handle deallocation of private hash table arrays in the MT engine for *subsumptive* tables.  Found with another Linux test.

I dont like to do a lot of little CVS updates, but sometimes the only way you can shake the bugs out is by working on a couple of platforms, and I use CVS to commuicate between the platforms.
----------------------------
revision 1.16
date: 2006/12/07 00:26:45;  author: tswift;  state: Exp;  lines: +7 -4

-- Added reclamation of conditional answer information (including
   subgoal PNDEs and delay tries) when variant predicates/subgoals are
   abolished in abolish_table_pred/1, abolish_table_call/1, and
   close_open_tables/0.  Also, wrote delete_delay_trie() to delete
   answer substitution factor for delay elements, and made sure this
   was used whenever des are reclaimed -- (e.g. by abolishes and
   simplifications).

-- fixed some bugs in MT engine where situations could arise where
   trie allocation type was not properly set before abolishes called
   in table gc sweeps or reloading tabled predicates.

-- Fixed numerous bugs in performing simplification in the MT engine.
   In general simplification routines may reclaim structures for delay
   lists, delay elements, answer branches, asis and pndes.  Whenever
   any of these structures are reclaimed in the MT engine a check must
   be made to determine whether these elements use private or shared
   memory management -- either struture managers or the managers for
   des/dls/pndes.  Keeping all of this straight required some thinking
   as the code flits from table to table by traversing pndes --
   however I think I was able to extend the code without undue mess
   (at least this time :-)
----------------------------
revision 1.15
date: 2006/03/24 16:40:28;  author: tswift;  state: Exp;  lines: +3 -2

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.14
date: 2006/03/17 18:17:59;  author: tswift;  state: Exp;  lines: +29 -1


Some updates to fix bugs in table abolishing and garbage
collecting.  Many of the changes have to do with refactoring code
to make it a little faster as well as to reduce bugs.

In addition, there are associated additional files in the test suite.

I'll be making more changes, and hopefully finishing over the weekend.
----------------------------
revision 1.13
date: 2006/01/12 21:33:51;  author: tswift;  state: Exp;  lines: +28 -30
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.12
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +9 -13
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.11
date: 2005/12/22 23:33:58;  author: tswift;  state: Exp;  lines: +33 -33

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.10
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +3 -3
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.9
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +4 -3
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.8
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +2 -1
Integration of multithreaded system
----------------------------
revision 1.7
date: 2004/05/03 21:56:46;  author: dwarren;  state: Exp;  lines: +17 -14
Fixed bug in abolishing subsumptive table preds:  Check for leaf before
checking if child is a hash-node.
----------------------------
revision 1.6
date: 2003/03/12 14:56:35;  author: lfcastro;  state: Exp;  lines: +8 -2
* Tentative fix of a segfault in delete_tst_answer_set, triggered when
  abolish_table_pred/1'ing subsumptive tables
----------------------------
revision 1.5
date: 2000/05/29 04:23:37;  author: ejohnson;  state: Exp;  lines: +20 -22
branches:  1.5.2;  1.5.6;  1.5.8;
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.4
date: 2000/05/25 00:32:02;  author: ejohnson;  state: Exp;  lines: +43 -33
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.3
date: 2000/05/20 06:56:08;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.2
date: 2000/03/01 16:22:34;  author: dwarren;  state: Exp;  lines: +3 -3
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.1
date: 2000/01/11 17:19:07;  author: ejohnson;  state: Exp;
Added support for subsumptive predicates/tables in two builtins:
table_state and abolish_table_pred.  This included 1) a routine for
performing a subsumptive goal lookup in a table, plus modification of
builtin code to interpret the results (this is practically rewritten),
and 2) a set of routines for deleting portions of subsumptive tables.
----------------------------
revision 1.5.8.3
date: 2004/11/22 16:36:30;  author: ruim;  state: Exp;  lines: +2 -1
added lock on struct manager
----------------------------
revision 1.5.8.2
date: 2004/10/18 20:46:11;  author: ruim;  state: Exp;  lines: +8 -2
update for version 2.6.1
----------------------------
revision 1.5.8.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.5.6.1
date: 2003/04/17 17:11:38;  author: lfcastro;  state: Exp;  lines: +8 -2
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.22.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.22.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.22.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/sub_insert.c,v
Working file: sub_insert.c
head: 1.13
branch:
locks: strict
access list:
symbolic names:
	pre-threading: 1.12
	release-2-2: 1.7
	chat-and-local: 1.7.0.2
	xsb-pre-cleanup: 1.7
	release-2-1: 1.5
	release-2-0-1: 1.4
	subsumption: 1.1
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.13
date: 2000/06/25 16:59:15;  author: ejohnson;  state: dead;  lines: +1 -1
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.12
date: 2000/05/29 04:23:38;  author: ejohnson;  state: Exp;  lines: +9 -9
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.11
date: 2000/05/25 00:32:02;  author: ejohnson;  state: Exp;  lines: +15 -15
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.10
date: 2000/05/20 06:56:08;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.9
date: 2000/05/19 04:58:33;  author: kifer;  state: Exp;  lines: +2 -2
got rid of compiler warnings having to do with casting get_arity.
----------------------------
revision 1.8
date: 2000/04/29 21:53:59;  author: kifer;  state: Exp;  lines: +31 -31
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.7
date: 2000/01/11 17:06:00;  author: ejohnson;  state: Exp;  lines: +30 -29
Modified identical_subterms to no longer be a static function and
changed its return type to bool.
----------------------------
revision 1.6
date: 2000/01/07 08:51:52;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/11/17 17:41:59;  author: ejohnson;  state: Exp;  lines: +13 -18
Warning fixes, noticed under 64-bit mode compilation:
- type mismatches, in assignment and print formats
- unused variables
----------------------------
revision 1.4
date: 1999/10/26 06:47:27;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.3
date: 1999/10/25 05:59:31;  author: kifer;  state: Exp;  lines: +3 -3
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/10/18 21:50:11;  author: cbaoqiu;  state: Exp;  lines: +12 -12
1) Renamed CallVarEnum back to VarEnumerator (after a long discussion
   with Ernie);
2) Renamed IndexOfStandardizedVariable to IndexOfStdVar;
3) Added more changes for attributed variables (around variant_call_search).
----------------------------
revision 1.1
date: 1999/10/12 19:23:06;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/sub_tables_xsb_i.h,v
Working file: sub_tables_xsb_i.h
head: 1.28
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.22
	ROLLBACK: 1.17
	latest_plus_supp_branch: 1.17.0.2
	latest_plus_supp: 1.17
	Version_3dot2_plus_supp: 1.15.0.2
	release_2_6_plus_supp: 1.4.0.10
	Version_3dot2: 1.15
	dec07-perf-results: 1.11
	mt_thesis: 1.10
	release_3_0: 1.10
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.4.8.4
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.4.8.1
	multi-threaded-25-engine: 1.4.0.8
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.6
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.4
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.2
	release_2_4: 1.4
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.2
keyword substitution: kv
total revisions: 37;	selected revisions: 37
description:
----------------------------
revision 1.28
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +3 -3

Integrating in Call Abstraction
----------------------------
revision 1.27
date: 2011/09/30 17:18:51;  author: tswift;  state: Exp;  lines: +13 -11

Some changes to allow compilation with CALL_ABSTRACTION set on
(tables.c not committed yet, though).  This change should not affect
regular compilation or evaluation.
----------------------------
revision 1.26
date: 2011/08/03 18:12:54;  author: tswift;  state: Exp;  lines: +58 -3

Added Call abstraction stuff (mostly commented out).
----------------------------
revision 1.25
date: 2010/12/23 18:47:55;  author: tswift;  state: Exp;  lines: +8 -4

Added macro that will make it easier to add abstraction records.
----------------------------
revision 1.24
date: 2010/12/16 16:47:13;  author: tswift;  state: Exp;  lines: +2 -2
Changed the name of VarVectorLoc to the more meaningful (to me) AnsTempl
----------------------------
revision 1.23
date: 2010/12/09 17:55:53;  author: tswift;  state: Exp;  lines: +5 -5

Changed CallLUR_VarVector to CallLUR_AnsTempl, which is much more
meaningful (to me, at least).
----------------------------
revision 1.22
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.21
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.20
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.19
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2010/01/23 18:58:50;  author: tswift;  state: Exp;  lines: +6 -14
branches:  1.17.2;

Minor cleanup of ifdefs.
----------------------------
revision 1.16
date: 2009/11/16 15:49:21;  author: tswift;  state: Exp;  lines: +10 -48

tries.c -- fixed (sort of) a heap-overflow bug when returning large
answers with delay lists.

sub_tables_xsb.i and tables.c -- just some code cleanup.
----------------------------
revision 1.15
date: 2009/01/01 00:07:22;  author: tswift;  state: Exp;  lines: +1 -6
Changes to get rid of sloppy extern statements, and put them into a .h file where they should be.
----------------------------
revision 1.14
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +7 -1


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.13
date: 2008/08/01 17:42:10;  author: tswift;  state: Exp;  lines: +3 -3

Fixed an overlooked case and two typos for global variables used for counting subsumptive tables.  These counters should not be used for the MT-OPT engine as they signficantly slow down concurrency.
----------------------------
revision 1.12
date: 2007/12/13 16:15:09;  author: ruim;  state: Exp;  lines: +68 -1
removed counters for subsumption from optimized multi-threaded engine
----------------------------
revision 1.11
date: 2007/01/29 19:35:27;  author: dwarren;  state: Exp;  lines: +2 -2
Added a coercion, to quiet my irritable compiler...
----------------------------
revision 1.10
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +2 -2
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.9
date: 2005/12/22 23:33:58;  author: tswift;  state: Exp;  lines: +4 -4

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.8
date: 2005/11/18 21:09:36;  author: tswift;  state: Exp;  lines: +4 -4


Changes to error reporting when an attempt is made to use
attributed variables in subsumptive tables.  Subsumptive tables
do not yet allow attvs, and I want to wait to implement them
until I can restructure the variant table code -- most likely
after the next release.  So for now, just make the error
reporting better.

In order to do this, I introduced a new error type, table_error
for misc errors involving table semantics / implementation.

Other changes affected only code documentation.
----------------------------
revision 1.7
date: 2005/09/01 18:37:06;  author: tswift;  state: Exp;  lines: +4 -4


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.6
date: 2005/03/05 07:49:50;  author: kifer;  state: Exp;  lines: +2 -2
got rid of obvious compiler warnings
----------------------------
revision 1.5
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +14 -14
Integration of multithreaded system
----------------------------
revision 1.4
date: 2001/04/28 20:15:37;  author: ejohnson;  state: Exp;  lines: +3 -2
branches:  1.4.8;
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.3
date: 2000/07/31 20:27:56;  author: ejohnson;  state: Exp;  lines: +7 -3
branches:  1.3.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.2
date: 2000/06/26 15:53:29;  author: ejohnson;  state: Exp;  lines: +2 -2
Converted another stack (tstTrail) utilized by the trie routines from
static to dynamic.
----------------------------
revision 1.1
date: 2000/06/25 16:59:16;  author: ejohnson;  state: Exp;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.3.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.8.4
date: 2004/12/14 08:47:05;  author: ruim;  state: Exp;  lines: +7 -7
added dynamic stacks to thread context
----------------------------
revision 1.4.8.3
date: 2004/11/24 21:53:26;  author: ruim;  state: Exp;  lines: +2 -2
made smBTHT and smBTN thread specific
----------------------------
revision 1.4.8.2
date: 2004/11/22 23:07:34;  author: ruim;  state: Exp;  lines: +9 -9
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.4.8.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.17.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.17.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.17.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/subinst.h,v
Working file: subinst.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.11
	ROLLBACK: 1.6
	latest_plus_supp_branch: 1.6.0.4
	latest_plus_supp: 1.6
	Version_3dot2_plus_supp: 1.6.0.2
	release_2_6_plus_supp: 1.4.0.6
	Version_3dot2: 1.6
	dec07-perf-results: 1.6
	mt_thesis: 1.6
	release_3_0: 1.6
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.3.4.2
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.3.4.1
	multi-threaded-25-engine: 1.3.0.4
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.4
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.2
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.2
	release_2_4: 1.2
	release_2_3: 1.1.1.1
	multi-threaded-engine: 1.1.1.1.0.4
	pre-threading: 1.1.1.1
	release-2-2: 1.1.1.1
	chat-and-local: 1.1.1.1.0.2
	xsb-pre-cleanup: 1.1.1.1
	release-2-1: 1.1.1.1
	release-2-0-1: 1.1.1.1
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 19;	selected revisions: 19
description:
----------------------------
revision 1.11
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.10
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.9
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +12 -5
branches:  1.6.4;


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.5
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.4
date: 2002/05/20 17:47:10;  author: tswift;  state: Exp;  lines: +10 -1

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.3
date: 2001/09/21 15:01:15;  author: tswift;  state: Exp;  lines: +3 -1
branches:  1.3.4;

Updates to profile amount of trapped Prolog choice points (if any) in SLGWAM
----------------------------
revision 1.2
date: 2001/06/21 19:07:59;  author: tswift;  state: Exp;  lines: +5 -1

Added profiling info and traces of SCC shapes.
----------------------------
revision 1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;  lines: +0 -0
branches:  1.1.1.1.4;
Imported sources
----------------------------
revision 1.1.1.1.4.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.1.1.4.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.4.2
date: 2004/10/18 20:46:11;  author: ruim;  state: Exp;  lines: +10 -1
update for version 2.6.1
----------------------------
revision 1.3.4.1
date: 2004/09/29 19:44:20;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.6.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.6.4.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/subp.c,v
Working file: subp.c
head: 1.144
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.127
	ROLLBACK: 1.120
	latest_plus_supp_branch: 1.117.0.2
	latest_plus_supp: 1.117
	Version_3dot2_plus_supp: 1.115.0.2
	release_2_6_plus_supp: 1.67.0.4
	Version_3dot2: 1.115
	dec07-perf-results: 1.111
	mt_thesis: 1.100
	release_3_0: 1.99
	release_2_7_0: 1.78
	multi-threaded-26-engine: 1.59.2.3
	pre-mt: 1.78
	multi-threaded-25-engine-done: 1.59.2.1
	multi-threaded-25-engine: 1.59.0.2
	release_2_6_1: 1.67
	release_2_6_final: 1.67
	release_2_6: 1.67.0.2
	last-merged-to-demand: 1.63
	demand_branch: 1.63.0.2
	before_removing_chat: 1.60
	release_2_5: 1.59
	pre-merge-slgwam-gc: 1.57
	multi-threaded-c-engine: 1.57.0.2
	release_2_4: 1.54
	release_2_3: 1.50
	multi-threaded-engine: 1.48.0.2
	pre-threading: 1.47
	release-2-2: 1.40
	chat-and-local: 1.39.0.2
	xsb-pre-cleanup: 1.39
	release-2-1: 1.34
	release-2-0-1: 1.33
	subsumption: 1.24
	without-attv: 1.21
	release-2-0: 1.11
	pre-release-2-0: 1.10
	v1-9-8: 1.3
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.2
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: o
total revisions: 164;	selected revisions: 164
description:
----------------------------
revision 1.144
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +0 -28

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.143
date: 2012/05/23 20:36:15;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed error in compare, due to not checking for boxed floats and integers in
one case.
----------------------------
revision 1.142
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +1 -0

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.141
date: 2012/02/01 22:10:48;  author: dwarren;  state: Exp;  lines: +24 -1
Changed timed_call so that old sleeper threads get killed of when a new
one is set.  I've tested the Windows version, and put in what I think
looks reasonable for linux, but it needs testing!
----------------------------
revision 1.140
date: 2011/11/11 18:21:39;  author: dwarren;  state: Exp;  lines: +17 -5
Added flag[UNIFY_WITH_OCCURS_CHECK_FLAG] that when true causes XSB
to do all unifications with occur_check.  (Not completely tested, and
better efficiency is possible by having compiler generate different
bldval instructions when it can determine that occur-check isn't needed.)
----------------------------
revision 1.139
date: 2011/11/09 02:28:19;  author: dwarren;  state: Exp;  lines: +166 -1
Changed unify to unify cyclic terms without going into an infinite loop.

Also fixed some calls to print term that gave too large a level parameter
which caused overflow of C runstack.
----------------------------
revision 1.138
date: 2011/10/01 17:37:19;  author: tswift;  state: Exp;  lines: +1 -1

Fix to make compile under unix again.
----------------------------
revision 1.137
date: 2011/09/28 21:14:51;  author: dwarren;  state: Exp;  lines: +5 -4
1. Fixed a bug in unify_with_occurs_check for structures, and modified code
to use a tail-recursion optimization (here and in not_occurs_in, too) in
C with a goto.
2. Fixed timed_call setup for Windows.  It seems to work on windows now.
3. Minor spacing change in statistics printout, which makes it look better
to me...
----------------------------
revision 1.136
date: 2011/09/23 18:36:07;  author: tswift;  state: Exp;  lines: +57 -0

Changes for timed_call/3
----------------------------
revision 1.135
date: 2011/08/13 20:07:48;  author: tswift;  state: Exp;  lines: +5 -3

forgot to commit
----------------------------
revision 1.134
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +7 -1
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.133
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +5 -11
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.132
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +5 -6
Getting Linux to Work
----------------------------
revision 1.131
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +36 -25
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.130
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +6 -5

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.129
date: 2011/03/05 19:05:30;  author: tswift;  state: Exp;  lines: +1 -1
Better error message when max call term depth exceeded.
----------------------------
revision 1.128
date: 2011/01/09 22:30:16;  author: tswift;  state: Exp;  lines: +1 -1

Minor code cleanup: some changes in documentation, changes to make a
function name accord with a builtin name, and moved some table
abolishing routines from tries.c to tr_utils.c with all the others.
----------------------------
revision 1.127
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +0 -5
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.126
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.125
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.124
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.123
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.122
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;  lines: +5 -0
no message
----------------------------
revision 1.121
date: 2010/08/17 19:45:02;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.120
date: 2010/06/22 23:51:37;  author: spyrosh;  state: Exp;  lines: +1 -6
no message
----------------------------
revision 1.119
date: 2010/06/19 19:10:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.118
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +904 -899
Dipti's code for support graph added
----------------------------
revision 1.117
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.117.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.116
date: 2009/08/21 20:09:34;  author: tswift;  state: Exp;  lines: +905 -891


Added various options for statistics/2 based in	part on	Paul
Fodor's modification of	  statistics/0.  See manual for details.
----------------------------
revision 1.115
date: 2008/10/24 18:55:20;  author: dwarren;  state: Exp;  lines: +3 -6
A couple of minor changes:
1. Use case-insensitive compare of filenames for redefining test on Windows machines.
2. Minor change to Profiling to accumulate interrupt counts and apply all to the
point of the next interrupt.  This now seems to me to be slightly better.  It doesn't
much change the few profiles I tested, but it seems better to me, so...
----------------------------
revision 1.114
date: 2008/10/15 16:41:53;  author: dwarren;  state: Exp;  lines: +11 -6
Extended xsb_profiling to include counts for time in garbage collection.
(This info could be gotten, approximately, from statistics, but it is
nice to see it directly in the profile_call dump.)
----------------------------
revision 1.113
date: 2008/01/30 16:03:03;  author: dwarren;  state: Exp;  lines: +2 -2
Added a new instruction for adding (or subtracting) small integers.
This allows a somewhat more efficient compilation of arithmetic,
for the common case of incrementing or decrementing a value.
----------------------------
revision 1.112
date: 2007/12/21 10:41:40;  author: ruim;  state: Exp;  lines: +2 -2
change to make signal handling on linux equivalent
to other systems
----------------------------
revision 1.111
date: 2007/12/05 19:02:39;  author: dwarren;  state: Exp;  lines: +6 -6
Just moved some redefines, which change the meaning of the unify_xsb() macro,
closer to the use of that macro.  At least now it's easier to see what's
going on.
----------------------------
revision 1.110
date: 2007/10/05 19:23:09;  author: tswift;  state: Exp;  lines: +2 -2

A number of changes to finish off ISO-style compatability for Multi-threaded library.

A message queue table was added for private message queues, public
message queues, and signal queues.  New message queue predicates can
now handle private queues.

Thread signal is now implemented, and thread-cancel merged into it.
Thread_signal places Goal on a threads queue and interrupts the
thread, which will execute Goal when it handles the interrupt.  The
interrupting had already been implemented for thread cancel, and now
thread_cancel is implemented as a special form of thread_signal.
Thread signal now inherits various behaviors of thread cancel,
including the control of thread cancel enabling/disabling, and the
thread cancel condition variable.

Main added as the thread alias of the main thread.

The manual documentation and test suite were also changed to support
the new functionality.
----------------------------
revision 1.109
date: 2007/09/28 18:30:10;  author: tswift;  state: Exp;  lines: +12 -6
thread_cancel depends on sigabrt being set to a particular handler --
for some reason setting signal handlers differs from Linux to BST-style
unixes, but this change makes thread_cancel work on linux, also.
----------------------------
revision 1.108
date: 2007/09/12 21:50:47;  author: tswift;  state: Exp;  lines: +17 -1

Making thread_cancel throw a SIGABRT rather than a SIGINT (and using a different handler).

Revised code so that message queue of size 0 is unbounded.
----------------------------
revision 1.107
date: 2007/09/05 20:53:55;  author: dwarren;  state: Exp;  lines: +4 -6
Fixed a bug I noticed in my change to handling the attv interrupt list in
the heap.  (Why it had passed the test suite is unclear.  Should work on
getting tests that test more cases...)
----------------------------
revision 1.106
date: 2007/09/04 00:49:09;  author: dwarren;  state: Exp;  lines: +50 -58
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.105
date: 2007/08/08 17:50:51;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.104
date: 2007/07/24 20:19:33;  author: ruim;  state: Exp;  lines: +4 -1
hack to allow threads to be interrupted while waiting
for messages
----------------------------
revision 1.103
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +9 -8
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.102
date: 2007/02/23 16:35:12;  author: dwarren;  state: Exp;  lines: +1 -1
Fix threads_xsb.c to call Sleep under windows instead of unix usleep.
Fixed old, probably bad call to unix sleep to be a call to usleep with
the appropriate argument.
----------------------------
revision 1.101
date: 2007/01/13 23:10:36;  author: tswift;  state: Exp;  lines: +2 -1
Put statistics about memory use in statistics(mutex) -- this should help in
tracking down when we're using too many  mallocs and frees which hurts scalability of the MT engine.  Right now they're only compiled in for NON-OPT-COMPILE.
----------------------------
revision 1.100
date: 2006/11/15 16:38:10;  author: tswift;  state: Exp;  lines: +1 -6

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.99
date: 2006/07/14 16:49:36;  author: tswift;  state: Exp;  lines: +3 -3

Fixed relatively obscure bugs in clause gc.  With these fixes, the gc testsuite is working again, as does the flora testsuite.

Changes are (1 traverse CPS from bfreg if needed; 2 dont reclaim if there are ;/2 or db_get_clause CPs in the stack.

Also changed dis to allow it to print to a file if needed.
----------------------------
revision 1.98
date: 2006/04/27 21:08:47;  author: tswift;  state: Exp;  lines: +22 -2

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.97
date: 2006/02/23 15:54:25;  author: dwarren;  state: Exp;  lines: +2 -3
A couple of minor casts or decls to quiet my complaining compiler.
----------------------------
revision 1.96
date: 2006/02/06 20:20:05;  author: tswift;  state: Exp;  lines: +2 -1

Changed default_system_error_handler so that it asserts a fact
'_$thread_exit_ball'/2 if a joinable thread exits via a thrown
error.  Changed xsb_thread_join/2 so that it returns the exit
ball, if any, along with the exit code of the thread.

Using this, created a new predicate, xsb_thread_cancel(Id) which
puts a new thread interrupt on thread Id's interrupt valus.  When
thread Id checks this value, it throws an error, which if
uncaught will cause Id to exit.
----------------------------
revision 1.95
date: 2006/01/16 22:13:31;  author: dwarren;  state: Exp;  lines: +6 -2
Fix bug in profiling that caused profile-interrupt-thread to be started too often.
----------------------------
revision 1.94
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +3 -3
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.93
date: 2005/12/22 23:33:58;  author: tswift;  state: Exp;  lines: +5 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.92
date: 2005/11/18 23:29:01;  author: tswift;  state: Exp;  lines: +16 -5

Took attv_interrupts array out of global area, and put it into
the thread context.  Also added, _gl suffix to realtime_count.

Other than that, just general documentation.
----------------------------
revision 1.91
date: 2005/11/11 21:24:30;  author: tswift;  state: Exp;  lines: +1 -3

Change to make xsb_basic_abort() throw a miscellaneous error.

chenge in subp.c is part of an attempt to get rid of xwammode, a bogus global I introduced when young and callow.
----------------------------
revision 1.90
date: 2005/10/28 10:27:34;  author: kostis;  state: Exp;  lines: +3 -6
File unify_xsb_i.h taken out from the repository -- related changes to subp.c
----------------------------
revision 1.89
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +6 -4


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.88
date: 2005/08/20 06:50:27;  author: ruim;  state: Exp;  lines: +2 -2
Made pflags thread private
----------------------------
revision 1.87
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +4 -4
made private flags array for sequential engine
----------------------------
revision 1.86
date: 2005/08/08 17:11:34;  author: dwarren;  state: Exp;  lines: +10 -2
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.85
date: 2005/07/20 21:54:49;  author: crojo;  state: Exp;  lines: +5 -4

updated optimization level for emuloop.c on cygwin when -mno-cygwin is given.
----------------------------
revision 1.84
date: 2005/07/19 21:25:44;  author: dwarren;  state: Exp;  lines: +5 -2
Mostly improvements to xsb_abort, so that aborts from down in the
system will now be prefixed with the thread number.  They must be caught by
the thread they occur in.  A catch is added to the calling of the goal that
is initiated by the thread, with the default handler.
I've also added some thread-specific routines for handling thread-specific tables
and clauses (for assert).  I've named mine "ds_???" to distinguish them from
"ts_???" (since TS obviously stood for Terrance Swift and DS stands for David S.
... that's a joke, guys...)  The ds_??? reoutines are just an initial thought,
and when we get a better idea of what we want, we can decide onthe ds or ts
versions, or more likely, some combination or something new altogether.
----------------------------
revision 1.83
date: 2005/07/18 21:54:11;  author: crojo;  state: Exp;  lines: +26 -24
*** empty log message ***
----------------------------
revision 1.82
date: 2005/07/18 19:47:46;  author: tswift;  state: Exp;  lines: +3 -3

picayune (my word for the day) changes in predicate names and a little added documentation
based on reviewing abolish_table_pred and friends.
----------------------------
revision 1.81
date: 2005/02/04 16:59:04;  author: dwarren;  state: Exp;  lines: +2 -3
(Oops, I didn't mean to change this one, so change it back... Sorry.)
----------------------------
revision 1.80
date: 2005/02/04 16:56:15;  author: dwarren;  state: Exp;  lines: +3 -2
Added a new general tagging scheme.  It is invoked by defining a compiler
flag GENERAL_TAGGING (need to add to configure, till then patch it into
emuMakefile.)  It automatically finds a tagging scheme that works.  It works
by recoding the top 4 bits of any address that might be referenced by a Cell.
It recodes the first 8 different top nibbles of addresses to 0-7, thus
freeing up one bit to be used (along the the bottom two) as a tag.  This
should allow xsb to run on any system and use up to 2GB of memory.
This required finding some mallocs and changing them to mem_allocs to allow
it to see all the addresses it needs.
----------------------------
revision 1.79
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +36 -29
Integration of multithreaded system
----------------------------
revision 1.78
date: 2004/11/17 21:55:07;  author: tswift;  state: Exp;  lines: +8 -1

I did find the bug(s) with attributed variables.

What apparently needs to be done on unifying to an attribute variable is

1) Build interrupts.  For an attributed variable, this means passing a
pointer to the attribute list.

2) Bind the attributed variable "eagerly" (as opposed to lazily, as
before)

This was being done correctly for the Prolog unification macros, but
not for the trie unification macros.  These latter macros passed a
pointer to the attributed variable (not the attr list) and skipped
step 2.

I changed what seemed to be appropriate places in tr_code_xsb_I.h,
namely in unify_with_trie_numcon, unify_with_trie_str,
unify_with_trie_list and unify_with_trie_attv.  However I did not
change unify_with_trie_val, as the comments in the code (from Bao, I
think) indicated that no interrupt should be dispaltched in this case.

This seemed to fix things.  The problem observed in a previous email
was that when the trie instructions passed a pointer to an attributed
variable, rather than to an attribute list, unification insructions in
the prolog attribute handling caused new bindings (e.g. binding to [])
causing new interrupts and an infinite loop.
----------------------------
revision 1.77
date: 2004/10/15 14:43:38;  author: dwarren;  state: Exp;  lines: +17 -11
Added file_puttoken option to print an atom ALWAYS as single-quoted.
----------------------------
revision 1.76
date: 2004/10/15 14:26:08;  author: dwarren;  state: Exp;  lines: +28 -14
Minor changes to fix file_puttoken to properly quote (or double quote) tokens.
Renamed no_quotes_needed to quotes_are_needed to reflect its semantics.
----------------------------
revision 1.75
date: 2004/07/07 22:31:14;  author: dwarren;  state: Exp;  lines: +3 -1
Add a couple of includes to declare necessary symbols, as suggested by a user.
----------------------------
revision 1.74
date: 2004/04/09 21:03:06;  author: dwarren;  state: Exp;  lines: +2 -1
Added 1) print_xsb_backtrace and 2) build_xsb_backtrace functions to 1) print
out the predicates on the forward continuation and the backward continuation
and 2) to build a list of these psc pointers to return to Prolog.
If xsb was not started with the -p option, then the backward continuation
is always empty.  Without the -p option, the predicate names returned as the
forward continuation are gotten from the psc pointers in the calls on the
forward continuation (so it is a weird collection of containing predicates,
given last-call optimization.)  With the -p option, it contains all the
predicates on the forward continuation (assuming their names are found),
as well as the calls (when they add new information.) This is clearly just
an approximation, but might help find where, in the Prolog context, bad
things happen.
----------------------------
revision 1.73
date: 2004/01/29 18:44:09;  author: dwarren;  state: Exp;  lines: +4 -6
Modified implementation of profiling to avoid the extra psc-record
field for the count.  Now the counts are kept in the code-ptr records
and accumulated only at accumulation time.  Someday may want to improve
accumulation algorithm.
----------------------------
revision 1.72
date: 2004/01/15 18:04:49;  author: dwarren;  state: Exp;  lines: +14 -20
Moure updates to try to get profiling working on multiple platforms.
----------------------------
revision 1.71
date: 2004/01/14 23:25:00;  author: dwarren;  state: Exp;  lines: +6 -6
Fix to compile under windows.
----------------------------
revision 1.70
date: 2004/01/14 23:19:32;  author: dwarren;  state: Exp;  lines: +32 -2
Attempt to get profiling thread working under unix, unsuccessful so
far, but it should compile now.
----------------------------
revision 1.69
date: 2004/01/14 20:27:13;  author: dwarren;  state: Exp;  lines: +32 -5
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.68
date: 2004/01/05 20:03:50;  author: dwarren;  state: Exp;  lines: +13 -11
Modified are_identical_terms to be tail-recursive, and in the process
fixed a bug.
----------------------------
revision 1.67
date: 2002/11/04 18:09:03;  author: dwarren;  state: Exp;  lines: +3 -31
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.66
date: 2002/10/30 18:07:17;  author: dwarren;  state: Exp;  lines: +3 -3
Floats have been giving up 4 tag bits, but we now use only 3.
So give back that 1 bit to (minimally) improve float precision.
----------------------------
revision 1.65
date: 2002/08/15 17:00:26;  author: lfcastro;  state: Exp;  lines: +7 -7
* interrupt handling (minor) cleanup:
  removed unnecessary argument to synint_proc & default_inthandler
----------------------------
revision 1.64
date: 2002/08/15 14:33:08;  author: lfcastro;  state: Exp;  lines: +6 -1
* statistics(8) shows profiling on the (string & symbol) hash tables.
----------------------------
revision 1.63
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.63.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.62
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +4 -10
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.61
date: 2002/05/20 17:47:10;  author: tswift;  state: Exp;  lines: +3 -1

Changes for profiling routine: spitOutGraph(), some changes for
remove_unf_set pre-implementation, and a little documentation here and
there.
----------------------------
revision 1.60
date: 2002/03/12 15:13:38;  author: lfcastro;  state: Exp;  lines: +6 -1
* added another statistics/1 capability:
  statistics(7) prints a backtrace of the choicepoints in the stack
* only works if CP_DEBUG is defined during compilation
----------------------------
revision 1.59
date: 2002/02/21 21:20:40;  author: tswift;  state: Exp;  lines: +5 -3
branches:  1.59.2;
Another iteration towards interprolog integration.
----------------------------
revision 1.58
date: 2002/01/23 17:08:10;  author: dwarren;  state: Exp;  lines: +12 -2
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.57
date: 2001/11/08 21:35:25;  author: dwarren;  state: Exp;  lines: +4 -4
Eliminated the indirection of *asynint_ptr and to directly use
asynint_val.  (Also a minor bug-fix in ptoc_longstring.)
----------------------------
revision 1.56
date: 2001/11/07 21:08:01;  author: dwarren;  state: Exp;  lines: +6 -5
I modified slightly the way interrupts are handled.  There had been a
couple of mechanisms, and I tried to consolidate them. I elimitaed
call_intercept and merged it in with *asynint_ptr. Now the keyboard
interrupt can be used for C-user-defined interrupts.  There is a new
variable asynint_code that can be set when an interrupt is signaled.
It is set to 0 by the system signal catcher.  To generate a
user-defined interrupt, you need to set the KEYINT_MARK bit of
*asynint_ptr and set asynint_code to your integer code.  Then when
this interrupt is fielded, it will call the keyboard interrupt handler
(set by set_inthandler imported from loader) which is a two argument
predicate.  When it is called, the first argument will be the goal to
call when continuing out of the interrupt; the second argument will be
the value of asynint_code.
----------------------------
revision 1.55
date: 2001/11/02 22:20:53;  author: dwarren;  state: Exp;  lines: +10 -2
Slightly modified how keyboard interrupts are handled.  In subp.c it
seemed that the embedded call to signal got lost, so XSB could only
intercept one keyboard interrupt and thereafter would abort.  xcallxsb
was changed to treat keyboard interrupt and treat it as an abort.
Abort is returned to the c-caller simply as failure.
----------------------------
revision 1.54
date: 2001/05/24 17:54:52;  author: lfcastro;  state: Exp;  lines: +5 -3
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.53
date: 2001/03/27 22:59:31;  author: dwarren;  state: Exp;  lines: +12 -12
modifications to configure (and a couple of other files) to support
the no-cygwin option to compile to a native windows executable usgin
cygwin's gcc compiler.  This allows XSB to use the jump-table
capabilities of gcc (for efficiency) without needing cygwin to
execute.
----------------------------
revision 1.52
date: 2001/03/27 17:52:03;  author: dwarren;  state: Exp;  lines: +2 -16
Took out PSC_INT code that MK proposed but is now not needed.  Also
minor changes to pahtname to make it a little more flexible for
cygwin.  Also changed last (?) boolean to xsbBool.
----------------------------
revision 1.51
date: 2001/03/23 03:54:31;  author: kifer;  state: Exp;  lines: +33 -14
added new PSC creation interrupt. -- doesn't work yet
----------------------------
revision 1.50
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +8 -3
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.49
date: 2000/12/27 00:26:43;  author: kifer;  state: Exp;  lines: +2 -2
Changed the default for segfault handling.
Fixed bug in the debugger where it fogot to close previously open input
stream.
----------------------------
revision 1.48
date: 2000/06/25 16:59:16;  author: ejohnson;  state: Exp;  lines: +46 -2
branches:  1.48.2;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.47
date: 2000/06/19 07:48:08;  author: ruim;  state: Exp;  lines: +9 -9
Changes to remove warnings
----------------------------
revision 1.46
date: 2000/06/19 07:18:39;  author: ruim;  state: Exp;  lines: +9 -4
Changed argument types of compare to fit the C++ type system
Refined types of other function prototypes
----------------------------
revision 1.45
date: 2000/05/25 00:32:02;  author: ejohnson;  state: Exp;  lines: +12 -1
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.44
date: 2000/05/20 06:56:08;  author: kifer;  state: Exp;  lines: +4 -4
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.43
date: 2000/05/19 22:55:39;  author: kifer;  state: Exp;  lines: +4 -2
removed unreachable statements
----------------------------
revision 1.42
date: 2000/05/19 04:58:34;  author: kifer;  state: Exp;  lines: +2 -2
got rid of compiler warnings having to do with casting get_arity.
----------------------------
revision 1.41
date: 2000/04/29 21:53:59;  author: kifer;  state: Exp;  lines: +17 -17
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.40
date: 2000/04/05 00:49:20;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Declared attv_interrupts as an extern variable in heap_xsb.h.
----------------------------
revision 1.39
date: 2000/03/14 21:05:50;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.39.2;
Fixed bug introduced by psc record change.  Now should use data field,
not ep field, for abort cutpoint address.
----------------------------
revision 1.38
date: 2000/03/01 16:22:35;  author: dwarren;  state: Exp;  lines: +2 -2
Changes to the psc-record so that we can always branch to the entry
point.  If the predicate is undefined, the ep now points to an
instruction that will load it.  This necessitated many changes.
----------------------------
revision 1.37
date: 2000/01/28 18:01:40;  author: unova;  state: Exp;  lines: +2 -2
Partial fix for 64 bits
----------------------------
revision 1.36
date: 2000/01/07 08:51:53;  author: kifer;  state: Exp;  lines: +5 -4
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.35
date: 1999/12/22 18:07:08;  author: warren;  state: Exp;  lines: +2 -2
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.34
date: 1999/11/16 20:28:48;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Changed two `bind_list' in build_interrupt_chain() to `bld_list' to
avoid unnecessary trailing.
----------------------------
revision 1.33
date: 1999/11/05 03:52:11;  author: cbaoqiu;  state: Exp;  lines: +9 -1
Changed some lines used for debugging attv.
----------------------------
revision 1.32
date: 1999/11/04 23:53:07;  author: cbaoqiu;  state: Exp;  lines: +5 -10
Simplified the definition of macro push_pre_image_trail().
----------------------------
revision 1.31
date: 1999/11/04 23:01:25;  author: cbaoqiu;  state: Exp;  lines: +13 -7
1) Moved the counter of the attv interrupts from the first word in the
   heap to `interrupt_counter';
2) Trail the content of array attv_interrupts[][] using pre_image
   trail (as what we did for the interrupt counter);
3) Do not use ATTVINT_MARK and *asynint_ptr to detect attv interrupts.
   Use *interrupt_reg directly (because *asynint_ptr is not trailed
   using pre_image trail).
----------------------------
revision 1.30
date: 1999/11/02 01:20:22;  author: cbaoqiu;  state: Exp;  lines: +4 -3
Very minor changes in comments.
----------------------------
revision 1.29
date: 1999/10/30 00:02:11;  author: cbaoqiu;  state: Exp;  lines: +11 -8
Reset the attv interrupt counter in build_interrupt_chain(), and made
this function external.
----------------------------
revision 1.28
date: 1999/10/29 10:41:36;  author: kostis;  state: Exp;  lines: +5 -5
Changes to possibly avoid clashes with other files and for slight performance
improvement.
----------------------------
revision 1.27
date: 1999/10/28 03:22:24;  author: cbaoqiu;  state: Exp;  lines: +10 -1
Put pre-image trail stuff into `#ifdef PRE_IMAGE_TRAIL' (for Kostis),
and added some comments about trail frame data structures in binding.h
(for Ernie).
----------------------------
revision 1.26
date: 1999/10/26 06:47:27;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.25
date: 1999/10/25 05:59:32;  author: kifer;  state: Exp;  lines: +8 -8
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.24
date: 1999/10/12 20:34:44;  author: ejohnson;  state: Exp;  lines: +36 -26
Mostly documentation.  Reformatted a small section involving many
nested "if"s.  Used xsb_memory macro instead of XSB register.
----------------------------
revision 1.23
date: 1999/10/10 12:36:46;  author: kostis;  state: Exp;  lines: +8 -8
Made variables local to the point of their use; not to entire function.
----------------------------
revision 1.22
date: 1999/10/09 02:00:28;  author: cbaoqiu;  state: Exp;  lines: +83 -9
Changes for attributed variables (first step).
----------------------------
revision 1.21
date: 1999/10/05 04:01:54;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.20
date: 1999/09/26 06:05:53;  author: kifer;  state: Exp;  lines: +2 -2
changed memory violation msg
----------------------------
revision 1.19
date: 1999/08/19 15:08:32;  author: kifer;  state: Exp;  lines: +6 -1
added segfault_handler/1
----------------------------
revision 1.18
date: 1999/08/17 06:34:14;  author: kifer;  state: Exp;  lines: +2 -2
Added pipe_open, pipe2file.
Fixed compilation bugs on NT from yesterday's.
----------------------------
revision 1.17
date: 1999/08/16 07:24:32;  author: kifer;  state: Exp;  lines: +14 -8
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.16
date: 1999/08/12 14:24:25;  author: kostis;  state: Exp;  lines: +3 -1
Changes to compile x_interp with the cpp-on option and integrate it better
with various defined constants in the emulator.
----------------------------
revision 1.15
date: 1999/08/06 14:35:49;  author: kostis;  state: Exp;  lines: +3 -3
Some more performance-related changes to the unification routine.
----------------------------
revision 1.14
date: 1999/08/04 16:21:36;  author: kifer;  state: Exp;  lines: +2 -4
ported process control to windows
----------------------------
revision 1.13
date: 1999/07/22 15:24:12;  author: warren;  state: Exp;  lines: +2 -1
Added return success at end of function unify.
----------------------------
revision 1.12
date: 1999/07/15 21:41:18;  author: ejohnson;  state: Exp;  lines: +5 -3
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.11
date: 1999/06/23 19:50:48;  author: kostis;  state: Exp;  lines: +1 -5
Changes to speed up definition and use of specialized unification.
----------------------------
revision 1.10
date: 1999/04/23 19:41:58;  author: cbaoqiu;  state: Exp;  lines: +11 -8
Added instruction `reset' and changed xsb_segfault_catcher(), so that
both xsb_segfault_catcher() and xsb_abort() longjmp to `case reset' in
emuloop.c.  Seg fault handler is now nicer.
----------------------------
revision 1.9
date: 1999/04/04 05:20:19;  author: kifer;  state: Exp;  lines: +8 -4
ifdef'ed signal(SIGBUS,...), since SIGBUS is a BSD-ism.
----------------------------
revision 1.8
date: 1999/04/03 02:22:20;  author: kostis;  state: Exp;  lines: +201 -225
Added SIGBUS signal.
----------------------------
revision 1.7
date: 1999/03/29 20:35:56;  author: kifer;  state: Exp;  lines: +2 -2
Changed the name of xsb_fall_back_environment to
xsb_segfault_fallback_environment
----------------------------
revision 1.6
date: 1999/03/25 02:47:13;  author: kifer;  state: Exp;  lines: +14 -4
Improved segfault handling: even when DEBUG and segfault handling is
disabled, we can now enable it in certain laces, those where we know
the reasons for segfaulting.
----------------------------
revision 1.5
date: 1999/03/23 22:45:18;  author: kifer;  state: Exp;  lines: +3 -1
surrounded signal(SIGSEGV,...) with #ifndef DEBUG
----------------------------
revision 1.4
date: 1999/03/23 05:30:14;  author: kifer;  state: Exp;  lines: +8 -1
Added segfault handling.
----------------------------
revision 1.3
date: 1998/12/21 01:08:52;  author: cbaoqiu;  state: Exp;  lines: +21 -2
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/11/14 05:05:30;  author: kifer;  state: Exp;  lines: +3 -3
djusted casts because now bool is typedef short, for NT compatibility.
----------------------------
revision 1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:21;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.39.2.1
date: 2000/04/19 18:27:03;  author: lfcastro;  state: Exp;  lines: +2 -2
- exporting attv_interrupts var to be used during GC
----------------------------
revision 1.48.2.3
date: 2001/01/06 18:43:05;  author: ruim;  state: Exp;  lines: +5 -1
Initialization data made static and other small changes
----------------------------
revision 1.48.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.48.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +63 -9
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.59.2.3
date: 2004/11/19 17:33:40;  author: ruim;  state: Exp;  lines: +2 -2
added core dump in debug configuration
----------------------------
revision 1.59.2.2
date: 2004/10/18 20:46:11;  author: ruim;  state: Exp;  lines: +26 -48
update for version 2.6.1
----------------------------
revision 1.59.2.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +38 -31
Sources from rfm repository
----------------------------
revision 1.63.2.9
date: 2003/05/13 18:12:53;  author: lfcastro;  state: Exp;  lines: +3 -3
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.63.2.8
date: 2003/04/17 17:11:38;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.63.2.7
date: 2003/02/11 18:36:12;  author: lfcastro;  state: Exp;  lines: +4 -32
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.63.2.6
date: 2002/10/28 16:49:32;  author: lfcastro;  state: Exp;  lines: +1 -0
* Merge with HEAD
----------------------------
revision 1.63.2.5
date: 2002/08/29 14:17:13;  author: lfcastro;  state: Exp;  lines: +9 -5
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.63.2.4
date: 2002/08/28 19:20:24;  author: lfcastro;  state: Exp;  lines: +6 -6
* FIXED problem in once/1 when there are no choicepoints under its
  scope
* MERGED patch from HEAD that fixes bug in interrupt handling (& attv)
* INCLUDED test predicate for demand & negation
----------------------------
revision 1.63.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +5 -5
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.63.2.2
date: 2002/08/07 17:53:31;  author: lfcastro;  state: Exp;  lines: +6 -6
* update to HEAD
----------------------------
revision 1.63.2.1
date: 2002/07/31 20:13:47;  author: lfcastro;  state: Exp;  lines: +6 -6
* demand_once/1 predicate cuts over tables, deleting incomplete tables
whose producer is in the scope of the "cut" (preliminary version)
----------------------------
revision 1.117.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.117.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +904 -899
no message
----------------------------
revision 1.117.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/subp.h,v
Working file: subp.h
head: 1.25
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.22
	ROLLBACK: 1.17
	latest_plus_supp_branch: 1.17.0.2
	latest_plus_supp: 1.17
	Version_3dot2_plus_supp: 1.16.0.2
	release_2_6_plus_supp: 1.11.0.4
	Version_3dot2: 1.16
	dec07-perf-results: 1.16
	mt_thesis: 1.15
	release_3_0: 1.15
	release_2_7_0: 1.13
	multi-threaded-26-engine: 1.10.8.2
	pre-mt: 1.13
	multi-threaded-25-engine-done: 1.10.8.1
	multi-threaded-25-engine: 1.10.0.8
	release_2_6_1: 1.11
	release_2_6_final: 1.11
	release_2_6: 1.11.0.2
	last-merged-to-demand: 1.10
	demand_branch: 1.10.0.6
	before_removing_chat: 1.10
	release_2_5: 1.10
	pre-merge-slgwam-gc: 1.10
	multi-threaded-c-engine: 1.10.0.4
	release_2_4: 1.10
	release_2_3: 1.10
	multi-threaded-engine: 1.10.0.2
	pre-threading: 1.9
	release-2-2: 1.6
	chat-and-local: 1.6.0.2
	xsb-pre-cleanup: 1.6
	release-2-1: 1.5
	release-2-0-1: 1.5
	subsumption: 1.4
	without-attv: 1.3
	release-2-0: 1.3
	pre-release-2-0: 1.2
	v1-9-8: 1.2
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.2
	r1-9-b5: 1.2
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 35;	selected revisions: 35
description:
----------------------------
revision 1.25
date: 2011/11/09 02:28:19;  author: dwarren;  state: Exp;  lines: +2 -1
Changed unify to unify cyclic terms without going into an infinite loop.

Also fixed some calls to print term that gave too large a level parameter
which caused overflow of C runstack.
----------------------------
revision 1.24
date: 2011/09/23 18:36:07;  author: tswift;  state: Exp;  lines: +2 -1

Changes for timed_call/3
----------------------------
revision 1.23
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +2 -2
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.22
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.21
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.20
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.19
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2009/08/21 20:09:34;  author: tswift;  state: Exp;  lines: +2 -1
branches:  1.17.2;


Added various options for statistics/2 based in	part on	Paul
Fodor's modification of	  statistics/0.  See manual for details.
----------------------------
revision 1.16
date: 2007/09/04 00:49:09;  author: dwarren;  state: Exp;  lines: +3 -1
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.15
date: 2005/07/18 19:47:46;  author: tswift;  state: Exp;  lines: +2 -2

picayune (my word for the day) changes in predicate names and a little added documentation
based on reviewing abolish_table_pred and friends.
----------------------------
revision 1.14
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +12 -11
Integration of multithreaded system
----------------------------
revision 1.13
date: 2004/10/15 14:43:38;  author: dwarren;  state: Exp;  lines: +2 -1
Added file_puttoken option to print an atom ALWAYS as single-quoted.
----------------------------
revision 1.12
date: 2004/10/15 14:26:08;  author: dwarren;  state: Exp;  lines: +2 -1
Minor changes to fix file_puttoken to properly quote (or double quote) tokens.
Renamed no_quotes_needed to quotes_are_needed to reflect its semantics.
----------------------------
revision 1.11
date: 2002/08/15 17:00:26;  author: lfcastro;  state: Exp;  lines: +2 -2
* interrupt handling (minor) cleanup:
  removed unnecessary argument to synint_proc & default_inthandler
----------------------------
revision 1.10
date: 2000/06/25 16:59:16;  author: ejohnson;  state: Exp;  lines: +2 -1
branches:  1.10.2;  1.10.6;  1.10.8;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.9
date: 2000/06/19 07:48:09;  author: ruim;  state: Exp;  lines: +3 -3
Changes to remove warnings
----------------------------
revision 1.8
date: 2000/06/19 07:18:39;  author: ruim;  state: Exp;  lines: +3 -3
Changed argument types of compare to fit the C++ type system
Refined types of other function prototypes
----------------------------
revision 1.7
date: 2000/04/29 21:53:59;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.6
date: 1999/12/14 03:38:19;  author: kifer;  state: Exp;  lines: +3 -2
small comments changes
----------------------------
revision 1.5
date: 1999/10/30 00:02:12;  author: cbaoqiu;  state: Exp;  lines: +2 -1
Reset the attv interrupt counter in build_interrupt_chain(), and made
this function external.
----------------------------
revision 1.4
date: 1999/10/09 02:00:28;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changes for attributed variables (first step).
----------------------------
revision 1.3
date: 1999/06/23 19:50:49;  author: kostis;  state: Exp;  lines: +1 -3
Changes to speed up definition and use of specialized unification.
----------------------------
revision 1.2
date: 1998/11/14 05:05:31;  author: kifer;  state: Exp;  lines: +5 -3
djusted casts because now bool is typedef short, for NT compatibility.
----------------------------
revision 1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.10.8.2
date: 2004/10/18 20:46:11;  author: ruim;  state: Exp;  lines: +2 -2
update for version 2.6.1
----------------------------
revision 1.10.8.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +12 -11
Sources from rfm repository
----------------------------
revision 1.10.6.2
date: 2003/04/17 17:11:38;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.10.6.1
date: 2002/08/28 19:20:24;  author: lfcastro;  state: Exp;  lines: +2 -2
* FIXED problem in once/1 when there are no choicepoints under its
  scope
* MERGED patch from HEAD that fixes bug in interrupt handling (& attv)
* INCLUDED test predicate for demand & negation
----------------------------
revision 1.10.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.10.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.17.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.17.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.17.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/support.c,v
Working file: support.c
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	latest_plus_supp: 1.5
	latest_plus_supp_branch: 1.1.0.2
keyword substitution: o
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: dead;  lines: +0 -0
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;  lines: +29 -29
no message
----------------------------
revision 1.2
date: 2010/06/21 16:04:02;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.1
date: 2010/06/19 13:55:38;  author: spyrosh;  state: Exp;
branches:  1.1.2;
Dipti's code added
----------------------------
revision 1.1.2.4
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.2.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +11 -12
no message
----------------------------
revision 1.1.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +1281 -0
no message
----------------------------
revision 1.1.2.1
date: 2010/06/19 13:55:38;  author: spyrosh;  state: dead;  lines: +0 -1281
file support.c was added on branch latest_plus_supp_branch on 2010-06-19 19:39:51 +0000
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/support.h,v
Working file: support.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	latest_plus_supp: 1.5
	latest_plus_supp_branch: 1.1.0.2
keyword substitution: o
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: dead;  lines: +0 -0
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;  lines: +8 -1
no message
----------------------------
revision 1.2
date: 2010/06/21 16:04:02;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.1
date: 2010/06/19 14:02:01;  author: spyrosh;  state: Exp;
branches:  1.1.2;
Dipti's code added
----------------------------
revision 1.1.2.4
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.2.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +7 -0
no message
----------------------------
revision 1.1.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +166 -0
no message
----------------------------
revision 1.1.2.1
date: 2010/06/19 14:02:01;  author: spyrosh;  state: dead;  lines: +0 -166
file support.h was added on branch latest_plus_supp_branch on 2010-06-19 19:39:51 +0000
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/support_builtin.c,v
Working file: support_builtin.c
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	latest_plus_supp: 1.5
	latest_plus_supp_branch: 1.1.0.2
keyword substitution: o
total revisions: 11;	selected revisions: 11
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: dead;  lines: +0 -0
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;  lines: +17 -98
no message
----------------------------
revision 1.2
date: 2010/06/21 16:04:02;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 2010/06/19 14:02:01;  author: spyrosh;  state: Exp;
branches:  1.1.2;
Dipti's code added
----------------------------
revision 1.1.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +261 -0
no message
----------------------------
revision 1.1.2.1
date: 2010/06/19 14:02:01;  author: spyrosh;  state: dead;  lines: +0 -342
file support_builtin.c was added on branch latest_plus_supp_branch on 2010-06-19 19:39:51 +0000
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/support_builtin.h,v
Working file: support_builtin.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	latest_plus_supp: 1.5
	latest_plus_supp_branch: 1.1.0.2
keyword substitution: o
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: dead;  lines: +0 -0
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;  lines: +26 -9
no message
----------------------------
revision 1.2
date: 2010/06/21 16:04:02;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 2010/06/19 14:02:01;  author: spyrosh;  state: Exp;
branches:  1.1.2;
Dipti's code added
----------------------------
revision 1.1.2.4
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.2.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +17 -0
no message
----------------------------
revision 1.1.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +33 -0
no message
----------------------------
revision 1.1.2.1
date: 2010/06/19 14:02:01;  author: spyrosh;  state: dead;  lines: +0 -33
file support_builtin.h was added on branch latest_plus_supp_branch on 2010-06-19 19:39:50 +0000
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/support_def.h,v
Working file: support_def.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	latest_plus_supp: 1.5
	latest_plus_supp_branch: 1.1.0.2
keyword substitution: o
total revisions: 11;	selected revisions: 11
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: dead;  lines: +0 -0
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2010/06/21 16:04:02;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.1
date: 2010/06/19 14:02:01;  author: spyrosh;  state: Exp;
branches:  1.1.2;
Dipti's code added
----------------------------
revision 1.1.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +37 -0
no message
----------------------------
revision 1.1.2.1
date: 2010/06/19 14:02:01;  author: spyrosh;  state: dead;  lines: +0 -37
file support_def.h was added on branch latest_plus_supp_branch on 2010-06-19 19:39:51 +0000
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/sw_envs.h,v
Working file: sw_envs.h
head: 1.19
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.19
	ROLLBACK: 1.14
	latest_plus_supp_branch: 1.14.0.4
	latest_plus_supp: 1.14
	Version_3dot2_plus_supp: 1.14.0.2
	release_2_6_plus_supp: 1.12.0.6
	Version_3dot2: 1.14
	dec07-perf-results: 1.14
	mt_thesis: 1.14
	release_3_0: 1.14
	release_2_7_0: 1.12
	multi-threaded-26-engine: 1.11.4.2
	pre-mt: 1.12
	multi-threaded-25-engine-done: 1.11.4.1
	multi-threaded-25-engine: 1.11.0.4
	release_2_6_1: 1.12
	release_2_6_final: 1.12
	release_2_6: 1.12.0.4
	last-merged-to-demand: 1.12
	demand_branch: 1.12.0.2
	before_removing_chat: 1.11
	release_2_5: 1.11
	pre-merge-slgwam-gc: 1.11
	multi-threaded-c-engine: 1.11.0.2
	release_2_4: 1.11
	release_2_3: 1.9
	multi-threaded-engine: 1.8.0.4
	pre-threading: 1.8
	release-2-2: 1.8
	chat-and-local: 1.8.0.2
	xsb-pre-cleanup: 1.8
	release-2-1: 1.8
	release-2-0-1: 1.7
	subsumption: 1.5
	without-attv: 1.4
	release-2-0: 1.3
	pre-release-2-0: 1.2
	v1-9-8: 1.2
keyword substitution: kv
total revisions: 30;	selected revisions: 30
description:
New files added by Kostis for GC & CHAT
----------------------------
revision 1.19
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.18
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.17
date: 2010/08/17 21:10:30;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +1 -9
branches:  1.14.4;


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.13
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.12
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +1 -21
branches:  1.12.2;
* Removal of Chat engine
----------------------------
revision 1.11
date: 2001/06/21 19:07:59;  author: tswift;  state: Exp;  lines: +6 -1
branches:  1.11.4;

Added profiling info and traces of SCC shapes.
----------------------------
revision 1.10
date: 2001/05/24 17:54:52;  author: lfcastro;  state: Exp;  lines: +8 -2
* New garbage collection scheme implemented: indirection sliding has
performance proportional to the amount of live data instead of the
initial data size. Use with 'xsb -g indirection'

* New profiling options for the garbage collector. When building with
DEBUG (for now), you can control the verboseness level of the GC by
calling 'xsb_flag(gc_verbose_level,Level)', where Level is a number
between 0 and 3.

* New profiling for number of environment switches

* If CP_DEBUG is #defined, every choicepoint contains a pointer to the
PSC record for the predicate that created the CP. This is to be
integrated into debugging and/or profiling in the future.
----------------------------
revision 1.9
date: 2001/01/31 10:23:29;  author: ejohnson;  state: Exp;  lines: +13 -10
Created the macro "table_pending_answer" to hide the details of
obtaining the next answer for consumption, which, in the case of a
properly subsumed subgoal, may require an answer identification step.

Second, removed -- again -- (most) "xtemp1" references.
(Argh!  How does this crap keep creeping back into the system?!?)

These were sprinkled over several files and removed by simply creating
a variable local to each macro in which a temp was needed.

The "need" for this change was precipitated due to the inclusion of an
"xtemp1" declaration within one of the code blocks which
table_pending_answer replaced.
----------------------------
revision 1.8
date: 1999/11/20 05:04:13;  author: cbaoqiu;  state: Exp;  lines: +18 -11
branches:  1.8.2;  1.8.4;
Modified switch_envs() so that retrailing of the forward trail is done
in the correct order.  This is required to support attributed
variables.
----------------------------
revision 1.7
date: 1999/10/28 03:22:25;  author: cbaoqiu;  state: Exp;  lines: +54 -38
Put pre-image trail stuff into `#ifdef PRE_IMAGE_TRAIL' (for Kostis),
and added some comments about trail frame data structures in binding.h
(for Ernie).
----------------------------
revision 1.6
date: 1999/10/24 20:09:34;  author: cbaoqiu;  state: Exp;  lines: +7 -6
Added two macros for pre-image trail in CHAT, and changed the macro of
table_undo_bindings().  More work needs to be done in function
chat_trail_copy(), etc.
----------------------------
revision 1.5
date: 1999/10/09 02:00:29;  author: cbaoqiu;  state: Exp;  lines: +26 -26
Changes for attributed variables (first step).
----------------------------
revision 1.4
date: 1999/08/04 14:42:07;  author: ejohnson;  state: Exp;  lines: +25 -24
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.3
date: 1999/04/29 09:56:01;  author: kostis;  state: Exp;  lines: +2 -2
*** empty log message ***
----------------------------
revision 1.2
date: 1999/01/18 18:38:48;  author: kostis;  state: Exp;  lines: +24 -28
Cleanup changes.
----------------------------
revision 1.1
date: 1998/12/21 01:08:54;  author: cbaoqiu;  state: Exp;
Kostis' changes for GC and CHAT.
----------------------------
revision 1.8.4.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.8.4.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.8.2.1
date: 2000/03/28 18:10:33;  author: lfcastro;  state: Exp;  lines: +11 -42
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.11.4.2
date: 2004/10/18 20:46:11;  author: ruim;  state: Exp;  lines: +1 -21
update for version 2.6.1
----------------------------
revision 1.11.4.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.12.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +4 -1
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.12.2.2
date: 2002/08/07 17:53:31;  author: lfcastro;  state: Exp;  lines: +2 -5
* update to HEAD
----------------------------
revision 1.12.2.1
date: 2002/07/31 20:13:47;  author: lfcastro;  state: Exp;  lines: +5 -2
* demand_once/1 predicate cuts over tables, deleting incomplete tables
whose producer is in the scope of the "cut" (preliminary version)
----------------------------
revision 1.14.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.14.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.14.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/switch.h,v
Working file: switch.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1999/01/31 14:04:19;  author: kostis;  state: dead;  lines: +1 -1
Junk file that is not needed.
----------------------------
revision 1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/sys_include.h,v
Working file: sys_include.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.4
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.2
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	pre-mt: 1.1
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +0 -9
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +3 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +3 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +3 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +3 -0
no message
----------------------------
revision 1.1
date: 2004/01/14 20:27:13;  author: dwarren;  state: Exp;
branches:  1.1.4;
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.1.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +3 -0
no message
----------------------------
revision 1.1.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +3 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/syscall_xsb.h,v
Working file: syscall_xsb.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.2.0.10
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.2.8.2
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.2.8.1
	multi-threaded-25-engine: 1.2.0.8
	release_2_6_1: 1.2.6.1
	release_2_6_final: 1.2
	release_2_6: 1.2.0.6
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.4
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.2
	release_2_4: 1.2
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
----------------------------
revision 1.9
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2004/03/02 15:12:52;  author: dwarren;  state: Exp;  lines: +2 -1
branches:  1.4.4;
Added SYS_create to allow creation of a lockfile.
----------------------------
revision 1.3
date: 2003/08/04 16:34:01;  author: lfcastro;  state: Exp;  lines: +2 -1
* Added a file-copy builtin
----------------------------
revision 1.2
date: 2001/02/20 21:49:43;  author: kifer;  state: Exp;  lines: +5 -1
branches:  1.2.6;  1.2.8;
added cwd/1 (current working dir)
documented other syscalls in shell.P
----------------------------
revision 1.1
date: 1999/10/25 05:59:33;  author: kifer;  state: Exp;
branches:  1.1.4;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.2.8.2
date: 2004/10/18 20:46:11;  author: ruim;  state: Exp;  lines: +2 -1
update for version 2.6.1
----------------------------
revision 1.2.8.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.2.6.1
date: 2003/08/27 16:07:18;  author: lfcastro;  state: Exp;  lines: +2 -1
* Several bugfixes ported from HEAD, including:

- Fix number_codes to deal with boxed integers. Necessary for using
  java1.4.2.

- newer gpp. The main change is that #include can take a macro as an
  argument

- Generalized transformation of P/A to Skel to comma-lists of P/A's in
  index, dynamic, table declarations.  (I.e., fixed a bug.)

- Added a file-copy builtin

- Fix message/2 when 1st argument is a list --- it was printing on
  STDMSG instead of using the given file handle.
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/system.c,v
Working file: system.c
head: 1.15
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.14
	without-attv: 1.14
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.3
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.3
	r1-9-b6: 1.3
	r1-9-b5: 1.3
	devel-1-9-b4-5: 1.3
	devel-1-9-b4-4: 1.3
	devel-1-9-b4-3: 1.3
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.15
date: 1999/10/25 05:59:34;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.14
date: 1999/08/25 13:59:20;  author: kifer;  state: Exp;  lines: +5 -5
fixed a buglet where subprocess stdout was directed to
XSB stderr.
----------------------------
revision 1.13
date: 1999/08/17 06:34:15;  author: kifer;  state: Exp;  lines: +5 -48
Added pipe_open, pipe2file.
Fixed compilation bugs on NT from yesterday's.
----------------------------
revision 1.12
date: 1999/08/14 18:48:40;  author: kifer;  state: Exp;  lines: +15 -9
added sys_exit/1, to allow xsb subprocesses to exit with any exit code.
----------------------------
revision 1.11
date: 1999/08/09 00:34:27;  author: kifer;  state: Exp;  lines: +168 -76
Added process control builtins, deprecated unix.P,
added C preprocessor.
----------------------------
revision 1.10
date: 1999/08/05 07:57:26;  author: kifer;  state: Exp;  lines: +44 -8
Added process plumbing to spawn_process
----------------------------
revision 1.9
date: 1999/08/04 16:21:37;  author: kifer;  state: Exp;  lines: +28 -24
ported process control to windows
----------------------------
revision 1.8
date: 1999/08/03 20:20:09;  author: kifer;  state: Exp;  lines: +3 -3
fixed declaration buglet
----------------------------
revision 1.7
date: 1999/08/03 19:18:49;  author: kifer;  state: Exp;  lines: +313 -32
Finished process control (needs testing under windows).
----------------------------
revision 1.6
date: 1999/08/02 09:05:20;  author: kifer;  state: Exp;  lines: +190 -38
Deleted open/close_process_stream/pipe.
Added the more general spawn_process/3.
Added section on interprocess communication to manual2.
Still needs testing on NT.
----------------------------
revision 1.5
date: 1999/07/22 05:45:52;  author: kifer;  state: Exp;  lines: +3 -3
Changes to make xsb run better under SGI. Still, foreign C interface
doesn't seem to work on SGI.
----------------------------
revision 1.4
date: 1999/07/20 18:54:42;  author: kifer;  state: Exp;  lines: +54 -5
added open_process_pipe/close_process_pipe,
open_process_stream/close_process_stream
----------------------------
revision 1.3
date: 1998/11/14 05:05:32;  author: kifer;  state: Exp;  lines: +2 -1
djusted casts because now bool is typedef short, for NT compatibility.
----------------------------
revision 1.2
date: 1998/11/13 02:49:08;  author: kifer;  state: Exp;  lines: +3 -2
Modifications for porting to NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/system.h,v
Working file: system.h
head: 1.4
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.3
	without-attv: 1.3
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.4
date: 1999/10/25 05:59:36;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3
date: 1999/08/17 06:34:16;  author: kifer;  state: Exp;  lines: +48 -7
Added pipe_open, pipe2file.
Fixed compilation bugs on NT from yesterday's.
----------------------------
revision 1.2
date: 1999/08/09 00:34:28;  author: kifer;  state: Exp;  lines: +4 -3
Added process control builtins, deprecated unix.P,
added C preprocessor.
----------------------------
revision 1.1
date: 1999/08/03 19:18:50;  author: kifer;  state: Exp;
Finished process control (needs testing under windows).
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/system_defs.h,v
Working file: system_defs.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1
	without-attv: 1.1
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
----------------------------
revision 1.2
date: 1999/10/25 05:59:37;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1999/08/17 06:34:16;  author: kifer;  state: Exp;
Added pipe_open, pipe2file.
Fixed compilation bugs on NT from yesterday's.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/system_defs_xsb.h,v
Working file: system_defs_xsb.h
head: 1.19
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.18
	ROLLBACK: 1.14
	latest_plus_supp_branch: 1.11.0.2
	latest_plus_supp: 1.11
	Version_3dot2_plus_supp: 1.9.0.2
	release_2_6_plus_supp: 1.7.0.4
	Version_3dot2: 1.9
	dec07-perf-results: 1.8
	mt_thesis: 1.8
	release_3_0: 1.8
	release_2_7_0: 1.7
	multi-threaded-26-engine: 1.6.6.2
	pre-mt: 1.7
	multi-threaded-25-engine-done: 1.6.6.1
	multi-threaded-25-engine: 1.6.0.6
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.2
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.4
	before_removing_chat: 1.6
	release_2_5: 1.6
	pre-merge-slgwam-gc: 1.6
	multi-threaded-c-engine: 1.6.0.2
	release_2_4: 1.6
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.1
keyword substitution: o
total revisions: 26;	selected revisions: 26
description:
----------------------------
revision 1.19
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +7 -1

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.18
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.17
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.15
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.14
date: 2010/06/22 23:51:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2010/06/19 19:10:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +58 -58
Dipti's code for support graph added
----------------------------
revision 1.11
date: 2009/08/26 23:58:41;  author: tswift;  state: Exp;  lines: +2 -1
branches:  1.11.2;

Adding statistics(atoms,X) to show size of atom space, in bytes.
----------------------------
revision 1.10
date: 2009/08/21 20:09:34;  author: tswift;  state: Exp;  lines: +57 -46


Added various options for statistics/2 based in	part on	Paul
Fodor's modification of	  statistics/0.  See manual for details.
----------------------------
revision 1.9
date: 2009/02/21 16:47:34;  author: tswift;  state: Exp;  lines: +7 -1

Changes to support

statistics/2
Rui's fix for the mt bug

along with scratch code for answer_completion.
----------------------------
revision 1.8
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.7
date: 2003/06/09 16:38:17;  author: lfcastro;  state: Exp;  lines: +2 -1
* New builtin 'list_directory(+Dir,-File)' which backtracks through
  all files in Dir.
----------------------------
revision 1.6
date: 2001/06/10 04:57:28;  author: kifer;  state: Exp;  lines: +2 -1
branches:  1.6.6;
added the tmpfilename builtin
----------------------------
revision 1.5
date: 2001/05/31 16:33:38;  author: lfcastro;  state: Exp;  lines: +2 -1
* inclusion of the XMC GUI
* new builtin created, exec/1
----------------------------
revision 1.4
date: 2001/03/26 04:59:02;  author: kifer;  state: Exp;  lines: +4 -1
got rid of the FILE_STAT builtin, replaced with the one in system_xsb.c
Added more path_sysop goodies.
----------------------------
revision 1.3
date: 2001/03/26 01:38:16;  author: kifer;  state: Exp;  lines: +4 -1
added uniform file operation interface:
path_sysop/2 and path_sysop/3.
Several more system calls are now available through it.
----------------------------
revision 1.2
date: 1999/11/16 19:06:02;  author: kifer;  state: Exp;  lines: +2 -1
branches:  1.2.4;
Revamped sockets interface.
----------------------------
revision 1.1
date: 1999/10/25 05:59:37;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2.4.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.4.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.6.6.2
date: 2004/10/18 20:46:11;  author: ruim;  state: Exp;  lines: +2 -1
update for version 2.6.1
----------------------------
revision 1.6.6.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.11.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.11.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +58 -58
no message
----------------------------
revision 1.11.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/system_xsb.c,v
Working file: system_xsb.c
head: 1.68
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.62
	ROLLBACK: 1.56
	latest_plus_supp_branch: 1.56.0.2
	latest_plus_supp: 1.56
	Version_3dot2_plus_supp: 1.54.0.2
	release_2_6_plus_supp: 1.31.2.1.0.2
	Version_3dot2: 1.54
	dec07-perf-results: 1.50
	mt_thesis: 1.45
	release_3_0: 1.45
	release_2_7_0: 1.40
	multi-threaded-26-engine: 1.26.4.2
	pre-mt: 1.40
	multi-threaded-25-engine-done: 1.26.4.1
	multi-threaded-25-engine: 1.26.0.4
	release_2_6_1: 1.31.2.2
	release_2_6_final: 1.31.2.1
	release_2_6: 1.31.0.2
	last-merged-to-demand: 1.28
	demand_branch: 1.27.0.2
	before_removing_chat: 1.26
	release_2_5: 1.26
	pre-merge-slgwam-gc: 1.26
	multi-threaded-c-engine: 1.26.0.2
	release_2_4: 1.19
	release_2_3: 1.9
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.8
	release-2-2: 1.5
	chat-and-local: 1.5.0.2
	xsb-pre-cleanup: 1.5
	release-2-1: 1.3
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 79;	selected revisions: 79
description:
----------------------------
revision 1.68
date: 2012/03/19 15:19:59;  author: dwarren;  state: Exp;  lines: +2 -6
Fixed a couple of declarations, not at the beginning of blocks.
Added some casts to quiet MSVC.
Conditioned the inline declarations of prolog_call0 and prolog_code_call,
which can't be external in MSVC.
----------------------------
revision 1.67
date: 2011/09/09 21:44:52;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed declaration for Windows to get correct return code for process_status.
----------------------------
revision 1.66
date: 2011/08/22 16:15:24;  author: dwarren;  state: Exp;  lines: +4 -4
Cleaned up recent checkins to work with MSVC, and avoid warnings.
(Changed bzero to memset, since MS seems not to have bzero.)
Also changed a couple of builtins to be more consistent in their
treatment of string p vs. 0-ary structure symbol p.
----------------------------
revision 1.65
date: 2011/08/06 05:19:19;  author: kifer;  state: Exp;  lines: +5 -1
use _tempname in windows instead of tmpnam. This makes windows look in its temp
direcotry instead of the current one.
----------------------------
revision 1.64
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +11 -11
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.63
date: 2011/05/18 19:21:40;  author: dwarren;  state: Exp;  lines: +18 -18
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.62
date: 2010/09/08 19:38:46;  author: kifer;  state: Exp;  lines: +11 -3
extended the builtin shell:sys_pid from Unix only to Windows.
Fixed incremental deletes by using incr_unmark_uninterned_nr
----------------------------
revision 1.61
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.60
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.59
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.58
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.57
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.56
date: 2010/04/26 18:05:51;  author: dwarren;  state: Exp;  lines: +2 -4
branches:  1.56.2;
Return time as an integer for file_time.  Now that we have 32-bit integers,
we don't need to do the bit hacking.
----------------------------
revision 1.55
date: 2010/02/26 19:03:23;  author: dwarren;  state: Exp;  lines: +13 -2
Took of trailing slash before calling stat (on files) in windows, for
compatability with other systems.  (Thanks, Paulo!)
----------------------------
revision 1.54
date: 2009/02/21 16:47:34;  author: tswift;  state: Exp;  lines: +7 -1

Changes to support

statistics/2
Rui's fix for the mt bug

along with scratch code for answer_completion.
----------------------------
revision 1.53
date: 2008/11/14 16:15:10;  author: tswift;  state: Exp;  lines: +11 -8

Updated to compile properly in MT engine.
----------------------------
revision 1.52
date: 2008/11/14 00:34:04;  author: tswift;  state: Exp;  lines: +6 -2

When the command is too large for the command buffer, only MAX_CMD_LEN
bytes are copied.  This is good, since it doesn't trash memory, but it
means that some commands unexpectedly wont run.  So, I made it also
throw a resource error in this case.

Also, increased the size of max_cmd_len
----------------------------
revision 1.51
date: 2008/10/08 20:44:27;  author: tswift;  state: Exp;  lines: +12 -7

I needed to look through sys_system() -- while I was doing that I
decided to update some documentation and turn the generic aborts into
typed errors
----------------------------
revision 1.50
date: 2007/08/13 19:14:18;  author: dwarren;  state: Exp;  lines: +2 -2
Changed windows call to spawnvp to _spawnvp, since doc says to move to _spawnvp.
----------------------------
revision 1.49
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.48
date: 2007/08/03 20:34:56;  author: tswift;  state: Exp;  lines: +31 -4

Changes to allow an override to restriction that only one thread may be active during a load.

In doing this, I refined the mutexes for syscalls so that system calls only use a mutex when using the proc table.
----------------------------
revision 1.47
date: 2007/07/07 21:02:08;  author: tswift;  state: Exp;  lines: +3 -3
-- Added usleep

-- Fixed concurrency bug with thread aliases in thread create.

-- made thread_join/thread_detach allow thread aliases
on input, and isoified their errors

-- Makde thread_self allow thread aliases on input.  The errors for
   this predicate different from ISO -- I dont really with their error
   designation in this case (at least not yet).

-- made thread_join, thread_detach, and thread_exit all properly
   remove aliases if applicable

-- Brought thread exit statuses in line with ISO working standard
   (mostly -- for now, we still have a cancelled status)

-- Added numerous tests for thread manipulation predicates to mttests.
----------------------------
revision 1.46
date: 2007/04/20 14:41:00;  author: tswift;  state: Exp;  lines: +3 -3

Made changes to several occurrences of ctop_string to avoid interning the string twice.  I only took the obvious cases, but there were several af them.  Probably at some point we should take a closer look at a few of them to make sure we aren't interning things unnecessarily, but this depends on understanding the actual uses in detail.
----------------------------
revision 1.45
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +3 -3
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.44
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +14 -10
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.43
date: 2005/04/12 18:38:13;  author: tswift;  state: Exp;  lines: +26 -2

Added patch submitted by Helga Schultz of the openshore project.  The patch allows
XSB to more easily compile files with spaces in them.
----------------------------
revision 1.42
date: 2005/02/11 01:55:59;  author: vidrevich;  state: Exp;  lines: +4 -5
changes for multi-threaded versions
----------------------------
revision 1.41
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +90 -90
Integration of multithreaded system
----------------------------
revision 1.40
date: 2004/09/02 19:48:52;  author: tswift;  state: Exp;  lines: +4 -4

1) added ISO predicates peek_char/1,2 peek_code/1,2, at_end_of_stream/1,2
set_stream_position/2

2) A bit of code cleanup by fixing print_openfiles.

3) Fixed error in spawning processes intro'd by new stream stuff.

4) Revised I/O documentation (more to come).
----------------------------
revision 1.39
date: 2004/08/19 22:15:25;  author: tswift;  state: Exp;  lines: +4 -4

Changes for streams.  Here's hoping...
----------------------------
revision 1.38
date: 2004/08/01 18:42:15;  author: kifer;  state: Exp;  lines: +2 -2
better error msg for "command str is too long
----------------------------
revision 1.37
date: 2004/03/30 14:04:59;  author: dwarren;  state: Exp;  lines: +4 -2
Added close when reading the files in a directory under Windows.  Otherwise
the directory stays locked (and so can't be deleted.)
----------------------------
revision 1.36
date: 2004/03/02 15:12:52;  author: dwarren;  state: Exp;  lines: +7 -2
Added SYS_create to allow creation of a lockfile.
----------------------------
revision 1.35
date: 2004/01/14 20:27:13;  author: dwarren;  state: Exp;  lines: +2 -2
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.34
date: 2003/08/08 18:54:24;  author: lfcastro;  state: Exp;  lines: +8 -1
* Fix buglet in sys_filecopy: Inode numbers returned from stat are meaningless in Windows
----------------------------
revision 1.33
date: 2003/08/04 16:34:01;  author: lfcastro;  state: Exp;  lines: +206 -3
* Added a file-copy builtin
----------------------------
revision 1.32
date: 2003/06/23 20:02:47;  author: lfcastro;  state: Exp;  lines: +2 -2
* Fix compilation in MIPS/64bits
----------------------------
revision 1.31
date: 2003/06/09 16:38:16;  author: lfcastro;  state: Exp;  lines: +75 -1
branches:  1.31.2;
* New builtin 'list_directory(+Dir,-File)' which backtracks through
  all files in Dir.
----------------------------
revision 1.30
date: 2003/04/02 21:45:44;  author: lfcastro;  state: Exp;  lines: +2 -2
* Allow use of "longstring"s when calling file_stat().
----------------------------
revision 1.29
date: 2003/02/03 20:38:53;  author: dwarren;  state: Exp;  lines: +13 -13
Changed filenames in sys_syscall to use longstring.
----------------------------
revision 1.28
date: 2002/08/07 15:42:12;  author: lfcastro;  state: Exp;  lines: +26 -25
* do not use is_* functions (from the C interface) inside the
  emulator.
----------------------------
revision 1.27
date: 2002/03/26 09:30:39;  author: kifer;  state: Exp;  lines: +8 -1
branches:  1.27.2;
fixed bug that prevented child processes from seeing EOF on input pipes.
----------------------------
revision 1.26
date: 2001/09/13 05:01:39;  author: kifer;  state: Exp;  lines: +5 -5
branches:  1.26.4;
name changes in system_xsb.c
Fixes in gpp to make it better work under windows
----------------------------
revision 1.25
date: 2001/08/29 08:25:14;  author: kifer;  state: Exp;  lines: +3 -3
fixes to work around windows braindamage in processing arguments to exec
----------------------------
revision 1.24
date: 2001/08/29 04:05:43;  author: kifer;  state: Exp;  lines: +19 -6
temporary fix for a bug in shell argument splitting under windows
----------------------------
revision 1.23
date: 2001/08/25 19:05:07;  author: kifer;  state: Exp;  lines: +3 -2
some more fixes to allow gpp to report included text's lines correctly
----------------------------
revision 1.22
date: 2001/08/23 19:06:35;  author: kifer;  state: Exp;  lines: +11 -2
made split_line handle the predefined escape chars correctly: \n\t, etc.
----------------------------
revision 1.21
date: 2001/08/23 17:49:26;  author: kifer;  state: Exp;  lines: +70 -35
In system_xsb.c: fixed line splitting so that it would split quoted strings
correctly when spawn_process is called.

In gpp: insert blank lines in lieue of deleted macros.
----------------------------
revision 1.20
date: 2001/08/06 06:10:14;  author: kifer;  state: Exp;  lines: +37 -17
Made compilation/loading stop if preprocessing fails
----------------------------
revision 1.19
date: 2001/07/06 02:48:18;  author: kifer;  state: Exp;  lines: +11 -10
fixes for windows
----------------------------
revision 1.18
date: 2001/07/02 19:40:19;  author: kifer;  state: Exp;  lines: +5 -1
fixed the problem with open file descriptors left behind when spawning a
new process.
----------------------------
revision 1.17
date: 2001/06/10 04:57:28;  author: kifer;  state: Exp;  lines: +7 -1
added the tmpfilename builtin
----------------------------
revision 1.16
date: 2001/05/31 16:50:27;  author: lfcastro;  state: Exp;  lines: +3 -3
* eliminated non-initialized var warning.
----------------------------
revision 1.15
date: 2001/05/31 16:33:38;  author: lfcastro;  state: Exp;  lines: +43 -1
* inclusion of the XMC GUI
* new builtin created, exec/1
----------------------------
revision 1.14
date: 2001/03/27 23:18:42;  author: kifer;  state: Exp;  lines: +4 -4
X/W/R_OK workaround
----------------------------
revision 1.13
date: 2001/03/26 04:59:02;  author: kifer;  state: Exp;  lines: +79 -15
got rid of the FILE_STAT builtin, replaced with the one in system_xsb.c
Added more path_sysop goodies.
----------------------------
revision 1.12
date: 2001/03/26 01:38:16;  author: kifer;  state: Exp;  lines: +48 -2
added uniform file operation interface:
path_sysop/2 and path_sysop/3.
Several more system calls are now available through it.
----------------------------
revision 1.11
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +30 -30
improved error messages
----------------------------
revision 1.10
date: 2001/02/20 21:49:43;  author: kifer;  state: Exp;  lines: +16 -2
added cwd/1 (current working dir)
documented other syscalls in shell.P
----------------------------
revision 1.9
date: 2000/06/28 16:54:53;  author: ruim;  state: Exp;  lines: +3 -2
branches:  1.9.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.8
date: 2000/05/22 05:48:06;  author: kifer;  state: Exp;  lines: +32 -4
enabled socket timeout on windows
----------------------------
revision 1.7
date: 2000/05/20 06:56:09;  author: kifer;  state: Exp;  lines: +4 -4
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.6
date: 2000/04/29 21:53:59;  author: kifer;  state: Exp;  lines: +5 -5
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.5
date: 2000/01/07 08:51:54;  author: kifer;  state: Exp;  lines: +2 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.4
date: 1999/12/10 07:47:39;  author: kifer;  state: Exp;  lines: +1 -2
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.3
date: 1999/11/16 19:06:03;  author: kifer;  state: Exp;  lines: +10 -1
Revamped sockets interface.
----------------------------
revision 1.2
date: 1999/10/26 06:47:28;  author: kifer;  state: Exp;  lines: +2 -2
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:59:38;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +11 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.26.4.2
date: 2004/10/18 20:46:12;  author: ruim;  state: Exp;  lines: +331 -39
update for version 2.6.1
----------------------------
revision 1.26.4.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +75 -75
Sources from rfm repository
----------------------------
revision 1.27.2.2
date: 2003/04/17 17:11:37;  author: lfcastro;  state: Exp;  lines: +14 -14
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.27.2.1
date: 2002/08/07 17:53:31;  author: lfcastro;  state: Exp;  lines: +26 -25
* update to HEAD
----------------------------
revision 1.31.2.2
date: 2003/08/27 16:07:18;  author: lfcastro;  state: Exp;  lines: +213 -3
* Several bugfixes ported from HEAD, including:

- Fix number_codes to deal with boxed integers. Necessary for using
  java1.4.2.

- newer gpp. The main change is that #include can take a macro as an
  argument

- Generalized transformation of P/A to Skel to comma-lists of P/A's in
  index, dynamic, table declarations.  (I.e., fixed a bug.)

- Added a file-copy builtin

- Fix message/2 when 1st argument is a list --- it was printing on
  STDMSG instead of using the given file handle.
----------------------------
revision 1.31.2.1
date: 2003/06/23 20:01:34;  author: lfcastro;  state: Exp;  lines: +2 -2
* Fix compilation in MIPS/64bits
----------------------------
revision 1.56.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.56.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.56.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/system_xsb.h,v
Working file: system_xsb.h
head: 1.17
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.17
	ROLLBACK: 1.12
	latest_plus_supp_branch: 1.12.0.4
	latest_plus_supp: 1.12
	Version_3dot2_plus_supp: 1.12.0.2
	release_2_6_plus_supp: 1.11.0.10
	Version_3dot2: 1.12
	dec07-perf-results: 1.12
	mt_thesis: 1.12
	release_3_0: 1.12
	release_2_7_0: 1.11
	multi-threaded-26-engine: 1.11.8.1
	pre-mt: 1.11
	multi-threaded-25-engine-done: 1.11.8.1
	multi-threaded-25-engine: 1.11.0.8
	release_2_6_1: 1.11
	release_2_6_final: 1.11
	release_2_6: 1.11.0.6
	last-merged-to-demand: 1.11
	demand_branch: 1.11.0.4
	before_removing_chat: 1.11
	release_2_5: 1.11
	pre-merge-slgwam-gc: 1.11
	multi-threaded-c-engine: 1.11.0.2
	release_2_4: 1.10
	release_2_3: 1.9
	multi-threaded-engine: 1.8.0.2
	pre-threading: 1.3
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 23;	selected revisions: 23
description:
----------------------------
revision 1.17
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.16
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.15
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.12.4;
Integration of multithreaded system
----------------------------
revision 1.11
date: 2001/08/06 06:10:14;  author: kifer;  state: Exp;  lines: +8 -7
branches:  1.11.8;
Made compilation/loading stop if preprocessing fails
----------------------------
revision 1.10
date: 2001/07/02 19:40:20;  author: kifer;  state: Exp;  lines: +3 -3
fixed the problem with open file descriptors left behind when spawning a
new process.
----------------------------
revision 1.9
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +4 -1
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.8
date: 2000/07/18 10:49:10;  author: ruim;  state: Exp;  lines: +9 -1
branches:  1.8.2;
added extern C to system_xsb.h and cast to tr_utils.h
----------------------------
revision 1.7
date: 2000/06/30 19:36:57;  author: kifer;  state: Exp;  lines: +12 -1
put back the prototypes for fileno, fdopen
----------------------------
revision 1.6
date: 2000/06/28 16:54:53;  author: ruim;  state: Exp;  lines: +1 -12
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.5
date: 2000/06/28 06:40:43;  author: kifer;  state: Exp;  lines: +12 -1
added missing prototypes
----------------------------
revision 1.4
date: 2000/06/26 19:09:26;  author: ruim;  state: Exp;  lines: +1 -12
Getting XSB to compile under g++ AGAIN
----------------------------
revision 1.3
date: 2000/06/17 23:28:53;  author: kifer;  state: Exp;  lines: +1 -6
fixed bugs in p_charlist_to_c_string.
Deleted the last argument from file_read_line_*
preds.
Removed the restriction that Lines must be under MAX_IO_SIZE
----------------------------
revision 1.2
date: 2000/05/20 06:56:09;  author: kifer;  state: Exp;  lines: +2 -2
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.1
date: 1999/10/25 05:59:39;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.8.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.8.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.11.8.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.12.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.12.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.12.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tab_structs.h,v
Working file: tab_structs.h
head: 1.27
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.13
	ROLLBACK: 1.7
	latest_plus_supp_branch: 1.3.0.2
	latest_plus_supp: 1.3
keyword substitution: kv
total revisions: 30;	selected revisions: 30
description:
----------------------------
revision 1.27
date: 2012/07/25 23:17:37;  author: tswift;  state: Exp;  lines: +9 -1

Bounded rationality for answer depth (ifdeffed out)
----------------------------
revision 1.26
date: 2012/03/14 19:22:46;  author: tswift;  state: Exp;  lines: +10 -6

Fixed potential problem with incr tabling where

1) A table is completed, choice points are set up to the completed table, and the visitors field of the subgoal is set (union field with compl_del_ret list)

2) The subgoal is re-completed (perhaps the first itme was early
completion?) and the visitor field is seen as a pointer.
----------------------------
revision 1.25
date: 2012/02/19 19:17:55;  author: tswift;  state: Exp;  lines: +5 -2

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.24
date: 2012/02/12 22:49:12;  author: tswift;  state: Exp;  lines: +4 -3

Fixed bug in throwing exceptions with incomplete tables.  Now tables
are reclaimed by unwind stack so that they stop *between* SCCs: this
allows us to continue reclaiming incomplete tables while at the same
time ensuring that we wont backtrack into a choice point for one of
those tables that we reclaimed.
----------------------------
revision 1.23
date: 2011/12/26 19:27:25;  author: tswift;  state: Exp;  lines: +2 -2

1) Fix to memory allocation/deallacation in ground_or_cyclic/1

2) When running out of space for pdlstack we abort rather than exiting.
----------------------------
revision 1.22
date: 2011/10/21 14:17:15;  author: dwarren;  state: Exp;  lines: +4 -4
Added a cast to quiet MSVC64 warnings.
Commented out unused variable, again to quiet warning.
----------------------------
revision 1.21
date: 2011/08/03 18:12:54;  author: tswift;  state: Exp;  lines: +15 -1

Added Call abstraction stuff (mostly commented out).
----------------------------
revision 1.20
date: 2011/08/01 13:24:31;  author: dwarren;  state: Exp;  lines: +2 -2
Changed long to Integer so will work with Windows64.
----------------------------
revision 1.19
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +35 -11

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.18
date: 2011/07/22 21:39:35;  author: tswift;  state: Exp;  lines: +7 -3

Unioning deltf_ptr and ans_list_tail to save a word from subgoal frames.
----------------------------
revision 1.17
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +2 -2

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.16
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +5 -5
Getting Linux to Work
----------------------------
revision 1.15
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.14
date: 2010/12/23 18:47:55;  author: tswift;  state: Exp;  lines: +4 -2

Added macro that will make it easier to add abstraction records.
----------------------------
revision 1.13
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +2 -21
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.12
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.11
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +21 -2
no message
----------------------------
revision 1.7
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -10
Backed out code
----------------------------
revision 1.4
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +11 -1
Dipti's code for support graph added
----------------------------
revision 1.3
date: 2010/01/23 19:03:03;  author: tswift;  state: Exp;  lines: +3 -3
branches:  1.3.2;

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.2
date: 2009/11/17 19:32:08;  author: dwarren;  state: Exp;  lines: +10 -3
Added pointers in the Child field of leaf nodes of answers to point to
the ALN node *preceding* the ALN node that points to it.
This pointer is used in the deletion of an answer.
It is tagged so that it can be known what the pointer is.
If there are conditional answers, this field is used for pointing
to the delay elements, and so is not used for this ALN pointer.
In that case, the entire ALN list must be run when deleting an answer
with a delay list.
----------------------------
revision 1.1
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.3.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +10 -0
no message
----------------------------
revision 1.3.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/table_inspection_defs.h,v
Working file: table_inspection_defs.h
head: 1.18
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	Version_3dot2: 1.3
	dec07-perf-results: 1.2
keyword substitution: kv
total revisions: 21;	selected revisions: 21
description:
----------------------------
revision 1.18
date: 2012/06/23 17:21:34;  author: tswift;  state: Exp;  lines: +1 -0
Added table_inspection builtin for use by get_returns_and_tvs.
----------------------------
revision 1.17
date: 2012/05/18 20:35:41;  author: tswift;  state: Exp;  lines: +1 -0

Added check_variant/[1,2]
----------------------------
revision 1.16
date: 2012/02/24 17:37:21;  author: tswift;  state: Exp;  lines: +1 -0

abort_pre_action and friends.
----------------------------
revision 1.15
date: 2012/02/19 19:17:56;  author: tswift;  state: Exp;  lines: +2 -1

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.14
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +2 -0
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.13
date: 2011/12/11 22:04:34;  author: tswift;  state: Exp;  lines: +2 -0

Forgot a definition
----------------------------
revision 1.12
date: 2011/10/29 23:27:58;  author: tswift;  state: Exp;  lines: +1 -0

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.11
date: 2011/08/19 18:26:30;  author: tswift;  state: Exp;  lines: +2 -0

Changes to support Ctrace (Fview).
----------------------------
revision 1.10
date: 2011/08/12 15:17:13;  author: tswift;  state: Exp;  lines: +5 -0

Fixes for approximate tabling and correcting memory errors.
----------------------------
revision 1.9
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +3 -0

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:36;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/01 22:06:02;  author: tswift;  state: Exp;  lines: +1 -0

biassert.c -- minor doc change

Others: changes to allow directives to change tables among
incremental, nonincremental, and opaque.
----------------------------
revision 1.3
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +2 -4
branches:  1.3.4;


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.2
date: 2007/06/01 22:47:10;  author: tswift;  state: Exp;  lines: +1 -0

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.1
date: 2007/05/01 14:52:28;  author: tswift;  state: Exp;

Adding scratch code for table inspection functions that may, if they're good, grow up into answer_completion and the like.
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/table_stats.c,v
Working file: table_stats.c
head: 1.42
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.34
	ROLLBACK: 1.29
	latest_plus_supp_branch: 1.29.0.2
	latest_plus_supp: 1.29
	Version_3dot2_plus_supp: 1.28.0.2
	release_2_6_plus_supp: 1.17.0.6
	Version_3dot2: 1.28
	dec07-perf-results: 1.28
	mt_thesis: 1.26
	release_3_0: 1.22
	release_2_7_0: 1.17
	multi-threaded-26-engine: 1.15.6.2
	pre-mt: 1.17
	multi-threaded-25-engine-done: 1.15.6.1
	multi-threaded-25-engine: 1.15.0.6
	release_2_6_1: 1.17
	release_2_6_final: 1.17
	release_2_6: 1.17.0.4
	last-merged-to-demand: 1.17
	demand_branch: 1.17.0.2
	before_removing_chat: 1.15
	release_2_5: 1.15
	pre-merge-slgwam-gc: 1.15
	multi-threaded-c-engine: 1.15.0.4
	release_2_4: 1.15
	release_2_3: 1.15
	multi-threaded-engine: 1.15.0.2
	pre-threading: 1.13
	release-2-2: 1.7
	chat-and-local: 1.7.0.2
	xsb-pre-cleanup: 1.7
	release-2-1: 1.5
	release-2-0-1: 1.5
	subsumption: 1.2
keyword substitution: kv
total revisions: 49;	selected revisions: 49
description:
----------------------------
revision 1.42
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +2 -2

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.41
date: 2012/03/01 15:43:04;  author: tswift;  state: Exp;  lines: +2 -2

A couple of tweaks for incremental table statistics.
----------------------------
revision 1.40
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +6 -6

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.39
date: 2011/05/22 16:02:22;  author: tswift;  state: Exp;  lines: +3 -3
Getting rid of (most of the) compiler warnings on Linux
----------------------------
revision 1.38
date: 2011/05/22 15:12:25;  author: tswift;  state: Exp;  lines: +38 -38

Changes to fix compiler warnings on various Mac configurations.
----------------------------
revision 1.37
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +2 -2

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.36
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +13 -13
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.35
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +8 -2

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.34
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.33
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.32
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.31
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.30
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.29
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.29.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.28
date: 2007/11/20 19:17:21;  author: tswift;  state: Exp;  lines: +44 -12


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.27
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.26
date: 2006/11/28 14:18:06;  author: ruim;  state: Exp;  lines: +11 -3
added one mutex to each struct manager so that MUTEX_SM is now obsolete.
this should provide a bit more scalability.
----------------------------
revision 1.25
date: 2006/11/15 18:21:38;  author: dwarren;  state: Exp;  lines: +9 -9
Moved some declarations to the top of the block so MSVC will compile it.
----------------------------
revision 1.24
date: 2006/11/15 16:38:10;  author: tswift;  state: Exp;  lines: +382 -108

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.23
date: 2006/11/06 10:31:39;  author: ruim;  state: Exp;  lines: +59 -59
Changed counter to unsigned long
Changed several counting variables to unsigned
Fixed a wrong thing in previous memory_xsb.c fix
----------------------------
revision 1.22
date: 2006/03/24 16:40:29;  author: tswift;  state: Exp;  lines: +5 -2

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.21
date: 2006/01/13 23:56:57;  author: tswift;  state: Exp;  lines: +3 -3

psc_xsb.c changed so that get_tip returns NULL when called with a
non-tabled predicate in the MT engine -- calling routines such as
abolish_table_pred/1 can then throw an error.

statistics files changed pretty minimally.  Basically, I just changed
them enough to prevent core dumps when calling statistics (due to the
new structure managers).  Or at least to sometimes prevent core dumps :-)
More work on them will be needed.
----------------------------
revision 1.20
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +10 -10
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.19
date: 2005/03/05 07:49:50;  author: kifer;  state: Exp;  lines: +2 -2
got rid of obvious compiler warnings
----------------------------
revision 1.18
date: 2005/01/14 18:31:33;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.17
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +3 -3
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.16
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +6 -6
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.15
date: 2000/06/27 17:59:16;  author: ejohnson;  state: Exp;  lines: +3 -3
branches:  1.15.2;  1.15.6;
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.14
date: 2000/06/23 20:54:08;  author: ruim;  state: Exp;  lines: +5 -5
Removed some C++ automatic pointer casting warnings
----------------------------
revision 1.13
date: 2000/05/30 14:11:08;  author: ejohnson;  state: Exp;  lines: +57 -7
Reinstate integrity checks for subgoal frames during the collection of
statistics.
----------------------------
revision 1.12
date: 2000/05/29 04:23:38;  author: ejohnson;  state: Exp;  lines: +42 -76
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.11
date: 2000/05/25 00:32:03;  author: ejohnson;  state: Exp;  lines: +102 -77
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.10
date: 2000/05/20 06:56:10;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.9
date: 2000/05/12 20:18:15;  author: ejohnson;  state: Exp;  lines: +10 -8
Fix for builtins abolish_all_tables and abolish_table_pred.
Checks that the subgoals are (marked as) complete before destroying
the tables.

Other supporting changes:

Added a field in TableInfoFrames (TIF) for maintaining references to
the subgoals according to predicate, rather than one global list.
Routines which walked this list had to be appropriately modified.

Discovered that TIFs weren't being counted in memory usage, so changed
their allocation to use mem_alloc() instead of malloc().

Moved the code which places a TIF on the alloc chain, maintained
through `first_tip' and `last_tip', into macro New_TIF().
Removed this code from biassert.c and loader_xsb.c.

Made a structure out of `first_tip' and `last_tip'.  Added an extern
for this structure to macro_xsb.h, and hence removed the externs from
biassert.c and builtin.c.  Modified references appropriately.

Producer subgoal frame allocation now puts the SF into the predicate's
TIF.
----------------------------
revision 1.8
date: 2000/04/25 23:16:05;  author: ejohnson;  state: Exp;  lines: +30 -146
Replaced the structure-specific functions with more general versions
which take a Structure_Manager as an argument.  This reduced code
duplicity and allows for statistics-gathering on trie-asserted
structures.
----------------------------
revision 1.7
date: 2000/01/11 16:53:16;  author: ejohnson;  state: Exp;  lines: +3 -2
Movement of definitions from one header to another; this then required
updating #includes for some files.

Predicate evaluation method #def's moved from file flag_defs_xsb.h to
new file table_status_defs.h which houses these and other new #def's.
----------------------------
revision 1.6
date: 2000/01/07 08:51:55;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/10/26 20:17:00;  author: ejohnson;  state: Exp;  lines: +153 -15
Replaced detailed table space usage and subsumptive operation stats in
total_stat() with less-detailed and spatially-smaller listings.
However, the detailed listings are preserved in table_stats.c for
future use.  (These are very helpful during debugging).
----------------------------
revision 1.4
date: 1999/10/26 06:47:29;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.3
date: 1999/10/25 05:59:39;  author: kifer;  state: Exp;  lines: +3 -3
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/10/13 21:03:47;  author: ejohnson;  state: Exp;  lines: +3 -3
Small changes to statistical displays.
----------------------------
revision 1.1
date: 1999/10/12 19:23:07;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.15.6.2
date: 2004/10/18 20:46:12;  author: ruim;  state: Exp;  lines: +7 -7
update for version 2.6.1
----------------------------
revision 1.15.6.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.15.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.15.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.29.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.29.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.29.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/table_stats.h,v
Working file: table_stats.h
head: 1.19
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.17
	ROLLBACK: 1.12
	latest_plus_supp_branch: 1.12.0.4
	latest_plus_supp: 1.12
	Version_3dot2_plus_supp: 1.12.0.2
	release_2_6_plus_supp: 1.8.0.12
	Version_3dot2: 1.12
	dec07-perf-results: 1.12
	mt_thesis: 1.12
	release_3_0: 1.11
	release_2_7_0: 1.8
	multi-threaded-26-engine: 1.8.10.1
	pre-mt: 1.8
	multi-threaded-25-engine-done: 1.8.10.1
	multi-threaded-25-engine: 1.8.0.10
	release_2_6_1: 1.8
	release_2_6_final: 1.8
	release_2_6: 1.8.0.8
	last-merged-to-demand: 1.8
	demand_branch: 1.8.0.6
	before_removing_chat: 1.8
	release_2_5: 1.8
	pre-merge-slgwam-gc: 1.8
	multi-threaded-c-engine: 1.8.0.4
	release_2_4: 1.8
	release_2_3: 1.8
	multi-threaded-engine: 1.8.0.2
	pre-threading: 1.7
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.2
	subsumption: 1.1
keyword substitution: kv
total revisions: 25;	selected revisions: 25
description:
----------------------------
revision 1.19
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +2 -2

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.18
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.17
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.16
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.15
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2006/11/15 16:38:10;  author: tswift;  state: Exp;  lines: +20 -33
branches:  1.12.4;

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.11
date: 2006/01/13 23:56:57;  author: tswift;  state: Exp;  lines: +47 -1

psc_xsb.c changed so that get_tip returns NULL when called with a
non-tabled predicate in the MT engine -- calling routines such as
abolish_table_pred/1 can then throw an error.

statistics files changed pretty minimally.  Basically, I just changed
them enough to prevent core dumps when calling statistics (due to the
new structure managers).  Or at least to sometimes prevent core dumps :-)
More work on them will be needed.
----------------------------
revision 1.10
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +4 -4
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.9
date: 2005/01/14 18:31:34;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.8
date: 2000/06/27 17:59:17;  author: ejohnson;  state: Exp;  lines: +4 -3
branches:  1.8.2;  1.8.10;
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.7
date: 2000/06/19 07:10:18;  author: ruim;  state: Exp;  lines: +3 -3
removed C++ keyword new
----------------------------
revision 1.6
date: 2000/05/30 14:11:08;  author: ejohnson;  state: Exp;  lines: +2 -1
Reinstate integrity checks for subgoal frames during the collection of
statistics.
----------------------------
revision 1.5
date: 2000/05/29 04:23:38;  author: ejohnson;  state: Exp;  lines: +30 -49
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.4
date: 2000/05/25 00:32:03;  author: ejohnson;  state: Exp;  lines: +13 -13
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.3
date: 2000/04/25 23:16:06;  author: ejohnson;  state: Exp;  lines: +4 -7
Replaced the structure-specific functions with more general versions
which take a Structure_Manager as an argument.  This reduced code
duplicity and allows for statistics-gathering on trie-asserted
structures.
----------------------------
revision 1.2
date: 1999/10/26 20:17:00;  author: ejohnson;  state: Exp;  lines: +8 -2
Replaced detailed table space usage and subsumptive operation stats in
total_stat() with less-detailed and spatially-smaller listings.
However, the detailed listings are preserved in table_stats.c for
future use.  (These are very helpful during debugging).
----------------------------
revision 1.1
date: 1999/10/12 19:23:07;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.8.10.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.8.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.8.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.12.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.12.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.12.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/table_status_defs.h,v
Working file: table_status_defs.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.12.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.12.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.9
date: 2011/04/01 18:23:56;  author: tswift;  state: Exp;  lines: +2 -1

Oops -- forgot to commit this one.
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2006/03/17 18:17:59;  author: tswift;  state: Exp;  lines: +4 -3
branches:  1.3.4;


Some updates to fix bugs in table abolishing and garbage
collecting.  Many of the changes have to do with refactoring code
to make it a little faster as well as to reduce bugs.

In addition, there are associated additional files in the test suite.

I'll be making more changes, and hopefully finishing over the weekend.
----------------------------
revision 1.2
date: 2005/01/14 18:31:34;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.1
date: 2000/01/11 16:53:17;  author: ejohnson;  state: Exp;
branches:  1.1.4;  1.1.12;
Movement of definitions from one header to another; this then required
updating #includes for some files.

Predicate evaluation method #def's moved from file flag_defs_xsb.h to
new file table_status_defs.h which houses these and other new #def's.
----------------------------
revision 1.1.12.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.4.4
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tables.c,v
Working file: tables.c
head: 1.104
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.83
	ROLLBACK: 1.76
	latest_plus_supp_branch: 1.72.0.2
	latest_plus_supp: 1.72
	Version_3dot2_plus_supp: 1.66.0.2
	release_2_6_plus_supp: 1.30.0.4
	Version_3dot2: 1.66
	dec07-perf-results: 1.57
	mt_thesis: 1.53
	release_3_0: 1.43
	release_2_7_0: 1.30
	multi-threaded-26-engine: 1.27.2.6
	pre-mt: 1.30
	multi-threaded-25-engine-done: 1.27.2.1
	multi-threaded-25-engine: 1.27.0.2
	release_2_6_1: 1.30
	release_2_6_final: 1.30
	release_2_6: 1.30.0.2
	last-merged-to-demand: 1.29
	demand_branch: 1.29.0.2
	before_removing_chat: 1.27
	release_2_5: 1.27
	pre-merge-slgwam-gc: 1.23
	multi-threaded-c-engine: 1.23.0.2
	release_2_4: 1.23
	release_2_3: 1.22
	multi-threaded-engine: 1.22.0.2
	pre-threading: 1.17
	release-2-2: 1.12
	chat-and-local: 1.12.0.2
	xsb-pre-cleanup: 1.12
	release-2-1: 1.9
	release-2-0-1: 1.8
	subsumption: 1.3
keyword substitution: kv
total revisions: 118;	selected revisions: 118
description:
----------------------------
revision 1.104
date: 2012/07/18 21:26:53;  author: tswift;  state: Exp;  lines: +25 -7
There was a problem with slg_not using has_answers
     when all answers for a subgoal have been removed via delay
     (surprisingly this case had not been tested).  So we only want an                                                  XXX_ANSWERS tag if the subg_ans_root_ptr is null; otherwise we                                                     handle the reclamantion in the else associated with this if...
----------------------------
revision 1.103
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +2 -2

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.102
date: 2012/04/26 18:19:27;  author: tswift;  state: Exp;  lines: +48 -21

Updates so that incremental tabling works with full WFS.

Also refactored the incremental tabling code a little.
----------------------------
revision 1.101
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +34 -18

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.100
date: 2012/03/01 21:26:49;  author: tswift;  state: Exp;  lines: +18 -18

Some documentation updates, changes to more meaningful names, and the
start of a function that might be used in lazy incremental tabling.
----------------------------
revision 1.99
date: 2012/03/01 16:40:09;  author: tswift;  state: Exp;  lines: +11 -10

Some very minor refactorig and change of a variable name to make it
more comprehensible.
----------------------------
revision 1.98
date: 2012/02/19 19:17:56;  author: tswift;  state: Exp;  lines: +2 -2

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.97
date: 2012/02/12 22:49:12;  author: tswift;  state: Exp;  lines: +2 -3

Fixed bug in throwing exceptions with incomplete tables.  Now tables
are reclaimed by unwind stack so that they stop *between* SCCs: this
allows us to continue reclaiming incomplete tables while at the same
time ensuring that we wont backtrack into a choice point for one of
those tables that we reclaimed.
----------------------------
revision 1.96
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +37 -22

Integrating in Call Abstraction
----------------------------
revision 1.95
date: 2011/08/19 21:44:15;  author: tswift;  state: Exp;  lines: +33 -1

Mostly minor changes to let ctrace print out early completion, and to
allow ctrace to be directed to stdout rather than a file if desired.
This necessitated some minor code refactoring.
----------------------------
revision 1.94
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +2 -2
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.93
date: 2011/08/03 18:12:54;  author: tswift;  state: Exp;  lines: +17 -3

Added Call abstraction stuff (mostly commented out).
----------------------------
revision 1.92
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +6 -5

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.91
date: 2011/07/22 21:39:35;  author: tswift;  state: Exp;  lines: +3 -2

Unioning deltf_ptr and ans_list_tail to save a word from subgoal frames.
----------------------------
revision 1.90
date: 2011/06/05 19:24:03;  author: tswift;  state: Exp;  lines: +7 -8



Changes to

1) Add flag-controlled answer depth checks to variant answer
tables.  (See current_prolog_flag in the manual for details).

2) In support of 1, added sprint_term, which prints a term to a C
string.  This is useful for errors and warnings invoked by C.

3) Added MAXTOINDEX_FLAG, which allows experimentation with the
depth of * indexing.

4) Increased the initial size strbuff from 1000 -> 10000.  This
reduces spurious long atom warnings.
----------------------------
revision 1.89
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.88
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +3 -3

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.87
date: 2011/04/12 17:31:59;  author: tswift;  state: Exp;  lines: +8 -8

Fix of abolishing incremental tables when the affected list is
non-empty -- it needed to be re-initialized to null.  In addition, the
changed list also needs to be initted and reinitialized to null, but
this is accessed less often so we haven't yet seen that problem arise.

I also changed the name of the global variables for incremental
tabling to make them more obvious -- names like "changed" and
"affected" arent good.
----------------------------
revision 1.86
date: 2010/12/23 18:12:43;  author: tswift;  state: Exp;  lines: +11 -3

The handling of answer templates within the SLG instructions is
extremely confusing, as there is a CallInfo and a CallLUR answer
template AND an answer template may be on the CPS or the heap at
different times.  I renamed some variables to make it clear wither the
AT was on the heap or CPS, and added a few comments.
----------------------------
revision 1.85
date: 2010/12/09 19:15:38;  author: tswift;  state: Exp;  lines: +16 -13

Added a return code for tabled_call_check_incr, to handle failures
from variant_call_check.
----------------------------
revision 1.84
date: 2010/12/09 17:55:53;  author: tswift;  state: Exp;  lines: +33 -33

Changed CallLUR_VarVector to CallLUR_AnsTempl, which is much more
meaningful (to me, at least).
----------------------------
revision 1.83
date: 2010/09/05 18:47:17;  author: tswift;  state: Exp;  lines: +2 -2

Fixes to make incremental tabling work properly when opaque is
switched to incremental.  I had made a fix to predicate_property to
distinguish incremenel from opaque that apparently broke things.
----------------------------
revision 1.82
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +3 -7
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.81
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.80
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.79
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.78
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.77
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +7 -3
no message
----------------------------
revision 1.76
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.75
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.74
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +2 -6
Backed out code
----------------------------
revision 1.73
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +7 -3
Dipti's code for support graph added
----------------------------
revision 1.72
date: 2010/04/24 20:50:43;  author: tswift;  state: Exp;  lines: +3 -3
branches:  1.72.2;

Changes for incremental tabling based on tries.
----------------------------
revision 1.71
date: 2010/03/18 22:22:17;  author: tswift;  state: Exp;  lines: +9 -4

Added subgoal depth check with actions of fail and error (cf pg. 165 of the manual)
----------------------------
revision 1.70
date: 2009/11/17 19:32:08;  author: dwarren;  state: Exp;  lines: +7 -3
Added pointers in the Child field of leaf nodes of answers to point to
the ALN node *preceding* the ALN node that points to it.
This pointer is used in the deletion of an answer.
It is tagged so that it can be known what the pointer is.
If there are conditional answers, this field is used for pointing
to the delay elements, and so is not used for this ALN pointer.
In that case, the entire ALN list must be run when deleting an answer
with a delay list.
----------------------------
revision 1.69
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +7 -4

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.68
date: 2009/11/16 15:49:21;  author: tswift;  state: Exp;  lines: +17 -14

tries.c -- fixed (sort of) a heap-overflow bug when returning large
answers with delay lists.

sub_tables_xsb.i and tables.c -- just some code cleanup.
----------------------------
revision 1.67
date: 2009/11/08 18:29:22;  author: tswift;  state: Exp;  lines: +3 -3

No functionality changes -- just some name changes and simplifications
in preparation for my trip to Portugal.

These were mostly name changes, but I did get rid of a few functions
-- not for efficiency but for simplicity.
----------------------------
revision 1.66
date: 2009/01/24 21:57:07;  author: tswift;  state: Exp;  lines: +2 -1

Initializing VarEnumerator in subsumptive answer search.  This is
used to copy in conditional answer information, and will hopefully fix an initialization error detected by valgrind.
----------------------------
revision 1.65
date: 2009/01/03 20:22:48;  author: tswift;  state: Exp;  lines: +1 -1

Fixed typo in tables.c

In tst_aux.h fixed so that tables created by call subsumption allow
attributed variable constraints in their answers (including in delay
elements).  Calls in call subsumption still cannot include attributed
variables -- I need to understand more about Bao's algorithm before
I'll be ready to add them there.  But having them in answers takes us
at least part of the way.
----------------------------
revision 1.64
date: 2009/01/03 01:11:26;  author: tswift;  state: Exp;  lines: +17 -5

Changes were mostly for documentation and code refactoring.

However, also fixed a latent bug in simplification where
was_simplifiable was not properly checking negative delay elements
corresponding to subsumed subgoal frames.  This led to the possibility
of adding un-needed delay elements that might not have been simplified
away.  Surprisingly enough, however, none of the tests in the test
suite checked for this.
----------------------------
revision 1.63
date: 2009/01/02 17:50:03;  author: tswift;  state: Exp;  lines: +3 -10


Updating a number of files so that delete_branch() will work with call
subsumption (it needs to know that it deallocates BTNs rather than
TSTNs).  This fixed a latent bug in simplification and allows another
test to be run for call subsumption. It also provides a step towards
supporting answer subsumption on call subsumptive tables.  There are
also some other documentationstyle changes.

Adding a new test for copying attributed variables into delay elements
/ lists.  I hadn't thought this worked, but apparently it does !

Also, I'm adding a very simple test for incremental evaluation -- more
cases need to be added here, but at least this is a start.
----------------------------
revision 1.62
date: 2009/01/01 00:07:22;  author: tswift;  state: Exp;  lines: +1 -16
Changes to get rid of sloppy extern statements, and put them into a .h file where they should be.
----------------------------
revision 1.61
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +42 -41


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.60
date: 2008/08/20 19:47:57;  author: tswift;  state: Exp;  lines: +14 -1


A change to stack reallocation from last January uncovered a bug
in Call subsumption, which copied the substitution factor from
the CPS to the heap.  Because of this, it is necessary to reset
pointers from the heap every time the glstack is reallocated,
regardless of whether the heap itself is moved.  So this change
revises the code to always reset heap pointers upon glstack
realloc.  See the documentation in tables.c to see why this is a
safe solution and the heap Substitution factor does not cause
other problems.

This fixes some core dumps in call subsumption.  The bug
exhibited itself on Linux and the Mac for a particular test
program, but the bug could show up anywhere.

Change in trace_xsb.c to fix table operation counts for the MT
engine.
----------------------------
revision 1.59
date: 2008/08/01 17:42:10;  author: tswift;  state: Exp;  lines: +8 -1

Fixed an overlooked case and two typos for global variables used for counting subsumptive tables.  These counters should not be used for the MT-OPT engine as they signficantly slow down concurrency.
----------------------------
revision 1.58
date: 2008/06/05 18:15:13;  author: ruim;  state: Exp;  lines: +4 -1
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.57
date: 2007/12/06 23:24:55;  author: ruim;  state: Exp;  lines: +3 -1
replaced shared struct manangers with malloc
which improves scalabilty on a multi-processor

that required a number of small fixes to have coherency
between shared and private struct managers
----------------------------
revision 1.56
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.55
date: 2007/06/06 19:15:14;  author: tswift;  state: Exp;  lines: +2 -1

Initialized TIF_Visited field -- not doing this causes some core dumps on Windows and Linux.
----------------------------
revision 1.54
date: 2007/06/01 22:47:10;  author: tswift;  state: Exp;  lines: +18 -18

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.53
date: 2006/12/03 17:09:28;  author: ruim;  state: Exp;  lines: +3 -4
Bug fix for concurrent completion:
  added a lock to protect insertion of consumers on subgoal asf list
----------------------------
revision 1.52
date: 2006/11/29 02:10:21;  author: ruim;  state: Exp;  lines: +3 -5
fixed shared completed tables call trie lock bug - it was an optical
ilusion because of the tangled if-ifdef structure

initialize lock even for private tifs, just in case they become shared
removed ifdef out incremental stuff for mt that looked prejudicial
----------------------------
revision 1.51
date: 2006/11/28 22:43:06;  author: tswift;  state: Exp;  lines: +7 -7

Changes in documentation mostly -- but also ifdeffed out some incremental completion stuff that seemed not to work with multi-threading.
----------------------------
revision 1.50
date: 2006/11/15 16:38:10;  author: tswift;  state: Exp;  lines: +3 -1

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.49
date: 2006/11/09 14:52:25;  author: ruim;  state: Exp;  lines: +2 -2
Fixed bug with private tables
----------------------------
revision 1.48
date: 2006/11/06 17:31:53;  author: ruim;  state: Exp;  lines: +4 -3
Fixes to CONC_COMPL:

- compl stack expansion fixed
- freeing of answer_return list finally fixed

it now runs all the tests that batched runs
----------------------------
revision 1.47
date: 2006/11/06 12:02:19;  author: ruim;  state: Exp;  lines: +2 -2
Taken out lock on subgoal frame as it doesn't seem necessary
Fixed check for reclamation of private tables answer return list
for concurrent completion
----------------------------
revision 1.46
date: 2006/11/05 23:53:15;  author: ruim;  state: Exp;  lines: +5 -2
Several changes & fixes for Concurrent Completion:
- Locking of the answer return list and consumer list at subgoal frame level
- No longer a dummy generator choice point is created for every external
  consumer
- Threads which don't have a stale view of the round are no longer awaken at
  completion
- The answer return list is not reclaim for shared tables
----------------------------
revision 1.45
date: 2006/11/05 13:59:43;  author: ruim;  state: Exp;  lines: +2 -1
added lock to call trie in MT
private tables initialize and destroy the lock, but don't use it
otherwise
----------------------------
revision 1.44
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +226 -6
Incremental Code Added.
----------------------------
revision 1.43
date: 2006/03/27 00:13:54;  author: tswift;  state: Exp;  lines: +2 -1

1) Split DelTF chain into private and shared chains.  This fixed
   a bug with table garbage collection, but also enabled me to
   allow garbage collection of a threads private tables when
   there is more than one active thread.

2) Extended the delay of space reclamation to abolished subgoals,
   and added subgoal reclamation to the table garbage collector.

I also added tests for these: lease update the various test
suites as the gc stuff may be a little brittle.
----------------------------
revision 1.42
date: 2006/03/24 16:40:29;  author: tswift;  state: Exp;  lines: +3 -1

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.41
date: 2006/03/18 17:37:49;  author: tswift;  state: Exp;  lines: +57 -1
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.40
date: 2006/03/17 18:17:59;  author: tswift;  state: Exp;  lines: +1 -68


Some updates to fix bugs in table abolishing and garbage
collecting.  Many of the changes have to do with refactoring code
to make it a little faster as well as to reduce bugs.

In addition, there are associated additional files in the test suite.

I'll be making more changes, and hopefully finishing over the weekend.
----------------------------
revision 1.39
date: 2006/03/15 13:15:54;  author: tswift;  state: Exp;  lines: +9 -5


Introduced two new predicates: abolish_private_tables, and
abolish_shared_tables (CPS check for these predicates is not yet
done).

Fixed bug (I think) for null parent pointer in CPS check.

Adding new test for abolishing tables to testsuite.
----------------------------
revision 1.38
date: 2006/01/14 16:39:34;  author: dwarren;  state: Exp;  lines: +5 -2
Conditioned inline decl to non win32 (MSVC doesn't allow inline across
compilation units.)
----------------------------
revision 1.37
date: 2006/01/12 21:33:52;  author: tswift;  state: Exp;  lines: +79 -10
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.36
date: 2006/01/09 00:06:32;  author: tswift;  state: Exp;  lines: +59 -7
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.35
date: 2005/12/22 23:33:59;  author: tswift;  state: Exp;  lines: +4 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.34
date: 2005/10/28 21:50:29;  author: tswift;  state: Exp;  lines: +16 -10

These changes are for documentation only, before I go ahead and fiddle around with some trie stuff.
----------------------------
revision 1.33
date: 2005/08/28 16:42:28;  author: ruim;  state: Exp;  lines: +7 -1
phase 1 of implementation of concurrent completion
----------------------------
revision 1.32
date: 2005/08/08 17:11:35;  author: dwarren;  state: Exp;  lines: +4 -4
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.31
date: 2005/01/14 18:31:34;  author: ruim;  state: Exp;  lines: +18 -16
Integration of multithreaded system
----------------------------
revision 1.30
date: 2002/11/04 18:09:03;  author: dwarren;  state: Exp;  lines: +2 -2
Added xsb_throw(msg) as a C function to allow C code to throw balls,
to be caught by a Prolog catch.  Used this mechanism to redefine
xsb_abort, to eliminate abort_cutpoint-like stuff, so that everything
is now done with catch/throw.  Modified slightly the initial readloop
in x_interp and ccallxsb to eliminate the  abort_cutpoint stuff and
use the new catch stuff.
----------------------------
revision 1.29
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +9 -9
branches:  1.29.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.28
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +21 -40
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.27
date: 2002/03/04 09:26:44;  author: kifer;  state: Exp;  lines: +1 -2
branches:  1.27.2;
got rid of unused `dummy' variable
----------------------------
revision 1.26
date: 2002/02/22 21:59:46;  author: lfcastro;  state: Exp;  lines: +5 -3
* Don't call heap expansion from table_call_search()
* Closes bug #521293
----------------------------
revision 1.25
date: 2002/01/28 16:47:56;  author: lfcastro;  state: Exp;  lines: +4 -6
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.24
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +13 -7
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.23
date: 2001/04/28 20:15:37;  author: ejohnson;  state: Exp;  lines: +10 -7
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.22
date: 2000/09/25 15:53:56;  author: ejohnson;  state: Exp;  lines: +24 -1
branches:  1.22.2;
Two subsumption-related changes:

(1) Allow tfindall/3 to be more forgiving to subsumptive predicates.
    Both completed subgoals and those without a subsumer are handled.
    Incomplete subgoals require negation-handling constructs which are
    currently unsupported.

(2) Even though negation for subsumptive predicates are not supported,
    it is still possible to derive conditional answers for subsumptive
    subgoals.  However, this feature is also not supported, so if a
    new answer is derived which is conditional, then the computation
    is aborted.
----------------------------
revision 1.21
date: 2000/06/27 17:59:17;  author: ejohnson;  state: Exp;  lines: +7 -6
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.20
date: 2000/06/26 19:09:27;  author: ruim;  state: Exp;  lines: +7 -7
Getting XSB to compile under g++ AGAIN
----------------------------
revision 1.19
date: 2000/06/25 16:59:16;  author: ejohnson;  state: Exp;  lines: +86 -32
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.18
date: 2000/06/23 20:54:08;  author: ruim;  state: Exp;  lines: +3 -3
Removed some C++ automatic pointer casting warnings
----------------------------
revision 1.17
date: 2000/06/19 07:03:21;  author: ruim;  state: Exp;  lines: +11 -11
Changed variable names from C++ keywords template and new.
----------------------------
revision 1.16
date: 2000/05/29 04:23:38;  author: ejohnson;  state: Exp;  lines: +24 -22
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.15
date: 2000/05/25 00:32:03;  author: ejohnson;  state: Exp;  lines: +62 -54
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.14
date: 2000/05/20 06:56:10;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.13
date: 2000/04/29 21:53:59;  author: kifer;  state: Exp;  lines: +3 -3
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.12
date: 2000/01/25 03:54:40;  author: cbaoqiu;  state: Exp;  lines: +3 -4
branches:  1.12.2;
Minor changes to get rid of the warning messages -- ``The variable
"attv_num" is set but never used'' -- when compiled on SGI 64-bit
machine.
----------------------------
revision 1.11
date: 2000/01/11 16:53:18;  author: ejohnson;  state: Exp;  lines: +2 -2
Movement of definitions from one header to another; this then required
updating #includes for some files.

Predicate evaluation method #def's moved from file flag_defs_xsb.h to
new file table_status_defs.h which houses these and other new #def's.
----------------------------
revision 1.10
date: 2000/01/07 08:51:56;  author: kifer;  state: Exp;  lines: +4 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.9
date: 1999/11/17 17:42:01;  author: ejohnson;  state: Exp;  lines: +2 -4
Warning fixes, noticed under 64-bit mode compilation:
- type mismatches, in assignment and print formats
- unused variables
----------------------------
revision 1.8
date: 1999/10/26 17:25:07;  author: cbaoqiu;  state: Exp;  lines: +9 -13
Changed the substitution factor of the call to support attributed
variables: 1) The arity cell now also contains the number of
attributed variables in the call; 2) Each element of the substitution
factor is a REF cell, NOT a FREE variable.
----------------------------
revision 1.7
date: 1999/10/26 06:47:29;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.6
date: 1999/10/25 05:59:40;  author: kifer;  state: Exp;  lines: +6 -6
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5
date: 1999/10/22 20:57:32;  author: ejohnson;  state: Exp;  lines: +1 -7
Enabled subsumption with CHAT.

The interesting changes are in chat.c and chatsched.i.

Changes to the other files just remove CHAT restrictions to
subsumption.
----------------------------
revision 1.4
date: 1999/10/16 03:00:55;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Correctly set the prototype of function variant_answer_search().
----------------------------
revision 1.3
date: 1999/10/15 17:32:52;  author: cbaoqiu;  state: Exp;  lines: +4 -4
Changed some places where `template_size' appears, so that attv_num in
the substitution factor is considered.  Functions
table_answer_search() and variant_answer_search() are also modified to
accept one more argument -- attv_num.
----------------------------
revision 1.2
date: 1999/10/15 02:54:15;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Changed functions table_consume_answer() and load_solution_trie() to
take one more argument, attv_num (the number of attributed variables
in the substitution factor).
----------------------------
revision 1.1
date: 1999/10/12 19:23:08;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.12.2.1
date: 2000/03/28 18:10:33;  author: lfcastro;  state: Exp;  lines: +1 -3
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.22.2.2
date: 2000/12/19 15:58:20;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.22.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +29 -7
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.27.2.6
date: 2004/12/20 16:26:29;  author: ruim;  state: Exp;  lines: +2 -2
renamed mini_trail to VarEnumerator_trail and put it on thread context
----------------------------
revision 1.27.2.5
date: 2004/11/24 21:53:26;  author: ruim;  state: Exp;  lines: +3 -3
made smBTHT and smBTN thread specific
----------------------------
revision 1.27.2.4
date: 2004/11/22 23:07:34;  author: ruim;  state: Exp;  lines: +3 -3
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.27.2.3
date: 2004/11/22 16:36:31;  author: ruim;  state: Exp;  lines: +2 -1
added lock on struct manager
----------------------------
revision 1.27.2.2
date: 2004/10/18 20:46:12;  author: ruim;  state: Exp;  lines: +22 -41
update for version 2.6.1
----------------------------
revision 1.27.2.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +12 -11
Sources from rfm repository
----------------------------
revision 1.29.2.2
date: 2003/04/17 17:11:37;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.29.2.1
date: 2003/02/11 18:36:10;  author: lfcastro;  state: Exp;  lines: +2 -2
* Disable GC when Demand is enabled.
* Cleanup & fixes on Demand code
* Changes from HEAD regarding exception handling
----------------------------
revision 1.72.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.72.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +6 -2
no message
----------------------------
revision 1.72.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tables.h,v
Working file: tables.h
head: 1.22
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.20
	ROLLBACK: 1.15
	latest_plus_supp_branch: 1.15.0.2
	latest_plus_supp: 1.15
	Version_3dot2_plus_supp: 1.14.0.2
	release_2_6_plus_supp: 1.8.0.4
	Version_3dot2: 1.14
	dec07-perf-results: 1.13
	mt_thesis: 1.13
	release_3_0: 1.12
	release_2_7_0: 1.8
	multi-threaded-26-engine: 1.7.6.2
	pre-mt: 1.8
	multi-threaded-25-engine-done: 1.7.6.1
	multi-threaded-25-engine: 1.7.0.6
	release_2_6_1: 1.8
	release_2_6_final: 1.8
	release_2_6: 1.8.0.2
	last-merged-to-demand: 1.7
	demand_branch: 1.7.0.4
	before_removing_chat: 1.7
	release_2_5: 1.7
	pre-merge-slgwam-gc: 1.7
	multi-threaded-c-engine: 1.7.0.2
	release_2_4: 1.7
	release_2_3: 1.7
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.5
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.3
	release-2-0-1: 1.3
	subsumption: 1.3
keyword substitution: kv
total revisions: 33;	selected revisions: 33
description:
----------------------------
revision 1.22
date: 2011/08/19 21:44:15;  author: tswift;  state: Exp;  lines: +3 -1

Mostly minor changes to let ctrace print out early completion, and to
allow ctrace to be directed to stdout rather than a file if desired.
This necessitated some minor code refactoring.
----------------------------
revision 1.21
date: 2010/12/09 19:15:38;  author: tswift;  state: Exp;  lines: +2 -2

Added a return code for tabled_call_check_incr, to handle failures
from variant_call_check.
----------------------------
revision 1.20
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.19
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.18
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.15
date: 2010/03/18 22:22:17;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.15.2;

Added subgoal depth check with actions of fail and error (cf pg. 165 of the manual)
----------------------------
revision 1.14
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +2 -1


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.13
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +2 -1
Incremental Code Added.
----------------------------
revision 1.12
date: 2006/01/12 21:33:52;  author: tswift;  state: Exp;  lines: +2 -2
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.11
date: 2006/01/09 00:06:33;  author: tswift;  state: Exp;  lines: +2 -2
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.10
date: 2005/12/22 23:34:00;  author: tswift;  state: Exp;  lines: +3 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.9
date: 2005/01/14 18:31:34;  author: ruim;  state: Exp;  lines: +6 -6
Integration of multithreaded system
----------------------------
revision 1.8
date: 2002/11/05 20:50:37;  author: lfcastro;  state: Exp;  lines: +3 -4
* First cut at an implementation for abolish_table_call/1.
  - at this point, this call deletes all subsuming tables of a given
  term, via backtracking; what is the desired semantics?

*** WARNING ***
This is not a "safe" operator. It does not perform any kind of
checking, so one may, in fact, delete a table which is in use. This
may cause undefined behavior (i.e. segmentation faults and the like).
----------------------------
revision 1.7
date: 2001/01/31 10:23:29;  author: ejohnson;  state: Exp;  lines: +53 -1
branches:  1.7.4;  1.7.6;
Created the macro "table_pending_answer" to hide the details of
obtaining the next answer for consumption, which, in the case of a
properly subsumed subgoal, may require an answer identification step.

Second, removed -- again -- (most) "xtemp1" references.
(Argh!  How does this crap keep creeping back into the system?!?)

These were sprinkled over several files and removed by simply creating
a variable local to each macro in which a temp was needed.

The "need" for this change was precipitated due to the inclusion of an
"xtemp1" declaration within one of the code blocks which
table_pending_answer replaced.
----------------------------
revision 1.6
date: 2000/06/27 17:59:17;  author: ejohnson;  state: Exp;  lines: +2 -2
branches:  1.6.2;
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.5
date: 2000/05/29 04:23:39;  author: ejohnson;  state: Exp;  lines: +5 -5
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.4
date: 2000/04/29 21:54:00;  author: kifer;  state: Exp;  lines: +2 -2
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.3
date: 1999/10/15 17:32:53;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changed some places where `template_size' appears, so that attv_num in
the substitution factor is considered.  Functions
table_answer_search() and variant_answer_search() are also modified to
accept one more argument -- attv_num.
----------------------------
revision 1.2
date: 1999/10/15 02:54:15;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changed functions table_consume_answer() and load_solution_trie() to
take one more argument, attv_num (the number of attributed variables
in the substitution factor).
----------------------------
revision 1.1
date: 1999/10/12 19:23:09;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.7.6.2
date: 2004/10/18 20:46:12;  author: ruim;  state: Exp;  lines: +3 -4
update for version 2.6.1
----------------------------
revision 1.7.6.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +6 -6
Sources from rfm repository
----------------------------
revision 1.7.4.4
date: 2003/04/17 17:11:37;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.7.4.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +2 -3
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.7.4.2
date: 2002/08/07 17:53:30;  author: lfcastro;  state: Exp;  lines: +4 -3
* update to HEAD
----------------------------
revision 1.7.4.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +3 -4
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.15.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.15.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.15.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/tc_insts.i,v
Working file: tc_insts.i
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.7
	without-attv: 1.6
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.9
date: 1999/10/25 05:59:41;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.8
date: 1999/10/19 02:48:56;  author: cbaoqiu;  state: Exp;  lines: +32 -1
Changed variant_answer_search() and trie code instructions to handled
attributed variables.
----------------------------
revision 1.7
date: 1999/10/12 20:10:23;  author: kostis;  state: Exp;  lines: +112 -58
Localized uses of tbreg and cleaned up some stuff.
----------------------------
revision 1.6
date: 1999/08/16 07:24:33;  author: kifer;  state: Exp;  lines: +50 -51
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.5
date: 1999/07/15 21:41:18;  author: ejohnson;  state: Exp;  lines: +6 -6
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.4
date: 1999/07/06 16:35:18;  author: ejohnson;  state: Exp;  lines: +219 -140
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.3
date: 1999/04/22 06:49:24;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.2
date: 1998/12/21 01:08:56;  author: cbaoqiu;  state: Exp;  lines: +131 -99
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tc_insts_xsb_i.h,v
Working file: tc_insts_xsb_i.h
head: 1.45
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.34
	ROLLBACK: 1.29
	latest_plus_supp_branch: 1.29.0.2
	latest_plus_supp: 1.29
	Version_3dot2_plus_supp: 1.28.0.2
	release_2_6_plus_supp: 1.15.0.6
	Version_3dot2: 1.28
	dec07-perf-results: 1.27
	mt_thesis: 1.25
	release_3_0: 1.25
	release_2_7_0: 1.15
	multi-threaded-26-engine: 1.13.2.3
	pre-mt: 1.15
	multi-threaded-25-engine-done: 1.13.2.1
	multi-threaded-25-engine: 1.13.0.2
	release_2_6_1: 1.15
	release_2_6_final: 1.15
	release_2_6: 1.15.0.4
	last-merged-to-demand: 1.15
	demand_branch: 1.15.0.2
	before_removing_chat: 1.13
	release_2_5: 1.13
	pre-merge-slgwam-gc: 1.11
	multi-threaded-c-engine: 1.11.0.2
	release_2_4: 1.11
	release_2_3: 1.11
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.6
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 53;	selected revisions: 53
description:
----------------------------
revision 1.45
date: 2012/02/19 19:17:56;  author: tswift;  state: Exp;  lines: +97 -54

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.44
date: 2011/08/20 21:36:49;  author: tswift;  state: Exp;  lines: +3 -3

Fixed bug in hash opcode where it was throwing an error when encountering an attv.

Will go through occurrences of isref() to make sure things are attv safe (or at least to triage).
----------------------------
revision 1.43
date: 2011/05/28 15:18:46;  author: tswift;  state: Exp;  lines: +3 -2

tc_insts -- restricted some scaffolding to NON_OPT_COMPILE
tries    -- changed some variable names to be less confusing (maybe just to me...)
----------------------------
revision 1.42
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +3 -3
Getting Linux to Work
----------------------------
revision 1.41
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.40
date: 2011/02/11 15:08:03;  author: tswift;  state: Exp;  lines: +53 -107

Fixes for attributed variable bug (typo fix) and fix for atom_codes
when it encounters a 0-ary predicate.
----------------------------
revision 1.39
date: 2011/01/09 22:30:16;  author: tswift;  state: Exp;  lines: +4 -4

Minor code cleanup: some changes in documentation, changes to make a
function name accord with a builtin name, and moved some table
abolishing routines from tries.c to tr_utils.c with all the others.
----------------------------
revision 1.38
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +106 -42

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.37
date: 2010/12/30 23:54:57;  author: tswift;  state: Exp;  lines: +2 -35
Restored consistent use of a macro within trie instructions.
----------------------------
revision 1.36
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +36 -36

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.35
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +55 -55

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.34
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.33
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.32
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.31
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.30
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.29
date: 2009/11/08 18:29:22;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.29.2;

No functionality changes -- just some name changes and simplifications
in preparation for my trip to Portugal.

These were mostly name changes, but I did get rid of a few functions
-- not for efficiency but for simplicity.
----------------------------
revision 1.28
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +9 -8


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.27
date: 2007/05/10 16:29:08;  author: tswift;  state: Exp;  lines: +62 -4

Minor changes:

tc_insts -- added some reserve code for testing, and some minor optimization of trie code
emuloop.c -- added a comment (from an email of David)
memory_xsb.h -- took out an old ifdef that confused me one too many times.
----------------------------
revision 1.26
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +3 -3
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.25
date: 2005/12/12 18:44:53;  author: dwarren;  state: Exp;  lines: +3 -2
Added string table garbage collection.
----------------------------
revision 1.24
date: 2005/12/07 13:23:02;  author: ruim;  state: Exp;  lines: +3 -3
removed rw lock from tries in Multi-threaded engine
----------------------------
revision 1.23
date: 2005/11/08 01:07:15;  author: tswift;  state: Exp;  lines: +12 -12

Minor updates to documentation for clarity.
----------------------------
revision 1.22
date: 2005/11/01 00:36:20;  author: tswift;  state: Exp;  lines: +43 -6

These changes continue the documentation effort on trie routines for variant tabling, as well as handling attributed variables from within tries.

In terms of changing code, I did change arity in variant_answer_search to sf_size, and took out what seem to be two unnecessary heap assignments for attributed variables.
----------------------------
revision 1.21
date: 2005/10/21 17:47:52;  author: tswift;  state: Exp;  lines: +3 -2


These are documentation changes only, made while stumbling through unfamiliar code.  I wanted to get them in before I started to make code changes.
----------------------------
revision 1.20
date: 2005/10/10 20:25:14;  author: tswift;  state: Exp;  lines: +2 -2

Once more with feeling -- fixed a bug that allows the inst not to lay down an unnecessary choicepoint.
----------------------------
revision 1.19
date: 2005/10/10 19:56:54;  author: tswift;  state: Exp;  lines: +4 -2

Fixed buglet with uninitialed variable hash_header in instruction hash_opcode.
----------------------------
revision 1.18
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +47 -31


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.17
date: 2005/07/18 19:47:46;  author: tswift;  state: Exp;  lines: +2 -1

picayune (my word for the day) changes in predicate names and a little added documentation
based on reviewing abolish_table_pred and friends.
----------------------------
revision 1.16
date: 2005/01/14 18:31:34;  author: ruim;  state: Exp;  lines: +65 -2
Integration of multithreaded system
----------------------------
revision 1.15
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +45 -45
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.14
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +45 -117
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.13
date: 2002/01/28 16:47:56;  author: lfcastro;  state: Exp;  lines: +32 -2
branches:  1.13.2;
* Updated GC stack-dumping to dump better approx. of # of registers
* Fixed some warnings
----------------------------
revision 1.12
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +83 -2
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.11
date: 2001/01/31 10:23:29;  author: ejohnson;  state: Exp;  lines: +1 -18
Created the macro "table_pending_answer" to hide the details of
obtaining the next answer for consumption, which, in the case of a
properly subsumed subgoal, may require an answer identification step.

Second, removed -- again -- (most) "xtemp1" references.
(Argh!  How does this crap keep creeping back into the system?!?)

These were sprinkled over several files and removed by simply creating
a variable local to each macro in which a temp was needed.

The "need" for this change was precipitated due to the inclusion of an
"xtemp1" declaration within one of the code blocks which
table_pending_answer replaced.
----------------------------
revision 1.10
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +128 -139
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.9
date: 2000/07/31 20:27:56;  author: ejohnson;  state: Exp;  lines: +2 -2
branches:  1.9.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.8
date: 2000/07/21 04:35:28;  author: cbaoqiu;  state: Exp;  lines: +30 -1
Added two missed attv trie instructions.
----------------------------
revision 1.7
date: 2000/06/22 01:27:51;  author: lfcastro;  state: Exp;  lines: +104 -104
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.6
date: 2000/05/19 21:18:43;  author: lfcastro;  state: Exp;  lines: +1 -2
removed save_find_locx(ereg) from trie_assert_inst, as suggested by
Bart.
----------------------------
revision 1.5
date: 2000/05/19 11:45:32;  author: tswift;  state: Exp;  lines: +2 -2

Fixed problem with double occurrance of save_find_locx in trie_try_var
----------------------------
revision 1.4
date: 2000/04/29 21:54:00;  author: kifer;  state: Exp;  lines: +3 -3
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.3
date: 1999/12/11 08:07:08;  author: cbaoqiu;  state: Exp;  lines: +1 -2
Removed the line which redundantly set `num_vars_in_var_regs = -1' in
`case trie_proceed:', since num_vars_in_var_regs will be set to -1 in
macro proceed_lpcreg anyway.
----------------------------
revision 1.2
date: 1999/10/26 06:47:30;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:59:42;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:11;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.13.2.3
date: 2004/11/18 16:03:26;  author: ruim;  state: Exp;  lines: +5 -7
put backtrack unlock on tries in get calls
----------------------------
revision 1.13.2.2
date: 2004/10/18 20:46:12;  author: ruim;  state: Exp;  lines: +49 -121
update for version 2.6.1
----------------------------
revision 1.13.2.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +67 -2
Sources from rfm repository
----------------------------
revision 1.29.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.29.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.29.2.1
date: 2010/06/19 19:36:21;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/term_psc_xsb_i.h,v
Working file: term_psc_xsb_i.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1.12.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1.12.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2005/08/08 17:11:35;  author: dwarren;  state: Exp;  lines: +5 -3
branches:  1.3.4;
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.2
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.1
date: 1999/12/10 07:47:40;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.12;
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.1.12.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +5 -1
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/thread_defs_xsb.h,v
Working file: thread_defs_xsb.h
head: 1.43
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.43
	ROLLBACK: 1.39
	latest_plus_supp_branch: 1.39.0.4
	latest_plus_supp: 1.39
	Version_3dot2_plus_supp: 1.39.0.2
	Version_3dot2: 1.39
	dec07-perf-results: 1.38
	mt_thesis: 1.26
	release_3_0: 1.19
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.2.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.2.1
	multi-threaded-25-engine: 1.2.0.2
	multi-threaded-engine: 1.1.0.2
keyword substitution: kv
total revisions: 51;	selected revisions: 51
description:
----------------------------
revision 1.43
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.42
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.41
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.40
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.39
date: 2008/04/27 15:23:32;  author: tswift;  state: Exp;  lines: +1 -0
branches:  1.39.4;

Changes so that error status is available to on_exit handler.
----------------------------
revision 1.38
date: 2007/10/23 15:53:19;  author: ruim;  state: Exp;  lines: +1 -0
Introduced command line option max_mqueues to specify maximum limit for
message queues

Rationalized use of max_threads_glc wrt sequential engine
----------------------------
revision 1.37
date: 2007/10/20 19:13:01;  author: tswift;  state: Exp;  lines: +2 -1


Made some small fixes in init_mq_table -- it appears that some of the
private signal queues were being kept in the private message queue
free list.

Changed some fields in mq table to bit fields.

Ensured that private signal queues are initialized on thread startup.

Cleared up some confusion in creating message queues with default
value vs. creating unbounded message queues.  Now macros are used to
differentiate the two cases.

In cut_code.h, cleaned up some messy code and added documentation.
----------------------------
revision 1.36
date: 2007/09/07 21:17:54;  author: tswift;  state: Exp;  lines: +2 -3
Modifications for thread_property/2.
Added statuses as property type, and now am allowing variable first argument, so that all valid threads can be backtracked through for their properties.
----------------------------
revision 1.35
date: 2007/08/04 19:51:19;  author: tswift;  state: Exp;  lines: +3 -0
Changes for message_queue peek
----------------------------
revision 1.34
date: 2007/08/03 20:34:56;  author: tswift;  state: Exp;  lines: +5 -5

Changes to allow an override to restriction that only one thread may be active during a load.

In doing this, I refined the mutexes for syscalls so that system calls only use a mutex when using the proc table.
----------------------------
revision 1.33
date: 2007/07/24 19:07:24;  author: ruim;  state: Exp;  lines: +3 -0
changes to make thread cancellation more roubust
----------------------------
revision 1.32
date: 2007/07/12 22:53:03;  author: tswift;  state: Exp;  lines: +1 -0
Added contexts for heap overflow check functions

Added queue aliases to message_queue_create, thread_send_message, and
thread_queue_message.

Added mutex aliases for all mutex functions to make them consistent with ISO working group.

Made default maximum queue terms a changeable XSB flag.

Wrote Prolog stub for message_queue_destroy

Manual updated, and mttest suite changed.
----------------------------
revision 1.31
date: 2007/07/07 21:02:08;  author: tswift;  state: Exp;  lines: +14 -0
-- Added usleep

-- Fixed concurrency bug with thread aliases in thread create.

-- made thread_join/thread_detach allow thread aliases
on input, and isoified their errors

-- Makde thread_self allow thread aliases on input.  The errors for
   this predicate different from ISO -- I dont really with their error
   designation in this case (at least not yet).

-- made thread_join, thread_detach, and thread_exit all properly
   remove aliases if applicable

-- Brought thread exit statuses in line with ISO working standard
   (mostly -- for now, we still have a cancelled status)

-- Added numerous tests for thread manipulation predicates to mttests.
----------------------------
revision 1.30
date: 2007/06/26 16:59:59;  author: tswift;  state: Exp;  lines: +3 -1

Now allowing modifications of default values for thread create via xsb_flag.
Altered thread create so that values can either be explicitly passed in, or obtained from flags.

Also, added usleep() as a temporary fix to a problem that I'll send out a note about.
----------------------------
revision 1.29
date: 2007/04/24 18:35:31;  author: tswift;  state: Exp;  lines: +9 -1

First pass at message queues.
----------------------------
revision 1.28
date: 2007/01/25 20:33:56;  author: tswift;  state: Exp;  lines: +2 -0


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.27
date: 2007/01/12 23:33:29;  author: tswift;  state: Exp;  lines: +3 -0

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.26
date: 2006/12/03 17:09:29;  author: ruim;  state: Exp;  lines: +4 -3
Bug fix for concurrent completion:
  added a lock to protect insertion of consumers on subgoal asf list
----------------------------
revision 1.25
date: 2006/11/30 21:50:09;  author: ruim;  state: Exp;  lines: +2 -2
added names to the pseudo mutexes
added max_threads_sofar a statistic for peak thread number
----------------------------
revision 1.24
date: 2006/11/30 21:10:24;  author: ruim;  state: Exp;  lines: +9 -2
Moved DELAY_MUTEX in, in do_delay_stuff_shared to avoid unneeded locks

New Feature:
 Pseudo Mutexes

  These are system mutexes which are just used for counting in place of
  either sets of mutexes (call trie, struct manager) or mutexes
  that really don't fit in the SYS_MUTEX convention (completing_mut,
  th_mutex)

  It allows to re-use the statistics stuff for these mutexes.
----------------------------
revision 1.23
date: 2006/11/28 22:43:06;  author: tswift;  state: Exp;  lines: +2 -2

Changes in documentation mostly -- but also ifdeffed out some incremental completion stuff that seemed not to work with multi-threading.
----------------------------
revision 1.22
date: 2006/11/15 16:38:10;  author: tswift;  state: Exp;  lines: +3 -0

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.21
date: 2006/10/18 17:12:37;  author: dwarren;  state: Exp;  lines: +0 -1
Remove unnecessary ATOM_BUFF mutex, and fix memory allocation for atom_to_list.
----------------------------
revision 1.20
date: 2006/08/11 20:30:33;  author: tswift;  state: Exp;  lines: +10 -4

Additions of ISO-style user mutexes.
----------------------------
revision 1.19
date: 2006/03/24 16:40:29;  author: tswift;  state: Exp;  lines: +4 -0

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.18
date: 2006/03/18 17:37:49;  author: tswift;  state: Exp;  lines: +5 -0
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.17
date: 2006/03/15 13:15:54;  author: tswift;  state: Exp;  lines: +3 -0


Introduced two new predicates: abolish_private_tables, and
abolish_shared_tables (CPS check for these predicates is not yet
done).

Fixed bug (I think) for null parent pointer in CPS check.

Adding new test for abolishing tables to testsuite.
----------------------------
revision 1.16
date: 2006/02/06 20:20:06;  author: tswift;  state: Exp;  lines: +3 -0

Changed default_system_error_handler so that it asserts a fact
'_$thread_exit_ball'/2 if a joinable thread exits via a thrown
error.  Changed xsb_thread_join/2 so that it returns the exit
ball, if any, along with the exit code of the thread.

Using this, created a new predicate, xsb_thread_cancel(Id) which
puts a new thread interrupt on thread Id's interrupt valus.  When
thread Id checks this value, it throws an error, which if
uncaught will cause Id to exit.
----------------------------
revision 1.15
date: 2006/01/29 22:46:05;  author: ruim;  state: Exp;  lines: +5 -0
changed the dispatch block to 256.
added predicates to change the initial stack sizes of threads.
----------------------------
revision 1.14
date: 2006/01/24 14:10:01;  author: tswift;  state: Exp;  lines: +1 -0

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.13
date: 2006/01/23 21:21:31;  author: tswift;  state: Exp;  lines: +3 -0

Fixed bug in is_incomplete: no overflow check was made before
allocating a completion suspension frame.

The bug was uncovered during testing thread-safety of the MT
engine.  This 1-line change took me most of the day to find ...
c'est la vie.
----------------------------
revision 1.12
date: 2005/12/29 20:06:43;  author: tswift;  state: Exp;  lines: +2 -0


Refactored init_machine() to include a new function
init_thread_structures() that includes all initializations that
need to be done on a per-thread basis.  Then mem_dealloc'ed all
thread-specific memory, including varstrings and such in
cleanup_tread_structures() (nee cleanup_machine()).  This change
should affect the MT engine only.

At this point, there should be no memory leaks simply for
creating a thread that exits -- apart from interaction with the
string table, etc.  Also, I'm not freeing space for dispatch
blocks for private predicates, which doesn't seem necessary
overall.  I suppose if we want to get rid of that space, the
reclamation should be done in one of the abolish predicates,
rather than xsb_thread_exit()?
----------------------------
revision 1.11
date: 2005/12/22 23:34:00;  author: tswift;  state: Exp;  lines: +31 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.10
date: 2005/12/13 01:13:45;  author: tswift;  state: Exp;  lines: +1 -0

Added mutex MUTEX_SYS_SYSTEM to protect global process table used
by spawn_process() and related functions.
----------------------------
revision 1.9
date: 2005/11/20 21:23:29;  author: dwarren;  state: Exp;  lines: +1 -0
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.8
date: 2005/11/17 23:24:25;  author: tswift;  state: Exp;  lines: +2 -1



Added new mutex, MUTEX_DELAY to synchronize management of de-s
dl-s and pnde-s.  For now, memory management of these data
structures uses common global variables, even in private tables,
hence the need for a mutex.

My placing of the mutexes within the code is still a little
uncertain.  On the one hand, I've over approximated a little so
that (I think) any of the memory management routines are covered.
I've also covered simplification routines (which do not directly
call the mem-management routines), though I'm not entirely
certain that the mutexes are needed there with shared tables and
our algorithm for shared concurrent tables.  More insight on
mutexes and simplification will undoubtedly come with paper
writing.

In addition, we should think in the future about managing de-s,
dl-s and pnde's for private tables using thread-specific memory
management routines.
----------------------------
revision 1.7
date: 2005/07/26 22:46:24;  author: crojo;  state: Exp;  lines: +1 -0

Fixed the ODBC interface in the multithreaded configuration.
----------------------------
revision 1.6
date: 2005/07/11 21:43:57;  author: dwarren;  state: Exp;  lines: +1 -0
Added thread_yield builtin to allow thread to give up the cpu to other threads.
----------------------------
revision 1.5
date: 2005/07/08 00:54:25;  author: dwarren;  state: Exp;  lines: +23 -19
Fixes to sockets for multi-threading, by Chris Rued.
----------------------------
revision 1.4
date: 2005/07/03 22:27:44;  author: ruim;  state: Exp;  lines: +1 -0
fixed multi-threaded bug with dynamic memory allocation
----------------------------
revision 1.3
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +14 -16
Integration of multithreaded system
----------------------------
revision 1.2
date: 2004/08/26 19:18:57;  author: tswift;  state: Exp;  lines: +70 -0
branches:  1.2.2;
Added for mttestsuite.
----------------------------
revision 1.1
date: 2000/12/22 23:09:50;  author: ruim;  state: dead;
branches:  1.1.2;
file thread_defs_xsb.h was initially added on branch multi-threaded-engine.
----------------------------
revision 1.1.2.3
date: 2001/01/06 18:43:05;  author: ruim;  state: Exp;  lines: +3 -0
Initialization data made static and other small changes
----------------------------
revision 1.1.2.2
date: 2001/01/03 20:04:51;  author: ruim;  state: Exp;  lines: +23 -0
fixes
----------------------------
revision 1.1.2.1
date: 2000/12/22 23:09:50;  author: ruim;  state: Exp;  lines: +12 -0
added last missing file
----------------------------
revision 1.2.2.2
date: 2004/11/22 16:36:31;  author: ruim;  state: Exp;  lines: +13 -12
added lock on struct manager
----------------------------
revision 1.2.2.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +0 -3
Sources from rfm repository
----------------------------
revision 1.39.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.39.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.39.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/thread_xsb.c,v
Working file: thread_xsb.c
head: 1.136
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.127
	ROLLBACK: 1.123
	latest_plus_supp_branch: 1.123.0.2
	latest_plus_supp: 1.123
	Version_3dot2_plus_supp: 1.120.0.2
	Version_3dot2: 1.120
	dec07-perf-results: 1.109
	mt_thesis: 1.65
	release_3_0: 1.46
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.2.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.2.1
	multi-threaded-25-engine: 1.2.0.2
	multi-threaded-engine: 1.1.0.2
keyword substitution: kv
total revisions: 144;	selected revisions: 144
description:
----------------------------
revision 1.136
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +1 -1

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.135
date: 2011/05/22 18:45:32;  author: tswift;  state: Exp;  lines: +7 -7
hopefully nearing 32/64 fixed point
----------------------------
revision 1.134
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +6 -22

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.133
date: 2011/05/19 15:05:05;  author: tswift;  state: Exp;  lines: +0 -1

Fixes to recompile XSB on Mac.
----------------------------
revision 1.132
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +6 -6
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.131
date: 2011/02/23 21:16:36;  author: tswift;  state: Exp;  lines: +7 -7

Fixed some (ignorable) compiler errors on 64-bit Mac.
----------------------------
revision 1.130
date: 2011/01/22 21:18:09;  author: dwarren;  state: Exp;  lines: +8 -8
Changed some format specs to quiet the gcc compiler
----------------------------
revision 1.129
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +8 -8

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.128
date: 2010/10/07 17:58:03;  author: dwarren;  state: Exp;  lines: +18 -0
Finally commited changes to allow the multithreaded version to compile under
Cygwin.  I just if-deffed the differences in types required by the windows
p-thread version and linux's.  A hack, but it works for now.
----------------------------
revision 1.127
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.126
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.125
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.124
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.123
date: 2010/05/02 05:11:26;  author: evansbj;  state: Exp;  lines: +335 -326
branches:  1.123.2;
Update to make thread_exit/1, and xsb_kill_thread work from the C interface. It passes the regression tests as well as before, better actually.
----------------------------
revision 1.122
date: 2010/04/03 23:53:36;  author: evansbj;  state: Exp;  lines: +2 -2
It turns out that pthread_cond_wait can return for reasons other than just the expected signal condition. It should be in a tight while loop that checks an expected state change in something like xsb_ready. Just to be sure that the C thread and the Prolog thread don't collide in signal rich environments.
----------------------------
revision 1.121
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +1 -1

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.120
date: 2008/11/05 18:26:45;  author: tswift;  state: Exp;  lines: +44 -6

Changes to support cancellable thread_sleep
----------------------------
revision 1.119
date: 2008/10/31 23:32:56;  author: tswift;  state: Exp;  lines: +8 -2

Added check to avoid destroying private message queues in message_queue_destroy.
----------------------------
revision 1.118
date: 2008/10/28 12:37:29;  author: tswift;  state: Exp;  lines: +6 -3

Fixed reporting of pthread_mutex routines.
----------------------------
revision 1.117
date: 2008/10/26 15:26:15;  author: tswift;  state: Exp;  lines: +168 -86

Fixed two MT bugs

1) We weren't checking the size of a queue message before copying into the heap

2) We weren't initializing queues for the main thread (0)

ALso, added some scaffolding for queue locking, particularly for debug mode.
----------------------------
revision 1.116
date: 2008/10/09 19:14:56;  author: tswift;  state: Exp;  lines: +1 -1

Moved a deallcoate within the scope of a mutex to avoid a concurrency issue.
----------------------------
revision 1.115
date: 2008/06/05 18:15:13;  author: ruim;  state: Exp;  lines: +2 -2
improvements to shared completed tables
	one condition var per predicate, less wake ups now
	got rid of reset field
	some fixes to the negation code
----------------------------
revision 1.114
date: 2008/04/27 15:23:32;  author: tswift;  state: Exp;  lines: +14 -1

Changes so that error status is available to on_exit handler.
----------------------------
revision 1.113
date: 2008/03/18 14:42:57;  author: pmoura;  state: Exp;  lines: +3 -3
Changed exception term "maximum threads" to simply "threads" for compliance with the ISO Threads DTR.
----------------------------
revision 1.112
date: 2008/03/08 21:50:36;  author: tswift;  state: Exp;  lines: +4 -1

Fixed bug in mutex_unlock_all that did not unlock recursive mutexes that had been multiply locked.
----------------------------
revision 1.111
date: 2008/01/02 19:47:43;  author: dwarren;  state: Exp;  lines: +7 -2
Fix (or at least greatly improve) the C-calling-XSB (recursively) interface for
the multi-threaded engine.  There is still an issue with multiple calls of
different C threads, but sharing the same th-context.  But I think the problem
is in more than just this interface.
----------------------------
revision 1.110
date: 2007/12/26 13:16:08;  author: ruim;  state: Exp;  lines: +6 -0
change to allow awaking threads suspended in condition
variables in windows
----------------------------
revision 1.109
date: 2007/10/26 22:47:33;  author: tswift;  state: Exp;  lines: +4 -1

Changes to support new ISO mutex_property.

tr_utils.c tries.c -- changes are comments
----------------------------
revision 1.108
date: 2007/10/23 15:53:19;  author: ruim;  state: Exp;  lines: +7 -3
Introduced command line option max_mqueues to specify maximum limit for
message queues

Rationalized use of max_threads_glc wrt sequential engine
----------------------------
revision 1.107
date: 2007/10/22 16:14:49;  author: dwarren;  state: Exp;  lines: +0 -2
Moved a define from thread_xsb.c to thread_xsb.h so it can be seen where used in
init_xsb.  (Terry, correct this if wrong.)
----------------------------
revision 1.106
date: 2007/10/21 13:36:48;  author: ruim;  state: Exp;  lines: +124 -66
added lock to mq table
verified if the q has been destroyed and re-created
several small fixes, specially in destroying mqs and
checking for destruction of mqs

Note - the private and signal queues are destroyed when the thread *exits*
not waiting for it to be joined
----------------------------
revision 1.105
date: 2007/10/20 19:13:01;  author: tswift;  state: Exp;  lines: +19 -8


Made some small fixes in init_mq_table -- it appears that some of the
private signal queues were being kept in the private message queue
free list.

Changed some fields in mq table to bit fields.

Ensured that private signal queues are initialized on thread startup.

Cleared up some confusion in creating message queues with default
value vs. creating unbounded message queues.  Now macros are used to
differentiate the two cases.

In cut_code.h, cleaned up some messy code and added documentation.
----------------------------
revision 1.104
date: 2007/10/12 15:48:30;  author: tswift;  state: Exp;  lines: +11 -13
Minor cleanup of error message.
----------------------------
revision 1.103
date: 2007/10/05 19:23:09;  author: tswift;  state: Exp;  lines: +203 -83

A number of changes to finish off ISO-style compatability for Multi-threaded library.

A message queue table was added for private message queues, public
message queues, and signal queues.  New message queue predicates can
now handle private queues.

Thread signal is now implemented, and thread-cancel merged into it.
Thread_signal places Goal on a threads queue and interrupts the
thread, which will execute Goal when it handles the interrupt.  The
interrupting had already been implemented for thread cancel, and now
thread_cancel is implemented as a special form of thread_signal.
Thread signal now inherits various behaviors of thread cancel,
including the control of thread cancel enabling/disabling, and the
thread cancel condition variable.

Main added as the thread alias of the main thread.

The manual documentation and test suite were also changed to support
the new functionality.
----------------------------
revision 1.102
date: 2007/09/12 21:50:47;  author: tswift;  state: Exp;  lines: +8 -3

Making thread_cancel throw a SIGABRT rather than a SIGINT (and using a different handler).

Revised code so that message queue of size 0 is unbounded.
----------------------------
revision 1.101
date: 2007/09/07 21:17:54;  author: tswift;  state: Exp;  lines: +43 -4
Modifications for thread_property/2.
Added statuses as property type, and now am allowing variable first argument, so that all valid threads can be backtracked through for their properties.
----------------------------
revision 1.100
date: 2007/08/17 13:59:45;  author: dwarren;  state: Exp;  lines: +17 -17
Changed the names of the enumerated type op_type, from MSG_* to MESG_*.
In my system one of these (at least, I didn't track them down) is already
defined as a constant, so the compiler won't take it as the name of
an enumerated constant.
----------------------------
revision 1.99
date: 2007/08/17 11:53:05;  author: ruim;  state: Exp;  lines: +9 -4
added check deleted to peek message
remove spurious locks on get message - this should fix the
deadlock problem.
----------------------------
revision 1.98
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +1 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.97
date: 2007/08/04 19:51:19;  author: tswift;  state: Exp;  lines: +41 -0
Changes for message_queue peek
----------------------------
revision 1.96
date: 2007/08/03 20:34:56;  author: tswift;  state: Exp;  lines: +1 -1

Changes to allow an override to restriction that only one thread may be active during a load.

In doing this, I refined the mutexes for syscalls so that system calls only use a mutex when using the proc table.
----------------------------
revision 1.95
date: 2007/07/25 15:43:46;  author: ruim;  state: Exp;  lines: +4 -0
fix for allowing xsb_abort on initialization
removed mt code for message queues from compiling in the sequential engine
----------------------------
revision 1.94
date: 2007/07/25 15:30:35;  author: ruim;  state: Exp;  lines: +15 -5
small fixes for msgq destroy
----------------------------
revision 1.93
date: 2007/07/25 15:20:24;  author: ruim;  state: Exp;  lines: +59 -15
fixes for message queue destroy
message queue memory can't be reclaimed as there might
still exits references for it.
----------------------------
revision 1.92
date: 2007/07/25 10:19:17;  author: ruim;  state: Exp;  lines: +82 -24
changes to allow message queue destroy
----------------------------
revision 1.91
date: 2007/07/24 20:19:33;  author: ruim;  state: Exp;  lines: +21 -5
hack to allow threads to be interrupted while waiting
for messages
----------------------------
revision 1.90
date: 2007/07/24 19:07:24;  author: ruim;  state: Exp;  lines: +30 -6
changes to make thread cancellation more roubust
----------------------------
revision 1.89
date: 2007/07/21 16:24:18;  author: ruim;  state: Exp;  lines: +5 -1
fixed find_context to work during xsb initialization
----------------------------
revision 1.88
date: 2007/07/18 10:32:44;  author: ruim;  state: Exp;  lines: +7 -0
added variable threads_initialized
it is checked in xsb_thread_self to avoid running through
the thread table when its is not initialized
----------------------------
revision 1.87
date: 2007/07/14 00:34:59;  author: dwarren;  state: Exp;  lines: +2 -2
My compiler complained about parameters to a call to xsb_existence_error, and it
looks like they were wrong.  I changed them to what I think is right.  If someone
knows better, be my guest...
----------------------------
revision 1.86
date: 2007/07/12 22:53:03;  author: tswift;  state: Exp;  lines: +6 -2
Added contexts for heap overflow check functions

Added queue aliases to message_queue_create, thread_send_message, and
thread_queue_message.

Added mutex aliases for all mutex functions to make them consistent with ISO working group.

Made default maximum queue terms a changeable XSB flag.

Wrote Prolog stub for message_queue_destroy

Manual updated, and mttest suite changed.
----------------------------
revision 1.85
date: 2007/07/08 01:21:39;  author: dwarren;  state: Exp;  lines: +4 -0
Cygwin (windows) doesn't seem to have usleep, so use ifdef to
use Sleep (which takes millesecs and so divide by 1000 to convert
microsecs to millesecs.
----------------------------
revision 1.84
date: 2007/07/07 21:02:08;  author: tswift;  state: Exp;  lines: +133 -43
-- Added usleep

-- Fixed concurrency bug with thread aliases in thread create.

-- made thread_join/thread_detach allow thread aliases
on input, and isoified their errors

-- Makde thread_self allow thread aliases on input.  The errors for
   this predicate different from ISO -- I dont really with their error
   designation in this case (at least not yet).

-- made thread_join, thread_detach, and thread_exit all properly
   remove aliases if applicable

-- Brought thread exit statuses in line with ISO working standard
   (mostly -- for now, we still have a cancelled status)

-- Added numerous tests for thread manipulation predicates to mttests.
----------------------------
revision 1.83
date: 2007/07/06 14:21:35;  author: ruim;  state: Exp;  lines: +5 -3
fixed what seemed to be a bug in init_system_threads
added checks for safety
----------------------------
revision 1.82
date: 2007/06/27 16:10:58;  author: ruim;  state: Exp;  lines: +2 -2
moved assignement before thread creation to avoid races
----------------------------
revision 1.81
date: 2007/06/27 13:23:16;  author: ruim;  state: Exp;  lines: +6 -7
got rid of usleep in ccalls_xsb_thread_create
made xsb_ready volatile
this code should now be correct
----------------------------
revision 1.80
date: 2007/06/26 17:55:51;  author: ruim;  state: Exp;  lines: +1 -2
fix thread create bug
----------------------------
revision 1.79
date: 2007/06/26 16:59:59;  author: tswift;  state: Exp;  lines: +19 -44

Now allowing modifications of default values for thread create via xsb_flag.
Altered thread create so that values can either be explicitly passed in, or obtained from flags.

Also, added usleep() as a temporary fix to a problem that I'll send out a note about.
----------------------------
revision 1.78
date: 2007/06/26 14:03:59;  author: ruim;  state: Exp;  lines: +5 -12
got rid of th_free_slots variable

check for thread table full is now ensured by th_new
----------------------------
revision 1.77
date: 2007/06/26 13:51:39;  author: ruim;  state: Exp;  lines: +1 -1
changed prolog's thread self to use the thread context's tid
instead of seraching for it in the thread table
----------------------------
revision 1.76
date: 2007/06/26 13:07:59;  author: ruim;  state: Exp;  lines: +47 -106
Major change in the new thread creation code
Also changed some of the windows thread id handling code -
mostly tried to share the linux code and avoid ifdefs.
Someone please test this in windows.

-- Rui Marques
----------------------------
revision 1.75
date: 2007/06/24 19:03:22;  author: tswift;  state: Exp;  lines: +18 -6
Changes to support thread aliases and other ISO functionality.
----------------------------
revision 1.74
date: 2007/06/22 17:18:46;  author: ruim;  state: Exp;  lines: +8 -6
fixed concurrency error while creating threads
----------------------------
revision 1.73
date: 2007/06/22 15:52:25;  author: ruim;  state: Exp;  lines: +33 -22
Fixed bug which appeared when the thread table was full of exited
threads.
Now we use the th_free_slots variable to keep track of how
many free slots really exist in the thread table.
----------------------------
revision 1.72
date: 2007/05/23 17:56:33;  author: tswift;  state: Exp;  lines: +10 -1

Added checks for overflowing MAX_THREADS
----------------------------
revision 1.71
date: 2007/04/24 18:35:31;  author: tswift;  state: Exp;  lines: +147 -0

First pass at message queues.
----------------------------
revision 1.70
date: 2007/03/12 16:06:20;  author: dwarren;  state: Exp;  lines: +2 -0
Fix findall deallocate routines to handle new situation of having one
chunk allocated but nothing in it.
Added findall_clean_all to free all memory associated with findall
buffers and added call to it when exiting a thread.
----------------------------
revision 1.69
date: 2007/02/23 16:35:14;  author: dwarren;  state: Exp;  lines: +12 -3
Fix threads_xsb.c to call Sleep under windows instead of unix usleep.
Fixed old, probably bad call to unix sleep to be a call to usleep with
the appropriate argument.
----------------------------
revision 1.68
date: 2007/02/22 00:16:05;  author: tswift;  state: Exp;  lines: +22 -3


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.67
date: 2007/01/25 20:33:56;  author: tswift;  state: Exp;  lines: +81 -6


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.66
date: 2007/01/12 23:33:29;  author: tswift;  state: Exp;  lines: +8 -0

Summary of problems and solutions

-- XSB errors are not always returned to the C level.

   Fixing this has necessitated a lot of small changes to the
   code.  I added a new default system error handler for the API
   and this handler puts any unhandled errors into a C data
   structure.  The API functions then check this structure and
   return a value of XSB_ERROR (integer 2) if an error has been thrown.

-- XSB errors were not always properly thrown.

   There were two main cases where we were not properly thowing
   errors.  The first was in the reader: if you pass a
   syntactically valid string to XSB from C you'll now get a
   syntax error, rather than a silent (but deadly :-) failure.
   In addition XSB exits on unrecoverable errors -- often on
   initialization and sometimes on execution.  This is bad
   behavior for the API, so now each of the xsb_exit() routines
   will check to see whether the variable xsb_mode_gl is equal to
   C_CALLING_XSB.  If so, it will return an error of type
   init_error (if we're in the initialization phase) or
   unrecoverable_error (if we're in the execution phase).
----------------------------
revision 1.65
date: 2006/12/03 17:09:29;  author: ruim;  state: Exp;  lines: +4 -4
Bug fix for concurrent completion:
  added a lock to protect insertion of consumers on subgoal asf list
----------------------------
revision 1.64
date: 2006/11/30 21:50:09;  author: ruim;  state: Exp;  lines: +12 -2
added names to the pseudo mutexes
added max_threads_sofar a statistic for peak thread number
----------------------------
revision 1.63
date: 2006/11/30 21:10:24;  author: ruim;  state: Exp;  lines: +10 -0
Moved DELAY_MUTEX in, in do_delay_stuff_shared to avoid unneeded locks

New Feature:
 Pseudo Mutexes

  These are system mutexes which are just used for counting in place of
  either sets of mutexes (call trie, struct manager) or mutexes
  that really don't fit in the SYS_MUTEX convention (completing_mut,
  th_mutex)

  It allows to re-use the statistics stuff for these mutexes.
----------------------------
revision 1.62
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +43 -9
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.61
date: 2006/11/22 18:36:50;  author: ruim;  state: Exp;  lines: +21 -7
added exited field to thread entry to avoid bugs in detaching threads
even so managed to decrease size of entry from 24 to 20 bytes through
the use of bit fields
----------------------------
revision 1.60
date: 2006/11/21 18:25:44;  author: ruim;  state: Exp;  lines: +24 -6
changes to keep thread list ordered by table order
arguably it will help improve locality of reference and efficiency
----------------------------
revision 1.59
date: 2006/11/21 01:37:45;  author: ruim;  state: Exp;  lines: +12 -8
rationalized validation of thread ids
----------------------------
revision 1.58
date: 2006/11/21 01:22:12;  author: ruim;  state: Exp;  lines: +8 -4
activated parameter --max_threads by replacing MAX_THREADS with max_threads_glc
----------------------------
revision 1.57
date: 2006/11/21 00:52:20;  author: ruim;  state: Exp;  lines: +116 -45
added lock to gc functions that use global data; however garbage collection
is not fixed as global variables values are assumed to stay the same between
builtin pred calls

added list of holes to thread table and list of threads
----------------------------
revision 1.56
date: 2006/11/20 16:53:42;  author: ruim;  state: Exp;  lines: +37 -17
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.55
date: 2006/11/15 16:38:10;  author: tswift;  state: Exp;  lines: +13 -0

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.54
date: 2006/11/06 18:07:16;  author: tswift;  state: Exp;  lines: +3 -1

Minor change to ensure bug fix.
----------------------------
revision 1.53
date: 2006/11/06 16:54:38;  author: tswift;  state: Exp;  lines: +2 -0

Fixing (I hope) a couple of small bugs evidenced by Valgrind in the MT engine.
----------------------------
revision 1.52
date: 2006/11/04 00:53:00;  author: ruim;  state: Exp;  lines: +8 -3
Changed minimum pthread stack size to 512 K
Minimum pthread stack size in Linux was previously 10 M,
clearly an exageration
mttest suite breaks with a stack size of 64 K, passes with 128 K
took out some compilation warnings
----------------------------
revision 1.51
date: 2006/10/30 17:48:46;  author: dwarren;  state: Exp;  lines: +4 -1
Changed call to PTHREAD_KILL for windows to pass tid_addr instead of tid.
I think this is right, but... (at least it was necessary to get it to compile
under windows.)
----------------------------
revision 1.50
date: 2006/10/25 15:35:03;  author: ruim;  state: Exp;  lines: +15 -0
Fix for bug in locking iostrs
----------------------------
revision 1.49
date: 2006/10/25 10:46:39;  author: ruim;  state: Exp;  lines: +3 -0
changed thread cancellation so that it works
for threads blocked on IO, by sending a SIGINT signal
----------------------------
revision 1.48
date: 2006/10/08 23:40:39;  author: tswift;  state: Exp;  lines: +2 -2

Changes to error_xsb.[ch] to turn current xsb_throw to xsb_throw_internal, and then re-introduce xsb_throw().  This allows xsb_throw to be used more easily
by foreign C functions and will hopefully solve Roberto Bagnara's problem.

Other changes fixed some typos in error messages.
----------------------------
revision 1.47
date: 2006/08/11 20:30:34;  author: tswift;  state: Exp;  lines: +278 -173

Additions of ISO-style user mutexes.
----------------------------
revision 1.46
date: 2006/05/02 14:28:22;  author: dwarren;  state: Exp;  lines: +4 -0
Add some extern declarations to quiet compiler complaints.
----------------------------
revision 1.45
date: 2006/04/24 15:41:16;  author: tswift;  state: Exp;  lines: +6 -5

Changes to make lists of delcfs both shared and private, so that space reclamation of dynamic clauses can occur when more than 1 thread is active.

Also, added reclamation of delcf and deltf frames for thread-private predicates upon exit of a thread.
----------------------------
revision 1.44
date: 2006/03/24 16:40:29;  author: tswift;  state: Exp;  lines: +4 -0

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.43
date: 2006/03/18 17:37:49;  author: tswift;  state: Exp;  lines: +1 -2
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.42
date: 2006/03/17 18:17:59;  author: tswift;  state: Exp;  lines: +4 -8


Some updates to fix bugs in table abolishing and garbage
collecting.  Many of the changes have to do with refactoring code
to make it a little faster as well as to reduce bugs.

In addition, there are associated additional files in the test suite.

I'll be making more changes, and hopefully finishing over the weekend.
----------------------------
revision 1.41
date: 2006/03/15 13:15:54;  author: tswift;  state: Exp;  lines: +18 -0


Introduced two new predicates: abolish_private_tables, and
abolish_shared_tables (CPS check for these predicates is not yet
done).

Fixed bug (I think) for null parent pointer in CPS check.

Adding new test for abolishing tables to testsuite.
----------------------------
revision 1.40
date: 2006/02/06 20:20:06;  author: tswift;  state: Exp;  lines: +28 -4

Changed default_system_error_handler so that it asserts a fact
'_$thread_exit_ball'/2 if a joinable thread exits via a thrown
error.  Changed xsb_thread_join/2 so that it returns the exit
ball, if any, along with the exit code of the thread.

Using this, created a new predicate, xsb_thread_cancel(Id) which
puts a new thread interrupt on thread Id's interrupt valus.  When
thread Id checks this value, it throws an error, which if
uncaught will cause Id to exit.
----------------------------
revision 1.39
date: 2006/02/03 18:14:13;  author: tswift;  state: Exp;  lines: +95 -74

Added mechanisms to create threads with varying stack sizes, and to create
detached threads.
----------------------------
revision 1.38
date: 2006/01/31 00:20:44;  author: tswift;  state: Exp;  lines: +102 -61

Changes for new threading API, as well as for passing in options list in xsb_thread_create.
----------------------------
revision 1.37
date: 2006/01/29 22:46:05;  author: ruim;  state: Exp;  lines: +25 -0
changed the dispatch block to 256.
added predicates to change the initial stack sizes of threads.
----------------------------
revision 1.36
date: 2006/01/27 20:29:47;  author: tswift;  state: Exp;  lines: +1 -3

Some changes I recently made broke batched evaluation.  I backed out these changes to fix the batched test suite again.
----------------------------
revision 1.35
date: 2006/01/16 00:33:23;  author: tswift;  state: Exp;  lines: +33 -15

Began documenting MT predicates in manual.  First pass on adding
error checking to multi-threading predicates.  Added
xsb_existence_error() in C.
----------------------------
revision 1.34
date: 2006/01/12 21:33:52;  author: tswift;  state: Exp;  lines: +1 -1
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.33
date: 2006/01/09 00:06:33;  author: tswift;  state: Exp;  lines: +21 -13
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.32
date: 2006/01/06 14:20:56;  author: dwarren;  state: Exp;  lines: +1 -0
Set return code explicitly in one branch where it was inadvertantly missed.
----------------------------
revision 1.31
date: 2005/12/31 01:43:35;  author: tswift;  state: Exp;  lines: +1 -1
Changes to mutex handling for IO that should affect only the MT
engine. Rather than having a global IO mutex, I've added a mutex
for each stream, and used MUTEX_IO to lock the open_files array
itself.  This change was prompted by the fact that I can't have
one thread waiting on an input-stream via, say, a read and have
that thread create other threads that write to the output stream
and exit when done.

The result is that we no longer have contention when different
threads write to different streams.  At the same time, we end up
doing no more locking than before -- a little less, in fact due
to some manipulations in xsb_writ.P Unfortunately, the stream
mutexes are recursive (as with MUTEX_IO).  We can't get rid of
this until we rewrite write_term.

Now, back to handling memory_errors.
----------------------------
revision 1.30
date: 2005/12/29 20:06:43;  author: tswift;  state: Exp;  lines: +74 -40


Refactored init_machine() to include a new function
init_thread_structures() that includes all initializations that
need to be done on a per-thread basis.  Then mem_dealloc'ed all
thread-specific memory, including varstrings and such in
cleanup_tread_structures() (nee cleanup_machine()).  This change
should affect the MT engine only.

At this point, there should be no memory leaks simply for
creating a thread that exits -- apart from interaction with the
string table, etc.  Also, I'm not freeing space for dispatch
blocks for private predicates, which doesn't seem necessary
overall.  I suppose if we want to get rid of that space, the
reclamation should be done in one of the abolish predicates,
rather than xsb_thread_exit()?
----------------------------
revision 1.29
date: 2005/12/22 23:34:00;  author: tswift;  state: Exp;  lines: +71 -17

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.28
date: 2005/12/17 02:46:32;  author: dwarren;  state: Exp;  lines: +1 -1
Fixed accumulated missing casts.  MSVC compiles it now without complaint.
----------------------------
revision 1.27
date: 2005/12/07 13:23:02;  author: ruim;  state: Exp;  lines: +2 -0
removed rw lock from tries in Multi-threaded engine
----------------------------
revision 1.26
date: 2005/11/18 21:09:37;  author: tswift;  state: Exp;  lines: +27 -3


Changes to error reporting when an attempt is made to use
attributed variables in subsumptive tables.  Subsumptive tables
do not yet allow attvs, and I want to wait to implement them
until I can restructure the variant table code -- most likely
after the next release.  So for now, just make the error
reporting better.

In order to do this, I introduced a new error type, table_error
for misc errors involving table semantics / implementation.

Other changes affected only code documentation.
----------------------------
revision 1.25
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +6 -6
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.24
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +14 -7
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.23
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +2 -1
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.22
date: 2005/08/20 06:50:28;  author: ruim;  state: Exp;  lines: +9 -0
Made pflags thread private
----------------------------
revision 1.21
date: 2005/08/08 17:11:35;  author: dwarren;  state: Exp;  lines: +6 -0
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.20
date: 2005/07/21 14:03:09;  author: ruim;  state: Exp;  lines: +3 -12
small changes to thread table in Linux
----------------------------
revision 1.19
date: 2005/07/20 16:45:23;  author: ruim;  state: Exp;  lines: +0 -13
added file deadlock.c in preparation for implementation of deadlock breaking
----------------------------
revision 1.18
date: 2005/07/20 10:20:36;  author: ruim;  state: Exp;  lines: +18 -5
fixes for thread self to work on both linux and win_nt
----------------------------
revision 1.17
date: 2005/07/19 19:38:02;  author: dwarren;  state: Exp;  lines: +5 -6
Changed type of threadID stored in thread table from pointer pthread_t_p to
pthread_t.  Necessary for WIN_NT.  (I think it should be OK for unix....)
----------------------------
revision 1.16
date: 2005/07/13 09:16:21;  author: ruim;  state: Exp;  lines: +4 -1
fixes in the sequence of deadlock detection
this time run the tests
----------------------------
revision 1.15
date: 2005/07/12 15:54:24;  author: ruim;  state: Exp;  lines: +28 -5
added deadlock detection to shared completed tables
----------------------------
revision 1.14
date: 2005/07/12 10:16:39;  author: ruim;  state: Exp;  lines: +1 -1
made macros for pthread_cancel and pthread_detach to work in win and unix
----------------------------
revision 1.13
date: 2005/07/11 21:43:58;  author: dwarren;  state: Exp;  lines: +13 -7
Added thread_yield builtin to allow thread to give up the cpu to other threads.
----------------------------
revision 1.12
date: 2005/07/11 16:59:44;  author: dwarren;  state: Exp;  lines: +3 -4
Commented out log messages in random...
----------------------------
revision 1.11
date: 2005/07/08 00:54:25;  author: dwarren;  state: Exp;  lines: +0 -7
Fixes to sockets for multi-threading, by Chris Rued.
----------------------------
revision 1.10
date: 2005/07/04 20:47:01;  author: ruim;  state: Exp;  lines: +6 -0
allow sharing of completed tables
----------------------------
revision 1.9
date: 2005/06/28 17:13:06;  author: dwarren;  state: Exp;  lines: +1 -1
Fix spelling in an error message.
----------------------------
revision 1.8
date: 2005/02/21 01:39:54;  author: vidrevich;  state: Exp;  lines: +6 -6
another try to fix pthreads in Windows
----------------------------
revision 1.7
date: 2005/02/21 00:15:09;  author: vidrevich;  state: Exp;  lines: +7 -2
fixed a bug in creating a thread in Windows version
----------------------------
revision 1.6
date: 2005/02/13 15:28:55;  author: vidrevich;  state: Exp;  lines: +5 -0
changes to compile multi-treaded XSB in Windows
----------------------------
revision 1.5
date: 2005/02/11 19:50:52;  author: vidrevich;  state: Exp;  lines: +47 -18
changes to run in multitreaded windows mode
----------------------------
revision 1.4
date: 2005/01/21 17:30:46;  author: tswift;  state: Exp;  lines: +3 -3

Changes to compile in Windows -- rand / random srand / srandom
----------------------------
revision 1.3
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +329 -2
Integration of multithreaded system
----------------------------
revision 1.2
date: 2004/08/29 14:33:23;  author: tswift;  state: Exp;  lines: +56 -0
branches:  1.2.2;
Forgot to add this one.
----------------------------
revision 1.1
date: 2000/12/20 18:48:05;  author: ruim;  state: dead;
branches:  1.1.2;
file thread_xsb.c was initially added on branch multi-threaded-engine.
----------------------------
revision 1.1.2.3
date: 2001/01/06 18:43:05;  author: ruim;  state: Exp;  lines: +16 -4
Initialization data made static and other small changes
----------------------------
revision 1.1.2.2
date: 2001/01/03 20:04:51;  author: ruim;  state: Exp;  lines: +48 -2
fixes
----------------------------
revision 1.1.2.1
date: 2000/12/20 18:48:05;  author: ruim;  state: Exp;  lines: +149 -0
added new files
----------------------------
revision 1.2.2.2
date: 2004/12/26 17:29:21;  author: ruim;  state: Exp;  lines: +20 -4
made exception mechanism multi-threaded
----------------------------
revision 1.2.2.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +313 -2
Sources from rfm repository
----------------------------
revision 1.123.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.123.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.123.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/thread_xsb.h,v
Working file: thread_xsb.h
head: 1.51
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.50
	ROLLBACK: 1.46
	latest_plus_supp_branch: 1.46.0.2
	latest_plus_supp: 1.46
	Version_3dot2_plus_supp: 1.44.0.2
	Version_3dot2: 1.44
	dec07-perf-results: 1.41
	mt_thesis: 1.27
	release_3_0: 1.17
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.2.3
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.2.1
	multi-threaded-25-engine: 1.2.0.2
	multi-threaded-engine: 1.1.0.2
keyword substitution: kv
total revisions: 59;	selected revisions: 59
description:
----------------------------
revision 1.51
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +2 -2

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.50
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.49
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.48
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.47
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.46
date: 2010/05/02 05:11:26;  author: evansbj;  state: Exp;  lines: +12 -12
branches:  1.46.2;
Update to make thread_exit/1, and xsb_kill_thread work from the C interface. It passes the regression tests as well as before, better actually.
----------------------------
revision 1.45
date: 2009/04/02 11:28:54;  author: ruim;  state: Exp;  lines: +2 -2
Increased default size of message queues
----------------------------
revision 1.44
date: 2008/10/26 15:26:15;  author: tswift;  state: Exp;  lines: +23 -0

Fixed two MT bugs

1) We weren't checking the size of a queue message before copying into the heap

2) We weren't initializing queues for the main thread (0)

ALso, added some scaffolding for queue locking, particularly for debug mode.
----------------------------
revision 1.43
date: 2008/07/09 19:55:33;  author: tswift;  state: Exp;  lines: +2 -2

Not counting system mutexes except in non-opt compiles.
----------------------------
revision 1.42
date: 2007/12/27 00:01:46;  author: tswift;  state: Exp;  lines: +1 -0

Small changes to make mutexes on shared tries recursive -- to support bulk_XXX style operations.
----------------------------
revision 1.41
date: 2007/10/26 22:47:33;  author: tswift;  state: Exp;  lines: +1 -0

Changes to support new ISO mutex_property.

tr_utils.c tries.c -- changes are comments
----------------------------
revision 1.40
date: 2007/10/23 15:53:19;  author: ruim;  state: Exp;  lines: +3 -0
Introduced command line option max_mqueues to specify maximum limit for
message queues

Rationalized use of max_threads_glc wrt sequential engine
----------------------------
revision 1.39
date: 2007/10/22 16:14:49;  author: dwarren;  state: Exp;  lines: +1 -0
Moved a define from thread_xsb.c to thread_xsb.h so it can be seen where used in
init_xsb.  (Terry, correct this if wrong.)
----------------------------
revision 1.38
date: 2007/10/21 13:36:48;  author: ruim;  state: Exp;  lines: +0 -17
added lock to mq table
verified if the q has been destroyed and re-created
several small fixes, specially in destroying mqs and
checking for destruction of mqs

Note - the private and signal queues are destroyed when the thread *exits*
not waiting for it to be joined
----------------------------
revision 1.37
date: 2007/10/20 19:13:01;  author: tswift;  state: Exp;  lines: +3 -3


Made some small fixes in init_mq_table -- it appears that some of the
private signal queues were being kept in the private message queue
free list.

Changed some fields in mq table to bit fields.

Ensured that private signal queues are initialized on thread startup.

Cleared up some confusion in creating message queues with default
value vs. creating unbounded message queues.  Now macros are used to
differentiate the two cases.

In cut_code.h, cleaned up some messy code and added documentation.
----------------------------
revision 1.36
date: 2007/10/05 19:23:09;  author: tswift;  state: Exp;  lines: +3 -1

A number of changes to finish off ISO-style compatability for Multi-threaded library.

A message queue table was added for private message queues, public
message queues, and signal queues.  New message queue predicates can
now handle private queues.

Thread signal is now implemented, and thread-cancel merged into it.
Thread_signal places Goal on a threads queue and interrupts the
thread, which will execute Goal when it handles the interrupt.  The
interrupting had already been implemented for thread cancel, and now
thread_cancel is implemented as a special form of thread_signal.
Thread signal now inherits various behaviors of thread cancel,
including the control of thread cancel enabling/disabling, and the
thread cancel condition variable.

Main added as the thread alias of the main thread.

The manual documentation and test suite were also changed to support
the new functionality.
----------------------------
revision 1.35
date: 2007/07/25 10:19:17;  author: ruim;  state: Exp;  lines: +3 -1
changes to allow message queue destroy
----------------------------
revision 1.34
date: 2007/07/24 20:19:33;  author: ruim;  state: Exp;  lines: +0 -2
hack to allow threads to be interrupted while waiting
for messages
----------------------------
revision 1.33
date: 2007/07/22 18:40:48;  author: ruim;  state: Exp;  lines: +1 -0
Changes to allow for main_xsb.c to link in under windows, for
the multi-threaded system.
----------------------------
revision 1.32
date: 2007/07/21 16:24:18;  author: ruim;  state: Exp;  lines: +2 -0
fixed find_context to work during xsb initialization
----------------------------
revision 1.31
date: 2007/06/23 19:52:33;  author: tswift;  state: Exp;  lines: +9 -0

Put in extern "C" declaration for ccall_xsb_thread_create()
----------------------------
revision 1.30
date: 2007/06/09 16:44:11;  author: ruim;  state: Exp;  lines: +2 -2
allowed msg queues to compile in concurrent completion
----------------------------
revision 1.29
date: 2007/04/24 18:35:31;  author: tswift;  state: Exp;  lines: +14 -1

First pass at message queues.
----------------------------
revision 1.28
date: 2007/01/25 20:33:56;  author: tswift;  state: Exp;  lines: +1 -0


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.27
date: 2006/11/30 21:50:09;  author: ruim;  state: Exp;  lines: +2 -0
added names to the pseudo mutexes
added max_threads_sofar a statistic for peak thread number
----------------------------
revision 1.26
date: 2006/11/30 21:10:25;  author: ruim;  state: Exp;  lines: +6 -0
Moved DELAY_MUTEX in, in do_delay_stuff_shared to avoid unneeded locks

New Feature:
 Pseudo Mutexes

  These are system mutexes which are just used for counting in place of
  either sets of mutexes (call trie, struct manager) or mutexes
  that really don't fit in the SYS_MUTEX convention (completing_mut,
  th_mutex)

  It allows to re-use the statistics stuff for these mutexes.
----------------------------
revision 1.25
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +4 -0
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.24
date: 2006/11/22 18:36:50;  author: ruim;  state: Exp;  lines: +5 -3
added exited field to thread entry to avoid bugs in detaching threads
even so managed to decrease size of entry from 24 to 20 bytes through
the use of bit fields
----------------------------
revision 1.23
date: 2006/11/21 00:52:20;  author: ruim;  state: Exp;  lines: +2 -1
added lock to gc functions that use global data; however garbage collection
is not fixed as global variables values are assumed to stay the same between
builtin pred calls

added list of holes to thread table and list of threads
----------------------------
revision 1.22
date: 2006/11/20 16:53:42;  author: ruim;  state: Exp;  lines: +9 -16
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.21
date: 2006/11/04 00:53:00;  author: ruim;  state: Exp;  lines: +3 -0
Changed minimum pthread stack size to 512 K
Minimum pthread stack size in Linux was previously 10 M,
clearly an exageration
mttest suite breaks with a stack size of 64 K, passes with 128 K
took out some compilation warnings
----------------------------
revision 1.20
date: 2006/10/25 10:46:39;  author: ruim;  state: Exp;  lines: +2 -0
changed thread cancellation so that it works
for threads blocked on IO, by sending a SIGINT signal
----------------------------
revision 1.19
date: 2006/09/15 20:09:43;  author: tswift;  state: Exp;  lines: +1 -1
Fix for bug that showed up as a core dump in a Flora program.
The bug had to do with the variable num_heap_term_vars not being
initialized when it went through the "ground" path of
table_consume_answer() in tabletry.  The lack of initialization
meant that a value was inappropriately copied to a delay list;
then the core dump arose when an answer using the delay
list (including the bad value) was copied into table space.
----------------------------
revision 1.18
date: 2006/08/11 20:30:34;  author: tswift;  state: Exp;  lines: +9 -2

Additions of ISO-style user mutexes.
----------------------------
revision 1.17
date: 2006/03/24 16:40:29;  author: tswift;  state: Exp;  lines: +1 -1

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.16
date: 2006/03/15 13:15:56;  author: tswift;  state: Exp;  lines: +1 -1


Introduced two new predicates: abolish_private_tables, and
abolish_shared_tables (CPS check for these predicates is not yet
done).

Fixed bug (I think) for null parent pointer in CPS check.

Adding new test for abolishing tables to testsuite.
----------------------------
revision 1.15
date: 2006/01/27 20:29:47;  author: tswift;  state: Exp;  lines: +4 -4

Some changes I recently made broke batched evaluation.  I backed out these changes to fix the batched test suite again.
----------------------------
revision 1.14
date: 2005/12/22 23:34:00;  author: tswift;  state: Exp;  lines: +40 -4

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.13
date: 2005/11/18 21:09:37;  author: tswift;  state: Exp;  lines: +21 -0


Changes to error reporting when an attempt is made to use
attributed variables in subsumptive tables.  Subsumptive tables
do not yet allow attvs, and I want to wait to implement them
until I can restructure the variant table code -- most likely
after the next release.  So for now, just make the error
reporting better.

In order to do this, I introduced a new error type, table_error
for misc errors involving table semantics / implementation.

Other changes affected only code documentation.
----------------------------
revision 1.12
date: 2005/07/20 16:45:23;  author: ruim;  state: Exp;  lines: +0 -2
added file deadlock.c in preparation for implementation of deadlock breaking
----------------------------
revision 1.11
date: 2005/07/15 20:09:57;  author: dwarren;  state: Exp;  lines: +1 -1
Chris Rued's changes to make the multi-threaded version configure and
work on FREEBSD.
----------------------------
revision 1.10
date: 2005/07/12 15:54:24;  author: ruim;  state: Exp;  lines: +5 -1
added deadlock detection to shared completed tables
----------------------------
revision 1.9
date: 2005/07/12 10:16:53;  author: ruim;  state: Exp;  lines: +4 -0
made macros for pthread_cancel and pthread_detach to work in win and unix
----------------------------
revision 1.8
date: 2005/07/11 21:43:58;  author: dwarren;  state: Exp;  lines: +1 -1
Added thread_yield builtin to allow thread to give up the cpu to other threads.
----------------------------
revision 1.7
date: 2005/07/08 00:54:25;  author: dwarren;  state: Exp;  lines: +25 -0
Fixes to sockets for multi-threading, by Chris Rued.
----------------------------
revision 1.6
date: 2005/07/04 20:47:01;  author: ruim;  state: Exp;  lines: +3 -0
allow sharing of completed tables
----------------------------
revision 1.5
date: 2005/02/20 23:31:45;  author: vidrevich;  state: Exp;  lines: +1 -1
removed cygwin-related block that tries to define thread constants that are already defined in pthread library. Keep it for Darwin only.
----------------------------
revision 1.4
date: 2005/01/21 17:30:59;  author: tswift;  state: Exp;  lines: +21 -1

Changes to compile in Windows -- rand / random srand / srandom
----------------------------
revision 1.3
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +11 -0
Integration of multithreaded system
----------------------------
revision 1.2
date: 2004/08/26 18:57:58;  author: tswift;  state: Exp;  lines: +36 -0
branches:  1.2.2;
Adding this.
----------------------------
revision 1.1
date: 2000/12/20 18:48:05;  author: ruim;  state: dead;
branches:  1.1.2;
file thread_xsb.h was initially added on branch multi-threaded-engine.
----------------------------
revision 1.1.2.2
date: 2001/01/03 20:04:51;  author: ruim;  state: Exp;  lines: +13 -0
fixes
----------------------------
revision 1.1.2.1
date: 2000/12/20 18:48:05;  author: ruim;  state: Exp;  lines: +13 -0
added new files
----------------------------
revision 1.2.2.3
date: 2004/12/26 17:29:21;  author: ruim;  state: Exp;  lines: +1 -0
made exception mechanism multi-threaded
----------------------------
revision 1.2.2.2
date: 2004/11/04 22:31:15;  author: tswift;  state: Exp;  lines: +10 -0

Changes for compilation in cygwin.  This will not affect the linux distribution (I hope).
Changes are:

	1) execute -> xsb_execute, to avoid conflict with pthread.h in cygwin
	2) Renamed mutex constants to accord with pthread.h in cygwin.
----------------------------
revision 1.2.2.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +0 -0
Sources from rfm repository
----------------------------
revision 1.46.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.46.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.46.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/timer_defs_xsb.h,v
Working file: timer_defs_xsb.h
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.10.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.10.1
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.2
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.8
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.3.4;
Integration of multithreaded system
----------------------------
revision 1.2
date: 2000/05/22 05:48:06;  author: kifer;  state: Exp;  lines: +2 -1
branches:  1.2.2;  1.2.10;
enabled socket timeout on windows
----------------------------
revision 1.1
date: 1999/11/16 19:06:04;  author: kifer;  state: Exp;
Revamped sockets interface.
----------------------------
revision 1.2.10.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.2.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/timer_xsb.c,v
Working file: timer_xsb.c
head: 1.28
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.27
	ROLLBACK: 1.22
	latest_plus_supp_branch: 1.22.0.4
	latest_plus_supp: 1.22
	Version_3dot2_plus_supp: 1.22.0.2
	release_2_6_plus_supp: 1.10.0.12
	Version_3dot2: 1.22
	dec07-perf-results: 1.22
	mt_thesis: 1.20
	release_3_0: 1.20
	release_2_7_0: 1.10
	multi-threaded-26-engine: 1.10.10.1
	pre-mt: 1.10
	multi-threaded-25-engine-done: 1.10.10.1
	multi-threaded-25-engine: 1.10.0.10
	release_2_6_1: 1.10
	release_2_6_final: 1.10
	release_2_6: 1.10.0.8
	last-merged-to-demand: 1.10
	demand_branch: 1.10.0.6
	before_removing_chat: 1.10
	release_2_5: 1.10
	pre-merge-slgwam-gc: 1.10
	multi-threaded-c-engine: 1.10.0.4
	release_2_4: 1.10
	release_2_3: 1.10
	multi-threaded-engine: 1.10.0.2
	pre-threading: 1.9
	release-2-2: 1.5
	chat-and-local: 1.5.0.2
	xsb-pre-cleanup: 1.5
	release-2-1: 1.4
keyword substitution: kv
total revisions: 34;	selected revisions: 34
description:
----------------------------
revision 1.28
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +4 -4
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.27
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.26
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.25
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -1
branches:  1.22.4;
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.21
date: 2007/02/22 00:16:05;  author: tswift;  state: Exp;  lines: +2 -2


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.20
date: 2006/02/03 18:14:13;  author: tswift;  state: Exp;  lines: +2 -2

Added mechanisms to create threads with varying stack sizes, and to create
detached threads.
----------------------------
revision 1.19
date: 2005/12/12 00:19:12;  author: tswift;  state: Exp;  lines: +17 -4

Mutexed socket calls which dont seem to be mutexed.  Also added a
mutex around some rarely used string/symbol table statistics.

Other than that, documentation.
----------------------------
revision 1.18
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +3 -3
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.17
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +3 -3
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.16
date: 2005/08/20 06:50:28;  author: ruim;  state: Exp;  lines: +2 -2
Made pflags thread private
----------------------------
revision 1.15
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +3 -3
made private flags array for sequential engine
----------------------------
revision 1.14
date: 2005/07/12 10:16:53;  author: ruim;  state: Exp;  lines: +4 -11
made macros for pthread_cancel and pthread_detach to work in win and unix
----------------------------
revision 1.13
date: 2005/07/10 18:35:08;  author: ruim;  state: Exp;  lines: +10 -1
Fixes for timer_xsb to compile under Linux.
----------------------------
revision 1.12
date: 2005/07/08 00:54:25;  author: dwarren;  state: Exp;  lines: +98 -16
Fixes to sockets for multi-threading, by Chris Rued.
----------------------------
revision 1.11
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +3 -3
Integration of multithreaded system
----------------------------
revision 1.10
date: 2000/09/27 02:25:03;  author: kifer;  state: Exp;  lines: +3 -1
branches:  1.10.2;  1.10.10;
added
#undef __STRICT_ANSI__
to avoid errors under cygwin
----------------------------
revision 1.9
date: 2000/06/19 07:05:30;  author: ruim;  state: Exp;  lines: +3 -1

Changed definition of global variable from .h to .c
----------------------------
revision 1.8
date: 2000/05/25 23:23:05;  author: kifer;  state: Exp;  lines: +13 -4
removed unnecessary casts
----------------------------
revision 1.7
date: 2000/05/22 05:48:06;  author: kifer;  state: Exp;  lines: +161 -24
enabled socket timeout on windows
----------------------------
revision 1.6
date: 2000/05/20 06:56:10;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.5
date: 2000/01/07 08:51:57;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.4
date: 1999/11/17 03:54:35;  author: kifer;  state: Exp;  lines: +3 -7
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.3
date: 1999/11/16 20:39:15;  author: kifer;  state: Exp;  lines: +3 -1
(Now hopefully) Fixed the include files for the latest gcc
----------------------------
revision 1.2
date: 1999/11/16 20:21:02;  author: kifer;  state: Exp;  lines: +11 -3
Fixed the include files for the latest gcc
----------------------------
revision 1.1
date: 1999/11/16 19:06:04;  author: kifer;  state: Exp;
Revamped sockets interface.
----------------------------
revision 1.10.10.1
date: 2004/09/29 19:44:21;  author: ruim;  state: Exp;  lines: +3 -3
Sources from rfm repository
----------------------------
revision 1.10.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.10.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +10 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.22.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.22.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.22.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/timer_xsb.h,v
Working file: timer_xsb.h
head: 1.22
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.21
	ROLLBACK: 1.16
	latest_plus_supp_branch: 1.16.0.4
	latest_plus_supp: 1.16
	Version_3dot2_plus_supp: 1.16.0.2
	release_2_6_plus_supp: 1.9.0.12
	Version_3dot2: 1.16
	dec07-perf-results: 1.15
	mt_thesis: 1.15
	release_3_0: 1.15
	release_2_7_0: 1.9
	multi-threaded-26-engine: 1.9.10.1
	pre-mt: 1.9
	multi-threaded-25-engine-done: 1.9.10.1
	multi-threaded-25-engine: 1.9.0.10
	release_2_6_1: 1.9
	release_2_6_final: 1.9
	release_2_6: 1.9.0.8
	last-merged-to-demand: 1.9
	demand_branch: 1.9.0.6
	before_removing_chat: 1.9
	release_2_5: 1.9
	pre-merge-slgwam-gc: 1.9
	multi-threaded-c-engine: 1.9.0.4
	release_2_4: 1.9
	release_2_3: 1.9
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.9
	release-2-2: 1.5
	chat-and-local: 1.5.0.2
	xsb-pre-cleanup: 1.5
	release-2-1: 1.4
keyword substitution: kv
total revisions: 28;	selected revisions: 28
description:
----------------------------
revision 1.22
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +13 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.21
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.20
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.19
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2007/12/16 13:22:31;  author: ruim;  state: Exp;  lines: +2 -2
branches:  1.16.4;
small change to make the code more coherent
----------------------------
revision 1.15
date: 2006/03/24 16:40:29;  author: tswift;  state: Exp;  lines: +4 -2

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.14
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +2 -2
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.13
date: 2005/08/20 06:50:28;  author: ruim;  state: Exp;  lines: +2 -2
Made pflags thread private
----------------------------
revision 1.12
date: 2005/08/19 16:24:10;  author: ruim;  state: Exp;  lines: +5 -5
made private flags array for sequential engine
----------------------------
revision 1.11
date: 2005/07/08 00:54:25;  author: dwarren;  state: Exp;  lines: +69 -25
Fixes to sockets for multi-threading, by Chris Rued.
----------------------------
revision 1.10
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +11 -1
Integration of multithreaded system
----------------------------
revision 1.9
date: 2000/06/19 07:05:32;  author: ruim;  state: Exp;  lines: +2 -2
branches:  1.9.2;  1.9.10;

Changed definition of global variable from .h to .c
----------------------------
revision 1.8
date: 2000/05/22 05:48:07;  author: kifer;  state: Exp;  lines: +35 -19
enabled socket timeout on windows
----------------------------
revision 1.7
date: 2000/05/20 06:56:11;  author: kifer;  state: Exp;  lines: +2 -2
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.6
date: 2000/05/01 21:42:26;  author: kifer;  state: Exp;  lines: +3 -3
cast flags[] to (in). Otherwise, if breaks on negative values
----------------------------
revision 1.5
date: 2000/01/07 08:51:58;  author: kifer;  state: Exp;  lines: +2 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.4
date: 1999/11/17 03:54:36;  author: kifer;  state: Exp;  lines: +6 -1
Separated setjmp.h into a separate setjmp_xsb.h and defined _POSIX_C_SOURCE
there. This is needed for some reason by gcc 2.95.
----------------------------
revision 1.3
date: 1999/11/16 20:39:15;  author: kifer;  state: Exp;  lines: +4 -4
(Now hopefully) Fixed the include files for the latest gcc
----------------------------
revision 1.2
date: 1999/11/16 20:21:03;  author: kifer;  state: Exp;  lines: +3 -3
Fixed the include files for the latest gcc
----------------------------
revision 1.1
date: 1999/11/16 19:06:05;  author: kifer;  state: Exp;
Revamped sockets interface.
----------------------------
revision 1.9.10.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +11 -1
Sources from rfm repository
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +3 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.16.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.16.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/token.c,v
Working file: token.c
head: 1.4
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.3
	without-attv: 1.3
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 5;	selected revisions: 5
description:
----------------------------
revision 1.4
date: 1999/10/25 05:59:44;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.3
date: 1999/08/16 07:24:34;  author: kifer;  state: Exp;  lines: +10 -12
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.2
date: 1999/08/10 12:17:52;  author: kostis;  state: Exp;  lines: +1 -3
lean up and slight improvement of string manipulation builtins.
Eliminated building of strings in the heap (like eg. in str_cat)
without checking for overflows.  Now str_cat occurs in a buffer
of its own.  Also, made str_* routines test their arguments for
the correct types and unify their output arguments.
----------------------------
revision 1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:23;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/token.h,v
Working file: token.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1999/10/25 05:59:45;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/token_defs_xsb.h,v
Working file: token_defs_xsb.h
head: 1.10
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.10
	ROLLBACK: 1.5
	latest_plus_supp_branch: 1.5.0.4
	latest_plus_supp: 1.5
	Version_3dot2_plus_supp: 1.5.0.2
	release_2_6_plus_supp: 1.2.0.4
	Version_3dot2: 1.5
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.1.10.2
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.1.10.1
	multi-threaded-25-engine: 1.1.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.2
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
keyword substitution: kv
total revisions: 18;	selected revisions: 18
description:
----------------------------
revision 1.10
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.9
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.8
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.7
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2008/02/16 18:00:42;  author: dwarren;  state: Exp;  lines: +2 -1
branches:  1.5.4;
Add new instructions putdfloat and getdfloat to handle double floats.
Update the loader to load these instructions from the xwam files.
(There is a possible problem.  The doubles are written into the xwam
file as bitstrings, and read by the loader as the same bitstring.  If
representations on different machines are different, then xwam files
compiled on one system won't run on another.)
----------------------------
revision 1.4
date: 2005/12/15 16:39:52;  author: dwarren;  state: Exp;  lines: +4 -4
1. Changed the XSB tokenizer to be more compatible with the Prolog
standard.  This involved adding escape characters when processing
strings -- single quoted, double quoted and 0-radix, as in 0'\n.  The
escape characters are those in the standard (taken from C).  I did not
add \' as a single quote within a quoted string, since it breaks the
form: '/\', which appears several times in the XSB system code.  (This
could, of course, be changed.)  Backslashes that are not followed by a
legal escape indicator are accepted simply as backslashes.  (I suspect
this is not what the standard expects, but it will break fewer
programs.)  I added the new forms for binary (e.g., 0b101), octal
(e.g., 0o731), and hex (e.g., 0xffef) that the standard requires.  I
left in the non-0 radix notation (after fixing a few bugs in it) which
is not in the standard, so we still process e.g., 8'713 as an octal
integer.  I extended the allowable radix up to 36 (which was partially
there already in a buggy form; I used A-Z for the digits 10-35.)  This
is probably not of much use, but what the hey....

The addition of the escape changed one of the tests in the testsuite.
Update tests from cvs to get the new correct answers.

2. Improved assert_code_to_buff so that it will run out of registers
less often when asserting GROUND structures.  The old version had a
limit of approximately 255 for right-branching when the left-elements
were non-constant.  E.g. arbitrary lists of constants were handled, but
lists of structures were limited to c. 255.  I've changed it so the
limit is now on left-branching instead of right-branching.  Since
right-branching is much more common in Prolog programs, this should
handle more structures that show up in Prolog programs.  (No claim is
made for Flora programs :-).
----------------------------
revision 1.3
date: 2004/10/15 14:43:38;  author: dwarren;  state: Exp;  lines: +4 -3
Added file_puttoken option to print an atom ALWAYS as single-quoted.
----------------------------
revision 1.2
date: 2003/01/28 22:57:06;  author: dwarren;  state: Exp;  lines: +3 -1
Move write_canonical (and write_canonical_lettervars) to C.  Not for speed
but so that they can be accessed from C, and used in the ODBC interface to
write terms canonically to character fields.
----------------------------
revision 1.1
date: 1999/11/20 06:45:50;  author: kifer;  state: Exp;
branches:  1.1.4;  1.1.8;  1.1.10;
Extracted token definitions into a new file token_defs_xsb.h
----------------------------
revision 1.1.10.2
date: 2004/10/18 20:46:12;  author: ruim;  state: Exp;  lines: +3 -1
update for version 2.6.1
----------------------------
revision 1.1.10.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.1.8.1
date: 2003/04/17 17:11:37;  author: lfcastro;  state: Exp;  lines: +3 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.1.4.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.4.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.5.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.5.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/token_xsb.c,v
Working file: token_xsb.c
head: 1.47
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.37
	ROLLBACK: 1.32
	latest_plus_supp_branch: 1.32.0.2
	latest_plus_supp: 1.32
	Version_3dot2_plus_supp: 1.30.0.2
	release_2_6_plus_supp: 1.12.0.8
	Version_3dot2: 1.30
	dec07-perf-results: 1.30
	mt_thesis: 1.25
	release_3_0: 1.25
	release_2_7_0: 1.13
	multi-threaded-26-engine: 1.12.6.1
	pre-mt: 1.13
	multi-threaded-25-engine-done: 1.12.6.1
	multi-threaded-25-engine: 1.12.0.6
	release_2_6_1: 1.12
	release_2_6_final: 1.12
	release_2_6: 1.12.0.4
	last-merged-to-demand: 1.12
	demand_branch: 1.12.0.2
	before_removing_chat: 1.12
	release_2_5: 1.12
	pre-merge-slgwam-gc: 1.9
	multi-threaded-c-engine: 1.9.0.2
	release_2_4: 1.9
	release_2_3: 1.6
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.4
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.2
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 53;	selected revisions: 53
description:
----------------------------
revision 1.47
date: 2011/08/15 15:10:25;  author: dwarren;  state: Exp;  lines: +2 -2
Minor changes to quiet 64-bit compilation (or use 64-bit compatible decls).
Minor change to tokenizer to make it more standardish(?) for \NUM form.
One decl moved to work with ANSI C (MSVC).
----------------------------
revision 1.46
date: 2011/07/26 17:27:49;  author: dwarren;  state: Exp;  lines: +4 -3
Fixed bug in ODBC interface that showed up under 64-bit port.  SQLTYPES were
not used consistently in malloc and free.
Minor change to tokenizer to be more Prolog standardish. (Mostly unused
string escapes.)
----------------------------
revision 1.45
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +2 -2
Getting Linux to Work
----------------------------
revision 1.44
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +20 -20
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.43
date: 2011/04/27 17:11:11;  author: pmoura;  state: Exp;  lines: +1 -4
Removed support for using the \z escape sequence for representing Prolog end-of-file. It worked fine for the 0' notation but it caused problems when using the escape sequence on strings an atoms.
----------------------------
revision 1.42
date: 2011/04/26 14:00:31;  author: pmoura;  state: Exp;  lines: +1 -3
Implemented 0'\s (space) and 0'\z (Prolog end-of-file). The former is specially useful as writing "0' " is fragile when using tools the reformat source code or when tabing/detabing source files. Second attempt.
----------------------------
revision 1.41
date: 2011/04/18 18:12:36;  author: kifer;  state: Exp;  lines: +6 -3
partially rolled back Paolo's change: breaks flora. Namely:

            case 's':		        // space
                return ' ';
----------------------------
revision 1.40
date: 2011/04/18 13:09:14;  author: pmoura;  state: Exp;  lines: +8 -4
Implemented 0'\s (space) and 0'\z (Prolog end-of-file). The former is specially useful as writing "0' " is fragile when using tools the reformat source code or when tabing/detabing source files.
----------------------------
revision 1.39
date: 2011/03/26 04:00:39;  author: kifer;  state: Exp;  lines: +2 -1
added errno.h
----------------------------
revision 1.38
date: 2011/03/24 17:58:47;  author: dwarren;  state: Exp;  lines: +13 -4
Modified recently added I/O error handling to call xsb_warn.  (Maybe still not
optimal.)
----------------------------
revision 1.37
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.36
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.35
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.34
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.33
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.32
date: 2010/03/14 01:47:00;  author: evansbj;  state: Exp;  lines: +2 -2
branches:  1.32.2;
Housekeeping cleaned up some unnecessary variable assignments ...
----------------------------
revision 1.31
date: 2010/01/30 20:17:37;  author: evansbj;  state: Exp;  lines: +5 -5
*** empty log message ***
----------------------------
revision 1.30
date: 2007/08/16 14:38:28;  author: dwarren;  state: Exp;  lines: +11 -3
Fix integer overflow check in tokenizer.  I think it now properly reports
overflow whenever it occurs.  There is one issue: it reports overflow for
-2^31 and returns -2^31-1, even though -2^31 is representable in 32 bits,
and if it were left to pass through, would be handled correctly.  The problem
is that I can't tell (well, easily) that the integer will be negated when
I'm doing the overflow check.  Maybe someday I'll figure it out.  For the moment
we lose one negative integer...
----------------------------
revision 1.29
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.28
date: 2007/02/23 21:06:11;  author: dwarren;  state: Exp;  lines: +1 -1
Change a remaining realloc to mem_realloc.
----------------------------
revision 1.27
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +15 -16
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.26
date: 2006/12/22 18:57:39;  author: tswift;  state: Exp;  lines: +14 -8
Added syntax errors to file_read/3.  Previously file_read/3 was
effectively handling its own errors, by printing out to STDERR and
failing.  This was not ISO compliant, and had two pressing
problems: it was not safe for threads that concurrently got syntax
errors while reading different streams, and syntax errors could not be
handled by applications -- an important feature for C calling XSB.

Because the reader is very fragile, I made relatively minimal changes
to handle this.  We're still using PSC records to store where an error
occurred (ugh!) because my attempt to actually throw errors at a
potential misparse broke the backtracking HiLog parser. But now at
lease different threads use different PSC records.  In addition, at
the end of file_read, if there is a syntax error, I package it up and
throw a proper error.

I maintained the old file_read predicate as file_read_fapoe (fail and
print out error), and made cmplib/parse.P call this predicate.  The
rest of the system now calls the new file_read.  Also, I did not
change file_read_foe (fail on error) which had been called in a couple
of places.

Also changed xsb_abort() calls in xsb_token.c to throw specific syntax
errors.

emuloop.c changes are purely indentational, to make the code more clear.
----------------------------
revision 1.25
date: 2006/04/30 18:27:14;  author: tswift;  state: Exp;  lines: +4 -2

-- Put parentheses around retract-gc definitions to ensure
   correctness.  The engine had been delaying space reclamation and
   garbage collecting far too often, and this seems to fix that problem.

-- A little more thread-safety for token_xsb.c

-- Fixed bug with file_clone/3 that I introduced many moons ago.  The
problem was that I hadn't been giving names to console type files,
and file_clone used the file name in a string_find.  Now console
files have file names and things seem to work fine.
----------------------------
revision 1.24
date: 2006/01/14 16:25:32;  author: dwarren;  state: Exp;  lines: +1 -8
Fix read_canonical to read floats into doubles,
Change write_canonical to write full precision floats (compatibility?)
Move MAXINT-type declarations, perhaps for giving to Prolog.
----------------------------
revision 1.23
date: 2006/01/03 18:14:09;  author: dwarren;  state: Exp;  lines: +3 -2
Restricted writeq to escape only backslashes that were folloed by an character
that would cause it to be interpreted as an escape.
----------------------------
revision 1.22
date: 2005/12/15 20:59:28;  author: dwarren;  state: Exp;  lines: +47 -31
More tokenizer fixups.  Supports full numeric precision.  Floats are doubles,
and full 32-bit integers are handled.  And cleaned up some escapes a bit, and
did slightly better treatment of odd cases in binary/octal/hex integers.
----------------------------
revision 1.21
date: 2005/12/15 16:39:52;  author: dwarren;  state: Exp;  lines: +66 -128
1. Changed the XSB tokenizer to be more compatible with the Prolog
standard.  This involved adding escape characters when processing
strings -- single quoted, double quoted and 0-radix, as in 0'\n.  The
escape characters are those in the standard (taken from C).  I did not
add \' as a single quote within a quoted string, since it breaks the
form: '/\', which appears several times in the XSB system code.  (This
could, of course, be changed.)  Backslashes that are not followed by a
legal escape indicator are accepted simply as backslashes.  (I suspect
this is not what the standard expects, but it will break fewer
programs.)  I added the new forms for binary (e.g., 0b101), octal
(e.g., 0o731), and hex (e.g., 0xffef) that the standard requires.  I
left in the non-0 radix notation (after fixing a few bugs in it) which
is not in the standard, so we still process e.g., 8'713 as an octal
integer.  I extended the allowable radix up to 36 (which was partially
there already in a buggy form; I used A-Z for the digits 10-35.)  This
is probably not of much use, but what the hey....

The addition of the escape changed one of the tests in the testsuite.
Update tests from cvs to get the new correct answers.

2. Improved assert_code_to_buff so that it will run out of registers
less often when asserting GROUND structures.  The old version had a
limit of approximately 255 for right-branching when the left-elements
were non-constant.  E.g. arbitrary lists of constants were handled, but
lists of structures were limited to c. 255.  I've changed it so the
limit is now on left-branching instead of right-branching.  Since
right-branching is much more common in Prolog programs, this should
handle more structures that show up in Prolog programs.  (No claim is
made for Flora programs :-).
----------------------------
revision 1.20
date: 2005/12/12 00:19:12;  author: tswift;  state: Exp;  lines: +4 -4

Mutexed socket calls which dont seem to be mutexed.  Also added a
mutex around some rarely used string/symbol table statistics.

Other than that, documentation.
----------------------------
revision 1.19
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +2 -2
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.18
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +3 -2
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.17
date: 2005/08/08 17:11:35;  author: dwarren;  state: Exp;  lines: +3 -3
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.16
date: 2005/07/26 22:46:25;  author: crojo;  state: Exp;  lines: +7 -7

Fixed the ODBC interface in the multithreaded configuration.
----------------------------
revision 1.15
date: 2005/07/08 20:25:22;  author: dwarren;  state: Exp;  lines: +24 -23
More thread-safe making.  gettoken and read_canonical, this time.
----------------------------
revision 1.14
date: 2005/07/08 17:11:14;  author: dwarren;  state: Exp;  lines: +2 -2
Fix a couple of oddities I noticed. (unused var in token, strange way to fail a builtin.)
----------------------------
revision 1.13
date: 2004/01/21 19:02:04;  author: dwarren;  state: Exp;  lines: +3 -1
Simple change in read_character to ameliorate a bug in cygwin's getc().
----------------------------
revision 1.12
date: 2002/02/23 04:05:00;  author: kifer;  state: Exp;  lines: +2 -5
branches:  1.12.6;
fixed error msg
----------------------------
revision 1.11
date: 2002/01/23 17:08:10;  author: dwarren;  state: Exp;  lines: +2 -2
Changes to introduce boxed values to support 32-bit integers.  Large
32-bit integers that can't be tagged safely are put in a structure
'$BOX$'(1,Hi8bitsInt,Lo24bitsInt).  Integer operations have been
changed to handle these boxed integers.  I/O operations have NOT been
changed, so they print as complex terms.  (Also the 64-bit port won't
work with these, but they shouldn't be necessary there anyway?? It
would be very easy to add.)  A little more work needs to be done, but
the INT OVERFLOW message is no longer given and a boxed int is used in
that case.
----------------------------
revision 1.10
date: 2001/12/24 18:45:35;  author: dwarren;  state: Exp;  lines: +4 -4
Fixed unGetC for instr case, to not reset string character.  No need
since no buffering.  (And it was sometimes off-by-one??).
----------------------------
revision 1.9
date: 2001/03/23 03:51:41;  author: kifer;  state: Exp;  lines: +14 -16
replaced numeric consts with symbolic constants
----------------------------
revision 1.8
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +2 -2
improved error messages
----------------------------
revision 1.7
date: 2001/03/15 21:52:46;  author: tswift;  state: Exp;  lines: +76 -14

Changes to make reading character code constants more ISO compatable.
In particular, we now handle constants like 0'\n.  Also, I put in some
stubs for binary/octal/hex integer constants.  See documentation in code for details.

  CVS:
----------------------------------------------------------------------
----------------------------------------------------------------------
----------------------------
revision 1.6
date: 2000/06/28 16:54:53;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.6.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.5
date: 2000/06/22 19:40:32;  author: ruim;  state: Exp;  lines: +3 -3
added casts to malloc calls to avoid warnings in C++
----------------------------
revision 1.4
date: 2000/05/20 06:56:11;  author: kifer;  state: Exp;  lines: +2 -2
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.3
date: 2000/01/07 08:51:58;  author: kifer;  state: Exp;  lines: +3 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.2
date: 1999/10/26 06:47:30;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:59:47;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +4 -2
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.12.6.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.32.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.32.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.32.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/token_xsb.h,v
Working file: token_xsb.h
head: 1.15
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.13
	ROLLBACK: 1.8
	latest_plus_supp_branch: 1.8.0.2
	latest_plus_supp: 1.8
	Version_3dot2_plus_supp: 1.7.0.2
	release_2_6_plus_supp: 1.2.0.14
	Version_3dot2: 1.7
	dec07-perf-results: 1.7
	mt_thesis: 1.7
	release_3_0: 1.6
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.12.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.12.1
	multi-threaded-25-engine: 1.2.0.12
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.10
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.8
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.6
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 22;	selected revisions: 22
description:
----------------------------
revision 1.15
date: 2011/06/05 19:24:03;  author: tswift;  state: Exp;  lines: +2 -2



Changes to

1) Add flag-controlled answer depth checks to variant answer
tables.  (See current_prolog_flag in the manual for details).

2) In support of 1, added sprint_term, which prints a term to a C
string.  This is useful for errors and warnings invoked by C.

3) Added MAXTOINDEX_FLAG, which allows experimentation with the
depth of * indexing.

4) Increased the initial size strbuff from 1000 -> 10000.  This
reduces spurious long atom warnings.
----------------------------
revision 1.14
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.13
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.12
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.11
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2010/01/30 20:17:37;  author: evansbj;  state: Exp;  lines: +3 -3
branches:  1.8.2;
*** empty log message ***
----------------------------
revision 1.7
date: 2006/10/25 15:35:04;  author: ruim;  state: Exp;  lines: +4 -2
Fix for bug in locking iostrs
----------------------------
revision 1.6
date: 2006/05/22 15:40:04;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed FILE_PEEK for strings.  (It had been consuming the character.)
----------------------------
revision 1.5
date: 2005/07/18 21:54:12;  author: crojo;  state: Exp;  lines: +2 -2
*** empty log message ***
----------------------------
revision 1.4
date: 2005/07/08 20:25:22;  author: dwarren;  state: Exp;  lines: +6 -8
More thread-safe making.  gettoken and read_canonical, this time.
----------------------------
revision 1.3
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +5 -1
Integration of multithreaded system
----------------------------
revision 1.2
date: 1999/11/20 06:45:51;  author: kifer;  state: Exp;  lines: +3 -50
branches:  1.2.4;  1.2.8;  1.2.12;
Extracted token definitions into a new file token_defs_xsb.h
----------------------------
revision 1.1
date: 1999/10/25 05:59:48;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2.12.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +5 -1
Sources from rfm repository
----------------------------
revision 1.2.8.1
date: 2003/04/17 17:11:37;  author: lfcastro;  state: Exp;  lines: +4 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.2.4.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.4.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +7 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.8.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.8.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/tr_code.i,v
Working file: tr_code.i
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.9
	without-attv: 1.7
	release-2-0: 1.4
	pre-release-2-0: 1.4
	v1-9-8: 1.3
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.11
date: 1999/10/25 05:59:49;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.10
date: 1999/10/19 02:48:56;  author: cbaoqiu;  state: Exp;  lines: +168 -116
Changed variant_answer_search() and trie code instructions to handled
attributed variables.
----------------------------
revision 1.9
date: 1999/10/13 14:04:05;  author: ejohnson;  state: Exp;  lines: +2 -2
Change in single macro reference.
----------------------------
revision 1.8
date: 1999/10/12 20:28:04;  author: kostis;  state: Exp;  lines: +84 -96
Clean up and localization of variables changes.
----------------------------
revision 1.7
date: 1999/08/04 14:42:08;  author: ejohnson;  state: Exp;  lines: +4 -4
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.6
date: 1999/07/15 21:41:19;  author: ejohnson;  state: Exp;  lines: +4 -4
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.5
date: 1999/07/06 16:35:18;  author: ejohnson;  state: Exp;  lines: +75 -46
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.4
date: 1999/04/22 06:49:25;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.3
date: 1999/01/10 01:13:04;  author: cbaoqiu;  state: Exp;  lines: +25 -9
proceed_lpcreg is changed so that num_vars_in_var_regs is always set
to -1 and global_num_vars will save the old value of
num_vars_in_var_regs.  Also, handle_conditional_answers is called only
when delay_it is 1.
----------------------------
revision 1.2
date: 1998/12/21 01:08:58;  author: cbaoqiu;  state: Exp;  lines: +160 -179
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tr_code_xsb_i.h,v
Working file: tr_code_xsb_i.h
head: 1.35
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.26
	ROLLBACK: 1.20
	latest_plus_supp_branch: 1.16.0.2
	latest_plus_supp: 1.16
	Version_3dot2_plus_supp: 1.15.0.2
	release_2_6_plus_supp: 1.7.0.12
	Version_3dot2: 1.15
	dec07-perf-results: 1.15
	mt_thesis: 1.11
	release_3_0: 1.11
	release_2_7_0: 1.8
	multi-threaded-26-engine: 1.7.10.1
	pre-mt: 1.8
	multi-threaded-25-engine-done: 1.7.10.1
	multi-threaded-25-engine: 1.7.0.10
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.8
	last-merged-to-demand: 1.7
	demand_branch: 1.7.0.6
	before_removing_chat: 1.7
	release_2_5: 1.7
	pre-merge-slgwam-gc: 1.7
	multi-threaded-c-engine: 1.7.0.4
	release_2_4: 1.7
	release_2_3: 1.7
	multi-threaded-engine: 1.7.0.2
	pre-threading: 1.6
	release-2-2: 1.5
	chat-and-local: 1.5.0.2
	xsb-pre-cleanup: 1.5
	release-2-1: 1.3
	release-2-0-1: 1.2
keyword substitution: kv
total revisions: 42;	selected revisions: 42
description:
----------------------------
revision 1.35
date: 2011/08/24 21:58:08;  author: tswift;  state: Exp;  lines: +2 -2

Added functionality to CTRACE and added a new debugging statement.
----------------------------
revision 1.34
date: 2011/06/02 22:29:23;  author: tswift;  state: Exp;  lines: +1 -5
Changes	to add stack expansion so that arbitrary numbers of
variables are allowed in interned, asserted tries and tables.

This uncovered a bug.

The problem arose when a conditional answer is interned in the
answer trie and that conditional answer contains variables both
in the answer head and the delay list, and there are variables in
the answer head that are not in the delay list. What happened was
that when the variables were interned in delay_trie_chk_insert,
the mini-trail that the trie routines use for standardizing
variables was reset.  This meant that the variables in the answer
head were not being properly untrailed and, due to the particular
way that variables are standardized, variables were bound to each
other that shouldn't have been, and in this case a circular
dereferencing chain arose, so that XSB hung.  I have no idea why
the bug was uncovered just now.
----------------------------
revision 1.33
date: 2011/05/22 15:12:25;  author: tswift;  state: Exp;  lines: +2 -2

Changes to fix compiler warnings on various Mac configurations.
----------------------------
revision 1.32
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +2 -2
Getting Linux to Work
----------------------------
revision 1.31
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +6 -6
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.30
date: 2011/02/11 15:08:03;  author: tswift;  state: Exp;  lines: +13 -18

Fixes for attributed variable bug (typo fix) and fix for atom_codes
when it encounters a 0-ary predicate.
----------------------------
revision 1.29
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +42 -4

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.28
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +46 -44

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.27
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +93 -93

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.26
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -3
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.25
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.24
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.21
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +3 -1
no message
----------------------------
revision 1.20
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.19
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.18
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -2
Backed out code
----------------------------
revision 1.17
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +3 -1
Dipti's code for support graph added
----------------------------
revision 1.16
date: 2009/10/22 16:16:03;  author: tswift;  state: Exp;  lines: +32 -4
branches:  1.16.2;

Added fix so that when an attribtued variable in a table is returned and unified
with a non-variable, the constraint is properly posted as an interrupt.
----------------------------
revision 1.15
date: 2007/09/04 00:49:09;  author: dwarren;  state: Exp;  lines: +5 -5
Change how attv interrupts are stored.  They used to be stored in an
array.  Now they are stored in the heap. This simplifies things, and
fixes a bug in garbage collection.
----------------------------
revision 1.14
date: 2007/08/30 14:46:19;  author: dwarren;  state: Exp;  lines: +1 -3
Fixed bug that showed up in GC in handling of reg_array.  reg_arrayptr
was not being reset to indicate reg_array was empty, so GC tried to
relocate garbage pointers.  So this resets reg_array to empty in
all restore-state type instructions.

Also found bug in GC in that it doesn't handle heap pointers in the
attv_interrupts array correctly.  That bug is not fixed.  I think we
need to change the way attv interrupts are accumulated and eliminate
this array.  But that awaits....
----------------------------
revision 1.13
date: 2007/07/10 20:29:35;  author: dwarren;  state: Exp;  lines: +7 -2
Add heap overflow tests to copying terms out of tries.  At every
push of a structure onto the heap, it checks for overflow.  (I had been
hoping to find a way to test more rarely, but this works and the
slowdown should be pretty minimal, I think.)  The hard
part was to fix garbage collection to handle the reg_array registers
and relocate them as well.  The sliding collector passes the test suite.
The copying collector fails a few tests, but I checked and the previous
cvs version failed the same tests, so I haven't made it any worse.

Also made some minor changes to debug_xsb.c so it would at least compile
for me under cygwin.
----------------------------
revision 1.12
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +4 -4
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.11
date: 2005/10/03 13:26:43;  author: tswift;  state: Exp;  lines: +40 -8


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.10
date: 2005/09/01 18:37:06;  author: tswift;  state: Exp;  lines: +9 -1


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.9
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +12 -7
Integration of multithreaded system
----------------------------
revision 1.8
date: 2004/11/17 21:55:07;  author: tswift;  state: Exp;  lines: +10 -6

I did find the bug(s) with attributed variables.

What apparently needs to be done on unifying to an attribute variable is

1) Build interrupts.  For an attributed variable, this means passing a
pointer to the attribute list.

2) Bind the attributed variable "eagerly" (as opposed to lazily, as
before)

This was being done correctly for the Prolog unification macros, but
not for the trie unification macros.  These latter macros passed a
pointer to the attributed variable (not the attr list) and skipped
step 2.

I changed what seemed to be appropriate places in tr_code_xsb_I.h,
namely in unify_with_trie_numcon, unify_with_trie_str,
unify_with_trie_list and unify_with_trie_attv.  However I did not
change unify_with_trie_val, as the comments in the code (from Bao, I
think) indicated that no interrupt should be dispaltched in this case.

This seemed to fix things.  The problem observed in a previous email
was that when the trie instructions passed a pointer to an attributed
variable, rather than to an attribute list, unification insructions in
the prolog attribute handling caused new bindings (e.g. binding to [])
causing new interrupts and an infinite loop.
----------------------------
revision 1.7
date: 2000/06/22 01:27:51;  author: lfcastro;  state: Exp;  lines: +5 -5
branches:  1.7.2;  1.7.10;
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.6
date: 2000/04/29 21:54:00;  author: kifer;  state: Exp;  lines: +13 -11
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.5
date: 2000/01/06 20:17:00;  author: cbaoqiu;  state: Exp;  lines: +14 -6
Do not trigger attv interrupt in unify_with_trie_val (needed for
clp(Q,R)).
----------------------------
revision 1.4
date: 1999/12/22 18:07:09;  author: warren;  state: Exp;  lines: +2 -2
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.3
date: 1999/11/14 17:47:07;  author: cbaoqiu;  state: Exp;  lines: +96 -88
Changed some unification macros to allow attv interrupts during the
execution of trie code.  This is required by trie_assert, get_calls
and get_returns.
----------------------------
revision 1.2
date: 1999/11/05 03:52:11;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changed some lines used for debugging attv.
----------------------------
revision 1.1
date: 1999/10/25 05:59:50;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.7.10.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +11 -6
Sources from rfm repository
----------------------------
revision 1.7.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.7.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.16.2.4
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.16.2.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +2 -0
no message
----------------------------
revision 1.16.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tr_delay.h,v
Working file: tr_delay.h
head: 1.22
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.21
	ROLLBACK: 1.16
	latest_plus_supp_branch: 1.16.0.4
	latest_plus_supp: 1.16
	Version_3dot2_plus_supp: 1.16.0.2
	release_2_6_plus_supp: 1.15.0.6
	Version_3dot2: 1.16
	dec07-perf-results: 1.16
	mt_thesis: 1.16
	release_3_0: 1.16
	release_2_7_0: 1.15
	multi-threaded-26-engine: 1.13.4.2
	pre-mt: 1.15
	multi-threaded-25-engine-done: 1.13.4.1
	multi-threaded-25-engine: 1.13.0.4
	release_2_6_1: 1.15
	release_2_6_final: 1.15
	release_2_6: 1.15.0.4
	last-merged-to-demand: 1.15
	demand_branch: 1.15.0.2
	before_removing_chat: 1.13
	release_2_5: 1.13
	pre-merge-slgwam-gc: 1.13
	multi-threaded-c-engine: 1.13.0.2
	release_2_4: 1.13
	release_2_3: 1.12
	multi-threaded-engine: 1.12.0.2
	pre-threading: 1.11
	release-2-2: 1.10
	chat-and-local: 1.10.0.2
	xsb-pre-cleanup: 1.10
	release-2-1: 1.10
	release-2-0-1: 1.10
	subsumption: 1.10
	without-attv: 1.9
	release-2-0: 1.6
	pre-release-2-0: 1.6
	v1-9-8: 1.5
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 30;	selected revisions: 30
description:
----------------------------
revision 1.22
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +15 -15

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.21
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.20
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.19
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.18
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.17
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.16
date: 2005/01/14 18:31:35;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.16.4;
Integration of multithreaded system
----------------------------
revision 1.15
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +10 -10
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.14
date: 2002/05/22 15:41:16;  author: lfcastro;  state: Exp;  lines: +12 -36
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.13
date: 2001/04/28 20:15:37;  author: ejohnson;  state: Exp;  lines: +2 -2
branches:  1.13.4;
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.12
date: 2000/07/31 20:27:57;  author: ejohnson;  state: Exp;  lines: +5 -5
branches:  1.12.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.11
date: 2000/05/29 04:23:39;  author: ejohnson;  state: Exp;  lines: +4 -4
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.10
date: 1999/10/09 18:37:53;  author: kostis;  state: Exp;  lines: +14 -10
Cleanup changes so that variables are declared and appear only in places
where they are actually needed.  Expect speed-up by doing so.
Also, finally, ugly xtemp[3-15] variables were eliminated.
Sorry, Terry !
----------------------------
revision 1.9
date: 1999/09/20 09:06:04;  author: kostis;  state: Exp;  lines: +5 -4
Changes to fix problem that caused the flora1 bug.  Changes affect both
SLG-WAM and CHAT emulators.
----------------------------
revision 1.8
date: 1999/09/18 04:39:47;  author: cbaoqiu;  state: Exp;  lines: +12 -2
Put some delay-variable stuff into ``#ifndef IGNORE_DELAYVAR'' (to
help Kostis debug).  By doing this, we make sure that no substitution
factor of the answer is put into the heap.  [To disable delay-variable
handling, one can put ``#define IGNORE_DELAYVAR'' in the file
$XSB/emu/debugs/debug_delay.h.]
----------------------------
revision 1.7
date: 1999/08/16 07:24:37;  author: kifer;  state: Exp;  lines: +7 -7
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.6
date: 1999/02/27 21:58:47;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Cleaned the simplification code for delay, and added some lines in
simplify_pos_unconditional() to release all the DLs and their DEs.
The DelayInfo node will be freed when it is not needed.
----------------------------
revision 1.5
date: 1999/01/29 04:18:28;  author: cbaoqiu;  state: Exp;  lines: +5 -7
Changed string_find("ret", 1) to ret_psc[0].  ret_psc[0] is set at the
time when the system is started.
----------------------------
revision 1.4
date: 1999/01/28 09:09:42;  author: cbaoqiu;  state: Exp;  lines: +33 -19
Changed the call of delay_positively() so that the SUBSF is not always
a CS pointer (it can be a string "ret").
----------------------------
revision 1.3
date: 1998/12/21 01:09:00;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:22:57;  author: cbaoqiu;  state: Exp;  lines: +56 -20
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  handle_conditional_answers is modified to support variables in delay
  list.
----------------------------
revision 1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.12.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.12.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.13.4.2
date: 2004/10/18 20:46:13;  author: ruim;  state: Exp;  lines: +13 -37
update for version 2.6.1
----------------------------
revision 1.13.4.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.16.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.16.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.16.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tr_utils.c,v
Working file: tr_utils.c
head: 1.251
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.206
	ROLLBACK: 1.199
	latest_plus_supp_branch: 1.192.0.2
	latest_plus_supp: 1.192
	Version_3dot2_plus_supp: 1.176.0.2
	release_2_6_plus_supp: 1.71.0.4
	Version_3dot2: 1.176
	dec07-perf-results: 1.161
	mt_thesis: 1.132
	release_3_0: 1.116
	release_2_7_0: 1.75
	multi-threaded-26-engine: 1.66.2.7
	pre-mt: 1.75
	multi-threaded-25-engine-done: 1.66.2.1
	multi-threaded-25-engine: 1.66.0.2
	release_2_6_1: 1.71
	release_2_6_final: 1.71
	release_2_6: 1.71.0.2
	last-merged-to-demand: 1.69
	demand_branch: 1.69.0.2
	before_removing_chat: 1.66
	release_2_5: 1.66
	pre-merge-slgwam-gc: 1.65
	multi-threaded-c-engine: 1.65.0.2
	release_2_4: 1.63
	release_2_3: 1.60
	multi-threaded-engine: 1.56.0.2
	pre-threading: 1.44
	release-2-2: 1.36
	chat-and-local: 1.36.0.2
	xsb-pre-cleanup: 1.36
	release-2-1: 1.29
	release-2-0-1: 1.29
	subsumption: 1.25
	without-attv: 1.24
	release-2-0: 1.19
	pre-release-2-0: 1.16
	v1-9-8: 1.10
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: o
total revisions: 275;	selected revisions: 275
description:
----------------------------
revision 1.251
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +1 -0

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.250
date: 2012/06/23 17:21:34;  author: tswift;  state: Exp;  lines: +9 -0
Added table_inspection builtin for use by get_returns_and_tvs.
----------------------------
revision 1.249
date: 2012/06/04 15:29:03;  author: dwarren;  state: Exp;  lines: +3 -2
Changed int type and added cast to quiet compiler.
----------------------------
revision 1.248
date: 2012/06/03 17:27:01;  author: tswift;  state: Exp;  lines: +1 -1

Setting up to log negative calls.
----------------------------
revision 1.247
date: 2012/05/18 20:35:41;  author: tswift;  state: Exp;  lines: +29 -1

Added check_variant/[1,2]
----------------------------
revision 1.246
date: 2012/04/26 18:19:27;  author: tswift;  state: Exp;  lines: +17 -1

Updates so that incremental tabling works with full WFS.

Also refactored the incremental tabling code a little.
----------------------------
revision 1.245
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +3 -4

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.244
date: 2012/02/29 21:10:19;  author: tswift;  state: Exp;  lines: +5 -5

Made abolish_table_pred abort rather than warn when called with an
incrementally tabled predicate.  I thought I'd already done that.
----------------------------
revision 1.243
date: 2012/02/24 17:37:21;  author: tswift;  state: Exp;  lines: +12 -0

abort_pre_action and friends.
----------------------------
revision 1.242
date: 2012/02/19 19:17:56;  author: tswift;  state: Exp;  lines: +7 -3

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.241
date: 2012/02/04 23:31:36;  author: tswift;  state: Exp;  lines: +1 -1

Fixed bug in stream I/O in print_incomplete_tables.
----------------------------
revision 1.240
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +12 -1
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.239
date: 2012/01/12 14:35:15;  author: dwarren;  state: Exp;  lines: +1 -1
Used sprintCyclicTerm instead of sprintTerm.  Probably unlikely to be a cyclic
term, but it's in an error message, so the extra time shouldn't matter, and
better safe than sorry...
----------------------------
revision 1.238
date: 2012/01/06 17:16:47;  author: tswift;  state: Exp;  lines: +3 -0
Setting del_ret_list ptr to null after reclaiming to avoid approximation bug.
----------------------------
revision 1.237
date: 2012/01/03 13:49:29;  author: dwarren;  state: Exp;  lines: +1 -1
Add coercion to quiet MSVC-64
----------------------------
revision 1.236
date: 2011/12/26 16:58:18;  author: tswift;  state: Exp;  lines: +6 -1
Changes for print_incomplete_tables/1.
----------------------------
revision 1.235
date: 2011/12/24 20:45:12;  author: tswift;  state: Exp;  lines: +13 -10

Fix for n2c for MT XSB + fixed some MT compiler errors
----------------------------
revision 1.234
date: 2011/12/21 20:54:56;  author: tswift;  state: Exp;  lines: +14 -2

Adding get_current_scc.
----------------------------
revision 1.233
date: 2011/11/12 00:33:31;  author: tswift;  state: Exp;  lines: +15 -7

Added depth check for interned tries -- use tabled answer depth /
action flags.
----------------------------
revision 1.232
date: 2011/11/11 18:21:39;  author: dwarren;  state: Exp;  lines: +2 -2
Added flag[UNIFY_WITH_OCCURS_CHECK_FLAG] that when true causes XSB
to do all unifications with occur_check.  (Not completely tested, and
better efficiency is possible by having compiler generate different
bldval instructions when it can determine that occur-check isn't needed.)
----------------------------
revision 1.231
date: 2011/11/09 02:28:19;  author: dwarren;  state: Exp;  lines: +1 -1
Changed unify to unify cyclic terms without going into an infinite loop.

Also fixed some calls to print term that gave too large a level parameter
which caused overflow of C runstack.
----------------------------
revision 1.230
date: 2011/10/29 23:27:58;  author: tswift;  state: Exp;  lines: +183 -2

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.229
date: 2011/10/21 14:17:16;  author: dwarren;  state: Exp;  lines: +2 -1
Added a cast to quiet MSVC64 warnings.
Commented out unused variable, again to quiet warning.
----------------------------
revision 1.228
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +13 -6

Integrating in Call Abstraction
----------------------------
revision 1.227
date: 2011/08/24 21:58:08;  author: tswift;  state: Exp;  lines: +30 -5

Added functionality to CTRACE and added a new debugging statement.
----------------------------
revision 1.226
date: 2011/08/22 16:15:24;  author: dwarren;  state: Exp;  lines: +1 -1
Cleaned up recent checkins to work with MSVC, and avoid warnings.
(Changed bzero to memset, since MS seems not to have bzero.)
Also changed a couple of builtins to be more consistent in their
treatment of string p vs. 0-ary structure symbol p.
----------------------------
revision 1.225
date: 2011/08/20 21:36:49;  author: tswift;  state: Exp;  lines: +1 -1

Fixed bug in hash opcode where it was throwing an error when encountering an attv.

Will go through occurrences of isref() to make sure things are attv safe (or at least to triage).
----------------------------
revision 1.224
date: 2011/08/20 20:40:08;  author: tswift;  state: Exp;  lines: +5 -2

Added a forgotten break statement.
----------------------------
revision 1.223
date: 2011/08/19 21:44:15;  author: tswift;  state: Exp;  lines: +5 -1

Mostly minor changes to let ctrace print out early completion, and to
allow ctrace to be directed to stdout rather than a file if desired.
This necessitated some minor code refactoring.
----------------------------
revision 1.222
date: 2011/08/19 18:26:30;  author: tswift;  state: Exp;  lines: +13 -1

Changes to support Ctrace (Fview).
----------------------------
revision 1.221
date: 2011/08/12 15:17:13;  author: tswift;  state: Exp;  lines: +29 -8

Fixes for approximate tabling and correcting memory errors.
----------------------------
revision 1.220
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +13 -11
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.219
date: 2011/08/03 18:14:11;  author: tswift;  state: Exp;  lines: +3 -2
Added support for an extended table_dump
----------------------------
revision 1.218
date: 2011/07/29 22:56:04;  author: tswift;  state: Exp;  lines: +33 -2

changes to

1) Add number of calls to a tabled predicate
2) Some termination conditions.
3) Some preliminary stuff for call abstraction
----------------------------
revision 1.217
date: 2011/06/22 21:27:53;  author: tswift;  state: Exp;  lines: +71 -4

Now maintaining gc time for abolishing tables -- this way I can tell
if my heuristics are out of whack for some program.
----------------------------
revision 1.216
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +6 -6
Getting Linux to Work
----------------------------
revision 1.215
date: 2011/05/19 15:05:05;  author: tswift;  state: Exp;  lines: +1 -1

Fixes to recompile XSB on Mac.
----------------------------
revision 1.214
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +32 -32
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.213
date: 2011/05/13 16:23:46;  author: tswift;  state: Exp;  lines: +2 -1

Making error types consistent between get_call and get_calls.
----------------------------
revision 1.212
date: 2011/04/12 17:31:59;  author: tswift;  state: Exp;  lines: +2 -1

Fix of abolishing incremental tables when the affected list is
non-empty -- it needed to be re-initialized to null.  In addition, the
changed list also needs to be initted and reinitialized to null, but
this is accessed less often so we haven't yet seen that problem arise.

I also changed the name of the global variables for incremental
tabling to make them more obvious -- names like "changed" and
"affected" arent good.
----------------------------
revision 1.211
date: 2011/01/09 22:30:16;  author: tswift;  state: Exp;  lines: +53 -0

Minor code cleanup: some changes in documentation, changes to make a
function name accord with a builtin name, and moved some table
abolishing routines from tries.c to tr_utils.c with all the others.
----------------------------
revision 1.210
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +10 -10

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.209
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +2 -2

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.208
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +5 -5

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.207
date: 2010/11/28 23:14:13;  author: tswift;  state: Exp;  lines: +13 -1

Added counts of abolishes to statistics (if there have been any).
Also added a count of the number of incomplete tables (if there are any).
----------------------------
revision 1.206
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +58 -141
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.205
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.204
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.203
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.202
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.201
date: 2010/08/17 19:45:53;  author: spyrosh;  state: Exp;  lines: +141 -58
no message
----------------------------
revision 1.200
date: 2010/08/17 19:45:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.199
date: 2010/08/01 22:06:02;  author: tswift;  state: Exp;  lines: +10 -1

biassert.c -- minor doc change

Others: changes to allow directives to change tables among
incremental, nonincremental, and opaque.
----------------------------
revision 1.198
date: 2010/07/05 20:47:42;  author: tswift;  state: Exp;  lines: +12 -6

Another small update to delete_branch to support backtrackable updates
and trie_unintern_nr.
----------------------------
revision 1.197
date: 2010/07/04 19:02:16;  author: tswift;  state: Exp;  lines: +15 -3



Made delete_branch check the BTNs that it deallocated, to make sure
that it wasn't deallocating an already-deallocated BTN.  The foregoing
situation arose when using trie_unintern_nr and reclaim_unintern_nr by
the storage module for backtrackable updates.
----------------------------
revision 1.196
date: 2010/06/22 23:51:37;  author: spyrosh;  state: Exp;  lines: +2 -131
no message
----------------------------
revision 1.195
date: 2010/06/19 19:10:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.194
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +131 -2
Dipti's code for support graph added
----------------------------
revision 1.193
date: 2010/06/18 17:07:05;  author: tswift;  state: Exp;  lines: +22 -3

Added code to abolish_table_calls to reinitialize hash tables for
incremental tries after all the hashtables have been destroyed.

This fixes things for incremental tries, but I think we still have the
same problem of destroyed  hash tables for regular dynamic code.
----------------------------
revision 1.192
date: 2010/05/21 17:00:53;  author: tswift;  state: Exp;  lines: +3 -1
branches:  1.192.2;

Commented out some incomplete code that caused compiler errors.
----------------------------
revision 1.191
date: 2010/05/21 16:07:55;  author: tswift;  state: Exp;  lines: +2 -5

tr_utils.c: removed increment of ans_deletes
sub_delete.c: resolved (potentially) ambiguous else.
----------------------------
revision 1.190
date: 2010/05/20 18:12:43;  author: tswift;  state: Exp;  lines: +2 -2

Additional places to chech for ALN tag before reclaiming space for conditional answers.
----------------------------
revision 1.189
date: 2010/05/20 17:52:18;  author: tswift;  state: Exp;  lines: +62 -8

Added check for ALNtag before trying to reclaim conditional answer information on abolish (for delete variant subgoaland answer)
----------------------------
revision 1.188
date: 2010/04/24 20:50:43;  author: tswift;  state: Exp;  lines: +23 -2

Changes for incremental tabling based on tries.
----------------------------
revision 1.187
date: 2010/04/02 17:24:42;  author: evansbj;  state: Exp;  lines: +4 -2
Another one, I think for most C compilers this would cause a strange subtle bug that disappears when DEBUG_VERBOSE is turned on. With DEBUG_VERBOSE off the xsb_dbgmsg line disappears and the 'if' applies to whatever the next line is after the C preprocessor is done...
----------------------------
revision 1.186
date: 2010/03/19 18:42:19;  author: tswift;  state: Exp;  lines: +2 -1

Re-added decrement of BTHT_numContents in delete_branch()
----------------------------
revision 1.185
date: 2010/03/14 01:47:00;  author: evansbj;  state: Exp;  lines: +6 -5
Housekeeping cleaned up some unnecessary variable assignments ...
----------------------------
revision 1.184
date: 2010/03/01 00:26:32;  author: evansbj;  state: Exp;  lines: +2 -4
More housekeeping removed some unnecessary assignments ...
----------------------------
revision 1.183
date: 2010/01/23 19:03:03;  author: tswift;  state: Exp;  lines: +6 -2

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.182
date: 2009/11/17 19:32:08;  author: dwarren;  state: Exp;  lines: +29 -23
Added pointers in the Child field of leaf nodes of answers to point to
the ALN node *preceding* the ALN node that points to it.
This pointer is used in the deletion of an answer.
It is tagged so that it can be known what the pointer is.
If there are conditional answers, this field is used for pointing
to the delay elements, and so is not used for this ALN pointer.
In that case, the entire ALN list must be run when deleting an answer
with a delay list.
----------------------------
revision 1.181
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.180
date: 2009/11/08 18:29:22;  author: tswift;  state: Exp;  lines: +3 -3

No functionality changes -- just some name changes and simplifications
in preparation for my trip to Portugal.

These were mostly name changes, but I did get rid of a few functions
-- not for efficiency but for simplicity.
----------------------------
revision 1.179
date: 2009/09/07 21:08:04;  author: tswift;  state: Exp;  lines: +15 -12

Implemented abolish_table_call for subsumptive predicates.
----------------------------
revision 1.178
date: 2009/09/07 15:58:13;  author: tswift;  state: Exp;  lines: +2 -2

Fixes a bug in certain cases of garbage collecting subsumptive tables.
----------------------------
revision 1.177
date: 2009/03/29 21:40:10;  author: tswift;  state: Exp;  lines: +8 -10
Changes to allow max_tries as a command-line option.
----------------------------
revision 1.176
date: 2009/03/14 22:04:47;  author: tswift;  state: Exp;  lines: +2 -2

Very minor changes to shut up the compiler.
----------------------------
revision 1.175
date: 2009/02/21 16:47:34;  author: tswift;  state: Exp;  lines: +96 -11

Changes to support

statistics/2
Rui's fix for the mt bug

along with scratch code for answer_completion.
----------------------------
revision 1.174
date: 2009/01/22 15:28:22;  author: tswift;  state: Exp;  lines: +41 -16

Changes to fix a bug in find_components, which is still under development.
----------------------------
revision 1.173
date: 2009/01/15 18:53:47;  author: dwarren;  state: Exp;  lines: +7 -7
Fixed a bug in accounting for mem_dealloc size in a particular case
of table processing.  This makes the table space statistics (more) correct.
----------------------------
revision 1.172
date: 2009/01/11 17:54:45;  author: tswift;  state: Exp;  lines: +64 -65

Finished update of table abolish/gc routines by making gc mark
check delay list (didn't do this last night because I wanted to
be fresh).  Also did some minor code refactoring and optimization
for these routines.
----------------------------
revision 1.171
date: 2009/01/10 23:37:07;  author: tswift;  state: Exp;  lines: +173 -59

Extended (almost) all the marking routines for tabled predicates
so that subgoals in the heap delay list are checked.  This rather
obscure bug caused a crash in a Flora program for defeasible
logic.  I'll try to finish that part tomorrow.

The problem was that space was reclaimed for a table T that had a
delay element in the heap pointing to it.  When the answer with
the delay element was added, the engine tried to adjust the
backpointers for T and crashed.

Also made some minor ajustments for efficency to some of the
marking functions.  And I changed abolish_table_info to the
clearer abolish_all_tables.
----------------------------
revision 1.170
date: 2009/01/09 23:19:10;  author: tswift;  state: Exp;  lines: +2 -2

Fixed dumb typo in switch to abolish tables transitively vs singly.
----------------------------
revision 1.169
date: 2009/01/04 21:12:29;  author: tswift;  state: Exp;  lines: +50 -46
In some Flora programs with defeasible reasoning, a
mysterious "null node" warning had been printed out.  It turned
out that this was being emitted by find_answers_for_subgoal(),
which is used in cascading abolishes.  The problem arose for
deleting calls that had empty answer tries, where a stack was
checked, a null node immediately found, and the routine exited.
In this case, it was harmless, but I added a check to get rid of
the warning in this case, and made the warning itself more
descriptive.
----------------------------
revision 1.168
date: 2009/01/02 17:50:03;  author: tswift;  state: Exp;  lines: +53 -42


Updating a number of files so that delete_branch() will work with call
subsumption (it needs to know that it deallocates BTNs rather than
TSTNs).  This fixed a latent bug in simplification and allows another
test to be run for call subsumption. It also provides a step towards
supporting answer subsumption on call subsumptive tables.  There are
also some other documentationstyle changes.

Adding a new test for copying attributed variables into delay elements
/ lists.  I hadn't thought this worked, but apparently it does !

Also, I'm adding a very simple test for incremental evaluation -- more
cases need to be added here, but at least this is a start.
----------------------------
revision 1.167
date: 2009/01/01 20:16:56;  author: tswift;  state: Exp;  lines: +33 -8

tr_utils.c -- fixed bug for abolish_all_tables in mt engine that
showed up when running some subsumption tests on mt engine.  Now the
mt engine runs the sequential test suite in the same way as the
sequential engine.

slgdelay.c -- minor changes to get rid of compiler warnings.
----------------------------
revision 1.166
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +59 -3


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.165
date: 2008/11/15 06:06:40;  author: kifer;  state: Exp;  lines: +3 -3
added stddbg to apparently debugging statements
----------------------------
revision 1.164
date: 2008/10/16 17:57:58;  author: dwarren;  state: Exp;  lines: +2 -2
Use data field in psc-records for predicates loaded into usermod to point
to the full filename of the file from which it was loaded.  Used this to
print a warning when XSB loads code for a usermod predicate that was previously
defined from a different file.
Will look at extending current_predicate to return this information, but that
has not yet been done.
----------------------------
revision 1.163
date: 2007/12/27 00:01:46;  author: tswift;  state: Exp;  lines: +3 -3

Small changes to make mutexes on shared tries recursive -- to support bulk_XXX style operations.
----------------------------
revision 1.162
date: 2007/12/24 19:16:59;  author: tswift;  state: Exp;  lines: +240 -98

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.161
date: 2007/12/06 23:24:55;  author: ruim;  state: Exp;  lines: +5 -4
replaced shared struct manangers with malloc
which improves scalabilty on a multi-processor

that required a number of small fixes to have coherency
between shared and private struct managers
----------------------------
revision 1.160
date: 2007/11/20 19:17:21;  author: tswift;  state: Exp;  lines: +160 -87


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.159
date: 2007/11/04 22:31:45;  author: tswift;  state: Exp;  lines: +2 -2

Minor refactoring before major refactorings later.  Took
initialization of global variables for SLGWAM instructions out of
thread initialiation and put it into system initialization, where it
should be.
----------------------------
revision 1.158
date: 2007/10/26 22:47:33;  author: tswift;  state: Exp;  lines: +3 -3

Changes to support new ISO mutex_property.

tr_utils.c tries.c -- changes are comments
----------------------------
revision 1.157
date: 2007/10/19 21:15:15;  author: tswift;  state: Exp;  lines: +2 -2

Changes to add call_cleanup/2, whose semantics is ISO compliant as far
as the ISO definition goes.  I also put call_cleanup/2 in std_xsb.P.
Cleanup handlers are scheduled through the attv interrupt chain, so I
needed to hack this code a little to make sure that an interrupt
handler for cleanups is always present.

Also, I made a change to peephole to not optimize away a putpbreg_ci
-- we'll usually need it for call_cleanups.

Right now I'm using a static inline for CHECK_CALL_CLEANUP -- on gcc
this should be as fast as a macro and allows me to trace if there are
any problems.


Adding these changes made me need to adjust a few include statements
in tr_utils.c and tst_retrv.c
----------------------------
revision 1.156
date: 2007/10/09 17:15:04;  author: dwarren;  state: Exp;  lines: +9 -9
These changes implement a facility that allows a routine called from
XSB as foreign code to call a predicate back in XSB.  This allows
mutual recursion between XSB and foreign code (and has been tested by
programming a recursive fibonacci in which the Prolog code calls C for
the samller values and C calls Prolog for its smaller values.)

It is similar to the "C calling XSB" interface, with the following
differences:

1. Do not call xsb_init or xsb_init_string.  These functions
initialize XSB, which clearly cannot be done if XSB is already
running.

2. A foreign routine called from XSB that wants to call an XSB
predicate must first call:
	xsb_query_save(NumRegs)

It must do this after retrieving its input parameters from XSB and
before calling any XSB predicate.  NumRegs must be the number of XSB
registers that the current foreign code uses (i.e., the number of
arguments of the XSB predicate used to call this foreign code
routine.)  This call saves the caller registers and sets up the XSB
state to accept queries from the foreign code.  (This is similar to
the XSB state after xsb_init is called.)  So after this call, the
foreign routine can use any of the interface routines for calling XSB,
such as xsb_command, xsb_command_string, xsb_query, xsb_query_string,
etc.

3. Before setting its output parameters and returning to its caller,
the foreign routine must call
	xsb_query_restore()

This restores the XSB parameter registers back to their state when
xsb_query_save() was called, and so prepares the registers to accept
the return values.  (It must be called even if there are no values to
be returned.)

This code works (according to my tests) for the single-threaded
engine.  It does NOT currently work for the multi-threaded engine.
I've put in the necessary CTXT- stuff, but still get crashes.  I'm
sure it can be made to work, but may need help in figuring out how.
----------------------------
revision 1.155
date: 2007/09/28 19:38:57;  author: tswift;  state: Exp;  lines: +2 -2
Minor changes to get rid of compiler warnings on 64-bit linux
----------------------------
revision 1.154
date: 2007/08/13 18:28:57;  author: dwarren;  state: Exp;  lines: +6 -5
Fixed bug in calling safe_delete_branch; must pass leaf, not root.
----------------------------
revision 1.153
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.152
date: 2007/07/11 17:55:31;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed a careless bug in my recent change to safe_delete_branch, when
computing the new instruction.
----------------------------
revision 1.151
date: 2007/07/10 20:25:10;  author: dwarren;  state: Exp;  lines: +7 -5
Changed safe_delete_branch to special-case on trie_root instruction.
This may not be a general solution, but it fixes my immediate problem.
----------------------------
revision 1.150
date: 2007/07/06 13:58:47;  author: ruim;  state: Exp;  lines: +3 -3
change to *compile* in a 64 bit machine
----------------------------
revision 1.149
date: 2007/07/03 14:56:53;  author: dwarren;  state: Exp;  lines: +4 -4
Commented out a couple of debugging log messages.
----------------------------
revision 1.148
date: 2007/06/16 22:16:29;  author: tswift;  state: Exp;  lines: +78 -34

Fixed some bugs in table gc as uncovered by Flora.  These bugs related
to having "dangling" deltfs that pointed to structures that had
already been reclaimed.

1) Added a DELETED bit to subgoal frames to ensure that the same
   subgoal frame won't be added twice to a DelTF list.

2) Ensured that deltfs are freed whenever abolish_all_*_tables is
   called.  This prevents a case where a table is put on the deltf
   chain, abolish_all_tables frees it, and then gc tries to reclaim a
   stale subgoal or predicate.
----------------------------
revision 1.147
date: 2007/06/11 21:07:58;  author: dwarren;  state: Exp;  lines: +2 -2
Allocated one more interned_trie, since it seems to use one more to hold
a final dummy marker.  Terry, if you extend this array, check out if this
is how you want to do it.
----------------------------
revision 1.146
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +88 -125

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.145
date: 2007/06/06 21:29:06;  author: dwarren;  state: Exp;  lines: +3 -2
Minor change to quiet MSVC compiler complaints.
----------------------------
revision 1.144
date: 2007/06/06 20:43:19;  author: tswift;  state: Exp;  lines: +3 -1

Trey Evan's updates for 64-bits.
----------------------------
revision 1.143
date: 2007/06/04 13:00:09;  author: tswift;  state: Exp;  lines: +16 -3

Bug fix (I hope).
----------------------------
revision 1.142
date: 2007/06/01 22:47:10;  author: tswift;  state: Exp;  lines: +987 -264

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.141
date: 2007/05/01 14:52:29;  author: tswift;  state: Exp;  lines: +278 -1

Adding scratch code for table inspection functions that may, if they're good, grow up into answer_completion and the like.
----------------------------
revision 1.140
date: 2007/04/06 11:41:48;  author: tswift;  state: Exp;  lines: +61 -28
Changes and additions to comments only (since at least Barry reads the comments :-)
----------------------------
revision 1.139
date: 2007/04/05 17:26:57;  author: tswift;  state: Exp;  lines: +62 -9
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.138
date: 2007/04/03 16:38:41;  author: tswift;  state: Exp;  lines: +3 -2
Commented out unnecessary list traversal in trie_dispose_nr
----------------------------
revision 1.137
date: 2007/02/23 20:17:05;  author: tswift;  state: Exp;  lines: +8 -8
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.136
date: 2007/02/22 20:41:53;  author: tswift;  state: Exp;  lines: +10 -3


Fixed memory deallocation problem introduced yesterday with the introduction
of private structure managers for trie hash arrays.  This problem only showed up for the MT engine in Linux.
----------------------------
revision 1.135
date: 2007/02/22 00:16:05;  author: tswift;  state: Exp;  lines: +1 -3


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.134
date: 2007/02/09 18:12:17;  author: dwarren;  state: Exp;  lines: +1 -1
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.133
date: 2006/12/14 19:38:07;  author: tswift;  state: Exp;  lines: +6 -5
Changes to handle uninitialized/freed data in tabling delay lists and in garbage colleting data.
----------------------------
revision 1.132
date: 2006/12/07 00:26:45;  author: tswift;  state: Exp;  lines: +206 -41

-- Added reclamation of conditional answer information (including
   subgoal PNDEs and delay tries) when variant predicates/subgoals are
   abolished in abolish_table_pred/1, abolish_table_call/1, and
   close_open_tables/0.  Also, wrote delete_delay_trie() to delete
   answer substitution factor for delay elements, and made sure this
   was used whenever des are reclaimed -- (e.g. by abolishes and
   simplifications).

-- fixed some bugs in MT engine where situations could arise where
   trie allocation type was not properly set before abolishes called
   in table gc sweeps or reloading tabled predicates.

-- Fixed numerous bugs in performing simplification in the MT engine.
   In general simplification routines may reclaim structures for delay
   lists, delay elements, answer branches, asis and pndes.  Whenever
   any of these structures are reclaimed in the MT engine a check must
   be made to determine whether these elements use private or shared
   memory management -- either struture managers or the managers for
   des/dls/pndes.  Keeping all of this straight required some thinking
   as the code flits from table to table by traversing pndes --
   however I think I was able to extend the code without undue mess
   (at least this time :-)
----------------------------
revision 1.131
date: 2006/11/28 14:18:06;  author: ruim;  state: Exp;  lines: +3 -3
added one mutex to each struct manager so that MUTEX_SM is now obsolete.
this should provide a bit more scalability.
----------------------------
revision 1.130
date: 2006/11/28 02:37:25;  author: ruim;  state: Exp;  lines: +11 -3
shaken a few bugs from concurrent completions and
shared completed tables
allowed free_trie_ht to work for shared tables
----------------------------
revision 1.129
date: 2006/11/25 13:00:10;  author: ruim;  state: Exp;  lines: +9 -1
fixed bug in abolish_all_private_tables
----------------------------
revision 1.128
date: 2006/11/22 16:18:07;  author: ruim;  state: Exp;  lines: +69 -69
Fixed heap expansion and GC to allow concurrency, by
moving global variables into the thread context.

GC_PROFILE was not fixed
----------------------------
revision 1.127
date: 2006/11/20 16:53:42;  author: ruim;  state: Exp;  lines: +4 -4
added incarnation number to thread id to avoid problems with
detached threads, when joining could mistake a thread with one reusing and old id
----------------------------
revision 1.126
date: 2006/11/15 16:38:10;  author: tswift;  state: Exp;  lines: +101 -15

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.125
date: 2006/11/12 20:00:18;  author: tswift;  state: Exp;  lines: +2 -1


Fixed minor memory leak in WF evaluation.  The ASI structure was not
being deallocated upon abolish_all_tables.  I changed its allocation
to use a structure manager and released it in abolish_all_tables.

This only addresses sequential memory issues.  Tomorrow I intend to
update the MT system to use private WFS structures for private tables
and shared WFS structures for shared tables.  The private WFS
structures will then be released upon thread exit.
----------------------------
revision 1.124
date: 2006/11/09 16:58:34;  author: ruim;  state: Exp;  lines: +11 -1
SET_TRIE_ALLOCATION_TYPE_TIP: I think this would not have worked
for thread private tabled dynamic predicates, so changed to a safer code

TRIE_ASSERT: there's only one structure manager for trie assert,
so had to use SHARED struct manager mode
I also added a lock on trie asserted tries, but as reading is not
protected this is not entirely safe
----------------------------
revision 1.123
date: 2006/11/08 00:25:56;  author: tswift;  state: Exp;  lines: +68 -14
Fixed bug in which several "generations" of abolished tabled
predicates gave a core dump upon GC.  The fix compares the deltf
records in the GC chain to the choice points by finding the
call-trie root of the answer and comparing that root to one saved
in the deltf frame.

A new test in the sequential test suite was also added to ensure
the fix stays around.
----------------------------
revision 1.122
date: 2006/11/06 12:10:10;  author: ruim;  state: Exp;  lines: +6 -1
fix for concurrent completion
----------------------------
revision 1.121
date: 2006/10/13 20:58:42;  author: dwarren;  state: Exp;  lines: +23 -14
All changes for incremental table maintenance:
1. Added filter in call to get changed_goals, so can avoid building huge
   lists of goals that subsequently get ignored.
2. Freed hashtables used in incr when doing abolish all tables.  Closes
   a potentially bad memory leak.
3. Eliminated freekey's call to mem_dealloc.  Turns out we are not allocating
   space for keys at all in hashtables...
----------------------------
revision 1.120
date: 2006/09/11 22:24:14;  author: diptikalyan;  state: Exp;  lines: +6 -4
Changed in get_calls for incremental evaluation.
----------------------------
revision 1.119
date: 2006/09/06 16:05:05;  author: diptikalyan;  state: Exp;  lines: +3 -3
Incremental Bug fixed.
----------------------------
revision 1.118
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +37 -1
Incremental Code Added.
----------------------------
revision 1.117
date: 2006/08/11 16:00:47;  author: dwarren;  state: Exp;  lines: +1 -1
Fixed bug that had used private Sstructure manager deallocate call instead of the
correct shared call.
----------------------------
revision 1.116
date: 2006/07/25 14:18:41;  author: tswift;  state: Exp;  lines: +23 -23

Commented out some fprintfs introduced for debugging.  This should be ready for release now.
----------------------------
revision 1.115
date: 2006/07/24 19:47:43;  author: dwarren;  state: Exp;  lines: +9 -6
Fixed a couple of more cases where a pointer was retrieved from a record AFTER
it was freed.
----------------------------
revision 1.114
date: 2006/06/20 19:16:03;  author: dwarren;  state: Exp;  lines: +3 -3
Fixed bug in accounting for TABLE space, in freeing of freeing_stack.
(Forgot to multiply number of ptrs by length of each.)
----------------------------
revision 1.113
date: 2006/04/27 21:08:47;  author: tswift;  state: Exp;  lines: +4 -1

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.112
date: 2006/04/24 15:41:16;  author: tswift;  state: Exp;  lines: +14 -1

Changes to make lists of delcfs both shared and private, so that space reclamation of dynamic clauses can occur when more than 1 thread is active.

Also, added reclamation of delcf and deltf frames for thread-private predicates upon exit of a thread.
----------------------------
revision 1.111
date: 2006/04/17 20:54:57;  author: tswift;  state: Exp;  lines: +2 -6

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.110
date: 2006/04/07 21:11:11;  author: dwarren;  state: Exp;  lines: +7 -6
Moved some declarations to beginning of block so it would compile under ansi C.
----------------------------
revision 1.109
date: 2006/04/07 17:55:27;  author: ruim;  state: Exp;  lines: +2 -2
removed cast so that mt config compiles under linux
----------------------------
revision 1.108
date: 2006/03/27 14:15:20;  author: tswift;  state: Exp;  lines: +2 -2

Eliminated unnecessary cast that gave problems on some compilers.
----------------------------
revision 1.107
date: 2006/03/27 00:13:54;  author: tswift;  state: Exp;  lines: +353 -28

1) Split DelTF chain into private and shared chains.  This fixed
   a bug with table garbage collection, but also enabled me to
   allow garbage collection of a threads private tables when
   there is more than one active thread.

2) Extended the delay of space reclamation to abolished subgoals,
   and added subgoal reclamation to the table garbage collector.

I also added tests for these: lease update the various test
suites as the gc stuff may be a little brittle.
----------------------------
revision 1.106
date: 2006/03/24 17:13:40;  author: dwarren;  state: Exp;  lines: +5 -2
In MSVC a function cannot be both extern and inline.  So make inline for
abolish_table_info conditioned on not being WIN_NT (except if cygwin.)
----------------------------
revision 1.105
date: 2006/03/24 16:40:29;  author: tswift;  state: Exp;  lines: +21 -14

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.104
date: 2006/03/18 17:37:49;  author: tswift;  state: Exp;  lines: +66 -57
Created two TIF lists: for shared and private tables.  I did this
both to be able to deallocte private TIFs more easily upon thread
exit (this wasn't being done) and also to have a more efficient
abolish_shared/private_tables (which is what got me started on
this).  This will also reduce the need for mutexees in
abolishes... which I've started to remove.

Polished up various abolishes so that they have a consistent
semantics -- see documentation in code (and soon the manual as
well) for their behavior.

Began working on thread-safety for the various features.
Reallocated uses of MUTEX_TABLE: this now handles tif_list,
displatch block lists, tabled_dispatch_block_lists, and deltf
lists.

Added tests for new functionality to the mttest suite.

I'll be working on XSB this weekend, in case I broke anything :-)
----------------------------
revision 1.103
date: 2006/03/17 18:18:00;  author: tswift;  state: Exp;  lines: +442 -93


Some updates to fix bugs in table abolishing and garbage
collecting.  Many of the changes have to do with refactoring code
to make it a little faster as well as to reduce bugs.

In addition, there are associated additional files in the test suite.

I'll be making more changes, and hopefully finishing over the weekend.
----------------------------
revision 1.102
date: 2006/03/15 13:15:57;  author: tswift;  state: Exp;  lines: +14 -21


Introduced two new predicates: abolish_private_tables, and
abolish_shared_tables (CPS check for these predicates is not yet
done).

Fixed bug (I think) for null parent pointer in CPS check.

Adding new test for abolishing tables to testsuite.
----------------------------
revision 1.101
date: 2006/02/27 22:03:46;  author: tswift;  state: Exp;  lines: +14 -4
Some miscellaneous changes

1) abolish_table_pred now emits a warning when the table has a
   leaf node with a delay list -- this could cause dangling
   pointers for dependency checking.  Also, modified an error.

2) trie_interned now throws an exception, rather than exiting on
   an error case.

3) max_threads is now a command-line option

4) Added a new define NON_OPT_COMPILE, and memory mutexes are now
   used only with NON_OPT_COMPILE
----------------------------
revision 1.100
date: 2006/01/12 21:33:52;  author: tswift;  state: Exp;  lines: +13 -4
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.99
date: 2006/01/09 00:06:33;  author: tswift;  state: Exp;  lines: +35 -6
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.98
date: 2005/12/22 23:34:00;  author: tswift;  state: Exp;  lines: +3 -3

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.97
date: 2005/12/07 13:23:02;  author: ruim;  state: Exp;  lines: +3 -3
removed rw lock from tries in Multi-threaded engine
----------------------------
revision 1.96
date: 2005/11/21 22:36:30;  author: dwarren;  state: Exp;  lines: +3 -1
Fixed bug I introduced in abolish_table_pred a couple of weeks ago.
It now works again.
(Also added case to xwam_stats to get delayreg.)
----------------------------
revision 1.95
date: 2005/11/17 23:24:25;  author: tswift;  state: Exp;  lines: +9 -1



Added new mutex, MUTEX_DELAY to synchronize management of de-s
dl-s and pnde-s.  For now, memory management of these data
structures uses common global variables, even in private tables,
hence the need for a mutex.

My placing of the mutexes within the code is still a little
uncertain.  On the one hand, I've over approximated a little so
that (I think) any of the memory management routines are covered.
I've also covered simplification routines (which do not directly
call the mem-management routines), though I'm not entirely
certain that the mutexes are needed there with shared tables and
our algorithm for shared concurrent tables.  More insight on
mutexes and simplification will undoubtedly come with paper
writing.

In addition, we should think in the future about managing de-s,
dl-s and pnde's for private tables using thread-specific memory
management routines.
----------------------------
revision 1.94
date: 2005/11/16 22:34:54;  author: dwarren;  state: Exp;  lines: +2 -2
Minor memory management cleanup, to reduce initial space usage.
----------------------------
revision 1.93
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +23 -23
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.92
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +27 -23
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.91
date: 2005/11/07 20:55:41;  author: dwarren;  state: Exp;  lines: +42 -4
Fixed (for now) abolish_table_call to check for table (note: NOT table-call)
to be in use, and if not, to delete the table-call and reclaim the space.
This fixes a memory leak.
(And added an xwam_stat builtin, to support better debugging from the
Prolog side.  Extensible.)
----------------------------
revision 1.90
date: 2005/10/25 13:35:23;  author: dwarren;  state: Exp;  lines: +14 -9
Check for parent of root pointer of zero to avoid crash.  When fix so
all trie roots point to their subgoal frames, then can remove this test.
----------------------------
revision 1.89
date: 2005/10/15 17:26:39;  author: dwarren;  state: Exp;  lines: +5 -7
Fix a memory leak in trie_delete introduced when making it thread-safe.
----------------------------
revision 1.88
date: 2005/09/29 15:41:01;  author: dwarren;  state: Exp;  lines: +3 -2
Fixed bug in abolishing tables.  If tabled predicate is found in stack, the
table is now deleted semantically so future calls will create a new one.
----------------------------
revision 1.87
date: 2005/09/17 20:32:11;  author: tswift;  state: Exp;  lines: +7 -1

Forgot to free freeing_stack which is allocated within delete_variant_table() but was never freed.  Thus caused a subtle memory leak in the classifier.
----------------------------
revision 1.86
date: 2005/09/16 00:56:41;  author: tswift;  state: Exp;  lines: +8 -2

Changes to make the storage module, which allows backtrackable updates, thread safe.  Storage "objects" (named interned tries) are private to each thread.
----------------------------
revision 1.85
date: 2005/09/13 13:02:05;  author: dwarren;  state: Exp;  lines: +3 -3
Fixed abolish_table_pred to work with private tables in multithreaded
(but there seems to be a memory leak that still needs to be tracked down.)
Also improved documentation of psc fields for tabling and sharedness.
Changed TDispBlk_t type for table dispatch blocks to allow direct coercion
to a TIF (so they agree on the psc and method fields.)
(Also, the load_backsuite test fails on cygwin, for a reason yet to be determined.)
----------------------------
revision 1.84
date: 2005/09/12 18:20:37;  author: tswift;  state: Exp;  lines: +4 -6

Some changes to move some info I put into a threads context into a function, so the info is no longer "global".  Also, fixed interned tries so that they are now thread-local.
----------------------------
revision 1.83
date: 2005/09/12 01:09:33;  author: tswift;  state: Exp;  lines: +54 -26

Tonight's changes were to clean up global data structures used to
clean up tries.  This time I was able to make data structures used in deleting
asserted and interned tries, local to the relevant function.  In addition,
I put into the MT context data structures used to manage an array of interned
tries.

Of course, there's more work to allow asserted and interned tries to be used in multi-threading -- but these changes will hopefully save us from one danger, at least.
----------------------------
revision 1.82
date: 2005/09/11 01:29:39;  author: tswift;  state: Exp;  lines: +12 -6

In tonights exciting installment, I made info about the freeing stack thread specific, since this array is used to deallocate tables.  Its called on thread exit to deallocate private tables, so we'd core dump sooner or later if we kept
freeing_stack as a global.
----------------------------
revision 1.81
date: 2005/09/02 21:17:42;  author: dwarren;  state: Exp;  lines: +8 -5
Variable declarations must be first in a block for ansi C;
Change code to conform.
----------------------------
revision 1.80
date: 2005/09/02 20:43:14;  author: tswift;  state: Exp;  lines: +62 -78

Fix to abolish_table_xxx and gc_tables to work when stacks are frozen;
and made creation of DelTF frames thread-safe.  Also, got a little
further towards reclaiming retracted clauses.

----------------------------------------------------------------------
builtin.c emuloop.c extensions_xsb.h inst_xsb.h CVS: std_cases_xsb_i.h
tr_utils.c xsb_inst_list.h CVS:
----------------------------------------------------------------------
----------------------------
revision 1.79
date: 2005/09/01 18:37:06;  author: tswift;  state: Exp;  lines: +299 -2


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.78
date: 2005/08/28 16:42:28;  author: ruim;  state: Exp;  lines: +5 -1
phase 1 of implementation of concurrent completion
----------------------------
revision 1.77
date: 2005/08/08 17:11:36;  author: dwarren;  state: Exp;  lines: +6 -2
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.76
date: 2005/01/14 18:31:36;  author: ruim;  state: Exp;  lines: +80 -55
Integration of multithreaded system
----------------------------
revision 1.75
date: 2004/09/30 13:22:21;  author: dwarren;  state: Exp;  lines: +4 -4
Refine 64-bit mods (and fix some inconsistencies I introduced yesterday...)
----------------------------
revision 1.74
date: 2004/09/29 21:41:56;  author: dwarren;  state: Exp;  lines: +4 -4
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.73
date: 2004/05/06 13:35:10;  author: dwarren;  state: Exp;  lines: +9 -7
Add short-circuit to try to spead up abolish_table_pred when table is already empty.
----------------------------
revision 1.72
date: 2004/01/14 20:27:13;  author: dwarren;  state: Exp;  lines: +21 -32
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.71
date: 2002/10/28 15:28:50;  author: lfcastro;  state: Exp;  lines: +2 -2
* fix an xsb_dbgmsg call that was introduced with the old syntax.
----------------------------
revision 1.70
date: 2002/10/18 04:43:00;  author: kifer;  state: Exp;  lines: +10 -3
a debug msg was incorrectly issued as a warning
----------------------------
revision 1.69
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +19 -19
branches:  1.69.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.68
date: 2002/05/22 15:41:17;  author: lfcastro;  state: Exp;  lines: +21 -35
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.67
date: 2002/03/12 17:31:21;  author: lfcastro;  state: Exp;  lines: +2 -38
* Removal of Chat engine
----------------------------
revision 1.66
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +4 -29
branches:  1.66.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.65
date: 2001/08/13 04:31:35;  author: kifer;  state: Exp;  lines: +9 -7
added builtin to optimize the storage.P module
----------------------------
revision 1.64
date: 2001/07/16 05:17:34;  author: kifer;  state: Exp;  lines: +14 -3
replaced error msgs with debug msgs
----------------------------
revision 1.63
date: 2001/05/07 02:17:29;  author: kifer;  state: Exp;  lines: +6 -1
added comments
----------------------------
revision 1.62
date: 2001/05/05 18:23:02;  author: kifer;  state: Exp;  lines: +13 -4
bug fixes in storage management.
----------------------------
revision 1.61
date: 2001/04/28 20:15:37;  author: ejohnson;  state: Exp;  lines: +3 -3
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.60
date: 2001/01/07 04:07:32;  author: kifer;  state: Exp;  lines: +11 -4
insertLeaf: don't issue warnings if deleting a valid node.
----------------------------
revision 1.59
date: 2000/12/28 04:15:27;  author: kifer;  state: Exp;  lines: +2 -2
message wording fix
----------------------------
revision 1.58
date: 2000/12/13 16:36:38;  author: tswift;  state: Exp;  lines: +5 -2

Change added to delete_return so that negation-failure simplification
is properly performed.
----------------------------
revision 1.57
date: 2000/12/04 17:10:43;  author: ejohnson;  state: Exp;  lines: +35 -16
Added support for subsumption-based LRD stratified negation,
including:

o Modification of 't not'/1 to accept all predicates.

o Replacement of predicate get_producer_subgoal_frame/2 with a new
  predicate get_producer_call/3 (ala get_call/3 and friends) to take
  the subgoal and perform a tabling-strategy-dependent lookup,
  returning a producer's subgoal frame and an answer template with
  respect to that producer.

  get_producer_call/3 aborts if given a non-tabled predicate and fails
  if the tabled predicate hasn't been called before.

o Modification of slg_not/1 s.t. it takes two extra arguments: the
  first is the answer template from get_producer_call/3, used by
  negated, properly subsumed predicates for relevant-answer
  collection; the second contains the subgoal which is negated, used
  only for error reporting.

o Extension of certain C functions, e.g. get_variant_sf() and
  get_subsumer_sf() to build and return, in an extra argument, the
  answer template.
----------------------------
revision 1.56
date: 2000/10/05 17:23:18;  author: ejohnson;  state: Exp;  lines: +17 -5
branches:  1.56.2;
Added two more structure tests to Structure Manager code:
- smIsAllocatedStruct(SM,struct) checks whether a known valid struct is
    currently allocated wrt its SM.
- smIsAllocatedStructRef(SM,struct) combines the functionality of
    smIsValidStructRef() and smIsAllocatedStruct().
Also changed argument passing style of SM from pass-by-ref to pass-by value.

Added extra checks to TRIE_DELETE_RETURN builtin to ensure that (1)
leaf node is currently allocated, (2) that it is in fact a leaf, and
(3) that it appears in the answer set associated with the given
subgoal frame.
----------------------------
revision 1.55
date: 2000/09/28 21:31:04;  author: ejohnson;  state: Exp;  lines: +31 -8
Two subsumption-related changes:

(1) Support for incomplete subsumptive subgoals in tfindall/3.
    Two builtins needed modification:
    -- get_subgoal_ptr/2 ==> get_producer_subgoal_frame/2
         Now handles both variant and subsumptive subgoals, returning
	 the producing table entry.
    -- is_incomplete/4 ==> is_incomplete/2
         Now handles both variant and subsumptive subgoals.  Used to
	 encompass some of the functionality of get_subgoal_ptr/2, but
	 since the processing performed by that builtin is more complex,
	 this (partial) functionality is removed.

(2) Standard predicate delete_return/2 produces an error when invoked
    on a subsumptive table entry.
----------------------------
revision 1.54
date: 2000/09/27 22:09:06;  author: lfcastro;  state: Exp;  lines: +19 -2
* Bugfix: when deleting answers, simplify conditional answers which
depend on this one.
----------------------------
revision 1.53
date: 2000/07/31 20:27:57;  author: ejohnson;  state: Exp;  lines: +9 -4
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.52
date: 2000/07/18 10:49:10;  author: ruim;  state: Exp;  lines: +3 -3
added extern C to system_xsb.h and cast to tr_utils.h
----------------------------
revision 1.51
date: 2000/07/14 16:19:13;  author: lfcastro;  state: Exp;  lines: +21 -5
* get_delay_lists is now obsolete (not exported anymore), and should
be substituted by get_returns_and_dls in user applications; this is in
order to hide erroneous dependencies between get_returns and
get_delay_lists from the user

* delete_return now eagerly reclaims space for deleted trie nodes; in
order to enforce that no choicepoints keep pointers to deleted answer
list nodes, the CP stack is inspected (in CHAT); before, only
choicepoints in the CHAT area were updated, and some choicepoints in
the stack could still have invalid pointers (this happened in
empty_answer.P, in the testsuite)
----------------------------
revision 1.50
date: 2000/06/28 16:54:53;  author: ruim;  state: Exp;  lines: +4 -4
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.49
date: 2000/06/28 14:27:46;  author: ruim;  state: Exp;  lines: +6 -6
Changed variable name n to is_new
----------------------------
revision 1.48
date: 2000/06/28 06:42:52;  author: kifer;  state: Exp;  lines: +193 -7
incorporated Prasad's reclaim_uninterned_nr builtin.
----------------------------
revision 1.47
date: 2000/06/26 19:09:27;  author: ruim;  state: Exp;  lines: +9 -9
Getting XSB to compile under g++ AGAIN
----------------------------
revision 1.46
date: 2000/06/25 16:59:16;  author: ejohnson;  state: Exp;  lines: +32 -535
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.45
date: 2000/06/22 01:27:52;  author: lfcastro;  state: Exp;  lines: +21 -19
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.44
date: 2000/06/19 07:02:25;  author: ruim;  state: Exp;  lines: +9 -9
Changed variable names from C++ keywords template and new.
----------------------------
revision 1.43
date: 2000/06/17 23:26:13;  author: kifer;  state: Exp;  lines: +42 -41
fixed bugs having to do with trie_retract_nr
----------------------------
revision 1.42
date: 2000/06/14 21:16:05;  author: kifer;  state: Exp;  lines: +8 -1
Added builtin stub for reclaim_uninterned_nr/trie_reclaim_uninterned_nr.
----------------------------
revision 1.41
date: 2000/05/29 04:23:39;  author: ejohnson;  state: Exp;  lines: +12 -12
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.40
date: 2000/05/25 00:32:03;  author: ejohnson;  state: Exp;  lines: +16 -16
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.39
date: 2000/05/20 06:56:11;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.38
date: 2000/05/12 20:18:16;  author: ejohnson;  state: Exp;  lines: +2 -1
Fix for builtins abolish_all_tables and abolish_table_pred.
Checks that the subgoals are (marked as) complete before destroying
the tables.

Other supporting changes:

Added a field in TableInfoFrames (TIF) for maintaining references to
the subgoals according to predicate, rather than one global list.
Routines which walked this list had to be appropriately modified.

Discovered that TIFs weren't being counted in memory usage, so changed
their allocation to use mem_alloc() instead of malloc().

Moved the code which places a TIF on the alloc chain, maintained
through `first_tip' and `last_tip', into macro New_TIF().
Removed this code from biassert.c and loader_xsb.c.

Made a structure out of `first_tip' and `last_tip'.  Added an extern
for this structure to macro_xsb.h, and hence removed the externs from
biassert.c and builtin.c.  Modified references appropriately.

Producer subgoal frame allocation now puts the SF into the predicate's
TIF.
----------------------------
revision 1.37
date: 2000/04/29 21:54:00;  author: kifer;  state: Exp;  lines: +18 -18
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.36
date: 2000/01/25 04:00:43;  author: cbaoqiu;  state: Exp;  lines: +3 -3
branches:  1.36.2;
Correctly set the value of Nvars: filter out the number of attributed
variables.
----------------------------
revision 1.35
date: 2000/01/11 17:19:08;  author: ejohnson;  state: Exp;  lines: +421 -22
Added support for subsumptive predicates/tables in two builtins:
table_state and abolish_table_pred.  This included 1) a routine for
performing a subsumptive goal lookup in a table, plus modification of
builtin code to interpret the results (this is practically rewritten),
and 2) a set of routines for deleting portions of subsumptive tables.
----------------------------
revision 1.34
date: 2000/01/10 18:30:23;  author: warren;  state: Exp;  lines: +120 -27
made delete_trie use an explicit auto-expanding stack instead of
recursion, so it could delete a LARGE trie.
----------------------------
revision 1.33
date: 2000/01/07 08:51:59;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.32
date: 1999/12/22 18:07:10;  author: warren;  state: Exp;  lines: +4 -4
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.31
date: 1999/12/14 20:57:33;  author: ejohnson;  state: Exp;  lines: +217 -184
Replaced/rewrote function variant_call_lookup() with a more general
function trie_lookup().  The number of globals this function depends
on is decreased, and it conditionally places collected variables into
an array supplied by the caller.  This allowed for the merging of
multiple ret/N construction functions found in tr_utils.c and tries.c.

The result of the merge was the function build_ret_term() which
replaced construct_ret_for_call() that was contained in this file.

construct_answer_template() is added for computing the answer template
of a properly subsumed goal.

Return type of get_subgoal_ptr() is now the expected SGFrame.

get_call() implements the builtin with the same name.
----------------------------
revision 1.30
date: 1999/12/10 07:47:41;  author: kifer;  state: Exp;  lines: +6 -3
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.29
date: 1999/10/26 06:47:31;  author: kifer;  state: Exp;  lines: +6 -6
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.28
date: 1999/10/25 12:02:30;  author: kostis;  state: Exp;  lines: +4 -4
Minor change.
----------------------------
revision 1.27
date: 1999/10/25 05:59:51;  author: kifer;  state: Exp;  lines: +6 -6
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.26
date: 1999/10/18 21:50:12;  author: cbaoqiu;  state: Exp;  lines: +4 -4
1) Renamed CallVarEnum back to VarEnumerator (after a long discussion
   with Ernie);
2) Renamed IndexOfStandardizedVariable to IndexOfStdVar;
3) Added more changes for attributed variables (around variant_call_search).
----------------------------
revision 1.25
date: 1999/10/13 14:11:29;  author: ejohnson;  state: Exp;  lines: +16 -33
Modified use of a few macros.

Removed answer list node deallocation routine.  This function is now
subsumed by table_complete_entry() which reclaims all superfluous
space from a table entry after completion (parts of the TST
representing the answer set, and answer list nodes from this set as
well as from the call's properly subsumed subgoals.
----------------------------
revision 1.24
date: 1999/10/05 04:01:57;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.23
date: 1999/08/16 07:24:38;  author: kifer;  state: Exp;  lines: +7 -8
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.22
date: 1999/08/04 14:42:09;  author: ejohnson;  state: Exp;  lines: +5 -5
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.21
date: 1999/07/15 21:41:20;  author: ejohnson;  state: Exp;  lines: +65 -78
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.20
date: 1999/07/06 16:35:19;  author: ejohnson;  state: Exp;  lines: +392 -313
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.19
date: 1999/05/20 17:57:37;  author: kostis;  state: Exp;  lines: +1 -2
Change to bypass warning.
----------------------------
revision 1.18
date: 1999/05/20 12:41:36;  author: warren;  state: Exp;  lines: +5 -10
Fixed problem in creating ret structure for returning the substitution
factor, by dereffing the components. (one more case)
----------------------------
revision 1.17
date: 1999/05/19 19:48:56;  author: warren;  state: Exp;  lines: +17 -4
Fixed problem in creating ret structure for returning the substitution
factor, by dereffing the components.
----------------------------
revision 1.16
date: 1999/04/17 05:01:30;  author: kifer;  state: Exp;  lines: +8 -2
Documented breg-retskel (somewhat)
----------------------------
revision 1.15
date: 1999/04/16 04:10:43;  author: kifer;  state: Exp;  lines: +3 -3
Minor changes to pacify non-gcc compilers.
----------------------------
revision 1.14
date: 1999/04/13 17:24:49;  author: kostis;  state: Exp;  lines: +3 -20
Performed major clean-up and rationalization of the tabling builtins.
----------------------------
revision 1.13
date: 1999/03/27 09:33:09;  author: workflow;  state: Exp;  lines: +2 -2

additional file functions and is_deleted(X) macro defn fixes
----------------------------
revision 1.12
date: 1999/02/23 10:50:43;  author: kostis;  state: Exp;  lines: +2 -2
Changes to tag number of substitution factor variables in the CP stack and
to considerably speed up garbage collection - many changes in heap.c.
----------------------------
revision 1.11
date: 1999/02/22 16:56:55;  author: workflow;  state: Exp;  lines: +20 -2
nr stuff
----------------------------
revision 1.10
date: 1999/02/03 16:07:15;  author: workflow;  state: Exp;  lines: +2 -20
rollback.
rollback
----------------------------
revision 1.9
date: 1999/02/03 11:14:19;  author: workflow;  state: Exp;  lines: +20 -2
*** empty log message ***
----------------------------
revision 1.8
date: 1999/01/31 14:02:22;  author: kostis;  state: Exp;  lines: +2 -1
Mostly cleanup changes to simplify "tries.h".  Lots of junk code has been
removed and things that are not needed in other files have been moved to
"tries.c".
----------------------------
revision 1.7
date: 1999/01/29 04:18:30;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Changed string_find("ret", 1) to ret_psc[0].  ret_psc[0] is set at the
time when the system is started.
----------------------------
revision 1.6
date: 1999/01/27 19:46:01;  author: kostis;  state: Exp;  lines: +6 -5
Changes to fix segmentation faults on 64-bit machines.
----------------------------
revision 1.5
date: 1999/01/24 17:07:48;  author: kostis;  state: Exp;  lines: +17 -18
Rectified type definitions in delete_branch().
----------------------------
revision 1.4
date: 1999/01/12 05:32:59;  author: cbaoqiu;  state: Exp;  lines: +54 -34
Changed function newtrie() and trie_interned() because now deleted
sets are collected into the free set list.  Function
clear_interned_tries() is removed since it is not used anywhere.
----------------------------
revision 1.3
date: 1998/12/22 15:48:43;  author: kostis;  state: Exp;  lines: +44 -27
Changes related to moving breg_skel() completely down to C and
making it work with CHAT which stores the substitution factor
of generatr choice points in the heap instead of the choice point
stack.
----------------------------
revision 1.2
date: 1998/12/21 01:09:02;  author: cbaoqiu;  state: Exp;  lines: +251 -213
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.36.2.2
date: 2000/09/13 18:41:13;  author: lfcastro;  state: Exp;  lines: +1 -3
Changes:

*Makefile
	- create target for 'make etags'

*emu/binding.h
	- got rid of #ifdef's on WAM_TRAIL

*emu/chat.c
	- commented out a switch_envs(breg) in
	  chat_restore_compl_susp_trail
	- introduced function chat_free_cp_compl_susp_chat_areas
	  needed for bugfix in cut_xsb.h
	- change in restore_answer_template

*emu/cut_xsb.h
	- bugfix in check_table_cut

*lib/Makefile
	- put '-g none' in calls to XSB to be able to compile when GC
	  isn't working

*general
	- changes/introduction in/of debug messages

Status:
Passes the testsuite for all tests, except for the gctests with the
copying collector, which fails for tests wfs_tests/p53 (and up).
----------------------------
revision 1.36.2.1
date: 2000/03/28 18:10:33;  author: lfcastro;  state: Exp;  lines: +4 -44
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.56.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.56.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +41 -3
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.66.2.7
date: 2004/12/14 08:47:05;  author: ruim;  state: Exp;  lines: +4 -4
added dynamic stacks to thread context
----------------------------
revision 1.66.2.6
date: 2004/11/24 21:53:26;  author: ruim;  state: Exp;  lines: +20 -20
made smBTHT and smBTN thread specific
----------------------------
revision 1.66.2.5
date: 2004/11/24 16:45:32;  author: ruim;  state: Exp;  lines: +21 -1
add trie unlock choice point in trie_get_returns and trie_interned
----------------------------
revision 1.66.2.4
date: 2004/11/22 23:07:35;  author: ruim;  state: Exp;  lines: +4 -4
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.66.2.3
date: 2004/11/22 16:36:31;  author: ruim;  state: Exp;  lines: +2 -1
added lock on struct manager
----------------------------
revision 1.66.2.2
date: 2004/10/18 20:46:13;  author: ruim;  state: Exp;  lines: +32 -75
update for version 2.6.1
----------------------------
revision 1.66.2.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +33 -30
Sources from rfm repository
----------------------------
revision 1.69.2.8
date: 2003/04/17 17:11:36;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.69.2.7
date: 2002/10/28 16:49:33;  author: lfcastro;  state: Exp;  lines: +12 -5
* Merge with HEAD
----------------------------
revision 1.69.2.6
date: 2002/08/29 14:48:35;  author: lfcastro;  state: Exp;  lines: +7 -9
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.69.2.5
date: 2002/08/29 14:17:13;  author: lfcastro;  state: Exp;  lines: +0 -38
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.69.2.4
date: 2002/08/10 00:19:35;  author: lfcastro;  state: Exp;  lines: +9 -7
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.69.2.3
date: 2002/08/08 12:53:18;  author: lfcastro;  state: Exp;  lines: +41 -3
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.69.2.2
date: 2002/08/07 17:53:29;  author: lfcastro;  state: Exp;  lines: +4 -42
* update to HEAD
----------------------------
revision 1.69.2.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +42 -4
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.192.2.4
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.192.2.3
date: 2010/06/24 21:04:44;  author: spyrosh;  state: Exp;  lines: +1 -0
no message
----------------------------
revision 1.192.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +129 -1
no message
----------------------------
revision 1.192.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tr_utils.h,v
Working file: tr_utils.h
head: 1.75
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.65
	ROLLBACK: 1.59
	latest_plus_supp_branch: 1.55.0.2
	latest_plus_supp: 1.55
	Version_3dot2_plus_supp: 1.52.0.2
	release_2_6_plus_supp: 1.27.0.4
	Version_3dot2: 1.52
	dec07-perf-results: 1.48
	mt_thesis: 1.42
	release_3_0: 1.40
	release_2_7_0: 1.28
	multi-threaded-26-engine: 1.26.6.4
	pre-mt: 1.28
	multi-threaded-25-engine-done: 1.26.6.1
	multi-threaded-25-engine: 1.26.0.6
	release_2_6_1: 1.27
	release_2_6_final: 1.27
	release_2_6: 1.27.0.2
	last-merged-to-demand: 1.26
	demand_branch: 1.26.0.4
	before_removing_chat: 1.26
	release_2_5: 1.26
	pre-merge-slgwam-gc: 1.26
	multi-threaded-c-engine: 1.26.0.2
	release_2_4: 1.25
	release_2_3: 1.25
	multi-threaded-engine: 1.24.0.2
	pre-threading: 1.20
	release-2-2: 1.16
	chat-and-local: 1.16.0.2
	xsb-pre-cleanup: 1.16
	release-2-1: 1.14
	release-2-0-1: 1.14
	subsumption: 1.13
	without-attv: 1.12
	release-2-0: 1.9
	pre-release-2-0: 1.9
	v1-9-8: 1.7
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 89;	selected revisions: 89
description:
----------------------------
revision 1.75
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +3 -1

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.74
date: 2011/11/12 00:33:31;  author: tswift;  state: Exp;  lines: +3 -3

Added depth check for interned tries -- use tabled answer depth /
action flags.
----------------------------
revision 1.73
date: 2011/10/29 23:27:59;  author: tswift;  state: Exp;  lines: +15 -1

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.72
date: 2011/08/19 18:26:30;  author: tswift;  state: Exp;  lines: +2 -1

Changes to support Ctrace (Fview).
----------------------------
revision 1.71
date: 2011/08/06 19:14:20;  author: tswift;  state: Exp;  lines: +2 -2
changes to handle table overflow gracefully, and more consistent usage of resource error (for which the handler is now different)
----------------------------
revision 1.70
date: 2011/06/22 21:27:53;  author: tswift;  state: Exp;  lines: +3 -1

Now maintaining gc time for abolishing tables -- this way I can tell
if my heuristics are out of whack for some program.
----------------------------
revision 1.69
date: 2011/06/02 22:29:23;  author: tswift;  state: Exp;  lines: +7 -1
Changes	to add stack expansion so that arbitrary numbers of
variables are allowed in interned, asserted tries and tables.

This uncovered a bug.

The problem arose when a conditional answer is interned in the
answer trie and that conditional answer contains variables both
in the answer head and the delay list, and there are variables in
the answer head that are not in the delay list. What happened was
that when the variables were interned in delay_trie_chk_insert,
the mini-trail that the trie routines use for standardizing
variables was reset.  This meant that the variables in the answer
head were not being properly untrailed and, due to the particular
way that variables are standardized, variables were bound to each
other that shouldn't have been, and in this case a circular
dereferencing chain arose, so that XSB hung.  I have no idea why
the bug was uncovered just now.
----------------------------
revision 1.68
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.67
date: 2011/01/09 22:30:16;  author: tswift;  state: Exp;  lines: +3 -1

Minor code cleanup: some changes in documentation, changes to make a
function name accord with a builtin name, and moved some table
abolishing routines from tries.c to tr_utils.c with all the others.
----------------------------
revision 1.66
date: 2010/11/28 23:14:14;  author: tswift;  state: Exp;  lines: +3 -1

Added counts of abolishes to statistics (if there have been any).
Also added a count of the number of incomplete tables (if there are any).
----------------------------
revision 1.65
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -3
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.64
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.63
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.62
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.61
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.60
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +3 -1
no message
----------------------------
revision 1.59
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.58
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.57
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +0 -2
Backed out code
----------------------------
revision 1.56
date: 2010/06/19 19:10:12;  author: spyrosh;  state: Exp;  lines: +3 -1
no message
----------------------------
revision 1.55
date: 2010/04/24 20:50:43;  author: tswift;  state: Exp;  lines: +3 -1
branches:  1.55.2;

Changes for incremental tabling based on tries.
----------------------------
revision 1.54
date: 2009/09/07 21:08:04;  author: tswift;  state: Exp;  lines: +5 -1

Implemented abolish_table_call for subsumptive predicates.
----------------------------
revision 1.53
date: 2009/03/29 21:40:10;  author: tswift;  state: Exp;  lines: +3 -1
Changes to allow max_tries as a command-line option.
----------------------------
revision 1.52
date: 2009/01/10 23:37:07;  author: tswift;  state: Exp;  lines: +2 -2

Extended (almost) all the marking routines for tabled predicates
so that subgoals in the heap delay list are checked.  This rather
obscure bug caused a crash in a Flora program for defeasible
logic.  I'll try to finish that part tomorrow.

The problem was that space was reclaimed for a table T that had a
delay element in the heap pointing to it.  When the answer with
the delay element was added, the engine tried to adjust the
backpointers for T and crashed.

Also made some minor ajustments for efficency to some of the
marking functions.  And I changed abolish_table_info to the
clearer abolish_all_tables.
----------------------------
revision 1.51
date: 2009/01/02 17:50:03;  author: tswift;  state: Exp;  lines: +4 -4


Updating a number of files so that delete_branch() will work with call
subsumption (it needs to know that it deallocates BTNs rather than
TSTNs).  This fixed a latent bug in simplification and allows another
test to be run for call subsumption. It also provides a step towards
supporting answer subsumption on call subsumptive tables.  There are
also some other documentationstyle changes.

Adding a new test for copying attributed variables into delay elements
/ lists.  I hadn't thought this worked, but apparently it does !

Also, I'm adding a very simple test for incremental evaluation -- more
cases need to be added here, but at least this is a start.
----------------------------
revision 1.50
date: 2008/01/02 14:52:30;  author: dwarren;  state: Exp;  lines: +2 -1
Add a declaration of trie_drop to eliminate warning.
----------------------------
revision 1.49
date: 2007/12/24 19:17:00;  author: tswift;  state: Exp;  lines: +36 -8

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.48
date: 2007/11/20 19:17:21;  author: tswift;  state: Exp;  lines: +5 -2


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.47
date: 2007/11/04 22:31:45;  author: tswift;  state: Exp;  lines: +2 -2

Minor refactoring before major refactorings later.  Took
initialization of global variables for SLGWAM instructions out of
thread initialiation and put it into system initialization, where it
should be.
----------------------------
revision 1.46
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +12 -7

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.45
date: 2007/06/01 22:47:10;  author: tswift;  state: Exp;  lines: +18 -9

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.44
date: 2007/04/05 17:26:57;  author: tswift;  state: Exp;  lines: +3 -1
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.43
date: 2007/02/22 00:16:06;  author: tswift;  state: Exp;  lines: +6 -2


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.42
date: 2006/12/07 00:26:45;  author: tswift;  state: Exp;  lines: +3 -1

-- Added reclamation of conditional answer information (including
   subgoal PNDEs and delay tries) when variant predicates/subgoals are
   abolished in abolish_table_pred/1, abolish_table_call/1, and
   close_open_tables/0.  Also, wrote delete_delay_trie() to delete
   answer substitution factor for delay elements, and made sure this
   was used whenever des are reclaimed -- (e.g. by abolishes and
   simplifications).

-- fixed some bugs in MT engine where situations could arise where
   trie allocation type was not properly set before abolishes called
   in table gc sweeps or reloading tabled predicates.

-- Fixed numerous bugs in performing simplification in the MT engine.
   In general simplification routines may reclaim structures for delay
   lists, delay elements, answer branches, asis and pndes.  Whenever
   any of these structures are reclaimed in the MT engine a check must
   be made to determine whether these elements use private or shared
   memory management -- either struture managers or the managers for
   des/dls/pndes.  Keeping all of this straight required some thinking
   as the code flits from table to table by traversing pndes --
   however I think I was able to extend the code without undue mess
   (at least this time :-)
----------------------------
revision 1.41
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +2 -1
Incremental Code Added.
----------------------------
revision 1.40
date: 2006/04/27 21:08:48;  author: tswift;  state: Exp;  lines: +2 -1

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.39
date: 2006/04/17 20:54:58;  author: tswift;  state: Exp;  lines: +2 -1

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.38
date: 2006/03/27 00:13:54;  author: tswift;  state: Exp;  lines: +7 -1

1) Split DelTF chain into private and shared chains.  This fixed
   a bug with table garbage collection, but also enabled me to
   allow garbage collection of a threads private tables when
   there is more than one active thread.

2) Extended the delay of space reclamation to abolished subgoals,
   and added subgoal reclamation to the table garbage collector.

I also added tests for these: lease update the various test
suites as the gc stuff may be a little brittle.
----------------------------
revision 1.37
date: 2006/03/24 16:40:29;  author: tswift;  state: Exp;  lines: +2 -18

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.36
date: 2006/03/17 18:18:00;  author: tswift;  state: Exp;  lines: +3 -2


Some updates to fix bugs in table abolishing and garbage
collecting.  Many of the changes have to do with refactoring code
to make it a little faster as well as to reduce bugs.

In addition, there are associated additional files in the test suite.

I'll be making more changes, and hopefully finishing over the weekend.
----------------------------
revision 1.35
date: 2006/01/24 14:10:01;  author: tswift;  state: Exp;  lines: +2 -2

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.34
date: 2005/12/22 23:34:00;  author: tswift;  state: Exp;  lines: +2 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.33
date: 2005/10/03 13:26:44;  author: tswift;  state: Exp;  lines: +1 -7


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.32
date: 2005/09/12 01:09:33;  author: tswift;  state: Exp;  lines: +4 -3

Tonight's changes were to clean up global data structures used to
clean up tries.  This time I was able to make data structures used in deleting
asserted and interned tries, local to the relevant function.  In addition,
I put into the MT context data structures used to manage an array of interned
tries.

Of course, there's more work to allow asserted and interned tries to be used in multi-threading -- but these changes will hopefully save us from one danger, at least.
----------------------------
revision 1.31
date: 2005/09/11 01:29:39;  author: tswift;  state: Exp;  lines: +5 -1

In tonights exciting installment, I made info about the freeing stack thread specific, since this array is used to deallocate tables.  Its called on thread exit to deallocate private tables, so we'd core dump sooner or later if we kept
freeing_stack as a global.
----------------------------
revision 1.30
date: 2005/09/01 18:37:07;  author: tswift;  state: Exp;  lines: +6 -1


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.29
date: 2005/01/14 18:31:37;  author: ruim;  state: Exp;  lines: +19 -17
Integration of multithreaded system
----------------------------
revision 1.28
date: 2004/09/29 21:41:56;  author: dwarren;  state: Exp;  lines: +2 -2
Changes for 64-bit port.  Mostly int's to Integer's.
One substantive fix to throw for 64-bits.
----------------------------
revision 1.27
date: 2002/10/04 20:42:02;  author: lfcastro;  state: Exp;  lines: +5 -1
* several fixes to better handle boxed-integerized addresses
	- buffer mgmt builtins: s/ptoc_string/ptoc_int/
	- delay lists now tag pointers as strings instead of ints
	- simplification of tagging of integers on LINUX_ELF & BIG_MEM
	- isinteger/1 builtin now handles boxed integers

* inclusion of guards on several .h files
----------------------------
revision 1.26
date: 2001/08/13 04:31:35;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.26.4;  1.26.6;
added builtin to optimize the storage.P module
----------------------------
revision 1.25
date: 2000/12/04 17:10:43;  author: ejohnson;  state: Exp;  lines: +3 -3
Added support for subsumption-based LRD stratified negation,
including:

o Modification of 't not'/1 to accept all predicates.

o Replacement of predicate get_producer_subgoal_frame/2 with a new
  predicate get_producer_call/3 (ala get_call/3 and friends) to take
  the subgoal and perform a tabling-strategy-dependent lookup,
  returning a producer's subgoal frame and an answer template with
  respect to that producer.

  get_producer_call/3 aborts if given a non-tabled predicate and fails
  if the tabled predicate hasn't been called before.

o Modification of slg_not/1 s.t. it takes two extra arguments: the
  first is the answer template from get_producer_call/3, used by
  negated, properly subsumed predicates for relevant-answer
  collection; the second contains the subgoal which is negated, used
  only for error reporting.

o Extension of certain C functions, e.g. get_variant_sf() and
  get_subsumer_sf() to build and return, in an extra argument, the
  answer template.
----------------------------
revision 1.24
date: 2000/10/05 17:23:19;  author: ejohnson;  state: Exp;  lines: +2 -1
branches:  1.24.2;
Added two more structure tests to Structure Manager code:
- smIsAllocatedStruct(SM,struct) checks whether a known valid struct is
    currently allocated wrt its SM.
- smIsAllocatedStructRef(SM,struct) combines the functionality of
    smIsValidStructRef() and smIsAllocatedStruct().
Also changed argument passing style of SM from pass-by-ref to pass-by value.

Added extra checks to TRIE_DELETE_RETURN builtin to ensure that (1)
leaf node is currently allocated, (2) that it is in fact a leaf, and
(3) that it appears in the answer set associated with the given
subgoal frame.
----------------------------
revision 1.23
date: 2000/09/28 21:31:05;  author: ejohnson;  state: Exp;  lines: +3 -2
Two subsumption-related changes:

(1) Support for incomplete subsumptive subgoals in tfindall/3.
    Two builtins needed modification:
    -- get_subgoal_ptr/2 ==> get_producer_subgoal_frame/2
         Now handles both variant and subsumptive subgoals, returning
	 the producing table entry.
    -- is_incomplete/4 ==> is_incomplete/2
         Now handles both variant and subsumptive subgoals.  Used to
	 encompass some of the functionality of get_subgoal_ptr/2, but
	 since the processing performed by that builtin is more complex,
	 this (partial) functionality is removed.

(2) Standard predicate delete_return/2 produces an error when invoked
    on a subsumptive table entry.
----------------------------
revision 1.22
date: 2000/06/28 06:42:52;  author: kifer;  state: Exp;  lines: +20 -3
incorporated Prasad's reclaim_uninterned_nr builtin.
----------------------------
revision 1.21
date: 2000/06/25 16:59:17;  author: ejohnson;  state: Exp;  lines: +1 -8
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.20
date: 2000/06/14 21:16:05;  author: kifer;  state: Exp;  lines: +2 -1
Added builtin stub for reclaim_uninterned_nr/trie_reclaim_uninterned_nr.
----------------------------
revision 1.19
date: 2000/05/29 04:23:39;  author: ejohnson;  state: Exp;  lines: +7 -7
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.18
date: 2000/05/25 00:32:03;  author: ejohnson;  state: Exp;  lines: +2 -2
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.17
date: 2000/04/29 21:54:00;  author: kifer;  state: Exp;  lines: +3 -3
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.16
date: 2000/01/11 17:19:09;  author: ejohnson;  state: Exp;  lines: +9 -2
Added support for subsumptive predicates/tables in two builtins:
table_state and abolish_table_pred.  This included 1) a routine for
performing a subsumptive goal lookup in a table, plus modification of
builtin code to interpret the results (this is practically rewritten),
and 2) a set of routines for deleting portions of subsumptive tables.
----------------------------
revision 1.15
date: 1999/12/14 20:57:34;  author: ejohnson;  state: Exp;  lines: +5 -3
Replaced/rewrote function variant_call_lookup() with a more general
function trie_lookup().  The number of globals this function depends
on is decreased, and it conditionally places collected variables into
an array supplied by the caller.  This allowed for the merging of
multiple ret/N construction functions found in tr_utils.c and tries.c.

The result of the merge was the function build_ret_term() which
replaced construct_ret_for_call() that was contained in this file.

construct_answer_template() is added for computing the answer template
of a properly subsumed goal.

Return type of get_subgoal_ptr() is now the expected SGFrame.

get_call() implements the builtin with the same name.
----------------------------
revision 1.14
date: 1999/10/26 20:31:34;  author: warren;  state: Exp;  lines: +3 -1
Added check to cut to abort if cutting over a table.
----------------------------
revision 1.13
date: 1999/10/13 14:12:51;  author: ejohnson;  state: Exp;  lines: +1 -2
Removed prototype of answer list node deallocation routine.
----------------------------
revision 1.12
date: 1999/08/04 14:42:10;  author: ejohnson;  state: Exp;  lines: +2 -2
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.11
date: 1999/07/15 21:41:21;  author: ejohnson;  state: Exp;  lines: +3 -5
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.10
date: 1999/07/06 16:35:20;  author: ejohnson;  state: Exp;  lines: +9 -11
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.9
date: 1999/04/13 17:24:51;  author: kostis;  state: Exp;  lines: +2 -3
Performed major clean-up and rationalization of the tabling builtins.
----------------------------
revision 1.8
date: 1999/02/22 16:56:56;  author: workflow;  state: Exp;  lines: +2 -1
nr stuff
----------------------------
revision 1.7
date: 1999/02/03 16:07:18;  author: workflow;  state: Exp;  lines: +1 -2
rollback.
rollback
----------------------------
revision 1.6
date: 1999/02/03 11:14:21;  author: workflow;  state: Exp;  lines: +2 -1
*** empty log message ***
----------------------------
revision 1.5
date: 1999/01/24 17:07:50;  author: kostis;  state: Exp;  lines: +3 -3
Rectified type definitions in delete_branch().
----------------------------
revision 1.4
date: 1999/01/12 05:34:43;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Removed the line 'extern clear_interned_tries() ...', and declared
variable first_free_set extern.
----------------------------
revision 1.3
date: 1998/12/22 15:48:48;  author: kostis;  state: Exp;  lines: +2 -2
Changes related to moving breg_skel() completely down to C and
making it work with CHAT which stores the substitution factor
of generatr choice points in the heap instead of the choice point
stack.
----------------------------
revision 1.2
date: 1998/12/21 01:09:04;  author: cbaoqiu;  state: Exp;  lines: +10 -11
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.24.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.24.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.26.6.4
date: 2004/12/14 08:47:06;  author: ruim;  state: Exp;  lines: +2 -2
added dynamic stacks to thread context
----------------------------
revision 1.26.6.3
date: 2004/11/24 21:53:27;  author: ruim;  state: Exp;  lines: +7 -7
made smBTHT and smBTN thread specific
----------------------------
revision 1.26.6.2
date: 2004/10/18 20:46:21;  author: ruim;  state: Exp;  lines: +6 -1
update for version 2.6.1
----------------------------
revision 1.26.6.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +11 -10
Sources from rfm repository
----------------------------
revision 1.26.4.4
date: 2003/04/17 17:11:35;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.26.4.3
date: 2002/08/08 12:53:19;  author: lfcastro;  state: Exp;  lines: +4 -0
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.26.4.2
date: 2002/08/07 17:53:29;  author: lfcastro;  state: Exp;  lines: +1 -5
* update to HEAD
----------------------------
revision 1.26.4.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +5 -1
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.55.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.55.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +2 -0
no message
----------------------------
revision 1.55.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/trace.c,v
Working file: trace.c
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.12
	without-attv: 1.10
	release-2-0: 1.8
	pre-release-2-0: 1.6
	v1-9-8: 1.6
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.14
date: 1999/10/25 05:59:53;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.13
date: 1999/10/22 20:57:32;  author: ejohnson;  state: Exp;  lines: +1 -3
Enabled subsumption with CHAT.

The interesting changes are in chat.c and chatsched.i.

Changes to the other files just remove CHAT restrictions to
subsumption.
----------------------------
revision 1.12
date: 1999/10/13 21:03:47;  author: ejohnson;  state: Exp;  lines: +3 -3
Small changes to statistical displays.
----------------------------
revision 1.11
date: 1999/10/13 14:15:19;  author: ejohnson;  state: Exp;  lines: +195 -57
Many changes to the way in which stats are collected on tabling
structures: Basic and TS Tries, their subcomponents, answer list
nodes, and subgoal frames.  This includes current and maximal values.

Also reports on number and type of subsumptive operations.
----------------------------
revision 1.10
date: 1999/10/05 04:01:59;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.9
date: 1999/07/06 16:35:21;  author: ejohnson;  state: Exp;  lines: +2 -2
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.8
date: 1999/06/19 13:04:31;  author: kostis;  state: Exp;  lines: +16 -13
Small changes in statistics.
----------------------------
revision 1.7
date: 1999/06/18 18:21:24;  author: cbaoqiu;  state: Exp;  lines: +22 -7
Added statistics information for DEs and DLs.
----------------------------
revision 1.6
date: 1999/01/17 14:56:13;  author: kostis;  state: Exp;  lines: +16 -6
Some small changes for statistics and for hooking up garbage collection.
----------------------------
revision 1.5
date: 1999/01/13 20:54:36;  author: kostis;  state: Exp;  lines: +12 -6
Further changes for statistics.
----------------------------
revision 1.4
date: 1999/01/13 20:28:27;  author: kostis;  state: Exp;  lines: +15 -12
Changes to fix statistics.
----------------------------
revision 1.3
date: 1998/12/21 01:09:06;  author: cbaoqiu;  state: Exp;  lines: +84 -71
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:26:39;  author: cbaoqiu;  state: Exp;  lines: +8 -8
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  The lines about ide_chk_ins, ide_count, idl_chk_ins, and idl_count
  are taken out (in function total_stat()).  This is temporarily and
  may need to be changed.
----------------------------
revision 1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:24;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/trace_xsb.c,v
Working file: trace_xsb.c
head: 1.62
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.48
	ROLLBACK: 1.44
	latest_plus_supp_branch: 1.41.0.2
	latest_plus_supp: 1.41
	Version_3dot2_plus_supp: 1.36.0.2
	release_2_6_plus_supp: 1.11.0.6
	Version_3dot2: 1.36
	dec07-perf-results: 1.33
	mt_thesis: 1.32
	release_3_0: 1.24
	release_2_7_0: 1.11
	multi-threaded-26-engine: 1.10.6.2
	pre-mt: 1.11
	multi-threaded-25-engine-done: 1.10.6.1
	multi-threaded-25-engine: 1.10.0.6
	release_2_6_1: 1.11
	release_2_6_final: 1.11
	release_2_6: 1.11.0.4
	last-merged-to-demand: 1.11
	demand_branch: 1.11.0.2
	before_removing_chat: 1.10
	release_2_5: 1.10
	pre-merge-slgwam-gc: 1.10
	multi-threaded-c-engine: 1.10.0.4
	release_2_4: 1.10
	release_2_3: 1.10
	multi-threaded-engine: 1.10.0.2
	pre-threading: 1.9
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.3
	release-2-0-1: 1.3
keyword substitution: o
total revisions: 71;	selected revisions: 71
description:
----------------------------
revision 1.62
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +3 -24

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.61
date: 2012/04/21 12:11:45;  author: tswift;  state: Exp;  lines: +6 -6

Fiddled with spaces in printfs for better statistics formatting.
----------------------------
revision 1.60
date: 2012/03/01 15:43:04;  author: tswift;  state: Exp;  lines: +7 -1

A couple of tweaks for incremental table statistics.
----------------------------
revision 1.59
date: 2011/09/28 21:14:51;  author: dwarren;  state: Exp;  lines: +6 -6
1. Fixed a bug in unify_with_occurs_check for structures, and modified code
to use a tail-recursion optimization (here and in not_occurs_in, too) in
C with a goto.
2. Fixed timed_call setup for Windows.  It seems to work on windows now.
3. Minor spacing change in statistics printout, which makes it look better
to me...
----------------------------
revision 1.58
date: 2011/06/22 21:27:53;  author: tswift;  state: Exp;  lines: +14 -7

Now maintaining gc time for abolishing tables -- this way I can tell
if my heuristics are out of whack for some program.
----------------------------
revision 1.57
date: 2011/05/22 18:45:32;  author: tswift;  state: Exp;  lines: +13 -13
hopefully nearing 32/64 fixed point
----------------------------
revision 1.56
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +7 -6

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.55
date: 2011/05/20 22:00:29;  author: tswift;  state: Exp;  lines: +17 -29

More changes for 32/64 bits.
----------------------------
revision 1.54
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +15 -15

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.53
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +77 -77
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.52
date: 2011/04/17 16:31:34;  author: tswift;  state: Exp;  lines: +14 -10

Minor changes for incremental tabling and statistics + renaming a few
incremental tabling predicates so that they are less obscure (at least
to me).
----------------------------
revision 1.51
date: 2011/03/28 12:45:48;  author: dwarren;  state: Exp;  lines: +3 -3
Added CTXT parameter to count_sccs() so it would compile under mt.
----------------------------
revision 1.50
date: 2011/03/24 16:50:06;  author: tswift;  state: Exp;  lines: +26 -5

Added count of SCCs along with report of how many open tables there
are.  This does mean that the default statistics must make a traversal
of the completion stack, but I dont think that will be much of a
problem.
----------------------------
revision 1.49
date: 2010/11/28 23:14:14;  author: tswift;  state: Exp;  lines: +34 -5

Added counts of abolishes to statistics (if there have been any).
Also added a count of the number of incomplete tables (if there are any).
----------------------------
revision 1.48
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.47
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.46
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.45
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.44
date: 2010/06/22 23:51:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.43
date: 2010/06/19 19:10:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.42
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +636 -636
Dipti's code for support graph added
----------------------------
revision 1.41
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +3 -3
branches:  1.41.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.40
date: 2009/08/29 17:18:08;  author: tswift;  state: Exp;  lines: +5 -1

Making statistics(atoms,X) work for the MT engine.
----------------------------
revision 1.39
date: 2009/08/26 23:58:41;  author: tswift;  state: Exp;  lines: +13 -18

Adding statistics(atoms,X) to show size of atom space, in bytes.
----------------------------
revision 1.38
date: 2009/08/21 20:09:34;  author: tswift;  state: Exp;  lines: +829 -466


Added various options for statistics/2 based in	part on	Paul
Fodor's modification of	  statistics/0.  See manual for details.
----------------------------
revision 1.37
date: 2009/05/07 19:39:51;  author: dwarren;  state: Exp;  lines: +4 -3
Fixed total memory used printout.  It had been double-counting trie_interned
space.
----------------------------
revision 1.36
date: 2009/02/21 16:47:34;  author: tswift;  state: Exp;  lines: +48 -1

Changes to support

statistics/2
Rui's fix for the mt bug

along with scratch code for answer_completion.
----------------------------
revision 1.35
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +2 -2
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.34
date: 2008/08/20 19:47:58;  author: tswift;  state: Exp;  lines: +6 -1


A change to stack reallocation from last January uncovered a bug
in Call subsumption, which copied the substitution factor from
the CPS to the heap.  Because of this, it is necessary to reset
pointers from the heap every time the glstack is reallocated,
regardless of whether the heap itself is moved.  So this change
revises the code to always reset heap pointers upon glstack
realloc.  See the documentation in tables.c to see why this is a
safe solution and the heap Substitution factor does not cause
other problems.

This fixes some core dumps in call subsumption.  The bug
exhibited itself on Linux and the Mac for a particular test
program, but the bug could show up anywhere.

Change in trace_xsb.c to fix table operation counts for the MT
engine.
----------------------------
revision 1.33
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.32
date: 2006/12/07 00:26:46;  author: tswift;  state: Exp;  lines: +3 -4

-- Added reclamation of conditional answer information (including
   subgoal PNDEs and delay tries) when variant predicates/subgoals are
   abolished in abolish_table_pred/1, abolish_table_call/1, and
   close_open_tables/0.  Also, wrote delete_delay_trie() to delete
   answer substitution factor for delay elements, and made sure this
   was used whenever des are reclaimed -- (e.g. by abolishes and
   simplifications).

-- fixed some bugs in MT engine where situations could arise where
   trie allocation type was not properly set before abolishes called
   in table gc sweeps or reloading tabled predicates.

-- Fixed numerous bugs in performing simplification in the MT engine.
   In general simplification routines may reclaim structures for delay
   lists, delay elements, answer branches, asis and pndes.  Whenever
   any of these structures are reclaimed in the MT engine a check must
   be made to determine whether these elements use private or shared
   memory management -- either struture managers or the managers for
   des/dls/pndes.  Keeping all of this straight required some thinking
   as the code flits from table to table by traversing pndes --
   however I think I was able to extend the code without undue mess
   (at least this time :-)
----------------------------
revision 1.31
date: 2006/11/30 21:50:09;  author: ruim;  state: Exp;  lines: +5 -1
added names to the pseudo mutexes
added max_threads_sofar a statistic for peak thread number
----------------------------
revision 1.30
date: 2006/11/15 16:38:10;  author: tswift;  state: Exp;  lines: +81 -34

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.29
date: 2006/11/06 17:31:53;  author: ruim;  state: Exp;  lines: +4 -2
Fixes to CONC_COMPL:

- compl stack expansion fixed
- freeing of answer_return list finally fixed

it now runs all the tests that batched runs
----------------------------
revision 1.28
date: 2006/11/06 10:31:39;  author: ruim;  state: Exp;  lines: +15 -15
Changed counter to unsigned long
Changed several counting variables to unsigned
Fixed a wrong thing in previous memory_xsb.c fix
----------------------------
revision 1.27
date: 2006/11/02 02:59:44;  author: ruim;  state: Exp;  lines: +9 -1
added counter for deadlocks to show in statistics
----------------------------
revision 1.26
date: 2006/10/18 20:42:27;  author: dwarren;  state: Exp;  lines: +1 -1
Updates to the ODBC interface:
1) fixed a global variable that would break MT
2) changed to use mem_alloc and new ODBC_SPACE tag to show memory
	usage in statistics.
----------------------------
revision 1.25
date: 2006/10/06 20:04:28;  author: dwarren;  state: Exp;  lines: +11 -5
Updated memory management in hashtable (which manages hashing for incremental
table maintenance.)  It now uses XSB mem_alloc and friends, and there is a new
space type of INCR_TABLE_SPACE.  It is included in SLG Table space in statistics
and is also broken out (if nonzero).
And doing that showed a huge amount of unused space due to many large hashtables
when there's only one edge.  So I changed the minimum size of initial hashtables
(they are automatically expanded if necessary.)  [It reduced incr space usage in
my DSS example from about 340M to 8M... much!! better.]
----------------------------
revision 1.24
date: 2006/06/20 17:43:21;  author: dwarren;  state: Exp;  lines: +11 -2
Fixed bug(?) in statistics, added line for trie-indexed asserted code space,
and took it out of SLG Table space.  It had been included in permanent space, but
wasn't in the breakdown.  Now it is.  The only oddity now (I know of) is that the overhead
space (for block chain headers and such) for trie-asserted code is still counted
in TABLE space.  (It's not immediately obvious how to pull it out...)
----------------------------
revision 1.23
date: 2006/04/27 21:08:48;  author: tswift;  state: Exp;  lines: +49 -19

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.22
date: 2006/01/13 23:56:58;  author: tswift;  state: Exp;  lines: +186 -6

psc_xsb.c changed so that get_tip returns NULL when called with a
non-tabled predicate in the MT engine -- calling routines such as
abolish_table_pred/1 can then throw an error.

statistics files changed pretty minimally.  Basically, I just changed
them enough to prevent core dumps when calling statistics (due to the
new structure managers).  Or at least to sometimes prevent core dumps :-)
More work on them will be needed.
----------------------------
revision 1.21
date: 2006/01/09 00:06:33;  author: tswift;  state: Exp;  lines: +4 -4
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.20
date: 2006/01/06 14:21:52;  author: dwarren;  state: Exp;  lines: +2 -2
Give better format element in printout to quiet complaining compiler.
----------------------------
revision 1.19
date: 2005/12/22 23:34:00;  author: tswift;  state: Exp;  lines: +4 -3

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.18
date: 2005/12/12 18:44:54;  author: dwarren;  state: Exp;  lines: +8 -7
Added string table garbage collection.
----------------------------
revision 1.17
date: 2005/11/20 21:23:29;  author: dwarren;  state: Exp;  lines: +6 -6
Separated atom_str_space into atom_space and string_space.
Reduced the initial size of atom table (not string table)

Commented that global variable prevpsc doesn't need protection for MT.

Added MUTEX for updating tag table in GENERAL_TAGGING under MT.

Added "free"-mark (2nd word) in structure_manager-managed space.  Supports
easier computation of free space, and setup for string-space gc.
----------------------------
revision 1.16
date: 2005/11/16 22:34:54;  author: dwarren;  state: Exp;  lines: +3 -2
Minor memory management cleanup, to reduce initial space usage.
----------------------------
revision 1.15
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +22 -7
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.14
date: 2005/10/03 13:26:44;  author: tswift;  state: Exp;  lines: +7 -1


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.13
date: 2005/08/01 23:03:30;  author: tswift;  state: Exp;  lines: +8 -1
1) Changes to error handling in assert, retract, abolish, clause, and
   related predicates to make the error terms a bit more ISO-like.

2) Change to psc_prop to check for T_DYNA in addition to T_PRED.
----------------------------
revision 1.12
date: 2005/01/14 18:31:37;  author: ruim;  state: Exp;  lines: +2 -2
Integration of multithreaded system
----------------------------
revision 1.11
date: 2002/03/12 17:31:22;  author: lfcastro;  state: Exp;  lines: +3 -22
branches:  1.11.2;
* Removal of Chat engine
----------------------------
revision 1.10
date: 2000/06/27 17:59:18;  author: ejohnson;  state: Exp;  lines: +6 -6
branches:  1.10.2;  1.10.6;
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.9
date: 2000/05/30 14:11:08;  author: ejohnson;  state: Exp;  lines: +4 -4
Reinstate integrity checks for subgoal frames during the collection of
statistics.
----------------------------
revision 1.8
date: 2000/05/29 04:23:40;  author: ejohnson;  state: Exp;  lines: +13 -13
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.7
date: 2000/05/25 00:32:04;  author: ejohnson;  state: Exp;  lines: +11 -7
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.6
date: 2000/05/20 06:56:12;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.5
date: 2000/04/25 23:18:56;  author: ejohnson;  state: Exp;  lines: +29 -16
Replaced the structure-specific statistic functions with more general
versions which take a Structure_Manager as an argument.  These
functions are now used for statistics-gathering on trie-asserted
structures.  Trie-assert usage is reported as part of permanent space.
----------------------------
revision 1.4
date: 2000/01/07 08:52:01;  author: kifer;  state: Exp;  lines: +3 -3
branches:  1.4.2;
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.3
date: 1999/10/26 20:17:00;  author: ejohnson;  state: Exp;  lines: +30 -110
Replaced detailed table space usage and subsumptive operation stats in
total_stat() with less-detailed and spatially-smaller listings.
However, the detailed listings are preserved in table_stats.c for
future use.  (These are very helpful during debugging).
----------------------------
revision 1.2
date: 1999/10/26 06:47:32;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.1
date: 1999/10/25 05:59:54;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.4.2.1
date: 2000/03/28 18:10:33;  author: lfcastro;  state: Exp;  lines: +3 -11
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.10.6.2
date: 2004/10/18 20:46:22;  author: ruim;  state: Exp;  lines: +3 -22
update for version 2.6.1
----------------------------
revision 1.10.6.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +2 -2
Sources from rfm repository
----------------------------
revision 1.10.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.10.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +7 -2
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.11.2.1
date: 2003/05/13 18:12:52;  author: lfcastro;  state: Exp;  lines: +16 -2
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.41.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.41.2.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +636 -636
no message
----------------------------
revision 1.41.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/trace_xsb.h,v
Working file: trace_xsb.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.8
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.2
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.3.0.2
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.11
date: 2012/07/04 15:10:46;  author: tswift;  state: Exp;  lines: +0 -3

Got rid of old TRACE_STA which was unusable as it was too slow.
Relpaced it by a routine that keeps track only of maximum table usage.
This can still be optimized, primarily by checking once per SCC
closure rather than once per completion, but it should be usable if we
want it.
----------------------------
revision 1.10
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +3 -2

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.9
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +2 -2
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2009/08/21 20:09:34;  author: tswift;  state: Exp;  lines: +1 -0
branches:  1.4.2;


Added various options for statistics/2 based in	part on	Paul
Fodor's modification of	  statistics/0.  See manual for details.
----------------------------
revision 1.3
date: 2006/06/01 13:39:24;  author: dwarren;  state: Exp;  lines: +0 -2
Removed MT conditioning of extern decl, since it's used in nonMT,
to eliminate "undeclared" warning.
----------------------------
revision 1.2
date: 2006/04/27 21:08:48;  author: tswift;  state: Exp;  lines: +6 -1

Some minor changes to retract code.

     1) fixed potential bug in free_delcfs with prrefs.
     2) abolish/1 causes abolish of completed tables
     3) Revised function-level documentation in code.

Also some relatively simple changes to statistics to make statistics
in the MT engine coherent and understandable.  We'll want to go
further with this in the future, but I think this is a reasonable
start.
----------------------------
revision 1.1
date: 2005/10/03 13:26:44;  author: tswift;  state: Exp;


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.4.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.4.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/trassert.h,v
Working file: trassert.h
head: 1.16
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.16
	ROLLBACK: 1.10
	latest_plus_supp_branch: 1.10.0.4
	latest_plus_supp: 1.10
	Version_3dot2_plus_supp: 1.10.0.2
	release_2_6_plus_supp: 1.4.0.14
	Version_3dot2: 1.10
	dec07-perf-results: 1.9
	mt_thesis: 1.7
	release_3_0: 1.5
	release_2_7_0: 1.4
	multi-threaded-26-engine: 1.4.12.1
	pre-mt: 1.4
	multi-threaded-25-engine-done: 1.4.12.1
	multi-threaded-25-engine: 1.4.0.12
	release_2_6_1: 1.4
	release_2_6_final: 1.4
	release_2_6: 1.4.0.10
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.8
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.6
	release_2_4: 1.4
	release_2_3: 1.4
	multi-threaded-engine: 1.4.0.4
	pre-threading: 1.4
	release-2-2: 1.4
	chat-and-local: 1.4.0.2
	xsb-pre-cleanup: 1.4
	release-2-1: 1.4
	release-2-0-1: 1.4
	subsumption: 1.4
	without-attv: 1.4
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 24;	selected revisions: 24
description:
----------------------------
revision 1.16
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -2
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.15
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.14
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +2 -1
no message
----------------------------
revision 1.10
date: 2007/12/24 19:17:00;  author: tswift;  state: Exp;  lines: +13 -12
branches:  1.10.4;

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.9
date: 2007/11/20 19:17:21;  author: tswift;  state: Exp;  lines: +15 -2


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.8
date: 2007/02/22 00:16:06;  author: tswift;  state: Exp;  lines: +11 -11


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.7
date: 2006/11/09 16:58:35;  author: ruim;  state: Exp;  lines: +2 -2
SET_TRIE_ALLOCATION_TYPE_TIP: I think this would not have worked
for thread private tabled dynamic predicates, so changed to a safer code

TRIE_ASSERT: there's only one structure manager for trie assert,
so had to use SHARED struct manager mode
I also added a lock on trie asserted tries, but as reading is not
protected this is not entirely safe
----------------------------
revision 1.6
date: 2006/09/27 22:03:43;  author: tswift;  state: Exp;  lines: +12 -4

Changes to get rid of uninitialized memory as reported by valgrind.

1) Initialized IGRhead and deadlock_brk_leader
2) Ensured that tries always use private structure manager
3) initialized num_heap_term_vars to be 0 at each pass through answer_return

The last fixes an obscure memory error in the sequential engine, as well.
----------------------------
revision 1.5
date: 2005/01/14 18:31:37;  author: ruim;  state: Exp;  lines: +5 -4
Integration of multithreaded system
----------------------------
revision 1.4
date: 1999/07/15 21:41:22;  author: ejohnson;  state: Exp;  lines: +7 -36
branches:  1.4.4;  1.4.12;
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.3
date: 1999/07/06 16:35:21;  author: ejohnson;  state: Exp;  lines: +2 -2
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.2
date: 1998/12/21 01:09:08;  author: cbaoqiu;  state: Exp;  lines: +41 -1
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.4.12.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +5 -4
Sources from rfm repository
----------------------------
revision 1.4.4.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.4.4.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.10.4.4
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.10.4.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +1 -0
no message
----------------------------
revision 1.10.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.10.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/trie_defs.h,v
Working file: trie_defs.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.2
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.2.0.2
	Version_3dot2: 1.2
	dec07-perf-results: 1.1
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.7
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.6
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/04/24 20:50:43;  author: tswift;  state: Exp;  lines: +6 -1
branches:  1.3.2;

Changes for incremental tabling based on tries.
----------------------------
revision 1.2
date: 2007/12/24 19:17:00;  author: tswift;  state: Exp;  lines: +4 -2

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.1
date: 2007/11/21 10:00:23;  author: tswift;  state: Exp;

Forgot to commit this one last night -- contains definitions for tries.
----------------------------
revision 1.3.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.3.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/trie_internals.h,v
Working file: trie_internals.h
head: 1.47
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.43
	ROLLBACK: 1.38
	latest_plus_supp_branch: 1.38.0.4
	latest_plus_supp: 1.38
	Version_3dot2_plus_supp: 1.38.0.2
	release_2_6_plus_supp: 1.19.0.4
	Version_3dot2: 1.38
	dec07-perf-results: 1.37
	mt_thesis: 1.35
	release_3_0: 1.29
	release_2_7_0: 1.19
	multi-threaded-26-engine: 1.18.6.5
	pre-mt: 1.19
	multi-threaded-25-engine-done: 1.18.6.1
	multi-threaded-25-engine: 1.18.0.6
	release_2_6_1: 1.19
	release_2_6_final: 1.19
	release_2_6: 1.19.0.2
	last-merged-to-demand: 1.18
	demand_branch: 1.18.0.4
	before_removing_chat: 1.18
	release_2_5: 1.18
	pre-merge-slgwam-gc: 1.18
	multi-threaded-c-engine: 1.18.0.2
	release_2_4: 1.18
	release_2_3: 1.16
	multi-threaded-engine: 1.15.0.2
	pre-threading: 1.11
	release-2-2: 1.8
	chat-and-local: 1.8.0.2
	xsb-pre-cleanup: 1.8
	release-2-1: 1.8
	release-2-0-1: 1.8
	subsumption: 1.5
	without-attv: 1.3
keyword substitution: kv
total revisions: 61;	selected revisions: 61
description:
----------------------------
revision 1.47
date: 2011/06/06 20:20:29;  author: dwarren;  state: Exp;  lines: +3 -3
Several fixes:
1. interprolog_callback on MT had a minor issue.

2. a couple of casts to avoid warnings

3. Most of the changes are due to simplified handling of short and
boxed integers.  A bug was submitted that showed an error is handling
of boxed integers.  To fix that, I added an isointeger test macro to
test whether a prolog_term is an integer OR a boxed integer.  (We had
done this for boxed floats, but not integers.)  Anyway, using this
simplified much code, so I went ahead and made many changes, finding a
and fixing number of minor bugs in handling large integers.
----------------------------
revision 1.46
date: 2011/06/02 22:29:23;  author: tswift;  state: Exp;  lines: +44 -7
Changes	to add stack expansion so that arbitrary numbers of
variables are allowed in interned, asserted tries and tables.

This uncovered a bug.

The problem arose when a conditional answer is interned in the
answer trie and that conditional answer contains variables both
in the answer head and the delay list, and there are variables in
the answer head that are not in the delay list. What happened was
that when the variables were interned in delay_trie_chk_insert,
the mini-trail that the trie routines use for standardizing
variables was reset.  This meant that the variables in the answer
head were not being properly untrailed and, due to the particular
way that variables are standardized, variables were bound to each
other that shouldn't have been, and in this case a circular
dereferencing chain arose, so that XSB hung.  I have no idea why
the bug was uncovered just now.
----------------------------
revision 1.45
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +3 -3
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.44
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +9 -6

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.43
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.42
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.41
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.40
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.39
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.38
date: 2009/01/14 18:40:12;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.38.4;
Fixed a memory leak in tabling: the bucket-array for hashing in tries
was not being released (unless it had been expanded.)  There was a test
for larger size than initial, which I removed.  I assume this was leak
was probably introduced when the initial bucket-array became independently
allocated (?).  With this change, abolish_all_tables and abolosh_table_pred
give back all the memory in my tests.
----------------------------
revision 1.37
date: 2007/04/05 17:26:57;  author: tswift;  state: Exp;  lines: +12 -1
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.36
date: 2007/02/22 00:16:06;  author: tswift;  state: Exp;  lines: +15 -72


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.35
date: 2006/11/28 18:43:14;  author: ruim;  state: Exp;  lines: +5 -5
changed dealloc struct to shared dealloc struct for shared aln deallocation
----------------------------
revision 1.34
date: 2006/11/28 14:18:06;  author: ruim;  state: Exp;  lines: +3 -3
added one mutex to each struct manager so that MUTEX_SM is now obsolete.
this should provide a bit more scalability.
----------------------------
revision 1.33
date: 2006/11/15 16:38:10;  author: tswift;  state: Exp;  lines: +8 -1

1) Modified the engine so that conditional answer information for
   private tables is now thread private.  This included creating a
   private structure manager for answer substitution frames (asi's),
   and making private allocation methods for delay lists, delay
   elements, and backpointers (pndes).  The advantages of this are
   that addition of a conditional answer for a private table no longer
   requires a mutex, and space for conditional private answers is
   automatically reclaimed upon thread exit.

2) Based on this, I added two predicates: abolish_all_private_tables
   and abolish_all_shared_tables that use the model of
   abolish_all_tables to reclaim space in the MT engine.

3) Updated statistics(table) to report a breakdown of space used by
   the various components of conditional answers.  Rewrote statistics
   and statistics(table) to provide information on space for shared
   and private tables separately.

4) redid the warning about removing conditional answers in
   abolish_table_pred to provide the name of the predicate with
   conditional answers and to warn only once per tabled predicate
   (rather than once per subgoal)

The manuals were updated to reflect all of this.  There's more to do
-- including refactoring some of the code I put in -- but that will
have to wait a couple of days.
----------------------------
revision 1.32
date: 2006/11/06 17:31:53;  author: ruim;  state: Exp;  lines: +15 -6
Fixes to CONC_COMPL:

- compl stack expansion fixed
- freeing of answer_return list finally fixed

it now runs all the tests that batched runs
----------------------------
revision 1.31
date: 2006/11/06 12:02:19;  author: ruim;  state: Exp;  lines: +2 -2
Taken out lock on subgoal frame as it doesn't seem necessary
Fixed check for reclamation of private tables answer return list
for concurrent completion
----------------------------
revision 1.30
date: 2006/11/05 23:53:15;  author: ruim;  state: Exp;  lines: +12 -7
Several changes & fixes for Concurrent Completion:
- Locking of the answer return list and consumer list at subgoal frame level
- No longer a dummy generator choice point is created for every external
  consumer
- Threads which don't have a stale view of the round are no longer awaken at
  completion
- The answer return list is not reclaim for shared tables
----------------------------
revision 1.29
date: 2006/01/12 21:33:53;  author: tswift;  state: Exp;  lines: +90 -31
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.28
date: 2006/01/09 00:06:33;  author: tswift;  state: Exp;  lines: +35 -8
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.27
date: 2005/12/22 23:34:01;  author: tswift;  state: Exp;  lines: +3 -3

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.26
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +3 -3
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.25
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +3 -3
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.24
date: 2005/10/21 17:47:52;  author: tswift;  state: Exp;  lines: +5 -3


These are documentation changes only, made while stumbling through unfamiliar code.  I wanted to get them in before I started to make code changes.
----------------------------
revision 1.23
date: 2005/10/03 13:26:44;  author: tswift;  state: Exp;  lines: +24 -41


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.22
date: 2005/08/28 16:42:28;  author: ruim;  state: Exp;  lines: +10 -1
phase 1 of implementation of concurrent completion
----------------------------
revision 1.21
date: 2005/08/01 19:10:49;  author: ruim;  state: Exp;  lines: +1 -5
changes to break deadlocks in negation and handle early completion
----------------------------
revision 1.20
date: 2005/01/14 18:31:37;  author: ruim;  state: Exp;  lines: +40 -2
Integration of multithreaded system
----------------------------
revision 1.19
date: 2002/11/05 20:50:37;  author: lfcastro;  state: Exp;  lines: +7 -7
* First cut at an implementation for abolish_table_call/1.
  - at this point, this call deletes all subsuming tables of a given
  term, via backtracking; what is the desired semantics?

*** WARNING ***
This is not a "safe" operator. It does not perform any kind of
checking, so one may, in fact, delete a table which is in use. This
may cause undefined behavior (i.e. segmentation faults and the like).
----------------------------
revision 1.18
date: 2001/05/07 02:17:29;  author: kifer;  state: Exp;  lines: +10 -3
branches:  1.18.4;  1.18.6;
added comments
----------------------------
revision 1.17
date: 2001/02/26 22:13:48;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed a bug that abolishing (and retractall-ing) a trie-indexed
predicate didn't release the space, causing a serious memory leak.
----------------------------
revision 1.16
date: 2000/12/04 17:10:45;  author: ejohnson;  state: Exp;  lines: +2 -2
Added support for subsumption-based LRD stratified negation,
including:

o Modification of 't not'/1 to accept all predicates.

o Replacement of predicate get_producer_subgoal_frame/2 with a new
  predicate get_producer_call/3 (ala get_call/3 and friends) to take
  the subgoal and perform a tabling-strategy-dependent lookup,
  returning a producer's subgoal frame and an answer template with
  respect to that producer.

  get_producer_call/3 aborts if given a non-tabled predicate and fails
  if the tabled predicate hasn't been called before.

o Modification of slg_not/1 s.t. it takes two extra arguments: the
  first is the answer template from get_producer_call/3, used by
  negated, properly subsumed predicates for relevant-answer
  collection; the second contains the subgoal which is negated, used
  only for error reporting.

o Extension of certain C functions, e.g. get_variant_sf() and
  get_subsumer_sf() to build and return, in an extra argument, the
  answer template.
----------------------------
revision 1.15
date: 2000/07/31 20:27:58;  author: ejohnson;  state: Exp;  lines: +13 -14
branches:  1.15.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.14
date: 2000/06/25 16:59:17;  author: ejohnson;  state: Exp;  lines: +96 -12
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.13
date: 2000/06/24 13:55:04;  author: ruim;  state: Exp;  lines: +10 -8
Casts to avoid void * implicit conversion
----------------------------
revision 1.12
date: 2000/06/23 20:54:09;  author: ruim;  state: Exp;  lines: +22 -19
Removed some C++ automatic pointer casting warnings
----------------------------
revision 1.11
date: 2000/05/29 04:23:40;  author: ejohnson;  state: Exp;  lines: +2 -2
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.10
date: 2000/05/25 00:32:04;  author: ejohnson;  state: Exp;  lines: +50 -49
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.9
date: 2000/04/29 21:54:01;  author: kifer;  state: Exp;  lines: +22 -22
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.8
date: 1999/10/27 16:13:00;  author: ejohnson;  state: Exp;  lines: +2 -3
Shifted a few defs around to "proper" places:
 - number of bits needed for Cell tagging scheme
	trie_internals.h -> celltags_xsb.h
 - TrieVar tag
	cell_xsb.h -> celltags_xsb.h
----------------------------
revision 1.7
date: 1999/10/26 06:47:33;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.6
date: 1999/10/18 21:50:13;  author: cbaoqiu;  state: Exp;  lines: +17 -12
1) Renamed CallVarEnum back to VarEnumerator (after a long discussion
   with Ernie);
2) Renamed IndexOfStandardizedVariable to IndexOfStdVar;
3) Added more changes for attributed variables (around variant_call_search).
----------------------------
revision 1.5
date: 1999/10/13 20:52:07;  author: ejohnson;  state: Exp;  lines: +4 -4
Better values for number of tabling structures to allocate at once.
----------------------------
revision 1.4
date: 1999/10/13 14:31:23;  author: ejohnson;  state: Exp;  lines: +388 -157
Modified definitions of trie-component abstractions.  This was needed
to avoid ANSI incompatibility: casting on LHS of stmt.  Some of these
defs were moved to tries.h.  These changes propogated into macros
which used these defs.

Trie Node Types changed to enumerated type rather than preprocessor
defs.

Specialized uses of array VarEnumerator[] into two separate arrays:
tracking call variables, CallVarEnum[], and tracking bindings to trie
vars, TrieVarBindings[].  These two arrays are needed simultaneously
during answer retrieval.

Added macros which utilize these arrays, and changed defs of older
macros to use these instead of VarEnumerator[].

Generalized basic trie-manipulating macros to be compatible with TSTs.

Finally, some appearance changes were made during the course of these
modifications.
----------------------------
revision 1.3
date: 1999/08/16 07:24:40;  author: kifer;  state: Exp;  lines: +3 -4
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.2
date: 1999/07/15 21:41:22;  author: ejohnson;  state: Exp;  lines: +115 -89
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.1
date: 1999/07/06 16:35:22;  author: ejohnson;  state: Exp;
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.15.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.15.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.18.6.5
date: 2004/12/14 08:47:06;  author: ruim;  state: Exp;  lines: +5 -1
added dynamic stacks to thread context
----------------------------
revision 1.18.6.4
date: 2004/11/24 21:53:27;  author: ruim;  state: Exp;  lines: +18 -3
made smBTHT and smBTN thread specific
----------------------------
revision 1.18.6.3
date: 2004/11/22 23:07:36;  author: ruim;  state: Exp;  lines: +16 -1
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.18.6.2
date: 2004/10/18 20:46:22;  author: ruim;  state: Exp;  lines: +7 -7
update for version 2.6.1
----------------------------
revision 1.18.6.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +5 -1
Sources from rfm repository
----------------------------
revision 1.18.4.4
date: 2003/04/17 17:11:35;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.18.4.3
date: 2002/08/08 12:53:19;  author: lfcastro;  state: Exp;  lines: +6 -6
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.18.4.2
date: 2002/08/07 17:53:29;  author: lfcastro;  state: Exp;  lines: +7 -7
* update to HEAD
----------------------------
revision 1.18.4.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +7 -7
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.38.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.38.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.38.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/trie_lookup.c,v
Working file: trie_lookup.c
head: 1.32
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.25
	ROLLBACK: 1.20
	latest_plus_supp_branch: 1.20.0.4
	latest_plus_supp: 1.20
	Version_3dot2_plus_supp: 1.20.0.2
	release_2_6_plus_supp: 1.7.0.6
	Version_3dot2: 1.20
	dec07-perf-results: 1.17
	mt_thesis: 1.16
	release_3_0: 1.16
	release_2_7_0: 1.7
	multi-threaded-26-engine: 1.5.4.4
	pre-mt: 1.7
	multi-threaded-25-engine-done: 1.5.4.1
	multi-threaded-25-engine: 1.5.0.4
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.4
	last-merged-to-demand: 1.7
	demand_branch: 1.7.0.2
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.2
	release_2_4: 1.5
	release_2_3: 1.4
	multi-threaded-engine: 1.3.0.2
keyword substitution: kv
total revisions: 41;	selected revisions: 41
description:
----------------------------
revision 1.32
date: 2011/10/29 23:27:59;  author: tswift;  state: Exp;  lines: +2 -2

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.31
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +21 -9

Integrating in Call Abstraction
----------------------------
revision 1.30
date: 2011/09/30 17:18:51;  author: tswift;  state: Exp;  lines: +3 -3

Some changes to allow compilation with CALL_ABSTRACTION set on
(tables.c not committed yet, though).  This change should not affect
regular compilation or evaluation.
----------------------------
revision 1.29
date: 2011/08/20 21:36:49;  author: tswift;  state: Exp;  lines: +2 -1

Fixed bug in hash opcode where it was throwing an error when encountering an attv.

Will go through occurrences of isref() to make sure things are attv safe (or at least to triage).
----------------------------
revision 1.28
date: 2011/08/03 18:12:54;  author: tswift;  state: Exp;  lines: +45 -2

Added Call abstraction stuff (mostly commented out).
----------------------------
revision 1.27
date: 2011/06/02 22:29:23;  author: tswift;  state: Exp;  lines: +3 -4
Changes	to add stack expansion so that arbitrary numbers of
variables are allowed in interned, asserted tries and tables.

This uncovered a bug.

The problem arose when a conditional answer is interned in the
answer trie and that conditional answer contains variables both
in the answer head and the delay list, and there are variables in
the answer head that are not in the delay list. What happened was
that when the variables were interned in delay_trie_chk_insert,
the mini-trail that the trie routines use for standardizing
variables was reset.  This meant that the variables in the answer
head were not being properly untrailed and, due to the particular
way that variables are standardized, variables were bound to each
other that shouldn't have been, and in this case a circular
dereferencing chain arose, so that XSB hung.  I have no idea why
the bug was uncovered just now.
----------------------------
revision 1.26
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +6 -6
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.25
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.24
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.23
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.21
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.20
date: 2009/02/21 17:05:07;  author: tswift;  state: Exp;  lines: +3 -1
branches:  1.20.4;

Small comment
----------------------------
revision 1.19
date: 2009/01/01 00:07:22;  author: tswift;  state: Exp;  lines: +1 -6
Changes to get rid of sloppy extern statements, and put them into a .h file where they should be.
----------------------------
revision 1.18
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +12 -2


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.17
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -2
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.16
date: 2005/12/12 18:44:54;  author: dwarren;  state: Exp;  lines: +2 -2
Added string table garbage collection.
----------------------------
revision 1.15
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +3 -1

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.14
date: 2005/11/18 21:09:37;  author: tswift;  state: Exp;  lines: +5 -1


Changes to error reporting when an attempt is made to use
attributed variables in subsumptive tables.  Subsumptive tables
do not yet allow attvs, and I want to wait to implement them
until I can restructure the variant table code -- most likely
after the next release.  So for now, just make the error
reporting better.

In order to do this, I introduced a new error type, table_error
for misc errors involving table semantics / implementation.

Other changes affected only code documentation.
----------------------------
revision 1.13
date: 2005/11/16 22:34:54;  author: dwarren;  state: Exp;  lines: +4 -13
Minor memory management cleanup, to reduce initial space usage.
----------------------------
revision 1.12
date: 2005/11/16 17:32:05;  author: dwarren;  state: Exp;  lines: +3 -3
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.11
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +6 -5
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.10
date: 2005/08/16 21:39:53;  author: dwarren;  state: Exp;  lines: +20 -49
Made subsumptive tables thread-safe with regard to global variables (I hope.)
So thread_private subsumptive tables should work.  No guarantees at all for
shared subsumptive tables.
----------------------------
revision 1.9
date: 2005/03/05 07:49:49;  author: kifer;  state: Exp;  lines: +3 -3
got rid of obvious compiler warnings
----------------------------
revision 1.8
date: 2005/01/14 18:31:37;  author: ruim;  state: Exp;  lines: +20 -20
Integration of multithreaded system
----------------------------
revision 1.7
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +34 -34
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.6
date: 2002/05/22 15:41:17;  author: lfcastro;  state: Exp;  lines: +46 -90
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.5
date: 2001/07/02 15:53:07;  author: ejohnson;  state: Exp;  lines: +6 -4
branches:  1.5.4;
Modified statement whose syntax yielded warning under gcc 3.0: array
bound variable both used and modified within same statement.
----------------------------
revision 1.4
date: 2000/12/04 17:10:45;  author: ejohnson;  state: Exp;  lines: +15 -5
Added support for subsumption-based LRD stratified negation,
including:

o Modification of 't not'/1 to accept all predicates.

o Replacement of predicate get_producer_subgoal_frame/2 with a new
  predicate get_producer_call/3 (ala get_call/3 and friends) to take
  the subgoal and perform a tabling-strategy-dependent lookup,
  returning a producer's subgoal frame and an answer template with
  respect to that producer.

  get_producer_call/3 aborts if given a non-tabled predicate and fails
  if the tabled predicate hasn't been called before.

o Modification of slg_not/1 s.t. it takes two extra arguments: the
  first is the answer template from get_producer_call/3, used by
  negated, properly subsumed predicates for relevant-answer
  collection; the second contains the subgoal which is negated, used
  only for error reporting.

o Extension of certain C functions, e.g. get_variant_sf() and
  get_subsumer_sf() to build and return, in an extra argument, the
  answer template.
----------------------------
revision 1.3
date: 2000/06/26 19:21:11;  author: ejohnson;  state: Exp;  lines: +15 -21
branches:  1.3.2;
Converted another stack (tstTermStackLog) utilized by the trie
routines from static to dynamic.
----------------------------
revision 1.2
date: 2000/06/26 15:53:29;  author: ejohnson;  state: Exp;  lines: +14 -14
Converted another stack (tstTrail) utilized by the trie routines from
static to dynamic.
----------------------------
revision 1.1
date: 2000/06/25 16:59:18;  author: ejohnson;  state: Exp;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.3.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.5.4.4
date: 2004/12/14 08:47:06;  author: ruim;  state: Exp;  lines: +4 -4
added dynamic stacks to thread context
----------------------------
revision 1.5.4.3
date: 2004/11/22 23:07:37;  author: ruim;  state: Exp;  lines: +17 -17
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.5.4.2
date: 2004/10/18 20:46:22;  author: ruim;  state: Exp;  lines: +49 -93
update for version 2.6.1
----------------------------
revision 1.5.4.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.20.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.20.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.20.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/trie_search.c,v
Working file: trie_search.c
head: 1.19
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.17
	ROLLBACK: 1.12
	latest_plus_supp_branch: 1.12.0.4
	latest_plus_supp: 1.12
	Version_3dot2_plus_supp: 1.12.0.2
	release_2_6_plus_supp: 1.6.0.6
	Version_3dot2: 1.12
	dec07-perf-results: 1.10
	mt_thesis: 1.9
	release_3_0: 1.9
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.4.4.5
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.4.4.1
	multi-threaded-25-engine: 1.4.0.4
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.4
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.2
	before_removing_chat: 1.4
	release_2_5: 1.4
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.2
	release_2_4: 1.4
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.2
keyword substitution: kv
total revisions: 29;	selected revisions: 29
description:
----------------------------
revision 1.19
date: 2010/12/07 21:08:02;  author: tswift;  state: Exp;  lines: +39 -37

Oops -- one more unused function to comment out.
----------------------------
revision 1.18
date: 2010/12/07 20:55:37;  author: tswift;  state: Exp;  lines: +76 -71

Commented out some unused code (so I don't have to keep trying to
figure out what it is).
----------------------------
revision 1.17
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.16
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.15
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.14
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2009/01/01 00:07:22;  author: tswift;  state: Exp;  lines: +1 -6
branches:  1.12.4;
Changes to get rid of sloppy extern statements, and put them into a .h file where they should be.
----------------------------
revision 1.11
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +29 -8


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.10
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.9
date: 2005/12/22 23:34:01;  author: tswift;  state: Exp;  lines: +4 -4

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.8
date: 2005/11/29 00:02:16;  author: tswift;  state: Exp;  lines: +20 -16

Appended global variables from orient_xsb.c with _gl suffix to indicate that they've been accounted for.  These were all safe anyway, so its not so important
a change.

Also documented gc_mark.h in some places where things were unclear to me.  I took a hard look to see whether attvs were properly marked.  It looks like they are, so somebody did some careful work.
----------------------------
revision 1.7
date: 2005/01/14 18:31:37;  author: ruim;  state: Exp;  lines: +20 -20
Integration of multithreaded system
----------------------------
revision 1.6
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +5 -5
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.5
date: 2002/05/22 15:41:17;  author: lfcastro;  state: Exp;  lines: +14 -13
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.4
date: 2001/04/28 20:15:37;  author: ejohnson;  state: Exp;  lines: +2 -2
branches:  1.4.4;
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.3
date: 2000/07/31 20:27:59;  author: ejohnson;  state: Exp;  lines: +2 -1
branches:  1.3.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.2
date: 2000/06/26 19:09:27;  author: ruim;  state: Exp;  lines: +2 -3
Getting XSB to compile under g++ AGAIN
----------------------------
revision 1.1
date: 2000/06/25 16:59:18;  author: ejohnson;  state: Exp;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.3.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.4.4.5
date: 2004/12/14 08:47:06;  author: ruim;  state: Exp;  lines: +3 -3
added dynamic stacks to thread context
----------------------------
revision 1.4.4.4
date: 2004/11/24 21:53:27;  author: ruim;  state: Exp;  lines: +4 -4
made smBTHT and smBTN thread specific
----------------------------
revision 1.4.4.3
date: 2004/11/22 23:07:38;  author: ruim;  state: Exp;  lines: +17 -17
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.4.4.2
date: 2004/10/18 20:46:22;  author: ruim;  state: Exp;  lines: +14 -13
update for version 2.6.1
----------------------------
revision 1.4.4.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.12.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.12.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.12.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tries.c,v
Working file: tries.c
head: 1.168
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.131
	ROLLBACK: 1.124
	latest_plus_supp_branch: 1.120.0.2
	latest_plus_supp: 1.120
	Version_3dot2_plus_supp: 1.115.0.2
	release_2_6_plus_supp: 1.62.0.4
	Version_3dot2: 1.115
	dec07-perf-results: 1.108
	mt_thesis: 1.90
	release_3_0: 1.87
	release_2_7_0: 1.63
	multi-threaded-26-engine: 1.57.4.9
	pre-mt: 1.63
	multi-threaded-25-engine-done: 1.57.4.1
	multi-threaded-25-engine: 1.57.0.4
	release_2_6_1: 1.62
	release_2_6_final: 1.62
	release_2_6: 1.62.0.2
	last-merged-to-demand: 1.61
	demand_branch: 1.61.0.2
	before_removing_chat: 1.57
	release_2_5: 1.57
	pre-merge-slgwam-gc: 1.57
	multi-threaded-c-engine: 1.57.0.2
	release_2_4: 1.57
	release_2_3: 1.55
	multi-threaded-engine: 1.55.0.2
	pre-threading: 1.51
	release-2-2: 1.46
	chat-and-local: 1.46.0.2
	xsb-pre-cleanup: 1.46
	release-2-1: 1.41
	release-2-0-1: 1.39
	subsumption: 1.27
	without-attv: 1.22
	release-2-0: 1.14
	pre-release-2-0: 1.13
	v1-9-8: 1.11
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 189;	selected revisions: 189
description:
----------------------------
revision 1.168
date: 2012/07/30 13:36:02;  author: dwarren;  state: Exp;  lines: +4 -3
Changed declaration of depth_limit to unsigned to avoid compiler warning.
----------------------------
revision 1.167
date: 2012/07/25 23:17:37;  author: tswift;  state: Exp;  lines: +115 -36

Bounded rationality for answer depth (ifdeffed out)
----------------------------
revision 1.166
date: 2012/05/08 15:00:28;  author: tswift;  state: Exp;  lines: +2 -2

Fixed long-standing buglet that mistakenly labled the trie type of a
node as interned in one particular case.
----------------------------
revision 1.165
date: 2012/05/01 21:21:10;  author: dwarren;  state: Exp;  lines: +4 -3
Removed unnecessary passing of answer_node variable to
handle_incrementally_rederived_answer and made it a local variable
instead.
----------------------------
revision 1.164
date: 2012/04/26 18:19:27;  author: tswift;  state: Exp;  lines: +72 -59

Updates so that incremental tabling works with full WFS.

Also refactored the incremental tabling code a little.
----------------------------
revision 1.163
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +20 -20

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.162
date: 2012/02/03 21:53:09;  author: tswift;  state: Exp;  lines: +3 -1

Deleting partially added answer branch on failure -- it had been
deleted on error, but I forgot to do so here.
----------------------------
revision 1.161
date: 2012/01/23 02:37:08;  author: tswift;  state: Exp;  lines: +13 -16
Change to slightly increase the initial stack amounts.

Main changes were to C printing routines.  Error messages now
mark cycles in terms as <cyclic> before printing these terms out.
Print routines also all observe Maxtermbuffer size so that they
won't overflow the buffer.  In addition, they now observe the
write_depth flag.  So these routines should be much more stable.
----------------------------
revision 1.160
date: 2012/01/12 14:36:40;  author: dwarren;  state: Exp;  lines: +6 -6
Changed several sprint_'s to sprint_cyclic_'s, just for safety.
----------------------------
revision 1.159
date: 2011/11/28 01:17:39;  author: tswift;  state: Exp;  lines: +23 -10

C printing of cyclic terms + utility predicate that backtrackably
marks a cycle within a term so that it can be printed, copied, etc.

Also, a few changes to get rid of compiler errors for MT.
----------------------------
revision 1.158
date: 2011/11/12 00:33:31;  author: tswift;  state: Exp;  lines: +64 -20

Added depth check for interned tries -- use tabled answer depth /
action flags.
----------------------------
revision 1.157
date: 2011/11/09 02:28:19;  author: dwarren;  state: Exp;  lines: +15 -13
Changed unify to unify cyclic terms without going into an infinite loop.

Also fixed some calls to print term that gave too large a level parameter
which caused overflow of C runstack.
----------------------------
revision 1.156
date: 2011/10/29 23:27:59;  author: tswift;  state: Exp;  lines: +40 -33

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.155
date: 2011/10/19 22:51:29;  author: tswift;  state: Exp;  lines: +3 -2

Changes to C trace to indicate the state of a tabled subgoal (new/complete/incomplete)
also emitting where an error was called from.

Also, some small change to get call abstracting compiling under MSVC.
----------------------------
revision 1.154
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +101 -57

Integrating in Call Abstraction
----------------------------
revision 1.153
date: 2011/08/27 20:58:51;  author: tswift;  state: Exp;  lines: +2 -2

Need to allocate a bigger buffer to accord with use of the sprint_term()
----------------------------
revision 1.152
date: 2011/08/12 15:17:13;  author: tswift;  state: Exp;  lines: +5 -5

Fixes for approximate tabling and correcting memory errors.
----------------------------
revision 1.151
date: 2011/08/03 18:12:54;  author: tswift;  state: Exp;  lines: +116 -3

Added Call abstraction stuff (mostly commented out).
----------------------------
revision 1.150
date: 2011/06/26 21:02:10;  author: tswift;  state: Exp;  lines: +9 -11
Support for C-level trace.
----------------------------
revision 1.149
date: 2011/06/05 19:24:03;  author: tswift;  state: Exp;  lines: +54 -12



Changes to

1) Add flag-controlled answer depth checks to variant answer
tables.  (See current_prolog_flag in the manual for details).

2) In support of 1, added sprint_term, which prints a term to a C
string.  This is useful for errors and warnings invoked by C.

3) Added MAXTOINDEX_FLAG, which allows experimentation with the
depth of * indexing.

4) Increased the initial size strbuff from 1000 -> 10000.  This
reduces spurious long atom warnings.
----------------------------
revision 1.148
date: 2011/06/02 22:29:23;  author: tswift;  state: Exp;  lines: +154 -96
Changes	to add stack expansion so that arbitrary numbers of
variables are allowed in interned, asserted tries and tables.

This uncovered a bug.

The problem arose when a conditional answer is interned in the
answer trie and that conditional answer contains variables both
in the answer head and the delay list, and there are variables in
the answer head that are not in the delay list. What happened was
that when the variables were interned in delay_trie_chk_insert,
the mini-trail that the trie routines use for standardizing
variables was reset.  This meant that the variables in the answer
head were not being properly untrailed and, due to the particular
way that variables are standardized, variables were bound to each
other that shouldn't have been, and in this case a circular
dereferencing chain arose, so that XSB hung.  I have no idea why
the bug was uncovered just now.
----------------------------
revision 1.147
date: 2011/05/28 15:18:46;  author: tswift;  state: Exp;  lines: +56 -56

tc_insts -- restricted some scaffolding to NON_OPT_COMPILE
tries    -- changed some variable names to be less confusing (maybe just to me...)
----------------------------
revision 1.146
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +16 -16
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.145
date: 2011/05/13 16:23:45;  author: tswift;  state: Exp;  lines: +8 -5

Making error types consistent between get_call and get_calls.
----------------------------
revision 1.144
date: 2011/03/05 19:05:30;  author: tswift;  state: Exp;  lines: +9 -5
Better error message when max call term depth exceeded.
----------------------------
revision 1.143
date: 2011/01/09 22:30:16;  author: tswift;  state: Exp;  lines: +10 -62

Minor code cleanup: some changes in documentation, changes to make a
function name accord with a builtin name, and moved some table
abolishing routines from tries.c to tr_utils.c with all the others.
----------------------------
revision 1.142
date: 2011/01/09 00:52:34;  author: tswift;  state: Exp;  lines: +41 -33

Mostly changes to documentation as I understand better the handling of
substitution factors and attvars.  Also a little code cleanup.
----------------------------
revision 1.141
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +37 -77

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.140
date: 2010/12/23 18:47:55;  author: tswift;  state: Exp;  lines: +3 -2

Added macro that will make it easier to add abstraction records.
----------------------------
revision 1.139
date: 2010/12/18 00:01:27;  author: tswift;  state: Exp;  lines: +13 -13
changed the names of some data structures whose names had confused me.
----------------------------
revision 1.138
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +23 -23

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.137
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +12 -12

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.136
date: 2010/12/16 16:47:13;  author: tswift;  state: Exp;  lines: +2 -2
Changed the name of VarVectorLoc to the more meaningful (to me) AnsTempl
----------------------------
revision 1.135
date: 2010/12/15 18:57:02;  author: tswift;  state: Exp;  lines: +2 -2

changed a stray printf to a warning.  Actually, we should do a better
job of checking for heap overflows when returning answers, so this is
just a minor band-aid.
----------------------------
revision 1.134
date: 2010/12/09 18:40:14;  author: tswift;  state: Exp;  lines: +33 -40

Cleaned up some documentation for variant_call_search and changed the
name of a variable in the program (which believe it or not, helps me
understand the function).
----------------------------
revision 1.133
date: 2010/12/09 17:55:53;  author: tswift;  state: Exp;  lines: +2 -2

Changed CallLUR_VarVector to CallLUR_AnsTempl, which is much more
meaningful (to me, at least).
----------------------------
revision 1.132
date: 2010/11/20 16:37:03;  author: dwarren;  state: Exp;  lines: +4 -5
Seeming bug found by Spyros.  It fixes a problem he had, and it seems innocuous
under the stated assumptions there.
----------------------------
revision 1.131
date: 2010/09/05 18:47:17;  author: tswift;  state: Exp;  lines: +3 -3

Fixes to make incremental tabling work properly when opaque is
switched to incremental.  I had made a fix to predicate_property to
distinguish incremenel from opaque that apparently broke things.
----------------------------
revision 1.130
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +3 -3
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.129
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.128
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.127
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.126
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.125
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +3 -3
no message
----------------------------
revision 1.124
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.123
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.122
date: 2010/06/22 23:30:55;  author: spyrosh;  state: Exp;  lines: +2 -2
Backed out code
----------------------------
revision 1.121
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +3 -3
Dipti's code for support graph added
----------------------------
revision 1.120
date: 2010/04/03 16:09:43;  author: tswift;  state: Exp;  lines: +5 -3
branches:  1.120.2;

Changed depth_ctr from an int to a Cell.  depth_ctr may be set from
flags, which is a cell, and the conversion from Cell to int caused
problems on 64-bits.

Also, there is a declaration for deleted answes, which may be
temporary (and is commented as such).
----------------------------
revision 1.119
date: 2010/03/18 22:22:17;  author: tswift;  state: Exp;  lines: +16 -4

Added subgoal depth check with actions of fail and error (cf pg. 165 of the manual)
----------------------------
revision 1.118
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.117
date: 2009/11/16 15:49:21;  author: tswift;  state: Exp;  lines: +10 -1

tries.c -- fixed (sort of) a heap-overflow bug when returning large
answers with delay lists.

sub_tables_xsb.i and tables.c -- just some code cleanup.
----------------------------
revision 1.116
date: 2009/11/08 18:29:22;  author: tswift;  state: Exp;  lines: +25 -53

No functionality changes -- just some name changes and simplifications
in preparation for my trip to Portugal.

These were mostly name changes, but I did get rid of a few functions
-- not for efficiency but for simplicity.
----------------------------
revision 1.115
date: 2009/01/24 22:18:22;  author: tswift;  state: Exp;  lines: +3 -3
... and another one ...
----------------------------
revision 1.114
date: 2009/01/02 17:50:03;  author: tswift;  state: Exp;  lines: +9 -6


Updating a number of files so that delete_branch() will work with call
subsumption (it needs to know that it deallocates BTNs rather than
TSTNs).  This fixed a latent bug in simplification and allows another
test to be run for call subsumption. It also provides a step towards
supporting answer subsumption on call subsumptive tables.  There are
also some other documentationstyle changes.

Adding a new test for copying attributed variables into delay elements
/ lists.  I hadn't thought this worked, but apparently it does !

Also, I'm adding a very simple test for incremental evaluation -- more
cases need to be added here, but at least this is a start.
----------------------------
revision 1.113
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +8 -6


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.112
date: 2008/08/27 22:06:35;  author: tswift;  state: Exp;  lines: +6 -3

Fix so that if a dynamic predicate is tabled with no clauses,
get_calls fails rater than throwing a permission error.

----------------------------------------------------------------------
----------------------------------------------------------------------
----------------------------
revision 1.111
date: 2008/03/10 16:21:50;  author: dwarren;  state: Exp;  lines: +4 -2
Fix bug in addintfastasgn instruction (to trail if binding to a variable.)
Also a cuple of comments to indicate where memory problems are wrt delay lists
(which may reduce search time the next time this bug shows up....)
----------------------------
revision 1.110
date: 2007/12/24 19:17:00;  author: tswift;  state: Exp;  lines: +9 -29

Major changes for new trie API and trie handling routines that allow
different kinds of tries, and both shared and private tries. -- all
this is explained in the new documentation in the manual.

In addition, I'm piggy-backing a few small changes onto this
update.  I added a portray_attributes hook to the interpreter for
attributed variables, and a simple ISO flag.
----------------------------
revision 1.109
date: 2007/12/10 17:02:04;  author: ruim;  state: Exp;  lines: +7 -1
ifdefed out another counter
----------------------------
revision 1.108
date: 2007/12/10 05:35:26;  author: ruim;  state: Exp;  lines: +2 -10
small code refactoring
----------------------------
revision 1.107
date: 2007/12/09 18:41:38;  author: ruim;  state: Exp;  lines: +25 -1
Removed global counters for stastics (including mem space values)
from multi-threaded system if not in debug mode.
Those counters were hurting scalability on a multi-processor badly
----------------------------
revision 1.106
date: 2007/12/06 23:24:55;  author: ruim;  state: Exp;  lines: +2 -2
replaced shared struct manangers with malloc
which improves scalabilty on a multi-processor

that required a number of small fixes to have coherency
between shared and private struct managers
----------------------------
revision 1.105
date: 2007/11/20 19:17:21;  author: tswift;  state: Exp;  lines: +3 -2


Added new private structure managers for trie asserted and
trie_interned code.  This is an important change in that I
changed the default structure managers for trie-asserted code
from shared to private.  So this means that we won't have
thread-shared trie asserted code for a while -- however I dont
thing that anyone is using this function yet, and if they did
they'd probably get a core dump before long.

Partial implementation of thread-shared interned tries.  There is
now a shared interned trie table and a private interned trie
table.  My experiences in interned tries should help out in
making thread-shared trie asserted code.
----------------------------
revision 1.104
date: 2007/10/26 22:47:33;  author: tswift;  state: Exp;  lines: +5 -5

Changes to support new ISO mutex_property.

tr_utils.c tries.c -- changes are comments
----------------------------
revision 1.103
date: 2007/08/08 17:50:52;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.102
date: 2007/07/18 01:20:26;  author: evansbj;  state: Exp;  lines: +5 -5
gcc-mp-4.1 does not like using 'vector' for a variable name
----------------------------
revision 1.101
date: 2007/07/12 22:53:03;  author: tswift;  state: Exp;  lines: +4 -4
Added contexts for heap overflow check functions

Added queue aliases to message_queue_create, thread_send_message, and
thread_queue_message.

Added mutex aliases for all mutex functions to make them consistent with ISO working group.

Made default maximum queue terms a changeable XSB flag.

Wrote Prolog stub for message_queue_destroy

Manual updated, and mttest suite changed.
----------------------------
revision 1.100
date: 2007/07/12 14:38:02;  author: dwarren;  state: Exp;  lines: +47 -9
Added heap overflow tests for copying terms out of tries from leaf to root.
This is done when returning answers from non-completed tables or when calling
interned with the leaf address bound.
----------------------------
revision 1.99
date: 2007/06/10 18:43:58;  author: tswift;  state: Exp;  lines: +2 -6

Made the array of interned tries an array of structures rather than an
array.  This helps fix some problems with core dumps in accessing
deleted tries.  In addition, I started doing some error checking (as
long as I could do it efficiently), which led to changing around a
number of the error checking routines -- so we now have an
iso_ctop_int with ISO-style error checking.

Also, I uncovered and fixed a bug in the storage module's use of
interned tries in the MT engine.

In the course of these changes, I do not yet have the trie array
expandable -- I'll put that in ASAP.
----------------------------
revision 1.98
date: 2007/06/06 20:43:19;  author: tswift;  state: Exp;  lines: +3 -3

Trey Evan's updates for 64-bits.
----------------------------
revision 1.97
date: 2007/06/01 22:47:10;  author: tswift;  state: Exp;  lines: +2 -2

A number of changes in this update.

1) there are changes to allow transitive subgoal abolishes for tables
with conditional answers.  If a subgoal S is abolished, then all
subgoals that (transitively) depend on S, positively or negatively,
will be abolished by default in order to prevent core dumps when
examining the residual program.  Only backward dependencies are
abolished -- forward dependencies do not cause a problem.

The transitive actions of the abolish can be turned off either by
a new xsb_flag or by calling a new predicate
abolish_table_call/2.

While testing these changes I discovered and fixed an obscure bug --
the table abolish CPS checks could not find the trie nodes when a
hash_handle choice point was on the choice point stack.  The result
was that not all tables with choice points were found when the CPS was
traversed.

2) There are similar changes to allow transitive predicate
abolishes for tables with conditional answers.  This is analogous
to the subgoal case above, but while doing this I discovered
another obscure bug.  It turns out that freeing a subgoal
frame (Free_Producer_SF()) changed the subgoal list that hung off
of the TIF.  This is the right action if space is reclaimed
immediately for a tabled predicate or subgoal, but this action should not be
done during garbage collection as the value of the subgoal list
off of the tif is for an entirely new set of tabled subgoals --
not the ones being reclaimed.

Both of these changes were a good excuse for (or required) refactoring
the table abolish and gc code.

Additions were made to the sequential and multi-threaded test suite to
test out the new functionality.

This update also includes some changes to interned tries that I
started in order to allow shared interned tries in the mt engine.
These aren't finished, but the interned trie code is in a consistent
state, so the update won't hurt anything.  They also included some
consistent but unfinished changes in alias handling.
----------------------------
revision 1.96
date: 2007/04/06 11:41:48;  author: tswift;  state: Exp;  lines: +6 -2
Changes and additions to comments only (since at least Barry reads the comments :-)
----------------------------
revision 1.95
date: 2007/04/05 17:26:57;  author: tswift;  state: Exp;  lines: +104 -13
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.94
date: 2007/02/22 00:16:07;  author: tswift;  state: Exp;  lines: +77 -12


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.93
date: 2007/02/09 18:12:17;  author: dwarren;  state: Exp;  lines: +3 -1
Improvements to the incremental table maintenance interface.
A couple of other minor changes.
----------------------------
revision 1.92
date: 2007/01/25 20:33:56;  author: tswift;  state: Exp;  lines: +8 -3


Changes to add multi-threading to the C-Calling XSB interface --
in particular the new interface allows different calling threads
to use different XSB threads by explicitly manipulating thread
contexts, and allowing threads to go into the xcallxsb.P command
loop.  See Vol 2 Chapter 3 for details.
----------------------------
revision 1.91
date: 2006/12/14 19:38:07;  author: tswift;  state: Exp;  lines: +42 -1
Changes to handle uninitialized/freed data in tabling delay lists and in garbage colleting data.
----------------------------
revision 1.90
date: 2006/12/07 00:26:46;  author: tswift;  state: Exp;  lines: +13 -3

-- Added reclamation of conditional answer information (including
   subgoal PNDEs and delay tries) when variant predicates/subgoals are
   abolished in abolish_table_pred/1, abolish_table_call/1, and
   close_open_tables/0.  Also, wrote delete_delay_trie() to delete
   answer substitution factor for delay elements, and made sure this
   was used whenever des are reclaimed -- (e.g. by abolishes and
   simplifications).

-- fixed some bugs in MT engine where situations could arise where
   trie allocation type was not properly set before abolishes called
   in table gc sweeps or reloading tabled predicates.

-- Fixed numerous bugs in performing simplification in the MT engine.
   In general simplification routines may reclaim structures for delay
   lists, delay elements, answer branches, asis and pndes.  Whenever
   any of these structures are reclaimed in the MT engine a check must
   be made to determine whether these elements use private or shared
   memory management -- either struture managers or the managers for
   des/dls/pndes.  Keeping all of this straight required some thinking
   as the code flits from table to table by traversing pndes --
   however I think I was able to extend the code without undue mess
   (at least this time :-)
----------------------------
revision 1.89
date: 2006/11/06 10:31:39;  author: ruim;  state: Exp;  lines: +2 -2
Changed counter to unsigned long
Changed several counting variables to unsigned
Fixed a wrong thing in previous memory_xsb.c fix
----------------------------
revision 1.88
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +41 -1
Incremental Code Added.
----------------------------
revision 1.87
date: 2006/05/22 14:53:44;  author: dwarren;  state: Exp;  lines: +3 -1
Added check for heap having overflowed and abort if so.  Should figure out how to check
if it will overflow and expand in case.  This is just a stop-gap but will at least
tell what happened.
----------------------------
revision 1.86
date: 2006/04/17 20:54:58;  author: tswift;  state: Exp;  lines: +1 -5

Changes for gc of dynamic code.

At a broad level, upon retract, retractall, abolish, or gc of
dynamic clauses

  1) a check is made to determine whether it is safe to reclaim
     the space of the clause(s).  If so, the space is reclaimed
     immediately, if not the clause(s) are marked for deletion,
     and a frame for them put onto a list for later gc.  Safety
     is ensured when:

     a) The predicate is private OR there is a single active thread
     AND
     b) a check of the CP stack determines that it is safe to
     reclaim spaces for the predicate,
     AND
     c) if the predicate is tabled, there is no incomplete table
     for that predicate.

   2) gc is invoked upon the top-level interpreter, in
      gen_retractall(), and can be invoked manually.  I'm open to
      other suggestions on when to invoke it.

   3) I've tested it a fair amount (see the updates in retract tests,
      and please update the tests if you're a developer), but given
      private and shared predicates, various indexing mechanisms, and
      tabled dynamic predicates, there could be some interactions that
      I didn't account for.

   4) I'll be making a few more changes over the next week,
      particularly for gc-ing in the MT environment and in making
      non-"abolish" retractalls more efficient.

   5) I have not changed the semantics of assert/retract.  There are a
      lot of arguments in favor of going to an ISO-style semantics,
      but I wanted to get this gc in.

   6) retract_nr/1 and reclaim_space/1 are now obsolete, although I've
      left the code around for compatability.
----------------------------
revision 1.85
date: 2006/02/16 18:32:50;  author: dwarren;  state: Exp;  lines: +4 -4
Fixed a memory bug that showed up when newly needed memory was more than twice
previous memory.  Showed up in trie_interned.  Added explicit argument to
memory allocator to provide needed amount.
----------------------------
revision 1.84
date: 2006/01/24 14:10:01;  author: tswift;  state: Exp;  lines: +3 -3

Got rid of check_table_cut, a global that was unnecessary and not thread-safe.

Also, put a mutex around handling of dispatch blocks in asserted code, using a new mutex MUTEX_DISPBLKHDR.
----------------------------
revision 1.83
date: 2006/01/12 21:33:53;  author: tswift;  state: Exp;  lines: +6 -4
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.82
date: 2006/01/09 00:06:33;  author: tswift;  state: Exp;  lines: +30 -7
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.81
date: 2005/12/22 23:34:01;  author: tswift;  state: Exp;  lines: +3 -3

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.80
date: 2005/12/07 13:23:03;  author: ruim;  state: Exp;  lines: +5 -5
removed rw lock from tries in Multi-threaded engine
----------------------------
revision 1.79
date: 2005/11/16 17:32:06;  author: dwarren;  state: Exp;  lines: +21 -15
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.78
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +5 -5
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.77
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +2 -2
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.76
date: 2005/11/08 01:05:16;  author: tswift;  state: Exp;  lines: +11 -5

Documentation changes only -- how attvs are traversed in variant_call_search and the setup for using trie instructions on completed tables.
----------------------------
revision 1.75
date: 2005/11/01 00:36:20;  author: tswift;  state: Exp;  lines: +30 -35

These changes continue the documentation effort on trie routines for variant tabling, as well as handling attributed variables from within tries.

In terms of changing code, I did change arity in variant_answer_search to sf_size, and took out what seem to be two unnecessary heap assignments for attributed variables.
----------------------------
revision 1.74
date: 2005/10/29 00:04:46;  author: tswift;  state: Exp;  lines: +24 -2

It turns out that while we keep track of variables in delay lists, we do not
keep track of attributed variables in delay lists.  There are a number of cases to consider, depending on how the delayed variable is introduced into a delay list (via a subgoal call, answer template, or binding to an answer from within the body of a clause.  This takes care of one case, with more to follow, along with some testscript files.
----------------------------
revision 1.73
date: 2005/10/28 21:50:29;  author: tswift;  state: Exp;  lines: +60 -29

These changes are for documentation only, before I go ahead and fiddle around with some trie stuff.
----------------------------
revision 1.72
date: 2005/10/27 16:33:40;  author: tswift;  state: Exp;  lines: +38 -19

Committing changed/added documentation only.
----------------------------
revision 1.71
date: 2005/10/21 17:47:52;  author: tswift;  state: Exp;  lines: +38 -24


These are documentation changes only, made while stumbling through unfamiliar code.  I wanted to get them in before I started to make code changes.
----------------------------
revision 1.70
date: 2005/09/12 18:20:37;  author: tswift;  state: Exp;  lines: +1 -5

Some changes to move some info I put into a threads context into a function, so the info is no longer "global".  Also, fixed interned tries so that they are now thread-local.
----------------------------
revision 1.69
date: 2005/09/12 01:09:33;  author: tswift;  state: Exp;  lines: +7 -3

Tonight's changes were to clean up global data structures used to
clean up tries.  This time I was able to make data structures used in deleting
asserted and interned tries, local to the relevant function.  In addition,
I put into the MT context data structures used to manage an array of interned
tries.

Of course, there's more work to allow asserted and interned tries to be used in multi-threading -- but these changes will hopefully save us from one danger, at least.
----------------------------
revision 1.68
date: 2005/09/11 01:29:39;  author: tswift;  state: Exp;  lines: +6 -2

In tonights exciting installment, I made info about the freeing stack thread specific, since this array is used to deallocate tables.  Its called on thread exit to deallocate private tables, so we'd core dump sooner or later if we kept
freeing_stack as a global.
----------------------------
revision 1.67
date: 2005/09/01 18:37:07;  author: tswift;  state: Exp;  lines: +36 -3


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.66
date: 2005/08/08 17:11:36;  author: dwarren;  state: Exp;  lines: +3 -3
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.65
date: 2005/07/18 19:47:46;  author: tswift;  state: Exp;  lines: +2 -3

picayune (my word for the day) changes in predicate names and a little added documentation
based on reviewing abolish_table_pred and friends.
----------------------------
revision 1.64
date: 2005/01/14 18:31:38;  author: ruim;  state: Exp;  lines: +144 -63
Integration of multithreaded system
----------------------------
revision 1.63
date: 2004/12/20 17:43:07;  author: tswift;  state: Exp;  lines: +3 -1
Fixed bug that arises when returning attvs out of incomplete tables.
----------------------------
revision 1.62
date: 2002/11/05 20:50:38;  author: lfcastro;  state: Exp;  lines: +3 -3
* First cut at an implementation for abolish_table_call/1.
  - at this point, this call deletes all subsuming tables of a given
  term, via backtracking; what is the desired semantics?

*** WARNING ***
This is not a "safe" operator. It does not perform any kind of
checking, so one may, in fact, delete a table which is in use. This
may cause undefined behavior (i.e. segmentation faults and the like).
----------------------------
revision 1.61
date: 2002/05/31 18:17:46;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.61.2;
* got rid of some warning messages
----------------------------
revision 1.60
date: 2002/05/31 15:09:03;  author: lfcastro;  state: Exp;  lines: +12 -12
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.59
date: 2002/05/22 15:41:17;  author: lfcastro;  state: Exp;  lines: +14 -22
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.58
date: 2002/03/12 17:31:22;  author: lfcastro;  state: Exp;  lines: +1 -10
* Removal of Chat engine
----------------------------
revision 1.57
date: 2001/04/28 20:15:37;  author: ejohnson;  state: Exp;  lines: +5 -5
branches:  1.57.4;
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.56
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +2 -2
improved error messages
----------------------------
revision 1.55
date: 2000/07/31 20:27:59;  author: ejohnson;  state: Exp;  lines: +58 -58
branches:  1.55.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.54
date: 2000/06/28 16:54:54;  author: ruim;  state: Exp;  lines: +4 -4
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.53
date: 2000/06/25 16:59:18;  author: ejohnson;  state: Exp;  lines: +9 -11
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.52
date: 2000/06/23 20:54:09;  author: ruim;  state: Exp;  lines: +8 -8
Removed some C++ automatic pointer casting warnings
----------------------------
revision 1.51
date: 2000/06/17 23:26:13;  author: kifer;  state: Exp;  lines: +9 -2
fixed bugs having to do with trie_retract_nr
----------------------------
revision 1.50
date: 2000/05/29 04:23:40;  author: ejohnson;  state: Exp;  lines: +11 -10
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.49
date: 2000/05/25 00:32:05;  author: ejohnson;  state: Exp;  lines: +36 -33
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.48
date: 2000/05/20 06:56:12;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.47
date: 2000/04/29 21:54:01;  author: kifer;  state: Exp;  lines: +99 -75
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.46
date: 2000/01/11 17:10:53;  author: ejohnson;  state: Exp;  lines: +2 -2
branches:  1.46.2;
Change of single macro use.
----------------------------
revision 1.45
date: 2000/01/07 08:52:02;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.44
date: 2000/01/06 18:16:10;  author: cbaoqiu;  state: Exp;  lines: +14 -1
Initialize var_regs[] before executing the trie code in
trie_get_returns_for_call(), so that get_returns/2 works correctly
when there are attvs in the call.
----------------------------
revision 1.43
date: 1999/12/14 21:02:37;  author: ejohnson;  state: Exp;  lines: +28 -33
trie_get_returns_for_call() follows "producer" SF ptr first to ensure
finding an answer set from any given SF.

nstruct_ret() removed; same functionality is available through
build_ret_term() in tr_utils.c.

prototype for ux_call_info(), which hasn't existed for a while, is
removed.
----------------------------
revision 1.42
date: 1999/12/10 07:47:43;  author: kifer;  state: Exp;  lines: +6 -3
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.41
date: 1999/11/17 21:52:13;  author: cbaoqiu;  state: Exp;  lines: +3 -2
Really got rid of ls_top and ls_bot: Ernie's change made them
undeclared.
----------------------------
revision 1.40
date: 1999/11/17 17:42:02;  author: ejohnson;  state: Exp;  lines: +2 -4
Warning fixes, noticed under 64-bit mode compilation:
- type mismatches, in assignment and print formats
- unused variables
----------------------------
revision 1.39
date: 1999/11/07 22:40:54;  author: cbaoqiu;  state: Exp;  lines: +88 -73
1) Added `case ATTV:' in one_term_chk_ins() to support attributed
variables in trie_assert/1; 2) Added one line to correctly initialize
attv_ctr in variant_answer_search() (fixed a potential bug).
----------------------------
revision 1.38
date: 1999/11/06 04:33:02;  author: cbaoqiu;  state: Exp;  lines: +75 -54
Modified whole_term_chk_ins() to support attributed variables in
trie_intern; Fixed a potential bug in rec_macro_make_heap_term.
----------------------------
revision 1.37
date: 1999/11/05 03:52:12;  author: cbaoqiu;  state: Exp;  lines: +1 -3
Changed some lines used for debugging attv.
----------------------------
revision 1.36
date: 1999/10/29 10:40:19;  author: kostis;  state: Exp;  lines: +1 -2
minor cleanup.
----------------------------
revision 1.35
date: 1999/10/26 21:32:51;  author: kostis;  state: Exp;  lines: +8 -2
Modified remove_open_tries() to reclaim CHAT areas too.
----------------------------
revision 1.34
date: 1999/10/26 20:31:35;  author: warren;  state: Exp;  lines: +4 -1
Added check to cut to abort if cutting over a table.
----------------------------
revision 1.33
date: 1999/10/26 17:25:07;  author: cbaoqiu;  state: Exp;  lines: +27 -7
Changed the substitution factor of the call in CHAT to support attributed
variables: 1) The arity cell now also contains the number of
attributed variables in the call; 2) Each element of the substitution
factor is a REF cell, NOT a FREE variable.
----------------------------
revision 1.32
date: 1999/10/26 06:47:33;  author: kifer;  state: Exp;  lines: +5 -5
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.31
date: 1999/10/25 05:59:55;  author: kifer;  state: Exp;  lines: +5 -5
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.30
date: 1999/10/19 02:48:57;  author: cbaoqiu;  state: Exp;  lines: +225 -160
Changed variant_answer_search() and trie code instructions to handled
attributed variables.
----------------------------
revision 1.29
date: 1999/10/18 21:50:14;  author: cbaoqiu;  state: Exp;  lines: +270 -228
1) Renamed CallVarEnum back to VarEnumerator (after a long discussion
   with Ernie);
2) Renamed IndexOfStandardizedVariable to IndexOfStdVar;
3) Added more changes for attributed variables (around variant_call_search).
----------------------------
revision 1.28
date: 1999/10/16 03:00:56;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Correctly set the prototype of function variant_answer_search().
----------------------------
revision 1.27
date: 1999/10/15 02:54:15;  author: cbaoqiu;  state: Exp;  lines: +11 -2
Changed functions table_consume_answer() and load_solution_trie() to
take one more argument, attv_num (the number of attributed variables
in the substitution factor).
----------------------------
revision 1.26
date: 1999/10/13 15:09:58;  author: ejohnson;  state: Exp;  lines: +5 -1
Put back comment inadvertently left out.
----------------------------
revision 1.25
date: 1999/10/13 14:53:33;  author: ejohnson;  state: Exp;  lines: +84 -166
Modified definitions of trie-component abstractions.  This was needed
to avoid ANSI incompatibility: casting on LHS of stmt.  Some of these
defs were moved from trie_internals.h.  These changes propogated into
macros which used these defs.

Specialized uses of array VarEnumerator[] into two separate arrays:
tracking call variables, CallVarEnum[], and tracking bindings to trie
vars, TrieVarBindings[].  These two arrays are needed simultaneously
during answer retrieval.

Added Structure_Manager decls for TST components.  Answer list node
Structure_Manager moved to tables.c.  Subgoal Frames are under
Structure_Manager control now.

Trie statistical routines subsumed by newer routines in table_stats.c.

abolish_trie() replaced by release_all_tabling_resources() in
tables.c.

Use of modified macros; standardized name of answer check/insert op:
variant_answer_search().

Fix counting for call inserts.

Moved CHAT answer template heap-shift to table_call_search() in
tables.c, since this is also needed for subsumptive call check/insert
op.
----------------------------
revision 1.24
date: 1999/10/12 20:28:05;  author: kostis;  state: Exp;  lines: +8 -1
Clean up and localization of variables changes.
----------------------------
revision 1.23
date: 1999/10/09 18:37:52;  author: kostis;  state: Exp;  lines: +2 -3
Cleanup changes so that variables are declared and appear only in places
where they are actually needed.  Expect speed-up by doing so.
Also, finally, ugly xtemp[3-15] variables were eliminated.
Sorry, Terry !
----------------------------
revision 1.22
date: 1999/10/05 04:02:01;  author: kifer;  state: Exp;  lines: +2 -2
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
----------------------------
revision 1.21
date: 1999/09/18 04:39:49;  author: cbaoqiu;  state: Exp;  lines: +22 -8
Put some delay-variable stuff into ``#ifndef IGNORE_DELAYVAR'' (to
help Kostis debug).  By doing this, we make sure that no substitution
factor of the answer is put into the heap.  [To disable delay-variable
handling, one can put ``#define IGNORE_DELAYVAR'' in the file
$XSB/emu/debugs/debug_delay.h.]
----------------------------
revision 1.20
date: 1999/09/03 04:18:22;  author: cbaoqiu;  state: Exp;  lines: +6 -6
Fixed a small bug in load_solution_trie(): always set
num_heap_term_vars as 0 in this function.
----------------------------
revision 1.19
date: 1999/08/16 07:24:41;  author: kifer;  state: Exp;  lines: +12 -12
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.18
date: 1999/08/04 14:42:11;  author: ejohnson;  state: Exp;  lines: +32 -31
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.17
date: 1999/07/22 19:06:48;  author: cbaoqiu;  state: Exp;  lines: +4 -4
Changed the way `mini_trail_top' is initialized to get rid of cc's
warning message on SGI -- ``Pointer points outside of underlying
object''.
----------------------------
revision 1.16
date: 1999/07/15 21:41:23;  author: ejohnson;  state: Exp;  lines: +195 -353
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.15
date: 1999/07/06 16:35:23;  author: ejohnson;  state: Exp;  lines: +527 -430
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.14
date: 1999/05/19 19:48:58;  author: warren;  state: Exp;  lines: +6 -10
Fixed problem in creating ret structure for returning the substitution
factor, by dereffing the components.
----------------------------
revision 1.13
date: 1999/04/13 17:24:47;  author: kostis;  state: Exp;  lines: +1 -12
Performed major clean-up and rationalization of the tabling builtins.
----------------------------
revision 1.12
date: 1999/02/23 10:50:41;  author: kostis;  state: Exp;  lines: +5 -5
Changes to tag number of substitution factor variables in the CP stack and
to considerably speed up garbage collection - many changes in heap.c.
----------------------------
revision 1.11
date: 1999/01/31 14:02:26;  author: kostis;  state: Exp;  lines: +55 -26
Mostly cleanup changes to simplify "tries.h".  Lots of junk code has been
removed and things that are not needed in other files have been moved to
"tries.c".
----------------------------
revision 1.10
date: 1999/01/29 20:52:57;  author: cbaoqiu;  state: Exp;  lines: +54 -50
Introduced a new array CPtr mini_trail[NUM_TRIEVARS] that is used as
the trail space when term are copied into tries.  Variables temp_trreg
and trie_tr_base were removed.  Also, in variant_trie_search(), a
minor change was made to prevent pointers pointing from heap to local
stack.
----------------------------
revision 1.9
date: 1999/01/29 04:18:33;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changed string_find("ret", 1) to ret_psc[0].  ret_psc[0] is set at the
time when the system is started.
----------------------------
revision 1.8
date: 1999/01/28 09:11:45;  author: cbaoqiu;  state: Exp;  lines: +9 -3
Changed the value of cell ans_var_pos_reg in variant_trie_search(), so
that it is integer 0 when the arity of the answer substitution factor
is 0.
----------------------------
revision 1.7
date: 1999/01/24 17:12:25;  author: kostis;  state: Exp;  lines: +38 -21
Important changes for CHAT: Substitution factor variables rectified so that
there are no references from heap to local stack variables.
----------------------------
revision 1.6
date: 1999/01/19 17:53:50;  author: kostis;  state: Exp;  lines: +48 -45
Fixed a compilation error on Dec Alpha and made some variables that are not
used outside this file "static".
----------------------------
revision 1.5
date: 1999/01/13 20:28:24;  author: kostis;  state: Exp;  lines: +11 -5
Changes to fix statistics.
----------------------------
revision 1.4
date: 1999/01/10 01:20:11;  author: cbaoqiu;  state: Exp;  lines: +56 -36
1. Set the values of global_num_vars and Last_Nod_Sav in functions
   bottomupunify() and whole_term_chk_ins().  Because they are needed
   in get_lastnode_cs_retskel().
2. Set delay_it to 0 in trie_get_returns_for_call().
3. Change function get_lastnode_and_retskel() to
   get_lastnode_cs_retskel().
----------------------------
revision 1.3
date: 1998/12/21 01:09:10;  author: cbaoqiu;  state: Exp;  lines: +434 -391
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:31:54;  author: cbaoqiu;  state: Exp;  lines: +293 -20
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  1. Global variable AnsVarCtr is added.
  2. variant_trie_search() is changed.
  3. recvariant_trie_ans_subsf is added.
  4. undo_answer_bindings(), delay_chk_insert(), and load_delay_trie()
     are added.
----------------------------
revision 1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.46.2.1
date: 2000/03/28 18:10:33;  author: lfcastro;  state: Exp;  lines: +2 -24
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.55.2.2
date: 2000/12/19 15:58:21;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.55.2.1
date: 2000/12/17 15:58:12;  author: ruim;  state: Exp;  lines: +59 -3
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.57.4.9
date: 2004/12/20 16:26:29;  author: ruim;  state: Exp;  lines: +19 -17
renamed mini_trail to VarEnumerator_trail and put it on thread context
----------------------------
revision 1.57.4.8
date: 2004/12/14 08:47:06;  author: ruim;  state: Exp;  lines: +2 -2
added dynamic stacks to thread context
----------------------------
revision 1.57.4.7
date: 2004/11/24 21:53:27;  author: ruim;  state: Exp;  lines: +18 -11
made smBTHT and smBTN thread specific
----------------------------
revision 1.57.4.6
date: 2004/11/24 16:45:33;  author: ruim;  state: Exp;  lines: +21 -1
add trie unlock choice point in trie_get_returns and trie_interned
----------------------------
revision 1.57.4.5
date: 2004/11/22 23:07:38;  author: ruim;  state: Exp;  lines: +2 -4
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.57.4.4
date: 2004/11/22 16:36:31;  author: ruim;  state: Exp;  lines: +2 -1
added lock on struct manager
----------------------------
revision 1.57.4.3
date: 2004/11/18 16:03:26;  author: ruim;  state: Exp;  lines: +22 -1
put backtrack unlock on tries in get calls
----------------------------
revision 1.57.4.2
date: 2004/10/18 20:46:22;  author: ruim;  state: Exp;  lines: +16 -33
update for version 2.6.1
----------------------------
revision 1.57.4.1
date: 2004/09/29 19:44:22;  author: ruim;  state: Exp;  lines: +67 -35
Sources from rfm repository
----------------------------
revision 1.61.2.5
date: 2003/04/17 17:11:34;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.61.2.4
date: 2002/10/28 16:49:33;  author: lfcastro;  state: Exp;  lines: +3 -0
* Merge with HEAD
----------------------------
revision 1.61.2.3
date: 2002/08/08 12:53:19;  author: lfcastro;  state: Exp;  lines: +2 -2
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.61.2.2
date: 2002/08/07 17:53:29;  author: lfcastro;  state: Exp;  lines: +3 -3
* update to HEAD
----------------------------
revision 1.61.2.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +3 -3
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.120.2.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.120.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +2 -2
no message
----------------------------
revision 1.120.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tries.h,v
Working file: tries.h
head: 1.84
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.62
	ROLLBACK: 1.56
	latest_plus_supp_branch: 1.52.0.2
	latest_plus_supp: 1.52
	Version_3dot2_plus_supp: 1.49.0.2
	release_2_6_plus_supp: 1.29.0.10
	Version_3dot2: 1.49
	dec07-perf-results: 1.47
	mt_thesis: 1.44
	release_3_0: 1.40
	release_2_7_0: 1.29
	multi-threaded-26-engine: 1.29.8.5
	pre-mt: 1.29
	multi-threaded-25-engine-done: 1.29.8.1
	multi-threaded-25-engine: 1.29.0.8
	release_2_6_1: 1.29
	release_2_6_final: 1.29
	release_2_6: 1.29.0.6
	last-merged-to-demand: 1.29
	demand_branch: 1.29.0.4
	before_removing_chat: 1.29
	release_2_5: 1.29
	pre-merge-slgwam-gc: 1.29
	multi-threaded-c-engine: 1.29.0.2
	release_2_4: 1.29
	release_2_3: 1.29
	multi-threaded-engine: 1.28.0.2
	pre-threading: 1.25
	release-2-2: 1.22
	chat-and-local: 1.22.0.2
	xsb-pre-cleanup: 1.22
	release-2-1: 1.20
	release-2-0-1: 1.20
	subsumption: 1.18
	without-attv: 1.15
	release-2-0: 1.12
	pre-release-2-0: 1.12
	v1-9-8: 1.8
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 96;	selected revisions: 96
description:
----------------------------
revision 1.84
date: 2012/07/25 23:17:37;  author: tswift;  state: Exp;  lines: +11 -1

Bounded rationality for answer depth (ifdeffed out)
----------------------------
revision 1.83
date: 2012/06/03 17:27:01;  author: tswift;  state: Exp;  lines: +3 -1

Setting up to log negative calls.
----------------------------
revision 1.82
date: 2012/04/26 18:19:27;  author: tswift;  state: Exp;  lines: +15 -4

Updates so that incremental tabling works with full WFS.

Also refactored the incremental tabling code a little.
----------------------------
revision 1.81
date: 2012/03/11 00:55:47;  author: tswift;  state: Exp;  lines: +4 -3

Lazy incremental tabling + small rewrites and refactors of incremental
tabling code.
----------------------------
revision 1.80
date: 2012/03/01 21:26:49;  author: tswift;  state: Exp;  lines: +10 -4

Some documentation updates, changes to more meaningful names, and the
start of a function that might be used in lazy incremental tabling.
----------------------------
revision 1.79
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +2 -2

Integrating in Call Abstraction
----------------------------
revision 1.78
date: 2011/08/03 18:12:54;  author: tswift;  state: Exp;  lines: +33 -1

Added Call abstraction stuff (mostly commented out).
----------------------------
revision 1.77
date: 2011/06/02 22:29:23;  author: tswift;  state: Exp;  lines: +13 -7
Changes	to add stack expansion so that arbitrary numbers of
variables are allowed in interned, asserted tries and tables.

This uncovered a bug.

The problem arose when a conditional answer is interned in the
answer trie and that conditional answer contains variables both
in the answer head and the delay list, and there are variables in
the answer head that are not in the delay list. What happened was
that when the variables were interned in delay_trie_chk_insert,
the mini-trail that the trie routines use for standardizing
variables was reset.  This meant that the variables in the answer
head were not being properly untrailed and, due to the particular
way that variables are standardized, variables were bound to each
other that shouldn't have been, and in this case a circular
dereferencing chain arose, so that XSB hung.  I have no idea why
the bug was uncovered just now.
----------------------------
revision 1.76
date: 2011/05/20 21:26:43;  author: tswift;  state: Exp;  lines: +3 -2

Got rid of some more 32/64 compiler warnings
----------------------------
revision 1.75
date: 2011/05/19 16:39:06;  author: tswift;  state: Exp;  lines: +2 -2
Getting Linux to Work
----------------------------
revision 1.74
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +13 -13
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.73
date: 2011/01/09 22:30:16;  author: tswift;  state: Exp;  lines: +3 -5

Minor code cleanup: some changes in documentation, changes to make a
function name accord with a builtin name, and moved some table
abolishing routines from tries.c to tr_utils.c with all the others.
----------------------------
revision 1.72
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +5 -5

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.71
date: 2010/12/23 18:12:43;  author: tswift;  state: Exp;  lines: +2 -2

The handling of answer templates within the SLG instructions is
extremely confusing, as there is a CallInfo and a CallLUR answer
template AND an answer template may be on the CPS or the heap at
different times.  I renamed some variables to make it clear wither the
AT was on the heap or CPS, and added a few comments.
----------------------------
revision 1.70
date: 2010/12/17 22:59:58;  author: tswift;  state: Exp;  lines: +6 -6

oops.. fixed typo.
----------------------------
revision 1.69
date: 2010/12/17 22:47:45;  author: tswift;  state: Exp;  lines: +10 -6
No change in execution ... just documentation.
----------------------------
revision 1.68
date: 2010/12/16 23:38:00;  author: tswift;  state: Exp;  lines: +5 -5

More name changes + changes to keep compiler quiet for 64 bit mac.
----------------------------
revision 1.67
date: 2010/12/16 22:10:24;  author: tswift;  state: Exp;  lines: +12 -12

Changed the name of reg_array, which sounds generic, to
trieinstr_unif_stk, which I can remember.

Ok, I'm probably spending too much time on name changes, but its
snowing outside and I'm not in a great mood :-)
----------------------------
revision 1.66
date: 2010/12/16 16:47:13;  author: tswift;  state: Exp;  lines: +2 -2
Changed the name of VarVectorLoc to the more meaningful (to me) AnsTempl
----------------------------
revision 1.65
date: 2010/12/09 17:55:53;  author: tswift;  state: Exp;  lines: +4 -4

Changed CallLUR_VarVector to CallLUR_AnsTempl, which is much more
meaningful (to me, at least).
----------------------------
revision 1.64
date: 2010/12/07 21:08:02;  author: tswift;  state: Exp;  lines: +4 -4

Oops -- one more unused function to comment out.
----------------------------
revision 1.63
date: 2010/12/07 20:55:37;  author: tswift;  state: Exp;  lines: +7 -7

Commented out some unused code (so I don't have to keep trying to
figure out what it is).
----------------------------
revision 1.62
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -11
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.61
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.60
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.59
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.58
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.57
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +11 -1
no message
----------------------------
revision 1.56
date: 2010/06/22 23:50:47;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.55
date: 2010/06/22 23:33:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.54
date: 2010/06/22 23:30:56;  author: spyrosh;  state: Exp;  lines: +0 -8
Backed out code
----------------------------
revision 1.53
date: 2010/06/19 13:42:26;  author: spyrosh;  state: Exp;  lines: +9 -1
Dipti's code for support graph added
----------------------------
revision 1.52
date: 2010/03/19 00:15:49;  author: evansbj;  state: Exp;  lines: +2 -2
branches:  1.52.2;
There seems to be a typo in the MT declaration for variant_call_search
----------------------------
revision 1.51
date: 2010/03/18 22:22:17;  author: tswift;  state: Exp;  lines: +2 -2

Added subgoal depth check with actions of fail and error (cf pg. 165 of the manual)
----------------------------
revision 1.50
date: 2009/11/08 18:29:23;  author: tswift;  state: Exp;  lines: +9 -2

No functionality changes -- just some name changes and simplifications
in preparation for my trip to Portugal.

These were mostly name changes, but I did get rid of a few functions
-- not for efficiency but for simplicity.
----------------------------
revision 1.49
date: 2009/01/24 22:06:20;  author: tswift;  state: Exp;  lines: +3 -1

Forgot to commit the extern statements for Varenumerator_trail_top.
----------------------------
revision 1.48
date: 2009/01/01 00:07:22;  author: tswift;  state: Exp;  lines: +3 -1
Changes to get rid of sloppy extern statements, and put them into a .h file where they should be.
----------------------------
revision 1.47
date: 2007/04/05 17:26:57;  author: tswift;  state: Exp;  lines: +3 -3
Copy of note to the group.  I have not yet updated the manual or test
suite.


I made some changes to interned tries that I think will make them
safer and easier to use, and maybe even speed them up a little.
However, there are some small changes in behavior.

Recall that, for now, interned tries must be private in the MT engine
(I'm looking to change this, but that's how they are now).

The changes are steps towards an interned trie garbage collector, but
todays update is only part of the way there.  Still, I think it is a
good step forward.

The first change occurs when a term is interned into a trie $T$.
Recall that when this happens we may make checks to determine whether
to hash the children of a particular node in the trie, or to resize
the hash table of that node.  If either of these checks are positive,
I made a change to run the choice point stack to see whether there are
any choice points for nodes in $T$, in which case it is not safe to
rehash.  If there are trie choice points for tables, asserted tries,
or interned tries other than $T$it doesn't matter -- its safe to
rehash.  Under this strategy we'll will recheck whenever the next
insert hits that node.  The idea is that adding an extra node wont
slow down access time considerably, and we'll always have the chance
to recheck if we expand the sibling chain (or fill up the hash table)
even further.

Similarly, I made a change in trie_unintern/2 (which reclaims space).
This runs the choice point stack with the same check as above, and if
its safe to reclaim space we do, otherwise we mark the node as deleted
just as in trie_unintern_nr/2.

Finally, I made a change to delete_trie/1 to check the choice point
stack and throw an error if there are choice points into the trie to
be deleted.

The positive side of this is fewer core dumps and the ability to use
interned tries in more types of applications.  The down side of this
is that we may be running the choice point stack more than we'd like.

To address this, first note that if the choice point stack is small,
this isn't a problem -- see the timings below.  However, to avoid
multiple checks during deletion, I added two new predicates,
trie_retractall/2, which does one check of the choice point stack,
then does multiple non-checked "retracts", with or without space
reclamation depending on the check.  Similarly, I added a new
predicate trie_bulk_insert/2 which allows a single check followed by
multiple inserts (with or without a check).

On my Mac, all tests are on an interned trie of 8 million facts.

------------------------------------------------------------
Interning facts in tries

Before adding the CPS checks:
To intern 8 million facts as below took 6.6 secs with trie_intern/4 (via time_create/2)
To intern 8 million facts as below took 4.2 secs with trie_intern/2 (via time_create/2)

After adding the CPS checks:
To intern 8 million facts as below took 4.8 secs with trie_intern/2 (via time_create/2)
To intern 8 million facts as below took 4.3 secs with trie_intern/2 (via time_create/2)

So when the CPS stack is small, you dont pay a price for hashing, but
you might if the CPS stack were big enough.

------------------------------------------------------------
Traversing tries

To traverse the trie, without doing anything other than unification
2.7 secs (using trie_interned/4 in time_traverse/1)

To traverse the trie, without doing anything other than unification
0.7 secs (using trie_interned/2 in time_traverse/1)

------------------------------------------------------------
To delete the trie with delete_trie takes 0.6 seconds (via
time_delete)

------------------------------------------------------------
To retractall the trie via trie_retractall/1 took 7.9 seconds (i.e. by
retracting p(_,_,_)

------------------------------------------------------------
To retractall 1/200th of the trie via trie_retractall/1 took 0.4 seconds (i.e. by
retracting p(1,_,_)
----------------------------
revision 1.46
date: 2007/02/23 20:17:06;  author: tswift;  state: Exp;  lines: +2 -2
There are lots of changes here, but they're all small.  The main
change was that I made xsb_exit() throw an unrecoverable_error if
the xsb_mode was c_calling_xsb.  Since throwing an error requires
a thread context, this meant a change everywhere xsb_exit() was
called, and some of these changes percolated up.  I did not
however change xsb_memory_error() to throw an error -- it just
exits as before.  Making the change would have meant changing all
occurrences of mem_alloc and friends.  Probably we should do it
in the future, but I didn't have the stomach for it today.

In addition I rechecked all usages of exit().  They all seem ok,
so -- while there's still more to do -- XSB should be safer when embedded in an application.
----------------------------
revision 1.45
date: 2007/02/22 00:16:07;  author: tswift;  state: Exp;  lines: +37 -1


Two sets of changes

1) am now allocating initial trie hash-table array out of a
   structure manager rather than via mallocs, at least for the MT
   engine.

2) Main changes are to the C interface with the MT engine.  I'm
   probably not done with these changes, but by putting them into
   CVS it allows Rui and I to test on different versions of Linux.

-- Dipti's bug not yet fixed.  I wanted to get these changes out
   of the way first.

Terry
----------------------------
revision 1.44
date: 2006/11/26 00:39:21;  author: ruim;  state: Exp;  lines: +4 -2
change to ifdef out some global variables for the mt system
got rid of global paren - no longer used
this is just cleanup not bug fix
----------------------------
revision 1.43
date: 2006/11/06 10:31:39;  author: ruim;  state: Exp;  lines: +2 -2
Changed counter to unsigned long
Changed several counting variables to unsigned
Fixed a wrong thing in previous memory_xsb.c fix
----------------------------
revision 1.42
date: 2006/09/20 15:01:25;  author: tswift;  state: Exp;  lines: +3 -3

added typedef for KEY in tries.h and changed occurrences of "struct key" in call_graph_xsb.c to KEY.
----------------------------
revision 1.41
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +54 -1
Incremental Code Added.
----------------------------
revision 1.40
date: 2006/03/24 16:40:29;  author: tswift;  state: Exp;  lines: +17 -1

This is an intermediate update, before going on to
abolish_table_call and other updates.  Changes include:

1) Added 2 fields to Prref for clause gc.  Actually, I might be
   able to get rid of one of these fields, and I do not intend to
   add any fields to cllrefs, which would have a much greater
   space impact.

2) Adjusting mutexes so that table mutexes, etc are handled
   better -- especially w.r.t. table data structures such as
   tifs, deltfs, etc.

3) Made a global variable private -- IGRhead -- to make interned
   tries thread-safe.

4) Hacked some code to make it compile under the Solaris 2.8
   bundled C compiler, which isn't the brightest compiler on the
   porch.

5) Some changes to my working area in biassert.c in preparation
   for gc of retract.
----------------------------
revision 1.39
date: 2006/02/16 18:32:50;  author: dwarren;  state: Exp;  lines: +5 -4
Fixed a memory bug that showed up when newly needed memory was more than twice
previous memory.  Showed up in trie_interned.  Added explicit argument to
memory allocator to provide needed amount.
----------------------------
revision 1.38
date: 2006/01/09 00:06:33;  author: tswift;  state: Exp;  lines: +13 -1
Made a pass at reallocating structure managers for MT engine.
Structure managers avoid a malloc except when obtaining a new
block.  Thus, the use of thread-private structure managers avoids
the use of mutexes, both explicit and those implicit within
alloc.

All  Variant  tabling  routines  use  either  private  or  shared
structure managers  for BTNs and BTHTs, depending  on whether the
tabled predicates are private or shared.  However I still need to
allow private tables to use private Sms subgoal frames and answer
list nodes.

In this pass, I made the subsumption structure managers,
smProdSF, smConsSF, smTSTN, smTSIN, and smTSTHT private in the
multi-threaded engine.  We can change it whenever we implement
shared subsumptive tables.  At this point, however call tries for
subsumptive tables are still based on shared structure managers
-- will fix that.

Also, trie-asserted code uses shared structure managers
regardless of whether the trie-asserted predicates are shared or
private.
----------------------------
revision 1.37
date: 2005/12/22 23:34:02;  author: tswift;  state: Exp;  lines: +3 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.36
date: 2005/12/12 18:44:54;  author: dwarren;  state: Exp;  lines: +4 -1
Added string table garbage collection.
----------------------------
revision 1.35
date: 2005/11/16 17:32:06;  author: dwarren;  state: Exp;  lines: +10 -23
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.34
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +3 -3
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.33
date: 2005/09/01 18:37:07;  author: tswift;  state: Exp;  lines: +4 -1


Main change below, also a little refactoring and documentation in these files.

/* TABLE ABOLISHING AND GARBAGE COLLECTING
 *
 * When a table is abolished, two checks must be made before its space
 * can be reclaimed.  First, the table must be completed, and second
 * it must be ensured that there are not any trie choice points for
 * the table in the choice point stack.
 *
 * In the case of abolish_all_tables, if there are any incomplete
 * tables, or if there are trie nodes for completed tables on the
 * choice point stack, errors are thrown.  In the case of
 * abolish_table_pred(P), if P is not completed an error is thrown;
 * while if trie choice points for P are on the stack, P is
 * "abolished" (pointers in the TIF are reset) but its space is not
 * yet reclaimed.  Rather, a deleted table frame (DelTF) is set up so
 * that P can later be reclaimed upon a call to gc_tables/1.  In
 * addition, if the freeze registers are set, then a DelTF is also
 * set up (this can be changed, but it doesn't seem necessary right
 * now)
 *
 * Later, on a call to gc_tables/1, the choice point stacks may be
 * traversed to mark those DelTF frames corresponding to tables with
 * trie CPs in the CP stack.  Once this is done, the chain of DelTF
 * frames is traversed to reclaim tables for those unmarked DelTF
 * frames (and free the frames) as well as to unmark the marked DelTF
 * frames.
 *
 * These predicates emit a warning and take no action if more than
 * one thread is active.  Soon to be fixed.
 */
----------------------------
revision 1.32
date: 2005/08/16 21:39:53;  author: dwarren;  state: Exp;  lines: +54 -1
Made subsumptive tables thread-safe with regard to global variables (I hope.)
So thread_private subsumptive tables should work.  No guarantees at all for
shared subsumptive tables.
----------------------------
revision 1.31
date: 2005/07/18 19:47:47;  author: tswift;  state: Exp;  lines: +3 -3

picayune (my word for the day) changes in predicate names and a little added documentation
based on reviewing abolish_table_pred and friends.
----------------------------
revision 1.30
date: 2005/01/14 18:31:38;  author: ruim;  state: Exp;  lines: +50 -2
Integration of multithreaded system
----------------------------
revision 1.29
date: 2000/12/04 17:10:45;  author: ejohnson;  state: Exp;  lines: +3 -2
branches:  1.29.8;
Added support for subsumption-based LRD stratified negation,
including:

o Modification of 't not'/1 to accept all predicates.

o Replacement of predicate get_producer_subgoal_frame/2 with a new
  predicate get_producer_call/3 (ala get_call/3 and friends) to take
  the subgoal and perform a tabling-strategy-dependent lookup,
  returning a producer's subgoal frame and an answer template with
  respect to that producer.

  get_producer_call/3 aborts if given a non-tabled predicate and fails
  if the tabled predicate hasn't been called before.

o Modification of slg_not/1 s.t. it takes two extra arguments: the
  first is the answer template from get_producer_call/3, used by
  negated, properly subsumed predicates for relevant-answer
  collection; the second contains the subgoal which is negated, used
  only for error reporting.

o Extension of certain C functions, e.g. get_variant_sf() and
  get_subsumer_sf() to build and return, in an extra argument, the
  answer template.
----------------------------
revision 1.28
date: 2000/07/31 20:28:00;  author: ejohnson;  state: Exp;  lines: +3 -3
branches:  1.28.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.27
date: 2000/06/27 17:59:19;  author: ejohnson;  state: Exp;  lines: +2 -2
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.26
date: 2000/06/25 16:59:18;  author: ejohnson;  state: Exp;  lines: +18 -14
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.25
date: 2000/05/29 04:23:41;  author: ejohnson;  state: Exp;  lines: +13 -4
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.24
date: 2000/05/25 00:32:05;  author: ejohnson;  state: Exp;  lines: +6 -11
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.23
date: 2000/04/29 21:54:01;  author: kifer;  state: Exp;  lines: +4 -4
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.22
date: 2000/01/11 17:19:10;  author: ejohnson;  state: Exp;  lines: +2 -1
Added support for subsumptive predicates/tables in two builtins:
table_state and abolish_table_pred.  This included 1) a routine for
performing a subsumptive goal lookup in a table, plus modification of
builtin code to interpret the results (this is practically rewritten),
and 2) a set of routines for deleting portions of subsumptive tables.
----------------------------
revision 1.21
date: 1999/12/14 21:02:38;  author: ejohnson;  state: Exp;  lines: +2 -3
trie_get_returns_for_call() follows "producer" SF ptr first to ensure
finding an answer set from any given SF.

nstruct_ret() removed; same functionality is available through
build_ret_term() in tr_utils.c.

prototype for ux_call_info(), which hasn't existed for a while, is
removed.
----------------------------
revision 1.20
date: 1999/10/26 06:47:36;  author: kifer;  state: Exp;  lines: +2 -2
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.19
date: 1999/10/16 03:00:57;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Correctly set the prototype of function variant_answer_search().
----------------------------
revision 1.18
date: 1999/10/15 02:54:16;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changed functions table_consume_answer() and load_solution_trie() to
take one more argument, attv_num (the number of attributed variables
in the substitution factor).
----------------------------
revision 1.17
date: 1999/10/13 14:53:34;  author: ejohnson;  state: Exp;  lines: +149 -79
Modified definitions of trie-component abstractions.  This was needed
to avoid ANSI incompatibility: casting on LHS of stmt.  Some of these
defs were moved from trie_internals.h.  These changes propogated into
macros which used these defs.

Specialized uses of array VarEnumerator[] into two separate arrays:
tracking call variables, CallVarEnum[], and tracking bindings to trie
vars, TrieVarBindings[].  These two arrays are needed simultaneously
during answer retrieval.

Added Structure_Manager decls for TST components.  Answer list node
Structure_Manager moved to tables.c.  Subgoal Frames are under
Structure_Manager control now.

Trie statistical routines subsumed by newer routines in table_stats.c.

abolish_trie() replaced by release_all_tabling_resources() in
tables.c.

Use of modified macros; standardized name of answer check/insert op:
variant_answer_search().

Fix counting for call inserts.

Moved CHAT answer template heap-shift to table_call_search() in
tables.c, since this is also needed for subsumptive call check/insert
op.
----------------------------
revision 1.16
date: 1999/10/12 20:28:06;  author: kostis;  state: Exp;  lines: +22 -22
Clean up and localization of variables changes.
----------------------------
revision 1.15
date: 1999/08/04 14:42:13;  author: ejohnson;  state: Exp;  lines: +11 -8
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.14
date: 1999/07/15 21:41:24;  author: ejohnson;  state: Exp;  lines: +35 -28
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.13
date: 1999/07/06 16:35:24;  author: ejohnson;  state: Exp;  lines: +181 -75
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.12
date: 1999/04/13 17:24:48;  author: kostis;  state: Exp;  lines: +1 -2
Performed major clean-up and rationalization of the tabling builtins.
----------------------------
revision 1.11
date: 1999/03/27 09:33:11;  author: workflow;  state: Exp;  lines: +2 -3

additional file functions and is_deleted(X) macro defn fixes
----------------------------
revision 1.10
date: 1999/02/27 21:58:48;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Cleaned the simplification code for delay, and added some lines in
simplify_pos_unconditional() to release all the DLs and their DEs.
The DelayInfo node will be freed when it is not needed.
----------------------------
revision 1.9
date: 1999/02/22 16:56:58;  author: workflow;  state: Exp;  lines: +3 -3
nr stuff
----------------------------
revision 1.8
date: 1999/02/10 18:07:10;  author: kostis;  state: Exp;  lines: +2 -3
Useless macro deleted.
----------------------------
revision 1.7
date: 1999/02/03 16:07:20;  author: workflow;  state: Exp;  lines: +4 -6
rollback.
rollback
----------------------------
revision 1.6
date: 1999/02/03 11:14:24;  author: workflow;  state: Exp;  lines: +6 -4
*** empty log message ***
----------------------------
revision 1.5
date: 1999/01/31 14:02:28;  author: kostis;  state: Exp;  lines: +32 -119
Mostly cleanup changes to simplify "tries.h".  Lots of junk code has been
removed and things that are not needed in other files have been moved to
"tries.c".
----------------------------
revision 1.4
date: 1999/01/10 01:21:51;  author: cbaoqiu;  state: Exp;  lines: +5 -3
1. Change get_lastnode_and_retskel to get_lastnode_cs_retskel.
2. Delare variable global_num_vars and delay_it as externed.
----------------------------
revision 1.3
date: 1998/12/21 01:09:12;  author: cbaoqiu;  state: Exp;  lines: +8 -7
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:36:40;  author: cbaoqiu;  state: Exp;  lines: +24 -2
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  1. Variables ans_var_pos_reg, copy_of_var_addr, and
     copy_of_num_heap_term_vars are declared extern.
  2. Functions delay_chk_insert(), undo_answer_bindings(),
     load_delay_trie(), and printterm() are declared extern.
  3. Macro definition print_trie_atom is defined.
----------------------------
revision 1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.28.2.2
date: 2000/12/19 15:58:22;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.28.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +4 -4
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.29.8.5
date: 2004/12/20 16:26:29;  author: ruim;  state: Exp;  lines: +2 -2
renamed mini_trail to VarEnumerator_trail and put it on thread context
----------------------------
revision 1.29.8.4
date: 2004/12/14 08:47:06;  author: ruim;  state: Exp;  lines: +4 -2
added dynamic stacks to thread context
----------------------------
revision 1.29.8.3
date: 2004/11/24 21:53:27;  author: ruim;  state: Exp;  lines: +5 -2
made smBTHT and smBTN thread specific
----------------------------
revision 1.29.8.2
date: 2004/11/22 23:07:39;  author: ruim;  state: Exp;  lines: +18 -1
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.29.8.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +28 -2
Sources from rfm repository
----------------------------
revision 1.52.2.4
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.52.2.3
date: 2010/06/24 21:04:45;  author: spyrosh;  state: Exp;  lines: +2 -0
no message
----------------------------
revision 1.52.2.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +8 -0
no message
----------------------------
revision 1.52.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tst_aux.h,v
Working file: tst_aux.h
head: 1.19
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.16
	ROLLBACK: 1.11
	latest_plus_supp_branch: 1.11.0.4
	latest_plus_supp: 1.11
	Version_3dot2_plus_supp: 1.11.0.2
	release_2_6_plus_supp: 1.7.0.10
	Version_3dot2: 1.11
	dec07-perf-results: 1.9
	mt_thesis: 1.9
	release_3_0: 1.9
	release_2_7_0: 1.7
	multi-threaded-26-engine: 1.7.8.2
	pre-mt: 1.7
	multi-threaded-25-engine-done: 1.7.8.1
	multi-threaded-25-engine: 1.7.0.8
	release_2_6_1: 1.7
	release_2_6_final: 1.7
	release_2_6: 1.7.0.6
	last-merged-to-demand: 1.7
	demand_branch: 1.7.0.4
	before_removing_chat: 1.7
	release_2_5: 1.7
	pre-merge-slgwam-gc: 1.7
	multi-threaded-c-engine: 1.7.0.2
	release_2_4: 1.7
	release_2_3: 1.6
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.3
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
	release-2-1: 1.1
	release-2-0-1: 1.1
	subsumption: 1.1
keyword substitution: kv
total revisions: 26;	selected revisions: 26
description:
----------------------------
revision 1.19
date: 2011/08/03 18:12:54;  author: tswift;  state: Exp;  lines: +84 -1

Added Call abstraction stuff (mostly commented out).
----------------------------
revision 1.18
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +4 -4
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.17
date: 2010/12/17 23:22:29;  author: tswift;  state: Exp;  lines: +49 -48

Documentation, and minor restructuring.
----------------------------
revision 1.16
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.15
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.14
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.13
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.12
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2009/01/03 20:22:48;  author: tswift;  state: Exp;  lines: +23 -6
branches:  1.11.4;

Fixed typo in tables.c

In tst_aux.h fixed so that tables created by call subsumption allow
attributed variable constraints in their answers (including in delay
elements).  Calls in call subsumption still cannot include attributed
variables -- I need to understand more about Bao's algorithm before
I'll be ready to add them there.  But having them in answers takes us
at least part of the way.
----------------------------
revision 1.10
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +5 -1


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.9
date: 2005/11/18 21:09:37;  author: tswift;  state: Exp;  lines: +5 -1


Changes to error reporting when an attempt is made to use
attributed variables in subsumptive tables.  Subsumptive tables
do not yet allow attvs, and I want to wait to implement them
until I can restructure the variant table code -- most likely
after the next release.  So for now, just make the error
reporting better.

In order to do this, I introduced a new error type, table_error
for misc errors involving table semantics / implementation.

Other changes affected only code documentation.
----------------------------
revision 1.8
date: 2005/01/14 18:31:38;  author: ruim;  state: Exp;  lines: +9 -1
Integration of multithreaded system
----------------------------
revision 1.7
date: 2001/04/28 20:15:37;  author: ejohnson;  state: Exp;  lines: +15 -9
branches:  1.7.8;
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.6
date: 2000/06/26 19:21:11;  author: ejohnson;  state: Exp;  lines: +35 -53
branches:  1.6.2;
Converted another stack (tstTermStackLog) utilized by the trie
routines from static to dynamic.
----------------------------
revision 1.5
date: 2000/06/26 15:53:29;  author: ejohnson;  state: Exp;  lines: +47 -52
Converted another stack (tstTrail) utilized by the trie routines from
static to dynamic.
----------------------------
revision 1.4
date: 2000/06/25 16:59:18;  author: ejohnson;  state: Exp;  lines: +189 -112
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.3
date: 2000/01/11 17:07:48;  author: ejohnson;  state: Exp;  lines: +9 -6
Added #def Trail_PopAndReset which effects the trail used for
subsumptive operations.
----------------------------
revision 1.2
date: 1999/12/14 21:07:06;  author: ejohnson;  state: Exp;  lines: +7 -2
Added comment to some macros about the expected condition of its
arguments.
----------------------------
revision 1.1
date: 1999/10/12 19:23:09;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:22;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.7.8.2
date: 2004/12/14 08:47:07;  author: ruim;  state: Exp;  lines: +9 -1
added dynamic stacks to thread context
----------------------------
revision 1.7.8.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.11.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.11.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.11.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tst_insert.c,v
Working file: tst_insert.c
head: 1.28
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.27
	ROLLBACK: 1.22
	latest_plus_supp_branch: 1.22.0.4
	latest_plus_supp: 1.22
	Version_3dot2_plus_supp: 1.22.0.2
	release_2_6_plus_supp: 1.16.0.4
	Version_3dot2: 1.22
	dec07-perf-results: 1.20
	mt_thesis: 1.19
	release_3_0: 1.19
	release_2_7_0: 1.16
	multi-threaded-26-engine: 1.13.6.5
	pre-mt: 1.16
	multi-threaded-25-engine-done: 1.13.6.1
	multi-threaded-25-engine: 1.13.0.6
	release_2_6_1: 1.16
	release_2_6_final: 1.16
	release_2_6: 1.16.0.2
	last-merged-to-demand: 1.15
	demand_branch: 1.15.0.2
	before_removing_chat: 1.13
	release_2_5: 1.13
	pre-merge-slgwam-gc: 1.13
	multi-threaded-c-engine: 1.13.0.4
	release_2_4: 1.13
	release_2_3: 1.13
	multi-threaded-engine: 1.13.0.2
	pre-threading: 1.12
	release-2-2: 1.8
	chat-and-local: 1.8.0.2
	xsb-pre-cleanup: 1.8
	release-2-1: 1.5
	release-2-0-1: 1.5
	subsumption: 1.1
keyword substitution: kv
total revisions: 42;	selected revisions: 42
description:
----------------------------
revision 1.28
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +6 -6
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.27
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.26
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.25
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2009/01/01 00:07:22;  author: tswift;  state: Exp;  lines: +1 -6
branches:  1.22.4;
Changes to get rid of sloppy extern statements, and put them into a .h file where they should be.
----------------------------
revision 1.21
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +7 -1


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.20
date: 2007/08/08 17:50:53;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.19
date: 2005/12/22 23:34:02;  author: tswift;  state: Exp;  lines: +17 -17

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.18
date: 2005/11/12 15:48:51;  author: dwarren;  state: Exp;  lines: +2 -1
Changed many mallocs,callocs,reallocs,frees to mem_allocs, mem_callocs,
mem_reallocs, and mem_deallocs, to keep better track of XSB memory usage.
The goal is eventually to add a new argument to these to indicate a
"category" of memory usage.  But that's not done here.  And this is only
a little more than half-way done of changing the system calls to our mem_*
versions.  Most of these changes are very local, but a couple require
extending interfaces to keep track of block sizes (since mem_dealloc, and
mem_realloc require a length parameter that the corresponding free and realloc
don't.)
----------------------------
revision 1.17
date: 2005/01/14 18:31:39;  author: ruim;  state: Exp;  lines: +12 -11
Integration of multithreaded system
----------------------------
revision 1.16
date: 2002/11/05 20:50:38;  author: lfcastro;  state: Exp;  lines: +7 -7
* First cut at an implementation for abolish_table_call/1.
  - at this point, this call deletes all subsuming tables of a given
  term, via backtracking; what is the desired semantics?

*** WARNING ***
This is not a "safe" operator. It does not perform any kind of
checking, so one may, in fact, delete a table which is in use. This
may cause undefined behavior (i.e. segmentation faults and the like).
----------------------------
revision 1.15
date: 2002/05/31 15:09:04;  author: lfcastro;  state: Exp;  lines: +9 -9
branches:  1.15.2;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.14
date: 2002/05/22 15:41:17;  author: lfcastro;  state: Exp;  lines: +5 -5
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.13
date: 2000/06/25 16:59:19;  author: ejohnson;  state: Exp;  lines: +352 -336
branches:  1.13.2;  1.13.6;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.12
date: 2000/05/29 04:23:41;  author: ejohnson;  state: Exp;  lines: +4 -4
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.11
date: 2000/05/25 00:32:05;  author: ejohnson;  state: Exp;  lines: +69 -69
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.10
date: 2000/05/20 06:56:13;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.9
date: 2000/04/29 21:54:01;  author: kifer;  state: Exp;  lines: +16 -14
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.8
date: 2000/01/11 16:43:42;  author: ejohnson;  state: Exp;  lines: +1 -2
Small change to copyright notice.
----------------------------
revision 1.7
date: 2000/01/07 08:52:04;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.6
date: 1999/12/22 18:07:12;  author: warren;  state: Exp;  lines: +2 -2
Minor (mostly decl) changes to make it compile under MSVC compiler
with few warnings.
----------------------------
revision 1.5
date: 1999/11/02 22:17:28;  author: cbaoqiu;  state: Exp;  lines: +3 -1
Commented out function tsiRemoveEntry().
----------------------------
revision 1.4
date: 1999/10/26 06:47:37;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.3
date: 1999/10/25 05:59:57;  author: kifer;  state: Exp;  lines: +3 -3
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/10/18 21:50:15;  author: cbaoqiu;  state: Exp;  lines: +2 -2
1) Renamed CallVarEnum back to VarEnumerator (after a long discussion
   with Ernie);
2) Renamed IndexOfStandardizedVariable to IndexOfStdVar;
3) Added more changes for attributed variables (around variant_call_search).
----------------------------
revision 1.1
date: 1999/10/12 19:23:10;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.13.6.5
date: 2004/11/24 21:53:27;  author: ruim;  state: Exp;  lines: +9 -9
made smBTHT and smBTN thread specific
----------------------------
revision 1.13.6.4
date: 2004/11/22 23:07:40;  author: ruim;  state: Exp;  lines: +3 -3
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.13.6.3
date: 2004/11/22 16:36:32;  author: ruim;  state: Exp;  lines: +2 -1
added lock on struct manager
----------------------------
revision 1.13.6.2
date: 2004/10/18 20:46:22;  author: ruim;  state: Exp;  lines: +15 -15
update for version 2.6.1
----------------------------
revision 1.13.6.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.13.2.2
date: 2000/12/19 15:58:22;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.13.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.15.2.4
date: 2003/04/17 17:11:34;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.15.2.3
date: 2002/08/08 12:53:19;  author: lfcastro;  state: Exp;  lines: +6 -6
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.15.2.2
date: 2002/08/07 17:53:29;  author: lfcastro;  state: Exp;  lines: +7 -7
* update to HEAD
----------------------------
revision 1.15.2.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +7 -7
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.22.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.22.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.22.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tst_retrv.c,v
Working file: tst_retrv.c
head: 1.35
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.31
	ROLLBACK: 1.26
	latest_plus_supp_branch: 1.26.0.2
	latest_plus_supp: 1.26
	Version_3dot2_plus_supp: 1.25.0.2
	release_2_6_plus_supp: 1.18.0.6
	Version_3dot2: 1.25
	dec07-perf-results: 1.25
	mt_thesis: 1.23
	release_3_0: 1.23
	release_2_7_0: 1.18
	multi-threaded-26-engine: 1.16.4.3
	pre-mt: 1.18
	multi-threaded-25-engine-done: 1.16.4.1
	multi-threaded-25-engine: 1.16.0.4
	release_2_6_1: 1.18
	release_2_6_final: 1.18
	release_2_6: 1.18.0.4
	last-merged-to-demand: 1.18
	demand_branch: 1.18.0.2
	before_removing_chat: 1.16
	release_2_5: 1.16
	pre-merge-slgwam-gc: 1.16
	multi-threaded-c-engine: 1.16.0.2
	release_2_4: 1.16
	release_2_3: 1.15
	multi-threaded-engine: 1.14.0.2
	pre-threading: 1.10
	release-2-2: 1.7
	chat-and-local: 1.7.0.2
	xsb-pre-cleanup: 1.7
	release-2-1: 1.5
	release-2-0-1: 1.4
	subsumption: 1.1
keyword substitution: kv
total revisions: 43;	selected revisions: 43
description:
----------------------------
revision 1.35
date: 2012/02/19 19:17:56;  author: tswift;  state: Exp;  lines: +2 -2

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.34
date: 2011/08/20 21:36:49;  author: tswift;  state: Exp;  lines: +4 -4

Fixed bug in hash opcode where it was throwing an error when encountering an attv.

Will go through occurrences of isref() to make sure things are attv safe (or at least to triage).
----------------------------
revision 1.33
date: 2011/05/22 15:12:25;  author: tswift;  state: Exp;  lines: +3 -3

Changes to fix compiler warnings on various Mac configurations.
----------------------------
revision 1.32
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +6 -6
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.31
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.30
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.29
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.28
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.27
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.26
date: 2009/11/17 14:59:34;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.26.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.25
date: 2007/10/19 21:15:16;  author: tswift;  state: Exp;  lines: +3 -2

Changes to add call_cleanup/2, whose semantics is ISO compliant as far
as the ISO definition goes.  I also put call_cleanup/2 in std_xsb.P.
Cleanup handlers are scheduled through the attv interrupt chain, so I
needed to hack this code a little to make sure that an interrupt
handler for cleanups is always present.

Also, I made a change to peephole to not optimize away a putpbreg_ci
-- we'll usually need it for call_cleanups.

Right now I'm using a static inline for CHECK_CALL_CLEANUP -- on gcc
this should be as fast as a macro and allows me to trace if there are
any problems.


Adding these changes made me need to adjust a few include statements
in tr_utils.c and tst_retrv.c
----------------------------
revision 1.24
date: 2007/08/08 17:50:53;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.23
date: 2006/01/12 21:33:53;  author: tswift;  state: Exp;  lines: +7 -6
Continued coding of shared/private structure managers.
Introduced private structure managers for variant SFs and Answer
list nodes.  Also, ensured that BTNs and BTHTs used in
subsumptive tables all arise from private SMs.  Rechecked and
refactored code to support the multifarious forms of deallocation
that we support.
----------------------------
revision 1.22
date: 2005/12/16 00:18:24;  author: tswift;  state: Exp;  lines: +52 -17

Fix for bug discovered by program submitted by H. Pilegaard.  Comment in code is as follows.


/* TLS: 12/05.  There was an bug in the routine
   tst_collect_relevant_answers().  This routine used Bind_and_Trail
   or Bind_and_Conditionally Trail (see old copies below) to bind trie
   symbols to variables in the answer template (substitution factor).
   For some reason these macros trailed, but did not actually bind.
   This meant that answers were occasionlly being returned to subsumed
   calls that didn't actually unify with these calls.  It didn't seem
   to happen often -- only when an subsumed call S_d has a
   variable/variable binding that a subsuming call S_g does not have
   AND S_d and S_g are in the same SCC.  Apparently we have not often
   encountered both of these cases at the same time (or tested for
   them).
*/
----------------------------
revision 1.21
date: 2005/08/16 21:39:53;  author: dwarren;  state: Exp;  lines: +7 -17
Made subsumptive tables thread-safe with regard to global variables (I hope.)
So thread_private subsumptive tables should work.  No guarantees at all for
shared subsumptive tables.
----------------------------
revision 1.20
date: 2005/07/26 22:46:25;  author: crojo;  state: Exp;  lines: +2 -2

Fixed the ODBC interface in the multithreaded configuration.
----------------------------
revision 1.19
date: 2005/01/14 18:31:39;  author: ruim;  state: Exp;  lines: +8 -7
Integration of multithreaded system
----------------------------
revision 1.18
date: 2002/05/31 15:09:04;  author: lfcastro;  state: Exp;  lines: +5 -5
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.17
date: 2002/05/22 15:41:17;  author: lfcastro;  state: Exp;  lines: +9 -11
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.16
date: 2001/04/28 20:15:38;  author: ejohnson;  state: Exp;  lines: +27 -15
branches:  1.16.4;
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.15
date: 2000/12/08 17:26:47;  author: ejohnson;  state: Exp;  lines: +4 -3
Altered the manner in which the truth of negated subsumptive
predicates are evaluated.  Originally I relied upon the interpretive
timestamp-based relevant-answer collection function, but this requires
the Time Stamp Indices to be present in the TST.  If the producer has
completed before the collection, then these structures would have
already been be reclaimed.

The new approach checks for a relevant answer using the
trie_get_return/2 builtin.  If one is found, then the literal can be
failed.  Otherwise, the producer must be checked for completion and
whether the negative-delay flag has been set.  This is performed
through a new builtin, lrd_success/2.  Therefore, slg_not/1 is restored
for handling variant tabled predicates only.
----------------------------
revision 1.14
date: 2000/06/27 17:59:19;  author: ejohnson;  state: Exp;  lines: +244 -249
branches:  1.14.2;
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.13
date: 2000/06/26 19:21:11;  author: ejohnson;  state: Exp;  lines: +23 -32
Converted another stack (tstTermStackLog) utilized by the trie
routines from static to dynamic.
----------------------------
revision 1.12
date: 2000/06/26 15:53:30;  author: ejohnson;  state: Exp;  lines: +3 -2
Converted another stack (tstTrail) utilized by the trie routines from
static to dynamic.
----------------------------
revision 1.11
date: 2000/06/25 16:59:19;  author: ejohnson;  state: Exp;  lines: +21 -20
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.10
date: 2000/05/25 00:32:05;  author: ejohnson;  state: Exp;  lines: +16 -16
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.9
date: 2000/05/20 06:56:13;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.8
date: 2000/04/29 21:54:01;  author: kifer;  state: Exp;  lines: +30 -30
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.7
date: 2000/01/11 16:43:43;  author: ejohnson;  state: Exp;  lines: +1 -2
Small change to copyright notice.
----------------------------
revision 1.6
date: 2000/01/07 08:52:05;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.5
date: 1999/11/17 22:10:46;  author: ejohnson;  state: Exp;  lines: +14 -18
(Hopefully) eliminated warning "end-of-loop code not reached"
(line 910) as seen during compilation on SGI.
----------------------------
revision 1.4
date: 1999/10/27 16:24:50;  author: ejohnson;  state: Exp;  lines: +17 -48
The subsumptive retrieval algorithm uses the system Trail to record
bindings during the traversal of a TST, as XSB's unification algorithm
may be called upon.  The Trailing mechanisms had been hard-coded,
tuned to forward trailing of the SLG-WAM.  Now it uses the proper XSB
macros.
----------------------------
revision 1.3
date: 1999/10/26 06:47:37;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.2
date: 1999/10/25 05:59:58;  author: kifer;  state: Exp;  lines: +4 -4
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1999/10/12 19:23:11;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.14.2.2
date: 2000/12/19 15:58:22;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.14.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +14 -4
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.16.4.3
date: 2004/11/22 16:36:32;  author: ruim;  state: Exp;  lines: +2 -1
added lock on struct manager
----------------------------
revision 1.16.4.2
date: 2004/10/18 20:46:23;  author: ruim;  state: Exp;  lines: +10 -12
update for version 2.6.1
----------------------------
revision 1.16.4.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +7 -7
Sources from rfm repository
----------------------------
revision 1.26.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.26.2.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.26.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tst_unify.c,v
Working file: tst_unify.c
head: 1.27
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.27
	ROLLBACK: 1.22
	latest_plus_supp_branch: 1.22.0.2
	latest_plus_supp: 1.22
	Version_3dot2_plus_supp: 1.21.0.2
	release_2_6_plus_supp: 1.13.0.6
	Version_3dot2: 1.21
	dec07-perf-results: 1.19
	mt_thesis: 1.18
	release_3_0: 1.18
	release_2_7_0: 1.13
	multi-threaded-26-engine: 1.12.2.3
	pre-mt: 1.13
	multi-threaded-25-engine-done: 1.12.2.1
	multi-threaded-25-engine: 1.12.0.2
	release_2_6_1: 1.13
	release_2_6_final: 1.13
	release_2_6: 1.13.0.4
	last-merged-to-demand: 1.13
	demand_branch: 1.13.0.2
	before_removing_chat: 1.12
	release_2_5: 1.12
	pre-merge-slgwam-gc: 1.11
	multi-threaded-c-engine: 1.11.0.2
	release_2_4: 1.11
	release_2_3: 1.9
	multi-threaded-engine: 1.9.0.2
	pre-threading: 1.8
	release-2-2: 1.5
	chat-and-local: 1.5.0.2
	xsb-pre-cleanup: 1.5
	release-2-1: 1.3
	release-2-0-1: 1.3
	subsumption: 1.1
keyword substitution: kv
total revisions: 35;	selected revisions: 35
description:
----------------------------
revision 1.27
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.26
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.25
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2009/11/17 14:59:35;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.22.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.21
date: 2008/03/22 19:17:35;  author: tswift;  state: Exp;  lines: +3 -2
Started looking at fmt_write since I thought it would be simple to
address its 64-bit issues.  This led me to update its documentation,
and to integrate it a little better with streams and ISO-style errors.
*That* led me to update error handling a little for other I/O
routines.  I put a Prolog stream check into fmt_write and fmt_read,
but apart from this, I don't think that my changes will cause any
detectable slowdowns in I/O.

error_xsb.c -- prettified output of xsb_abort()
----------------------------
revision 1.20
date: 2007/12/13 16:15:09;  author: ruim;  state: Exp;  lines: +8 -1
removed counters for subsumption from optimized multi-threaded engine
----------------------------
revision 1.19
date: 2007/08/08 17:50:53;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.18
date: 2006/01/02 16:33:37;  author: dwarren;  state: Exp;  lines: +3 -2
Modified XSB_STREAM_LOCK and _UNLOCK to account for reading from strings.
Commented out debugging function that was causing a warning.
Added cast to quiet warning in xsb_error.
----------------------------
revision 1.17
date: 2005/12/22 23:34:02;  author: tswift;  state: Exp;  lines: +9 -2

Changes were made so that, in the MT engine, upon thread_exit or
abort, any mutexes held by the exiting/aborting thread are released.
The core change was to add a field "owner" to the mutex frame.  The
field is to the xsb_thread_id locking the mutex upon locking and back
to -1 when unlocking.

I then added release_held_mutexes() to close_open_tables() after
checking that held mutexes should also be released when
close_open_tables() is called.  It seems sensible for now, but we can
change it if needed.

The changes were much messier than I anticipated as I had to add
thread contexts to a bunch of pickyune trie functions.  However, there
were also two issues that I stumbled onto:

1) In certain cases, I didn't want to pass contexts down to functions
   that call mutexes.  Thus I also created SYS_MUTEX_(UN)LOCK_NOERROR.
   My uses of NOERROR won't cause concurrency problems.  In fact, in
   some places where I put in a CTXT definition, I probably could have
   made the underlying locking NOERROR instead.

2) Since context.h depends on macro_xsb.h, we cant use the CTXT-style
   definitions there, leading to some messy code.
----------------------------
revision 1.16
date: 2005/10/03 13:26:44;  author: tswift;  state: Exp;  lines: +3 -1


-- Changed hash_opcode trie instruction.  This instruction
   unnecessarily set up a choice point when the call is ground in the
   designated position and there are no variables in the hash table.
   I refactored the conditionals so that it checks for this case, and
   only sets up a choice point if the case doesn't hold.  I believe
   that it will make asserted tries faster in the when the
   call-position and trie position is ground, and will never make it
   slower.

-- slginsts_xsb_i.h / macro_xsb.h factored out dispatch code from
   tabletry instruction to make this instruction more readable, as
   dispatch handling seems fairly stable now.

-- trie_internals.h found a bit to designate in each trie node whether
   it is part of a shared trie or a private trie in the MT engine.

Please do not yet rely on the shared bits being set -- I dont yet
guarentee that they are set properly in the MT engine.  However, the
private bit is always 0, so the "default" private case will always
work.

-- context.h / tst_unify.h / residual.c Global variables put into
   thread context for multi-threading.  Their allocation is not
   changed, they've just had the simple if-deffing.

-- macro_xsb.h Grabbed an unused bit from the first cell of subgoal
   frames to indicate whether the SF is private or shared in the MT
   system.  Added supporting macros as needed.

-- builtin.c / subinst.h ifdeffed out my PROFILE for the MT engine.
   Don't worry, this profiling of SCCs has NOTHING to do with the XSB
   profiling library.

-- struct_manager.h -- added typedef.

-- added trace_xsb.h so that its a little more clear where the
   typedefs, extern statements, etc are for the statistics routines.

Any other file changed and not mentioned has only documentation or
formatting changes.
----------------------------
revision 1.15
date: 2005/08/16 21:39:53;  author: dwarren;  state: Exp;  lines: +4 -1
Made subsumptive tables thread-safe with regard to global variables (I hope.)
So thread_private subsumptive tables should work.  No guarantees at all for
shared subsumptive tables.
----------------------------
revision 1.14
date: 2005/01/14 18:31:39;  author: ruim;  state: Exp;  lines: +17 -15
Integration of multithreaded system
----------------------------
revision 1.13
date: 2002/05/22 15:41:17;  author: lfcastro;  state: Exp;  lines: +3 -3
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.12
date: 2001/12/13 21:13:35;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.12.2;
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.11
date: 2001/05/01 17:35:27;  author: ejohnson;  state: Exp;  lines: +30 -25
Ensure that TrieVarBindings[] elements are unbound after leaving
consume_subsumptive_answer(), even when an error occurs.
----------------------------
revision 1.10
date: 2001/04/28 20:15:38;  author: ejohnson;  state: Exp;  lines: +210 -199
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.9
date: 2000/06/25 16:59:20;  author: ejohnson;  state: Exp;  lines: +5 -5
branches:  1.9.2;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.8
date: 2000/05/29 04:23:41;  author: ejohnson;  state: Exp;  lines: +3 -3
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.7
date: 2000/05/20 06:56:14;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.6
date: 2000/04/29 21:54:01;  author: kifer;  state: Exp;  lines: +31 -31
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.5
date: 2000/01/11 16:43:44;  author: ejohnson;  state: Exp;  lines: +1 -2
Small change to copyright notice.
----------------------------
revision 1.4
date: 2000/01/07 08:52:06;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.3
date: 1999/10/26 06:47:38;  author: kifer;  state: Exp;  lines: +3 -3
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.2
date: 1999/10/25 05:59:58;  author: kifer;  state: Exp;  lines: +4 -4
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1999/10/12 19:23:12;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.9.2.2
date: 2000/12/19 15:58:22;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.9.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +8 -2
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.12.2.3
date: 2004/12/14 08:47:07;  author: ruim;  state: Exp;  lines: +13 -11
added dynamic stacks to thread context
----------------------------
revision 1.12.2.2
date: 2004/10/18 20:46:38;  author: ruim;  state: Exp;  lines: +3 -3
update for version 2.6.1
----------------------------
revision 1.12.2.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +5 -5
Sources from rfm repository
----------------------------
revision 1.22.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.22.2.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.22.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tst_utils.c,v
Working file: tst_utils.c
head: 1.44
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.38
	ROLLBACK: 1.32
	latest_plus_supp_branch: 1.32.0.2
	latest_plus_supp: 1.32
	Version_3dot2_plus_supp: 1.31.0.2
	release_2_6_plus_supp: 1.23.0.4
	Version_3dot2: 1.31
	dec07-perf-results: 1.30
	mt_thesis: 1.29
	release_3_0: 1.29
	release_2_7_0: 1.23
	multi-threaded-26-engine: 1.22.4.4
	pre-mt: 1.23
	multi-threaded-25-engine-done: 1.22.4.1
	multi-threaded-25-engine: 1.22.0.4
	release_2_6_1: 1.23
	release_2_6_final: 1.23
	release_2_6: 1.23.0.2
	last-merged-to-demand: 1.22
	demand_branch: 1.22.0.2
	before_removing_chat: 1.22
	release_2_5: 1.22
	pre-merge-slgwam-gc: 1.21
	multi-threaded-c-engine: 1.21.0.2
	release_2_4: 1.21
	release_2_3: 1.18
	multi-threaded-engine: 1.18.0.2
	pre-threading: 1.12
	release-2-2: 1.6
	chat-and-local: 1.6.0.2
	xsb-pre-cleanup: 1.6
	release-2-1: 1.4
	release-2-0-1: 1.3
	subsumption: 1.1
keyword substitution: kv
total revisions: 57;	selected revisions: 57
description:
----------------------------
revision 1.44
date: 2012/06/07 19:37:42;  author: tswift;  state: Exp;  lines: +177 -3

A number of changes to extend forest logging to handle negation.
----------------------------
revision 1.43
date: 2011/10/29 23:27:59;  author: tswift;  state: Exp;  lines: +2 -2

Subgoal abstraction now is correct for programs that use
tnot/1 to the extent that an error is thrown when the maximal tabled
subgoal depth is exceeded.  This is just a temporary measure until the
correct post action is implemented for negative calls that are
abstracted.  However, the new mechanism abstracts positive calls and
does not throw errors in cases where it did not before.

   Technical note; This code was refactored and partially rewritten in
   C so that variant_call_search can detect whether a tabled call
   arises from a tnot or not.  This is needed so that subgoal
   abstraction can do the right thing for negative literals and
   positive literals.

The speed for tnot was improved.  tnot/1 is the basis of naf
implementation.

   Technical Note: The ground check for tnot is now (efficiently) done
   in variant call search, and a couple of other literals were
   implemented.

Made tnot/1, sk_not/1, and abolish_table_call/1 "cycle safe" to the
extent that they throw exceptions when encountering a cyclic term
(rather than going into an infinite loop). sk_not/1 is also heavily
used by Flora

More robust error handling for aborted tries

     Technical Note: Now, partial branches of tries that were aborted
     for having too high a depth are treated as deleted.  Not doing so
     was a bad oversight, and caused some core dumps.

Better error reporting for subgoal calls, including cyclic terms.
Things will look ugly sometimes, but the info should always be there.
I have an enhancement to change I/O for cyclic terms which I will use
to make them prettier.
----------------------------
revision 1.42
date: 2011/10/16 19:20:34;  author: tswift;  state: Exp;  lines: +6 -6

Integrating in Call Abstraction
----------------------------
revision 1.41
date: 2011/05/22 15:12:25;  author: tswift;  state: Exp;  lines: +3 -3

Changes to fix compiler warnings on various Mac configurations.
----------------------------
revision 1.40
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +5 -1
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.39
date: 2010/12/17 23:22:29;  author: tswift;  state: Exp;  lines: +2 -1

Documentation, and minor restructuring.
----------------------------
revision 1.38
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +3 -4
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.37
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.36
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.35
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.34
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.33
date: 2010/08/17 19:43:21;  author: spyrosh;  state: Exp;  lines: +4 -3
no message
----------------------------
revision 1.32
date: 2009/11/17 14:59:35;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.32.2;

Changed macro_xsb.h to tab_structs.h to reflect its contents.

Also, changed a warning to an error when combining incremental and
subsumptive tabling.
----------------------------
revision 1.31
date: 2008/12/31 23:44:42;  author: tswift;  state: Exp;  lines: +21 -2


Initial version extending call subsumption to WFS.  There's more to
do, but I want to save this backup point.

1) I have only tested local evaluation so far (I do plan to do
   batched)

2) Within local evaluation, I've tested things thoroughly on the
   sequential engine..  I modified my test suite so that neg_tests,
   wfs_tests, and delay_tests are executed when XSB is called with the
   -S option (which uses call subsumption by default).  All of these
   tests work correctly except for

   	 delay_tests/dret (this tests manual deletion of returns,
   	 which I'm not worried about at this point)

   	 delay_tests/residual1 (this one may be a feature rather than a bug)

	 ... both on subsumption

3) Some of my code needs to be optimized, as I sometimes retraverse
   data structures unnecessarily.  While I haven't yet performed
   timings, the code for WFS under call variance should not be
   affected.  The only difference from the call variance perspective
   is a few more conditions in simplification code.

4) The new code is not yet thread-safe, so I have not yet tested the
   MT tests.  On the sequential tests, the MT engine works almost as
   well as the sequential engine except for

      delay_tests/interp1
      delay_tests/dynstrat1

      ... both on subsumption

I don't understand why CVS thinks all the .xwam files have been modified??
----------------------------
revision 1.30
date: 2007/08/08 17:50:53;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.29
date: 2005/11/16 17:32:06;  author: dwarren;  state: Exp;  lines: +5 -5
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.28
date: 2005/11/14 18:58:49;  author: tswift;  state: Exp;  lines: +2 -2


Changes to make global variables conform to conventions in
README.  Removed a few global variables, including
set_scope_marker (for catch/3), and a jmp_buf environment in
cinterf.

Added some documentation of XSB-specific instructions to emuloop.
----------------------------
revision 1.27
date: 2005/08/16 21:39:53;  author: dwarren;  state: Exp;  lines: +3 -3
Made subsumptive tables thread-safe with regard to global variables (I hope.)
So thread_private subsumptive tables should work.  No guarantees at all for
shared subsumptive tables.
----------------------------
revision 1.26
date: 2005/08/08 17:11:36;  author: dwarren;  state: Exp;  lines: +6 -5
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.25
date: 2005/07/18 21:54:12;  author: crojo;  state: Exp;  lines: +14 -2
*** empty log message ***
----------------------------
revision 1.24
date: 2005/01/14 18:31:39;  author: ruim;  state: Exp;  lines: +26 -24
Integration of multithreaded system
----------------------------
revision 1.23
date: 2002/11/05 20:50:38;  author: lfcastro;  state: Exp;  lines: +2 -2
* First cut at an implementation for abolish_table_call/1.
  - at this point, this call deletes all subsuming tables of a given
  term, via backtracking; what is the desired semantics?

*** WARNING ***
This is not a "safe" operator. It does not perform any kind of
checking, so one may, in fact, delete a table which is in use. This
may cause undefined behavior (i.e. segmentation faults and the like).
----------------------------
revision 1.22
date: 2001/12/28 07:24:47;  author: ejohnson;  state: Exp;  lines: +20 -19
branches:  1.22.2;  1.22.4;
Changed printTriePath() to print the symbol in the trie root when an
ESCAPE node is passed in.
----------------------------
revision 1.21
date: 2001/04/29 17:25:56;  author: ejohnson;  state: Exp;  lines: +2 -2
Removed stray mark causing compilation error.
----------------------------
revision 1.20
date: 2001/04/29 17:21:13;  author: ejohnson;  state: Exp;  lines: +4 -2
Small change to debugging output.
----------------------------
revision 1.19
date: 2001/04/28 20:15:38;  author: ejohnson;  state: Exp;  lines: +104 -120
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.18
date: 2000/07/31 20:28:01;  author: ejohnson;  state: Exp;  lines: +6 -3
branches:  1.18.2;
These changes mostly encompass clean-up and robustification of the
tabling builtins.

Prolog side:
- Made greater use of automatic inlining by XSB compiler.  This allowed for
  the removal of several explicit builtin calls at the end of tables.P.
- Backtrackable builtins use findall/3 to collect terms, thereby avoiding
  read/write problem.  This was mostly done; I modified get_returns/2 to
  complete the transformation of these builtins.
- delete_return/2 was absent from the list of standard predicates, even
  though the manual claims that it is one.  I added this in.
- Renamed builtin trie_delete_branch_ret/3 (with #def TRIE_DELETE_TERM)
  to trie_get_return/2 (with #def TRIE_GET_RETURN).  This builtin was never
  being used except for deletion of returns, hence the name change.

C side:
- Builtins TRIE_DELETE_RETURN/2 and TRIE_GET_RETURN/2 accept sensitive info
  directly from the user.  I've added pointer validity checking to reduce
  the possibility of seg faults and bus errors resulting from arbitrary
  values supplied as pointers.
- All invalid pointers generate a generic error msg and abort.
- In TRIE_GET_RETURN/2, the correct value for n in ret/n is now checked for.
  The builtin fails if it doesn't match that stored in the root of the trie.
  Originally, this builtin would succeed when n was greater than needed.
  The result was that "extra" arguments were left unchanged.

There were other small changes, like the addition and modification of a
few macros and inlined functions, mostly limited to tries.  The roots of
tries may now contain XSB_STRINGs rather than a 0-arity PSC record.

The findall change in get_returns/2 caused some erros in two attv
tests.  I've slightly modified these tests to avoid the errors, so an
update of the testsuite is called for.
----------------------------
revision 1.17
date: 2000/06/27 17:59:20;  author: ejohnson;  state: Exp;  lines: +3 -3
References to the subsumption-based tabling process of "retrieval"
have been renamed to "relevant answer identification" to bring the
nomenclature in line with that used within published articles.
Function and macro names have been similarly altered.
----------------------------
revision 1.16
date: 2000/06/26 19:21:11;  author: ejohnson;  state: Exp;  lines: +5 -3
Converted another stack (tstTermStackLog) utilized by the trie
routines from static to dynamic.
----------------------------
revision 1.15
date: 2000/06/26 15:53:30;  author: ejohnson;  state: Exp;  lines: +4 -3
Converted another stack (tstTrail) utilized by the trie routines from
static to dynamic.
----------------------------
revision 1.14
date: 2000/06/25 16:59:20;  author: ejohnson;  state: Exp;  lines: +158 -115
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.13
date: 2000/06/22 19:40:32;  author: ruim;  state: Exp;  lines: +3 -3
added casts to malloc calls to avoid warnings in C++
----------------------------
revision 1.12
date: 2000/05/29 04:23:42;  author: ejohnson;  state: Exp;  lines: +61 -90
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.11
date: 2000/05/25 00:32:06;  author: ejohnson;  state: Exp;  lines: +3 -3
Two types of subgoal frames are defined: one for variant-based
evaluations, and one for subsumption-based evaluations.  Tabling,
statistical, debugging, and builtin code were all modified
appropriately.

Subsumptive table deletion routine takes advantage of subgoals chained
from TIF.

Changed the names of some trie-internal macros to be consistent with
description in papers.
----------------------------
revision 1.10
date: 2000/05/20 06:56:14;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.9
date: 2000/05/19 04:58:34;  author: kifer;  state: Exp;  lines: +2 -2
got rid of compiler warnings having to do with casting get_arity.
----------------------------
revision 1.8
date: 2000/05/12 20:18:16;  author: ejohnson;  state: Exp;  lines: +24 -69
Fix for builtins abolish_all_tables and abolish_table_pred.
Checks that the subgoals are (marked as) complete before destroying
the tables.

Other supporting changes:

Added a field in TableInfoFrames (TIF) for maintaining references to
the subgoals according to predicate, rather than one global list.
Routines which walked this list had to be appropriately modified.

Discovered that TIFs weren't being counted in memory usage, so changed
their allocation to use mem_alloc() instead of malloc().

Moved the code which places a TIF on the alloc chain, maintained
through `first_tip' and `last_tip', into macro New_TIF().
Removed this code from biassert.c and loader_xsb.c.

Made a structure out of `first_tip' and `last_tip'.  Added an extern
for this structure to macro_xsb.h, and hence removed the externs from
biassert.c and builtin.c.  Modified references appropriately.

Producer subgoal frame allocation now puts the SF into the predicate's
TIF.
----------------------------
revision 1.7
date: 2000/04/29 21:54:02;  author: kifer;  state: Exp;  lines: +16 -16
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.6
date: 2000/01/11 17:08:29;  author: ejohnson;  state: Exp;  lines: +2 -3
Small change to output of triePrintPath().
----------------------------
revision 1.5
date: 2000/01/07 08:52:07;  author: kifer;  state: Exp;  lines: +3 -3
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.4
date: 1999/11/17 17:42:04;  author: ejohnson;  state: Exp;  lines: +11 -5
Warning fixes, noticed under 64-bit mode compilation:
- type mismatches, in assignment and print formats
- unused variables
----------------------------
revision 1.3
date: 1999/10/26 06:47:38;  author: kifer;  state: Exp;  lines: +4 -4
renamed cell.h, celltags.h, psc.h, inst.[ch], flag*.h by adding _xsb, to
avoid conflicts with system includes
----------------------------
revision 1.2
date: 1999/10/25 05:59:59;  author: kifer;  state: Exp;  lines: +3 -3
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1999/10/12 19:23:12;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.18.2.2
date: 2000/12/19 15:58:23;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.18.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.22.4.4
date: 2004/12/14 08:47:07;  author: ruim;  state: Exp;  lines: +24 -22
added dynamic stacks to thread context
----------------------------
revision 1.22.4.3
date: 2004/11/22 23:07:41;  author: ruim;  state: Exp;  lines: +4 -4
made TrieVarBindings and VarEnumerator thread specific
----------------------------
revision 1.22.4.2
date: 2004/10/18 20:46:39;  author: ruim;  state: Exp;  lines: +2 -2
update for version 2.6.1
----------------------------
revision 1.22.4.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.22.2.4
date: 2003/04/17 17:11:33;  author: lfcastro;  state: Exp;  lines: +1 -1
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.22.2.3
date: 2002/08/08 12:53:19;  author: lfcastro;  state: Exp;  lines: +1 -1
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.22.2.2
date: 2002/08/07 17:53:29;  author: lfcastro;  state: Exp;  lines: +2 -2
* update to HEAD
----------------------------
revision 1.22.2.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +2 -2
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.32.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.32.2.2
date: 2010/06/19 19:39:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.32.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/tst_utils.h,v
Working file: tst_utils.h
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.13
	ROLLBACK: 1.8
	latest_plus_supp_branch: 1.8.0.4
	latest_plus_supp: 1.8
	Version_3dot2_plus_supp: 1.8.0.2
	release_2_6_plus_supp: 1.6.0.10
	Version_3dot2: 1.8
	dec07-perf-results: 1.7
	mt_thesis: 1.7
	release_3_0: 1.7
	release_2_7_0: 1.6
	multi-threaded-26-engine: 1.6.8.1
	pre-mt: 1.6
	multi-threaded-25-engine-done: 1.6.8.1
	multi-threaded-25-engine: 1.6.0.8
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.6
	last-merged-to-demand: 1.6
	demand_branch: 1.6.0.4
	before_removing_chat: 1.6
	release_2_5: 1.6
	pre-merge-slgwam-gc: 1.6
	multi-threaded-c-engine: 1.6.0.2
	release_2_4: 1.6
	release_2_3: 1.5
	multi-threaded-engine: 1.5.0.2
	pre-threading: 1.4
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.1
	release-2-0-1: 1.1
	subsumption: 1.1
keyword substitution: kv
total revisions: 20;	selected revisions: 20
description:
----------------------------
revision 1.14
date: 2012/06/07 19:37:42;  author: tswift;  state: Exp;  lines: +2 -1

A number of changes to extend forest logging to handle negation.
----------------------------
revision 1.13
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.12
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.11
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2009/01/03 01:11:26;  author: tswift;  state: Exp;  lines: +3 -1
branches:  1.8.4;

Changes were mostly for documentation and code refactoring.

However, also fixed a latent bug in simplification where
was_simplifiable was not properly checking negative delay elements
corresponding to subsumed subgoal frames.  This led to the possibility
of adding un-needed delay elements that might not have been simplified
away.  Surprisingly enough, however, none of the tests in the test
suite checked for this.
----------------------------
revision 1.7
date: 2005/01/14 18:31:39;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.6
date: 2001/04/28 20:15:38;  author: ejohnson;  state: Exp;  lines: +3 -3
branches:  1.6.8;
1) Fixed subsumption bug which appeared to be caused by a
   cut-and-paste error: processing of functors and lists during
   identification of relevant answers were handled in a manner suited
   only for constants.  The bug appeared as an inability to unify a
   (falsely identified) answer with an answer template.

2) Added FILE * arguments to several debugging routines for channeling
   their output.  Made other revisions to some of these which altered
   their output and/or improved their processing.

3) Added more error checking to try to catch tabling, especially
   subsumption, problems as early as possible.
----------------------------
revision 1.5
date: 2000/06/25 16:59:20;  author: ejohnson;  state: Exp;  lines: +14 -22
branches:  1.5.2;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.4
date: 2000/05/29 04:23:42;  author: ejohnson;  state: Exp;  lines: +7 -7
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.3
date: 2000/04/29 21:54:02;  author: kifer;  state: Exp;  lines: +3 -3
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.2
date: 2000/01/11 16:43:45;  author: ejohnson;  state: Exp;  lines: +1 -2
Small change to copyright notice.
----------------------------
revision 1.1
date: 1999/10/12 19:23:13;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.5.2.2
date: 2000/12/19 15:58:23;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.5.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.6.8.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.8.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.8.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/ubi_BinTree.c,v
Working file: ubi_BinTree.c
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.4
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.2
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.1
	pre-mt: 1.1
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +3 -12
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +5 -2
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +5 -2
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +6 -3
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +6 -3
no message
----------------------------
revision 1.2
date: 2005/07/18 21:54:26;  author: crojo;  state: Exp;  lines: +13 -10
branches:  1.2.4;
*** empty log message ***
----------------------------
revision 1.1
date: 2004/01/14 20:27:14;  author: dwarren;  state: Exp;
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.2.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +6 -3
no message
----------------------------
revision 1.2.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +6 -3
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/ubi_BinTree.h,v
Working file: ubi_BinTree.h
head: 1.9
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	pre-mt: 1.2
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.9
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +0 -9
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +3 -0
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +3 -0
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +3 -0
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +11 -0
no message
----------------------------
revision 1.4
date: 2007/08/08 17:50:53;  author: dwarren;  state: Exp;  lines: +4 -0
branches:  1.4.4;
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.3
date: 2005/01/14 18:31:39;  author: ruim;  state: Exp;  lines: +7 -1
Integration of multithreaded system
----------------------------
revision 1.2
date: 2004/01/29 18:44:09;  author: dwarren;  state: Exp;  lines: +4 -0
Modified implementation of profiling to avoid the extra psc-record
field for the count.  Now the counts are kept in the code-ptr records
and accumulated only at accumulation time.  Someday may want to improve
accumulation algorithm.
----------------------------
revision 1.1
date: 2004/01/14 20:27:14;  author: dwarren;  state: Exp;
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +3 -0
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +11 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/ubi_SplayTree.c,v
Working file: ubi_SplayTree.c
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.4
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.2
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	pre-mt: 1.1
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +3 -12
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +5 -2
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +5 -2
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +6 -3
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +6 -3
no message
----------------------------
revision 1.1
date: 2004/01/14 20:27:14;  author: dwarren;  state: Exp;
branches:  1.1.4;
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.1.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +6 -3
no message
----------------------------
revision 1.1.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +6 -3
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/ubi_SplayTree.h,v
Working file: ubi_SplayTree.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.4
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.2
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	pre-mt: 1.1
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +0 -9
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +3 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +3 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +3 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +3 -0
no message
----------------------------
revision 1.1
date: 2004/01/14 20:27:14;  author: dwarren;  state: Exp;
branches:  1.1.4;
XSB Prolog Profiling as command line option -p
----------------------------
revision 1.1.4.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +3 -0
no message
----------------------------
revision 1.1.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +3 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/unify.i,v
Working file: unify.i
head: 1.8
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.7
	without-attv: 1.5
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 9;	selected revisions: 9
description:
----------------------------
revision 1.8
date: 1999/10/25 05:59:59;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.7
date: 1999/10/10 12:36:45;  author: kostis;  state: Exp;  lines: +2 -2
Made variables local to the point of their use; not to entire function.
----------------------------
revision 1.6
date: 1999/10/09 02:00:29;  author: cbaoqiu;  state: Exp;  lines: +39 -2
Changes for attributed variables (first step).
----------------------------
revision 1.5
date: 1999/08/06 14:35:50;  author: kostis;  state: Exp;  lines: +12 -15
Some more performance-related changes to the unification routine.
----------------------------
revision 1.4
date: 1999/07/04 10:39:19;  author: kostis;  state: Exp;  lines: +86 -127
Changes in the general unification routine to speed up unification;
around 10-20% for some programs; courtecy of Bart Demoen and Kostis
Sagonas.
----------------------------
revision 1.3
date: 1999/04/22 06:49:26;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.2
date: 1998/12/21 01:09:15;  author: cbaoqiu;  state: Exp;  lines: +10 -3
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/unify_xsb.h,v
Working file: unify_xsb.h
head: 1.15
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.13
	ROLLBACK: 1.8
	latest_plus_supp_branch: 1.8.0.4
	latest_plus_supp: 1.8
	Version_3dot2_plus_supp: 1.8.0.2
	release_2_6_plus_supp: 1.4.0.6
	Version_3dot2: 1.8
	dec07-perf-results: 1.8
	mt_thesis: 1.8
	release_3_0: 1.7
	release_2_7_0: 1.5
	multi-threaded-26-engine: 1.1.4.2
	pre-mt: 1.5
	multi-threaded-25-engine-done: 1.1.4.1
	multi-threaded-25-engine: 1.1.0.4
	release_2_6_1: 1.4.4.1
	release_2_6_final: 1.4
	release_2_6: 1.4.0.4
	last-merged-to-demand: 1.4
	demand_branch: 1.4.0.2
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
	release_2_4: 1.1
	release_2_3: 1.1
keyword substitution: kv
total revisions: 21;	selected revisions: 21
description:
----------------------------
revision 1.15
date: 2011/11/11 18:21:39;  author: dwarren;  state: Exp;  lines: +51 -5
Added flag[UNIFY_WITH_OCCURS_CHECK_FLAG] that when true causes XSB
to do all unifications with occur_check.  (Not completely tested, and
better efficiency is possible by having compiler generate different
bldval instructions when it can determine that occur-check isn't needed.)
----------------------------
revision 1.14
date: 2011/11/09 02:28:19;  author: dwarren;  state: Exp;  lines: +24 -8
Changed unify to unify cyclic terms without going into an infinite loop.

Also fixed some calls to print term that gave too large a level parameter
which caused overflow of C runstack.
----------------------------
revision 1.13
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.12
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.11
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.8
date: 2006/09/01 13:12:39;  author: dwarren;  state: Exp;  lines: +1 -0
branches:  1.8.4;
findall and unify did not correctly handle 0-ary psc records on the heap.
These are unusual in that they only arise when they represent 0-ary predicate
symbols, so creating them on the heap and unifying them is exceedingly rare.
But it caused a crash when writing a metapredicate to get all tabled predicates,
and a 0-ary one was encountered.  So I fixed it.
----------------------------
revision 1.7
date: 2005/11/17 21:46:57;  author: dwarren;  state: Exp;  lines: +14 -1
Changes to try to improve floating point handling for doubles.
There are still some issues with compiled indexes on floats, and
they don't work correctly.
----------------------------
revision 1.6
date: 2005/01/14 18:31:54;  author: ruim;  state: Exp;  lines: +6 -6
Integration of multithreaded system
----------------------------
revision 1.5
date: 2003/09/29 13:05:12;  author: tschrijvers;  state: Exp;  lines: +7 -4
Merged CHR related updates to branch release_2_6 into the HEAD.
----------------------------
revision 1.4
date: 2002/05/31 15:09:04;  author: lfcastro;  state: Exp;  lines: +2 -2
branches:  1.4.4;
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.3
date: 2002/05/22 15:41:17;  author: lfcastro;  state: Exp;  lines: +3 -1
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.2
date: 2002/03/12 17:31:22;  author: lfcastro;  state: Exp;  lines: +1 -10
* Removal of Chat engine
----------------------------
revision 1.1
date: 2001/01/27 00:02:18;  author: lfcastro;  state: Exp;
branches:  1.1.4;
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.1.4.2
date: 2004/10/18 20:46:39;  author: ruim;  state: Exp;  lines: +9 -13
update for version 2.6.1
----------------------------
revision 1.1.4.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +6 -6
Sources from rfm repository
----------------------------
revision 1.4.4.1
date: 2003/09/11 13:48:09;  author: tschrijvers;  state: Exp;  lines: +7 -4
Changed the emulator in the following way:
- term_new_mod/3 builtin from to copy a term
  to a term in a different module
- globalvar builtin that provides one global variable
- changed behavior of get_attributes and put_attributes:
  attribute value can be anything, not just a vector
- replace pre-unification interrupt handling of attributed variables
  to post-unification handling
----------------------------
revision 1.8.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.8.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.8.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/unify_xsb_i.h,v
Working file: unify_xsb_i.h
head: 1.11
branch:
locks: strict
access list:
symbolic names:
	release_2_6_plus_supp: 1.8.0.6
	release_2_7_0: 1.8
	multi-threaded-26-engine: 1.7.4.2
	pre-mt: 1.8
	multi-threaded-25-engine-done: 1.7.4.1
	multi-threaded-25-engine: 1.7.0.4
	release_2_6_1: 1.8
	release_2_6_final: 1.8
	release_2_6: 1.8.0.4
	last-merged-to-demand: 1.8
	demand_branch: 1.8.0.2
	before_removing_chat: 1.7
	release_2_5: 1.7
	pre-merge-slgwam-gc: 1.7
	multi-threaded-c-engine: 1.7.0.2
	release_2_4: 1.7
	release_2_3: 1.7
	multi-threaded-engine: 1.6.0.2
	pre-threading: 1.6
	release-2-2: 1.5
	chat-and-local: 1.5.0.2
	xsb-pre-cleanup: 1.5
	release-2-1: 1.3
	release-2-0-1: 1.3
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.11
date: 2005/10/28 10:27:34;  author: kostis;  state: dead;  lines: +1 -1
File unify_xsb_i.h taken out from the repository -- related changes to subp.c
----------------------------
revision 1.10
date: 2005/07/26 22:46:25;  author: crojo;  state: Exp;  lines: +3 -3

Fixed the ODBC interface in the multithreaded configuration.
----------------------------
revision 1.9
date: 2005/01/14 18:31:54;  author: ruim;  state: Exp;  lines: +4 -4
Integration of multithreaded system
----------------------------
revision 1.8
date: 2002/03/12 17:31:22;  author: lfcastro;  state: Exp;  lines: +1 -9
* Removal of Chat engine
----------------------------
revision 1.7
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +118 -111
branches:  1.7.4;
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.6
date: 2000/04/29 21:54:02;  author: kifer;  state: Exp;  lines: +4 -4
branches:  1.6.2;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.5
date: 2000/01/26 15:01:54;  author: kostis;  state: Exp;  lines: +113 -129
branches:  1.5.2;
Incorporated Bart's cleaned up version of unify.i that should be faster
for some programs.
----------------------------
revision 1.4
date: 1999/12/10 07:47:44;  author: kifer;  state: Exp;  lines: +6 -5
Changes:
1. Properly inlined term_psc and ptoc_tag by creating include files for them.
2. Deleted bind_copy0
3. Replaced Areg with ptoc_tag (findall.c)
4 (findall.c). Made copy_term0 unify the result with Arg2.
   Now copy_term0 and copy_term are identical.
   The next step is to get rid of copy_term0 completely.
5. Some additional small cleanup in findall.c
6. Took out the #defines from basictypes.h and put them in a new file
    basicdefs.h
    Took some basic typedefs from auxlry.h and put them into basictypes.h
----------------------------
revision 1.3
date: 1999/11/05 03:52:13;  author: cbaoqiu;  state: Exp;  lines: +5 -5
Changed some lines used for debugging attv.
----------------------------
revision 1.2
date: 1999/11/04 23:01:26;  author: cbaoqiu;  state: Exp;  lines: +1 -5
1) Moved the counter of the attv interrupts from the first word in the
   heap to `interrupt_counter';
2) Trail the content of array attv_interrupts[][] using pre_image
   trail (as what we did for the interrupt counter);
3) Do not use ATTVINT_MARK and *asynint_ptr to detect attv interrupts.
   Use *interrupt_reg directly (because *asynint_ptr is not trailed
   using pre_image trail).
----------------------------
revision 1.1
date: 1999/10/25 06:00:01;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5.2.1
date: 2000/03/28 18:10:33;  author: lfcastro;  state: Exp;  lines: +3 -9
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.6.2.2
date: 2000/12/19 15:58:23;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.6.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.7.4.2
date: 2004/10/18 20:46:39;  author: ruim;  state: Exp;  lines: +1 -9
update for version 2.6.1
----------------------------
revision 1.7.4.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +4 -4
Sources from rfm repository
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/url_encode.c,v
Working file: url_encode.c
head: 1.2
branch:
locks: strict
access list:
symbolic names:
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
----------------------------
revision 1.2
date: 2011/05/01 09:36:18;  author: kifer;  state: Exp;  lines: +3 -1
killed most of the warnings
fixed makefile bug
----------------------------
revision 1.1
date: 2011/04/15 03:11:03;  author: kifer;  state: Exp;
Added url_encode/url_decode.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/url_encode.h,v
Working file: url_encode.h
head: 1.1
branch:
locks: strict
access list:
symbolic names:
keyword substitution: kv
total revisions: 1;	selected revisions: 1
description:
----------------------------
revision 1.1
date: 2011/04/15 03:11:03;  author: kifer;  state: Exp;
Added url_encode/url_decode.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/usurp.h,v
Working file: usurp.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
----------------------------
revision 1.2
date: 2011/05/22 18:18:54;  author: tswift;  state: Exp;  lines: +4 -4

More 32/64 compilation fixing -- this time mostly for MT.
----------------------------
revision 1.1
date: 2010/12/09 17:28:45;  author: tswift;  state: Exp;

Reformatted tabletry, which had gotten to be practically unreadable.
The major change was putting the usurpation action into a separate
include file.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/varstring.c,v
Working file: varstring.c
head: 1.29
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.28
	ROLLBACK: 1.23
	latest_plus_supp_branch: 1.23.0.2
	latest_plus_supp: 1.23
	Version_3dot2_plus_supp: 1.21.0.2
	release_2_6_plus_supp: 1.13.0.10
	Version_3dot2: 1.21
	dec07-perf-results: 1.20
	mt_thesis: 1.19
	release_3_0: 1.19
	release_2_7_0: 1.14
	multi-threaded-26-engine: 1.13.8.1
	pre-mt: 1.14
	multi-threaded-25-engine-done: 1.13.8.1
	multi-threaded-25-engine: 1.13.0.8
	release_2_6_1: 1.13
	release_2_6_final: 1.13
	release_2_6: 1.13.0.6
	last-merged-to-demand: 1.13
	demand_branch: 1.13.0.4
	before_removing_chat: 1.13
	release_2_5: 1.13
	pre-merge-slgwam-gc: 1.13
	multi-threaded-c-engine: 1.13.0.2
	release_2_4: 1.12
	release_2_3: 1.8
	multi-threaded-engine: 1.8.0.2
	pre-threading: 1.5
	release-2-2: 1.3
	chat-and-local: 1.3.0.2
	xsb-pre-cleanup: 1.3
keyword substitution: kv
total revisions: 35;	selected revisions: 35
description:
----------------------------
revision 1.29
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +6 -6
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.28
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.27
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.26
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.25
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.24
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.23
date: 2010/05/25 04:52:24;  author: kifer;  state: Exp;  lines: +3 -1
branches:  1.23.2;
added the pcre package
----------------------------
revision 1.22
date: 2009/08/26 21:21:25;  author: dwarren;  state: Exp;  lines: +3 -4
Fixed an off-by-one error in XSB_StrAppendC of varstring.
(IN searching for this bug, I improved the implementation of
write_canonical slightly when it writes strings that require quotes.)
----------------------------
revision 1.21
date: 2008/11/05 22:47:16;  author: dwarren;  state: Exp;  lines: +2 -9
Some mostly simple changes in memory management involving mem_calloc.
mem_calloc was changed to not return NULL if memory is not available
but to throw an error.  This was generally a good idea.  It made some
error handling by callers of mem_calloc obsolete, so most of these
changes are simply to delete that unnecessary code.

A bigger change is to try to allow findall to recover from a memory
overflow.  If findall fails to get memory, an error had been thrown,
but none of now-unused space was released.  So these changes release
that space.  (So a new mem_calloc_nocheck function was added similar
to the other _nocheck versions, so the caller can do more memory
management.)  So now findall releases all buffers it holds when it
can't get more memory.  I had hoped this would allow graceful
recovery, but it seems that even if we release all the space back to
the system, memory is now fragmented and future requests for large
amounts of space (as for expanding the heap) now fail.  So the
recovery is still not that good, but it's better than before.
----------------------------
revision 1.20
date: 2007/08/08 17:50:53;  author: dwarren;  state: Exp;  lines: +2 -1
Fix problem with --enable-fast-floats compilation.
Almost all these changes were due to the fact that cell_xsb.h
included context.h only in the case of not fast-floats. I decided
(maybe unwisely) not have the cell_xsb.h file include context.h at
all.  This meant that context.h must be included before cell_xsb.h
is included.  Thus all the changes.  My generaly feeling is that
I don't like .h files including other .h files, and this follows
that feeling.  But maybe that's better and I should have just
made cell_xsb.h include context.h.
----------------------------
revision 1.19
date: 2005/12/31 23:16:03;  author: tswift;  state: Exp;  lines: +4 -3

Fixed problems with throwing memory errors from mem_xxxoc(), at
least in sequential engine.  When memory cannot be malloced, a
resource error is thrown.  Since throwing errors mallocs memory
in itself, mem_xxxocs used by a throw are changed into
mem_xxxoc_nochecks and an xsb_exit is called if these functions
return NULL pointers.  Care is taken so that when a resource
error is thrown, space for its PSCs has been pre-allocated, and
varstrings are used for the actual message strings (varstring
exits too, if there is not enough memory).

In MT engine, a memory error just exits -- this is because I need
a CTXT to throw an error.  Right now, I'm not sure whether its a
good idea or not to put CTXTs into mem_xxxoc or not.

Not that some of the biggest memory allocations, such as tcp
stack, local-heap stack use straight reallocs and use their own
error handling.

In general, we should be handling most memory errors in a
reasonable, or at least consistent, manner.
----------------------------
revision 1.18
date: 2005/11/16 17:32:06;  author: dwarren;  state: Exp;  lines: +5 -5
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.17
date: 2005/11/13 21:38:38;  author: dwarren;  state: Exp;  lines: +6 -5
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.16
date: 2005/07/07 18:59:43;  author: dwarren;  state: Exp;  lines: +11 -2
Made write_canonical thread-safe
----------------------------
revision 1.15
date: 2005/07/07 16:55:52;  author: dwarren;  state: Exp;  lines: +7 -4
Fixed fmt_read/write for multithreading.  Minor change to write_canonical (still NOT
thread-safe).
Added several (extensible) string buffers to context, since many builtins use
global string buffers.  Idea is to change those places to use these buffers.
They are implemented as varstring's.
----------------------------
revision 1.14
date: 2004/02/02 20:29:48;  author: dwarren;  state: Exp;  lines: +2 -2
Change min and max macros to xsb_min and xsb_max to avoid name clash
as requested by a user.
----------------------------
revision 1.13
date: 2001/07/24 15:36:49;  author: dwarren;  state: Exp;  lines: +4 -4
branches:  1.13.8;
Fix lack-of-indirection error in varstring_create, so calling varstr is changed.
----------------------------
revision 1.12
date: 2001/07/07 06:10:30;  author: kifer;  state: Exp;  lines: +16 -1
some work to enhance dll support.
VarString cleanup in builtin.c
----------------------------
revision 1.11
date: 2001/07/06 18:19:42;  author: kifer;  state: Exp;  lines: +9 -9
Exported print_pterm, VarStrOps for windows compilation
----------------------------
revision 1.10
date: 2001/04/20 02:11:36;  author: kifer;  state: Exp;  lines: +2 -2
null terminated getbuff'ed string.
----------------------------
revision 1.9
date: 2001/03/17 05:44:01;  author: kifer;  state: Exp;  lines: +2 -2
improved error messages
----------------------------
revision 1.8
date: 2000/06/28 16:54:54;  author: ruim;  state: Exp;  lines: +3 -3
branches:  1.8.2;
Changes to keep the sanity of the system.

Now xsb_config.h is ALWAYS the FIRST #include on any file.
This guarantees that autoconf generated #defines work for system include files.
----------------------------
revision 1.7
date: 2000/06/23 20:54:10;  author: ruim;  state: Exp;  lines: +2 -2
Removed some C++ automatic pointer casting warnings
----------------------------
revision 1.6
date: 2000/06/22 19:40:33;  author: ruim;  state: Exp;  lines: +2 -2
added casts to malloc calls to avoid warnings in C++
----------------------------
revision 1.5
date: 2000/05/20 06:56:15;  author: kifer;  state: Exp;  lines: +3 -3
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.4
date: 2000/04/29 21:54:02;  author: kifer;  state: Exp;  lines: +19 -19
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.3
date: 2000/01/07 08:52:08;  author: kifer;  state: Exp;  lines: +3 -2
renamed configs/config.h to configs/xsb_config.h
same for debug.h -> xsb_debug.h

This is needed to avoid potential conflicts in C interface programs that
wish to include config.h.
----------------------------
revision 1.2
date: 1999/12/02 07:07:02;  author: kifer;  state: Exp;  lines: +4 -7
code cleanup.
----------------------------
revision 1.1
date: 1999/11/29 00:30:20;  author: kifer;  state: Exp;
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.8.2.2
date: 2000/12/19 15:58:23;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.8.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.13.8.1
date: 2004/09/29 19:44:23;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.23.2.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.23.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.23.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/varstring_xsb.h,v
Working file: varstring_xsb.h
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.14
	ROLLBACK: 1.9
	latest_plus_supp_branch: 1.9.0.2
	latest_plus_supp: 1.9
	Version_3dot2_plus_supp: 1.8.0.2
	release_2_6_plus_supp: 1.5.0.10
	Version_3dot2: 1.8
	dec07-perf-results: 1.8
	mt_thesis: 1.8
	release_3_0: 1.8
	release_2_7_0: 1.5
	multi-threaded-26-engine: 1.5.8.1
	pre-mt: 1.5
	multi-threaded-25-engine-done: 1.5.8.1
	multi-threaded-25-engine: 1.5.0.8
	release_2_6_1: 1.5
	release_2_6_final: 1.5
	release_2_6: 1.5.0.6
	last-merged-to-demand: 1.5
	demand_branch: 1.5.0.4
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.5
	multi-threaded-c-engine: 1.5.0.2
	release_2_4: 1.4
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.2
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
keyword substitution: kv
total revisions: 20;	selected revisions: 20
description:
----------------------------
revision 1.14
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.13
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.12
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.11
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.10
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.9
date: 2010/05/21 23:31:38;  author: kifer;  state: Exp;  lines: +2 -2
branches:  1.9.2;
added DllExport to p_charlist_to_c_string and c_string_to_p_charlist
----------------------------
revision 1.8
date: 2005/07/07 18:59:43;  author: dwarren;  state: Exp;  lines: +3 -1
Made write_canonical thread-safe
----------------------------
revision 1.7
date: 2005/07/07 16:55:53;  author: dwarren;  state: Exp;  lines: +2 -2
Fixed fmt_read/write for multithreading.  Minor change to write_canonical (still NOT
thread-safe).
Added several (extensible) string buffers to context, since many builtins use
global string buffers.  Idea is to change those places to use these buffers.
They are implemented as varstring's.
----------------------------
revision 1.6
date: 2005/01/14 18:31:54;  author: ruim;  state: Exp;  lines: +1 -1
Integration of multithreaded system
----------------------------
revision 1.5
date: 2001/07/24 15:36:49;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.5.8;
Fix lack-of-indirection error in varstring_create, so calling varstr is changed.
----------------------------
revision 1.4
date: 2001/07/07 06:10:29;  author: kifer;  state: Exp;  lines: +12 -2
some work to enhance dll support.
VarString cleanup in builtin.c
----------------------------
revision 1.3
date: 2001/07/06 18:19:42;  author: kifer;  state: Exp;  lines: +3 -2
Exported print_pterm, VarStrOps for windows compilation
----------------------------
revision 1.2
date: 2000/04/29 21:54:02;  author: kifer;  state: Exp;  lines: +16 -16
branches:  1.2.2;
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.1
date: 1999/11/29 00:30:21;  author: kifer;  state: Exp;
Added the varial length string data type, VarString.
Modified io_builtins.c, error_xsb.c, cinterf.c, string_xsb.c,
dynelf_xsb_i.j, regmatch/wildmatch to work with variable length strings.
----------------------------
revision 1.2.2.2
date: 2000/12/19 15:58:23;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.2.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +5 -6
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.5.8.1
date: 2004/09/29 19:44:24;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.9.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.9.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.9.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/wfs.i,v
Working file: wfs.i
head: 1.12
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.11
	without-attv: 1.9
	release-2-0: 1.7
	pre-release-2-0: 1.7
	v1-9-8: 1.6
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.12
date: 1999/10/25 06:00:02;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.11
date: 1999/10/13 15:17:01;  author: ejohnson;  state: Exp;  lines: +4 -4
Replaced macro reclaim_subg_space() with
reclaim_incomplete_table_structs().  An extra flag in the subgoal
frame indicates whether these structs have already been reclaimed.
This was a simpler solution when dealing with subsumptive structures,
which now must also be relclaimed.  This flag is checked before
calling these reclamation routines.

Subgoal frames are under Structure_Manager control.  A few more fields
are added to support subsumption.  Separate macros for creating
producer and consumer subgoal frames are defined.
----------------------------
revision 1.10
date: 1999/10/09 18:37:56;  author: kostis;  state: Exp;  lines: +2 -2
Cleanup changes so that variables are declared and appear only in places
where they are actually needed.  Expect speed-up by doing so.
Also, finally, ugly xtemp[3-15] variables were eliminated.
Sorry, Terry !
----------------------------
revision 1.9
date: 1999/08/16 07:24:42;  author: kifer;  state: Exp;  lines: +18 -18
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.8
date: 1999/08/06 14:36:29;  author: kostis;  state: Exp;  lines: +2 -2
Minor performance thingy...
----------------------------
revision 1.7
date: 1999/04/22 06:49:27;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.6
date: 1999/02/06 19:12:45;  author: kostis;  state: Exp;  lines: +22 -27
Cleaned up some macros and simplified some stuff for CHAT.
----------------------------
revision 1.5
date: 1999/01/29 18:16:47;  author: kostis;  state: Exp;  lines: +18 -23
Fixed bug with not reclaiming some space in CHAT.  Also, cleaned up some stuff.
----------------------------
revision 1.4
date: 1999/01/28 15:01:43;  author: kostis;  state: Exp;  lines: +2 -2
Minor cleanup.
----------------------------
revision 1.3
date: 1999/01/18 17:59:38;  author: kostis;  state: Exp;  lines: +1 -28
Changes to make ptcp pointing to subgoal frame independently of engine used.
----------------------------
revision 1.2
date: 1998/12/21 01:09:17;  author: cbaoqiu;  state: Exp;  lines: +156 -81
Kostis' changes for GC and CHAT.
----------------------------
revision 1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/wfs_xsb_i.h,v
Working file: wfs_xsb_i.h
head: 1.25
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.25
	ROLLBACK: 1.20
	latest_plus_supp_branch: 1.20.0.2
	latest_plus_supp: 1.20
	Version_3dot2_plus_supp: 1.19.0.2
	release_2_6_plus_supp: 1.9.0.6
	Version_3dot2: 1.19
	dec07-perf-results: 1.19
	mt_thesis: 1.19
	release_3_0: 1.15
	release_2_7_0: 1.9
	multi-threaded-26-engine: 1.5.2.2
	pre-mt: 1.9
	multi-threaded-25-engine-done: 1.5.2.1
	multi-threaded-25-engine: 1.5.0.2
	release_2_6_1: 1.9
	release_2_6_final: 1.9
	release_2_6: 1.9.0.4
	last-merged-to-demand: 1.9
	demand_branch: 1.9.0.2
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.4
	release_2_4: 1.3
	release_2_3: 1.3
	multi-threaded-engine: 1.3.0.2
	pre-threading: 1.3
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 40;	selected revisions: 40
description:
----------------------------
revision 1.25
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.24
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.23
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.22
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.21
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.20
date: 2010/01/23 19:03:03;  author: tswift;  state: Exp;  lines: +2 -2
branches:  1.20.2;

1) Fix for MT memory leak -- interned trie table was not deallocated
when threads exit

2) Changed asf_list to pos_cons_list to help YAP and Ciao people when
they read through the code.
----------------------------
revision 1.19
date: 2006/12/02 19:31:57;  author: ruim;  state: Exp;  lines: +8 -8
moved in lock of compl mutex to avoid locking if non leader
some standartization and ifx of potential bugs for conc compl
----------------------------
revision 1.18
date: 2006/11/08 18:19:21;  author: ruim;  state: Exp;  lines: +19 -1
undid the last change as, after all,
CONC_COMPL needs wfs_xsb_i.h in some cases
----------------------------
revision 1.17
date: 2006/11/08 17:06:33;  author: ruim;  state: Exp;  lines: +2 -20
solved bug in CONC_COMPL involving completion stack expansion
taken out some unneeded ifded CONC_COMPL
----------------------------
revision 1.16
date: 2006/11/06 17:31:53;  author: ruim;  state: Exp;  lines: +5 -3
Fixes to CONC_COMPL:

- compl stack expansion fixed
- freeing of answer_return list finally fixed

it now runs all the tests that batched runs
----------------------------
revision 1.15
date: 2005/11/16 17:32:06;  author: dwarren;  state: Exp;  lines: +3 -3
These changes make it so that all permanent space memory allocations
(all old mem_allocs and almost all old mallocs) now have a "category"
associated with them that indicates the use of the memory.  The
statistics predicate prints out the (non-zero) amounts of permanent
memory in each category.  There is still work to be done, especially
in rationalizing the table space use.  At the moment it is still double
counted.
----------------------------
revision 1.14
date: 2005/11/13 21:38:39;  author: dwarren;  state: Exp;  lines: +3 -3
This changes almost all mallocs and friends to mem_allocs and friends.
The only ones left are at initialization where we can't do mem_alloc yet, and
they're space for a path.  So "permanent space" now includes all pace gotten
by malloc except the basic engine stacks.  (So table space is double counted.)
This will be fixed soon.  [I did uncover and fix 2 memory leaks: one in atom_codes
introduced with multi-threading, and one in interprolog callback.]
----------------------------
revision 1.13
date: 2005/10/12 23:06:26;  author: tswift;  state: Exp;  lines: +6 -6


Mostly added documentation.  Other changes

biassert.c -- commented out a debug that prevented -vrb option from
compiling.

Added a !defined(SOLARIS) to the inclusion of POSIX_C_SOURCE in
setjmp_xsb.h, and put the setjmp_xsb.h back into context.  I figured
its best to make the minimal change, rather than taking out the
inclusion of POSIX_C_SOURCE, which somehow would have broken something
down the line.

Terry
----------------------------
revision 1.12
date: 2005/10/04 12:13:13;  author: ruim;  state: Exp;  lines: +18 -2
partial integration of negation in concurrent completion
----------------------------
revision 1.11
date: 2005/08/13 15:04:02;  author: ruim;  state: Exp;  lines: +3 -3
changed defines to allow concurrent completion
made batch compile under mt
----------------------------
revision 1.10
date: 2005/01/14 18:31:54;  author: ruim;  state: Exp;  lines: +5 -5
Integration of multithreaded system
----------------------------
revision 1.9
date: 2002/07/09 02:27:01;  author: lfcastro;  state: Exp;  lines: +3 -3
branches:  1.9.2;
* fixed two misuses of dbg_print_subgoal
----------------------------
revision 1.8
date: 2002/05/31 15:09:04;  author: lfcastro;  state: Exp;  lines: +15 -15
* Use hack to fix lack of variadic macros on non-C99 compilers
- xsb_dbgmsg should be always called with extra parentheses around the
list of arguments it receives, like in
	xsb_dbgmsg((LOG_DEBUG,"some log %s",some_var));
----------------------------
revision 1.7
date: 2002/05/22 15:41:17;  author: lfcastro;  state: Exp;  lines: +18 -32
* Several changes to debug-related macros, as described in xsb-dev
----------------------------
revision 1.6
date: 2002/03/12 17:31:22;  author: lfcastro;  state: Exp;  lines: +1 -46
* Removal of Chat engine
----------------------------
revision 1.5
date: 2002/02/05 21:34:43;  author: tswift;  state: Exp;  lines: +139 -21
branches:  1.5.2;
Added lots of documentation to these files.
----------------------------
revision 1.4
date: 2001/12/13 21:13:34;  author: lfcastro;  state: Exp;  lines: +64 -62
Changes for release 2.5

* New default engine: slg-wam
* Garbage collector for slg-wam
* New gc scheme (default): indirection
* Optimizations for local scheduling
  - scheduling of completion suspensions by chaining instead of
  creating new choicepoints
  - no need to keep tags and arities in tabled choicepoints
* Answer templates kept on the Heap
* Simplification of CHAT data structures (no need to keep args)
* Re-structuring of GC code
----------------------------
revision 1.3
date: 2000/05/29 04:23:43;  author: ejohnson;  state: Exp;  lines: +12 -12
branches:  1.3.2;
Added a third type of subgoal frame for properly subsumed subgoals.
Previously there were two types, one for variant evaluations and the
other for subsumptive.

Some macro and type names were changed for the benefit of consistent
naming of these subgoalframe-related entities.
----------------------------
revision 1.2
date: 2000/04/29 21:54:03;  author: kifer;  state: Exp;  lines: +4 -4
Renamed:
    bool -> xsbBool
    CS   -> XSB_STRUCT
    LIST -> XSB_LIST
    ....

    deref -> XSB_Deref

Also renamed variable string macros:
    vstrDEFINE -> XSB_StrDefine
    .....
----------------------------
revision 1.1
date: 1999/10/25 06:00:03;  author: kifer;  state: Exp;
branches:  1.1.2;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.2.2
date: 2000/09/13 18:41:13;  author: lfcastro;  state: Exp;  lines: +6 -4
Changes:

*Makefile
	- create target for 'make etags'

*emu/binding.h
	- got rid of #ifdef's on WAM_TRAIL

*emu/chat.c
	- commented out a switch_envs(breg) in
	  chat_restore_compl_susp_trail
	- introduced function chat_free_cp_compl_susp_chat_areas
	  needed for bugfix in cut_xsb.h
	- change in restore_answer_template

*emu/cut_xsb.h
	- bugfix in check_table_cut

*lib/Makefile
	- put '-g none' in calls to XSB to be able to compile when GC
	  isn't working

*general
	- changes/introduction in/of debug messages

Status:
Passes the testsuite for all tests, except for the gctests with the
copying collector, which fails for tests wfs_tests/p53 (and up).
----------------------------
revision 1.1.2.1
date: 2000/03/28 18:10:33;  author: lfcastro;  state: Exp;  lines: +8 -75
This system is a result of a cleanup of the current XSB system. Both
the batched scheduling- and slg-wam-related portions of code have been
removed from the system.

The system, thus, consists of the CHAT engine with the local
scheduling strategy. Also, the engine has been modified so as to use
an slg-wam-like trail.

TODO: there are still some minor code clenups to be done; also, the
garbage collector has to be adapted to the new trail scheme.
----------------------------
revision 1.3.2.2
date: 2000/12/19 15:58:23;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.3.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +11 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.5.2.2
date: 2004/10/18 20:46:41;  author: ruim;  state: Exp;  lines: +19 -78
update for version 2.6.1
----------------------------
revision 1.5.2.1
date: 2004/09/29 19:44:24;  author: ruim;  state: Exp;  lines: +5 -5
Sources from rfm repository
----------------------------
revision 1.9.2.6
date: 2003/05/13 18:12:52;  author: lfcastro;  state: Exp;  lines: +10 -0
bineg_xsb_i.h
	Minor cleanups in debug messages

choice.h
	Make completion suspension frames be part of the suppliers chain

complete_local.h
	Skip early completed tables (which are eagerly reclaimed, now)

debug_xsb.c
	When traversing choicepoint stack, print type of CP

debug_xsb.h
	Beginnings of making debug levels a bitmap instead of a
	cumulative variable

demand.c
	check_external_demand: 	skip early completed subgoals
				added statistics counter: ec_deleted_tables
	early_completion_pruning: new

demand.h
	add marks for deleted choicepoints (next_clause = NULL)

error_xsb.c
	use bitmaps for current log level

init_xsb.c
	new statistics counters: new_calls, early_completions,
	ec_deleted_tables

memory_xsb.c
	deal with early completed choicepoints

slginsts_xsb_i.h
	count new producers (new_calls)
	eager early completion with table deletion

trace_xsb.c
	Print memory statistics in Prolog term form
	Print EC statistics

wfs_xsb_i.h
	deal with early completed tables properly
----------------------------
revision 1.9.2.5
date: 2002/08/29 14:17:13;  author: lfcastro;  state: Exp;  lines: +6 -9
* APPLIED several patches from HEAD
* BACKED OUT circular lists in nlcp_prevlookup, in favor of tagging
  the next_clause pointer to mark undemanded choicepoints
----------------------------
revision 1.9.2.4
date: 2002/08/10 00:19:35;  author: lfcastro;  state: Exp;  lines: +9 -6
* some additions to accomodate for demand
- added supplier chain linking consumers to the subgoal frame they're
supplying;
- modified nlcp_prevlookup chain to be circular, so that a NULL
pointer indicates an undemanded consumer
----------------------------
revision 1.9.2.3
date: 2002/08/08 12:53:19;  author: lfcastro;  state: Exp;  lines: +41 -0
* fix the mess left after my attempt at merging with HEAD
----------------------------
revision 1.9.2.2
date: 2002/08/07 17:53:29;  author: lfcastro;  state: Exp;  lines: +1 -33
* update to HEAD
----------------------------
revision 1.9.2.1
date: 2002/08/07 17:41:36;  author: lfcastro;  state: Exp;  lines: +33 -1
* create new module, demand.o
* guard .h files from multiple inclusion
----------------------------
revision 1.20.2.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.20.2.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.20.2.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/wind2unix.h,v
Working file: wind2unix.h
head: 1.13
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.9
	ROLLBACK: 1.4
	latest_plus_supp_branch: 1.4.0.4
	latest_plus_supp: 1.4
	Version_3dot2_plus_supp: 1.4.0.2
	release_2_6_plus_supp: 1.3.0.10
	Version_3dot2: 1.4
	dec07-perf-results: 1.4
	mt_thesis: 1.4
	release_3_0: 1.4
	release_2_7_0: 1.3
	multi-threaded-26-engine: 1.3.8.1
	pre-mt: 1.3
	multi-threaded-25-engine-done: 1.3.8.1
	multi-threaded-25-engine: 1.3.0.8
	release_2_6_1: 1.3
	release_2_6_final: 1.3
	release_2_6: 1.3.0.6
	last-merged-to-demand: 1.3
	demand_branch: 1.3.0.4
	before_removing_chat: 1.3
	release_2_5: 1.3
	pre-merge-slgwam-gc: 1.3
	multi-threaded-c-engine: 1.3.0.2
	release_2_4: 1.3
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.2
	pre-threading: 1.1
keyword substitution: kv
total revisions: 19;	selected revisions: 19
description:
----------------------------
revision 1.13
date: 2012/02/24 22:02:48;  author: dwarren;  state: Exp;  lines: +2 -1
Fixed tempnam bug I just introduced.
----------------------------
revision 1.12
date: 2011/05/18 19:21:41;  author: dwarren;  state: Exp;  lines: +2 -1
*Many* changes to support the windows 64-bit port.  Almost all changes are either
1. Casts to shut the compiler up when a larger integer is assigned to a shorter one, or
2. Redeclarations of int (or long) to Integer (or to size_t) so that lengths
are appropriate for 64-bit ports.

A couple of other minor bugs were fixed, such as:
a) error when boxed integers are required for a result of a power operation.
b) error in simplification in subsumptive case (test of symbol type was missing
the reference to the symbol in the trie record.)
c) max-min integer specifications.
d) error in term_compare on 64-bit when integers greater the 2^32 apart were compared.
... and maybe another one or two.
----------------------------
revision 1.11
date: 2011/05/01 09:36:18;  author: kifer;  state: Exp;  lines: +10 -1
killed most of the warnings
fixed makefile bug
----------------------------
revision 1.10
date: 2011/03/23 15:45:19;  author: dwarren;  state: Exp;  lines: +3 -1
Fixed bug in interprolog_callback in reuse and deallocation of a byte buffer.
Now interprolog works on Windows 7.
Added missing deref to std_pred_xsb_i.h
Added condition on definition of fileno, so avoid redefinition warnings.
----------------------------
revision 1.9
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.8
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.7
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.6
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.5
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2005/01/14 18:31:54;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.4.4;
Integration of multithreaded system
----------------------------
revision 1.3
date: 2001/03/27 23:18:42;  author: kifer;  state: Exp;  lines: +10 -4
branches:  1.3.8;
X/W/R_OK workaround
----------------------------
revision 1.2
date: 2001/03/27 04:58:56;  author: kifer;  state: Exp;  lines: +16 -1
some corrections for NT
----------------------------
revision 1.1
date: 2000/05/20 06:56:15;  author: kifer;  state: Exp;
branches:  1.1.2;
Renamings due to the problems in configuring under windows:

1. xsb_config.h xsb_debug.h: no longer in emu/configs
   They are included rught out of the config/<architecture>/ directory.
2. configs/special.h is now emu/wind2unix.h
3. All files (lots of them in emu) updated to account for these changes.

Also: Windows makefiles now (hopefully) have the right line endings.
----------------------------
revision 1.1.2.2
date: 2000/12/19 15:58:23;  author: ruim;  state: Exp;  lines: +0 -0
Flags are now copied into threads
----------------------------
revision 1.1.2.1
date: 2000/12/17 15:58:13;  author: ruim;  state: Exp;  lines: +1 -1
Working version of the multi threaded engine - available for knowledge of developers only
----------------------------
revision 1.3.8.1
date: 2004/09/29 19:44:24;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.4.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.4.4.2
date: 2010/06/19 19:39:50;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/wsipx.h,v
Working file: wsipx.h
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.5
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.14
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.12
	release_2_6_plus_supp: 1.1.0.10
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.8
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.6
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.4
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
	release_2_4: 1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.5
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 2001/03/27 22:59:31;  author: dwarren;  state: Exp;
branches:  1.1.14;
modifications to configure (and a couple of other files) to support
the no-cygwin option to compile to a native windows executable usgin
cygwin's gcc compiler.  This allows XSB to use the jump-table
capabilities of gcc (for efficiency) without needing cygwin to
execute.
----------------------------
revision 1.1.14.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.1.14.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1.14.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xddemain.c,v
Working file: xddemain.c
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	devel-1-9-b4-5: 1.2
	devel-1-9-b4-4: 1.2
	devel-1-9-b4-3: 1.2
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 4;	selected revisions: 4
description:
----------------------------
revision 1.3
date: 1998/11/17 00:29:04;  author: kifer;  state: dead;  lines: +1 -1
Adjustments for the NT port.
----------------------------
revision 1.2
date: 1998/11/14 18:48:52;  author: kifer;  state: Exp;  lines: +2 -2
Copyright fix
----------------------------
revision 1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:25;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xmacro.h,v
Working file: xmacro.h
head: 1.15
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.13
	without-attv: 1.10
	release-2-0: 1.4
	pre-release-2-0: 1.4
	v1-9-8: 1.3
	code-fixer-new: 1.2
	code-fixer: 1.2
	delayvar_ok: 1.2
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 16;	selected revisions: 16
description:
----------------------------
revision 1.15
date: 1999/10/25 06:00:04;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.14
date: 1999/10/19 20:11:47;  author: ejohnson;  state: Exp;  lines: +15 -10
Addition of variant/1 to XSB to complement subsumptive/1.
Each one changes the tabled evaluation method of the given
predicate(s).

Modified the structure of related constants to utilize the
preprocessor on the Prolog end.  The builtin which actually makes the
change in the TableInfoFrame is generalized from only making the
switch to subsumptive mode to taking an extra argument indicating the
method to use during the predicate's evaluation.
----------------------------
revision 1.13
date: 1999/10/13 20:52:07;  author: ejohnson;  state: Exp;  lines: +2 -2
Better values for number of tabling structures to allocate at once.
----------------------------
revision 1.12
date: 1999/10/13 15:17:02;  author: ejohnson;  state: Exp;  lines: +219 -82
Replaced macro reclaim_subg_space() with
reclaim_incomplete_table_structs().  An extra flag in the subgoal
frame indicates whether these structs have already been reclaimed.
This was a simpler solution when dealing with subsumptive structures,
which now must also be relclaimed.  This flag is checked before
calling these reclamation routines.

Subgoal frames are under Structure_Manager control.  A few more fields
are added to support subsumption.  Separate macros for creating
producer and consumer subgoal frames are defined.
----------------------------
revision 1.11
date: 1999/10/09 16:34:40;  author: kostis;  state: Exp;  lines: +4 -4
Fixed minor problem in macros.  Took out some casts which might cause some
temporary warnings from the compiler; they will be corrected in the next
commit.
----------------------------
revision 1.10
date: 1999/09/21 11:11:40;  author: kostis;  state: Exp;  lines: +12 -1
Changes to better maintain invariants in the completion stack.
----------------------------
revision 1.9
date: 1999/09/20 09:06:01;  author: kostis;  state: Exp;  lines: +39 -6
Changes to fix problem that caused the flora1 bug.  Changes affect both
SLG-WAM and CHAT emulators.
----------------------------
revision 1.8
date: 1999/08/16 07:24:44;  author: kifer;  state: Exp;  lines: +3 -3
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.7
date: 1999/08/04 14:42:14;  author: ejohnson;  state: Exp;  lines: +53 -30
Have made several more changes to XSB for subsumptive support:

1) Placed another field on TIFs for noting the tabling method to use
with that predicate.  Cleaned up TIF manipulation, e.g., by adding an
allocation macro.  This cleanup required minute changes to several files.

2) Added a standard predicate, subsumptive/1, for changing the tabling
method of a tabled predicate from variant to subsumption.  This
required a new builtin, also.

3) Also added a new option to XSB which forces all tabled predicates
to be evaluated subsumptively.

4) Merged the cases for tabletry and tabletrysingle into a single code
block.  Many simplifications of code segments were then possible,
e.g., choice point creation.

5) VarPosReg is no longer a global variable, but one local to
variant_call_search().

6) Left hooks in tabletry and tabletrysingle code block for
subsumptive predicates.
----------------------------
revision 1.6
date: 1999/07/15 21:41:25;  author: ejohnson;  state: Exp;  lines: +8 -8
Another step in preparing the system for integration of subsumption.

New and noteworthy:

1) Introduction of a new "object" which provides a standard way to
allocate like structures in blocks and parcel them out as needed.
Includes methods to allocate, free, and query the space utilization.
The code to support this functionality is housed in struct_manager.[ch].

2) Changed trie nodes, trie hash tables, and answer list nodes over to
the above maintenance object.

3) emuMakefile.in updated to include struct_manager.c

4) More clean-up of macros whose functionality was duplicated or
subsumed by another.

5) Robustified trie-deletion functions:
  a) fixed memory leaks--e.g., answer list nodes weren't being deleted
  b) number of nodes in hash table was being incorrectly set (count
	from IsInsibling) which caused problems in delete_branch.
  c) exceptional conditions tested for and reported

6) exception_handler now includes call to switch_from_trie_assert.  If
an abort is triggered while assert-trie-space is set as the default
trie-space, then table-trie components could incorrectly be allocated
from assert-trie-space.
----------------------------
revision 1.5
date: 1999/07/06 16:35:25;  author: ejohnson;  state: Exp;  lines: +17 -12
Made low-level changes to trie structure and code as a lead-in to
adding subsumptive tabling.  Also performed a lot of cleanup within
the trie code as well as to the interface between tries and the rest
of the system.

Among the changes:

1) expanded the use of the first field in a trie node to include
information about the type of trie the node is in as well as about the
node itself.  These fields subsumed the role that "ftagging" played.

2) renamed trie-related macros with more meaningful and consistent
names.

3) replaced the old format of trie hash tables with a new one.  These
now consist of a header and a separate bucket array.  A parent node's
"Child" field points to the header, which contains a field identical
to that in a trie node (instr, node & trie type, delete status).  It
used to be that a dummy node hanged off of the parent and it pointed
to the hash table, which combined that header and bucket array into a
single memory block.

4) added a root node to all tries, except those containing delay
variables, as these exist currently as simple chains, i.e., the "trie"
is just a single path.

5) separated low-level trie macros into a new file for inclusion into
files containing trie-manipulating routines.  Higher-level defs are in
another header file for inclusion in files which merely use tries and
call these routines.

6) Removed global variable "UglyHackForTip."

7) Fixed some "suspicious" code.  In particular, care was not taken
when switching back and forth from "tabling-trie" space to
"assert-trie" space (which also includes user-constructed tries).  The
switch was made made at the very beginning and end of code blocks
where, somewhere in the middle, a trie-manipulating function was
called.  This function call alone would require the switch.  But with
other ways to exit the block, execution might never reach the switch
back.  Hence, where ever a switch was called for, I "moved them in" to
just around the functions which depended on it.  This may not
completely solve the problem, as handling an error occurring inside
one of these trie functions may bypass the switch back.  But I think
this is a general problem resulting from the error handling of XSB...

NOTE: these functions are general trie-manipulating functions, so
moving the switch into these functions is not the right thing to do.
The purpose of the switch is to allow these functions to work "in a
different space."
----------------------------
revision 1.4
date: 1999/02/25 15:01:29;  author: kostis;  state: Exp;  lines: +20 -22
Changes for sliding garbage collection made default.
----------------------------
revision 1.3
date: 1998/12/21 01:09:19;  author: cbaoqiu;  state: Exp;  lines: +118 -53
Kostis' changes for GC and CHAT.
----------------------------
revision 1.2
date: 1998/12/09 03:39:14;  author: cbaoqiu;  state: Exp;  lines: +12 -10
Changes to support variables in delay list, and changes of data
structure of delay element/list.

Specific changes in this file:

  Field nide (type IDE) is changed to nde_list (type PNDE).
----------------------------
revision 1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xmain.c,v
Working file: xmain.c
head: 1.12
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.11
	without-attv: 1.11
	release-2-0: 1.10
	pre-release-2-0: 1.9
	v1-9-8: 1.9
	code-fixer-new: 1.9
	code-fixer: 1.9
	delayvar_ok: 1.9
	r1-9-b6: 1.9
	r1-9-b5: 1.7
	devel-1-9-b4-5: 1.3
	devel-1-9-b4-4: 1.3
	devel-1-9-b4-3: 1.3
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 13;	selected revisions: 13
description:
----------------------------
revision 1.12
date: 1999/10/25 06:00:06;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.11
date: 1999/08/04 16:21:38;  author: kifer;  state: Exp;  lines: +2 -2
ported process control to windows
----------------------------
revision 1.10
date: 1999/05/24 16:01:29;  author: luis;  state: Exp;  lines: +1 -13
* C Interface cleanup
----------------------------
revision 1.9
date: 1998/11/19 05:24:23;  author: kifer;  state: Exp;  lines: +2 -6
changed so that C program calling XSb would only pass the top xsb
directory instead of the executable directory
----------------------------
revision 1.8
date: 1998/11/18 07:59:17;  author: kifer;  state: Exp;  lines: +14 -195
Moved initialization of executable, user_home, xsb_config_file to the
new file self_orientation. Added initialization like in xmain.c to
xsb_init in cinterf.c. This should fix the C-calling xsb interface.
----------------------------
revision 1.7
date: 1998/11/18 03:20:21;  author: kifer;  state: Exp;  lines: +65 -19
Changed so that xsb will find its path name in case it is called as
xsb and is found by the OS by searching the $PATH environment var.
----------------------------
revision 1.6
date: 1998/11/17 19:16:55;  author: kifer;  state: Exp;  lines: +1 -2
deleted a blank line.
----------------------------
revision 1.5
date: 1998/11/17 08:07:03;  author: kifer;  state: Exp;  lines: +7 -5
placed .xsb creation after xsb initialization, so that xsb -h and xsb -v
won't be making the .xsb subdirs for curiousity seekers.
----------------------------
revision 1.4
date: 1998/11/17 00:29:39;  author: kifer;  state: Exp;  lines: +5 -5
Adjustments for the NT port.
----------------------------
revision 1.3
date: 1998/11/13 23:08:19;  author: kifer;  state: Exp;  lines: +5 -1
Adjusted various macros for NT
----------------------------
revision 1.2
date: 1998/11/13 02:49:10;  author: kifer;  state: Exp;  lines: +10 -1
Modifications for porting to NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xpathname.c,v
Working file: xpathname.c
head: 1.14
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.12
	without-attv: 1.12
	release-2-0: 1.8
	pre-release-2-0: 1.7
	v1-9-8: 1.6
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.3
	r1-9-b6: 1.3
	r1-9-b5: 1.3
	devel-1-9-b4-5: 1.3
	devel-1-9-b4-4: 1.3
	devel-1-9-b4-3: 1.3
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 15;	selected revisions: 15
description:
----------------------------
revision 1.14
date: 1999/10/25 06:00:08;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.13
date: 1999/10/20 18:22:12;  author: kifer;  state: Exp;  lines: +5 -5
Removed misleading references to DOS, which imply as if DOS is supported
----------------------------
revision 1.12
date: 1999/09/21 00:11:58;  author: kifer;  state: Exp;  lines: +5 -1
fixed the ../.. bug at the start of a path.
----------------------------
revision 1.11
date: 1999/09/20 08:52:39;  author: kostis;  state: Exp;  lines: +2 -2
Fixed a minor inconsistency in the treatment of file names beginning with
a ~/.
----------------------------
revision 1.10
date: 1999/08/28 07:54:17;  author: kostis;  state: Exp;  lines: +134 -68
Added new builtins in C that manipulate file names and used them in
consult.P to implement search_module/7.  Should be cleaner and faster
now.
----------------------------
revision 1.9
date: 1999/08/18 12:31:31;  author: kostis;  state: Exp;  lines: +4 -4
Predicate ground/1 made a direct builtin.  Also some unused (and most
probably non-working) builtins taken out.  Small change in xpathname.c.
----------------------------
revision 1.8
date: 1999/05/03 00:55:53;  author: luis;  state: Exp;  lines: +3 -3
* changes regarding exporting functions under Windows
----------------------------
revision 1.7
date: 1999/04/19 15:41:29;  author: luis;  state: Exp;  lines: +21 -1
* added support for Cygwin-style pathnames under Windows
----------------------------
revision 1.6
date: 1999/02/10 15:46:11;  author: kifer;  state: Exp;  lines: +1 -4
got rid of malloc.h
----------------------------
revision 1.5
date: 1999/01/31 15:42:07;  author: kostis;  state: Exp;  lines: +2 -2
Changed use of obsolete function bcopy() to memmove().
----------------------------
revision 1.4
date: 1999/01/19 02:37:10;  author: kifer;  state: Exp;  lines: +12 -6
rectify_file_name no longer issues an error when it is passed a file
with leading `..'. Now, it doesn't delete the leading ..'s at all.
----------------------------
revision 1.3
date: 1998/11/13 07:16:53;  author: kifer;  state: Exp;  lines: +17 -8
Bracketed unistd with WIN_NT.
Fixed parse_file_name
----------------------------
revision 1.2
date: 1998/11/13 02:49:12;  author: kifer;  state: Exp;  lines: +9 -1
Modifications for porting to NT
----------------------------
revision 1.1
date: 1998/11/05 16:55:28;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:28;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/xsb.def,v
Working file: xsb.def
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.8
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.6
	release_2_6_plus_supp: 1.2.0.4
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.1.6.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.6
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.2
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.4
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.2
	release_2_4: 1.1
keyword substitution: kv
total revisions: 11;	selected revisions: 11
description:
----------------------------
revision 1.6
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2003/02/10 18:57:52;  author: lfcastro;  state: Exp;  lines: +149 -55
branches:  1.2.8;
* Fix creation of DLLs using Cygwin with -mno-cygwin
- changed xsb.def file to create aliases with correct name mangling
- changed default calling convention to STDCALL under -mno-cygwin
- created new makexsb goal, 'cygdll', which creates the dll under -mno-cygwin
- updated include paths to those of current cygwin (with gcc 3.2)
----------------------------
revision 1.1
date: 2001/05/17 12:49:01;  author: dwarren;  state: Exp;
branches:  1.1.4;  1.1.6;
Allow -mno-cygwin gcc generation of XSB DLL.
----------------------------
revision 1.1.6.1
date: 2004/10/18 20:46:41;  author: ruim;  state: Exp;  lines: +149 -55
update for version 2.6.1
----------------------------
revision 1.1.4.1
date: 2003/04/17 17:11:33;  author: lfcastro;  state: Exp;  lines: +149 -55
* Merge with HEAD on 2003-04-17 12:30 (or so)
----------------------------
revision 1.2.8.3
date: 2010/08/17 20:21:13;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.2.8.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2.8.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/xsb_inst_list.h,v
Working file: xsb_inst_list.h
head: 1.34
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.29
	ROLLBACK: 1.25
	latest_plus_supp_branch: 1.25.0.4
	latest_plus_supp: 1.25
	Version_3dot2_plus_supp: 1.25.0.2
	release_2_6_plus_supp: 1.6.0.4
	Version_3dot2: 1.25
	dec07-perf-results: 1.21
	mt_thesis: 1.15
	release_3_0: 1.14
	release_2_7_0: 1.8
	multi-threaded-26-engine: 1.5.4.3
	pre-mt: 1.8
	multi-threaded-25-engine-done: 1.5.4.1
	multi-threaded-25-engine: 1.5.0.4
	release_2_6_1: 1.6
	release_2_6_final: 1.6
	release_2_6: 1.6.0.2
	last-merged-to-demand: 1.5
	demand_branch: 1.5.0.2
	before_removing_chat: 1.5
	release_2_5: 1.5
	pre-merge-slgwam-gc: 1.4
	multi-threaded-c-engine: 1.4.0.2
	release_2_4: 1.4
	release_2_3: 1.4
	multi-threaded-engine: 1.2.0.2
keyword substitution: kv
total revisions: 41;	selected revisions: 41
description:
----------------------------
revision 1.34
date: 2012/06/04 15:59:24;  author: dwarren;  state: Exp;  lines: +1 -1
Added unindexed profiling.
----------------------------
revision 1.33
date: 2012/02/19 19:17:56;  author: tswift;  state: Exp;  lines: +2 -2

Changes to add trie root choice point for incremental tables, so that
updates of incremental tables can detect whether there are any choice
points pointing into them.

Also, added call cleanup check when throwing exceptions.
----------------------------
revision 1.32
date: 2011/12/14 22:40:26;  author: dwarren;  state: Exp;  lines: +1 -0
Added fdivreg instruction for div operation.
----------------------------
revision 1.31
date: 2011/01/09 21:00:44;  author: dwarren;  state: Exp;  lines: +6 -6
Changed xwam instruction codes for the variant_trie_* cp management
instructions.  Code assumes these kinds of instructions start on a 0 mod 4
boundary, and these didn't.  Bug showed up in delete_branch.
----------------------------
revision 1.30
date: 2011/01/02 22:16:43;  author: tswift;  state: Exp;  lines: +6 -5

Main change was	to fix a bug in	trie_xxx_val in	handling
attributed variables.  A specialization that works for variant
tables does not work properly for asserted or interned tries when
there are attributed variables in the	   call and val instructions
in the trie.  (I haven't yet figured out what subsumptive tables
should do).  To fix this I "unspecialized" the code and made
special variant instructions to be used in the case of variant
answer tries.

In addition the	change fixed a number of annoying compiler
warnings on Mac Snow Leopard, and also cleaned up some code.
First, I commented out some trie locking stuff but left it around
in case we ever want to put it back in.	  Also, I changed the name
of whole_term_chk_insert() to trie_intern_chk_insert and
one_term_chk_insert to trie_assert_chk_insert.
----------------------------
revision 1.29
date: 2010/08/18 03:09:52;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.28
date: 2010/08/17 21:10:31;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.27
date: 2010/08/17 20:48:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.26
date: 2010/08/17 20:44:29;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.25
date: 2008/02/16 18:00:42;  author: dwarren;  state: Exp;  lines: +2 -2
branches:  1.25.4;
Add new instructions putdfloat and getdfloat to handle double floats.
Update the loader to load these instructions from the xwam files.
(There is a possible problem.  The doubles are written into the xwam
file as bitstrings, and read by the loader as the same bitstring.  If
representations on different machines are different, then xwam files
compiled on one system won't run on another.)
----------------------------
revision 1.24
date: 2008/02/04 03:59:53;  author: dwarren;  state: Exp;  lines: +1 -1
Add a new xwam instruction,cmpreg, replaces subreg for comparisons
to avoid overflow problems.  Now minint is less than maxint....
----------------------------
revision 1.23
date: 2008/01/30 16:03:03;  author: dwarren;  state: Exp;  lines: +2 -2
Added a new instruction for adding (or subtracting) small integers.
This allows a somewhat more efficient compilation of arithmetic,
for the common case of incrementing or decrementing a value.
----------------------------
revision 1.22
date: 2008/01/03 18:45:20;  author: dwarren;  state: Exp;  lines: +1 -1
Added new mega-instruction: getkpvars, which codes for multiple getpvar's.
Since the compiler generates a sequence of getpvar's of consecutively
increasing register numbers and increasing local variable locations for
heads that have distinct variables that are all permanent variables, this
instruction can be used quite often (as can be seen by the number of
.xwam files that have changed.)  The form is getkpvars(K,V,R) which
codes for K getpvar's with the V and R increasing by one each time.
----------------------------
revision 1.21
date: 2007/10/28 23:32:35;  author: tswift;  state: Exp;  lines: +2 -2


Added evaluable functions **/2 and sign/1, which were in the core standard.

Added an evaluable xor function ></2 which is in the revision.

Rewrote arithmetic_abort to give evaluation errors and instantiation
errors, making us a little more compliant.  We still aren't reporting
underflows or overflows, so we do deviate from the standard in this
respect.
----------------------------
revision 1.20
date: 2007/09/28 18:20:20;  author: dwarren;  state: Exp;  lines: +2 -2
This change causes attv interrupts to be handled before cuts.
(It also fixes a bug in the previous checkin to handle attv
interrupts before trymeorelse instructions.)
All the xwam files are changed since this involved generating a
new instruction(s) putpbreg (and the temp version) for cuts that have
parameters for ARsize and NumRegsInUse which are needed if an
interrupt is pending and is to be handled.
Sitll to be done is to figure out how to handle interrupts before
trie_try-type instructions that do unification when retrieving
from tries.
----------------------------
revision 1.19
date: 2007/09/26 20:15:24;  author: dwarren;  state: Exp;  lines: +1 -1
This update modifies the trymeorelse instruction (which implements
disjunctions, including if-then-else) to include a check for pending
attv interrupts, and handling them if there are any.  The problem is
that to handle interrupts, the environment must be known and there
must be a "call"-like instruction that allows called routines to find
the size of the parents AR.  This is done here by having the
trymeorelse instruction (when there is a pending interrupt) create
an environment and then branch to a 2-instruction sequence of
check_interrupt,restore_dealloc_proceed.  This last instruction is
new, and it restores registers (if nec, but here it's not since no
registers are active at a trymeorelse), pops the environment and
returns to the original caller, which in this case causes the trymeorelse
instruction to be executed again.
----------------------------
revision 1.18
date: 2007/03/23 18:13:27;  author: dwarren;  state: Exp;  lines: +1 -1
Improved fix to compiler to generate instruction to test heap when
necessary on clause return.
----------------------------
revision 1.17
date: 2007/03/16 20:40:32;  author: dwarren;  state: Exp;  lines: +3 -3
Add new mega-xwam-instructions to compile "abc"-type strings more
efficiently.  This changes almost(?) all xwam files.
The implementation at this point is just thru the peephole
optimizer.  The next step is to change the way the compiler
processes these strings to speed up compilation.
----------------------------
revision 1.16
date: 2007/03/15 21:30:45;  author: dwarren;  state: Exp;  lines: +1 -1
Add new instruction, deallocate_gc, that tests for stack overflow.  Fixes
a bug in which there is a deep recursion, and terms are built on the heap
on returning back up the call stack.  There are no heap-checks in such a
loop and so we can get stack overflow, without this check.
----------------------------
revision 1.15
date: 2006/09/06 05:15:27;  author: diptikalyan;  state: Exp;  lines: +3 -1
Incremental Code Added.
----------------------------
revision 1.14
date: 2006/01/27 17:50:19;  author: dwarren;  state: Exp;  lines: +1 -1
Added a new instruction to implement unary tests that don't change
the XWAM state.  Examples are integer/1, atom/1, etc.  The compiler
is changed to use these instructions to avoid laying down a choicepoint
in a conditional, and they are used for regular inline calls.
----------------------------
revision 1.13
date: 2005/09/02 20:43:14;  author: tswift;  state: Exp;  lines: +1 -1

Fix to abolish_table_xxx and gc_tables to work when stacks are frozen;
and made creation of DelTF frames thread-safe.  Also, got a little
further towards reclaiming retracted clauses.

----------------------------------------------------------------------
builtin.c emuloop.c extensions_xsb.h inst_xsb.h CVS: std_cases_xsb_i.h
tr_utils.c xsb_inst_list.h CVS:
----------------------------------------------------------------------
----------------------------
revision 1.12
date: 2005/08/08 17:11:36;  author: dwarren;  state: Exp;  lines: +1 -1
Widespread changes to support shared (and private) predicates in multithreading
system.
----------------------------
revision 1.11
date: 2005/07/15 15:02:33;  author: dwarren;  state: Exp;  lines: +3 -3
Made assert thread-safe (I hope.)  Problem was asserta, and I added
mutex_lock in jumptbreg when just entering asserted code, and I release
it after the code for the first clause to be executed is found and about
to be entered.  It introduces new instructions: dyntrymeelse, dynnoop, and
dynfail to release the lock.
assertz was made safe (I hope) without locks, by adding the new clause at the
end and then as the last thing, changing the opcode of the old-last clause
from dyntrust to retry.  Since dyntrust doesn't look at any argument, this
should work.
----------------------------
revision 1.10
date: 2005/03/08 22:21:58;  author: tswift;  state: Exp;  lines: +2 -2

Two changes for compatability

1) Changed consult/compile to use .pl and XSB_SRC_EXTENSION (.P) files interchangably, with
preference for XSB_SRC_EXTENSION files.  .pl files are handled as are XSB_SRC_EXTENSION
files, compared to XSB_OBJECT_EXTENSION (.xwam) files used with .H files,etc.  However if
there is a .P file the .pl wont be examined (even if the .pl file is newer)

Unlike the extensions .pl is hard-wired -- as this is what other Prologs mostly use.

2) added min and max as first-class arithmetic functions, so you can now have expresions
like

X is 3*max(Y,min(Z,W+1))

if you want.  Min/max is useful for reading files written for other Prologs, as well as for
full clpqr.  I introduced two new instructions for these -- I might have gotten away with
one.
----------------------------
revision 1.9
date: 2005/01/14 18:31:54;  author: ruim;  state: Exp;  lines: +2 -2
Integration of multithreaded system
----------------------------
revision 1.8
date: 2004/08/20 18:11:35;  author: dwarren;  state: Exp;  lines: +5 -2
Added uniavar and bldavar WAM instructions for processing anonymous variables.
Fixed a bug in backtrace due to cpreg being used in compiling inline disjunctions
   and thus not pointing after a call WAM instruction.
Fixed initialization to put system-defined constants/predicates (in particular ,/2)
   into both the particular module (standard) AND in usermod.
----------------------------
revision 1.7
date: 2004/03/08 13:56:30;  author: dwarren;  state: Exp;  lines: +1 -1
Added new instruction to compile new @= operator.
----------------------------
revision 1.6
date: 2002/10/28 15:29:49;  author: lfcastro;  state: Exp;  lines: +0 -1
* Remove 'reset' instruction
----------------------------
revision 1.5
date: 2002/01/14 22:42:15;  author: tswift;  state: Exp;  lines: +1 -1
branches:  1.5.2;  1.5.4;

Change in definition of unifunc that should only effect disassembly.
----------------------------
revision 1.4
date: 2001/02/06 16:56:37;  author: lfcastro;  state: Exp;  lines: +12 -6
* introduction of a new operand type of instruction (B), to distinguish
between integer constants that should/shoudn't be tagged at
load-time.

* load-time tagging is always performed, now (not a configure option,
anymore).
----------------------------
revision 1.3
date: 2001/01/26 23:56:09;  author: lfcastro;  state: Exp;  lines: +2 -2
* Introduction of optimizations in the engine:

[...]
        First, I renamed the previously-called threading emulator to
jump-table. So, in order to use it, you have to pass
--enable-jumptable to the configure script, instead of
--enable-threading. This reflects the fact that it's actually a
jump-table, not a direct threading engine, and incidentally avoid
possible clashes and confusions with the multi-threaded engine.

        The other optimizations are all compile-time choices, given by
the following options to configure (sorry for the names!):

--enable-tag-on-load
        This option tags all numeric constants at load time; so,
        constants are tagged in the code area.

--enable-insn-blocks
        This option declares variables like op1, op2, etc. locally to
        each wam instruction.

--enable-bp-lpcreg
        This option is experimental, and probably doesn't work yet,
        but it's an attempt to declare lpcreg using a register in x86
        archs.
----------------------------
revision 1.2
date: 2000/07/22 16:14:24;  author: cbaoqiu;  state: Exp;  lines: +3 -3
Added two lines for instructions trie_trust_attv and trie_retry_attv.
----------------------------
revision 1.1
date: 2000/06/22 01:27:52;  author: lfcastro;  state: Exp;
** Introduction of direct threading in the emulator loop; uses
gcc-specific constructions

** Single-update per instruction on lpcreg

The indirect threading is enabled by configuring with
--enable-threading.

        Basically, all instructions are now declared in a file called
xsb_inst_list.h, structured as:

XSB_INST(inum, instr, label, op1type, op2type, op3type, op4type);

        where:
                inum is the number of the instruction;
                instr is the constant name of the instruction;
                label is the corresponding label in emuloop;
                op?type are the types of the operands

        XSB_INST is just a name for a macro which is redefined each
time we need to include this file. This is done both in inst_xsb.c, to
initialize inst_table, and inside emuloop.c, to initialize the array
with the addresses of instructions.

        Unfortunatelly, we still need to declare the number of the
instructions in inst_xsb.h. Note that we could generate that from the
above structure, but that would require some kind of
pre-pre-processing (or at least I couldn't figure out how to do it
without using m4 or the like). Also, we need to include both the name
of the instruction (instr) and the corresponding label ini the
definition; that's because the names are going to be already defined
as their numbers, when xsb_inst_list.h is included. If somebody has
any suggestions to overcome these "problems", please let me know.

        Continuing... in emuloop, instructions are now defined between
calls to XSB_Start_Instr(instr, label); and XSB_Next_Instr();. These
macros are expanded to, either labels and indirect goto's if compiling
with indirect threading, or cases of a switch and goto contcases
otherwise.

        The other change I made is regarding the handling of operands
f instructions. The goal is to reduce the number of updates
(increments) to lpcreg in each instruction. So, I created macros which
will use displacements from lpcreg to get the arguments, and to
advance lpcreg according to the size of the instruction+operands.

        As an example, here is the definition of getpvar:

  XSB_Start_Instr(getpvar,_getpvar);  /* PVR */
    Op1(Variable(get_xvx));
    Op2(Register(get_xxr));
    ADVANCE_PC(size_xxx);
   /* trailing is needed here because this instruction can also be
       generated *after* the occurrence of the first call - kostis */
    bind_copy((CPtr)op1, op2);      /* In WAM bld_copy() */
    XSB_Next_Instr();
----------------------------
revision 1.5.4.3
date: 2004/11/04 22:31:15;  author: tswift;  state: Exp;  lines: +1 -1

Changes for compilation in cygwin.  This will not affect the linux distribution (I hope).
Changes are:

	1) execute -> xsb_execute, to avoid conflict with pthread.h in cygwin
	2) Renamed mutex constants to accord with pthread.h in cygwin.
----------------------------
revision 1.5.4.2
date: 2004/10/18 20:46:43;  author: ruim;  state: Exp;  lines: +0 -1
update for version 2.6.1
----------------------------
revision 1.5.4.1
date: 2004/09/29 19:44:24;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.5.2.1
date: 2002/10/28 16:49:33;  author: lfcastro;  state: Exp;  lines: +0 -1
* Merge with HEAD
----------------------------
revision 1.25.4.3
date: 2010/08/17 20:21:12;  author: spyrosh;  state: dead;  lines: +0 -0
no message
----------------------------
revision 1.25.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.25.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsb_memory.c,v
Working file: xsb_memory.c
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1
	without-attv: 1.1
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
former memory.c
----------------------------
revision 1.2
date: 1999/10/25 06:00:10;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1999/10/05 04:02:04;  author: kifer;  state: Exp;
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsb_memory.h,v
Working file: xsb_memory.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1
	without-attv: 1.1
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
former memory.h
----------------------------
revision 1.2
date: 1999/10/25 06:00:11;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1999/10/05 04:02:05;  author: kifer;  state: Exp;
had to move memory.* to xsb_memory.* because memory.h is on the standard
include path of the C compiler.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsb_odbc.c,v
Working file: xsb_odbc.c
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.6
	without-attv: 1.6
	release-2-0: 1.5
	pre-release-2-0: 1.3
	v1-9-8: 1.3
	code-fixer-new: 1.3
	code-fixer: 1.3
	delayvar_ok: 1.3
	r1-9-b6: 1.3
	r1-9-b5: 1.3
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.7
date: 1999/10/25 06:00:12;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.6
date: 1999/08/16 07:24:45;  author: kifer;  state: Exp;  lines: +7 -7
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.5
date: 1999/05/03 20:12:42;  author: luis;  state: Exp;  lines: +2 -1
* changes related to the foreign interface under windows
----------------------------
revision 1.4
date: 1999/05/03 00:55:54;  author: luis;  state: Exp;  lines: +2 -2
* changes regarding exporting functions under Windows
----------------------------
revision 1.3
date: 1998/11/17 01:56:47;  author: kifer;  state: Exp;  lines: +631 -620
Changed so that basictypes.h could be included multiple times.
Moved prolog_int and such from cinterf to basictypes.h
----------------------------
revision 1.2
date: 1998/11/17 00:29:42;  author: kifer;  state: Exp;  lines: +2 -1
Adjustments for the NT port.
----------------------------
revision 1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsb_odbc.h,v
Working file: xsb_odbc.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1999/10/25 06:00:14;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsb_odbc.i,v
Working file: xsb_odbc.i
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.4
	without-attv: 1.4
	release-2-0: 1.3
	pre-release-2-0: 1.3
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 6;	selected revisions: 6
description:
----------------------------
revision 1.5
date: 1999/10/25 06:00:15;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.4
date: 1999/08/16 07:24:47;  author: kifer;  state: Exp;  lines: +2 -2
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.3
date: 1999/04/22 06:49:28;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.2
date: 1999/04/13 14:16:09;  author: kostis;  state: Exp;  lines: +2 -2
Rationalization change.
----------------------------
revision 1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsb_string.c,v
Working file: xsb_string.c
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1
	without-attv: 1.1
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
----------------------------
revision 1.2
date: 1999/10/25 06:00:17;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1999/10/08 07:33:48;  author: kifer;  state: Exp;
added substring, string_substitute
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/xsb_time.h,v
Working file: xsb_time.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.3
	latest_plus_supp_branch: 1.3.0.4
	latest_plus_supp: 1.3
	Version_3dot2_plus_supp: 1.3.0.2
	release_2_6_plus_supp: 1.2.0.10
	Version_3dot2: 1.3
	dec07-perf-results: 1.3
	mt_thesis: 1.3
	release_3_0: 1.3
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2.8.1
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2.8.1
	multi-threaded-25-engine: 1.2.0.8
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.6
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.4
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.2
	release_2_4: 1.1
keyword substitution: kv
total revisions: 10;	selected revisions: 10
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +0 -0
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:18:00;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 20:02:07;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2005/01/14 18:31:55;  author: ruim;  state: Exp;  lines: +1 -1
branches:  1.3.4;
Integration of multithreaded system
----------------------------
revision 1.2
date: 2001/10/09 05:48:20;  author: kifer;  state: Exp;  lines: +6 -1
branches:  1.2.8;
fixed the time.h problem
----------------------------
revision 1.1
date: 2001/06/29 21:03:29;  author: kifer;  state: Exp;
took care of the time.h/ sys/time.h problem.
----------------------------
revision 1.2.8.1
date: 2004/09/29 19:44:24;  author: ruim;  state: Exp;  lines: +1 -1
Sources from rfm repository
----------------------------
revision 1.3.4.3
date: 2010/08/17 20:21:11;  author: spyrosh;  state: dead;  lines: +1 -1
no message
----------------------------
revision 1.3.4.2
date: 2010/06/19 19:39:51;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3.4.1
date: 2010/06/19 19:36:22;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsberror.c,v
Working file: xsberror.c
head: 1.16
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.15
	without-attv: 1.15
	release-2-0: 1.13
	pre-release-2-0: 1.8
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 17;	selected revisions: 17
description:
----------------------------
revision 1.16
date: 1999/10/25 06:00:18;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.15
date: 1999/08/16 07:24:48;  author: kifer;  state: Exp;  lines: +35 -6
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.14
date: 1999/08/09 00:29:28;  author: kifer;  state: Exp;  lines: +2 -1
Changes for windows installation
----------------------------
revision 1.13
date: 1999/06/26 05:01:37;  author: kifer;  state: Exp;  lines: +4 -4
made print_pterm return void and increased buff size in the arithmetic
exception functions.
----------------------------
revision 1.12
date: 1999/06/25 21:23:56;  author: kostis;  state: Exp;  lines: +7 -7
Small change after a suggestion by Michael Kifer.
----------------------------
revision 1.11
date: 1999/06/24 14:13:45;  author: kostis;  state: Exp;  lines: +15 -4
Some more changes to report meaningful things in arithmetic exceptions
(dealt with bit operations this time).
----------------------------
revision 1.10
date: 1999/06/23 21:26:01;  author: kostis;  state: Exp;  lines: +48 -14
Changes to have more meaningful error messages in case of arithmetic
expressions or comparisons.
----------------------------
revision 1.9
date: 1999/04/27 14:39:50;  author: kifer;  state: Exp;  lines: +2 -2
Made large builtins in the former std_pred.i into inlined subroutines.
Added atom_codes, number_codes and made atom_chars, number_chars into
synonyms to the *_codes builtins.
----------------------------
revision 1.8
date: 1999/04/25 05:17:51;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Fixed a problem in the call of longjmp in xsb_abort(): pass pcreg
instead of 1.
----------------------------
revision 1.7
date: 1999/04/23 19:41:59;  author: cbaoqiu;  state: Exp;  lines: +1 -4
Added instruction `reset' and changed xsb_segfault_catcher(), so that
both xsb_segfault_catcher() and xsb_abort() longjmp to `case reset' in
emuloop.c.  Seg fault handler is now nicer.
----------------------------
revision 1.6
date: 1999/04/04 03:54:50;  author: kifer;  state: Exp;  lines: +10 -4
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.5
date: 1999/03/30 16:25:21;  author: kifer;  state: Exp;  lines: +24 -1
Changes associated with moving file_open/close/put/get,
fmt_read/write, etc. to file_io. Unifying the builtins
file_open/close/put/get with file_flush/seek/truncate
under a single builtin file_function.
----------------------------
revision 1.4
date: 1999/03/29 20:37:05;  author: kifer;  state: Exp;  lines: +24 -4
xsb_abort now takes variable number of arguments, like printf.
Also, xsb_abort longjumps directly to emuloop.c
----------------------------
revision 1.3
date: 1999/03/23 05:30:15;  author: kifer;  state: Exp;  lines: +2 -1
Added segfault handling.
----------------------------
revision 1.2
date: 1999/03/18 01:26:57;  author: cbaoqiu;  state: Exp;  lines: +2 -2
Changed the local variable `message' in xsb_abort so that it can print
out longer message.
----------------------------
revision 1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsberror.h,v
Working file: xsberror.h
head: 1.13
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.12
	without-attv: 1.12
	release-2-0: 1.10
	pre-release-2-0: 1.8
	v1-9-8: 1.2
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 14;	selected revisions: 14
description:
----------------------------
revision 1.13
date: 1999/10/25 06:00:19;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.12
date: 1999/08/17 06:34:17;  author: kifer;  state: Exp;  lines: +5 -3
Added pipe_open, pipe2file.
Fixed compilation bugs on NT from yesterday's.
----------------------------
revision 1.11
date: 1999/08/16 07:24:49;  author: kifer;  state: Exp;  lines: +8 -1
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.10
date: 1999/06/24 14:13:46;  author: kostis;  state: Exp;  lines: +2 -1
Some more changes to report meaningful things in arithmetic exceptions
(dealt with bit operations this time).
----------------------------
revision 1.9
date: 1999/06/23 21:26:02;  author: kostis;  state: Exp;  lines: +3 -1
Changes to have more meaningful error messages in case of arithmetic
expressions or comparisons.
----------------------------
revision 1.8
date: 1999/04/23 19:42:00;  author: cbaoqiu;  state: Exp;  lines: +1 -3
Added instruction `reset' and changed xsb_segfault_catcher(), so that
both xsb_segfault_catcher() and xsb_abort() longjmp to `case reset' in
emuloop.c.  Seg fault handler is now nicer.
----------------------------
revision 1.7
date: 1999/04/04 03:54:51;  author: kifer;  state: Exp;  lines: +6 -5
Added error checking.
Made sure the new SET_FILEPTR macro is used to check fileptr().
Replaced fprintf(stderr with xsb_abort/warn where appropriate.
----------------------------
revision 1.6
date: 1999/03/30 16:25:22;  author: kifer;  state: Exp;  lines: +3 -4
Changes associated with moving file_open/close/put/get,
fmt_read/write, etc. to file_io. Unifying the builtins
file_open/close/put/get with file_flush/seek/truncate
under a single builtin file_function.
----------------------------
revision 1.5
date: 1999/03/29 20:37:06;  author: kifer;  state: Exp;  lines: +7 -5
xsb_abort now takes variable number of arguments, like printf.
Also, xsb_abort longjumps directly to emuloop.c
----------------------------
revision 1.4
date: 1999/03/25 02:47:14;  author: kifer;  state: Exp;  lines: +14 -4
Improved segfault handling: even when DEBUG and segfault handling is
disabled, we can now enable it in certain laces, those where we know
the reasons for segfaulting.
----------------------------
revision 1.3
date: 1999/03/23 05:30:16;  author: kifer;  state: Exp;  lines: +6 -1
Added segfault handling.
----------------------------
revision 1.2
date: 1999/02/04 22:06:34;  author: kostis;  state: Exp;  lines: +2 -1
Added a convenience macro.
----------------------------
revision 1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:26;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsbsocket.c,v
Working file: xsbsocket.c
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.5
	without-attv: 1.5
keyword substitution: kv
total revisions: 6;	selected revisions: 6
description:
----------------------------
revision 1.6
date: 1999/10/25 06:00:21;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.5
date: 1999/08/16 07:24:50;  author: kifer;  state: Exp;  lines: +2 -2
Split XSB output into several streams.
Big cleanup of messages.
Added file_clone and file_reopen
----------------------------
revision 1.4
date: 1999/08/14 06:12:03;  author: kifer;  state: Exp;  lines: +56 -29
cleaned up, added the error arg to socket_call
----------------------------
revision 1.3
date: 1999/08/02 09:05:21;  author: kifer;  state: Exp;  lines: +5 -1
Deleted open/close_process_stream/pipe.
Added the more general spawn_process/3.
Added section on interprocess communication to manual2.
Still needs testing on NT.
----------------------------
revision 1.2
date: 1999/08/02 00:50:36;  author: kifer;  state: Exp;  lines: +11 -1
moved things around
----------------------------
revision 1.1
date: 1999/08/02 00:28:58;  author: kifer;  state: Exp;
renamed xsbsockets.i to xsbsockets.c
added socket_set-option
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsbsocket.h,v
Working file: xsbsocket.h
head: 1.12
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.11
	without-attv: 1.11
	release-2-0: 1.3
	pre-release-2-0: 1.3
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.12
date: 1999/10/25 06:00:21;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.11
date: 1999/09/06 17:32:22;  author: kifer;  state: Exp;  lines: +2 -16
Changes that enable XSB to work with GPP instead of CPP.
----------------------------
revision 1.10
date: 1999/08/09 00:29:29;  author: kifer;  state: Exp;  lines: +1 -2
Changes for windows installation
----------------------------
revision 1.9
date: 1999/08/02 00:50:37;  author: kifer;  state: Exp;  lines: +8 -19
moved things around
----------------------------
revision 1.8
date: 1999/08/02 00:28:59;  author: kifer;  state: Exp;  lines: +3 -2
renamed xsbsockets.i to xsbsockets.c
added socket_set-option
----------------------------
revision 1.7
date: 1999/07/24 23:33:30;  author: kifer;  state: Exp;  lines: +3 -2
Added _open_osfhandle in socket_accept/connect, which should smooth out the
differences between windows and unix.
----------------------------
revision 1.6
date: 1999/07/21 23:09:00;  author: kifer;  state: Exp;  lines: +2 -2
fixed bug where socket_connect/accept was not returning the right stream
----------------------------
revision 1.5
date: 1999/07/21 21:33:34;  author: kifer;  state: Exp;  lines: +3 -1
socket() now checks if the address is a hostname. If so, convert to IP.
----------------------------
revision 1.4
date: 1999/07/15 20:46:01;  author: warren;  state: Exp;  lines: +3 -3
Fix error in macros for testing for socket errors under both unix and
nt.
----------------------------
revision 1.3
date: 1999/04/23 04:10:40;  author: kifer;  state: Exp;  lines: +2 -2
cosmetic changes
----------------------------
revision 1.2
date: 1999/04/22 07:00:11;  author: kifer;  state: Exp;  lines: +8 -9
buglet fix
----------------------------
revision 1.1
date: 1999/04/22 06:54:38;  author: kifer;  state: Exp;
Took socket stuff out of builtin.c and put it in xsbsocket.[ih]
Unified WIN_NT and Unix parts, eliminating duplicates, etc.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/Attic/xsbsocket.i,v
Working file: xsbsocket.i
head: 1.12
branch:
locks: strict
access list:
symbolic names:
	release-2-0: 1.3
	pre-release-2-0: 1.3
keyword substitution: kv
total revisions: 12;	selected revisions: 12
description:
----------------------------
revision 1.12
date: 1999/08/02 00:29:00;  author: kifer;  state: dead;  lines: +1 -1
renamed xsbsockets.i to xsbsockets.c
added socket_set-option
----------------------------
revision 1.11
date: 1999/07/26 03:22:52;  author: kifer;  state: Exp;  lines: +2 -2
Cast 4th param is setsockopt to (void *)
----------------------------
revision 1.10
date: 1999/07/25 15:36:21;  author: kifer;  state: Exp;  lines: +14 -1
Reduced the default linger option.
----------------------------
revision 1.9
date: 1999/07/24 23:33:30;  author: kifer;  state: Exp;  lines: +54 -53
Added _open_osfhandle in socket_accept/connect, which should smooth out the
differences between windows and unix.
----------------------------
revision 1.8
date: 1999/07/22 19:10:06;  author: kifer;  state: Exp;  lines: +3 -3
Have socket_accept/connect return -1 in the last arg under NT.
----------------------------
revision 1.7
date: 1999/07/21 23:09:01;  author: kifer;  state: Exp;  lines: +15 -5
fixed bug where socket_connect/accept was not returning the right stream
----------------------------
revision 1.6
date: 1999/07/21 21:33:35;  author: kifer;  state: Exp;  lines: +24 -2
socket() now checks if the address is a hostname. If so, convert to IP.
----------------------------
revision 1.5
date: 1999/07/20 18:54:43;  author: kifer;  state: Exp;  lines: +19 -31
added open_process_pipe/close_process_pipe,
open_process_stream/close_process_stream
----------------------------
revision 1.4
date: 1999/07/02 20:16:23;  author: warren;  state: Exp;  lines: +10 -11
clean up sockets interface in minor way.  Eliminate socket flush.
----------------------------
revision 1.3
date: 1999/04/23 04:10:41;  author: kifer;  state: Exp;  lines: +2 -2
cosmetic changes
----------------------------
revision 1.2
date: 1999/04/22 07:37:35;  author: kifer;  state: Exp;  lines: +2 -4
deleted ifdef HAVE_SOCKET
----------------------------
revision 1.1
date: 1999/04/22 06:54:39;  author: kifer;  state: Exp;
Took socket stuff out of builtin.c and put it in xsbsocket.[ih]
Unified WIN_NT and Unix parts, eliminating duplicates, etc.
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dde/ddemain_xsb.c,v
Working file: dde/ddemain_xsb.c
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.18
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.16
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:10:09;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.1
date: 1999/10/25 06:00:22;  author: kifer;  state: Exp;
branches:  1.1.18;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/dde/Attic/xddemain.c,v
Working file: dde/xddemain.c
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.1
	without-attv: 1.1
	release-2-0: 1.1
	pre-release-2-0: 1.1
	v1-9-8: 1.1
	code-fixer-new: 1.1
	code-fixer: 1.1
	r1-9-b6: 1.1
	r1-9-b5: 1.1
keyword substitution: kv
total revisions: 2;	selected revisions: 2
description:
moved here from emu
----------------------------
revision 1.2
date: 1999/10/25 06:00:24;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1
date: 1998/11/17 00:44:35;  author: kifer;  state: Exp;
Moved here from emu
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debugs/.cvsignore,v
Working file: debugs/.cvsignore
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.16
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.14
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.2
	release-2-2: 1.1.1.1
	chat-and-local: 1.1.1.1.0.2
	xsb-pre-cleanup: 1.1.1.1
	release-2-1: 1.1.1.1
	release-2-0-1: 1.1.1.1
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.6
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2000/04/30 03:38:08;  author: kifer;  state: Exp;  lines: +1 -1
branches:  1.2.16;
fixed files to ignore
----------------------------
revision 1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.2.16.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debugs/README,v
Working file: debugs/README
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.5
	ROLLBACK: 1.1.1.1
	latest_plus_supp_branch: 1.1.1.1.0.18
	latest_plus_supp: 1.1.1.1
	Version_3dot2_plus_supp: 1.1.1.1.0.16
	release_2_6_plus_supp: 1.1.1.1.0.14
	Version_3dot2: 1.1.1.1
	dec07-perf-results: 1.1.1.1
	mt_thesis: 1.1.1.1
	release_3_0: 1.1.1.1
	release_2_7_0: 1.1.1.1
	multi-threaded-26-engine: 1.1.1.1
	pre-mt: 1.1.1.1
	multi-threaded-25-engine-done: 1.1.1.1
	multi-threaded-25-engine: 1.1.1.1.0.12
	release_2_6_1: 1.1.1.1
	release_2_6_final: 1.1.1.1
	release_2_6: 1.1.1.1.0.10
	last-merged-to-demand: 1.1.1.1
	demand_branch: 1.1.1.1.0.8
	before_removing_chat: 1.1.1.1
	release_2_5: 1.1.1.1
	pre-merge-slgwam-gc: 1.1.1.1
	multi-threaded-c-engine: 1.1.1.1.0.6
	release_2_4: 1.1.1.1
	release_2_3: 1.1.1.1
	multi-threaded-engine: 1.1.1.1.0.4
	pre-threading: 1.1.1.1
	release-2-2: 1.1.1.1
	chat-and-local: 1.1.1.1.0.2
	xsb-pre-cleanup: 1.1.1.1
	release-2-1: 1.1.1.1
	release-2-0-1: 1.1.1.1
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.5
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;  lines: +0 -0
branches:  1.1.1.1.18;
Imported sources
----------------------------
revision 1.1.1.1.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debugs/debug_attv.h,v
Working file: debugs/debug_attv.h
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.5
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.18
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.16
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 6;	selected revisions: 6
description:
----------------------------
revision 1.5
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 1999/11/05 03:54:38;  author: cbaoqiu;  state: Exp;
branches:  1.1.18;
Initial version.
----------------------------
revision 1.1.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debugs/debug_biassert.h,v
Working file: debugs/debug_biassert.h
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.5
	ROLLBACK: 1.1.1.1
	latest_plus_supp_branch: 1.1.1.1.0.18
	latest_plus_supp: 1.1.1.1
	Version_3dot2_plus_supp: 1.1.1.1.0.16
	release_2_6_plus_supp: 1.1.1.1.0.14
	Version_3dot2: 1.1.1.1
	dec07-perf-results: 1.1.1.1
	mt_thesis: 1.1.1.1
	release_3_0: 1.1.1.1
	release_2_7_0: 1.1.1.1
	multi-threaded-26-engine: 1.1.1.1
	pre-mt: 1.1.1.1
	multi-threaded-25-engine-done: 1.1.1.1
	multi-threaded-25-engine: 1.1.1.1.0.12
	release_2_6_1: 1.1.1.1
	release_2_6_final: 1.1.1.1
	release_2_6: 1.1.1.1.0.10
	last-merged-to-demand: 1.1.1.1
	demand_branch: 1.1.1.1.0.8
	before_removing_chat: 1.1.1.1
	release_2_5: 1.1.1.1
	pre-merge-slgwam-gc: 1.1.1.1
	multi-threaded-c-engine: 1.1.1.1.0.6
	release_2_4: 1.1.1.1
	release_2_3: 1.1.1.1
	multi-threaded-engine: 1.1.1.1.0.4
	pre-threading: 1.1.1.1
	release-2-2: 1.1.1.1
	chat-and-local: 1.1.1.1.0.2
	xsb-pre-cleanup: 1.1.1.1
	release-2-1: 1.1.1.1
	release-2-0-1: 1.1.1.1
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.5
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;  lines: +0 -0
branches:  1.1.1.1.18;
Imported sources
----------------------------
revision 1.1.1.1.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debugs/debug_delay.h,v
Working file: debugs/debug_delay.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.18
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.16
	release_2_6_plus_supp: 1.2.0.14
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.12
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.10
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.8
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.6
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.4
	pre-threading: 1.2
	release-2-2: 1.2
	chat-and-local: 1.2.0.2
	xsb-pre-cleanup: 1.2
	release-2-1: 1.2
	release-2-0-1: 1.2
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.6
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 1999/09/20 12:12:15;  author: kostis;  state: Exp;  lines: +2 -8
branches:  1.2.18;
Made it up-to-date.
----------------------------
revision 1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.2.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debugs/Attic/debug_kostis.h,v
Working file: debugs/debug_kostis.h
head: 1.2
branch:
locks: strict
access list:
symbolic names:
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
----------------------------
revision 1.2
date: 1999/02/02 17:19:39;  author: kostis;  state: dead;  lines: +0 -0
Unnecessary -- taken out.
----------------------------
revision 1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debugs/debug_residual.h,v
Working file: debugs/debug_residual.h
head: 1.5
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.5
	ROLLBACK: 1.1.1.1
	latest_plus_supp_branch: 1.1.1.1.0.18
	latest_plus_supp: 1.1.1.1
	Version_3dot2_plus_supp: 1.1.1.1.0.16
	release_2_6_plus_supp: 1.1.1.1.0.14
	Version_3dot2: 1.1.1.1
	dec07-perf-results: 1.1.1.1
	mt_thesis: 1.1.1.1
	release_3_0: 1.1.1.1
	release_2_7_0: 1.1.1.1
	multi-threaded-26-engine: 1.1.1.1
	pre-mt: 1.1.1.1
	multi-threaded-25-engine-done: 1.1.1.1
	multi-threaded-25-engine: 1.1.1.1.0.12
	release_2_6_1: 1.1.1.1
	release_2_6_final: 1.1.1.1
	release_2_6: 1.1.1.1.0.10
	last-merged-to-demand: 1.1.1.1
	demand_branch: 1.1.1.1.0.8
	before_removing_chat: 1.1.1.1
	release_2_5: 1.1.1.1
	pre-merge-slgwam-gc: 1.1.1.1
	multi-threaded-c-engine: 1.1.1.1.0.6
	release_2_4: 1.1.1.1
	release_2_3: 1.1.1.1
	multi-threaded-engine: 1.1.1.1.0.4
	pre-threading: 1.1.1.1
	release-2-2: 1.1.1.1
	chat-and-local: 1.1.1.1.0.2
	xsb-pre-cleanup: 1.1.1.1
	release-2-1: 1.1.1.1
	release-2-0-1: 1.1.1.1
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.5
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;  lines: +0 -0
branches:  1.1.1.1.18;
Imported sources
----------------------------
revision 1.1.1.1.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debugs/debug_tables.h,v
Working file: debugs/debug_tables.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.16
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.14
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
	subsumption: 1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.6
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2000/06/25 16:59:21;  author: ejohnson;  state: Exp;  lines: +5 -2
branches:  1.2.16;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.1
date: 1999/10/12 19:23:19;  author: ejohnson;  state: Exp;
Initial version of new file in support of subsumption.
----------------------------
revision 1.2.16.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/debugs/debug_tries.h,v
Working file: debugs/debug_tries.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.16
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.14
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.1.1.1
	release-2-2: 1.1.1.1
	chat-and-local: 1.1.1.1.0.2
	xsb-pre-cleanup: 1.1.1.1
	release-2-1: 1.1.1.1
	release-2-0-1: 1.1.1.1
	subsumption: 1.1.1.1
	without-attv: 1.1.1.1
	release-2-0: 1.1.1.1
	pre-release-2-0: 1.1.1.1
	v1-9-8: 1.1.1.1
	code-fixer-new: 1.1.1.1
	code-fixer: 1.1.1.1
	delayvar_ok: 1.1.1.1
	r1-9-b6: 1.1.1.1
	r1-9-b5: 1.1.1.1
	devel-1-9-b4-5: 1.1.1.1
	devel-1-9-b4-4: 1.1.1.1
	devel-1-9-b4-3: 1.1.1.1
	xsb-9-1-b4-2: 1.1.1.1
	xsb-9-1-b4-1: 1.1.1.1
	xsb-1-9-b4: 1.1.1.1
	start: 1.1.1.1
	xsb: 1.1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.6
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +0 -0
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +0 -0
no message
----------------------------
revision 1.2
date: 2000/06/25 16:59:21;  author: ejohnson;  state: Exp;  lines: +13 -0
branches:  1.2.16;
Altered Answer-Check/Insert operation under subsumption-based tabling
to use subsumptive checks rather than variant.

Reorganized the subsumption-based routines and expanded their
functionality and versatility.  Similar-style variant-based routines
are also included.  Their organization is divided along two lines.
One is a division by functionality: lookup, insert, and search
(check/insert), where the latter routines employ the other primitive
operations of lookup and insert.  The second line provides abstraction
within each class of routine.  Using the lower-level routines,
trie-manipulating operations with special requirements can be built,
thus limiting the duplication of trie code.  Note that although these
routines could serve to replace the one-use trie functions employed by
XSB, their use has been restricted to the subsumption-based component
of tabling and a few builtins.

The contents of file sub_insert.c has been spread across several
files; the new file sub_tables_xsb_i.h contains the subsumptive call
check/insert operation formerly found there.  There are also two other
new files to house the different flavors of trie routines as discussed
above: trie_lookup.c and trie_search.c

These trie routines rely on several auxiliary data areas, primarily
stacks.  Two new files, dynamic_stack.[ch], contain the basic
machinery for creating and manipulating a dynamic stack.  A couple of
the stacks needed by the trie routines have been converted so far.  A
few still remain to be converted.
----------------------------
revision 1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;
branches:  1.1.1;
Initial revision
----------------------------
revision 1.1.1.1
date: 1998/11/05 16:55:30;  author: sbprolog;  state: Exp;  lines: +0 -0
Imported sources
----------------------------
revision 1.2.16.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +0 -0
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/Attic/close.i,v
Working file: orastuff/close.i
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.1
	code-fixer-new: 1.1
	code-fixer: 1.1
	r1-9-b6: 1.1
	r1-9-b5: 1.1
	devel-1-9-b4-5: 1.1
	devel-1-9-b4-4: 1.1
	devel-1-9-b4-3: 1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
initial version
----------------------------
revision 1.3
date: 1999/10/25 06:00:27;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/04/22 06:49:30;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1998/11/13 02:51:05;  author: kifer;  state: Exp;
*** empty log message ***
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/close_xsb_i.h,v
Working file: orastuff/close_xsb_i.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.18
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.16
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.1
date: 1999/10/25 06:00:28;  author: kifer;  state: Exp;
branches:  1.1.18;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/Attic/desc_bv.i,v
Working file: orastuff/desc_bv.i
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.1
	code-fixer-new: 1.1
	code-fixer: 1.1
	r1-9-b6: 1.1
	r1-9-b5: 1.1
	devel-1-9-b4-5: 1.1
	devel-1-9-b4-4: 1.1
	devel-1-9-b4-3: 1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
initial version
----------------------------
revision 1.3
date: 1999/10/25 06:00:29;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/04/22 06:49:31;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1998/11/13 02:51:07;  author: kifer;  state: Exp;
*** empty log message ***
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/desc_bv_xsb_i.h,v
Working file: orastuff/desc_bv_xsb_i.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.16
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.14
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2000/10/02 15:32:23;  author: ejohnson;  state: Exp;  lines: +64 -22
branches:  1.2.16;
Oracle 8 Pro*C syntax change.
----------------------------
revision 1.1
date: 1999/10/25 06:00:30;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2.16.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/Attic/desc_sli.i,v
Working file: orastuff/desc_sli.i
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.1
	code-fixer-new: 1.1
	code-fixer: 1.1
	r1-9-b6: 1.1
	r1-9-b5: 1.1
	devel-1-9-b4-5: 1.1
	devel-1-9-b4-4: 1.1
	devel-1-9-b4-3: 1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
initial version
----------------------------
revision 1.3
date: 1999/10/25 06:00:31;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/04/22 06:49:32;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1998/11/13 02:51:08;  author: kifer;  state: Exp;
*** empty log message ***
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/desc_sli_xsb_i.h,v
Working file: orastuff/desc_sli_xsb_i.h
head: 1.7
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.7
	ROLLBACK: 1.2
	latest_plus_supp_branch: 1.2.0.16
	latest_plus_supp: 1.2
	Version_3dot2_plus_supp: 1.2.0.14
	release_2_6_plus_supp: 1.2.0.12
	Version_3dot2: 1.2
	dec07-perf-results: 1.2
	mt_thesis: 1.2
	release_3_0: 1.2
	release_2_7_0: 1.2
	multi-threaded-26-engine: 1.2
	pre-mt: 1.2
	multi-threaded-25-engine-done: 1.2
	multi-threaded-25-engine: 1.2.0.10
	release_2_6_1: 1.2
	release_2_6_final: 1.2
	release_2_6: 1.2.0.8
	last-merged-to-demand: 1.2
	demand_branch: 1.2.0.6
	before_removing_chat: 1.2
	release_2_5: 1.2
	pre-merge-slgwam-gc: 1.2
	multi-threaded-c-engine: 1.2.0.4
	release_2_4: 1.2
	release_2_3: 1.2
	multi-threaded-engine: 1.2.0.2
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 8;	selected revisions: 8
description:
----------------------------
revision 1.7
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.6
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.5
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.4
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2000/10/03 15:47:37;  author: ejohnson;  state: Exp;  lines: +64 -22
branches:  1.2.16;
Oracle 8 Pro*C syntax change.
----------------------------
revision 1.1
date: 1999/10/25 06:00:31;  author: kifer;  state: Exp;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2.16.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/Attic/fetch.i,v
Working file: orastuff/fetch.i
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.1
	code-fixer-new: 1.1
	code-fixer: 1.1
	r1-9-b6: 1.1
	r1-9-b5: 1.1
	devel-1-9-b4-5: 1.1
	devel-1-9-b4-4: 1.1
	devel-1-9-b4-3: 1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
initial version
----------------------------
revision 1.3
date: 1999/10/25 06:00:32;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/04/22 06:49:33;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1998/11/13 02:51:09;  author: kifer;  state: Exp;
*** empty log message ***
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/fetch_xsb_i.h,v
Working file: orastuff/fetch_xsb_i.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.18
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.16
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.1
date: 1999/10/25 06:00:33;  author: kifer;  state: Exp;
branches:  1.1.18;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/Attic/open.i,v
Working file: orastuff/open.i
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.1
	code-fixer-new: 1.1
	code-fixer: 1.1
	r1-9-b6: 1.1
	r1-9-b5: 1.1
	devel-1-9-b4-5: 1.1
	devel-1-9-b4-4: 1.1
	devel-1-9-b4-3: 1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
initial version
----------------------------
revision 1.3
date: 1999/10/25 06:00:34;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/04/22 06:49:34;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1998/11/13 02:51:11;  author: kifer;  state: Exp;
*** empty log message ***
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/open_xsb_i.h,v
Working file: orastuff/open_xsb_i.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.18
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.16
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.1
date: 1999/10/25 06:00:35;  author: kifer;  state: Exp;
branches:  1.1.18;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/Attic/prepdecl.i,v
Working file: orastuff/prepdecl.i
head: 1.3
branch:
locks: strict
access list:
symbolic names:
	subsumption: 1.2
	without-attv: 1.2
	release-2-0: 1.2
	pre-release-2-0: 1.2
	v1-9-8: 1.1
	code-fixer-new: 1.1
	code-fixer: 1.1
	r1-9-b6: 1.1
	r1-9-b5: 1.1
	devel-1-9-b4-5: 1.1
	devel-1-9-b4-4: 1.1
	devel-1-9-b4-3: 1.1
keyword substitution: kv
total revisions: 3;	selected revisions: 3
description:
initial version
----------------------------
revision 1.3
date: 1999/10/25 06:00:37;  author: kifer;  state: dead;  lines: +1 -1
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.2
date: 1999/04/22 06:49:34;  author: kifer;  state: Exp;  lines: +2 -1
Added header so these will come up in c-mode in emacs
----------------------------
revision 1.1
date: 1998/11/13 02:51:12;  author: kifer;  state: Exp;
*** empty log message ***
=============================================================================

RCS file: /cvsroot/xsb/XSB/emu/orastuff/prepdecl_xsb_i.h,v
Working file: orastuff/prepdecl_xsb_i.h
head: 1.6
branch:
locks: strict
access list:
symbolic names:
	BEFORE_MULTIPLE_PREPROCESSORS: 1.6
	ROLLBACK: 1.1
	latest_plus_supp_branch: 1.1.0.18
	latest_plus_supp: 1.1
	Version_3dot2_plus_supp: 1.1.0.16
	release_2_6_plus_supp: 1.1.0.14
	Version_3dot2: 1.1
	dec07-perf-results: 1.1
	mt_thesis: 1.1
	release_3_0: 1.1
	release_2_7_0: 1.1
	multi-threaded-26-engine: 1.1
	pre-mt: 1.1
	multi-threaded-25-engine-done: 1.1
	multi-threaded-25-engine: 1.1.0.12
	release_2_6_1: 1.1
	release_2_6_final: 1.1
	release_2_6: 1.1.0.10
	last-merged-to-demand: 1.1
	demand_branch: 1.1.0.8
	before_removing_chat: 1.1
	release_2_5: 1.1
	pre-merge-slgwam-gc: 1.1
	multi-threaded-c-engine: 1.1.0.6
	release_2_4: 1.1
	release_2_3: 1.1
	multi-threaded-engine: 1.1.0.4
	pre-threading: 1.1
	release-2-2: 1.1
	chat-and-local: 1.1.0.2
	xsb-pre-cleanup: 1.1
	release-2-1: 1.1
	release-2-0-1: 1.1
keyword substitution: kv
total revisions: 7;	selected revisions: 7
description:
----------------------------
revision 1.6
date: 2010/08/19 15:03:37;  author: spyrosh;  state: Exp;  lines: +1 -1
Roll back to state as of Aug 16, 2010.
----------------------------
revision 1.5
date: 2010/08/18 03:10:10;  author: spyrosh;  state: Exp;  lines: +1 -1
Backed out faulty changes
----------------------------
revision 1.4
date: 2010/08/17 21:10:43;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.3
date: 2010/08/17 20:48:49;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.2
date: 2010/08/17 20:44:37;  author: spyrosh;  state: Exp;  lines: +1 -1
no message
----------------------------
revision 1.1
date: 1999/10/25 06:00:37;  author: kifer;  state: Exp;
branches:  1.1.18;
Renamed .i files to _xsb_i.h files
Renamed some other .h files (added _xsb) that might clash with
/usr/include/*.h
These conflicts can (and do) arise while compiling programs through the
foreign C interface.
Ideally, all emu/ files should be renamed by adding _xsb to eliminate such
possible clashes.
----------------------------
revision 1.1.18.1
date: 2010/06/19 19:36:23;  author: spyrosh;  state: dead;  lines: +1 -1
no message
=============================================================================
